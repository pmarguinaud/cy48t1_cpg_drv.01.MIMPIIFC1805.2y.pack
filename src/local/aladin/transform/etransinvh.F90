SUBROUTINE ETRANSINVH(YDGEOMETRY,YDGFL,YDGMV,YDML_DIAG,YDML_GCONF,CDCONF,YDSP,YDMTRAJ)

!**** *ETRANSINVH * - Inverse transforms

!     Purpose.  Perform inverse transform (spectral to gridpoint)
!     --------

!**   Interface.  CALL ETRANSINVH(CDCONF)
!     ---------- 

!     Explicit arguments :
!     --------------------
!        CDCONF     - configuration of work
!                     Current values in use for CDCONF(2:3): AA, M1, K0, E0, GB, KD

!     Externals.
!     ----------

!     Reference.
!     ----------
!        ECMWF Research Department documentation of the IFS

!     Author.
!     -------
!        Mats Hamrud *ECMWF*

!     Modifications.
!     --------------
!        Original : 00-10-25
!        Modified : 02-09-30 P. Smolikova (PGPAUX for d4 in NH)
!    R. El khatib : 03-04-24 Phasing with cy26
!        Y. Seity : 03-09-30 Phasing with cy27
!        M.Hamrud      01-Oct-2003 CY28 Cleaning
!        O.Spaniel     Oct-2004 phasing for AL29
!        R. Brozkova   Jul-2005 cleaning the VDAUX specific structure
!        R. Hamdi      Feb. 2006 Phasing CY31
!        R. El Khatib 17-Jul-2012 Fullpos move away
!        B. Bochenek 15-04-2013 - Phasing cy40, coherence with modified modules
!        M. Hortal  Nov-2014 add Wedi's LGRADSP
!        B. Bochenek (Apr 2015): Phasing: move some variables.
!        O. Marsden: June 2015 CY42 YRGMV, YRGFL, YRSURF, YRGMV5, and YRGFL5 are now passed by argument
!        O. Marsden: June 2015 CY42 YRGMV, YRGFL, YRSURF, YRGMV5, and YRGFL5 are now passed by argument
!        T. Montmerle: fev 2020 CY47 : put YDMTRAJ optional
!     ------------------------------------------------------------------

USE MODEL_DIAGNOSTICS_MOD , ONLY : MODEL_DIAGNOSTICS_TYPE
USE MODEL_GENERAL_CONF_MOD , ONLY : MODEL_GENERAL_CONF_TYPE
USE GEOMETRY_MOD , ONLY : GEOMETRY
USE MTRAJ_MOD  , ONLY : MTRAJ
USE YOMGFL     , ONLY : TGFL
USE YOMGMV     , ONLY : TGMV
USE PARKIND1 , ONLY : JPIM     ,JPRB
USE YOMHOOK  , ONLY : LHOOK,   DR_HOOK
USE YOMSP    , ONLY : SPVOR_FLT, SPDIV_FLT, SPUB_FLT, SPVB_FLT
USE YOMSP5   , ONLY : SPA5
USE YOMDYNA   ,ONLY : YRDYNA
USE SPECTRAL_FIELDS_MOD

!     ------------------------------------------------------------------

IMPLICIT NONE

TYPE(GEOMETRY), INTENT(IN) :: YDGEOMETRY
TYPE(TGFL) , INTENT(INOUT) :: YDGFL
TYPE(TGMV) , INTENT(INOUT) :: YDGMV
TYPE(MODEL_DIAGNOSTICS_TYPE),INTENT(INOUT):: YDML_DIAG
TYPE(MODEL_GENERAL_CONF_TYPE),INTENT(INOUT):: YDML_GCONF
CHARACTER(LEN=9)  ,INTENT(IN)    :: CDCONF 
TYPE(SPECTRAL_FIELD), INTENT(INOUT) :: YDSP
TYPE(MTRAJ), INTENT(INOUT), OPTIONAL  :: YDMTRAJ
!     ------------------------------------------------------------------
LOGICAL :: LLDERR,LLMODE,LLTRAJ
REAL(KIND=JPRB) :: ZHOOK_HANDLE

!     ------------------------------------------------------------------

#include "etransinv_mdl.intfb.h"
#include "abor1.intfb.h"

!     ------------------------------------------------------------------
IF (LHOOK) CALL DR_HOOK('ETRANSINVH',0,ZHOOK_HANDLE)
ASSOCIATE(YDDIM=>YDGEOMETRY%YRDIM, YDDIMV=>YDGEOMETRY%YRDIMV, &
  & YDGEM=>YDGEOMETRY%YRGEM, YDMP=>YDGEOMETRY%YRMP, YDLDDH=>YDML_DIAG%YRLDDH,YDDIMF=>YDML_GCONF%YRDIMF, &
  & YDSPDDH=>YDML_DIAG%YRSPDDH,YDGPDDH=>YDML_DIAG%YRGPDDH)

ASSOCIATE( &
 & GMV=>YDGMV%GMV, GMVS=>YDGMV%GMVS, &
 & LADER=>YDDIMF%LADER, &
 & SPTNDHD_DIV=>YDSPDDH%SPTNDHD_DIV, SPTNDHD_GFL=>YDSPDDH%SPTNDHD_GFL, &
 & SPTNDHD_SNHX=>YDSPDDH%SPTNDHD_SNHX, SPTNDHD_SPD=>YDSPDDH%SPTNDHD_SPD, &
 & SPTNDHD_SVD=>YDSPDDH%SPTNDHD_SVD, SPTNDHD_T=>YDSPDDH%SPTNDHD_T, &
 & SPTNDHD_VOR=>YDSPDDH%SPTNDHD_VOR, SPTNDSI_DIV=>YDSPDDH%SPTNDSI_DIV, &
 & SPTNDSI_SPD=>YDSPDDH%SPTNDSI_SPD, SPTNDSI_SVD=>YDSPDDH%SPTNDSI_SVD, &
 & SPTNDSI_T=>YDSPDDH%SPTNDSI_T, SPTNDSI_VOR=>YDSPDDH%SPTNDSI_VOR, &
 & GMVTNDSI_DDH=>YDGPDDH%GMVTNDSI_DDH, GMVTNDHD_DDH=>YDGPDDH%GMVTNDHD_DDH, &
 & GFLTNDHD_DDH=>YDGPDDH%GFLTNDHD_DDH, LRSIDDH=>YDLDDH%LRSIDDH, &
 & LRHDDDH=>YDLDDH%LRHDDDH)
!     ------------------------------------------------------------------

LLDERR = LLE(CDCONF(2:2),'F') .AND. LADER 
LLMODE = (CDCONF(2:3)=='AA').OR.(CDCONF(2:3)=='M1').OR.(CDCONF(2:3)=='GB')
LLTRAJ = (CDCONF(2:3)=='E0').OR.(CDCONF(2:3)=='K0').OR.(CDCONF(2:3)=='KD')

IF(LLMODE) THEN
  IF (YRDYNA%LGRADSP) THEN
    CALL ETRANSINV_MDL(YDGEOMETRY,YDGMV,YDML_DIAG%YRMDDH,YDML_GCONF,PSPVOR=YDSP%VOR,PSPDIV=YDSP%DIV,PSPMEANU=YDSP%UB,&
     & PSPMEANV=YDSP%VB,PSPSP=YDSP%SP,PSPHV=YDSP%HV,PSPGFL=YDSP%GFL,PGMV=GMV,&
     & PGMVS=GMVS,PGFL=YDGFL%GFL,LDERR=LLDERR,&
     & PSPTNDSI_VOR=SPTNDSI_VOR,PSPTNDSI_DIV=SPTNDSI_DIV,&
     & PSPTNDSI_T=SPTNDSI_T,PSPTNDSI_SPD=SPTNDSI_SPD,&
     & PSPTNDSI_SVD=SPTNDSI_SVD,&
     & PSPTNDHD_VOR=SPTNDHD_VOR,PSPTNDHD_DIV=SPTNDHD_DIV,&
     & PSPTNDHD_T=SPTNDHD_T,PSPTNDHD_SPD=SPTNDHD_SPD,&
     & PSPTNDHD_SVD=SPTNDHD_SVD,&
     & PSPTNDHD_SNHX=SPTNDHD_SNHX,PSPTNDHD_GFL=SPTNDHD_GFL,&
     & PGMVTNDSI=GMVTNDSI_DDH,PGMVTNDHD=GMVTNDHD_DDH,&
     & PGFLTNDHD=GFLTNDHD_DDH,LDSIDDH=LRSIDDH,LDHDDDH=LRHDDDH,&
     & PSPVOR_FLT=SPVOR_FLT,PSPDIV_FLT=SPDIV_FLT,&
     & PSPUB_FLT=SPUB_FLT,PSPVB_FLT=SPVB_FLT)
  ELSE
    CALL ETRANSINV_MDL(YDGEOMETRY,YDGMV,YDML_DIAG%YRMDDH,YDML_GCONF,PSPVOR=YDSP%VOR,PSPDIV=YDSP%DIV,PSPMEANU=YDSP%UB,&
     & PSPMEANV=YDSP%VB,PSPSP=YDSP%SP,PSPHV=YDSP%HV,PSPGFL=YDSP%GFL,PGMV=GMV,&
     & PGMVS=GMVS,PGFL=YDGFL%GFL,LDERR=LLDERR,&
     & PSPTNDSI_VOR=SPTNDSI_VOR,PSPTNDSI_DIV=SPTNDSI_DIV,&
     & PSPTNDSI_T=SPTNDSI_T,PSPTNDSI_SPD=SPTNDSI_SPD,&
     & PSPTNDSI_SVD=SPTNDSI_SVD,&
     & PSPTNDHD_VOR=SPTNDHD_VOR,PSPTNDHD_DIV=SPTNDHD_DIV,&
     & PSPTNDHD_T=SPTNDHD_T,PSPTNDHD_SPD=SPTNDHD_SPD,&
     & PSPTNDHD_SVD=SPTNDHD_SVD,&
     & PSPTNDHD_SNHX=SPTNDHD_SNHX,PSPTNDHD_GFL=SPTNDHD_GFL,&
     & PGMVTNDSI=GMVTNDSI_DDH,PGMVTNDHD=GMVTNDHD_DDH,&
     & PGFLTNDHD=GFLTNDHD_DDH,LDSIDDH=LRSIDDH,LDHDDDH=LRHDDDH)
  ENDIF
ELSEIF(LLTRAJ) THEN
  IF (PRESENT(YDMTRAJ)) THEN
     CALL ETRANSINV_MDL(YDGEOMETRY,YDGMV,YDML_DIAG%YRMDDH,YDML_GCONF,PSPVOR=SPA5%VOR, &
     & PSPDIV=SPA5%DIV,PSPMEANU=SPA5%UB,&
     & PSPMEANV=SPA5%VB,PSPSP=SPA5%SP,PSPHV=SPA5%HV,PSPGFL=SPA5%GFL,PGMV=YDMTRAJ%YRGMV5%GMV5,&
     & PGMVS=YDMTRAJ%YRGMV5%GMV5S,PGFL=YDMTRAJ%YRGFL5%GFL5,LDERR=LLDERR)
  ELSE
     CALL ABOR1(' ETRANSINVH - YDMTRAJ REQUIRED ')
  ENDIF
ELSE
  CALL ABOR1(' ETRANSINVH - CONFIGURATION NOT SUPPORTED ')
ENDIF

!     ------------------------------------------------------------------
END ASSOCIATE
END ASSOCIATE
IF (LHOOK) CALL DR_HOOK('ETRANSINVH',1,ZHOOK_HANDLE)
END SUBROUTINE ETRANSINVH
