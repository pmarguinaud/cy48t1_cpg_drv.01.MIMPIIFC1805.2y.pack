SUBROUTINE CPG_DIA_DDH (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDCPG_TND, YDCPG_MISC, YDCPG_GPAR, YDMF_PHYS, YDCPG_DYN0, &
                      & YDMF_PHYS_SURF, YDVARS, YDGMV, YDMODEL, KDDHI, PGMV, PGFL, POMEGA, PEXT, PCOVPTOT, PGMVTNDSI, &
                      & PGMVTNDHD, PGFLTNDHD, PDHCV, YDDDH, PFTCNS)

USE PARKIND1, ONLY : JPIM, JPRB

USE GEOMETRY_MOD       , ONLY : GEOMETRY
USE CPG_OPTS_TYPE_MOD   , ONLY : CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE CPG_TYPE_MOD       , ONLY : CPG_DYN_TYPE, CPG_MISC_TYPE, CPG_TND_TYPE, CPG_GPAR_TYPE
USE MF_PHYS_TYPE_MOD   , ONLY : MF_PHYS_TYPE
USE CPG_TYPE_MOD       , ONLY : CPG_DYN_TYPE, CPG_MISC_TYPE, CPG_TND_TYPE, CPG_GPAR_TYPE
USE MF_PHYS_SURFACE_TYPE_MOD,ONLY : MF_PHYS_SURF_TYPE
USE FIELD_VARIABLES_MOD, ONLY : FIELD_VARIABLES
USE YOMGMV             , ONLY : TGMV
USE TYPE_MODEL         , ONLY : MODEL
USE DDH_MIX            , ONLY : NTOTFIELD, RDDH_FIELD, RDDHSURF_FIELD, TYP_DDH


IMPLICIT NONE

TYPE(GEOMETRY)    ,INTENT(IN)    :: YDGEOMETRY
TYPE(CPG_BNDS_TYPE),INTENT(IN)   :: YDCPG_BNDS
TYPE(CPG_OPTS_TYPE),INTENT(IN)   :: YDCPG_OPTS
TYPE(CPG_TND_TYPE),INTENT(INOUT) :: YDCPG_TND
TYPE(CPG_MISC_TYPE),INTENT(INOUT):: YDCPG_MISC
TYPE(CPG_GPAR_TYPE),INTENT(INOUT):: YDCPG_GPAR
TYPE(MF_PHYS_TYPE),INTENT(INOUT) :: YDMF_PHYS
TYPE(CPG_DYN_TYPE),INTENT(INOUT) :: YDCPG_DYN0
TYPE(MF_PHYS_SURF_TYPE),INTENT(INOUT) :: YDMF_PHYS_SURF
TYPE(FIELD_VARIABLES),INTENT(INOUT) :: YDVARS
TYPE(TGMV)        ,INTENT(INOUT) :: YDGMV
TYPE(MODEL)       ,INTENT(INOUT) :: YDMODEL
INTEGER(KIND=JPIM),INTENT(IN)    :: KDDHI(YDGEOMETRY%YRDIM%NPROMA)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PGMV(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG,YDGMV%NDIMGMV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PGFL(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG,YDMODEL%YRML_GCONF%YGFL%NDIM)
REAL(KIND=JPRB)   ,INTENT(IN)    :: POMEGA(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PEXT(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG,YDMODEL%YRML_PHY_G%YRDPHY%NVEXTR)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PCOVPTOT(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG,1)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PGMVTNDSI(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG,2+YDMODEL%YRML_GCONF%YRDIMF%NFTHER)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PGMVTNDHD(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG,2+YDMODEL%YRML_GCONF%YRDIMF%NFTHER)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PGFLTNDHD(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG,1)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PDHCV(YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG,YDMODEL%YRML_DIAG%YRMDDH%NDHCVSUN)
TYPE(TYP_DDH)     ,INTENT(INOUT) :: YDDDH
REAL(KIND=JPRB) ,INTENT(INOUT) :: PFTCNS(YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG,6)

LOGICAL :: LLDYN
LOGICAL :: LLPHY
REAL(KIND=JPRB) :: ZDHCS(YDGEOMETRY%YRDIM%NPROMM,YDMODEL%YRML_DIAG%YRMDDH%NDHCSSU)
REAL(KIND=JPRB) :: ZDUM1(YDGEOMETRY%YRDIM%NPROMA)
REAL(KIND=JPRB) :: ZENTRA(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL(KIND=JPRB) :: ZENTRV(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL(KIND=JPRB) :: ZEXT(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG,YDMODEL%YRML_PHY_G%YRDPHY%NVEXTR)
REAL(KIND=JPRB) :: ZFPLCL(YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL(KIND=JPRB) :: ZFPLCN(YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL(KIND=JPRB) :: ZFPLSL(YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL(KIND=JPRB) :: ZFPLSN(YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL(KIND=JPRB) :: ZNEB(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL(KIND=JPRB) :: ZQICE(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL(KIND=JPRB) :: ZQLI(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL(KIND=JPRB) :: ZQRAIN(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL(KIND=JPRB) :: ZQS(YDGEOMETRY%YRDIM%NPROMA)
REAL(KIND=JPRB) :: ZQSAT(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL(KIND=JPRB) :: ZQSNOW(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL(KIND=JPRB) :: ZRH(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL(KIND=JPRB) :: ZTSOL(YDGEOMETRY%YRDIM%NPROMA)
REAL(KIND=JPRB) :: ZUZGEO(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL(KIND=JPRB) :: ZVMGEO(YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)

#include "cpcuddh.intfb.h"
#include "cpcuddh_omp.intfb.h"
#include "cpdyddh.intfb.h"
#include "cpphddh.intfb.h"
#include "gprh.intfb.h"

INTEGER (KIND=JPIM) :: JCV
INTEGER (KIND=JPIM) :: JEXT
INTEGER (KIND=JPIM) :: JROF


IF (YDMODEL%YRML_PHY_MF%YRARPHY%LMPA) THEN
  ZQICE(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG) = YDVARS%I%T0(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG)
  ZQLI(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG) = YDVARS%L%T0(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG)
  ZQRAIN(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG) = YDVARS%R%T0(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG)
  ZQSNOW(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG) = YDVARS%S%T0(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG)
ELSE
  IF(YDMODEL%YRML_PHY_MF%YRPHY%LMPHYS.OR.(YDMODEL%YRML_PHY_EC%YREPHY%LEPHYS.AND..NOT.YDMODEL%YRML_PHY_EC%YREPHY%LAGPHY).OR.YDMODEL%YRML_PHY_MF%YRSIMPHL%LSIMPH) THEN
    ZFPLCL(1:YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG) = YDMF_PHYS%OUT%FPLCL(1:YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
    ZFPLCN(1:YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG) = YDMF_PHYS%OUT%FPLCN(1:YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
    ZFPLSL(1:YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG) = YDMF_PHYS%OUT%FPLSL(1:YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
    ZFPLSN(1:YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG) = YDMF_PHYS%OUT%FPLSN(1:YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
  ENDIF
  ZQICE(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG) = YDCPG_MISC%QICE(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG)
  ZQLI(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG) = YDCPG_MISC%QLI(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG)
  ZQRAIN(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG) = YDCPG_MISC%QRAIN(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG)
  ZQSNOW(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG) = YDCPG_MISC%QSNOW(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG)
ENDIF

IF (YDMODEL%YRML_DIAG%YRSDDH%LHDPAS) THEN 
   IF (YDMODEL%YRML_PHY_G%YRDPHY%NVEXTR > 0) THEN
      DO JEXT=1,YDMODEL%YRML_PHY_G%YRDPHY%NVEXTR
         ZEXT(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG,JEXT)=PEXT(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG,JEXT)
      ENDDO
   ELSE
      ZEXT(1:YDGEOMETRY%YRDIM%NPROMA,1:YDGEOMETRY%YRDIMV%NFLEVG,:)=0.0_JPRB
   ENDIF
ENDIF 


IF(YDMODEL%YRML_PHY_EC%YREPHY%LAGPHY.OR.(.NOT.YDCPG_OPTS%LDIAB)) THEN

  LLPHY=.FALSE.
  CALL GPRH(.FALSE., YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, 1.0_JPRB, 0.0_JPRB, YDVARS%Q%T0, &
  & YDVARS%T%T0, YDCPG_DYN0%PREF, ZQSAT, ZRH)  

  ZDUM1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=0.0_JPRB

  IF(YDMODEL%YRML_GCONF%YGFL%YA%LACTIVE) THEN
    ZNEB(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS%A%T0(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
  ELSE
    IF (YDMODEL%YRML_PHY_MF%YRARPHY%LMPA) THEN
      ZNEB(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=0.0_JPRB    ! ???
    ELSE
      ZNEB(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDCPG_MISC%NEB(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
    ENDIF
  ENDIF


  ! * COMP. OF DYNAMICAL VARIABLES AND FLUX/TENDENCIES

  CALL CPDYDDH(YDGEOMETRY%YRVAB, YDGMV, YDMODEL%YRML_GCONF, YDMODEL%YRML_PHY_G%YRDPHY, YDMODEL%YRML_DIAG, YDMODEL%YRML_PHY_MF%YRPHY, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIM%NPROMNH,                 &
  & YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRGSGEOM(YDCPG_BNDS%KBL), YDGEOMETRY%YRCSGEOM(YDCPG_BNDS%KBL), YDCPG_DYN0%XYB%ZVIEW, YDCPG_DYN0%RCP%ZVIEW,     &
  & YDCPG_DYN0%PHI, YDCPG_DYN0%PHIF, YDCPG_DYN0%PHIFL, YDCPG_DYN0%PHIFM, YDCPG_DYN0%KENE, YDCPG_DYN0%RTL,           &
  & YDCPG_DYN0%RTM, YDCPG_DYN0%OROGL, YDCPG_DYN0%OROGM, YDCPG_DYN0%PREL, YDCPG_DYN0%PREM, YDCPG_DYN0%PREF,          &
  & YDCPG_DYN0%PRE, YDCPG_DYN0%NHPREF, YDCPG_DYN0%NHPREH, YDCPG_DYN0%QCHAL, YDCPG_DYN0%QCHAM, YDCPG_DYN0%CTY%ZVIEW, &
  & POMEGA, ZFPLCL, ZFPLCN, ZFPLSL, ZFPLSN, ZDUM1, ZDUM1, ZRH, ZNEB, ZQLI, ZQICE, ZQRAIN, ZQSNOW,                   &
  & ZEXT, PCOVPTOT, PGFL, PGMV, PGMVTNDSI, PGMVTNDHD, PGFLTNDHD, YDCPG_TND%ZVIEW, ZUZGEO, ZVMGEO,                   &
  & PDHCV, ZENTRA, ZENTRV, YDDDH)

ELSE

  IF(.NOT.(YDMODEL%YRML_PHY_MF%YRPHY%LMPHYS.OR.YDMODEL%YRML_PHY_EC%YREPHY%LEPHYS)) THEN
    LLPHY=.FALSE.
    CALL GPRH(.FALSE., YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, 1.0_JPRB, 0.0_JPRB, YDVARS%Q%T0, &
    & YDVARS%T%T0, YDCPG_DYN0%PREF, ZQSAT, ZRH)  
  ELSE
    IF (YDMODEL%YRML_PHY_MF%YRARPHY%LMPA) THEN
      CALL GPRH(.FALSE., YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, 1.0_JPRB, 0.0_JPRB, YDVARS%Q%T0, &
      & YDVARS%T%T0, YDCPG_DYN0%PREF, ZQSAT, ZRH)  
    ELSE
      ZRH(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDCPG_MISC%RH(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
    ENDIF
    LLPHY=.TRUE.
  ENDIF

  IF (YDMODEL%YRML_PHY_MF%YRARPHY%LMPA) THEN
    ZQS(1:YDGEOMETRY%YRDIM%NPROMA) =  YDCPG_GPAR%ZVIEW(1:YDGEOMETRY%YRDIM%NPROMA,YDMODEL%YRML_PHY_MF%YRPARAR%MVQS)
    ZTSOL(1:YDGEOMETRY%YRDIM%NPROMA) = YDCPG_GPAR%ZVIEW(1:YDGEOMETRY%YRDIM%NPROMA,YDMODEL%YRML_PHY_MF%YRPARAR%MVTS)
  ELSE 
    ZQS(1:YDGEOMETRY%YRDIM%NPROMA) =  YDCPG_MISC%QS(1:YDGEOMETRY%YRDIM%NPROMA)
    ZTSOL(1:YDGEOMETRY%YRDIM%NPROMA) = YDMF_PHYS_SURF%GSP_RR%PT_T0(1:YDGEOMETRY%YRDIM%NPROMA)
  ENDIF

  ! * COMP. OF DYNAMICAL VARIABLES AND FLUX/TENDENCIES

  CALL CPDYDDH(YDGEOMETRY%YRVAB, YDGMV, YDMODEL%YRML_GCONF, YDMODEL%YRML_PHY_G%YRDPHY, YDMODEL%YRML_DIAG, YDMODEL%YRML_PHY_MF%YRPHY, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIM%NPROMNH,                 &
  & YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRGSGEOM(YDCPG_BNDS%KBL), YDGEOMETRY%YRCSGEOM(YDCPG_BNDS%KBL), YDCPG_DYN0%XYB%ZVIEW, YDCPG_DYN0%RCP%ZVIEW,     &
  & YDCPG_DYN0%PHI, YDCPG_DYN0%PHIF, YDCPG_DYN0%PHIFL, YDCPG_DYN0%PHIFM, YDCPG_DYN0%KENE, YDCPG_DYN0%RTL,           &
  & YDCPG_DYN0%RTM, YDCPG_DYN0%OROGL, YDCPG_DYN0%OROGM, YDCPG_DYN0%PREL, YDCPG_DYN0%PREM, YDCPG_DYN0%PREF,          &
  & YDCPG_DYN0%PRE, YDCPG_DYN0%NHPREF, YDCPG_DYN0%NHPREH, YDCPG_DYN0%QCHAL, YDCPG_DYN0%QCHAM, YDCPG_DYN0%CTY%ZVIEW, &
  & POMEGA, ZFPLCL, ZFPLCN, ZFPLSL, ZFPLSN, ZQS, ZTSOL, ZRH, YDCPG_MISC%NEB, ZQLI, ZQICE, ZQRAIN,                   &
  & ZQSNOW, ZEXT, PCOVPTOT, PGFL, PGMV, PGMVTNDSI, PGMVTNDHD, PGFLTNDHD, YDCPG_TND%ZVIEW, ZUZGEO,                   &
  & ZVMGEO, PDHCV, ZENTRA, ZENTRV, YDDDH)

  ! * COMP. OF PHYS. FIELDS AND SURFACE FLUXES

  IF((YDMODEL%YRML_PHY_MF%YRPHY%LMPHYS.OR.YDMODEL%YRML_PHY_EC%YREPHY%LEPHYS).AND..NOT.YDMODEL%YRML_PHY_MF%YRARPHY%LMPA.AND..NOT.YDMODEL%YRML_DIAG%YRLDDH%LFLEXDIA) THEN
    CALL CPPHDDH (YDMODEL%YRML_DIAG, YDMODEL%YRML_PHY_EC%YREPHY, YDMODEL%YRML_GCONF%YRRIP, YDMODEL%YRML_PHY_MF, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA,                          &
    & YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, .TRUE., YDGEOMETRY%YRGSGEOM(YDCPG_BNDS%KBL), ZUZGEO, ZVMGEO, YDMF_PHYS_SURF%GSP_SG%PF_T0, YDMF_PHYS_SURF%GSP_SB%PT_T0, &
    & YDMF_PHYS_SURF%GSP_RR%PT_T0, YDMF_PHYS_SURF%GSP_SB%PQ_T0, YDMF_PHYS_SURF%GSP_RR%PW_T0, YDVARS%T%T0,                   &
    & YDMF_PHYS_SURF%GSD_VF%PLSM, YDMF_PHYS%OUT%DIFCQ, YDMF_PHYS%OUT%DIFCS, YDMF_PHYS%OUT%DIFTQ, YDMF_PHYS%OUT%DIFTS,       &
    & YDMF_PHYS%OUT%FCQNG, YDMF_PHYS%OUT%FPLCL, YDMF_PHYS%OUT%FPLCN, YDMF_PHYS%OUT%FPLSL, YDMF_PHYS%OUT%FPLSN,              &
    & YDMF_PHYS%OUT%FRSO, YDMF_PHYS%OUT%FRTH, YDMF_PHYS%OUT%FRTHDS, YDMF_PHYS%OUT%FHPCL, YDMF_PHYS%OUT%FHPCN,               &
    & YDMF_PHYS%OUT%FHPSL, YDMF_PHYS%OUT%FHPSN, YDMF_PHYS%OUT%STRCU, YDMF_PHYS%OUT%STRCV, YDMF_PHYS%OUT%STRDU,              &
    & YDMF_PHYS%OUT%STRDV, YDMF_PHYS%OUT%STRTU, YDMF_PHYS%OUT%STRTV, YDMF_PHYS%OUT%CT, YDMF_PHYS%OUT%FCHSP,                 &
    & YDMF_PHYS%OUT%FCLL, YDMF_PHYS%OUT%FCLN, YDMF_PHYS%OUT%FCS, YDMF_PHYS%OUT%FEVL, YDMF_PHYS%OUT%FEVN,                    &
    & YDMF_PHYS%OUT%FLWSP, YDMF_PHYS%OUT%FONTE, YDMF_PHYS%OUT%RUISP, YDMF_PHYS%OUT%RUISS, ZENTRA,                           &
    & ZENTRV, YDMF_PHYS%OUT%DIFTQL, YDMF_PHYS%OUT%DIFTQN, YDMF_PHYS%OUT%DIFCQL, YDMF_PHYS%OUT%DIFCQN,                       &
    & YDMF_PHYS%OUT%FCQLNG, YDMF_PHYS%OUT%FCQNNG, YDMF_PHYS%OUT%FHSCL, YDMF_PHYS%OUT%FHSCN, YDMF_PHYS%OUT%FHSSL,            &
    & YDMF_PHYS%OUT%FHSSN, YDMF_PHYS%OUT%FEPFP, YDMF_PHYS%OUT%FCMPCQ, YDMF_PHYS%OUT%FCMPSN, YDMF_PHYS%OUT%FCMPSL,           &
    & YDMF_PHYS%OUT%FCCQL, YDMF_PHYS%OUT%FCCQN, YDMF_PHYS%OUT%FCSQL, YDMF_PHYS%OUT%FCSQN, YDMF_PHYS%OUT%FPFPSL,             &
    & YDMF_PHYS%OUT%FPFPSN, YDMF_PHYS%OUT%FPFPCL, YDMF_PHYS%OUT%FPFPCN, YDMF_PHYS%OUT%FPEVPSL, YDMF_PHYS%OUT%FPEVPSN,       &
    & YDMF_PHYS%OUT%FPEVPCL, YDMF_PHYS%OUT%FPEVPCN, YDMF_PHYS%OUT%FCQRNG, YDMF_PHYS%OUT%FCQSNG, YDCPG_DYN0%PHI,             &
    & YDMF_PHYS%OUT%UCLS, YDMF_PHYS%OUT%VCLS, YDMF_PHYS%OUT%TCLS, YDMF_PHYS%OUT%QCLS, YDMF_PHYS%OUT%CLPH,                   &
    & YDMF_PHYS%OUT%ALB, YDMF_PHYS%OUT%GZ0, YDMF_PHYS%OUT%GZ0H, PDHCV, ZDHCS, PFTCNS)
  ENDIF

  IF(YDMODEL%YRML_PHY_MF%YRPHY%LMPHYS.AND.YDMODEL%YRML_PHY_MF%YRARPHY%LMPA) THEN

    ! Surface variables and fluxes set to zero.
    ! There are no surface variables for AROME in DDH, yet.
    IF(LLPHY) THEN
      DO JROF = 1, YDGEOMETRY%YRDIM%NPROMM
        DO JCV = 1, YDMODEL%YRML_DIAG%YRMDDH%NDHCSSU
          ZDHCS(JROF,JCV)=0_JPRB
        ENDDO
      ENDDO
    ENDIF

  ENDIF

ENDIF

! * STORE/ACCUM. IN HORIZONTAL MEAN ARRAYS

LLDYN=.TRUE.

IF (YDMODEL%YRML_DIAG%YRLDDH%LFLEXDIA) THEN
  IF (YDMODEL%YRML_DIAG%YRLDDH%LDDH_OMP) THEN
    CALL CPCUDDH_OMP(YDMODEL%YRML_DIAG%YRMDDH, YDMODEL%YRML_DIAG%YRTDDH, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, &
    & YDGEOMETRY%YRDIMV%NFLEVG, KDDHI, YDDDH, LLDYN)
  ELSE
    CALL CPCUDDH(YDMODEL%YRML_DIAG, YDMODEL%YRML_GCONF%YRRIP, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, &
    & KDDHI, YDCPG_MISC%DHSF, RDDH_FIELD, RDDHSURF_FIELD, LLDYN, LLPHY, NTOTFIELD)
  ENDIF 
ELSE 
  CALL CPCUDDH(YDMODEL%YRML_DIAG, YDMODEL%YRML_GCONF%YRRIP, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, KDDHI, &
  & YDCPG_MISC%DHSF, PDHCV, ZDHCS, LLDYN, LLPHY, YDMODEL%YRML_DIAG%YRMDDH%NDHCVSUN)
ENDIF 
  

END SUBROUTINE
