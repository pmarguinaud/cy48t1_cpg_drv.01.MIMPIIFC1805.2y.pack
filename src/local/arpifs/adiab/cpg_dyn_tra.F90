SUBROUTINE CPG_DYN_TRA (YDGEOMETRY, YDCPG_BNDS, YDCPG_DYN9, YDVARS, YDMODEL, PB1, PB2, PTRAJ_SLAG)

USE PARKIND1, ONLY : JPIM, JPRB

USE GEOMETRY_MOD , ONLY : GEOMETRY
USE CPG_OPTS_TYPE_MOD, ONLY : CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE CPG_TYPE_MOD,ONLY : CPG_DYN_TYPE, CPG_MISC_TYPE, CPG_TND_TYPE
USE FIELD_VARIABLES_MOD,ONLY : FIELD_VARIABLES
USE TYPE_MODEL   , ONLY : MODEL
USE YOMTRAJ  , ONLY : TRAJ_SLAG_TYPE,  LPRTTRAJ, LTRAJSAVE, LTRAJSLAG
USE YOMLUN   , ONLY : NULOUT
USE YOMDYNA  , ONLY : LSLHD, LSLHD_STATIC


IMPLICIT NONE

TYPE(GEOMETRY)       ,INTENT(IN)    :: YDGEOMETRY
TYPE(CPG_BNDS_TYPE)   ,INTENT(IN)   :: YDCPG_BNDS
TYPE(CPG_DYN_TYPE)   ,INTENT(INOUT) :: YDCPG_DYN9
TYPE(FIELD_VARIABLES),INTENT(INOUT) :: YDVARS
TYPE(MODEL)          ,INTENT(INOUT) :: YDMODEL
REAL(KIND=JPRB)      ,INTENT(INOUT) :: PB1(YDGEOMETRY%YRDIM%NPROMA,YDMODEL%YRML_DYN%YRPTRSLB1%NFLDSLB1)
REAL(KIND=JPRB)      ,INTENT(INOUT) :: PB2(YDGEOMETRY%YRDIM%NPROMA,YDMODEL%YRML_DYN%YRPTRSLB2%NFLDSLB2)
TYPE (TRAJ_SLAG_TYPE),INTENT(INOUT) :: PTRAJ_SLAG

INTEGER(KIND=JPIM) :: JJOFF
REAL(KIND=JPRB) :: ZTSTEP

INTEGER (KIND=JPIM) :: JGFL

IF (YDMODEL%YRML_GCONF%YRRIP%TSTEP == 0.0_JPRB) THEN
  ZTSTEP=1.0_JPRB
ELSE
  ZTSTEP=YDMODEL%YRML_GCONF%YRRIP%TSTEP
ENDIF
PTRAJ_SLAG%PUL95(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1U9+1-YDGEOMETRY%YRDIMV%NFLSA:YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1U9+YDGEOMETRY%YRDIMV%NFLEVG-YDGEOMETRY%YRDIMV%NFLSA)
PTRAJ_SLAG%PVL95(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1V9+1-YDGEOMETRY%YRDIMV%NFLSA:YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1V9+YDGEOMETRY%YRDIMV%NFLEVG-YDGEOMETRY%YRDIMV%NFLSA)
PTRAJ_SLAG%PTL95(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1T9+1-YDGEOMETRY%YRDIMV%NFLSA:YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1T9+YDGEOMETRY%YRDIMV%NFLEVG-YDGEOMETRY%YRDIMV%NFLSA)
DO JGFL=1,YDMODEL%YRML_GCONF%YGFL%NUMFLDS
  IF(YDMODEL%YRML_GCONF%YGFL%YCOMP(JGFL)%LADV) THEN
    JJOFF=(YDGEOMETRY%YRDIMV%NFLEN-YDGEOMETRY%YRDIMV%NFLSA+1)*(YDMODEL%YRML_GCONF%YGFL%YCOMP(JGFL)%MP_SL1-1)-YDGEOMETRY%YRDIMV%NFLSA
    PTRAJ_SLAG%PGFLL95(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG,YDMODEL%YRML_GCONF%YGFL%YCOMP(JGFL)%MP_SL1) =&
       & PB1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1GFL9+1+JJOFF:YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1GFL9+YDGEOMETRY%YRDIMV%NFLEVG+JJOFF)
    ! store absolute position as a label for recognition in the TL/AD code
    PTRAJ_SLAG%IGFLL95(YDMODEL%YRML_GCONF%YGFL%YCOMP(JGFL)%MP_SL1) = YDMODEL%YRML_GCONF%YGFL%YCOMP(JGFL)%MP
  ENDIF
ENDDO
! Some fields are tendencies which include a TSTEP factor which may
! be different when fields will be read in.
PTRAJ_SLAG%PCL95(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1C9+1-YDGEOMETRY%YRDIMV%NFLSA:YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1C9+YDGEOMETRY%YRDIMV%NFLEVG-YDGEOMETRY%YRDIMV%NFLSA)/ZTSTEP
PTRAJ_SLAG%PUL05(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1U0+1-YDGEOMETRY%YRDIMV%NFLSA:YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1U0+YDGEOMETRY%YRDIMV%NFLEVG-YDGEOMETRY%YRDIMV%NFLSA)/ZTSTEP
PTRAJ_SLAG%PVL05(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1V0+1-YDGEOMETRY%YRDIMV%NFLSA:YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1V0+YDGEOMETRY%YRDIMV%NFLEVG-YDGEOMETRY%YRDIMV%NFLSA)/ZTSTEP
PTRAJ_SLAG%PTL05(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1T0+1-YDGEOMETRY%YRDIMV%NFLSA:YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1T0+YDGEOMETRY%YRDIMV%NFLEVG-YDGEOMETRY%YRDIMV%NFLSA)/ZTSTEP
IF (YDMODEL%YRML_DYN%YRDYN%LADVF.AND.YDMODEL%YRML_DYN%YRDYN%L2TLFF) THEN
  PTRAJ_SLAG%PUT15(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS%U%T1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
  PTRAJ_SLAG%PVT15(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS%V%T1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
ENDIF
PTRAJ_SLAG%PURL05(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1UR0+1-YDGEOMETRY%YRDIMV%NFLSA:YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1UR0+YDGEOMETRY%YRDIMV%NFLEVG-YDGEOMETRY%YRDIMV%NFLSA)
PTRAJ_SLAG%PVRL05(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1VR0+1-YDGEOMETRY%YRDIMV%NFLSA:YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1VR0+YDGEOMETRY%YRDIMV%NFLEVG-YDGEOMETRY%YRDIMV%NFLSA)
IF (YDMODEL%YRML_DYN%YRDYN%LSLDP_CURV) THEN
  PTRAJ_SLAG%PZRL05(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1ZR0+1-YDGEOMETRY%YRDIMV%NFLSA:YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1ZR0+YDGEOMETRY%YRDIMV%NFLEVG-YDGEOMETRY%YRDIMV%NFLSA)
ENDIF
PTRAJ_SLAG%PWRL05(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1WR0+1-YDGEOMETRY%YRDIMV%NFLSA:YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1WR0+YDGEOMETRY%YRDIMV%NFLEVG-YDGEOMETRY%YRDIMV%NFLSA)
IF (YDMODEL%YRML_DYN%YRDYN%LSLDP_RK) THEN
  PTRAJ_SLAG%PURL005(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1UR00+1-YDGEOMETRY%YRDIMV%NFLSA:YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1UR00+YDGEOMETRY%YRDIMV%NFLEVG-YDGEOMETRY%YRDIMV%NFLSA)
  PTRAJ_SLAG%PVRL005(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1VR00+1-YDGEOMETRY%YRDIMV%NFLSA:YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1VR00+YDGEOMETRY%YRDIMV%NFLEVG-YDGEOMETRY%YRDIMV%NFLSA)
  IF (YDMODEL%YRML_DYN%YRDYN%LSLDP_CURV) THEN
    PTRAJ_SLAG%PZRL005(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1ZR00+1-YDGEOMETRY%YRDIMV%NFLSA:YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1ZR00+YDGEOMETRY%YRDIMV%NFLEVG-YDGEOMETRY%YRDIMV%NFLSA)
  ENDIF
  PTRAJ_SLAG%PWRL005(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1WR00+1-YDGEOMETRY%YRDIMV%NFLSA:YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1WR00+YDGEOMETRY%YRDIMV%NFLEVG-YDGEOMETRY%YRDIMV%NFLSA)
ENDIF
PTRAJ_SLAG%PURL5(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB2(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB2%MSLB2URL:YDMODEL%YRML_DYN%YRPTRSLB2%MSLB2URL+YDGEOMETRY%YRDIMV%NFLEVG-1)
PTRAJ_SLAG%PVRL5(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB2(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB2%MSLB2VRL:YDMODEL%YRML_DYN%YRPTRSLB2%MSLB2VRL+YDGEOMETRY%YRDIMV%NFLEVG-1)
PTRAJ_SLAG%PWRL5(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB2(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB2%MSLB2WRL:YDMODEL%YRML_DYN%YRPTRSLB2%MSLB2WRL+YDGEOMETRY%YRDIMV%NFLEVG-1)
IF (LSLHD.AND.(.NOT.LSLHD_STATIC)) THEN
  PTRAJ_SLAG%PKAPPA5(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB2(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB2%MSLB2KAPPA:YDMODEL%YRML_DYN%YRPTRSLB2%MSLB2KAPPA+YDGEOMETRY%YRDIMV%NFLEVG-1)
  IF (YDMODEL%YRML_DYN%YRDYN%LSLHDHEAT) THEN
    PTRAJ_SLAG%PKAPPAT5(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=PB2(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB2%MSLB2KAPPAT:YDMODEL%YRML_DYN%YRPTRSLB2%MSLB2KAPPAT+YDGEOMETRY%YRDIMV%NFLEVG-1)
  ENDIF
ENDIF
IF (YDMODEL%YRML_DYN%YRDYN%LSETTLSVF) THEN
  PTRAJ_SLAG%PWRL95(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDCPG_DYN9%WRL(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
ENDIF
PTRAJ_SLAG%PX95(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=PB1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDMODEL%YRML_DYN%YRPTRSLB1%MSLB1SP9)

IF (LPRTTRAJ.AND.PTRAJ_SLAG%LASTCHUNK) WRITE(NULOUT,*)'GREPTRAJ STORE TRAJ_SLAG in CPG_DYN'

END SUBROUTINE
