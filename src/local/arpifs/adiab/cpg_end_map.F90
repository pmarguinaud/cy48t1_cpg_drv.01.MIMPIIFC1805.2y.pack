SUBROUTINE CPG_END_MAP (YDGEOMETRY, YDMODEL, YDVARS, YDCPG_BNDS, YDCPG_OPTS)

USE PARKIND1, ONLY : JPIM, JPRB

USE GEOMETRY_MOD , ONLY : GEOMETRY
USE TYPE_MODEL         , ONLY : MODEL
USE FIELD_VARIABLES_MOD, ONLY : FIELD_VARIABLES
USE CPG_OPTS_TYPE_MOD, ONLY : CPG_BNDS_TYPE, CPG_OPTS_TYPE


IMPLICIT NONE

TYPE(GEOMETRY)        ,INTENT(IN)     :: YDGEOMETRY
TYPE(MODEL)           ,INTENT(INOUT)  :: YDMODEL
TYPE(FIELD_VARIABLES) ,INTENT(INOUT)  :: YDVARS
TYPE(CPG_BNDS_TYPE)   ,INTENT(IN)     :: YDCPG_BNDS
TYPE(CPG_OPTS_TYPE)   ,INTENT(IN)     :: YDCPG_OPTS
INTEGER(KIND=JPIM) :: IFLAG
LOGICAL    :: LLSTR
REAL(KIND=JPRB) :: ZEPS

#include "gpmpfc_expl.intfb.h"

!*    3.    DIVIDE BY MAPPING FACTOR.
!           -------------------------

ZEPS=100.0_JPRB*TINY(1.0_JPRB)
LLSTR=(ABS(YDGEOMETRY%YRGEM%RSTRET-1.0_JPRB)>ZEPS)

IF (LLSTR.AND.(.NOT.YDMODEL%YRML_PHY_EC%YREPHY%LAGPHY)) THEN
  IFLAG=1
  CALL GPMPFC_EXPL(YDCPG_OPTS%LNHDYN, YDMODEL%YRML_DYN%YRDYNA%LNHXDER, YDMODEL%YRML_DYN%YRDYNA%LPC_FULL, YDCPG_OPTS%LTWOTL, YDVARS, YDMODEL%YRML_GCONF, YDMODEL%YRML_DYN%YRDYN, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA,          &
  & IFLAG, YDVARS%GEOMETRY%GM%T0)
ENDIF

END SUBROUTINE
