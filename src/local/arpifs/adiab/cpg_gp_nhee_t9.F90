SUBROUTINE CPG_GP_NHEE_T9 (YDGEOMETRY, YDCPG_BNDS, YDVARS, YDCPG_DYN0, YDMODEL, LDGPXX, LDGWADV, &
                         & LDRDBBC, LDVERTFE, LDVFE_GW, LD_RDRY_VD, KVDVAR, P_GPHL_T0, P_GPHM_T0, P_NHPPI_T0, P_NHXS_T0, &
                         & P_SVDINCR13_T0, P_ZERO_T0, YDCPG_DYN9, LDLDIAB, LDMPA)

USE PARKIND1, ONLY : JPIM, JPRB
USE YOMHOOK  , ONLY : LHOOK, DR_HOOK

USE GEOMETRY_MOD,        ONLY : GEOMETRY
USE CPG_OPTS_TYPE_MOD,   ONLY : CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE FIELD_VARIABLES_MOD, ONLY : FIELD_VARIABLES
USE CPG_TYPE_MOD,        ONLY : CPG_DYN_TYPE
USE TYPE_MODEL,          ONLY : MODEL
USE CPG_TYPE_MOD,        ONLY : CPG_DYN_TYPE
USE YOMCVER,             ONLY : LVERTFE, LVFE_ECMWF, LVFE_GW
USE YOMDYNA,             ONLY : NVDVAR, NPDVAR, LAPRXPK, NDLNPR, RHYDR0
USE YOMVERT,             ONLY : TOPPRES

IMPLICIT NONE

TYPE(GEOMETRY),       INTENT(IN)    :: YDGEOMETRY
TYPE(CPG_BNDS_TYPE),  INTENT(IN)    :: YDCPG_BNDS
TYPE(FIELD_VARIABLES),INTENT(INOUT) :: YDVARS
TYPE(CPG_DYN_TYPE),   INTENT(INOUT) :: YDCPG_DYN0
TYPE(MODEL),          INTENT(INOUT) :: YDMODEL
LOGICAL,              INTENT(IN)    :: LDGPXX
LOGICAL,              INTENT(IN)    :: LDGWADV
LOGICAL,              INTENT(IN)    :: LDRDBBC
LOGICAL,              INTENT(IN)    :: LDVERTFE
LOGICAL,              INTENT(IN)    :: LDVFE_GW
LOGICAL,              INTENT(IN)    :: LD_RDRY_VD
INTEGER (KIND=JPIM),  INTENT(IN)    :: KVDVAR
REAL (KIND=JPRB),     INTENT(INOUT) :: P_GPHL_T0 (YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB),     INTENT(INOUT) :: P_GPHM_T0 (YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB),     INTENT(INOUT) :: P_NHPPI_T0 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB),     INTENT(INOUT) :: P_NHXS_T0 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB),     INTENT(INOUT) :: P_SVDINCR13_T0 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB),     INTENT(INOUT) :: P_ZERO_T0 (YDGEOMETRY%YRDIM%NPROMA)
TYPE(CPG_DYN_TYPE),   INTENT(INOUT) :: YDCPG_DYN9
LOGICAL,              INTENT(IN)    :: LDLDIAB
LOGICAL,              INTENT(IN)    :: LDMPA

#include "gnhee_svdincr13.intfb.h"
#include "gnhpre.intfb.h"
#include "gnhpreh.intfb.h"
#include "gpgeo.intfb.h"
#include "gpgw.intfb.h"
#include "gphluv_expl.intfb.h"
#include "gphpre_expl.intfb.h"
#include "gprcp_ydvars.intfb.h"
#include "gpuvs.intfb.h"
#include "gpxx.intfb.h"
#include "gpyy.intfb.h"

REAL (KIND=JPRB) :: Z_DELNHPRE_T9 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_DVERW_T9 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_DVER_T9 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_GDW_T9 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_GWHT_T9 (YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_NHPPI_T9 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_PDEP_T9 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_R0T_T9 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_RDT_T9 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_RNHPPI_T9 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_RRED_T9 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_US_T9 (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB) :: Z_UVH_UH_T9 (YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_UVH_VH_T9 (YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_UVH_WWI_T9 (YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_VS_T9 (YDGEOMETRY%YRDIM%NPROMA)

LOGICAL :: LLDER
LOGICAL :: LLGDWI

INTEGER (KIND=JPIM) :: JLEV
INTEGER (KIND=JPIM) :: JROF

REAL(KIND=JPRB) :: ZHOOK_HANDLE

IF (LHOOK) CALL DR_HOOK('CPG_GP_NHEE_T9', 0, ZHOOK_HANDLE)

!*     3.2.1 COMPUTE PRE9, PXYB9, PRE9F.

CALL GPHPRE_EXPL(LAPRXPK, LVERTFE, NDLNPR, RHYDR0, TOPPRES, YDMODEL%YRCST, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY%YRVAB, YDCPG_DYN9%PRE, PRESF=YDCPG_DYN9%PREF,   &
& PDELP=YDCPG_DYN9%XYB%DELP, PLNPR=YDCPG_DYN9%XYB%LNPR, PRDELP=YDCPG_DYN9%XYB%RDELP, PALPH=YDCPG_DYN9%XYB%ALPH, &
& PRTGR=YDCPG_DYN9%XYB%RTGR, PRPRE=YDCPG_DYN9%XYB%RPRE, PRPP=YDCPG_DYN9%XYB%RPP)

!*     3.2.3 COMPUTE "R", "Cp" AND "Kap=R/Cp".

CALL GPRCP_YDVARS (YDMODEL%YRCST, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, YDVARS=YDVARS, KGFLTYP=9, &
                 & PCP=YDCPG_DYN9%RCP%CP, PR=YDCPG_DYN9%RCP%R)

!*     3.2.4 COMPUTE "RT".

! ZR0T9 is used in calculation of NHX(t-dt).
Z_R0T_T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS%T%T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)*YDCPG_DYN0%RCP%R(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)

! ZRDT9 is the (RT) at "t-dt" used in the definition of "dver":
IF (LD_RDRY_VD) THEN
  Z_RDT_T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDMODEL%YRCST%RD*YDVARS%T%T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
ELSE
  ! use of R_moist at time t to be consistent with ZR0T9 and ZDVER9.
  DO JLEV=1,YDGEOMETRY%YRDIMV%NFLEVG
    DO JROF=YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
      Z_RDT_T9(JROF,JLEV)=YDCPG_DYN0%RCP%R(JROF,JLEV)*YDVARS%T%T9(JROF,JLEV)
    ENDDO
  ENDDO
ENDIF

!*     3.2.6 COMPUTE QUANTITIES FOR NHEE MODEL.

CALL GNHPRE(NPDVAR, YDGEOMETRY, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDVARS%SPD%T9, YDCPG_DYN9%PREF, &
& PNHPREF=YDCPG_DYN9%NHPREF, PNHPPI=Z_NHPPI_T9, PRNHPPI=Z_RNHPPI_T9, PDEP=Z_PDEP_T9)
DO JLEV=1,YDGEOMETRY%YRDIMV%NFLEVG
  Z_RRED_T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,JLEV)=YDCPG_DYN9%RCP%R(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,JLEV)/Z_NHPPI_T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,JLEV)
ENDDO
CALL GNHPREH(LVERTFE, LVFE_ECMWF, NPDVAR, YDGEOMETRY, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDVARS%SPD%T9, YDCPG_DYN9%PRE, &
& YDCPG_DYN9%XYB%DELP, YDCPG_DYN9%XYB%LNPR, Z_NHPPI_T9, YDCPG_DYN9%NHPREF, YDCPG_DYN9%NHPREH,               &
& Z_DELNHPRE_T9  )

!*     3.2.8 COMPUTES THE GEOPOTENTIAL HEIGHT "gz" AND ITS GRADIENT.

! * "gz" at full levels and half levels.
IF (LDLDIAB.OR.YDMODEL%YRML_PHY_MF%YRSIMPHL%LSIMPH) THEN
  YDCPG_DYN9%PHI(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS%GEOMETRY%OROG%T0(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)
  CALL GPGEO(YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, YDCPG_DYN9%PHI, YDCPG_DYN9%PHIF, YDVARS%T%T9, &
  & Z_RRED_T9, YDCPG_DYN9%XYB%LNPR, YDCPG_DYN9%XYB%ALPH, YDGEOMETRY%YRVERT_GEOM)
ENDIF

!*     3.2.10 COMPUTES HALF-LEVEL WINDS.

! Not needed if Z-term and X-term are calculated FE
IF (LDGPXX .AND. .NOT.LDVERTFE) THEN
  ! * same remark as for time t half-level winds.
  Z_UVH_WWI_T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDCPG_DYN0%UVH%WWI(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
  CALL GPHLUV_EXPL(YDGEOMETRY%YRDIMV, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDVARS%U%T9, YDVARS%V%T9, &
  & PWWI=Z_UVH_WWI_T9, PUH=Z_UVH_UH_T9, PVH=Z_UVH_VH_T9)
ENDIF

LLDER=.FALSE.
CALL GPUVS(YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, LLDER, YDVARS%U%T9, YDVARS%V%T9, &
& Z_US_T9, Z_VS_T9)

!*     3.2.13a COMPUTES TERM "NHX".

! caution: must use "R" and "pre/prehyd" at time t.
IF (LDGPXX) THEN
  CALL GPXX(LVERTFE, YDGEOMETRY, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, P_GPHL_T0, P_GPHM_T0, YDCPG_DYN0%PHIFL, &
  & YDCPG_DYN0%PHIFM, YDCPG_DYN9%XYB%LNPR, Z_R0T_T9, YDVARS%U%T9, YDVARS%V%T9, Z_UVH_UH_T9,                         &
  & Z_UVH_VH_T9, P_NHXS_T0, PNHPPI=P_NHPPI_T0)
  IF (KVDVAR == 3 .OR. KVDVAR == 4) THEN
    ! NHX = NHX_S
    YDCPG_DYN9%NHX(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=P_NHXS_T0(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
  ELSEIF (KVDVAR == 5) THEN
    ! NHX = NHX_S - (d13 - dver)
    CALL GNHEE_SVDINCR13(LVERTFE, LVFE_GW, YDGEOMETRY, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_DYN0%OROGL,    &
    & YDCPG_DYN0%OROGM, Z_UVH_UH_T9, Z_UVH_VH_T9, PLNPR=YDCPG_DYN9%XYB%LNPR, PRT=Z_RDT_T9, PNHPPI=Z_NHPPI_T9, &
    & PSVDINCR13=P_SVDINCR13_T0)
    YDCPG_DYN9%NHX(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=P_NHXS_T0(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)-P_SVDINCR13_T0(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
  ENDIF
ELSE
  ! This case only occurs for a subset of NVDVAR= 4 or 5 cases
  ! PNHXT9 and PGMV.,.,YT9%MNHX) always stores NHX; calculation of NHX_S is
  ! useless.
  YDCPG_DYN9%NHX(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS%NHX%T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
ENDIF

!*     3.1.13b COMPUTES TERM "NHY"

IF (KVDVAR == 5 .AND. LDGWADV) THEN
  CALL GPYY(LVERTFE, LVFE_GW, YDGEOMETRY, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_DYN0%OROGL, YDCPG_DYN0%OROGM, &
  & Z_UVH_UH_T9, Z_UVH_VH_T9, YDCPG_DYN9%NHY)
ELSE
  YDCPG_DYN9%NHY(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,0:YDGEOMETRY%YRDIMV%NFLEVG) = 0.0_JPRB
ENDIF


!*     3.2.14 COMPUTES dver.

IF (KVDVAR == 3) THEN
  Z_DVER_T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS%SVD%T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
ELSEIF (KVDVAR == 4) THEN
  Z_DVER_T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS%SVD%T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)-YDCPG_DYN9%NHX(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
ELSEIF (KVDVAR == 5) THEN
  ! d13 in ZDVERW9
  Z_DVERW_T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS%SVD%T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)-YDCPG_DYN9%NHX(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
  ! dver in ZDVER9
  CALL GNHEE_SVDINCR13(LVERTFE, LVFE_GW, YDGEOMETRY, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_DYN0%OROGL,    &
  & YDCPG_DYN0%OROGM, Z_UVH_UH_T9, Z_UVH_VH_T9, PLNPR=YDCPG_DYN9%XYB%LNPR, PRT=Z_RDT_T9, PNHPPI=Z_NHPPI_T9, &
  & PSVDINCR13=P_SVDINCR13_T0)
  Z_DVER_T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=Z_DVERW_T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)-P_SVDINCR13_T0(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
ENDIF

!*     3.2.16 COMPUTES term [gw] or [gW].

! Caution: must use consistent definitions of RT in ZRDT9 and ZDVER9.
IF (KVDVAR==3 .OR. KVDVAR==4) THEN
  LLGDWI=.FALSE.
  IF (LDGWADV.AND.LDVFE_GW) THEN
    ! PGDW is required (at least for SL3TL)
    CALL GPGW(YDGEOMETRY, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, LDMPA, LLGDWI, YDCPG_DYN0%OROGL, &
    & YDCPG_DYN0%OROGM, YDCPG_DYN9%XYB%LNPR, YDCPG_DYN9%XYB%ALPH, Z_US_T9, Z_VS_T9, Z_RDT_T9,                  &
    & Z_DVER_T9, Z_GWHT_T9, YDCPG_DYN9%GWFT, PRNHPPI=Z_RNHPPI_T9, PGDW=Z_GDW_T9)

    YDCPG_DYN9%GWT(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDCPG_DYN9%GWFT(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
  ELSE
    CALL GPGW(YDGEOMETRY, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, LDMPA, LLGDWI, YDCPG_DYN0%OROGL, &
    & YDCPG_DYN0%OROGM, YDCPG_DYN9%XYB%LNPR, YDCPG_DYN9%XYB%ALPH, Z_US_T9, Z_VS_T9, Z_RDT_T9,                  &
    & Z_DVER_T9, Z_GWHT_T9, YDCPG_DYN9%GWFT, PRNHPPI=Z_RNHPPI_T9)

    IF (LDGWADV) YDCPG_DYN9%GWT(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=Z_GWHT_T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,0:YDGEOMETRY%YRDIMV%NFLEVG-1)
  ENDIF

  IF (LDRDBBC) THEN
    ! PGWS contains (gw)_surf
    YDCPG_DYN0%GWS(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=Z_GWHT_T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDGEOMETRY%YRDIMV%NFLEVG)
  ENDIF
ELSEIF (KVDVAR==5) THEN
  ! Case LVFE_GW is ignored and not coded.
  ! -- Modified W
  LLGDWI=.FALSE.
  CALL GPGW(YDGEOMETRY, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, LDMPA, LLGDWI,          &
  & P_ZERO_T0, P_ZERO_T0, YDCPG_DYN9%XYB%LNPR, YDCPG_DYN9%XYB%ALPH, P_ZERO_T0, P_ZERO_T0, Z_RDT_T9, &
  & Z_DVERW_T9, Z_GWHT_T9, YDCPG_DYN9%GWFT, PRNHPPI=Z_RNHPPI_T9)

  IF (LDGWADV) YDCPG_DYN9%GWT(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=Z_GWHT_T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,0:YDGEOMETRY%YRDIMV%NFLEVG-1)

  IF (LDRDBBC) THEN
    ! PGWS contains 0
    YDCPG_DYN0%GWS(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=0.0_JPRB
  ENDIF
ENDIF

IF (LHOOK) CALL DR_HOOK('CPG_GP_NHEE_T9', 1, ZHOOK_HANDLE)

END SUBROUTINE
