SUBROUTINE CPG_GP_NHQE_T9 (YDGEOMETRY, YDCPG_BNDS, YDVARS, YDCPG_DYN0, YDMODEL, LDGPXX, LDGWADV, LDDER, &
                         & LDGDWI, LDRDBBC, LDVERTFE, LDVFE_GW, P_GPHL_T0, P_GPHM_T0, P_ONE_T0, YDCPG_DYN9, &
                         & LDLDIAB, LDMPA)

USE PARKIND1, ONLY : JPIM, JPRB
USE YOMHOOK  , ONLY : LHOOK, DR_HOOK

USE GEOMETRY_MOD,       ONLY : GEOMETRY
USE CPG_OPTS_TYPE_MOD,  ONLY : CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE FIELD_VARIABLES_MOD,ONLY : FIELD_VARIABLES
USE CPG_TYPE_MOD,       ONLY : CPG_DYN_TYPE
USE TYPE_MODEL,         ONLY : MODEL
USE CPG_TYPE_MOD,       ONLY : CPG_DYN_TYPE
USE YOMDYNA,            ONLY : NVDVAR, NPDVAR, LRUBC, LAPRXPK, NDLNPR, RHYDR0
USE YOMCVER,            ONLY : LVERTFE
USE YOMVERT,            ONLY : TOPPRES
 
IMPLICIT NONE

TYPE(GEOMETRY),        INTENT(IN)    :: YDGEOMETRY
TYPE(CPG_BNDS_TYPE),   INTENT(IN)    :: YDCPG_BNDS
TYPE(FIELD_VARIABLES), INTENT(INOUT) :: YDVARS
TYPE(CPG_DYN_TYPE),    INTENT(INOUT) :: YDCPG_DYN0
TYPE(MODEL),           INTENT(INOUT) :: YDMODEL
LOGICAL,               INTENT(IN)    :: LDGPXX
LOGICAL,               INTENT(IN)    :: LDGWADV
LOGICAL,               INTENT(IN)    :: LDDER
LOGICAL,               INTENT(IN)    :: LDGDWI
LOGICAL,               INTENT(IN)    :: LDRDBBC
LOGICAL,               INTENT(IN)    :: LDVERTFE
LOGICAL,               INTENT(IN)    :: LDVFE_GW
REAL (KIND=JPRB),      INTENT(IN)    :: P_GPHL_T0 (YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB),      INTENT(IN)    :: P_GPHM_T0 (YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB),      INTENT(IN)    :: P_ONE_T0 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
TYPE(CPG_DYN_TYPE),    INTENT(INOUT) :: YDCPG_DYN9
LOGICAL,               INTENT(IN)    :: LDLDIAB
LOGICAL,               INTENT(IN)    :: LDMPA

#include "gnhpre.intfb.h"
#include "gnhqe_preh.intfb.h"
#include "gnhqe_xxd.intfb.h"
#include "gpgeo.intfb.h"
#include "gpgw.intfb.h"
#include "gphluv_expl.intfb.h"
#include "gphpre_expl.intfb.h"
#include "gprcp_ydvars.intfb.h"
#include "gpuvs.intfb.h"
#include "gpxx.intfb.h"

REAL (KIND=JPRB) :: Z_DVER_T9 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_GDW_T9 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_GWHT_T9 (YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_NHXD_T_T9 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_NHXS_T_T9 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_R0T_T9 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_R9T_T9 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_US_T9 (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB) :: Z_UVH_UH_T9 (YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_UVH_VH_T9 (YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_UVH_WWI_T9 (YDGEOMETRY%YRDIM%NPROMA,0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB) :: Z_VS_T9 (YDGEOMETRY%YRDIM%NPROMA)

INTEGER (KIND=JPIM) :: JLEV
INTEGER (KIND=JPIM) :: JROF


REAL(KIND=JPRB) :: ZHOOK_HANDLE

IF (LHOOK) CALL DR_HOOK('CPG_GP_NHQE_T9', 0, ZHOOK_HANDLE)

!*     3.2.1 COMPUTE PRE9, PXYB9, PRE9F.

CALL GPHPRE_EXPL(LAPRXPK, LVERTFE, NDLNPR, RHYDR0, TOPPRES, YDMODEL%YRCST, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY%YRVAB, YDCPG_DYN9%PRE, PRESF=YDCPG_DYN9%PREF,   &
& PDELP=YDCPG_DYN9%XYB%DELP, PLNPR=YDCPG_DYN9%XYB%LNPR, PRDELP=YDCPG_DYN9%XYB%RDELP, PALPH=YDCPG_DYN9%XYB%ALPH, &
& PRTGR=YDCPG_DYN9%XYB%RTGR, PRPRE=YDCPG_DYN9%XYB%RPRE, PRPP=YDCPG_DYN9%XYB%RPP)

!*     3.2.3 COMPUTE "R", "Cp" AND "Kap=R/Cp".

CALL GPRCP_YDVARS (YDMODEL%YRCST, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, YDVARS=YDVARS, KGFLTYP=9, &
                 & PCP=YDCPG_DYN9%RCP%CP, PR=YDCPG_DYN9%RCP%R, PKAP=YDCPG_DYN9%RCP%KAP)

!*     3.2.4 COMPUTE "RT".

! ZR9T9 is R(t-dt)*Tt(t-dt); ZR0T9 is R(t)*Tt(t-dt) (for GPXX)
Z_R9T_T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS%T%T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)*YDCPG_DYN9%RCP%R(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
Z_R0T_T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS%T%T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)*YDCPG_DYN0%RCP%R(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)

!*     3.2.6 COMPUTE QUANTITIES FOR NHQE MODEL.

CALL GNHPRE(NPDVAR, YDGEOMETRY, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDVARS%SPD%T9, YDCPG_DYN9%PREF, &
& PKAP=YDCPG_DYN9%RCP%KAP, PNHPREF=YDCPG_DYN9%NHPREF)
CALL GNHQE_PREH(LVERTFE, NPDVAR, YDGEOMETRY, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_DYN9%PRE, YDVARS%SPD%T9, YDCPG_DYN9%NHPREH&
&     )

!*     3.2.8 COMPUTES THE GEOPOTENTIAL HEIGHT "gz" AND ITS GRADIENT.

! * "gz" at full levels and half levels.
IF((LDLDIAB.OR.YDMODEL%YRML_PHY_MF%YRSIMPHL%LSIMPH)) THEN
  YDCPG_DYN9%PHI(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS%GEOMETRY%OROG%T0(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)
  CALL GPGEO(YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, YDCPG_DYN9%PHI, YDCPG_DYN9%PHIF, &
  & Z_R9T_T9, P_ONE_T0, YDCPG_DYN9%XYB%LNPR, YDCPG_DYN9%XYB%ALPH, YDGEOMETRY%YRVERT_GEOM)
ENDIF

!*     3.2.10 COMPUTES HALF-LEVEL WINDS.

! Not needed if X-term and Z_term calculated FE.
IF (LDGPXX .AND. .NOT.LDVERTFE) THEN
  ! * same remark as for time t half-level winds.
  Z_UVH_WWI_T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDCPG_DYN0%UVH%WWI(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
  CALL GPHLUV_EXPL (YDGEOMETRY%YRDIMV, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDVARS%U%T9, YDVARS%V%T9, &
  & PWWI=Z_UVH_WWI_T9, PUH=Z_UVH_UH_T9, PVH=Z_UVH_VH_T9)
ENDIF

LDDER=.FALSE.
CALL GPUVS(YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, LDDER, YDVARS%U%T9, YDVARS%V%T9, &
& Z_US_T9, Z_VS_T9)

!*     3.2.13 COMPUTES TERM "NHX".

IF (LDGPXX) THEN
  ! * compute NHX_s = "wind shear" part of NHX
  CALL GPXX(LVERTFE, YDGEOMETRY, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, P_GPHL_T0, P_GPHM_T0, YDCPG_DYN0%PHIFL, &
  & YDCPG_DYN0%PHIFM, YDCPG_DYN9%XYB%LNPR, Z_R0T_T9, YDVARS%U%T9, YDVARS%V%T9, Z_UVH_UH_T9,                         &
  & Z_UVH_VH_T9, Z_NHXS_T_T9)
  ! * compute NHX_d = "divergence" part of NHX
  CALL GNHQE_XXD(LRUBC, LVERTFE, YDGEOMETRY, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDVARS%U%T9, YDVARS%V%T9, &
  & YDCPG_DYN9%XYB%LNPR, YDCPG_DYN9%XYB%RDELP, YDCPG_DYN9%XYB%ALPH, YDCPG_DYN9%XYB%RTGR, YDCPG_DYN9%PREL,  &
  & YDCPG_DYN9%PREM, YDCPG_DYN9%RCP%KAP, Z_NHXD_T_T9)
  ! * compute NHX
  DO JLEV=1,YDGEOMETRY%YRDIMV%NFLEVG
    DO JROF=YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
      YDCPG_DYN9%NHX(JROF,JLEV)=Z_NHXS_T_T9(JROF,JLEV)+Z_NHXD_T_T9(JROF,JLEV)
    ENDDO
  ENDDO
ELSE
  ! ??? we do not need separate contributions ZNHXS_T9 and ZNHXD_T9 in this case.
  YDCPG_DYN9%NHX(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS%NHX%T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
ENDIF

!*     3.2.14 COMPUTES dver.

DO JLEV=1,YDGEOMETRY%YRDIMV%NFLEVG
  DO JROF=YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
    Z_DVER_T9(JROF,JLEV)=YDVARS%SVD%T9(JROF,JLEV)-YDCPG_DYN9%NHX(JROF,JLEV)
  ENDDO
ENDDO

!*     3.2.16 COMPUTES term [gw].

LDGDWI=.FALSE.
IF (LDGWADV.AND.LDVFE_GW) THEN
  ! PGDW is required (at least for SL3TL)
  CALL GPGW(YDGEOMETRY, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, LDMPA, LDGDWI, YDCPG_DYN0%OROGL, &
  & YDCPG_DYN0%OROGM, YDCPG_DYN9%XYB%LNPR, YDCPG_DYN9%XYB%ALPH, Z_US_T9, Z_VS_T9, Z_R9T_T9,                  &
  & Z_DVER_T9, Z_GWHT_T9, YDCPG_DYN9%GWFT, PGDW=Z_GDW_T9)

  YDCPG_DYN9%GWT(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=YDCPG_DYN9%GWFT(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)
ELSE
  CALL GPGW(YDGEOMETRY, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, LDMPA, LDGDWI, YDCPG_DYN0%OROGL, &
  & YDCPG_DYN0%OROGM, YDCPG_DYN9%XYB%LNPR, YDCPG_DYN9%XYB%ALPH, Z_US_T9, Z_VS_T9, Z_R9T_T9,                  &
  & Z_DVER_T9, Z_GWHT_T9, YDCPG_DYN9%GWFT)

  IF (LDGWADV) YDCPG_DYN9%GWT(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:YDGEOMETRY%YRDIMV%NFLEVG)=Z_GWHT_T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,0:YDGEOMETRY%YRDIMV%NFLEVG-1)
ENDIF

IF (LDRDBBC) THEN
  ! PGWS contains (gw)_surf
  YDCPG_DYN0%GWS(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=Z_GWHT_T9(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,YDGEOMETRY%YRDIMV%NFLEVG)
ENDIF

IF (LHOOK) CALL DR_HOOK('CPG_GP_NHQE_T9', 1, ZHOOK_HANDLE)

END SUBROUTINE
