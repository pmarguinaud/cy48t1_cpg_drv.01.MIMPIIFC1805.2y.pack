SUBROUTINE CPTEND_NEW (YDCST, YDMODEL,KPROMA, KSTART, KPROF, KFLEV,PGNORDL,PGNORDM,&
 !  Variables 2D Input
 & PDIFCQ , PDIFCQI, PDIFCQL, PDIFCS ,PDIFEXT,&
 & PDIFTQ , PDIFTQI, PDIFTQL, PDIFTS ,&
 & PFCCQL , PFCCQN , PFCSQL , PFCSQN ,&
 & PFPLSL , PFPLSN , PFPLSG , PFPLCL ,  PFPLCN , PFPLCG,&
 & PFESL  , PFESN  , PFESG  , PFECL  ,  PFECN  , PFECG,&
 & PFASL  , PFASN  , PFASG  , PFACL  ,  PFACN  ,&
 & PFCQLNG, PFCQING, PFCQRNG, PFCQSNG,  PFCQGNG,&
 & PFCQNG , PFRMH  , PFRMQ  , PFRSO  , PFRTH  ,&
 & PSTRCU , PSTRCV , PSTRDU , PSTRDV ,&
 & PSTRTU , PSTRTV , PSTRMU , PSTRMV ,&
 & PDIFCQLC,PDIFCQIC,PFIMCC, &
 & PFEDQLC, PFEDQIC, PFEDQRC, PFEDQSC, PFCNEGQLC,PFCNEGQIC,PFCNEGQRC,PFCNEGQSC, &
 & PFTKE  , PFTKEI,  PFEFB1,  PFEFB2,  PFEFB3, &
 & PDELP  , PRDELP , PAPHIF , PCP    ,&
 & PU     , PV     , PT     ,&
 & PQ     , PQI    , PQL    ,&
 & PQLCONV, PQICONV, PQRCONV, PQSCONV,&
 & PQR    , PQS    , PQG    ,&
 !  Variables 1D Input
 & PCPS   , PTS    ,&
 !  Variables 2D Output
 & PFHSCL , PFHSCN , PFHSSL , PFHSSN , PFHSSG ,&
 & PFHPCL , PFHPCN , PFHPCG ,PFHPSL , PFHPSN , PFHPSG ,&
 & PFHP   , PFP    , PFEPFP , PFCMPCQ, PFCMPSN, PFCMPSL,&
 & PTENDU , PTENDV , PTENDU_ZDEC, PTENDV_ZDEC, PTENDH ,&
 & PTENDQ , PTENDQI, PTENDQL, &
 & PTENDQLCONV, PTENDQICONV, &
 & PTENDQRCONV, PTENDQSCONV, &
 & PTENDQR, PTENDQS, PTENDQG, &
 & PTENDTKE, PTENDEFB1, PTENDEFB2, PTENDEFB3, PTENDEXT, YDDDH )
!     ------------------------------------------------------------------
!     ACTION DES PROCESSUS PHYSIQUES SUR LA QUANTITE DE MOUVEMENT ,
!     LES VARIABLES THERMODYNAMIQUES ET SUR L'EQUATION DE CONTINUITE
!     INTERFACE AVEC LES PARAMETRISATIONS PHYSIQUES  (IALPP)
!     ------------------------------------------------------------------

!     BUT
!     ---
!**** *CPTEND* CACUL DES TENDANCES PHYSIQUES SUR U, V, H, Q, QI, QL, TKE
!      SPECIFIQUE ET SUR LA TEMPERATURE.

!      VOIR DOCUMENTATION, INTERFACE PHYSICO-DYNAMIQUE.
!                            -----------------

!      POUR COMPRENDRE LA LOGIQUE DE CETTE ROUTINE, BIEN REALISER
!      QUE LA VARIABLE THERMODYNAMIQUE DE LA PHYSIQUE EST L ENTHALPIE
!                                                         -----------
!      (PLUS EXACTEMENT L ENERGIE STATIQUE HUMIDE)

!      LE TRANSPORT EVENTUEL PAR LES PLUIES EST PRIS EN COMPTE DE
!      MANIERE MIXTE :
!      - UNE PARTIE DE CE TRANSPORT EST CONTENUE DE MANIERE IMPLICITE
!        DANS LA FORMULATION EN FLUX D ENTHALPIE
!      - IL RESTE POURTANT UN TERME DE TRANSPORT D ENERGIE POTENTIELLE
!        QUI EST TRAITE ICI COMME UNE ADVECTION VERTICALE

!     ARGUMENTS D ENTREE
!     ------------------
!       KPROMA : DIMENSION HORIZONTALE
!       KSTART : DEBUT DE LA BOUCLE HORIZONTALE
!       KPROF  : BORNE HORIZONTALE DES CALCULS
!       KFLEV  : DIMENSION ET BORNE VERTICALE
!       PGNORDL,PGNORDM : compass.

! --- INPUT 2D (0:KLEV).
!     -----------------.
! PDIFCQ     : FLUX CONVECTIF D'HUMIDITE SPECIFIQUE (HORS COND. ET RR).
! PDIFCQI    : FLUX CONVECTIF D'EAU SOLIDE (HORS COND. ET RR).
! PDIFCQL    : FLUX CONVECTIF D'EAU LIQUIDE (HORS COND. ET RR).
! PDIFCS     : FLUX CONVECTIF D'ENTHALPIE .
! PDIFEXT    : FLUX DES EXTRA-GFL .
! PDIFTQ     : FLUX TURBULENT (ET Q NEGATIF) D'HUMIDITE SPECIFIQUE.
! PDIFTQI    : FLUX TURBULENT (ET Q NEGATIF) D'EAU GLACE.
! PDIFTQL    : FLUX TURBULENT (ET Q NEGATIF) D'EAU LIQUIDE.
! PDIFTS     : FLUX TURBULENT D'ENTHALPIE (OU D'ENERGIE STATIQUE SECHE).
! PFCCQL     : FLUX DE CONDENSATION LIE AUX RR CONVECTIVES LIQUIDES.
! PFCCQN     : FLUX DE CONDENSATION LIE AUX RR CONVECTIVES NEIGEUSES.
! PFCSQL     : FLUX DE CONDENSATION LIE AUX RR STRATIFORMES LIQUIDES.
! PFCSQN     : FLUX DE CONDENSATION LIE AUX RR STRATIFORMES NEIGEUSES.
! PFPLCL     : PRECIPITATIONS CONVECTIVES SOUS FORME LIQUIDE.
! PFPLCN     : PRECIPITATIONS CONVECTIVES SOUS FORME NEIGE.
! PFPLCG     : PRECIPITATIONS CONVECTIVES SOUS FORME GRAUPEL.
! PFPLSL     : PRECIPITATIONS STRATIFORMES SOUS FORME LIQUIDE.
! PFPLSN     : PRECIPITATIONS STRATIFORMES SOUS FORME NEIGE.
! PFPLSG     : PRECIPITATIONS STRATIFORMES SOUS FORME GRAUPEL.
! PFRMH      : FLUX MESOSPHERIQUE D'ENTHALPIE.
! PFRMQ      : FLUX MESOSPHERIQUE D'EAU.
! PFRSO      : FLUX DE RAYONNEMENT SOLAIRE.
! PFRTH      : FLUX DE RAYONNEMENT THERMIQUE.
! PSTRCU     : FLUX CONVECTIF DE QUANTITE DE MOUVEMENT "U".
! PSTRCV     : FLUX CONVECTIF DE QUANTITE DE MOUVEMENT "V".
! PSTRDU     : FLUX "GRAVITY WAVE DRAG" "U".
! PSTRDV     : FLUX "GRAVITY WAVE DRAG" "V".
! PSTRTU     : FLUX TURBULENT DE QUANTITE DE MOUVEMENT "U".
! PSTRTV     : FLUX TURBULENT DE QUANTITE DE MOUVEMENT "V".
! PSTRMU     : FLUX MESOSPHERIQUE DE QUANTITE DE MOUVEMENT "U".
! PSTRMV     : FLUX MESOSPHERIQUE DE QUANTITE DE MOUVEMENT "V".
! PDIFCQLC   : CONVECTIVE TRANSPORT FLUX OF QLC (LIQUID CONVECTIVE).
! PDIFCQIC   : CONVECTIVE TRANSPORT FLUX OF QIC (ICE CONVECTIVE).
! PFIMCC     : Q FLUX DUE TO ICING-MELTING FOLLOWING CONVECTIVE TRANSPORT OF CONVECTIVE LIQUID AND ICE WATER.
! PFEDQLC    : ENTRAINMENT-DETRAINMENT OF QLC AND QLR (LIQUID CONVECTIVE AND RESOLVED).
! PFEDQIC    : ENTRAINMENT-DETRAINMENT OF QIC AND QIR (ICE    CONVECTIVE AND RESOLVED).
! PFEDQRC    : ENTRAINMENT-DETRAINMENT OF QRC AND QRR (RAIN   CONVECTIVE AND RESOLVED).
! PFEDQSC    : ENTRAINMENT-DETRAINMENT OF QSC AND QSR (SNOW   CONVECTIVE AND RESOLVED).
! PFCNEGQLC  : CORRECT NEGATIVE VALUES OF QLC (LIQUID CONVECTIVE).
! PFCNEGQIC  : CORRECT NEGATIVE VALUES OF QIC (ICE    CONVECTIVE).
! PFCNEGQRC  : CORRECT NEGATIVE VALUES OF QRC (RAIN   CONVECTIVE).
! PFCNEGQSC  : CORRECT NEGATIVE VALUES OF QSC (SNOW   CONVECTIVE).
! PFTKE      : FLUX DE "TKE".

! --- INPUT 2D (1:KLEV).
!     -----------------.
! PRDELP     : INVERSE DE L'EPAISSEUR EN PRESSION DE LA COUCHE.
! PAPHIF     : GEOPOTENTIEL AUX NIVEAUX DES COUCHES.
! PCP        : CHALEUR MASSIQUE A PRESSION CONSTANTE DE L'AIR.
! PU         : COMPOSANTE EN X DU VENT.
! PV         : COMPOSANTE EN Y DU VENT.
! PT         : TEMPERATURE.
! PQ         : HUMIDITE SPECIFIQUE DE LA VAPEUR D'EAU.
! PQI        : GLACE.
! PQL        : EAU LIQUIDE.
! PQR        : RAIN
! PQS        : SNOW
! PQG        : GRAUPEL
! PQLCONV    : LIQUID WATER (CONVECTIVE).
! PQICONV    : ICE    WATER (CONVECTIVE).
! PQRCONV    : RAIN   WATER (CONVECTIVE).
! PQSCONV    : SNOW   WATER (CONVECTIVE).

! - 1D.
!   --.
! PCPS       : CHALEUR SPECIFIQUE EN SURFACE.
! PTS        : TEMPERATURE DE SURFACE.

! --- ARGUMENTS IMPLICITES.
!     --------------------.
! CONSTANTES UNIVERSELLES = COMMON /YOMCST/: RG,RCPD
! INDICATEURS LOGIQUES    = COMMON /YOMPHY/: NDPSFI,LCONDWT

! --- SORTIES 2D (0:KFLEV).
!     --------------------.
! PFHSCL : FLUX DE CHALEUR SENSIBLE LIE AUX RR CONVECTIVES LIQUIDES.
! PFHSCN : FLUX DE CHALEUR SENSIBLE LIE AUX RR CONVECTIVES NEIGEUSES.
! PFHSSL : FLUX DE CHALEUR SENSIBLE LIE AUX RR STRATIFORMES LIQUIDES.
! PFHSSN : FLUX DE CHALEUR SENSIBLE LIE AUX RR STRATIFORMES NEIGEUSES.
! PFHSSG : FLUX DE CHALEUR SENSIBLE LIE AUX RR STRATIFORMES GRAUPEL.
! PFHPCL : FLUX D'ENTHALPIE LIE A LA CONDENSATION CONVECTIVE LIQUIDE.
! PFHPCN : FLUX D'ENTHALPIE LIE A LA CONDENSATION CONVECTIVE NEIGEUSE.
! PFHPCG : FLUX D'ENTHALPIE LIE A LA CONDENSATION CONVECTIVE GRAUPEL.
! PFHPSL : FLUX D'ENTHALPIE LIE A LA CONDENSATION STRATIFORME LIQUIDE.
! PFHPSN : FLUX D'ENTHALPIE LIE A LA CONDENSATION STRATIFORME NEIGEUSE.
! PFHPSG : FLUX D'ENTHALPIE LIE A LA CONDENSATION STRATIFORME GRAUPEL.
! PFHP   : FLUX TOTAL D'ENTHALPIE + FLUX DE CHALEUR SENSIBLE.
! PFP    : FLUX TOTAL DE PRECIPITATIONS.
! PFEPFP : PSEUDO FLUX D'ENTHALPIE LIE A L'ENERGIE PRECIPITATIONS.

! --- SORTIES 2D (1:KFLEV).
!     --------------------.
! PTENDU     : TENDANCE DU VENT SUR U.
! PTENDV     : TENDANCE DU VENT SUR V.
! PTENDU_ZDEC : TENDANCE DU VENT SUR U. USED IN CPUTQY TO COMPUTE T TENDENCIES (WITHOUT DEEP CONVECTION CONTRIBUTION)
! OF LCVTDK TO AVOID DOUBLE COUNTING)
! PTENDV_ZDEC : TENDANCE DU VENT SUR V. USED IN CPUTQY TO COMPUTE T TENDENCIES (WITHOUT DEEP CONVECTION CONTRIBUTION) 
! OF LCVTDK TO AVOID DOUBLE COUNTING)
! PTENDH     : TENDANCE DE L'ENTHALPIE.
! PTENDQ     : TENDANCE DE L'HUMIDITE.
! PTENDQI    : TENDANCE DE L'EAU GLACE.
! PTENDQL    : TENDANCE DE L'EAU LIQUIDE.
! PTENDQR    : TENDANCE DU CONTENU EN EAU PRECIPITANT LIQUIDE.
! PTENDQS    : TENDANCE DU CONTENU EN EAU PRECIPITANT SOLIDE.
! PTENDQG    : TENDANCE DU CONTENU EN EAU PRECIPITANT GRAUPEL.
! PTENDQLCONV: TENDANCE DE L'EAU LIQUIDE (CONVECTIVE).
! PTENDQICONV: TENDANCE DE L'EAU GLACE   (CONVECTIVE).
! PTENDQRCONV: TENDANCE DE L'EAU PLUIE   (CONVECTIVE).
! PTENDQSCONV: TENDANCE DE L'EAU NEIGE   (CONVECTIVE).
! PTENDTKE   : TENDANCE DE TKE.
! PTENDEXT   : GFL EXTRA tendency.
! --- AUTEUR.
!     ------.
!     02/01/92 E.BAZILE.
!        Reunification de Cpaty,Cpdthp,Cpdup par E.Bazile.

! --- MODIFICATIONS.
!     --------------
!      Modified 04-01-16 by P. Marquet (Lopez and Gueremy schemes,
!                        they both add PFPEVPP to PTENDQ, with
!                        PFPFP and PFADVP only for Lopez)
!                        The signs of the fluxes PFPEVPP, PFPFP and
!                        PFADVP have changed in ADVPRC.
!      Modified 07-02-01 by M.Janousek (Catry's modifications for
!                        NDPSFI=1; tendency of pTKE)
!      Modified 07-05-07 by F.Bouyssel (tendency of TKE + Cleaning)
!      Modified 07-06-13 by T.Kovacic, PFCMPCQ, PFCMPSN, PFCMPSL added for DDH
!        Modified 11-02-01 by M. Mokhtari add the key LMDUST and traitement of passifs scalars
!        Modified 11-03-31 by M. Deque : Relax. of Meso. Specific Humidity added (fix)
!        Modified 11-12-01 by J. Van den Bergh: introduction of graupel
!        2011-09-07 J.M. Piriou: PCMT convection scheme.
!        2013-11, D. Degrauwe: Bugfix (use halflevel cp in case of NDPSFI=1).
!        2014-02-20 J.M. Piriou: fix 2 bugs in ZFHIMCC computation.
!        2014-04-30 J.M. Piriou: change sign in ZFHIMCC computation.
!        2016-10-04 P. Marguinaud : Port to single precision
!        2019-12-12 Y. Bouteloup : Introduction of PTENDU_ZDEC and PTENDV_ZDEC (for Tiedtke scheme)
!-----------------------------------------------------------------------

USE TYPE_MODEL , ONLY : MODEL
USE PARKIND1 , ONLY : JPIM, JPRB, JPRD
USE YOMHOOK  , ONLY : LHOOK, DR_HOOK

USE DDH_MIX  , ONLY : ADD_FIELD_3D, NEW_ADD_FIELD_3D, TYP_DDH
USE YOMLSFORC, ONLY : LMUSCLFA,NMUSCLFA
USE YOMCST,    ONLY : TCST

!-----------------------------------------------------------------------

IMPLICIT NONE

TYPE(TCST)        ,INTENT(IN)    :: YDCST
TYPE(MODEL)       ,INTENT(IN)    :: YDMODEL
INTEGER(KIND=JPIM),INTENT(IN)    :: KPROMA
INTEGER(KIND=JPIM),INTENT(IN)    :: KFLEV
INTEGER(KIND=JPIM),INTENT(IN)    :: KSTART
INTEGER(KIND=JPIM),INTENT(IN)    :: KPROF
REAL(KIND=JPRB)   ,INTENT(IN)    :: PGNORDL(KPROMA)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PGNORDM(KPROMA)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PDIFCQ  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PDIFCQI (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PDIFCQL (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PDIFCS  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PDIFEXT (KPROMA,0:KFLEV,1:YDMODEL%YRML_GCONF%YGFL%NGFL_EXT)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PDIFTQ  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PDIFTQI (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PDIFTQL (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PDIFTS  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFCCQL  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFCCQN  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFCSQL  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFCSQN  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFPLCL  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFPLCN  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFPLCG  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFPLSL  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFPLSN  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFPLSG  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFRMH   (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFRMQ   (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFRSO   (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFRTH   (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PSTRCU  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PSTRCV  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PSTRDU  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PSTRDV  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PSTRTU  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PSTRTV  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PSTRMU  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PSTRMV  (KPROMA,0:KFLEV)

REAL(KIND=JPRB)   ,INTENT(IN) :: PDIFCQLC(KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN) :: PDIFCQIC(KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN) :: PFIMCC (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN) :: PFEDQLC(KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN) :: PFEDQIC(KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN) :: PFEDQRC(KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN) :: PFEDQSC(KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN) :: PFCNEGQLC(KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN) :: PFCNEGQIC(KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN) :: PFCNEGQRC(KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN) :: PFCNEGQSC(KPROMA,0:KFLEV)

REAL(KIND=JPRB)   ,INTENT(IN)    :: PFTKE   (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFTKEI  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFEFB1  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFEFB2  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFEFB3  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PDELP   (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PRDELP  (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PAPHIF  (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFASL   (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFASN   (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFASG   (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFACL   (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFACN   (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFESL   (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFESN   (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFESG   (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFECL   (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFECN   (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFECG   (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFCQNG  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFCQLNG (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFCQING (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFCQRNG (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFCQSNG (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFCQGNG (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PCP     (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PU      (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PV      (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PT      (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PQ      (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PQI     (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PQL     (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PQR     (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PQS     (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PQG     (KPROMA,KFLEV)

REAL(KIND=JPRB)   ,INTENT(IN)    :: PQLCONV (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PQICONV (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PQRCONV (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PQSCONV (KPROMA,KFLEV)

REAL(KIND=JPRB)   ,INTENT(IN)    :: PCPS    (KPROMA)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PTS     (KPROMA)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFHSCL  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFHSCN  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFHSSL  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFHSSN  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFHSSG  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFHPCL  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFHPCN  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFHPCG  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFHPSL  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFHPSN  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFHPSG  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFHP    (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFP     (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFEPFP  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDU  (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDV  (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDU_ZDEC  (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDV_ZDEC  (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDH  (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQ  (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQI (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQL (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQR (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQS (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQG (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQLCONV (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQICONV (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQRCONV (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQSCONV (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDTKE(KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDEFB1(KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDEFB2(KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDEFB3(KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDEXT(KPROMA,KFLEV,YDMODEL%YRML_GCONF%YGFL%NGFL_EXT)
TYPE(TYP_DDH)     ,INTENT(INOUT) :: YDDDH
!-----------------------------------------------------------------------

REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFCMPCQ(KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFCMPSN(KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFCMPSL(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZGSDP (KPROMA,KFLEV)
REAL(KIND=JPRB) :: ZJTOT (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFHSENS(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFHDPSFI(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZTI   (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZQH   (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZQLH  (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZQIH  (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZQRH  (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZQSH  (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZQGH  (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZCHAT (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZLIFT (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFPL  (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFPN  (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFPG  (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFPLSL(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFPLSN(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFPLSG(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFPLCL(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFPLCN(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFPLCG(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFHIMCC(KPROMA,0:KFLEV)

REAL(KIND=JPRB) :: ZTMPVAR(KPROMA,KFLEV)
REAL(KIND=JPRB) :: ZTMPFLUX(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZSTTUG(KPROMA,0:KFLEV), ZSTTVG(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZSTCUG(KPROMA,0:KFLEV), ZSTCVG(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZSTDUG(KPROMA,0:KFLEV), ZSTDVG(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZTNDKKC(KPROMA,KFLEV), ZTNDKKD(KPROMA,KFLEV)
REAL(KIND=JPRB) :: ZTNDKKT(KPROMA,KFLEV), ZKENE(KPROMA,KFLEV)
REAL(KIND=JPRB) :: ZUZGEO(KPROMA,KFLEV), ZVMGEO(KPROMA,KFLEV)
REAL(KIND=JPRB) :: ZQ1(KPROMA,KFLEV), ZQ2(KPROMA,KFLEV)
REAL(KIND=JPRB) :: ZCPH

INTEGER(KIND=JPIM) :: JLEV, JROF, JGFL

LOGICAL :: LLDPSFI

REAL(KIND=JPRB) :: ZHOOK_HANDLE

#include "wrscmr.intfb.h"
#include "fcttrm.ycst.h"

!-----------------------------------------------------------------------
IF (LHOOK) CALL DR_HOOK('CPTEND_NEW',0,ZHOOK_HANDLE)

ASSOCIATE(YDPHY=>YDMODEL%YRML_PHY_MF%YRPHY,YGFL=>YDMODEL%YRML_GCONF%YGFL,YDLDDH=>YDMODEL%YRML_DIAG%YRLDDH, &
 & YDARPHY=>YDMODEL%YRML_PHY_MF%YRARPHY)
ASSOCIATE(LMDUST=>YDARPHY%LMDUST, &
 & NGFL_EXT=>YGFL%NGFL_EXT, &
 & LCONDWT=>YDPHY%LCONDWT, LPHSPSH=>YDPHY%LPHSPSH, LEFB=>YDPHY%LEFB, &
 & LGPCMT=>YDPHY%LGPCMT, LECT=>YDPHY%LECT, LCVTDK=>YDPHY%LCVTDK, NDPSFI=>YDPHY%NDPSFI, &
 & LGRAPRO=>YDPHY%LGRAPRO, LFLEXDIA=>YDLDDH%LFLEXDIA,LDDH_OMP=>YDLDDH%LDDH_OMP)
!-----------------------------------------------------------------------

! ------------------------------------------------------------------
! intermediate CPTEND version made for acpluie_prog and Luc's scheme
! ------------------------------------------------------------------

! the following assumptions are made:

! * Lopez scheme uses both QR and QS as prognostic variable
! * the diffusive fluxes (for qv, qi, ql and s) have a turbulent
!   and convective component
! * the pseudo-fluxes between the species (','',''') all have a
!   stratiform component, only condensation has a convective
!   component
! * CPFHPFS is integrated in this routine and should not be called
! ------------------------------------------------------------------

!    -------------------------------------------------------------------

LLDPSFI=(NDPSFI==1)
ZLIFT=0.0_JPRB
ZCHAT=0.0_JPRB

IF(LGPCMT) THEN
  ! Heat flux due to convective icing/melting of cloud condensates.
  DO JROF = KSTART, KPROF
    ZFHIMCC(JROF,0)=0._JPRB
  ENDDO
  DO JLEV= 1, KFLEV
    DO JROF = KSTART, KPROF
      ZFHIMCC(JROF,JLEV)=ZFHIMCC(JROF,JLEV-1)+(PFIMCC(JROF,JLEV)-PFIMCC(JROF,JLEV-1))&
        & *(YDCST%RLVZER-YDCST%RLSZER)
    ENDDO
  ENDDO
ELSE
  ZFHIMCC(:,:)=0._JPRB
ENDIF

!  ------------------------------------------------------------
!   1. CALCUL DE L'EVOLUTION DE Q ET CALCUL PARTIEL DE dU/dT ET
!  ET DE dH/dt ( avec H = CpT + Phi + Ec )
!  ------------------------------------------------------------

! Calculation of temperatures on half levels

IF (LPHSPSH) THEN
  DO JROF = KSTART, KPROF
    ZTI(JROF,0)=PT(JROF,1)
    ZTI(JROF,KFLEV)=PT(JROF,KFLEV)
  ENDDO
ELSE
  DO JROF = KSTART, KPROF
    ZTI(JROF,0)=PT(JROF,1)
    ZTI(JROF,KFLEV)=PTS(JROF)
  ENDDO
ENDIF

DO JLEV= 1, KFLEV-1
  DO JROF = KSTART, KPROF
    ZTI(JROF,JLEV)=(PT(JROF,JLEV)+PT(JROF,JLEV+1))*0.5_JPRB
  ENDDO
ENDDO

! preparation for case delta_m=1

IF (LLDPSFI) THEN
  DO JROF = KSTART, KPROF
    ZQH  (JROF,0) = 0.0_JPRB
    ZQLH (JROF,0) = 0.0_JPRB
    ZQIH (JROF,0) = 0.0_JPRB
    ZQRH (JROF,0) = 0.0_JPRB
    ZQSH (JROF,0) = 0.0_JPRB
    ZQH  (JROF,KFLEV) = PQ (JROF,KFLEV)
    ZQLH (JROF,KFLEV) = PQL(JROF,KFLEV)
    ZQIH (JROF,KFLEV) = PQI(JROF,KFLEV)
    ZQRH (JROF,KFLEV) = PQR(JROF,KFLEV)
    ZQSH (JROF,KFLEV) = PQS(JROF,KFLEV)
  ENDDO
  DO JLEV= 1, KFLEV-1
    DO JROF = KSTART, KPROF
      ZQH (JROF,JLEV) = (PQ (JROF,JLEV)+PQ (JROF,JLEV+1))*0.5_JPRB
      ZQLH(JROF,JLEV) = (PQL(JROF,JLEV)+PQL(JROF,JLEV+1))*0.5_JPRB
      ZQIH(JROF,JLEV) = (PQI(JROF,JLEV)+PQI(JROF,JLEV+1))*0.5_JPRB
      ZQRH(JROF,JLEV) = (PQR(JROF,JLEV)+PQR(JROF,JLEV+1))*0.5_JPRB
      ZQSH(JROF,JLEV) = (PQS(JROF,JLEV)+PQS(JROF,JLEV+1))*0.5_JPRB
    ENDDO
  ENDDO
    IF (LGRAPRO) THEN
      DO JROF=KSTART, KPROF
        ZQGH (JROF,0) = 0.0_JPRB
        ZQGH (JROF,KFLEV) = PQG(JROF,KFLEV)
      ENDDO
      DO JLEV = 1, KFLEV-1
        DO JROF = KSTART, KPROF
          ZQGH(JROF,JLEV) = (PQG(JROF,JLEV)+PQG(JROF,JLEV+1))*0.5_JPRB
        ENDDO
      ENDDO
    ENDIF
ENDIF

! Transformation between absolute and relative precip fluxes

IF (LLDPSFI) THEN
  IF (LGRAPRO) THEN
    DO JLEV= 0, KFLEV
      DO JROF = KSTART, KPROF
        ZFPL(JROF,JLEV)=(1.0_JPRB-ZQRH(JROF,JLEV))*PFPLSL(JROF,JLEV)&
          & -ZQRH(JROF,JLEV)*(PFPLSN(JROF,JLEV)+PFPLSG(JROF,JLEV))
        ZFPN(JROF,JLEV)=(1.0_JPRB-ZQSH(JROF,JLEV))*PFPLSN(JROF,JLEV)&
          & -ZQSH(JROF,JLEV)*(PFPLSL(JROF,JLEV)+PFPLSG(JROF,JLEV))
        ZFPG(JROF,JLEV)=(1.0_JPRB-ZQGH(JROF,JLEV))*PFPLSG(JROF,JLEV)&
          & -ZQGH(JROF,JLEV)*(PFPLSL(JROF,JLEV)+PFPLSN(JROF,JLEV))
        ZFPLSL(JROF,JLEV)=ZFPL(JROF,JLEV)
        ZFPLSN(JROF,JLEV)=ZFPN(JROF,JLEV)
        ZFPLSG(JROF,JLEV)=ZFPG(JROF,JLEV)
        ZFPL(JROF,JLEV)=(1.0_JPRB-ZQRH(JROF,JLEV))*PFPLCL(JROF,JLEV)&
          & -ZQRH(JROF,JLEV)*(PFPLCN(JROF,JLEV))
        ZFPN(JROF,JLEV)=(1.0_JPRB-ZQSH(JROF,JLEV))*PFPLCN(JROF,JLEV)&
          & -ZQSH(JROF,JLEV)*(PFPLCL(JROF,JLEV))
        ZFPG(JROF,JLEV)=(1.0_JPRB-ZQGH(JROF,JLEV))*PFPLCG(JROF,JLEV)&
          & -ZQGH(JROF,JLEV)*(PFPLCG(JROF,JLEV))
        ZFPLCL(JROF,JLEV)=ZFPL(JROF,JLEV)
        ZFPLCN(JROF,JLEV)=ZFPN(JROF,JLEV)
        ZFPLCG(JROF,JLEV)=ZFPG(JROF,JLEV)
        ZFPL(JROF,JLEV)=ZFPLSL(JROF,JLEV)+ZFPLCL(JROF,JLEV)
        ZFPN(JROF,JLEV)=ZFPLSN(JROF,JLEV)+ZFPLCN(JROF,JLEV)
        ZFPG(JROF,JLEV)=ZFPLSG(JROF,JLEV)+ZFPLCG(JROF,JLEV)
        ZCPH=YDCST%RCPD+ (YDCST%RCPV-YDCST%RCPD)*ZQH(JROF,JLEV)+&
         & (YDCST%RCW-YDCST%RCPD)*(ZQLH(JROF,JLEV)+ZQRH(JROF,JLEV))+ &
         & (YDCST%RCS-YDCST%RCPD)*(ZQIH(JROF,JLEV)+ZQSH(JROF,JLEV)+ZQGH(JROF,JLEV))
        ZCHAT(JROF,JLEV)=(ZCPH-YDCST%RCW*ZQRH(JROF,JLEV)-&
          & YDCST%RCS*(ZQSH(JROF,JLEV)+ZQGH(JROF,JLEV)))/&
          & (1.0_JPRB-ZQRH(JROF,JLEV)-ZQSH(JROF,JLEV)-ZQGH(JROF,JLEV))
        ZLIFT(JROF,JLEV)=(ZFPL(JROF,JLEV)+ZFPN(JROF,JLEV)+ZFPG(JROF,JLEV))/&
          & (1.0_JPRB-ZQRH(JROF,JLEV)-ZQSH(JROF,JLEV)-ZQGH(JROF,JLEV))
      ENDDO
    ENDDO
  ELSE
    DO JLEV= 0, KFLEV
      DO JROF = KSTART, KPROF
        ZFPL(JROF,JLEV)=(1.0_JPRB-ZQRH(JROF,JLEV))*PFPLSL(JROF,JLEV)&
          & -ZQRH(JROF,JLEV)*PFPLSN(JROF,JLEV)
        ZFPN(JROF,JLEV)=(1.0_JPRB-ZQSH(JROF,JLEV))*PFPLSN(JROF,JLEV)&
          & -ZQSH(JROF,JLEV)*PFPLSL(JROF,JLEV)
        ZFPLSL(JROF,JLEV)=ZFPL(JROF,JLEV)
        ZFPLSN(JROF,JLEV)=ZFPN(JROF,JLEV)
        ZFPL(JROF,JLEV)=(1.0_JPRB-ZQRH(JROF,JLEV))*PFPLCL(JROF,JLEV)&
          & -ZQRH(JROF,JLEV)*PFPLCN(JROF,JLEV)
        ZFPN(JROF,JLEV)=(1.0_JPRB-ZQSH(JROF,JLEV))*PFPLCN(JROF,JLEV)&
          & -ZQSH(JROF,JLEV)*PFPLCL(JROF,JLEV)
        ZFPLCL(JROF,JLEV)=ZFPL(JROF,JLEV)
        ZFPLCN(JROF,JLEV)=ZFPN(JROF,JLEV)
        ZFPL(JROF,JLEV)=ZFPLSL(JROF,JLEV)+ZFPLCL(JROF,JLEV)
        ZFPN(JROF,JLEV)=ZFPLSN(JROF,JLEV)+ZFPLCN(JROF,JLEV)
        ZCPH=YDCST%RCPD+ (YDCST%RCPV-YDCST%RCPD)*ZQH(JROF,JLEV)+&
         & (YDCST%RCW-YDCST%RCPD)*(ZQLH(JROF,JLEV)+ZQRH(JROF,JLEV))+ &
         & (YDCST%RCS-YDCST%RCPD)*(ZQIH(JROF,JLEV)+ZQSH(JROF,JLEV))
        ZCHAT(JROF,JLEV)=(ZCPH-YDCST%RCW*ZQRH(JROF,JLEV)-&
         & YDCST%RCS*ZQSH(JROF,JLEV))/(1.0_JPRB-ZQRH(JROF,JLEV)-ZQSH(JROF,JLEV))
        ZLIFT(JROF,JLEV)=(ZFPL(JROF,JLEV)+ZFPN(JROF,JLEV))/&
          & (1.0_JPRB-ZQRH(JROF,JLEV)-ZQSH(JROF,JLEV))
      ENDDO
    ENDDO
  ENDIF
ELSE
  DO JLEV= 0, KFLEV
    DO JROF = KSTART, KPROF
      ZFPL(JROF,JLEV)=PFPLSL(JROF,JLEV)+PFPLCL(JROF,JLEV)
      ZFPN(JROF,JLEV)=PFPLSN(JROF,JLEV)+PFPLCN(JROF,JLEV)
    ENDDO
  ENDDO
  IF (LGRAPRO) THEN
    DO JLEV=0, KFLEV
      DO JROF = KSTART, KPROF
        ZFPG(JROF,JLEV)=PFPLSG(JROF,JLEV)
      ENDDO
    ENDDO
  ENDIF
ENDIF
! Diagnostics

DO JLEV= 0, KFLEV
  DO JROF = KSTART, KPROF

    IF (LLDPSFI) THEN

      PFHSCL(JROF,JLEV)=ZFPLCL(JROF,JLEV)*ZTI(JROF,JLEV)*YDCST%RCW
      PFHSCN(JROF,JLEV)=ZFPLCN(JROF,JLEV)*ZTI(JROF,JLEV)*YDCST%RCS
      PFHSSL(JROF,JLEV)=ZFPLSL(JROF,JLEV)*ZTI(JROF,JLEV)*YDCST%RCW
      PFHSSN(JROF,JLEV)=ZFPLSN(JROF,JLEV)*ZTI(JROF,JLEV)*YDCST%RCS
      IF (LGRAPRO) THEN
        PFHSSG(JROF,JLEV)=ZFPLSG(JROF,JLEV)*ZTI(JROF,JLEV)*YDCST%RCS
      ENDIF

    ELSE

      PFHSCL(JROF,JLEV)=PFPLCL(JROF,JLEV)*ZTI(JROF,JLEV)*(YDCST%RCW-YDCST%RCPD)
      PFHSCN(JROF,JLEV)=PFPLCN(JROF,JLEV)*ZTI(JROF,JLEV)*(YDCST%RCS-YDCST%RCPD)
      PFHSSL(JROF,JLEV)=PFPLSL(JROF,JLEV)*ZTI(JROF,JLEV)*(YDCST%RCW-YDCST%RCPD)
      PFHSSN(JROF,JLEV)=PFPLSN(JROF,JLEV)*ZTI(JROF,JLEV)*(YDCST%RCS-YDCST%RCPD)
      IF (LGRAPRO) THEN
        PFHSSG(JROF,JLEV)=PFPLSG(JROF,JLEV)*ZTI(JROF,JLEV)*(YDCST%RCS-YDCST%RCPD)
      ENDIF

    ENDIF

    PFHPCL(JROF,JLEV)= - YDCST%RLVZER * (PFCCQL(JROF,JLEV)-PFECL(JROF,JLEV))
    PFHPCN(JROF,JLEV)= - YDCST%RLSZER * (PFCCQN(JROF,JLEV)-PFECN(JROF,JLEV))
    PFHPSL(JROF,JLEV)= - YDCST%RLVZER * (PFCSQL(JROF,JLEV)-PFESL(JROF,JLEV))
    PFHPSN(JROF,JLEV)= - YDCST%RLSZER * (PFCSQN(JROF,JLEV)-PFESN(JROF,JLEV))

    PFP(JROF,JLEV)= ZFPL(JROF,JLEV) +ZFPN(JROF,JLEV)

    IF (LGRAPRO) THEN
      PFHPSG(JROF,JLEV)= - YDCST%RLSZER * (-PFESG(JROF,JLEV))
      PFHPCG(JROF,JLEV)= - YDCST%RLSZER * (-PFECG(JROF,JLEV))
      PFP(JROF,JLEV)= PFP(JROF,JLEV) + ZFPG(JROF,JLEV)
    ENDIF

    PFEPFP(JROF,JLEV)=-NDPSFI*ZCHAT(JROF,JLEV)*ZTI(JROF,JLEV)*&
     & PFP(JROF,JLEV)

    PFHP(JROF,JLEV) = PFHSCL(JROF,JLEV) + PFHSCN(JROF,JLEV) +&
     & PFHSSL(JROF,JLEV) + PFHSSN(JROF,JLEV) +&
     & PFHPCL(JROF,JLEV) + PFHPCN(JROF,JLEV) +&
     & PFHPSL(JROF,JLEV) + PFHPSN(JROF,JLEV) +&
     & PFEPFP(JROF,JLEV)

    IF (LGRAPRO) THEN
      PFHP(JROF,JLEV) = PFHP(JROF,JLEV) + PFHSSG(JROF,JLEV) + PFHPSG(JROF,JLEV) + PFHPCG(JROF,JLEV)
    ENDIF
  ENDDO
ENDDO

! Computation of the total enthalpy flux J_tot (including NDPSFI==1)

DO JLEV= 0, KFLEV
  DO JROF = KSTART, KPROF
    ZJTOT(JROF,JLEV) = PFRSO(JROF,JLEV)+PFRTH(JROF,JLEV)+PFRMH(JROF,JLEV)+&
        & PDIFTS(JROF,JLEV)+PDIFCS(JROF,JLEV)+&
        & (YDCST%RCW-YDCST%RCPD)*ZFPL(JROF,JLEV)*ZTI(JROF,JLEV)+&
        & (YDCST%RCS-YDCST%RCPD)*ZFPN(JROF,JLEV)*ZTI(JROF,JLEV)-&
        & YDCST%RLVZER*(PFCCQL(JROF,JLEV)+PFCSQL(JROF,JLEV)-PFESL(JROF,JLEV)&
        & -PFECL(JROF,JLEV))-&
        & YDCST%RLSZER*(PFCCQN(JROF,JLEV)+PFCSQN(JROF,JLEV)-PFESN(JROF,JLEV)&
        & -PFECN(JROF,JLEV))&
        & +ZFHIMCC(JROF,JLEV)
  ENDDO
ENDDO

IF (LGRAPRO) THEN
 DO JLEV = 0, KFLEV
   DO JROF = KSTART, KPROF
     ZJTOT(JROF,JLEV) = ZJTOT(JROF,JLEV) + (YDCST%RCS-YDCST%RCPD)*ZFPG(JROF,JLEV)*ZTI(JROF,JLEV) +&
      & YDCST%RLSZER*(PFESG(JROF,JLEV)+PFECG(JROF,JLEV))
   ENDDO
 ENDDO
ENDIF

IF (LLDPSFI) THEN
  DO JLEV= 0, KFLEV
    DO JROF = KSTART, KPROF
      ZFHDPSFI(JROF,JLEV) = -(ZCHAT(JROF,JLEV)-YDCST%RCPD)*ZTI(JROF,JLEV)*&
          &  (ZFPL(JROF,JLEV)+ZFPN(JROF,JLEV))
      IF (LGRAPRO) THEN
        ZFHDPSFI(JROF,JLEV) = ZFHDPSFI(JROF,JLEV) - (ZCHAT(JROF,JLEV) - YDCST%RCPD)*&
         &ZTI(JROF,JLEV)*ZFPG(JROF,JLEV)
      ENDIF
      ZJTOT(JROF,JLEV) = ZJTOT(JROF,JLEV)+ZFHDPSFI(JROF,JLEV)
    ENDDO
  ENDDO
ELSE
  ZFHDPSFI(KSTART:KPROF,0:KFLEV)=0.
ENDIF


!CDIR UNROLL=8
DO JLEV = 1, KFLEV
  DO JROF = KSTART, KPROF

    ZGSDP(JROF,JLEV)=YDCST%RG*PRDELP(JROF,JLEV)

    PTENDU(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
     & (PSTRCU (JROF,JLEV-1) - PSTRCU (JROF,JLEV)) +&
     & (PSTRDU (JROF,JLEV-1) - PSTRDU (JROF,JLEV)) +&
     & (PSTRMU (JROF,JLEV-1) - PSTRMU (JROF,JLEV)) +&
     & (PSTRTU (JROF,JLEV-1) - PSTRTU (JROF,JLEV)) )

    PTENDV(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
     & (PSTRCV (JROF,JLEV-1) - PSTRCV (JROF,JLEV)) +&
     & (PSTRDV (JROF,JLEV-1) - PSTRDV (JROF,JLEV)) +&
     & (PSTRMV (JROF,JLEV-1) - PSTRMV (JROF,JLEV)) +&
     & (PSTRTV (JROF,JLEV-1) - PSTRTV (JROF,JLEV)) )

    IF (LCVTDK) THEN
  !     PTENDU_ZDEC(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
  !      & (PSTRDU (JROF,JLEV-1) - PSTRDU (JROF,JLEV)) +&
  !      & (PSTRMU (JROF,JLEV-1) - PSTRMU (JROF,JLEV)) +&
  !      & (PSTRTU (JROF,JLEV-1) - PSTRTU (JROF,JLEV)) )
     
       PTENDU_ZDEC(JROF,JLEV) = 0.0_JPRB
   !    PTENDV_ZDEC(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
   !     & (PSTRDV (JROF,JLEV-1) - PSTRDV (JROF,JLEV)) +&
   !     & (PSTRMV (JROF,JLEV-1) - PSTRMV (JROF,JLEV)) +&
   !     & (PSTRTV (JROF,JLEV-1) - PSTRTV (JROF,JLEV)) )
   
       PTENDV_ZDEC(JROF,JLEV) = 0.0_JPRB
    ELSE    
       PTENDU_ZDEC(JROF,JLEV) = PTENDU(JROF,JLEV) 
       PTENDV_ZDEC(JROF,JLEV) = PTENDV(JROF,JLEV)  
    ENDIF
       
    PTENDQ(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
     & (PDIFTQ (JROF,JLEV-1) - PDIFTQ (JROF,JLEV)) +&
     & (PDIFCQ (JROF,JLEV-1) - PDIFCQ (JROF,JLEV)) +&
     & (PFRMQ  (JROF,JLEV-1) - PFRMQ (JROF,JLEV))  +&
     & (PFCCQL (JROF,JLEV-1) - PFCCQL (JROF,JLEV)) +&
     & (PFCCQN (JROF,JLEV-1) - PFCCQN (JROF,JLEV)) +&
     & (PFCSQL (JROF,JLEV-1) - PFCSQL (JROF,JLEV)) +&
     & (PFCSQN (JROF,JLEV-1) - PFCSQN (JROF,JLEV)) +&
     & (PFCQNG (JROF,JLEV-1) - PFCQNG (JROF,JLEV)) -&
     & (PFECL  (JROF,JLEV-1) - PFECL  (JROF,JLEV)) -&
     & (PFESL  (JROF,JLEV-1) - PFESL  (JROF,JLEV)) -&
     & (PFECN  (JROF,JLEV-1) - PFECN  (JROF,JLEV)) -&
     & (PFESN  (JROF,JLEV-1) - PFESN  (JROF,JLEV)))

    PTENDH(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
     &  ZJTOT  (JROF,JLEV-1) - ZJTOT  (JROF,JLEV))

  ENDDO
ENDDO

IF (LGRAPRO) THEN
!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQ(JROF,JLEV)=PTENDQ(JROF,JLEV) + ZGSDP(JROF,JLEV)*(-&
        & (PFESG(JROF,JLEV-1) - PFESG(JROF,JLEV)) - &
        & (PFECG(JROF,JLEV-1) - PFECG(JROF,JLEV)))
    ENDDO
  ENDDO
ENDIF

IF (LFLEXDIA) THEN
   IF (LDDH_OMP) THEN
     !-------------------------------------------------
    ! QV DDH budget.
    !-------------------------------------------------
    ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
    & PDELP(KSTART:KPROF,1:KFLEV)*PQ(KSTART:KPROF,1:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQV',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFTQ,'FQVTUR',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFCQ,'FQVTURCONV',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCCQL,'FQVCCQL',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCCQN,'FQVCCQN',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCSQL,'FQVCSQL',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCSQN,'FQVCSQN',YDDDH)
    IF(LMUSCLFA) CALL WRSCMR(NMUSCLFA,'PFCQNG_CPTEND_NEW',PFCQNG,KPROF,KFLEV+1)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQNG,'FQVCQNG',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFECL(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQVECL',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFESL(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQVESL',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFECN(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQVECN',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFESN(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQVESN',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFESG(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQVESG',YDDDH)
    !-------------------------------------------------
    ! H (enthalpy) DDH budget.
    !-------------------------------------------------
    ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
    & PDELP(KSTART:KPROF,1:KFLEV)*PCP(KSTART:KPROF,1:KFLEV)*PT(KSTART:KPROF,1:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VCT',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFRSO,'FCTRSO',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFRTH,'FCTRTH',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFRMH,'FCTRMH',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFTS,'FCTDIFT',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFCS,'FCTDIFC',YDDDH)
    ZFHSENS(KSTART:KPROF,0:KFLEV)=(YDCST%RCW-YDCST%RCPD)*ZFPL(KSTART:KPROF,0:KFLEV)*ZTI(KSTART:KPROF,0:KFLEV)+&
      & (YDCST%RCS-YDCST%RCPD)*ZFPN(KSTART:KPROF,0:KFLEV)*ZTI(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZFHSENS,'FCTSENSPREC',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDCST%RLVZER*PFCCQL(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTCCQL',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDCST%RLVZER*PFCSQL(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTCSQL',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=YDCST%RLVZER*PFESL(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTESL',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=YDCST%RLVZER*PFECL(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTECL',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDCST%RLSZER*PFCCQN(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTCCQN',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDCST%RLSZER*PFCSQN(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTCSQN',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=YDCST%RLSZER*PFESN(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTESN',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=YDCST%RLSZER*PFECN(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTECN',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=YDCST%RLSZER*PFESG(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTESG',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZFHDPSFI,'FCTDPSFI',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZFHIMCC,'FCTIMCC',YDDDH)
   ELSE
    !-------------------------------------------------
    ! QV DDH budget.
    !-------------------------------------------------
    ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
    & PDELP(KSTART:KPROF,1:KFLEV)*PQ(KSTART:KPROF,1:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQV','V','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PDIFTQ,'FQVTUR','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PDIFCQ,'FQVTURCONV','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PFCCQL,'FQVCCQL','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PFCCQN,'FQVCCQN','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PFCSQL,'FQVCSQL','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PFCSQN,'FQVCSQN','F','ARP',.TRUE.,.TRUE.)
    IF(LMUSCLFA) CALL WRSCMR(NMUSCLFA,'PFCQNG_CPTEND_NEW',PFCQNG,KPROF,KFLEV+1)
    CALL ADD_FIELD_3D(YDLDDH,PFCQNG,'FQVCQNG','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFECL(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQVECL','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFESL(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQVESL','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFECN(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQVECN','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFESN(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQVESN','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFESG(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQVESG','F','ARP',.TRUE.,.TRUE.)
    !-------------------------------------------------
    ! H (enthalpy) DDH budget.
    !-------------------------------------------------
    ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
    & PDELP(KSTART:KPROF,1:KFLEV)*PCP(KSTART:KPROF,1:KFLEV)*PT(KSTART:KPROF,1:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VCT','V','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PFRSO,'FCTRSO','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PFRTH,'FCTRTH','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PFRMH,'FCTRMH','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PDIFTS,'FCTDIFT','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,PDIFCS,'FCTDIFC','F','ARP',.TRUE.,.TRUE.)
    ZFHSENS(KSTART:KPROF,0:KFLEV)=(YDCST%RCW-YDCST%RCPD)*ZFPL(KSTART:KPROF,0:KFLEV)*ZTI(KSTART:KPROF,0:KFLEV)+&
      & (YDCST%RCS-YDCST%RCPD)*ZFPN(KSTART:KPROF,0:KFLEV)*ZTI(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZFHSENS,'FCTSENSPREC','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDCST%RLVZER*PFCCQL(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTCCQL','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDCST%RLVZER*PFCSQL(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTCSQL','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=YDCST%RLVZER*PFESL(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTESL','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=YDCST%RLVZER*PFECL(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTECL','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDCST%RLSZER*PFCCQN(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTCCQN','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDCST%RLSZER*PFCSQN(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTCSQN','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=YDCST%RLSZER*PFESN(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTESN','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=YDCST%RLSZER*PFECN(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTECN','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=YDCST%RLSZER*PFESG(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTESG','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZFHDPSFI,'FCTDPSFI','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZFHIMCC,'FCTIMCC','F','ARP',.TRUE.,.TRUE.)
  ENDIF
ENDIF


!  ------------------------------------------------------------
!   2. CALCUL DE L'EVOLUTION DE QL, QI, QR, QS, QG
!  ------------------------------------------------------------

! - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
! Pronostic equations for liquid/solid water/precipitation
! - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

IF (LCONDWT.AND..NOT.LGPCMT) THEN

  ! - - - - - - - - - - - - - - - - - -
  ! Usual equation for QL=suspended liquid water
  ! - - - - - - - - - - - - - - - - - -

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQL(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & (PDIFTQL(JROF,JLEV-1) - PDIFTQL(JROF,JLEV)) +&
       & (PDIFCQL(JROF,JLEV-1) - PDIFCQL(JROF,JLEV)) +&
       & (PFCQLNG(JROF,JLEV-1) - PFCQLNG(JROF,JLEV)) +&
       & (PFACL  (JROF,JLEV-1) - PFACL  (JROF,JLEV)) +&
       & (PFASL  (JROF,JLEV-1) - PFASL  (JROF,JLEV)) -&
       & (PFCSQL (JROF,JLEV-1) - PFCSQL (JROF,JLEV)) -&
       & (PFCCQL (JROF,JLEV-1) - PFCCQL (JROF,JLEV)))
    ENDDO
  ENDDO
  IF (LFLEXDIA) THEN
    !-------------------------------------------------
    ! QL DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQL(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFTQL,'FQLDIFT',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFCQL,'FQLDIFC',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQLNG,'FQLCQLNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFACL,'FQLACL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFASL,'FQLASL',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFCSQL(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQLCSQL',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFCCQL(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQLCCQL',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQL(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQL','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFTQL,'FQLDIFT','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFCQL,'FQLDIFC','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCQLNG,'FQLCQLNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFACL,'FQLACL','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFASL,'FQLASL','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFCSQL(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQLCSQL','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFCCQL(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQLCCQL','F','ARP',.TRUE.,.TRUE.)
    ENDIF 
  ENDIF

  ! - - - - - - - - - - - - - - - - - -
  ! equation for QI=suspended ice water
  ! - - - - - - - - - - - - - - - - - -

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQI(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & (PDIFTQI(JROF,JLEV-1) - PDIFTQI(JROF,JLEV)) +&
       & (PDIFCQI(JROF,JLEV-1) - PDIFCQI(JROF,JLEV)) +&
       & (PFCQING(JROF,JLEV-1) - PFCQING(JROF,JLEV)) +&
       & (PFACN  (JROF,JLEV-1) - PFACN  (JROF,JLEV)) +&
       & (PFASN  (JROF,JLEV-1) - PFASN  (JROF,JLEV)) -&
       & (PFCSQN (JROF,JLEV-1) - PFCSQN (JROF,JLEV)) -&
       & (PFCCQN (JROF,JLEV-1) - PFCCQN (JROF,JLEV)))
    ENDDO
  ENDDO
  IF (LGRAPRO) THEN
    DO JLEV = 1, KFLEV
      DO JROF = KSTART, KPROF
        PTENDQI(JROF,JLEV) = PTENDQI(JROF,JLEV) +ZGSDP(JROF,JLEV)*&
         &(PFASG  (JROF,JLEV-1) - PFASG  (JROF,JLEV))
      ENDDO
    ENDDO
  ENDIF
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QI DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQI(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQI',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFTQI,'FQIDIFT',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFCQI,'FQIDIFC',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQING,'FQICQING',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFACN,'FQIACN',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFASN,'FQIASN',YDDDH)
      IF (LGRAPRO) THEN
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFASG,'FQIASG',YDDDH)
      ENDIF
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFCSQN(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQICSQN',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFCCQN(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQICCQN',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQI(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQI','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFTQI,'FQIDIFT','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFCQI,'FQIDIFC','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCQING,'FQICQING','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFACN,'FQIACN','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFASN,'FQIASN','F','ARP',.TRUE.,.TRUE.)
      IF (LGRAPRO) THEN
        CALL ADD_FIELD_3D(YDLDDH,PFASG,'FQIASG','F','ARP',.TRUE.,.TRUE.)
      ENDIF
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFCSQN(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQICSQN','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFCCQN(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQICCQN','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF

  ! -----------------------------------
  ! Equation for QR=rain water
  ! -----------------------------------

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQR(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & (PFESL  (JROF,JLEV-1) - PFESL  (JROF,JLEV)) +&
       & (PFECL  (JROF,JLEV-1) - PFECL  (JROF,JLEV)) +&
       & (PFCQRNG(JROF,JLEV-1) - PFCQRNG(JROF,JLEV)) +&
       & (ZFPL   (JROF,JLEV-1) - ZFPL   (JROF,JLEV)) -&
       & (PFACL  (JROF,JLEV-1) - PFACL  (JROF,JLEV)) -&
       & (PFASL  (JROF,JLEV-1) - PFASL  (JROF,JLEV)))
    ENDDO
  ENDDO
  IF (LFLEXDIA) THEN
    !-------------------------------------------------
    ! QR DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQR(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQR',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFESL,'FQRESL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFECL,'FQRECL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQRNG,'FQRCQRNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZFPL,'FQRPL',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFACL(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQRACL',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFASL(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQRASL',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQR(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQR','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFESL,'FQRESL','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFECL,'FQRECL','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCQRNG,'FQRCQRNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,ZFPL,'FQRPL','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFACL(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQRACL','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFASL(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQRASL','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF

  ! ---------------------------------
  ! Equation for QS=snow water
  ! --------------------------------

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQS(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & (PFESN  (JROF,JLEV-1) - PFESN  (JROF,JLEV)) +&
       & (PFECN  (JROF,JLEV-1) - PFECN  (JROF,JLEV)) +&
       & (PFCQSNG(JROF,JLEV-1) - PFCQSNG(JROF,JLEV)) +&
       & (ZFPN   (JROF,JLEV-1) - ZFPN   (JROF,JLEV)) -&
       & (PFACN  (JROF,JLEV-1) - PFACN  (JROF,JLEV)) -&
       & (PFASN  (JROF,JLEV-1) - PFASN  (JROF,JLEV)))
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QS DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQS(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQS',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFESN,'FQSESN',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFECN,'FQSECN',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQSNG,'FQSCQSNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZFPN,'FQSPN',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFACN(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQSACN',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFASN(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQSASN',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQS(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQS','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFESN,'FQSESN','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFECN,'FQSECN','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCQSNG,'FQSCQSNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,ZFPN,'FQSPN','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFACN(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQSACN','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFASN(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQSASN','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF

  ! ---------------------------------
  ! Equation for QG=graupel
  ! --------------------------------
  IF (LGRAPRO) THEN
  !cdir unroll=8
    DO JLEV = 1, KFLEV
      DO JROF = KSTART, KPROF
        PTENDQG(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
         & (PFESG  (JROF,JLEV-1) - PFESG  (JROF,JLEV)) +&
         & (PFECG  (JROF,JLEV-1) - PFECG  (JROF,JLEV)) +&
         & (PFCQGNG(JROF,JLEV-1) - PFCQGNG(JROF,JLEV)) +&
         & (ZFPG   (JROF,JLEV-1) - ZFPG   (JROF,JLEV)) -&
         & (PFASG  (JROF,JLEV-1) - PFASG  (JROF,JLEV)))
      ENDDO
    ENDDO
    IF(LFLEXDIA) THEN
      !-------------------------------------------------
      ! QG DDH budget.
      !-------------------------------------------------
      IF (LDDH_OMP) THEN
        ZTMPVAR(KSTART:KPROF,1:KFLEV)= &
        & PDELP(KSTART:KPROF,1:KFLEV)*PQG(KSTART:KPROF,1:KFLEV)
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQG',YDDDH)
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFESG,'FQGESG',YDDDH)
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFECG,'FQGECG',YDDDH)
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQGNG,'FQGCQGNG',YDDDH)
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZFPG,'FQGPG',YDDDH)
        ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFASG(KSTART:KPROF,0:KFLEV)
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQGASG',YDDDH)
      ELSE
        ZTMPVAR(KSTART:KPROF,1:KFLEV)= &
        & PDELP(KSTART:KPROF,1:KFLEV)*PQG(KSTART:KPROF,1:KFLEV)
        CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQG','V','ARP',.TRUE.,.TRUE.)
        CALL ADD_FIELD_3D(YDLDDH,PFESG,'FQGESG','F','ARP',.TRUE.,.TRUE.)
        CALL ADD_FIELD_3D(YDLDDH,PFECG,'FQGECG','F','ARP',.TRUE.,.TRUE.)
        CALL ADD_FIELD_3D(YDLDDH,PFCQGNG,'FQGCQGNG','F','ARP',.TRUE.,.TRUE.)
        CALL ADD_FIELD_3D(YDLDDH,ZFPG,'FQGPG','F','ARP',.TRUE.,.TRUE.)
        ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFASG(KSTART:KPROF,0:KFLEV)
        CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQGASG','F','ARP',.TRUE.,.TRUE.)
      ENDIF
    ENDIF
  ENDIF


ELSEIF(LCONDWT.AND.LGPCMT) THEN

  ! - - - - - - - - - - - - - - - - - -
  ! PCMT convection scheme.
  ! - - - - - - - - - - - - - - - - - -

  ! - - - - - - - - - - - - - - - - - -
  ! Usual equation for QL=suspended liquid water
  ! - - - - - - - - - - - - - - - - - -

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQL(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & (PDIFTQL(JROF,JLEV-1) - PDIFTQL(JROF,JLEV)) +&
       & (PDIFCQL(JROF,JLEV-1) - PDIFCQL(JROF,JLEV)) +&
       & (PFCQLNG(JROF,JLEV-1) - PFCQLNG(JROF,JLEV)) -&
       & (PFEDQLC(JROF,JLEV-1) - PFEDQLC(JROF,JLEV)) +&
       & (PFASL  (JROF,JLEV-1) - PFASL  (JROF,JLEV)) -&
       & (PFCSQL (JROF,JLEV-1) - PFCSQL (JROF,JLEV)))
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QL DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQL(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFTQL,'FQLDIFT',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFCQL,'FQLDIFC',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQLNG,'FQLCQLNG',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFEDQLC(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQLEDCONV',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFASL,'FQLASL',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFCSQL(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQLCSQL',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQL(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQL','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFTQL,'FQLDIFT','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFCQL,'FQLDIFC','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCQLNG,'FQLCQLNG','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFEDQLC(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQLEDCONV','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFASL,'FQLASL','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFCSQL(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQLCSQL','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF

  ! - - - - - - - - - - - - - - - - - -
  ! equation for QI=suspended ice water
  ! - - - - - - - - - - - - - - - - - -

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQI(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & (PDIFTQI(JROF,JLEV-1) - PDIFTQI(JROF,JLEV)) +&
       & (PDIFCQI(JROF,JLEV-1) - PDIFCQI(JROF,JLEV)) +&
       & (PFCQING(JROF,JLEV-1) - PFCQING(JROF,JLEV)) -&
       & (PFEDQIC(JROF,JLEV-1) - PFEDQIC(JROF,JLEV)) +&
       & (PFASN  (JROF,JLEV-1) - PFASN  (JROF,JLEV)) -&
       & (PFCSQN (JROF,JLEV-1) - PFCSQN (JROF,JLEV)))
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QI DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQI(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQI',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFTQI,'FQIDIFT',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFCQI,'FQIDIFC',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQING,'FQICQING',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFEDQIC(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQIEDCONV',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFASN,'FQIASN',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFCSQN(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQICSQN',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQI(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQI','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFTQI,'FQIDIFT','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFCQI,'FQIDIFC','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCQING,'FQICQING','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFEDQIC(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQIEDCONV','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFASN,'FQIASN','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFCSQN(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQICSQN','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF

  ! -----------------------------------
  ! Equation for QR=rain water
  ! -----------------------------------

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQR(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & (PFESL  (JROF,JLEV-1) - PFESL  (JROF,JLEV)) +&
       & (PFCQRNG(JROF,JLEV-1) - PFCQRNG(JROF,JLEV)) -&
       & (PFEDQRC(JROF,JLEV-1) - PFEDQRC(JROF,JLEV)) +&
       & (PFPLSL (JROF,JLEV-1) - PFPLSL (JROF,JLEV)) -&
       & (PFASL  (JROF,JLEV-1) - PFASL  (JROF,JLEV)))
    ENDDO
  ENDDO
  IF (LFLEXDIA) THEN
    !-------------------------------------------------
    ! QR DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQR(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQR',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFESL,'FQRESL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQRNG,'FQRCQRNG',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFEDQRC(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQREDCONV',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFPLSL,'FQRPL',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFASL(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQRASL',YDDDH)
    ELSE   
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQR(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQR','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFESL,'FQRESL','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCQRNG,'FQRCQRNG','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFEDQRC(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQREDCONV','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFPLSL,'FQRPL','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFASL(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQRASL','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF

  ! ---------------------------------
  ! Equation for QS=snow water
  ! --------------------------------

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQS(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & (PFESN  (JROF,JLEV-1) - PFESN  (JROF,JLEV)) +&
       & (PFCQSNG(JROF,JLEV-1) - PFCQSNG(JROF,JLEV)) -&
       & (PFEDQSC(JROF,JLEV-1) - PFEDQSC(JROF,JLEV)) +&
       & (PFPLSN (JROF,JLEV-1) - PFPLSN (JROF,JLEV)) -&
       & (PFASN  (JROF,JLEV-1) - PFASN  (JROF,JLEV)))
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QS DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQS(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQS',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFESN,'FQSESN',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCQSNG,'FQSCQSNG',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFEDQSC(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQSEDCONV',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFPLSN,'FQSPN',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFASN(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQSASN',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQS(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQS','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFESN,'FQSESN','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCQSNG,'FQSCQSNG','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFEDQSC(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQSEDCONV','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFPLSN,'FQSPN','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFASN(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQSASN','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF
  ! - - - - - - - - - - - - - - - - - -
  ! Equation for QLCONV=suspended liquid water (CONV. PART)
  ! - - - - - - - - - - - - - - - - - -
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQLCONV(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & +(PFCNEGQLC(JROF,JLEV-1) - PFCNEGQLC(JROF,JLEV))&
       & +(PDIFCQLC(JROF,JLEV-1)  - PDIFCQLC(JROF,JLEV))&
       & +(PFEDQLC(JROF,JLEV-1)   - PFEDQLC(JROF,JLEV))&
       & +(PFIMCC(JROF,JLEV-1)    - PFIMCC(JROF,JLEV))&
       & -(PFCCQL (JROF,JLEV-1)   - PFCCQL (JROF,JLEV))&
       & +(PFACL  (JROF,JLEV-1)   - PFACL  (JROF,JLEV))&
       & )
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QLCONV DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQLCONV(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VCL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCNEGQLC,'FCLCQNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFCQLC,'FCLDIFC',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFEDQLC,'FCLED',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFIMCC,'FCLIM',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFCCQL(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCLCOND',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFACL,'FCLAUTOCONV',YDDDH)
    ELSE 
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQLCONV(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VCL','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCNEGQLC,'FCLCQNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFCQLC,'FCLDIFC','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFEDQLC,'FCLED','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFIMCC,'FCLIM','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFCCQL(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCLCOND','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFACL,'FCLAUTOCONV','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF
  ! - - - - - - - - - - - - - - - - - -
  ! Equation for QICONV=suspended ice water (CONV. PART)
  ! - - - - - - - - - - - - - - - - - -
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQICONV(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & +(PFCNEGQIC(JROF,JLEV-1) - PFCNEGQIC(JROF,JLEV))&
       & +(PDIFCQIC(JROF,JLEV-1)  - PDIFCQIC(JROF,JLEV))&
       & +(PFEDQIC(JROF,JLEV-1)   - PFEDQIC(JROF,JLEV))&
       & -(PFIMCC(JROF,JLEV-1)    - PFIMCC(JROF,JLEV))&
       & -(PFCCQN (JROF,JLEV-1)   - PFCCQN (JROF,JLEV))&
       & +(PFACN  (JROF,JLEV-1)   - PFACN  (JROF,JLEV))&
       & )
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QICONV DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQICONV(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VCI',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCNEGQIC,'FCICQNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PDIFCQIC,'FCIDIFC',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFEDQIC,'FCIED',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFIMCC(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCIIM',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFCCQN(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCICOND',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFACN,'FCIAUTOCONV',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQICONV(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VCI','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCNEGQIC,'FCICQNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PDIFCQIC,'FCIDIFC','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFEDQIC,'FCIED','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFIMCC(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCIIM','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFCCQN(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCICOND','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFACN,'FCIAUTOCONV','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF
  ! -----------------------------------
  ! Equation for QRCONV=rain (CONV. PART)
  ! -----------------------------------
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQRCONV(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & +(PFCNEGQRC(JROF,JLEV-1) - PFCNEGQRC(JROF,JLEV))&
       & +(PFPLCL (JROF,JLEV-1)   - PFPLCL (JROF,JLEV))&
       & +(PFEDQRC(JROF,JLEV-1)   - PFEDQRC(JROF,JLEV))&
       & -(PFACL  (JROF,JLEV-1)   - PFACL  (JROF,JLEV))&
       & +(PFECL  (JROF,JLEV-1)   - PFECL  (JROF,JLEV))&
       & )
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QRCONV DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQRCONV(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VCR',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCNEGQRC,'FCRCQNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFPLCL,'FCRSEDIM',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFEDQRC,'FCRED',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFACL(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCRAUTOCONV',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFECL,'FCREVAPO',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQRCONV(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VCR','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCNEGQRC,'FCRCQNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFPLCL,'FCRSEDIM','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFEDQRC,'FCRED','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFACL(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCRAUTOCONV','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFECL,'FCREVAPO','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF
  ! ---------------------------------
  ! Equation for QSCONV=snow (CONV. PART)
  ! --------------------------------
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQSCONV(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & +(PFCNEGQSC(JROF,JLEV-1) - PFCNEGQSC(JROF,JLEV))&
       & +(PFPLCN (JROF,JLEV-1)   - PFPLCN (JROF,JLEV))&
       & +(PFEDQSC(JROF,JLEV-1)   - PFEDQSC(JROF,JLEV))&
       & -(PFACN  (JROF,JLEV-1)   - PFACN  (JROF,JLEV))&
       & +(PFECN  (JROF,JLEV-1)   - PFECN  (JROF,JLEV))&
       & )
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QSCONV DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQSCONV(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VCS',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFCNEGQSC,'FCSCQNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFPLCN,'FCSSEDIM',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFEDQSC,'FCSED',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFACN(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCSAUTOCONV',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,PFECN,'FCSEVAPO',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*PQSCONV(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VCS','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFCNEGQSC,'FCSCQNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFPLCN,'FCSSEDIM','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFEDQSC,'FCSED','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-PFACN(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCSAUTOCONV','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,PFECN,'FCSEVAPO','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF
ENDIF

!     For DDH, could be used in next loop for PTENDQ, PTENDQI,PTENDQL
IF (LFLEXDIA) THEN
  IF (LLDPSFI) THEN
    DO JLEV = 0, KFLEV
      DO JROF = KSTART, KPROF
        PFCMPCQ(JROF,JLEV) = ZQH(JROF,JLEV)*ZLIFT(JROF,JLEV)
        IF (LCONDWT) THEN
           PFCMPSN(JROF,JLEV) = ZQIH(JROF,JLEV)*ZLIFT(JROF,JLEV)
           PFCMPSL(JROF,JLEV) = ZQLH(JROF,JLEV)*ZLIFT(JROF,JLEV)
         ENDIF
      ENDDO
    ENDDO
  ELSE
    DO JLEV = 0, KFLEV
      DO JROF = KSTART, KPROF
        PFCMPCQ(JROF,JLEV) =  0.0_JPRB
        IF (LCONDWT) THEN
           PFCMPSN(JROF,JLEV) =  0.0_JPRB
           PFCMPSL(JROF,JLEV) =  0.0_JPRB
         ENDIF
      ENDDO
    ENDDO
  ENDIF
ENDIF

IF (LLDPSFI) THEN
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
       PTENDQ(JROF,JLEV) = PTENDQ(JROF,JLEV)-ZGSDP(JROF,JLEV)*&
         & (ZQH(JROF,JLEV-1)*ZLIFT(JROF,JLEV-1)-&
         & ZQH(JROF,JLEV)*ZLIFT(JROF,JLEV))
       IF (LCONDWT) THEN
         PTENDQI(JROF,JLEV) = PTENDQI(JROF,JLEV)-ZGSDP(JROF,JLEV)*&
           & (ZQIH(JROF,JLEV-1)*ZLIFT(JROF,JLEV-1)-&
           & ZQIH(JROF,JLEV)*ZLIFT(JROF,JLEV))
         PTENDQL(JROF,JLEV) = PTENDQL(JROF,JLEV)-ZGSDP(JROF,JLEV)*&
           & (ZQLH(JROF,JLEV-1)*ZLIFT(JROF,JLEV-1)-&
           & ZQLH(JROF,JLEV)*ZLIFT(JROF,JLEV))
       ENDIF
    ENDDO
  ENDDO
ENDIF

!  ------------------------------------------------------------
!   3. CALCUL DE L'EVOLUTION DE TKE
!  ------------------------------------------------------------

IF (LECT) THEN
  IF (JPRD == JPRB) THEN
    DO JLEV = 1, KFLEV
      DO JROF = KSTART, KPROF
        PTENDTKE(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
         & PFTKE (JROF,JLEV-1) - PFTKE (JROF,JLEV))
      ENDDO
    ENDDO
  ELSE
! This appears to be a more precise calculation of the TKE tendency
! but is not compatible with the interface of cptend_new and needs
! to be reviewed
    DO JLEV = 1, KFLEV
      DO JROF = KSTART, KPROF
        PTENDTKE(JROF,JLEV) = PFTKEI (JROF, JLEV)
      ENDDO
    ENDDO
  ENDIF
ENDIF

!  ------------------------------------------------------------
!   3.1 CALCUL DE L'EVOLUTION DE EFB1, EFB2 and EFB3
!  ------------------------------------------------------------

IF (LEFB) THEN
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDEFB1(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & PFEFB1 (JROF,JLEV-1) - PFEFB1 (JROF,JLEV))
      PTENDEFB2(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & PFEFB2 (JROF,JLEV-1) - PFEFB2 (JROF,JLEV))
      PTENDEFB3(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & PFEFB3 (JROF,JLEV-1) - PFEFB3 (JROF,JLEV))
    ENDDO
  ENDDO
ENDIF

!  ------------------------------------------------------------
!   ?. CALCUL DE L'EVOLUTION DES SCALAIRES PASSIFS
!  ------------------------------------------------------------

IF(LMDUST.AND.(NGFL_EXT/=0)) THEN
  DO JGFL = 1, NGFL_EXT
    DO JLEV = 1, KFLEV
      DO JROF = KSTART, KPROF
        PTENDEXT(JROF,JLEV,JGFL) = ZGSDP(JROF,JLEV)*(&
          & PDIFEXT(JROF,JLEV-1,JGFL) - PDIFEXT(JROF,JLEV,JGFL))
      ENDDO
    ENDDO
  ENDDO
ENDIF
!

!  ------------------------------------------------------------
!   4. CALCUL DE L'EVOLUTION DE P ET W (CAS NH)
!  ------------------------------------------------------------

! TO DO

!--------------------------------------------------------------------------

IF(LFLEXDIA) THEN

  !-------------------------------------------------
  ! U AND V DDH Budget.
  !-------------------------------------------------

  DO JLEV = 0, KFLEV
    DO JROF=KSTART,KPROF
      ZSTTUG(JROF,JLEV) = PGNORDM(JROF)*PSTRTU(JROF,JLEV)-&
      & PGNORDL(JROF)*PSTRTV(JROF,JLEV)
      ZSTTVG(JROF,JLEV) = PGNORDL(JROF)*PSTRTU(JROF,JLEV)+&
      & PGNORDM(JROF)*PSTRTV(JROF,JLEV)
      ZSTCUG(JROF,JLEV) = PGNORDM(JROF)*PSTRCU(JROF,JLEV)-&
      & PGNORDL(JROF)*PSTRCV(JROF,JLEV)
      ZSTCVG(JROF,JLEV) = PGNORDL(JROF)*PSTRCU(JROF,JLEV)+&
      & PGNORDM(JROF)*PSTRCV(JROF,JLEV)
      ZSTDUG(JROF,JLEV) = PGNORDM(JROF)*PSTRDU(JROF,JLEV)-&
      & PGNORDL(JROF)*PSTRDV(JROF,JLEV)
      ZSTDVG(JROF,JLEV) = PGNORDL(JROF)*PSTRDU(JROF,JLEV)+&
      & PGNORDM(JROF)*PSTRDV(JROF,JLEV)
    ENDDO
  ENDDO

  DO JLEV = 1, KFLEV
    DO JROF=KSTART,KPROF
      ZUZGEO(JROF,JLEV)=PGNORDM(JROF)*PU(JROF,JLEV)-PGNORDL(JROF)*PV(JROF,JLEV)
      ZVMGEO(JROF,JLEV)=PGNORDL(JROF)*PU(JROF,JLEV)+PGNORDM(JROF)*PV(JROF,JLEV)
    ENDDO
  ENDDO

  IF (LDDH_OMP) THEN
     ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
    & PDELP(KSTART:KPROF,1:KFLEV)*PU(KSTART:KPROF,1:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VUU',YDDDH)
    ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
    & PDELP(KSTART:KPROF,1:KFLEV)*PV(KSTART:KPROF,1:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VVV',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZSTTUG,'FUUTUR',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZSTTVG,'FVVTUR',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZSTCUG,'FUUTURCONV',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZSTCVG,'FVVTURCONV',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZSTDUG,'FUUONDEGREL',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZSTDVG,'FVVONDEGREL',YDDDH)
  ELSE
    ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
    & PDELP(KSTART:KPROF,1:KFLEV)*PU(KSTART:KPROF,1:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VUU','V','ARP',.TRUE.,.TRUE.)
    ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
    & PDELP(KSTART:KPROF,1:KFLEV)*PV(KSTART:KPROF,1:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VVV','V','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZSTTUG,'FUUTUR','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZSTTVG,'FVVTUR','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZSTCUG,'FUUTURCONV','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZSTCVG,'FVVTURCONV','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZSTDUG,'FUUONDEGREL','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZSTDVG,'FVVONDEGREL','F','ARP',.TRUE.,.TRUE.)
  ENDIF

  !-------------------------------------------------
  ! Kinetic Energy DDH budget.
  !-------------------------------------------------

  DO JLEV=1,KFLEV
    DO JROF=KSTART,KPROF
!     VKK
      ZKENE(JROF,JLEV)  = 0.5_JPRB*&
      & (PU(JROF,JLEV)**2+PV(JROF,JLEV)**2)
!     TKKDISSIPTUR
      ZTNDKKT(JROF,JLEV) = -( ZUZGEO(JROF,JLEV)*&
       & (ZSTTUG(JROF,JLEV)-ZSTTUG(JROF,JLEV-1)) + ZVMGEO(JROF,JLEV)&
       & *(ZSTTVG(JROF,JLEV)-ZSTTVG(JROF,JLEV-1)) )
!     TKKDISSIPCONV
      ZTNDKKC(JROF,JLEV) = -( ZUZGEO(JROF,JLEV)*&
       & (ZSTCUG(JROF,JLEV)-ZSTCUG(JROF,JLEV-1)) + ZVMGEO(JROF,JLEV)&
       & *(ZSTCVG(JROF,JLEV)-ZSTCVG(JROF,JLEV-1)) )
!     TKKDISSIPGREL
      ZTNDKKD(JROF,JLEV) = -( ZUZGEO(JROF,JLEV)*&
       & (ZSTDUG(JROF,JLEV)-ZSTDUG(JROF,JLEV-1)) + ZVMGEO(JROF,JLEV)&
       & *(ZSTDVG(JROF,JLEV)-ZSTDVG(JROF,JLEV-1)) )
    ENDDO
  ENDDO

  IF(LDDH_OMP) THEN
    ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*ZKENE(KSTART:KPROF,1:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VKK',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTNDKKT,'TKKDISSTUR',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTNDKKC,'TKKDISSCONV',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTNDKKD,'TKKDISSGREL',YDDDH)
  ELSE
    ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & PDELP(KSTART:KPROF,1:KFLEV)*ZKENE(KSTART:KPROF,1:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VKK','V','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZTNDKKT,'TKKDISSTUR','T','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZTNDKKC,'TKKDISSCONV','T','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZTNDKKD,'TKKDISSGREL','T','ARP',.TRUE.,.TRUE.)
  ENDIF

ENDIF
IF(LMUSCLFA) THEN

  !-------------------------------------------------
  ! Single column model MUSC diagnostics.
  ! Q1 and Q2.
  !-------------------------------------------------

  DO JLEV=1,KFLEV
    DO JROF=KSTART,KPROF
      ZQ1(JROF,JLEV)=(PTENDH(JROF,JLEV)-(YDCST%RCPV-YDCST%RCPD)*PTENDQ(JROF,JLEV)*PT(JROF,JLEV))/PCP(JROF,JLEV)
      ZQ2(JROF,JLEV)=-FOLH(PT(JROF,JLEV),MAX(0._JPRB,SIGN(1._JPRB,YDCST%RTT-PT(JROF,JLEV))))&
        & *PTENDQ(JROF,JLEV)/PCP(JROF,JLEV)
    ENDDO
  ENDDO
  CALL WRSCMR(NMUSCLFA,'Q1',ZQ1,KPROF,KFLEV)
  CALL WRSCMR(NMUSCLFA,'Q2',ZQ2,KPROF,KFLEV)

ENDIF

!-----------------------------------------------------------------------
END ASSOCIATE
END ASSOCIATE

IF (LHOOK) CALL DR_HOOK('CPTEND_NEW',1,ZHOOK_HANDLE)
END SUBROUTINE CPTEND_NEW

