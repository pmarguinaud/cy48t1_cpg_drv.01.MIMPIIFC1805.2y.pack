SUBROUTINE CPTEND_NEW ( &
 & YDMF_PHYS, YDMF_PHYS_STATE, YDVARS, &
 & YDMODEL,KPROMA, KSTART, KPROF, KFLEV,PGNORDL,PGNORDM,&
 !  Variables 2D Input
 & PDIFEXT,&
 & &
 & &
 & &
 & &
 & &
 & &
 & PFRMQ  , &
 & &
 & &
 & &
 & &
 & PFTKE  , PFTKEI,  PFEFB1,  PFEFB2,  PFEFB3, &
 & &
 & &
 & &
 & &
 & &
 !  Variables 1D Input
 & PCPS   , &
 !  Variables 2D Output
 & &
 & &
 & PFHP   , PFP    , &
 & PTENDU_ZDEC, PTENDV_ZDEC, PTENDH ,&
 & PTENDQ , PTENDQI, PTENDQL, &
 & PTENDQLCONV, PTENDQICONV, &
 & PTENDQRCONV, PTENDQSCONV, &
 & PTENDQR, PTENDQS, PTENDQG, &
 & PTENDTKE, PTENDEFB1, PTENDEFB2, PTENDEFB3, PTENDEXT, YDDDH )
!     ------------------------------------------------------------------
!     ACTION DES PROCESSUS PHYSIQUES SUR LA QUANTITE DE MOUVEMENT ,
!     LES VARIABLES THERMODYNAMIQUES ET SUR L'EQUATION DE CONTINUITE
!     INTERFACE AVEC LES PARAMETRISATIONS PHYSIQUES  (IALPP)
!     ------------------------------------------------------------------

!     BUT
!     ---
!**** *CPTEND* CACUL DES TENDANCES PHYSIQUES SUR U, V, H, Q, QI, QL, TKE
!      SPECIFIQUE ET SUR LA TEMPERATURE.

!      VOIR DOCUMENTATION, INTERFACE PHYSICO-DYNAMIQUE.
!                            -----------------

!      POUR COMPRENDRE LA LOGIQUE DE CETTE ROUTINE, BIEN REALISER
!      QUE LA VARIABLE THERMODYNAMIQUE DE LA PHYSIQUE EST L ENTHALPIE
!                                                         -----------
!      (PLUS EXACTEMENT L ENERGIE STATIQUE HUMIDE)

!      LE TRANSPORT EVENTUEL PAR LES PLUIES EST PRIS EN COMPTE DE
!      MANIERE MIXTE :
!      - UNE PARTIE DE CE TRANSPORT EST CONTENUE DE MANIERE IMPLICITE
!        DANS LA FORMULATION EN FLUX D ENTHALPIE
!      - IL RESTE POURTANT UN TERME DE TRANSPORT D ENERGIE POTENTIELLE
!        QUI EST TRAITE ICI COMME UNE ADVECTION VERTICALE

!     ARGUMENTS D ENTREE
!     ------------------
!       KPROMA : DIMENSION HORIZONTALE
!       KSTART : DEBUT DE LA BOUCLE HORIZONTALE
!       KPROF  : BORNE HORIZONTALE DES CALCULS
!       KFLEV  : DIMENSION ET BORNE VERTICALE
!       PGNORDL,PGNORDM : compass.

! --- INPUT 2D (0:KLEV).
!     -----------------.
! PDIFCQ     : FLUX CONVECTIF D'HUMIDITE SPECIFIQUE (HORS COND. ET RR).
! PDIFCQI    : FLUX CONVECTIF D'EAU SOLIDE (HORS COND. ET RR).
! PDIFCQL    : FLUX CONVECTIF D'EAU LIQUIDE (HORS COND. ET RR).
! PDIFCS     : FLUX CONVECTIF D'ENTHALPIE .
! PDIFEXT    : FLUX DES EXTRA-GFL .
! PDIFTQ     : FLUX TURBULENT (ET Q NEGATIF) D'HUMIDITE SPECIFIQUE.
! PDIFTQI    : FLUX TURBULENT (ET Q NEGATIF) D'EAU GLACE.
! PDIFTQL    : FLUX TURBULENT (ET Q NEGATIF) D'EAU LIQUIDE.
! PDIFTS     : FLUX TURBULENT D'ENTHALPIE (OU D'ENERGIE STATIQUE SECHE).
! PFCCQL     : FLUX DE CONDENSATION LIE AUX RR CONVECTIVES LIQUIDES.
! PFCCQN     : FLUX DE CONDENSATION LIE AUX RR CONVECTIVES NEIGEUSES.
! PFCSQL     : FLUX DE CONDENSATION LIE AUX RR STRATIFORMES LIQUIDES.
! PFCSQN     : FLUX DE CONDENSATION LIE AUX RR STRATIFORMES NEIGEUSES.
! PFPLCL     : PRECIPITATIONS CONVECTIVES SOUS FORME LIQUIDE.
! PFPLCN     : PRECIPITATIONS CONVECTIVES SOUS FORME NEIGE.
! PFPLCG     : PRECIPITATIONS CONVECTIVES SOUS FORME GRAUPEL.
! PFPLSL     : PRECIPITATIONS STRATIFORMES SOUS FORME LIQUIDE.
! PFPLSN     : PRECIPITATIONS STRATIFORMES SOUS FORME NEIGE.
! PFPLSG     : PRECIPITATIONS STRATIFORMES SOUS FORME GRAUPEL.
! PFRMH      : FLUX MESOSPHERIQUE D'ENTHALPIE.
! PFRMQ      : FLUX MESOSPHERIQUE D'EAU.
! PFRSO      : FLUX DE RAYONNEMENT SOLAIRE.
! PFRTH      : FLUX DE RAYONNEMENT THERMIQUE.
! PSTRCU     : FLUX CONVECTIF DE QUANTITE DE MOUVEMENT "U".
! PSTRCV     : FLUX CONVECTIF DE QUANTITE DE MOUVEMENT "V".
! PSTRDU     : FLUX "GRAVITY WAVE DRAG" "U".
! PSTRDV     : FLUX "GRAVITY WAVE DRAG" "V".
! PSTRTU     : FLUX TURBULENT DE QUANTITE DE MOUVEMENT "U".
! PSTRTV     : FLUX TURBULENT DE QUANTITE DE MOUVEMENT "V".
! PSTRMU     : FLUX MESOSPHERIQUE DE QUANTITE DE MOUVEMENT "U".
! PSTRMV     : FLUX MESOSPHERIQUE DE QUANTITE DE MOUVEMENT "V".
! PDIFCQLC   : CONVECTIVE TRANSPORT FLUX OF QLC (LIQUID CONVECTIVE).
! PDIFCQIC   : CONVECTIVE TRANSPORT FLUX OF QIC (ICE CONVECTIVE).
! PFIMCC     : Q FLUX DUE TO ICING-MELTING FOLLOWING CONVECTIVE TRANSPORT OF CONVECTIVE LIQUID AND ICE WATER.
! PFEDQLC    : ENTRAINMENT-DETRAINMENT OF QLC AND QLR (LIQUID CONVECTIVE AND RESOLVED).
! PFEDQIC    : ENTRAINMENT-DETRAINMENT OF QIC AND QIR (ICE    CONVECTIVE AND RESOLVED).
! PFEDQRC    : ENTRAINMENT-DETRAINMENT OF QRC AND QRR (RAIN   CONVECTIVE AND RESOLVED).
! PFEDQSC    : ENTRAINMENT-DETRAINMENT OF QSC AND QSR (SNOW   CONVECTIVE AND RESOLVED).
! PFCNEGQLC  : CORRECT NEGATIVE VALUES OF QLC (LIQUID CONVECTIVE).
! PFCNEGQIC  : CORRECT NEGATIVE VALUES OF QIC (ICE    CONVECTIVE).
! PFCNEGQRC  : CORRECT NEGATIVE VALUES OF QRC (RAIN   CONVECTIVE).
! PFCNEGQSC  : CORRECT NEGATIVE VALUES OF QSC (SNOW   CONVECTIVE).
! PFTKE      : FLUX DE "TKE".

! --- INPUT 2D (1:KLEV).
!     -----------------.
! PRDELP     : INVERSE DE L'EPAISSEUR EN PRESSION DE LA COUCHE.
! PAPHIF     : GEOPOTENTIEL AUX NIVEAUX DES COUCHES.
! PCP        : CHALEUR MASSIQUE A PRESSION CONSTANTE DE L'AIR.
! PU         : COMPOSANTE EN X DU VENT.
! PV         : COMPOSANTE EN Y DU VENT.
! PT         : TEMPERATURE.
! PQ         : HUMIDITE SPECIFIQUE DE LA VAPEUR D'EAU.
! PQI        : GLACE.
! PQL        : EAU LIQUIDE.
! PQR        : RAIN
! PQS        : SNOW
! PQG        : GRAUPEL
! PQLCONV    : LIQUID WATER (CONVECTIVE).
! PQICONV    : ICE    WATER (CONVECTIVE).
! PQRCONV    : RAIN   WATER (CONVECTIVE).
! PQSCONV    : SNOW   WATER (CONVECTIVE).

! - 1D.
!   --.
! PCPS       : CHALEUR SPECIFIQUE EN SURFACE.
! PTS        : TEMPERATURE DE SURFACE.

! --- ARGUMENTS IMPLICITES.
!     --------------------.
! CONSTANTES UNIVERSELLES = COMMON /YOMCST/: RG,RCPD
! INDICATEURS LOGIQUES    = COMMON /YOMPHY/: NDPSFI,LCONDWT

! --- SORTIES 2D (0:KFLEV).
!     --------------------.
! PFHSCL : FLUX DE CHALEUR SENSIBLE LIE AUX RR CONVECTIVES LIQUIDES.
! PFHSCN : FLUX DE CHALEUR SENSIBLE LIE AUX RR CONVECTIVES NEIGEUSES.
! PFHSSL : FLUX DE CHALEUR SENSIBLE LIE AUX RR STRATIFORMES LIQUIDES.
! PFHSSN : FLUX DE CHALEUR SENSIBLE LIE AUX RR STRATIFORMES NEIGEUSES.
! PFHSSG : FLUX DE CHALEUR SENSIBLE LIE AUX RR STRATIFORMES GRAUPEL.
! PFHPCL : FLUX D'ENTHALPIE LIE A LA CONDENSATION CONVECTIVE LIQUIDE.
! PFHPCN : FLUX D'ENTHALPIE LIE A LA CONDENSATION CONVECTIVE NEIGEUSE.
! PFHPCG : FLUX D'ENTHALPIE LIE A LA CONDENSATION CONVECTIVE GRAUPEL.
! PFHPSL : FLUX D'ENTHALPIE LIE A LA CONDENSATION STRATIFORME LIQUIDE.
! PFHPSN : FLUX D'ENTHALPIE LIE A LA CONDENSATION STRATIFORME NEIGEUSE.
! PFHPSG : FLUX D'ENTHALPIE LIE A LA CONDENSATION STRATIFORME GRAUPEL.
! PFHP   : FLUX TOTAL D'ENTHALPIE + FLUX DE CHALEUR SENSIBLE.
! PFP    : FLUX TOTAL DE PRECIPITATIONS.
! PFEPFP : PSEUDO FLUX D'ENTHALPIE LIE A L'ENERGIE PRECIPITATIONS.

! --- SORTIES 2D (1:KFLEV).
!     --------------------.
! PTENDU     : TENDANCE DU VENT SUR U.
! PTENDV     : TENDANCE DU VENT SUR V.
! PTENDU_ZDEC : TENDANCE DU VENT SUR U. USED IN CPUTQY TO COMPUTE T TENDENCIES (WITHOUT DEEP CONVECTION CONTRIBUTION)
! OF LCVTDK TO AVOID DOUBLE COUNTING)
! PTENDV_ZDEC : TENDANCE DU VENT SUR V. USED IN CPUTQY TO COMPUTE T TENDENCIES (WITHOUT DEEP CONVECTION CONTRIBUTION) 
! OF LCVTDK TO AVOID DOUBLE COUNTING)
! PTENDH     : TENDANCE DE L'ENTHALPIE.
! PTENDQ     : TENDANCE DE L'HUMIDITE.
! PTENDQI    : TENDANCE DE L'EAU GLACE.
! PTENDQL    : TENDANCE DE L'EAU LIQUIDE.
! PTENDQR    : TENDANCE DU CONTENU EN EAU PRECIPITANT LIQUIDE.
! PTENDQS    : TENDANCE DU CONTENU EN EAU PRECIPITANT SOLIDE.
! PTENDQG    : TENDANCE DU CONTENU EN EAU PRECIPITANT GRAUPEL.
! PTENDQLCONV: TENDANCE DE L'EAU LIQUIDE (CONVECTIVE).
! PTENDQICONV: TENDANCE DE L'EAU GLACE   (CONVECTIVE).
! PTENDQRCONV: TENDANCE DE L'EAU PLUIE   (CONVECTIVE).
! PTENDQSCONV: TENDANCE DE L'EAU NEIGE   (CONVECTIVE).
! PTENDTKE   : TENDANCE DE TKE.
! PTENDEXT   : GFL EXTRA tendency.
! --- AUTEUR.
!     ------.
!     02/01/92 E.BAZILE.
!        Reunification de Cpaty,Cpdthp,Cpdup par E.Bazile.

! --- MODIFICATIONS.
!     --------------
!      Modified 04-01-16 by P. Marquet (Lopez and Gueremy schemes,
!                        they both add PFPEVPP to PTENDQ, with
!                        PFPFP and PFADVP only for Lopez)
!                        The signs of the fluxes PFPEVPP, PFPFP and
!                        PFADVP have changed in ADVPRC.
!      Modified 07-02-01 by M.Janousek (Catry's modifications for
!                        NDPSFI=1; tendency of pTKE)
!      Modified 07-05-07 by F.Bouyssel (tendency of TKE + Cleaning)
!      Modified 07-06-13 by T.Kovacic, PFCMPCQ, PFCMPSN, PFCMPSL added for DDH
!        Modified 11-02-01 by M. Mokhtari add the key LMDUST and traitement of passifs scalars
!        Modified 11-03-31 by M. Deque : Relax. of Meso. Specific Humidity added (fix)
!        Modified 11-12-01 by J. Van den Bergh: introduction of graupel
!        2011-09-07 J.M. Piriou: PCMT convection scheme.
!        2013-11, D. Degrauwe: Bugfix (use halflevel cp in case of NDPSFI=1).
!        2014-02-20 J.M. Piriou: fix 2 bugs in ZFHIMCC computation.
!        2014-04-30 J.M. Piriou: change sign in ZFHIMCC computation.
!        2016-10-04 P. Marguinaud : Port to single precision
!        2019-12-12 Y. Bouteloup : Introduction of PTENDU_ZDEC and PTENDV_ZDEC (for Tiedtke scheme)
!-----------------------------------------------------------------------

USE FIELD_VARIABLES_MOD, ONLY : FIELD_VARIABLES
USE MF_PHYS_TYPE_MOD   , ONLY : MF_PHYS_TYPE
USE MF_PHYS_STATE_TYPE_MOD &
                       , ONLY : MF_PHYS_STATE_TYPE
USE TYPE_MODEL , ONLY : MODEL
USE PARKIND1 , ONLY : JPIM, JPRB, JPRD
USE YOMHOOK  , ONLY : LHOOK, DR_HOOK
USE YOMCST   , ONLY : RG, RV, RCPV, RETV, RCW, RCS, RLVTT, RLSTT, RTT, RALPW, &
 & RBETW, RGAMW, RALPS, RBETS, RGAMS, RALPD, RBETD,  RGAMD, RCPD, RLVZER, RLSZER
USE DDH_MIX  , ONLY : ADD_FIELD_3D, NEW_ADD_FIELD_3D, TYP_DDH
USE YOMLSFORC, ONLY : LMUSCLFA,NMUSCLFA

!-----------------------------------------------------------------------

IMPLICIT NONE

TYPE(MODEL)       ,INTENT(INOUT) :: YDMODEL
TYPE(MF_PHYS_TYPE),INTENT(INOUT) :: YDMF_PHYS
TYPE(MF_PHYS_STATE_TYPE),INTENT(INOUT) :: YDMF_PHYS_STATE
TYPE(FIELD_VARIABLES),INTENT(INOUT) :: YDVARS
INTEGER(KIND=JPIM),INTENT(IN)    :: KPROMA
INTEGER(KIND=JPIM),INTENT(IN)    :: KFLEV
INTEGER(KIND=JPIM),INTENT(IN)    :: KSTART
INTEGER(KIND=JPIM),INTENT(IN)    :: KPROF
REAL(KIND=JPRB)   ,INTENT(IN)    :: PGNORDL(KPROMA)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PGNORDM(KPROMA)




REAL(KIND=JPRB)   ,INTENT(IN)    :: PDIFEXT (KPROMA,0:KFLEV,1:YDMODEL%YRML_GCONF%YGFL%NGFL_EXT)















REAL(KIND=JPRB)   ,INTENT(IN)    :: PFRMQ   (KPROMA,0:KFLEV)























REAL(KIND=JPRB)   ,INTENT(IN)    :: PFTKE   (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFTKEI  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFEFB1  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFEFB2  (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFEFB3  (KPROMA,0:KFLEV)




































REAL(KIND=JPRB)   ,INTENT(IN)    :: PCPS    (KPROMA)












REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFHP    (KPROMA,0:KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFP     (KPROMA,0:KFLEV)



REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDU_ZDEC  (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDV_ZDEC  (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDH  (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQ  (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQI (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQL (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQR (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQS (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQG (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQLCONV (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQICONV (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQRCONV (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDQSCONV (KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDTKE(KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDEFB1(KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDEFB2(KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDEFB3(KPROMA,KFLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDEXT(KPROMA,KFLEV,YDMODEL%YRML_GCONF%YGFL%NGFL_EXT)
TYPE(TYP_DDH)     ,INTENT(INOUT) :: YDDDH
!-----------------------------------------------------------------------




REAL(KIND=JPRB) :: ZGSDP (KPROMA,KFLEV)
REAL(KIND=JPRB) :: ZJTOT (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFHSENS(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFHDPSFI(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZTI   (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZQH   (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZQLH  (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZQIH  (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZQRH  (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZQSH  (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZQGH  (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZCHAT (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZLIFT (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFPL  (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFPN  (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFPG  (KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFPLSL(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFPLSN(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFPLSG(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFPLCL(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFPLCN(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFPLCG(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZFHIMCC(KPROMA,0:KFLEV)

REAL(KIND=JPRB) :: ZTMPVAR(KPROMA,KFLEV)
REAL(KIND=JPRB) :: ZTMPFLUX(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZSTTUG(KPROMA,0:KFLEV), ZSTTVG(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZSTCUG(KPROMA,0:KFLEV), ZSTCVG(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZSTDUG(KPROMA,0:KFLEV), ZSTDVG(KPROMA,0:KFLEV)
REAL(KIND=JPRB) :: ZTNDKKC(KPROMA,KFLEV), ZTNDKKD(KPROMA,KFLEV)
REAL(KIND=JPRB) :: ZTNDKKT(KPROMA,KFLEV), ZKENE(KPROMA,KFLEV)
REAL(KIND=JPRB) :: ZUZGEO(KPROMA,KFLEV), ZVMGEO(KPROMA,KFLEV)
REAL(KIND=JPRB) :: ZQ1(KPROMA,KFLEV), ZQ2(KPROMA,KFLEV)
REAL(KIND=JPRB) :: ZCPH

INTEGER(KIND=JPIM) :: JLEV, JROF, JGFL

LOGICAL :: LLDPSFI

REAL(KIND=JPRB) :: ZHOOK_HANDLE

#include "wrscmr.intfb.h"
#include "fcttrm.func.h"

!-----------------------------------------------------------------------
IF (LHOOK) CALL DR_HOOK('CPTEND_NEW',0,ZHOOK_HANDLE)
ASSOCIATE(YDPHY=>YDMODEL%YRML_PHY_MF%YRPHY,YGFL=>YDMODEL%YRML_GCONF%YGFL,YDLDDH=>YDMODEL%YRML_DIAG%YRLDDH, &
 & YDARPHY=>YDMODEL%YRML_PHY_MF%YRARPHY)
ASSOCIATE(LMDUST=>YDARPHY%LMDUST, &
 & NGFL_EXT=>YGFL%NGFL_EXT, &
 & LCONDWT=>YDPHY%LCONDWT, LPHSPSH=>YDPHY%LPHSPSH, LEFB=>YDPHY%LEFB, &
 & LGPCMT=>YDPHY%LGPCMT, LECT=>YDPHY%LECT, LCVTDK=>YDPHY%LCVTDK, NDPSFI=>YDPHY%NDPSFI, &
 & LGRAPRO=>YDPHY%LGRAPRO, LFLEXDIA=>YDLDDH%LFLEXDIA,LDDH_OMP=>YDLDDH%LDDH_OMP)
!-----------------------------------------------------------------------

! ------------------------------------------------------------------
! intermediate CPTEND version made for acpluie_prog and Luc's scheme
! ------------------------------------------------------------------

! the following assumptions are made:

! * Lopez scheme uses both QR and QS as prognostic variable
! * the diffusive fluxes (for qv, qi, ql and s) have a turbulent
!   and convective component
! * the pseudo-fluxes between the species (','',''') all have a
!   stratiform component, only condensation has a convective
!   component
! * CPFHPFS is integrated in this routine and should not be called
! ------------------------------------------------------------------

!    -------------------------------------------------------------------

LLDPSFI=(NDPSFI==1)
ZLIFT=0.0_JPRB
ZCHAT=0.0_JPRB

IF(LGPCMT) THEN
  ! Heat flux due to convective icing/melting of cloud condensates.
  DO JROF = KSTART, KPROF
    ZFHIMCC(JROF,0)=0._JPRB
  ENDDO
  DO JLEV= 1, KFLEV
    DO JROF = KSTART, KPROF
      ZFHIMCC(JROF,JLEV)=ZFHIMCC(JROF,JLEV-1)+(YDMF_PHYS%OUT%FIMCC(JROF,JLEV)-YDMF_PHYS%OUT%FIMCC(JROF,JLEV-1))&
        & *(RLVZER-RLSZER)
    ENDDO
  ENDDO
ELSE
  ZFHIMCC(:,:)=0._JPRB
ENDIF

!  ------------------------------------------------------------
!   1. CALCUL DE L'EVOLUTION DE Q ET CALCUL PARTIEL DE dU/dT ET
!  ET DE dH/dt ( avec H = CpT + Phi + Ec )
!  ------------------------------------------------------------

! Calculation of temperatures on half levels

IF (LPHSPSH) THEN
  DO JROF = KSTART, KPROF
    ZTI(JROF,0)=YDMF_PHYS_STATE%T(JROF,1)
    ZTI(JROF,KFLEV)=YDMF_PHYS_STATE%T(JROF,KFLEV)
  ENDDO
ELSE
  DO JROF = KSTART, KPROF
    ZTI(JROF,0)=YDMF_PHYS_STATE%T(JROF,1)
    ZTI(JROF,KFLEV)=YDMF_PHYS_STATE%YGSP_RR%T(JROF)
  ENDDO
ENDIF

DO JLEV= 1, KFLEV-1
  DO JROF = KSTART, KPROF
    ZTI(JROF,JLEV)=(YDMF_PHYS_STATE%T(JROF,JLEV)+YDMF_PHYS_STATE%T(JROF,JLEV+1))*0.5_JPRB
  ENDDO
ENDDO

! preparation for case delta_m=1

IF (LLDPSFI) THEN
  DO JROF = KSTART, KPROF
    ZQH  (JROF,0) = 0.0_JPRB
    ZQLH (JROF,0) = 0.0_JPRB
    ZQIH (JROF,0) = 0.0_JPRB
    ZQRH (JROF,0) = 0.0_JPRB
    ZQSH (JROF,0) = 0.0_JPRB
    ZQH  (JROF,KFLEV) = YDMF_PHYS_STATE%Q (JROF,KFLEV)
    ZQLH (JROF,KFLEV) = YDMF_PHYS_STATE%L(JROF,KFLEV)
    ZQIH (JROF,KFLEV) = YDMF_PHYS_STATE%I(JROF,KFLEV)
    ZQRH (JROF,KFLEV) = YDMF_PHYS_STATE%R(JROF,KFLEV)
    ZQSH (JROF,KFLEV) = YDMF_PHYS_STATE%S(JROF,KFLEV)
  ENDDO
  DO JLEV= 1, KFLEV-1
    DO JROF = KSTART, KPROF
      ZQH (JROF,JLEV) = (YDMF_PHYS_STATE%Q (JROF,JLEV)+YDMF_PHYS_STATE%Q (JROF,JLEV+1))*0.5_JPRB
      ZQLH(JROF,JLEV) = (YDMF_PHYS_STATE%L(JROF,JLEV)+YDMF_PHYS_STATE%L(JROF,JLEV+1))*0.5_JPRB
      ZQIH(JROF,JLEV) = (YDMF_PHYS_STATE%I(JROF,JLEV)+YDMF_PHYS_STATE%I(JROF,JLEV+1))*0.5_JPRB
      ZQRH(JROF,JLEV) = (YDMF_PHYS_STATE%R(JROF,JLEV)+YDMF_PHYS_STATE%R(JROF,JLEV+1))*0.5_JPRB
      ZQSH(JROF,JLEV) = (YDMF_PHYS_STATE%S(JROF,JLEV)+YDMF_PHYS_STATE%S(JROF,JLEV+1))*0.5_JPRB
    ENDDO
  ENDDO
    IF (LGRAPRO) THEN
      DO JROF=KSTART, KPROF
        ZQGH (JROF,0) = 0.0_JPRB
        ZQGH (JROF,KFLEV) = YDMF_PHYS_STATE%G(JROF,KFLEV)
      ENDDO
      DO JLEV = 1, KFLEV-1
        DO JROF = KSTART, KPROF
          ZQGH(JROF,JLEV) = (YDMF_PHYS_STATE%G(JROF,JLEV)+YDMF_PHYS_STATE%G(JROF,JLEV+1))*0.5_JPRB
        ENDDO
      ENDDO
    ENDIF
ENDIF

! Transformation between absolute and relative precip fluxes

IF (LLDPSFI) THEN
  IF (LGRAPRO) THEN
    DO JLEV= 0, KFLEV
      DO JROF = KSTART, KPROF
        ZFPL(JROF,JLEV)=(1.0_JPRB-ZQRH(JROF,JLEV))*YDMF_PHYS%OUT%FPLSL(JROF,JLEV)&
          & -ZQRH(JROF,JLEV)*(YDMF_PHYS%OUT%FPLSN(JROF,JLEV)+YDMF_PHYS%OUT%FPLSG(JROF,JLEV))
        ZFPN(JROF,JLEV)=(1.0_JPRB-ZQSH(JROF,JLEV))*YDMF_PHYS%OUT%FPLSN(JROF,JLEV)&
          & -ZQSH(JROF,JLEV)*(YDMF_PHYS%OUT%FPLSL(JROF,JLEV)+YDMF_PHYS%OUT%FPLSG(JROF,JLEV))
        ZFPG(JROF,JLEV)=(1.0_JPRB-ZQGH(JROF,JLEV))*YDMF_PHYS%OUT%FPLSG(JROF,JLEV)&
          & -ZQGH(JROF,JLEV)*(YDMF_PHYS%OUT%FPLSL(JROF,JLEV)+YDMF_PHYS%OUT%FPLSN(JROF,JLEV))
        ZFPLSL(JROF,JLEV)=ZFPL(JROF,JLEV)
        ZFPLSN(JROF,JLEV)=ZFPN(JROF,JLEV)
        ZFPLSG(JROF,JLEV)=ZFPG(JROF,JLEV)
        ZFPL(JROF,JLEV)=(1.0_JPRB-ZQRH(JROF,JLEV))*YDMF_PHYS%OUT%FPLCL(JROF,JLEV)&
          & -ZQRH(JROF,JLEV)*(YDMF_PHYS%OUT%FPLCN(JROF,JLEV))
        ZFPN(JROF,JLEV)=(1.0_JPRB-ZQSH(JROF,JLEV))*YDMF_PHYS%OUT%FPLCN(JROF,JLEV)&
          & -ZQSH(JROF,JLEV)*(YDMF_PHYS%OUT%FPLCL(JROF,JLEV))
        ZFPG(JROF,JLEV)=(1.0_JPRB-ZQGH(JROF,JLEV))*YDMF_PHYS%OUT%FPLCG(JROF,JLEV)&
          & -ZQGH(JROF,JLEV)*(YDMF_PHYS%OUT%FPLCG(JROF,JLEV))
        ZFPLCL(JROF,JLEV)=ZFPL(JROF,JLEV)
        ZFPLCN(JROF,JLEV)=ZFPN(JROF,JLEV)
        ZFPLCG(JROF,JLEV)=ZFPG(JROF,JLEV)
        ZFPL(JROF,JLEV)=ZFPLSL(JROF,JLEV)+ZFPLCL(JROF,JLEV)
        ZFPN(JROF,JLEV)=ZFPLSN(JROF,JLEV)+ZFPLCN(JROF,JLEV)
        ZFPG(JROF,JLEV)=ZFPLSG(JROF,JLEV)+ZFPLCG(JROF,JLEV)
        ZCPH=RCPD+ (RCPV-RCPD)*ZQH(JROF,JLEV)+&
         & (RCW-RCPD)*(ZQLH(JROF,JLEV)+ZQRH(JROF,JLEV))+ &
         & (RCS-RCPD)*(ZQIH(JROF,JLEV)+ZQSH(JROF,JLEV)+ZQGH(JROF,JLEV))
        ZCHAT(JROF,JLEV)=(ZCPH-RCW*ZQRH(JROF,JLEV)-&
          & RCS*(ZQSH(JROF,JLEV)+ZQGH(JROF,JLEV)))/&
          & (1.0_JPRB-ZQRH(JROF,JLEV)-ZQSH(JROF,JLEV)-ZQGH(JROF,JLEV))
        ZLIFT(JROF,JLEV)=(ZFPL(JROF,JLEV)+ZFPN(JROF,JLEV)+ZFPG(JROF,JLEV))/&
          & (1.0_JPRB-ZQRH(JROF,JLEV)-ZQSH(JROF,JLEV)-ZQGH(JROF,JLEV))
      ENDDO
    ENDDO
  ELSE
    DO JLEV= 0, KFLEV
      DO JROF = KSTART, KPROF
        ZFPL(JROF,JLEV)=(1.0_JPRB-ZQRH(JROF,JLEV))*YDMF_PHYS%OUT%FPLSL(JROF,JLEV)&
          & -ZQRH(JROF,JLEV)*YDMF_PHYS%OUT%FPLSN(JROF,JLEV)
        ZFPN(JROF,JLEV)=(1.0_JPRB-ZQSH(JROF,JLEV))*YDMF_PHYS%OUT%FPLSN(JROF,JLEV)&
          & -ZQSH(JROF,JLEV)*YDMF_PHYS%OUT%FPLSL(JROF,JLEV)
        ZFPLSL(JROF,JLEV)=ZFPL(JROF,JLEV)
        ZFPLSN(JROF,JLEV)=ZFPN(JROF,JLEV)
        ZFPL(JROF,JLEV)=(1.0_JPRB-ZQRH(JROF,JLEV))*YDMF_PHYS%OUT%FPLCL(JROF,JLEV)&
          & -ZQRH(JROF,JLEV)*YDMF_PHYS%OUT%FPLCN(JROF,JLEV)
        ZFPN(JROF,JLEV)=(1.0_JPRB-ZQSH(JROF,JLEV))*YDMF_PHYS%OUT%FPLCN(JROF,JLEV)&
          & -ZQSH(JROF,JLEV)*YDMF_PHYS%OUT%FPLCL(JROF,JLEV)
        ZFPLCL(JROF,JLEV)=ZFPL(JROF,JLEV)
        ZFPLCN(JROF,JLEV)=ZFPN(JROF,JLEV)
        ZFPL(JROF,JLEV)=ZFPLSL(JROF,JLEV)+ZFPLCL(JROF,JLEV)
        ZFPN(JROF,JLEV)=ZFPLSN(JROF,JLEV)+ZFPLCN(JROF,JLEV)
        ZCPH=RCPD+ (RCPV-RCPD)*ZQH(JROF,JLEV)+&
         & (RCW-RCPD)*(ZQLH(JROF,JLEV)+ZQRH(JROF,JLEV))+ &
         & (RCS-RCPD)*(ZQIH(JROF,JLEV)+ZQSH(JROF,JLEV))
        ZCHAT(JROF,JLEV)=(ZCPH-RCW*ZQRH(JROF,JLEV)-&
         & RCS*ZQSH(JROF,JLEV))/(1.0_JPRB-ZQRH(JROF,JLEV)-ZQSH(JROF,JLEV))
        ZLIFT(JROF,JLEV)=(ZFPL(JROF,JLEV)+ZFPN(JROF,JLEV))/&
          & (1.0_JPRB-ZQRH(JROF,JLEV)-ZQSH(JROF,JLEV))
      ENDDO
    ENDDO
  ENDIF
ELSE
  DO JLEV= 0, KFLEV
    DO JROF = KSTART, KPROF
      ZFPL(JROF,JLEV)=YDMF_PHYS%OUT%FPLSL(JROF,JLEV)+YDMF_PHYS%OUT%FPLCL(JROF,JLEV)
      ZFPN(JROF,JLEV)=YDMF_PHYS%OUT%FPLSN(JROF,JLEV)+YDMF_PHYS%OUT%FPLCN(JROF,JLEV)
    ENDDO
  ENDDO
  IF (LGRAPRO) THEN
    DO JLEV=0, KFLEV
      DO JROF = KSTART, KPROF
        ZFPG(JROF,JLEV)=YDMF_PHYS%OUT%FPLSG(JROF,JLEV)
      ENDDO
    ENDDO
  ENDIF
ENDIF
! Diagnostics

DO JLEV= 0, KFLEV
  DO JROF = KSTART, KPROF

    IF (LLDPSFI) THEN

      YDMF_PHYS%OUT%FHSCL(JROF,JLEV)=ZFPLCL(JROF,JLEV)*ZTI(JROF,JLEV)*RCW
      YDMF_PHYS%OUT%FHSCN(JROF,JLEV)=ZFPLCN(JROF,JLEV)*ZTI(JROF,JLEV)*RCS
      YDMF_PHYS%OUT%FHSSL(JROF,JLEV)=ZFPLSL(JROF,JLEV)*ZTI(JROF,JLEV)*RCW
      YDMF_PHYS%OUT%FHSSN(JROF,JLEV)=ZFPLSN(JROF,JLEV)*ZTI(JROF,JLEV)*RCS
      IF (LGRAPRO) THEN
        YDMF_PHYS%OUT%FHSSG(JROF,JLEV)=ZFPLSG(JROF,JLEV)*ZTI(JROF,JLEV)*RCS
      ENDIF

    ELSE

      YDMF_PHYS%OUT%FHSCL(JROF,JLEV)=YDMF_PHYS%OUT%FPLCL(JROF,JLEV)*ZTI(JROF,JLEV)*(RCW-RCPD)
      YDMF_PHYS%OUT%FHSCN(JROF,JLEV)=YDMF_PHYS%OUT%FPLCN(JROF,JLEV)*ZTI(JROF,JLEV)*(RCS-RCPD)
      YDMF_PHYS%OUT%FHSSL(JROF,JLEV)=YDMF_PHYS%OUT%FPLSL(JROF,JLEV)*ZTI(JROF,JLEV)*(RCW-RCPD)
      YDMF_PHYS%OUT%FHSSN(JROF,JLEV)=YDMF_PHYS%OUT%FPLSN(JROF,JLEV)*ZTI(JROF,JLEV)*(RCS-RCPD)
      IF (LGRAPRO) THEN
        YDMF_PHYS%OUT%FHSSG(JROF,JLEV)=YDMF_PHYS%OUT%FPLSG(JROF,JLEV)*ZTI(JROF,JLEV)*(RCS-RCPD)
      ENDIF

    ENDIF

    YDMF_PHYS%OUT%FHPCL(JROF,JLEV)= - RLVZER * (YDMF_PHYS%OUT%FCCQL(JROF,JLEV)-YDMF_PHYS%OUT%FPEVPCL(JROF,JLEV))
    YDMF_PHYS%OUT%FHPCN(JROF,JLEV)= - RLSZER * (YDMF_PHYS%OUT%FCCQN(JROF,JLEV)-YDMF_PHYS%OUT%FPEVPCN(JROF,JLEV))
    YDMF_PHYS%OUT%FHPSL(JROF,JLEV)= - RLVZER * (YDMF_PHYS%OUT%FCSQL(JROF,JLEV)-YDMF_PHYS%OUT%FPEVPSL(JROF,JLEV))
    YDMF_PHYS%OUT%FHPSN(JROF,JLEV)= - RLSZER * (YDMF_PHYS%OUT%FCSQN(JROF,JLEV)-YDMF_PHYS%OUT%FPEVPSN(JROF,JLEV))

    PFP(JROF,JLEV)= ZFPL(JROF,JLEV) +ZFPN(JROF,JLEV)

    IF (LGRAPRO) THEN
      YDMF_PHYS%OUT%FHPSG(JROF,JLEV)= - RLSZER * (-YDMF_PHYS%OUT%FPEVPSG(JROF,JLEV))
      YDMF_PHYS%OUT%FHPCG(JROF,JLEV)= - RLSZER * (-YDMF_PHYS%OUT%FPEVPCG(JROF,JLEV))
      PFP(JROF,JLEV)= PFP(JROF,JLEV) + ZFPG(JROF,JLEV)
    ENDIF

    YDMF_PHYS%OUT%FEPFP(JROF,JLEV)=-NDPSFI*ZCHAT(JROF,JLEV)*ZTI(JROF,JLEV)*&
     & PFP(JROF,JLEV)

    PFHP(JROF,JLEV) = YDMF_PHYS%OUT%FHSCL(JROF,JLEV) + YDMF_PHYS%OUT%FHSCN(JROF,JLEV) +&
     & YDMF_PHYS%OUT%FHSSL(JROF,JLEV) + YDMF_PHYS%OUT%FHSSN(JROF,JLEV) +&
     & YDMF_PHYS%OUT%FHPCL(JROF,JLEV) + YDMF_PHYS%OUT%FHPCN(JROF,JLEV) +&
     & YDMF_PHYS%OUT%FHPSL(JROF,JLEV) + YDMF_PHYS%OUT%FHPSN(JROF,JLEV) +&
     & YDMF_PHYS%OUT%FEPFP(JROF,JLEV)

    IF (LGRAPRO) THEN
      PFHP(JROF,JLEV) = PFHP(JROF,JLEV) + YDMF_PHYS%OUT%FHSSG(JROF,JLEV) + YDMF_PHYS%OUT%FHPSG(JROF,JLEV) + YDMF_PHYS%OUT%FHPCG(JROF,JLEV)
    ENDIF
  ENDDO
ENDDO

! Computation of the total enthalpy flux J_tot (including NDPSFI==1)

DO JLEV= 0, KFLEV
  DO JROF = KSTART, KPROF
    ZJTOT(JROF,JLEV) = YDMF_PHYS%OUT%FRSO(JROF,JLEV,1)+YDMF_PHYS%OUT%FRTH(JROF,JLEV,1)+YDMF_PHYS%OUT%FRMH(JROF,JLEV)+&
        & YDMF_PHYS%OUT%DIFTS(JROF,JLEV)+YDMF_PHYS%OUT%DIFCS(JROF,JLEV)+&
        & (RCW-RCPD)*ZFPL(JROF,JLEV)*ZTI(JROF,JLEV)+&
        & (RCS-RCPD)*ZFPN(JROF,JLEV)*ZTI(JROF,JLEV)-&
        & RLVZER*(YDMF_PHYS%OUT%FCCQL(JROF,JLEV)+YDMF_PHYS%OUT%FCSQL(JROF,JLEV)-YDMF_PHYS%OUT%FPEVPSL(JROF,JLEV)&
        & -YDMF_PHYS%OUT%FPEVPCL(JROF,JLEV))-&
        & RLSZER*(YDMF_PHYS%OUT%FCCQN(JROF,JLEV)+YDMF_PHYS%OUT%FCSQN(JROF,JLEV)-YDMF_PHYS%OUT%FPEVPSN(JROF,JLEV)&
        & -YDMF_PHYS%OUT%FPEVPCN(JROF,JLEV))&
        & +ZFHIMCC(JROF,JLEV)
  ENDDO
ENDDO

IF (LGRAPRO) THEN
 DO JLEV = 0, KFLEV
   DO JROF = KSTART, KPROF
     ZJTOT(JROF,JLEV) = ZJTOT(JROF,JLEV) + (RCS-RCPD)*ZFPG(JROF,JLEV)*ZTI(JROF,JLEV) +&
      & RLSZER*(YDMF_PHYS%OUT%FPEVPSG(JROF,JLEV)+YDMF_PHYS%OUT%FPEVPCG(JROF,JLEV))
   ENDDO
 ENDDO
ENDIF

IF (LLDPSFI) THEN
  DO JLEV= 0, KFLEV
    DO JROF = KSTART, KPROF
      ZFHDPSFI(JROF,JLEV) = -(ZCHAT(JROF,JLEV)-RCPD)*ZTI(JROF,JLEV)*&
          &  (ZFPL(JROF,JLEV)+ZFPN(JROF,JLEV))
      IF (LGRAPRO) THEN
        ZFHDPSFI(JROF,JLEV) = ZFHDPSFI(JROF,JLEV) - (ZCHAT(JROF,JLEV) - RCPD)*&
         &ZTI(JROF,JLEV)*ZFPG(JROF,JLEV)
      ENDIF
      ZJTOT(JROF,JLEV) = ZJTOT(JROF,JLEV)+ZFHDPSFI(JROF,JLEV)
    ENDDO
  ENDDO
ELSE
  ZFHDPSFI(KSTART:KPROF,0:KFLEV)=0.
ENDIF


!CDIR UNROLL=8
DO JLEV = 1, KFLEV
  DO JROF = KSTART, KPROF

    ZGSDP(JROF,JLEV)=RG*YDMF_PHYS_STATE%YCPG_PHY%XYB%RDELP(JROF,JLEV)

    YDMF_PHYS%OUT%TENDU(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
     & (YDMF_PHYS%OUT%STRCU (JROF,JLEV-1) - YDMF_PHYS%OUT%STRCU (JROF,JLEV)) +&
     & (YDMF_PHYS%OUT%STRDU (JROF,JLEV-1) - YDMF_PHYS%OUT%STRDU (JROF,JLEV)) +&
     & (YDMF_PHYS%OUT%STRMU (JROF,JLEV-1) - YDMF_PHYS%OUT%STRMU (JROF,JLEV)) +&
     & (YDMF_PHYS%OUT%STRTU (JROF,JLEV-1) - YDMF_PHYS%OUT%STRTU (JROF,JLEV)) )

    YDMF_PHYS%OUT%TENDV(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
     & (YDMF_PHYS%OUT%STRCV (JROF,JLEV-1) - YDMF_PHYS%OUT%STRCV (JROF,JLEV)) +&
     & (YDMF_PHYS%OUT%STRDV (JROF,JLEV-1) - YDMF_PHYS%OUT%STRDV (JROF,JLEV)) +&
     & (YDMF_PHYS%OUT%STRMV (JROF,JLEV-1) - YDMF_PHYS%OUT%STRMV (JROF,JLEV)) +&
     & (YDMF_PHYS%OUT%STRTV (JROF,JLEV-1) - YDMF_PHYS%OUT%STRTV (JROF,JLEV)) )

    IF (LCVTDK) THEN
  !     PTENDU_ZDEC(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
  !      & (PSTRDU (JROF,JLEV-1) - PSTRDU (JROF,JLEV)) +&
  !      & (PSTRMU (JROF,JLEV-1) - PSTRMU (JROF,JLEV)) +&
  !      & (PSTRTU (JROF,JLEV-1) - PSTRTU (JROF,JLEV)) )
     
       PTENDU_ZDEC(JROF,JLEV) = 0.0_JPRB
   !    PTENDV_ZDEC(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
   !     & (PSTRDV (JROF,JLEV-1) - PSTRDV (JROF,JLEV)) +&
   !     & (PSTRMV (JROF,JLEV-1) - PSTRMV (JROF,JLEV)) +&
   !     & (PSTRTV (JROF,JLEV-1) - PSTRTV (JROF,JLEV)) )
   
       PTENDV_ZDEC(JROF,JLEV) = 0.0_JPRB
    ELSE    
       PTENDU_ZDEC(JROF,JLEV) = YDMF_PHYS%OUT%TENDU(JROF,JLEV) 
       PTENDV_ZDEC(JROF,JLEV) = YDMF_PHYS%OUT%TENDV(JROF,JLEV)  
    ENDIF
       
    PTENDQ(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
     & (YDMF_PHYS%OUT%DIFTQ (JROF,JLEV-1) - YDMF_PHYS%OUT%DIFTQ (JROF,JLEV)) +&
     & (YDMF_PHYS%OUT%DIFCQ (JROF,JLEV-1) - YDMF_PHYS%OUT%DIFCQ (JROF,JLEV)) +&
     & (PFRMQ  (JROF,JLEV-1) - PFRMQ (JROF,JLEV))  +&
     & (YDMF_PHYS%OUT%FCCQL (JROF,JLEV-1) - YDMF_PHYS%OUT%FCCQL (JROF,JLEV)) +&
     & (YDMF_PHYS%OUT%FCCQN (JROF,JLEV-1) - YDMF_PHYS%OUT%FCCQN (JROF,JLEV)) +&
     & (YDMF_PHYS%OUT%FCSQL (JROF,JLEV-1) - YDMF_PHYS%OUT%FCSQL (JROF,JLEV)) +&
     & (YDMF_PHYS%OUT%FCSQN (JROF,JLEV-1) - YDMF_PHYS%OUT%FCSQN (JROF,JLEV)) +&
     & (YDMF_PHYS%OUT%FCQNG (JROF,JLEV-1) - YDMF_PHYS%OUT%FCQNG (JROF,JLEV)) -&
     & (YDMF_PHYS%OUT%FPEVPCL  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPEVPCL  (JROF,JLEV)) -&
     & (YDMF_PHYS%OUT%FPEVPSL  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPEVPSL  (JROF,JLEV)) -&
     & (YDMF_PHYS%OUT%FPEVPCN  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPEVPCN  (JROF,JLEV)) -&
     & (YDMF_PHYS%OUT%FPEVPSN  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPEVPSN  (JROF,JLEV)))

    PTENDH(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
     &  ZJTOT  (JROF,JLEV-1) - ZJTOT  (JROF,JLEV))

  ENDDO
ENDDO

IF (LGRAPRO) THEN
!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQ(JROF,JLEV)=PTENDQ(JROF,JLEV) + ZGSDP(JROF,JLEV)*(-&
        & (YDMF_PHYS%OUT%FPEVPSG(JROF,JLEV-1) - YDMF_PHYS%OUT%FPEVPSG(JROF,JLEV)) - &
        & (YDMF_PHYS%OUT%FPEVPCG(JROF,JLEV-1) - YDMF_PHYS%OUT%FPEVPCG(JROF,JLEV)))
    ENDDO
  ENDDO
ENDIF

IF (LFLEXDIA) THEN
   IF (LDDH_OMP) THEN
     !-------------------------------------------------
    ! QV DDH budget.
    !-------------------------------------------------
    ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
    & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%Q(KSTART:KPROF,1:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQV',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%DIFTQ,'FQVTUR',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%DIFCQ,'FQVTURCONV',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FCCQL,'FQVCCQL',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FCCQN,'FQVCCQN',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FCSQL,'FQVCSQL',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FCSQN,'FQVCSQN',YDDDH)
    IF(LMUSCLFA) CALL WRSCMR(NMUSCLFA,'PFCQNG_CPTEND_NEW',YDMF_PHYS%OUT%FCQNG,KPROF,KFLEV+1)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FCQNG,'FQVCQNG',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPEVPCL(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQVECL',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPEVPSL(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQVESL',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPEVPCN(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQVECN',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPEVPSN(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQVESN',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPEVPSG(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQVESG',YDDDH)
    !-------------------------------------------------
    ! H (enthalpy) DDH budget.
    !-------------------------------------------------
    ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
    & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%YCPG_DYN%RCP%CP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%T(KSTART:KPROF,1:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VCT',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FRSO(:,:,1),'FCTRSO',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FRTH(:,:,1),'FCTRTH',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FRMH,'FCTRMH',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%DIFTS,'FCTDIFT',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%DIFCS,'FCTDIFC',YDDDH)
    ZFHSENS(KSTART:KPROF,0:KFLEV)=(RCW-RCPD)*ZFPL(KSTART:KPROF,0:KFLEV)*ZTI(KSTART:KPROF,0:KFLEV)+&
      & (RCS-RCPD)*ZFPN(KSTART:KPROF,0:KFLEV)*ZTI(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZFHSENS,'FCTSENSPREC',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-RLVZER*YDMF_PHYS%OUT%FCCQL(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTCCQL',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-RLVZER*YDMF_PHYS%OUT%FCSQL(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTCSQL',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=RLVZER*YDMF_PHYS%OUT%FPEVPSL(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTESL',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=RLVZER*YDMF_PHYS%OUT%FPEVPCL(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTECL',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-RLSZER*YDMF_PHYS%OUT%FCCQN(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTCCQN',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-RLSZER*YDMF_PHYS%OUT%FCSQN(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTCSQN',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=RLSZER*YDMF_PHYS%OUT%FPEVPSN(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTESN',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=RLSZER*YDMF_PHYS%OUT%FPEVPCN(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTECN',YDDDH)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=RLSZER*YDMF_PHYS%OUT%FPEVPSG(KSTART:KPROF,0:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCTESG',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZFHDPSFI,'FCTDPSFI',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZFHIMCC,'FCTIMCC',YDDDH)
   ELSE
    !-------------------------------------------------
    ! QV DDH budget.
    !-------------------------------------------------
    ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
    & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%Q(KSTART:KPROF,1:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQV','V','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%DIFTQ,'FQVTUR','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%DIFCQ,'FQVTURCONV','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FCCQL,'FQVCCQL','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FCCQN,'FQVCCQN','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FCSQL,'FQVCSQL','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FCSQN,'FQVCSQN','F','ARP',.TRUE.,.TRUE.)
    IF(LMUSCLFA) CALL WRSCMR(NMUSCLFA,'PFCQNG_CPTEND_NEW',YDMF_PHYS%OUT%FCQNG,KPROF,KFLEV+1)
    CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FCQNG,'FQVCQNG','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPEVPCL(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQVECL','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPEVPSL(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQVESL','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPEVPCN(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQVECN','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPEVPSN(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQVESN','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPEVPSG(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQVESG','F','ARP',.TRUE.,.TRUE.)
    !-------------------------------------------------
    ! H (enthalpy) DDH budget.
    !-------------------------------------------------
    ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
    & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%YCPG_DYN%RCP%CP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%T(KSTART:KPROF,1:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VCT','V','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FRSO(:,:,1),'FCTRSO','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FRTH(:,:,1),'FCTRTH','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FRMH,'FCTRMH','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%DIFTS,'FCTDIFT','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%DIFCS,'FCTDIFC','F','ARP',.TRUE.,.TRUE.)
    ZFHSENS(KSTART:KPROF,0:KFLEV)=(RCW-RCPD)*ZFPL(KSTART:KPROF,0:KFLEV)*ZTI(KSTART:KPROF,0:KFLEV)+&
      & (RCS-RCPD)*ZFPN(KSTART:KPROF,0:KFLEV)*ZTI(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZFHSENS,'FCTSENSPREC','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-RLVZER*YDMF_PHYS%OUT%FCCQL(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTCCQL','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-RLVZER*YDMF_PHYS%OUT%FCSQL(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTCSQL','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=RLVZER*YDMF_PHYS%OUT%FPEVPSL(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTESL','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=RLVZER*YDMF_PHYS%OUT%FPEVPCL(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTECL','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-RLSZER*YDMF_PHYS%OUT%FCCQN(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTCCQN','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-RLSZER*YDMF_PHYS%OUT%FCSQN(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTCSQN','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=RLSZER*YDMF_PHYS%OUT%FPEVPSN(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTESN','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=RLSZER*YDMF_PHYS%OUT%FPEVPCN(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTECN','F','ARP',.TRUE.,.TRUE.)
    ZTMPFLUX(KSTART:KPROF,0:KFLEV)=RLSZER*YDMF_PHYS%OUT%FPEVPSG(KSTART:KPROF,0:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCTESG','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZFHDPSFI,'FCTDPSFI','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZFHIMCC,'FCTIMCC','F','ARP',.TRUE.,.TRUE.)
  ENDIF
ENDIF


!  ------------------------------------------------------------
!   2. CALCUL DE L'EVOLUTION DE QL, QI, QR, QS, QG
!  ------------------------------------------------------------

! - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
! Pronostic equations for liquid/solid water/precipitation
! - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

IF (LCONDWT.AND..NOT.LGPCMT) THEN

  ! - - - - - - - - - - - - - - - - - -
  ! Usual equation for QL=suspended liquid water
  ! - - - - - - - - - - - - - - - - - -

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQL(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & (YDMF_PHYS%OUT%DIFTQL(JROF,JLEV-1) - YDMF_PHYS%OUT%DIFTQL(JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%DIFCQL(JROF,JLEV-1) - YDMF_PHYS%OUT%DIFCQL(JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%FCQLNG(JROF,JLEV-1) - YDMF_PHYS%OUT%FCQLNG(JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%FPFPCL  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPFPCL  (JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%FPFPSL  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPFPSL  (JROF,JLEV)) -&
       & (YDMF_PHYS%OUT%FCSQL (JROF,JLEV-1) - YDMF_PHYS%OUT%FCSQL (JROF,JLEV)) -&
       & (YDMF_PHYS%OUT%FCCQL (JROF,JLEV-1) - YDMF_PHYS%OUT%FCCQL (JROF,JLEV)))
    ENDDO
  ENDDO
  IF (LFLEXDIA) THEN
    !-------------------------------------------------
    ! QL DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%L(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%DIFTQL,'FQLDIFT',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%DIFCQL,'FQLDIFC',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FCQLNG,'FQLCQLNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPFPCL,'FQLACL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPFPSL,'FQLASL',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FCSQL(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQLCSQL',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FCCQL(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQLCCQL',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%L(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQL','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%DIFTQL,'FQLDIFT','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%DIFCQL,'FQLDIFC','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FCQLNG,'FQLCQLNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPFPCL,'FQLACL','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPFPSL,'FQLASL','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FCSQL(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQLCSQL','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FCCQL(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQLCCQL','F','ARP',.TRUE.,.TRUE.)
    ENDIF 
  ENDIF

  ! - - - - - - - - - - - - - - - - - -
  ! equation for QI=suspended ice water
  ! - - - - - - - - - - - - - - - - - -

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQI(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & (YDMF_PHYS%OUT%DIFTQN(JROF,JLEV-1) - YDMF_PHYS%OUT%DIFTQN(JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%DIFCQN(JROF,JLEV-1) - YDMF_PHYS%OUT%DIFCQN(JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%FCQNNG(JROF,JLEV-1) - YDMF_PHYS%OUT%FCQNNG(JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%FPFPCN  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPFPCN  (JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%FPFPSN  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPFPSN  (JROF,JLEV)) -&
       & (YDMF_PHYS%OUT%FCSQN (JROF,JLEV-1) - YDMF_PHYS%OUT%FCSQN (JROF,JLEV)) -&
       & (YDMF_PHYS%OUT%FCCQN (JROF,JLEV-1) - YDMF_PHYS%OUT%FCCQN (JROF,JLEV)))
    ENDDO
  ENDDO
  IF (LGRAPRO) THEN
    DO JLEV = 1, KFLEV
      DO JROF = KSTART, KPROF
        PTENDQI(JROF,JLEV) = PTENDQI(JROF,JLEV) +ZGSDP(JROF,JLEV)*&
         &(YDMF_PHYS%OUT%FPFPSG  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPFPSG  (JROF,JLEV))
      ENDDO
    ENDDO
  ENDIF
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QI DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%I(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQI',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%DIFTQN,'FQIDIFT',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%DIFCQN,'FQIDIFC',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FCQNNG,'FQICQING',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPFPCN,'FQIACN',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPFPSN,'FQIASN',YDDDH)
      IF (LGRAPRO) THEN
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPFPSG,'FQIASG',YDDDH)
      ENDIF
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FCSQN(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQICSQN',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FCCQN(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQICCQN',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%I(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQI','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%DIFTQN,'FQIDIFT','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%DIFCQN,'FQIDIFC','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FCQNNG,'FQICQING','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPFPCN,'FQIACN','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPFPSN,'FQIASN','F','ARP',.TRUE.,.TRUE.)
      IF (LGRAPRO) THEN
        CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPFPSG,'FQIASG','F','ARP',.TRUE.,.TRUE.)
      ENDIF
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FCSQN(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQICSQN','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FCCQN(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQICCQN','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF

  ! -----------------------------------
  ! Equation for QR=rain water
  ! -----------------------------------

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQR(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & (YDMF_PHYS%OUT%FPEVPSL  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPEVPSL  (JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%FPEVPCL  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPEVPCL  (JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%FCQRNG(JROF,JLEV-1) - YDMF_PHYS%OUT%FCQRNG(JROF,JLEV)) +&
       & (ZFPL   (JROF,JLEV-1) - ZFPL   (JROF,JLEV)) -&
       & (YDMF_PHYS%OUT%FPFPCL  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPFPCL  (JROF,JLEV)) -&
       & (YDMF_PHYS%OUT%FPFPSL  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPFPSL  (JROF,JLEV)))
    ENDDO
  ENDDO
  IF (LFLEXDIA) THEN
    !-------------------------------------------------
    ! QR DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%R(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQR',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPEVPSL,'FQRESL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPEVPCL,'FQRECL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FCQRNG,'FQRCQRNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZFPL,'FQRPL',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPFPCL(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQRACL',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPFPSL(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQRASL',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%R(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQR','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPEVPSL,'FQRESL','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPEVPCL,'FQRECL','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FCQRNG,'FQRCQRNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,ZFPL,'FQRPL','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPFPCL(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQRACL','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPFPSL(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQRASL','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF

  ! ---------------------------------
  ! Equation for QS=snow water
  ! --------------------------------

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQS(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & (YDMF_PHYS%OUT%FPEVPSN  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPEVPSN  (JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%FPEVPCN  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPEVPCN  (JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%FCQSNG(JROF,JLEV-1) - YDMF_PHYS%OUT%FCQSNG(JROF,JLEV)) +&
       & (ZFPN   (JROF,JLEV-1) - ZFPN   (JROF,JLEV)) -&
       & (YDMF_PHYS%OUT%FPFPCN  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPFPCN  (JROF,JLEV)) -&
       & (YDMF_PHYS%OUT%FPFPSN  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPFPSN  (JROF,JLEV)))
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QS DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%S(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQS',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPEVPSN,'FQSESN',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPEVPCN,'FQSECN',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FCQSNG,'FQSCQSNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZFPN,'FQSPN',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPFPCN(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQSACN',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPFPSN(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQSASN',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%S(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQS','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPEVPSN,'FQSESN','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPEVPCN,'FQSECN','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FCQSNG,'FQSCQSNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,ZFPN,'FQSPN','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPFPCN(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQSACN','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPFPSN(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQSASN','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF

  ! ---------------------------------
  ! Equation for QG=graupel
  ! --------------------------------
  IF (LGRAPRO) THEN
  !cdir unroll=8
    DO JLEV = 1, KFLEV
      DO JROF = KSTART, KPROF
        PTENDQG(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
         & (YDMF_PHYS%OUT%FPEVPSG  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPEVPSG  (JROF,JLEV)) +&
         & (YDMF_PHYS%OUT%FPEVPCG  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPEVPCG  (JROF,JLEV)) +&
         & (YDMF_PHYS%OUT%FCQGNG(JROF,JLEV-1) - YDMF_PHYS%OUT%FCQGNG(JROF,JLEV)) +&
         & (ZFPG   (JROF,JLEV-1) - ZFPG   (JROF,JLEV)) -&
         & (YDMF_PHYS%OUT%FPFPSG  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPFPSG  (JROF,JLEV)))
      ENDDO
    ENDDO
    IF(LFLEXDIA) THEN
      !-------------------------------------------------
      ! QG DDH budget.
      !-------------------------------------------------
      IF (LDDH_OMP) THEN
        ZTMPVAR(KSTART:KPROF,1:KFLEV)= &
        & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%G(KSTART:KPROF,1:KFLEV)
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQG',YDDDH)
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPEVPSG,'FQGESG',YDDDH)
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPEVPCG,'FQGECG',YDDDH)
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FCQGNG,'FQGCQGNG',YDDDH)
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZFPG,'FQGPG',YDDDH)
        ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPFPSG(KSTART:KPROF,0:KFLEV)
        CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQGASG',YDDDH)
      ELSE
        ZTMPVAR(KSTART:KPROF,1:KFLEV)= &
        & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%G(KSTART:KPROF,1:KFLEV)
        CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQG','V','ARP',.TRUE.,.TRUE.)
        CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPEVPSG,'FQGESG','F','ARP',.TRUE.,.TRUE.)
        CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPEVPCG,'FQGECG','F','ARP',.TRUE.,.TRUE.)
        CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FCQGNG,'FQGCQGNG','F','ARP',.TRUE.,.TRUE.)
        CALL ADD_FIELD_3D(YDLDDH,ZFPG,'FQGPG','F','ARP',.TRUE.,.TRUE.)
        ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPFPSG(KSTART:KPROF,0:KFLEV)
        CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQGASG','F','ARP',.TRUE.,.TRUE.)
      ENDIF
    ENDIF
  ENDIF


ELSEIF(LCONDWT.AND.LGPCMT) THEN

  ! - - - - - - - - - - - - - - - - - -
  ! PCMT convection scheme.
  ! - - - - - - - - - - - - - - - - - -

  ! - - - - - - - - - - - - - - - - - -
  ! Usual equation for QL=suspended liquid water
  ! - - - - - - - - - - - - - - - - - -

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQL(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & (YDMF_PHYS%OUT%DIFTQL(JROF,JLEV-1) - YDMF_PHYS%OUT%DIFTQL(JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%DIFCQL(JROF,JLEV-1) - YDMF_PHYS%OUT%DIFCQL(JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%FCQLNG(JROF,JLEV-1) - YDMF_PHYS%OUT%FCQLNG(JROF,JLEV)) -&
       & (YDMF_PHYS%OUT%FEDQLC(JROF,JLEV-1) - YDMF_PHYS%OUT%FEDQLC(JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%FPFPSL  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPFPSL  (JROF,JLEV)) -&
       & (YDMF_PHYS%OUT%FCSQL (JROF,JLEV-1) - YDMF_PHYS%OUT%FCSQL (JROF,JLEV)))
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QL DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%L(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%DIFTQL,'FQLDIFT',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%DIFCQL,'FQLDIFC',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FCQLNG,'FQLCQLNG',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FEDQLC(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQLEDCONV',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPFPSL,'FQLASL',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FCSQL(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQLCSQL',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%L(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQL','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%DIFTQL,'FQLDIFT','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%DIFCQL,'FQLDIFC','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FCQLNG,'FQLCQLNG','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FEDQLC(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQLEDCONV','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPFPSL,'FQLASL','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FCSQL(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQLCSQL','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF

  ! - - - - - - - - - - - - - - - - - -
  ! equation for QI=suspended ice water
  ! - - - - - - - - - - - - - - - - - -

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQI(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & (YDMF_PHYS%OUT%DIFTQN(JROF,JLEV-1) - YDMF_PHYS%OUT%DIFTQN(JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%DIFCQN(JROF,JLEV-1) - YDMF_PHYS%OUT%DIFCQN(JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%FCQNNG(JROF,JLEV-1) - YDMF_PHYS%OUT%FCQNNG(JROF,JLEV)) -&
       & (YDMF_PHYS%OUT%FEDQIC(JROF,JLEV-1) - YDMF_PHYS%OUT%FEDQIC(JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%FPFPSN  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPFPSN  (JROF,JLEV)) -&
       & (YDMF_PHYS%OUT%FCSQN (JROF,JLEV-1) - YDMF_PHYS%OUT%FCSQN (JROF,JLEV)))
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QI DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%I(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQI',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%DIFTQN,'FQIDIFT',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%DIFCQN,'FQIDIFC',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FCQNNG,'FQICQING',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FEDQIC(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQIEDCONV',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPFPSN,'FQIASN',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FCSQN(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQICSQN',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%I(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQI','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%DIFTQN,'FQIDIFT','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%DIFCQN,'FQIDIFC','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FCQNNG,'FQICQING','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FEDQIC(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQIEDCONV','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPFPSN,'FQIASN','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FCSQN(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQICSQN','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF

  ! -----------------------------------
  ! Equation for QR=rain water
  ! -----------------------------------

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQR(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & (YDMF_PHYS%OUT%FPEVPSL  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPEVPSL  (JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%FCQRNG(JROF,JLEV-1) - YDMF_PHYS%OUT%FCQRNG(JROF,JLEV)) -&
       & (YDMF_PHYS%OUT%FEDQRC(JROF,JLEV-1) - YDMF_PHYS%OUT%FEDQRC(JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%FPLSL (JROF,JLEV-1) - YDMF_PHYS%OUT%FPLSL (JROF,JLEV)) -&
       & (YDMF_PHYS%OUT%FPFPSL  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPFPSL  (JROF,JLEV)))
    ENDDO
  ENDDO
  IF (LFLEXDIA) THEN
    !-------------------------------------------------
    ! QR DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%R(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQR',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPEVPSL,'FQRESL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FCQRNG,'FQRCQRNG',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FEDQRC(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQREDCONV',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPLSL,'FQRPL',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPFPSL(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQRASL',YDDDH)
    ELSE   
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%R(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQR','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPEVPSL,'FQRESL','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FCQRNG,'FQRCQRNG','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FEDQRC(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQREDCONV','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPLSL,'FQRPL','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPFPSL(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQRASL','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF

  ! ---------------------------------
  ! Equation for QS=snow water
  ! --------------------------------

!cdir unroll=8
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQS(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & (YDMF_PHYS%OUT%FPEVPSN  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPEVPSN  (JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%FCQSNG(JROF,JLEV-1) - YDMF_PHYS%OUT%FCQSNG(JROF,JLEV)) -&
       & (YDMF_PHYS%OUT%FEDQSC(JROF,JLEV-1) - YDMF_PHYS%OUT%FEDQSC(JROF,JLEV)) +&
       & (YDMF_PHYS%OUT%FPLSN (JROF,JLEV-1) - YDMF_PHYS%OUT%FPLSN (JROF,JLEV)) -&
       & (YDMF_PHYS%OUT%FPFPSN  (JROF,JLEV-1) - YDMF_PHYS%OUT%FPFPSN  (JROF,JLEV)))
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QS DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%S(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VQS',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPEVPSN,'FQSESN',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FCQSNG,'FQSCQSNG',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FEDQSC(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQSEDCONV',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPLSN,'FQSPN',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPFPSN(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FQSASN',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%S(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VQS','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPEVPSN,'FQSESN','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FCQSNG,'FQSCQSNG','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FEDQSC(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQSEDCONV','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPLSN,'FQSPN','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPFPSN(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FQSASN','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF
  ! - - - - - - - - - - - - - - - - - -
  ! Equation for QLCONV=suspended liquid water (CONV. PART)
  ! - - - - - - - - - - - - - - - - - -
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQLCONV(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & +(YDMF_PHYS%OUT%FCNEGQLC(JROF,JLEV-1) - YDMF_PHYS%OUT%FCNEGQLC(JROF,JLEV))&
       & +(YDMF_PHYS%OUT%DIFCQLC(JROF,JLEV-1)  - YDMF_PHYS%OUT%DIFCQLC(JROF,JLEV))&
       & +(YDMF_PHYS%OUT%FEDQLC(JROF,JLEV-1)   - YDMF_PHYS%OUT%FEDQLC(JROF,JLEV))&
       & +(YDMF_PHYS%OUT%FIMCC(JROF,JLEV-1)    - YDMF_PHYS%OUT%FIMCC(JROF,JLEV))&
       & -(YDMF_PHYS%OUT%FCCQL (JROF,JLEV-1)   - YDMF_PHYS%OUT%FCCQL (JROF,JLEV))&
       & +(YDMF_PHYS%OUT%FPFPCL  (JROF,JLEV-1)   - YDMF_PHYS%OUT%FPFPCL  (JROF,JLEV))&
       & )
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QLCONV DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDVARS%LCONV%T0(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VCL',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FCNEGQLC,'FCLCQNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%DIFCQLC,'FCLDIFC',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FEDQLC,'FCLED',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FIMCC,'FCLIM',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FCCQL(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCLCOND',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPFPCL,'FCLAUTOCONV',YDDDH)
    ELSE 
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDVARS%LCONV%T0(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VCL','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FCNEGQLC,'FCLCQNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%DIFCQLC,'FCLDIFC','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FEDQLC,'FCLED','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FIMCC,'FCLIM','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FCCQL(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCLCOND','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPFPCL,'FCLAUTOCONV','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF
  ! - - - - - - - - - - - - - - - - - -
  ! Equation for QICONV=suspended ice water (CONV. PART)
  ! - - - - - - - - - - - - - - - - - -
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQICONV(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & +(YDMF_PHYS%OUT%FCNEGQIC(JROF,JLEV-1) - YDMF_PHYS%OUT%FCNEGQIC(JROF,JLEV))&
       & +(YDMF_PHYS%OUT%DIFCQIC(JROF,JLEV-1)  - YDMF_PHYS%OUT%DIFCQIC(JROF,JLEV))&
       & +(YDMF_PHYS%OUT%FEDQIC(JROF,JLEV-1)   - YDMF_PHYS%OUT%FEDQIC(JROF,JLEV))&
       & -(YDMF_PHYS%OUT%FIMCC(JROF,JLEV-1)    - YDMF_PHYS%OUT%FIMCC(JROF,JLEV))&
       & -(YDMF_PHYS%OUT%FCCQN (JROF,JLEV-1)   - YDMF_PHYS%OUT%FCCQN (JROF,JLEV))&
       & +(YDMF_PHYS%OUT%FPFPCN  (JROF,JLEV-1)   - YDMF_PHYS%OUT%FPFPCN  (JROF,JLEV))&
       & )
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QICONV DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDVARS%ICONV%T0(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VCI',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FCNEGQIC,'FCICQNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%DIFCQIC,'FCIDIFC',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FEDQIC,'FCIED',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FIMCC(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCIIM',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FCCQN(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCICOND',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPFPCN,'FCIAUTOCONV',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDVARS%ICONV%T0(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VCI','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FCNEGQIC,'FCICQNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%DIFCQIC,'FCIDIFC','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FEDQIC,'FCIED','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FIMCC(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCIIM','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FCCQN(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCICOND','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPFPCN,'FCIAUTOCONV','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF
  ! -----------------------------------
  ! Equation for QRCONV=rain (CONV. PART)
  ! -----------------------------------
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQRCONV(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & +(YDMF_PHYS%OUT%FCNEGQRC(JROF,JLEV-1) - YDMF_PHYS%OUT%FCNEGQRC(JROF,JLEV))&
       & +(YDMF_PHYS%OUT%FPLCL (JROF,JLEV-1)   - YDMF_PHYS%OUT%FPLCL (JROF,JLEV))&
       & +(YDMF_PHYS%OUT%FEDQRC(JROF,JLEV-1)   - YDMF_PHYS%OUT%FEDQRC(JROF,JLEV))&
       & -(YDMF_PHYS%OUT%FPFPCL  (JROF,JLEV-1)   - YDMF_PHYS%OUT%FPFPCL  (JROF,JLEV))&
       & +(YDMF_PHYS%OUT%FPEVPCL  (JROF,JLEV-1)   - YDMF_PHYS%OUT%FPEVPCL  (JROF,JLEV))&
       & )
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QRCONV DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDVARS%RCONV%T0(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VCR',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FCNEGQRC,'FCRCQNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPLCL,'FCRSEDIM',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FEDQRC,'FCRED',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPFPCL(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCRAUTOCONV',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPEVPCL,'FCREVAPO',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDVARS%RCONV%T0(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VCR','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FCNEGQRC,'FCRCQNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPLCL,'FCRSEDIM','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FEDQRC,'FCRED','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPFPCL(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCRAUTOCONV','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPEVPCL,'FCREVAPO','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF
  ! ---------------------------------
  ! Equation for QSCONV=snow (CONV. PART)
  ! --------------------------------
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDQSCONV(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & +(YDMF_PHYS%OUT%FCNEGQSC(JROF,JLEV-1) - YDMF_PHYS%OUT%FCNEGQSC(JROF,JLEV))&
       & +(YDMF_PHYS%OUT%FPLCN (JROF,JLEV-1)   - YDMF_PHYS%OUT%FPLCN (JROF,JLEV))&
       & +(YDMF_PHYS%OUT%FEDQSC(JROF,JLEV-1)   - YDMF_PHYS%OUT%FEDQSC(JROF,JLEV))&
       & -(YDMF_PHYS%OUT%FPFPCN  (JROF,JLEV-1)   - YDMF_PHYS%OUT%FPFPCN  (JROF,JLEV))&
       & +(YDMF_PHYS%OUT%FPEVPCN  (JROF,JLEV-1)   - YDMF_PHYS%OUT%FPEVPCN  (JROF,JLEV))&
       & )
    ENDDO
  ENDDO
  IF(LFLEXDIA) THEN
    !-------------------------------------------------
    ! QSCONV DDH budget.
    !-------------------------------------------------
    IF (LDDH_OMP) THEN
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDVARS%SCONV%T0(KSTART:KPROF,1:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VCS',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FCNEGQSC,'FCSCQNG',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPLCN,'FCSSEDIM',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FEDQSC,'FCSED',YDDDH)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPFPCN(KSTART:KPROF,0:KFLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPFLUX,'FCSAUTOCONV',YDDDH)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS%OUT%FPEVPCN,'FCSEVAPO',YDDDH)
    ELSE
      ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDVARS%SCONV%T0(KSTART:KPROF,1:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VCS','V','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FCNEGQSC,'FCSCQNG','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPLCN,'FCSSEDIM','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FEDQSC,'FCSED','F','ARP',.TRUE.,.TRUE.)
      ZTMPFLUX(KSTART:KPROF,0:KFLEV)=-YDMF_PHYS%OUT%FPFPCN(KSTART:KPROF,0:KFLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPFLUX,'FCSAUTOCONV','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_3D(YDLDDH,YDMF_PHYS%OUT%FPEVPCN,'FCSEVAPO','F','ARP',.TRUE.,.TRUE.)
    ENDIF
  ENDIF
ENDIF

!     For DDH, could be used in next loop for PTENDQ, PTENDQI,PTENDQL
IF (LFLEXDIA) THEN
  IF (LLDPSFI) THEN
    DO JLEV = 0, KFLEV
      DO JROF = KSTART, KPROF
        YDMF_PHYS%OUT%FCMPCQ(JROF,JLEV) = ZQH(JROF,JLEV)*ZLIFT(JROF,JLEV)
        IF (LCONDWT) THEN
           YDMF_PHYS%OUT%FCMPSN(JROF,JLEV) = ZQIH(JROF,JLEV)*ZLIFT(JROF,JLEV)
           YDMF_PHYS%OUT%FCMPSL(JROF,JLEV) = ZQLH(JROF,JLEV)*ZLIFT(JROF,JLEV)
         ENDIF
      ENDDO
    ENDDO
  ELSE
    DO JLEV = 0, KFLEV
      DO JROF = KSTART, KPROF
        YDMF_PHYS%OUT%FCMPCQ(JROF,JLEV) =  0.0_JPRB
        IF (LCONDWT) THEN
           YDMF_PHYS%OUT%FCMPSN(JROF,JLEV) =  0.0_JPRB
           YDMF_PHYS%OUT%FCMPSL(JROF,JLEV) =  0.0_JPRB
         ENDIF
      ENDDO
    ENDDO
  ENDIF
ENDIF

IF (LLDPSFI) THEN
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
       PTENDQ(JROF,JLEV) = PTENDQ(JROF,JLEV)-ZGSDP(JROF,JLEV)*&
         & (ZQH(JROF,JLEV-1)*ZLIFT(JROF,JLEV-1)-&
         & ZQH(JROF,JLEV)*ZLIFT(JROF,JLEV))
       IF (LCONDWT) THEN
         PTENDQI(JROF,JLEV) = PTENDQI(JROF,JLEV)-ZGSDP(JROF,JLEV)*&
           & (ZQIH(JROF,JLEV-1)*ZLIFT(JROF,JLEV-1)-&
           & ZQIH(JROF,JLEV)*ZLIFT(JROF,JLEV))
         PTENDQL(JROF,JLEV) = PTENDQL(JROF,JLEV)-ZGSDP(JROF,JLEV)*&
           & (ZQLH(JROF,JLEV-1)*ZLIFT(JROF,JLEV-1)-&
           & ZQLH(JROF,JLEV)*ZLIFT(JROF,JLEV))
       ENDIF
    ENDDO
  ENDDO
ENDIF

!  ------------------------------------------------------------
!   3. CALCUL DE L'EVOLUTION DE TKE
!  ------------------------------------------------------------

IF (LECT) THEN
  IF (JPRD == JPRB) THEN
    DO JLEV = 1, KFLEV
      DO JROF = KSTART, KPROF
        PTENDTKE(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
         & PFTKE (JROF,JLEV-1) - PFTKE (JROF,JLEV))
      ENDDO
    ENDDO
  ELSE
! This appears to be a more precise calculation of the TKE tendency
! but is not compatible with the interface of cptend_new and needs
! to be reviewed
    DO JLEV = 1, KFLEV
      DO JROF = KSTART, KPROF
        PTENDTKE(JROF,JLEV) = PFTKEI (JROF, JLEV)
      ENDDO
    ENDDO
  ENDIF
ENDIF

!  ------------------------------------------------------------
!   3.1 CALCUL DE L'EVOLUTION DE EFB1, EFB2 and EFB3
!  ------------------------------------------------------------

IF (LEFB) THEN
  DO JLEV = 1, KFLEV
    DO JROF = KSTART, KPROF
      PTENDEFB1(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & PFEFB1 (JROF,JLEV-1) - PFEFB1 (JROF,JLEV))
      PTENDEFB2(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & PFEFB2 (JROF,JLEV-1) - PFEFB2 (JROF,JLEV))
      PTENDEFB3(JROF,JLEV) = ZGSDP(JROF,JLEV)*(&
       & PFEFB3 (JROF,JLEV-1) - PFEFB3 (JROF,JLEV))
    ENDDO
  ENDDO
ENDIF

!  ------------------------------------------------------------
!   ?. CALCUL DE L'EVOLUTION DES SCALAIRES PASSIFS
!  ------------------------------------------------------------

IF(LMDUST.AND.(NGFL_EXT/=0)) THEN
  DO JGFL = 1, NGFL_EXT
    DO JLEV = 1, KFLEV
      DO JROF = KSTART, KPROF
        PTENDEXT(JROF,JLEV,JGFL) = ZGSDP(JROF,JLEV)*(&
          & PDIFEXT(JROF,JLEV-1,JGFL) - PDIFEXT(JROF,JLEV,JGFL))
      ENDDO
    ENDDO
  ENDDO
ENDIF
!

!  ------------------------------------------------------------
!   4. CALCUL DE L'EVOLUTION DE P ET W (CAS NH)
!  ------------------------------------------------------------

! TO DO

!--------------------------------------------------------------------------

IF(LFLEXDIA) THEN

  !-------------------------------------------------
  ! U AND V DDH Budget.
  !-------------------------------------------------

  DO JLEV = 0, KFLEV
    DO JROF=KSTART,KPROF
      ZSTTUG(JROF,JLEV) = PGNORDM(JROF)*YDMF_PHYS%OUT%STRTU(JROF,JLEV)-&
      & PGNORDL(JROF)*YDMF_PHYS%OUT%STRTV(JROF,JLEV)
      ZSTTVG(JROF,JLEV) = PGNORDL(JROF)*YDMF_PHYS%OUT%STRTU(JROF,JLEV)+&
      & PGNORDM(JROF)*YDMF_PHYS%OUT%STRTV(JROF,JLEV)
      ZSTCUG(JROF,JLEV) = PGNORDM(JROF)*YDMF_PHYS%OUT%STRCU(JROF,JLEV)-&
      & PGNORDL(JROF)*YDMF_PHYS%OUT%STRCV(JROF,JLEV)
      ZSTCVG(JROF,JLEV) = PGNORDL(JROF)*YDMF_PHYS%OUT%STRCU(JROF,JLEV)+&
      & PGNORDM(JROF)*YDMF_PHYS%OUT%STRCV(JROF,JLEV)
      ZSTDUG(JROF,JLEV) = PGNORDM(JROF)*YDMF_PHYS%OUT%STRDU(JROF,JLEV)-&
      & PGNORDL(JROF)*YDMF_PHYS%OUT%STRDV(JROF,JLEV)
      ZSTDVG(JROF,JLEV) = PGNORDL(JROF)*YDMF_PHYS%OUT%STRDU(JROF,JLEV)+&
      & PGNORDM(JROF)*YDMF_PHYS%OUT%STRDV(JROF,JLEV)
    ENDDO
  ENDDO

  DO JLEV = 1, KFLEV
    DO JROF=KSTART,KPROF
      ZUZGEO(JROF,JLEV)=PGNORDM(JROF)*YDMF_PHYS_STATE%U(JROF,JLEV)-PGNORDL(JROF)*YDMF_PHYS_STATE%V(JROF,JLEV)
      ZVMGEO(JROF,JLEV)=PGNORDL(JROF)*YDMF_PHYS_STATE%U(JROF,JLEV)+PGNORDM(JROF)*YDMF_PHYS_STATE%V(JROF,JLEV)
    ENDDO
  ENDDO

  IF (LDDH_OMP) THEN
     ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
    & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%U(KSTART:KPROF,1:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VUU',YDDDH)
    ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
    & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%V(KSTART:KPROF,1:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VVV',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZSTTUG,'FUUTUR',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZSTTVG,'FVVTUR',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZSTCUG,'FUUTURCONV',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZSTCVG,'FVVTURCONV',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZSTDUG,'FUUONDEGREL',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZSTDVG,'FVVONDEGREL',YDDDH)
  ELSE
    ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
    & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%U(KSTART:KPROF,1:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VUU','V','ARP',.TRUE.,.TRUE.)
    ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
    & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*YDMF_PHYS_STATE%V(KSTART:KPROF,1:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VVV','V','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZSTTUG,'FUUTUR','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZSTTVG,'FVVTUR','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZSTCUG,'FUUTURCONV','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZSTCVG,'FVVTURCONV','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZSTDUG,'FUUONDEGREL','F','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZSTDVG,'FVVONDEGREL','F','ARP',.TRUE.,.TRUE.)
  ENDIF

  !-------------------------------------------------
  ! Kinetic Energy DDH budget.
  !-------------------------------------------------

  DO JLEV=1,KFLEV
    DO JROF=KSTART,KPROF
!     VKK
      ZKENE(JROF,JLEV)  = 0.5_JPRB*&
      & (YDMF_PHYS_STATE%U(JROF,JLEV)**2+YDMF_PHYS_STATE%V(JROF,JLEV)**2)
!     TKKDISSIPTUR
      ZTNDKKT(JROF,JLEV) = -( ZUZGEO(JROF,JLEV)*&
       & (ZSTTUG(JROF,JLEV)-ZSTTUG(JROF,JLEV-1)) + ZVMGEO(JROF,JLEV)&
       & *(ZSTTVG(JROF,JLEV)-ZSTTVG(JROF,JLEV-1)) )
!     TKKDISSIPCONV
      ZTNDKKC(JROF,JLEV) = -( ZUZGEO(JROF,JLEV)*&
       & (ZSTCUG(JROF,JLEV)-ZSTCUG(JROF,JLEV-1)) + ZVMGEO(JROF,JLEV)&
       & *(ZSTCVG(JROF,JLEV)-ZSTCVG(JROF,JLEV-1)) )
!     TKKDISSIPGREL
      ZTNDKKD(JROF,JLEV) = -( ZUZGEO(JROF,JLEV)*&
       & (ZSTDUG(JROF,JLEV)-ZSTDUG(JROF,JLEV-1)) + ZVMGEO(JROF,JLEV)&
       & *(ZSTDVG(JROF,JLEV)-ZSTDVG(JROF,JLEV-1)) )
    ENDDO
  ENDDO

  IF(LDDH_OMP) THEN
    ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*ZKENE(KSTART:KPROF,1:KFLEV)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPVAR,'VKK',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTNDKKT,'TKKDISSTUR',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTNDKKC,'TKKDISSCONV',YDDDH)
    CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTNDKKD,'TKKDISSGREL',YDDDH)
  ELSE
    ZTMPVAR(KSTART:KPROF,1:KFLEV)=&
      & YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(KSTART:KPROF,1:KFLEV)*ZKENE(KSTART:KPROF,1:KFLEV)
    CALL ADD_FIELD_3D(YDLDDH,ZTMPVAR,'VKK','V','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZTNDKKT,'TKKDISSTUR','T','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZTNDKKC,'TKKDISSCONV','T','ARP',.TRUE.,.TRUE.)
    CALL ADD_FIELD_3D(YDLDDH,ZTNDKKD,'TKKDISSGREL','T','ARP',.TRUE.,.TRUE.)
  ENDIF

ENDIF
IF(LMUSCLFA) THEN

  !-------------------------------------------------
  ! Single column model MUSC diagnostics.
  ! Q1 and Q2.
  !-------------------------------------------------

  DO JLEV=1,KFLEV
    DO JROF=KSTART,KPROF
      ZQ1(JROF,JLEV)=(PTENDH(JROF,JLEV)-(RCPV-RCPD)*PTENDQ(JROF,JLEV)*YDMF_PHYS_STATE%T(JROF,JLEV))/YDMF_PHYS_STATE%YCPG_DYN%RCP%CP(JROF,JLEV)
      ZQ2(JROF,JLEV)=-FOLH(YDMF_PHYS_STATE%T(JROF,JLEV),MAX(0._JPRB,SIGN(1._JPRB,RTT-YDMF_PHYS_STATE%T(JROF,JLEV))))&
        & *PTENDQ(JROF,JLEV)/YDMF_PHYS_STATE%YCPG_DYN%RCP%CP(JROF,JLEV)
    ENDDO
  ENDDO
  CALL WRSCMR(NMUSCLFA,'Q1',ZQ1,KPROF,KFLEV)
  CALL WRSCMR(NMUSCLFA,'Q2',ZQ2,KPROF,KFLEV)

ENDIF

!-----------------------------------------------------------------------
END ASSOCIATE
END ASSOCIATE
IF (LHOOK) CALL DR_HOOK('CPTEND_NEW',1,ZHOOK_HANDLE)
END SUBROUTINE CPTEND_NEW

