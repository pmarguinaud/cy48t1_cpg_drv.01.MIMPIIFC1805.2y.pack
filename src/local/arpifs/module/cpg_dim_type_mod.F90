MODULE CPG_DIM_TYPE_MOD

USE PARKIND1, ONLY : JPIM, JPRB
USE GEOMETRY_MOD, ONLY : GEOMETRY
USE YOMCT3, ONLY : NSTEP

IMPLICIT NONE

TYPE CPG_DIM_TYPE
  INTEGER(KIND=JPIM) :: KIDIA 
  INTEGER(KIND=JPIM) :: KFDIA 
  INTEGER(KIND=JPIM) :: KBL 
  INTEGER(KIND=JPIM) :: KLON 
  INTEGER(KIND=JPIM) :: KFLEVG 
  INTEGER(KIND=JPIM) :: KSTGLO 
  INTEGER(KIND=JPIM) :: KGPTOT 
  INTEGER(KIND=JPIM) :: KGPCOMP 
  INTEGER(KIND=JPIM) :: KFDIE 
  INTEGER(KIND=JPIM) :: KIDIE
  INTEGER(KIND=JPIM) :: KGL1
  INTEGER(KIND=JPIM) :: KGL2
  INTEGER(KIND=JPIM) :: KSTEP
  INTEGER(KIND=JPIM) :: KTDIA
  INTEGER(KIND=JPIM) :: ILEVT1I
  INTEGER(KIND=JPIM) :: ILEVT1F
  INTEGER(KIND=JPIM) :: KVCLIS
  INTEGER(KIND=JPIM) :: KDTPREC
  INTEGER(KIND=JPIM) :: KDTPREC2
  INTEGER(KIND=JPIM) :: KSBDLEV
  INTEGER(KIND=JPIM) :: KTSSG
  INTEGER(KIND=JPIM) :: KGRADIENTS
  INTEGER(KIND=JPIM) :: KMAXDRAFT
  INTEGER(KIND=JPIM) :: KSW
  

CONTAINS
  PROCEDURE :: INIT => CPG_DIM_TYPE_INIT
  PROCEDURE :: UPDATE => CPG_DIM_TYPE_UPDATE
END TYPE CPG_DIM_TYPE

CONTAINS

  SUBROUTINE CPG_DIM_TYPE_INIT(SELF, YDGEOMETRY, YDMODEL, YDFIELDS)
    USE TYPE_MODEL, ONLY : MODEL
    USE FIELDS_MOD, ONLY : FIELDS
    USE YOMCT0, ONLY : LSLAG, LTWOTL
    CLASS(CPG_DIM_TYPE) :: SELF
    TYPE(MODEL)   , INTENT(IN) :: YDMODEL
    TYPE(GEOMETRY), INTENT(IN) :: YDGEOMETRY
    TYPE(FIELDS),   INTENT(IN) :: YDFIELDS

    SELF%KBL          =  1
    SELF%KLON         =  YDGEOMETRY%YRDIM%NPROMA
    SELF%KIDIA        =  1
    SELF%KIDIE        =  1
    SELF%KFDIA        =  YDGEOMETRY%YRDIM%NPROMA
    SELF%KFDIE        =  YDGEOMETRY%YRDIM%NPROMA
    SELF%KFLEVG       =  YDGEOMETRY%YRDIMV%NFLEVG
    SELF%KGPTOT       =  YDGEOMETRY%YRGEM%NGPTOT
    SELF%KGPCOMP      =  YDGEOMETRY%YRGEM%NGPTOT_CAP
    SELF%KSTEP        =  NSTEP
    SELF%KGL1         =  YDGEOMETRY%YRDIM%NDGENL
    SELF%KTDIA        =  1
    SELF%KVCLIS       =  YDMODEL%YRML_PHY_G%YRDPHY%NVCLIS
    SELF%KDTPREC      =  YDMODEL%YRML_PHY_MF%YRPHY%YRDPRECIPS%NDTPREC
    SELF%KDTPREC2     =  YDMODEL%YRML_PHY_MF%YRPHY%YRDPRECIPS%NDTPREC2
    SELF%KSBDLEV      =  YDFIELDS%YRSURF%YSP_SBD%NLEVS
    SELF%KTSSG        =  YDMODEL%YRML_PHY_G%YRDPHY%NTSSG
    SELF%KGRADIENTS   =  YDMODEL%YRML_PHY_MF%YRARPHY%NGRADIENTS

    IF (YDMODEL%YRML_PHY_MF%YRARPHY%LMFSHAL .AND. YDMODEL%YRML_PHY_MF%YRPARAR%CMF_UPDRAFT=='DUAL') THEN
      SELF%KMAXDRAFT=3
    ELSE
      SELF%KMAXDRAFT=0
    ENDIF


    IF (LSLAG) THEN
      SELF%ILEVT1I = 0
      SELF%ILEVT1F = YDGEOMETRY%YRDIMV%NFLEVG + 1
    ELSE
      SELF%ILEVT1I = 1
      SELF%ILEVT1F = YDGEOMETRY%YRDIMV%NFLEVG 
    ENDIF

    IF (YDMODEL%YRML_PHY_MF%YRPHY%LRAY) THEN
      SELF%KSW = 1
    ELSE
      SELF%KSW = YDMODEL%YRML_PHY_RAD%YRERAD%NSW
    ENDIF

  END SUBROUTINE CPG_DIM_TYPE_INIT

  SUBROUTINE CPG_DIM_TYPE_UPDATE(SELF, IBL)
    CLASS(CPG_DIM_TYPE) :: SELF
    INTEGER(KIND=JPIM), INTENT(IN) :: IBL

    SELF%KBL    = IBL
    SELF%KSTGLO = 1 + (IBL - 1) * SELF%KLON
    SELF%KFDIA  = MIN (SELF%KLON, SELF%KGPCOMP - SELF%KSTGLO + 1)
    SELF%KFDIE  = MIN (SELF%KLON, SELF%KGPTOT  - SELF%KSTGLO + 1)

  END SUBROUTINE CPG_DIM_TYPE_UPDATE

END MODULE CPG_DIM_TYPE_MOD
