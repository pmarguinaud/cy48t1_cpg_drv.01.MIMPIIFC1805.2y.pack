MODULE CPG_DYN_TYPE_MOD

USE FIELD_MODULE
USE FIELD_REGISTRY_MOD
USE PARKIND1, ONLY : JPRB, JPIM

IMPLICIT NONE

TYPE CPG_DYN_TYPE

  REAL (KIND=JPRB), POINTER, CONTIGUOUS :: PHI (:, :) => NULL ()
  TYPE (FIELD_3D), POINTER :: F_PHI => NULL ()
  REAL (KIND=JPRB), POINTER, CONTIGUOUS :: PRE (:, :) => NULL ()
  TYPE (FIELD_3D), POINTER :: F_PRE => NULL ()
  REAL (KIND=JPRB), POINTER, CONTIGUOUS :: PHIF (:, :) => NULL ()
  TYPE (FIELD_3D), POINTER :: F_PHIF => NULL ()
  REAL (KIND=JPRB), POINTER, CONTIGUOUS :: RCP (:, :, :) => NULL ()
  TYPE (FIELD_4D), POINTER :: F_RCP => NULL ()
  REAL (KIND=JPRB), POINTER, CONTIGUOUS :: PREF (:, :) => NULL ()
  TYPE (FIELD_3D), POINTER :: F_PREF => NULL ()
  REAL (KIND=JPRB), POINTER, CONTIGUOUS :: CTY (:, :, :) => NULL ()
  TYPE (FIELD_4D), POINTER :: F_CTY => NULL ()
  REAL (KIND=JPRB), POINTER, CONTIGUOUS :: WRL (:, :) => NULL ()
  TYPE (FIELD_3D), POINTER :: F_WRL => NULL ()

CONTAINS
  PROCEDURE :: INIT => CPG_DYN_TYPE_INIT
  PROCEDURE :: UPDATE_VIEW => CPG_DYN_TYPE_UPDATE_VIEW
  PROCEDURE :: FINAL => CPG_DYN_TYPE_FINAL
END TYPE

CONTAINS




SUBROUTINE CPG_DYN_TYPE_INIT (SELF, REGISTRY, NLEV, PERSISTENT &
                           &, PHIF &
                           &, PRCP &
                           &, PREF &
                           &, PCTY &
                           &, PWRL &
                           &)

USE INTDYN_MOD, ONLY : YYTCTY0, YYTRCP0

CLASS (CPG_DYN_TYPE)                  :: SELF
TYPE (FIELD_REGISTRY), INTENT (INOUT) :: REGISTRY
INTEGER (KIND=JPIM),   INTENT (IN)    :: NLEV
LOGICAL, OPTIONAL,     INTENT (IN)    :: PERSISTENT
REAL(KIND=JPRB),       INTENT (IN), OPTIONAL, TARGET  :: PHIF(:, :, :)
REAL(KIND=JPRB),       INTENT (IN), OPTIONAL, TARGET  :: PRCP(:, :, :, :)
REAL(KIND=JPRB),       INTENT (IN), OPTIONAL, TARGET  :: PREF(:, :, :)
REAL(KIND=JPRB),       INTENT (IN), OPTIONAL, TARGET  :: PCTY(:, :, :, :)
REAL(KIND=JPRB),       INTENT (IN), OPTIONAL, TARGET  :: PWRL(:, :, :)

SELF%F_PHI => CREATE_TEMPORARY ("PHI", GEOM=REGISTRY%GEOM, NLEV=NLEV+1, PERSISTENT=PERSISTENT)

SELF%F_PRE => CREATE_TEMPORARY ("PRE", GEOM=REGISTRY%GEOM, NLEV=NLEV+1, PERSISTENT=PERSISTENT)

IF (PRESENT (PHIF)) THEN
  SELF%F_PHIF => CREATE_FIELD_WRAP ('PHIF', PHIF)
ELSE
  SELF%F_PHIF => CREATE_TEMPORARY ("PHIF", GEOM=REGISTRY%GEOM, NLEV=NLEV, PERSISTENT=PERSISTENT)
ENDIF

IF (PRESENT (PRCP)) THEN
  SELF%F_RCP => CREATE_FIELD_WRAP ('RCP', PRCP)
ELSE
  SELF%F_RCP => CREATE_TEMPORARY ("RCP", GEOM=REGISTRY%GEOM, NLEV=NLEV, NDIM=YYTRCP0%NDIM, PERSISTENT=PERSISTENT)
ENDIF

IF (PRESENT (PREF)) THEN
  SELF%F_PREF => CREATE_FIELD_WRAP ('PREF', PREF)
ELSE
  SELF%F_PREF => CREATE_TEMPORARY ("PREF", GEOM=REGISTRY%GEOM, NLEV=NLEV, PERSISTENT=PERSISTENT)
ENDIF

IF (PRESENT (PCTY)) THEN
  SELF%F_CTY => CREATE_FIELD_WRAP ('CTY', PCTY)
ENDIF

IF (PRESENT (PWRL)) THEN
  SELF%F_WRL => CREATE_FIELD_WRAP ('WRL', PWRL)
ENDIF


END SUBROUTINE


SUBROUTINE CPG_DYN_TYPE_UPDATE_VIEW (SELF, BLOCK_INDEX)

CLASS (CPG_DYN_TYPE)              :: SELF
INTEGER(KIND=JPIM), INTENT (IN)   :: BLOCK_INDEX

IF (ASSOCIATED (SELF%F_PHI)) SELF%PHI (1:,0:) => SELF%F_PHI%GET_VIEW (BLOCK_INDEX)
IF (ASSOCIATED (SELF%F_PRE)) SELF%PRE (1:,0:) => SELF%F_PRE%GET_VIEW (BLOCK_INDEX)
IF (ASSOCIATED (SELF%F_PHIF)) SELF%PHIF  => SELF%F_PHIF%GET_VIEW (BLOCK_INDEX)
IF (ASSOCIATED (SELF%F_RCP)) SELF%RCP  => SELF%F_RCP%GET_VIEW (BLOCK_INDEX)
IF (ASSOCIATED (SELF%F_PREF)) SELF%PREF  => SELF%F_PREF%GET_VIEW (BLOCK_INDEX)
IF (ASSOCIATED (SELF%F_CTY)) SELF%CTY (1:,0:, 1:) => SELF%F_CTY%GET_VIEW (BLOCK_INDEX)
IF (ASSOCIATED (SELF%F_WRL)) SELF%WRL  => SELF%F_WRL%GET_VIEW (BLOCK_INDEX)

END SUBROUTINE

SUBROUTINE CPG_DYN_TYPE_FINAL (SELF)
CLASS (CPG_DYN_TYPE)              :: SELF

IF (ASSOCIATED (SELF%F_PHIF)) CALL DELETE_TEMPORARY (SELF%F_PHI) 
IF (ASSOCIATED (SELF%F_PHIF)) CALL DELETE_TEMPORARY (SELF%F_PRE) 
IF (ASSOCIATED (SELF%F_PHIF)) CALL DELETE_TEMPORARY (SELF%F_PHIF) 
IF (ASSOCIATED (SELF%F_PHIF)) CALL DELETE_TEMPORARY (SELF%F_RCP) 
IF (ASSOCIATED (SELF%F_PHIF)) CALL DELETE_TEMPORARY (SELF%F_PREF) 
IF (ASSOCIATED (SELF%F_PHIF)) CALL DELETE_TEMPORARY (SELF%F_CTY) 
IF (ASSOCIATED (SELF%F_PHIF)) CALL DELETE_TEMPORARY (SELF%F_WRL) 

END SUBROUTINE 

END MODULE CPG_DYN_TYPE_MOD

