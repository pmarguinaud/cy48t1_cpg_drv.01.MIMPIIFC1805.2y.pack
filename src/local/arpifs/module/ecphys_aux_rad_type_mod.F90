MODULE ECPHYS_AUX_RAD_TYPE_MOD
USE PARKIND1, ONLY : JPIM, JPRB
USE FIELD_MODULE, ONLY: FIELD_2D, FIELD_3D, FIELD_4D
USE FIELD_REGISTRY_MOD, ONLY: FIELD_REGISTRY, CREATE_TEMPORARY, DELETE_TEMPORARY
USE FIELD_VARIABLES_MOD, ONLY: FIELD_VARIABLES

IMPLICIT NONE

TYPE AUX_RAD_TYPE
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PNEB     ! FRACTIONAL CLOUDINESS FOR RADIATION.
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PQICE    ! (KLON,KLEV) SPECIFIC HUMIDITY OF SOLID WATER FOR RADIATION.
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PQLI     ! (KLON,KLEV) SPECIFIC HUMIDITY OF LIQUID WATER FOR RADIATION
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PEMTD    ! (KLON,0:KLEV) Net longwave flux
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PTRSW    ! (KLON,0:KLEV) SW transmissivity (scale by incoming SW for flux)
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PEMTC    ! (KLON,0:KLEV)  Clear-sky net longwave flux
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PTRSC    ! (KLON,0:KLEV)  Clear-sky shortwave transmissivity
  REAL(KIND=JPRB), DIMENSION(:,:,:), POINTER, CONTIGUOUS :: PTAUAER! (KLON,KLEV,6)  OPTICAL THICKNESS FOR 6 AEROSOL TYPES
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PSRLWD   ! (KLON,NLWOUT)  Surface downward longwave flux in emissivity spectral intervals
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PSRLWDC    ! (KLON)  SURFACE DOWNWARD CLEAR-SKY LONGWAVE 
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PSRSWD     ! (KLON)  SURFACE SHORTWAVE DOWNWARDS
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PSRSWDC    ! (KLON)  SURFACE DOWNWARD CLEAR-SKY SHORTWAVE
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PSRSWDCS   ! (KLON)  SURFACE NET SHORTWAVE CLEAR-SKY
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PEDRO      ! (KLON)  STORED SKIN (BRIGHTNESS) TEMPERATURE FROM LAST RAD. STEP
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PSRSWPAR   ! (KLON) downward SW PAR radiation at the surface
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PSRSWUVB   ! (KLON) downward UV-B radiation at the surface
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PSRSWPARC  ! (KLON) downward clear-sky SW PAR radiation at the surface
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PSRSWTINC  ! (KLON) TOA incident solar radiation
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PSRFDIR    ! (KLON)  total sky direct downward SW radiation
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PSRCDIR    ! (KLON)  clear-sky direct downward SW radiation
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PTINCF     ! TOA INCIDENT SOLAR RADIATION
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PFDIR, PCDIR   ! TOTAL (clear-SKY) DIRECT SW RADIATION AT SURFACE
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PDSRP      ! TOTAL DIRECT SW RADIATION AT SURFACE ON PLANE PERPENDICULAR
                                                       ! TO SUN DIRECTION (DIRECT BEAM)
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PISUND     ! SUNSHINE DURATION (FRACTION OF TIME STEP)
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PINCSR,PINCSR0 ! INCIDENT AND ANUAL INCIDENT SOLAR RADIATION
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PHRSW,PHRLW,PHRSC,PHRLC ! SW/LW all-sky/clear-sky heating rates
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: DERIVATIVELW ! (KLON,0:KLEV) Derivative to update LW radiation each timestep

  ! Storage fields to provide thread-local views
  TYPE(FIELD_2D), POINTER :: F_PSRLWDC, F_PSRSWD, F_PSRSWDC, F_PSRSWDCS, F_PEDRO, F_PSRSWPAR, F_PSRSWUVB, &
   & F_PSRSWPARC, F_PSRSWTINC, F_PSRFDIR, F_PSRCDIR, F_PTINCF, F_PFDIR, F_PCDIR, F_PDSRP, F_PISUND, F_PINCSR, F_PINCSR0
  TYPE(FIELD_3D), POINTER :: F_PSRLWD, F_PNEB, F_PQICE, F_PQLI, F_PEMTD, F_PTRSW, F_PEMTC, F_PTRSC, F_PHRSW, F_PHRLW, &
   & F_PHRSC, F_PHRLC, F_DERIVATIVELW
  TYPE(FIELD_4D), POINTER :: F_PTAUAER

CONTAINS
  PROCEDURE :: INIT => AUX_RAD_TYPE_INIT
  PROCEDURE :: UPDATE_VIEW => AUX_RAD_TYPE_UPDATE_VIEW
  PROCEDURE :: FINAL => AUX_RAD_TYPE_FINAL
END TYPE AUX_RAD_TYPE

CONTAINS

  SUBROUTINE AUX_RAD_TYPE_INIT(SELF, REGISTRY, VARIABLES, NLEV, PERSISTENT)
    CLASS(AUX_RAD_TYPE) :: SELF
    TYPE(FIELD_REGISTRY), INTENT(INOUT) :: REGISTRY
    TYPE(FIELD_VARIABLES), INTENT(INOUT) :: VARIABLES
    INTEGER(KIND=JPIM), INTENT(IN) :: NLEV
    LOGICAL, OPTIONAL, INTENT(IN) :: PERSISTENT

    SELF%F_PEMTD     => VARIABLES%RADIATION%EMTD%FT0
    SELF%F_PTRSW     => VARIABLES%RADIATION%TRSW%FT0
    SELF%F_PEMTC     => VARIABLES%RADIATION%EMTC%FT0
    SELF%F_PTRSC     => VARIABLES%RADIATION%TRSC%FT0
    SELF%F_PTAUAER   => VARIABLES%RADIATION%TAUAER%FT0
    SELF%F_PSRLWD    => VARIABLES%RADIATION%SRLWD%FT0
    SELF%F_PSRLWDC   => VARIABLES%RADIATION%SRLWDC%FT0
    SELF%F_PSRSWD    => VARIABLES%RADIATION%SRSWD %FT0
    SELF%F_PSRSWDC   => VARIABLES%RADIATION%SRSWDC%FT0
    SELF%F_PSRSWDCS  => VARIABLES%RADIATION%SRSWDCS%FT0
    SELF%F_PEDRO     => VARIABLES%RADIATION%EDRO%FT0
    SELF%F_PSRSWPAR  => VARIABLES%RADIATION%SRSWPAR%FT0
    SELF%F_PSRSWUVB  => VARIABLES%RADIATION%SRSWUVB%FT0
    SELF%F_PSRSWPARC => VARIABLES%RADIATION%SRSWPARC%FT0
    SELF%F_PSRSWTINC => VARIABLES%RADIATION%SRSWTINC%FT0
    SELF%F_PSRFDIR   => VARIABLES%RADIATION%SRFDIR%FT0
    SELF%F_PSRCDIR   => VARIABLES%RADIATION%SRCDIR%FT0
    SELF%F_DERIVATIVELW => VARIABLES%RADIATION%DERIVATIVELW%FT0
    SELF%F_PTINCF  => CREATE_TEMPORARY(GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PDSRP   => CREATE_TEMPORARY(GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PFDIR   => CREATE_TEMPORARY(GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PCDIR   => CREATE_TEMPORARY(GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PISUND  => CREATE_TEMPORARY(GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PINCSR  => CREATE_TEMPORARY(GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PINCSR0 => CREATE_TEMPORARY(GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PNEB    => CREATE_TEMPORARY(GEOM=REGISTRY%GEOM, NLEV=NLEV, PERSISTENT=PERSISTENT)
    SELF%F_PQICE   => CREATE_TEMPORARY(GEOM=REGISTRY%GEOM, NLEV=NLEV, PERSISTENT=PERSISTENT)
    SELF%F_PQLI    => CREATE_TEMPORARY(GEOM=REGISTRY%GEOM, NLEV=NLEV, PERSISTENT=PERSISTENT)
    SELF%F_PHRSW   => CREATE_TEMPORARY(GEOM=REGISTRY%GEOM, NLEV=NLEV, PERSISTENT=PERSISTENT)
    SELF%F_PHRLW   => CREATE_TEMPORARY(GEOM=REGISTRY%GEOM, NLEV=NLEV, PERSISTENT=PERSISTENT)
    SELF%F_PHRSC   => CREATE_TEMPORARY(GEOM=REGISTRY%GEOM, NLEV=NLEV, PERSISTENT=PERSISTENT)
    SELF%F_PHRLC   => CREATE_TEMPORARY(GEOM=REGISTRY%GEOM, NLEV=NLEV, PERSISTENT=PERSISTENT)
  END SUBROUTINE AUX_RAD_TYPE_INIT

  SUBROUTINE AUX_RAD_TYPE_UPDATE_VIEW(SELF, BLOCK_INDEX)
    ! Extract local array views from field objects
    CLASS(AUX_RAD_TYPE) :: SELF
    INTEGER(KIND=JPIM), INTENT(IN) :: BLOCK_INDEX

    SELF%PEMTD     => SELF%F_PEMTD%GET_VIEW(BLOCK_INDEX)
    SELF%PTRSW     => SELF%F_PTRSW%GET_VIEW(BLOCK_INDEX)
    SELF%PEMTC     => SELF%F_PEMTC%GET_VIEW(BLOCK_INDEX)
    SELF%PTRSC     => SELF%F_PTRSC%GET_VIEW(BLOCK_INDEX)
    SELF%PTAUAER   => SELF%F_PTAUAER%GET_VIEW(BLOCK_INDEX)
    SELF%PSRLWD    => SELF%F_PSRLWD%GET_VIEW(BLOCK_INDEX)
    SELF%PSRLWDC   => SELF%F_PSRLWDC%GET_VIEW(BLOCK_INDEX)
    SELF%PSRSWD    => SELF%F_PSRSWD %GET_VIEW(BLOCK_INDEX)
    SELF%PSRSWDC   => SELF%F_PSRSWDC%GET_VIEW(BLOCK_INDEX)
    SELF%PSRSWDCS  => SELF%F_PSRSWDCS%GET_VIEW(BLOCK_INDEX)
    SELF%PEDRO     => SELF%F_PEDRO%GET_VIEW(BLOCK_INDEX)
    SELF%PSRSWPAR  => SELF%F_PSRSWPAR%GET_VIEW(BLOCK_INDEX)
    SELF%PSRSWUVB  => SELF%F_PSRSWUVB%GET_VIEW(BLOCK_INDEX)
    SELF%PSRSWPARC => SELF%F_PSRSWPARC%GET_VIEW(BLOCK_INDEX)
    SELF%PSRSWTINC => SELF%F_PSRSWTINC%GET_VIEW(BLOCK_INDEX)
    SELF%PSRFDIR   => SELF%F_PSRFDIR%GET_VIEW(BLOCK_INDEX)
    SELF%PSRCDIR   => SELF%F_PSRCDIR%GET_VIEW(BLOCK_INDEX)
    SELF%DERIVATIVELW => SELF%F_DERIVATIVELW%GET_VIEW(BLOCK_INDEX)
    SELF%PTINCF  => SELF%F_PTINCF%GET_VIEW(BLOCK_INDEX)
    SELF%PDSRP   => SELF%F_PDSRP%GET_VIEW(BLOCK_INDEX)
    SELF%PFDIR   => SELF%F_PFDIR%GET_VIEW(BLOCK_INDEX)
    SELF%PCDIR   => SELF%F_PCDIR%GET_VIEW(BLOCK_INDEX)
    SELF%PISUND  => SELF%F_PISUND%GET_VIEW(BLOCK_INDEX)
    SELF%PINCSR  => SELF%F_PINCSR%GET_VIEW(BLOCK_INDEX)
    SELF%PINCSR0 => SELF%F_PINCSR0%GET_VIEW(BLOCK_INDEX)
    SELF%PNEB    => SELF%F_PNEB%GET_VIEW(BLOCK_INDEX)
    SELF%PQICE   => SELF%F_PQICE%GET_VIEW(BLOCK_INDEX)
    SELF%PQLI    => SELF%F_PQLI%GET_VIEW(BLOCK_INDEX)
    SELF%PHRSW   => SELF%F_PHRSW%GET_VIEW(BLOCK_INDEX)
    SELF%PHRLW   => SELF%F_PHRLW%GET_VIEW(BLOCK_INDEX)
    SELF%PHRSC   => SELF%F_PHRSC%GET_VIEW(BLOCK_INDEX)
    SELF%PHRLC   => SELF%F_PHRLC%GET_VIEW(BLOCK_INDEX)
  END SUBROUTINE AUX_RAD_TYPE_UPDATE_VIEW

  SUBROUTINE AUX_RAD_TYPE_FINAL(SELF)
    CLASS(AUX_RAD_TYPE) :: SELF

    CALL DELETE_TEMPORARY(SELF%F_PTINCF)
    CALL DELETE_TEMPORARY(SELF%F_PDSRP)
    CALL DELETE_TEMPORARY(SELF%F_PFDIR)
    CALL DELETE_TEMPORARY(SELF%F_PCDIR)
    CALL DELETE_TEMPORARY(SELF%F_PISUND)
    CALL DELETE_TEMPORARY(SELF%F_PINCSR)
    CALL DELETE_TEMPORARY(SELF%F_PINCSR0)
    CALL DELETE_TEMPORARY(SELF%F_PNEB)
    CALL DELETE_TEMPORARY(SELF%F_PQICE)
    CALL DELETE_TEMPORARY(SELF%F_PQLI)
    CALL DELETE_TEMPORARY(SELF%F_PHRSW)
    CALL DELETE_TEMPORARY(SELF%F_PHRLW)
    CALL DELETE_TEMPORARY(SELF%F_PHRSC)
    CALL DELETE_TEMPORARY(SELF%F_PHRLC)
  END SUBROUTINE AUX_RAD_TYPE_FINAL

END MODULE ECPHYS_AUX_RAD_TYPE_MOD
