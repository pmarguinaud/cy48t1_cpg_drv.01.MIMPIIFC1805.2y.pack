
MODULE ECPHYS_SURFACE_TYPE_MOD

USE PARKIND1, ONLY : JPIM, JPRB
USE FIELD_MODULE, ONLY: FIELD_2D, FIELD_3D, FIELD_4D, FIELD_INT2D
USE FIELD_REGISTRY_MOD, ONLY: FIELD_REGISTRY, CREATE_TEMPORARY, CREATE_TEMPORARY_INT2D, DELETE_TEMPORARY
USE FIELD_VARIABLES_MOD, ONLY: FIELD_VARIABLES
USE ECPHYS_DIMENSION_TYPE_MOD, ONLY: DIMENSION_TYPE
USE SURFACE_FIELDS_MIX, ONLY: TSURF
USE SURFACE_VARIABLES_MOD, ONLY: SURFACE_VARIABLES
! FIXME: CMake dependency analysis breaks down if we do this:
! USE SURFACE_VIEWS_MODULE, ONLY:  SURFACE_VIEW_GROUP_SOILB, SURFACE_VIEW_GROUP_SNOWG, SURFACE_VIEW_GROUP_LAKEB, SURFACE_VIEW_GROUP_RESVR, SURFACE_VIEW_GROUP_CLS, SURFACE_VIEW_GROUP_OML, SURFACE_VIEW_GROUP_EXTRP, SURFACE_VIEW_GROUP_XTRP2, SURFACE_VIEW_GROUP_CANRI, SURFACE_VIEW_GROUP_VARSF, SURFACE_VIEW_GROUP_VCLIH, SURFACE_VIEW_GROUP_VCLIK, SURFACE_VIEW_GROUP_VCLIP, SURFACE_VIEW_GROUP_VCLIV, SURFACE_VIEW_GROUP_VCLIA, SURFACE_VIEW_GROUP_VCLIN, SURFACE_VIEW_GROUP_VDIAGO2, SURFACE_VIEW_GROUP_VDIAGO3, SURFACE_VIEW_GROUP_VDIAG, SURFACE_VIEW_GROUP_SATSIM, SURFACE_VIEW_GROUP_WAVES, SURFACE_VIEW_GROUP_WAM, SURFACE_VIEW_GROUP_VEXTRA, SURFACE_VIEW_GROUP_VEXTRDI, SURFACE_VIEW_GROUP_VPRECIP, SURFACE_VIEW_GROUP_VPRECIP2, SURFACE_VIEW_GROUP_VEXTR2, SURFACE_VIEW_GROUP_SFORC, SURFACE_VIEW_GROUP_SFLUX, SURFACE_VIEW_GROUP_VO3ABC
USE SURFACE_VIEWS_MODULE
USE YOMDYN, ONLY : TDYN
USE YOMCTESSELDIM, ONLY: IKVTYPES, IKDHVVEGS, IKDHFVEGS

IMPLICIT NONE

TYPE SURF_AND_MORE_TYPE
  ! --------------------------------------
  ! ----  Surface field group views  -----
  TYPE(SURFACE_VIEW_GROUP_SOILB) :: GSP_SB
  TYPE(SURFACE_VIEW_GROUP_SNOWG) :: GSP_SG
  TYPE(SURFACE_VIEW_GROUP_LAKEB) :: GSP_SL
  TYPE(SURFACE_VIEW_GROUP_RESVR) :: GSP_RR
  TYPE(SURFACE_VIEW_GROUP_CLS) :: GSP_CL
  TYPE(SURFACE_VIEW_GROUP_OML) :: GSP_OM
  TYPE(SURFACE_VIEW_GROUP_EXTRP) :: GSP_EP
  TYPE(SURFACE_VIEW_GROUP_XTRP2) :: GSP_X2
  TYPE(SURFACE_VIEW_GROUP_CANRI) :: GSP_CI
  TYPE(SURFACE_VIEW_GROUP_VARSF) :: GSD_VF
  TYPE(SURFACE_VIEW_GROUP_VCLIH) :: GSD_VH
  TYPE(SURFACE_VIEW_GROUP_VCLIK) :: GSD_VK
  TYPE(SURFACE_VIEW_GROUP_VCLIP) :: GSD_VP
  TYPE(SURFACE_VIEW_GROUP_VCLIV) :: GSD_VV
  TYPE(SURFACE_VIEW_GROUP_VCLIA) :: GSD_VA
  TYPE(SURFACE_VIEW_GROUP_VCLIN) :: GSD_VN
  TYPE(SURFACE_VIEW_GROUP_VDIAGO2) :: GSD_V2
  TYPE(SURFACE_VIEW_GROUP_VDIAGO3) :: GSD_V3
  TYPE(SURFACE_VIEW_GROUP_VDIAG) :: GSD_VD
  TYPE(SURFACE_VIEW_GROUP_SATSIM) :: GSD_SM
  TYPE(SURFACE_VIEW_GROUP_WAVES) :: GSD_WS
  TYPE(SURFACE_VIEW_GROUP_WAM) :: GSD_WW
  TYPE(SURFACE_VIEW_GROUP_VEXTRA) :: GSD_XA
  TYPE(SURFACE_VIEW_GROUP_VEXTRDI) :: GSD_DI
  TYPE(SURFACE_VIEW_GROUP_VPRECIP) :: GSD_XP
  TYPE(SURFACE_VIEW_GROUP_VPRECIP2) :: GSD_XP2
  TYPE(SURFACE_VIEW_GROUP_VEXTR2) :: GSD_X2
  TYPE(SURFACE_VIEW_GROUP_SFORC) :: GSD_SFO
  TYPE(SURFACE_VIEW_GROUP_SFLUX) :: GSD_SFL
  TYPE(SURFACE_VIEW_GROUP_VO3ABC) :: GSD_VC

  ! ------------------------------
  ! ----  Local array views  -----
  REAL(KIND=JPRB), DIMENSION(:,:,:), POINTER, CONTIGUOUS :: PEXTRD 
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PCOVPTOT => NULL()  !Precip fraction
  ! T star tiles
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PUSTRTI  ! E-W (INSTANTANEOUS) SURFACE STRESS FOR EACH TILE
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PVSTRTI  ! N-S (INSTANTANEOUS) SURFACE STRESS FOR EACH TILE
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PAHFSTI  ! (INSTANTANEOUS) SURFACE SENSIBLE HEAT FLUX FOR EACH TILE
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PEVAPTI  ! (INSTANTANEOUS) EVAPORATION FOR EACH TILE
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PTSKTI   ! SKIN TEMPERATURE FOR EACH TILE
  ! other 
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS ::  PEMIS      ! MODEL SURFACE LONGWAVE EMISSIVITY.
  ! GPP/REC flux adjustment coefficients
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PCGPP, PCREC ! to store bias correction coefficients
  !  Tendencies from surface scheme
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PSNSE1   ! OF MULTI-LAYER SNOW MASS PER UNIT SURFACE
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PRSNE1   ! OF MULTI-LAYER SNOW DENSITY
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PTSNE1   ! OF MULTI-LAYER SNOW TEMPERATURE
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PWSNE1   ! OF MULTI-LAYER SNOW LIQUID WATER MASS PER UNIT SURFACE
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PASNE1   ! OF SNOW ALBEDO : only the top layer is used
  REAL(KIND=JPRB), DIMENSION(:),   POINTER, CONTIGUOUS :: PWLE1    ! OF SKIN RESERVOIR WATER CONTENT
  REAL(KIND=JPRB), DIMENSION(:),   POINTER, CONTIGUOUS :: PTLE1    ! OF SKIN TEMPERATURE
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PTSAE1   ! OF MULTI-LAYER SOIL TEMPERATURE
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PWSAE1   ! OF MULTI-LAYER SOIL WETNESS
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PTIAE1   ! OF MULTI-LAYER SEA ICE TEMPERATURE
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PUOE1    ! VELOCITY TENDENCY OF OCEAN MIXED LAYER MODEL M/S**2
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PVOE1    ! VELOCITY TENDENCY OF OCEAN MIXED LAYER MODEL M/S**2
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PTOE1    ! TEMPERATURE TENDENCY OF OCEAN MIXED LAYER MODEL  K/S
  REAL(KIND=JPRB), DIMENSION(:,:), POINTER, CONTIGUOUS :: PSOE1    ! SALINITY TENDENCY OF OCEAN MIXED LAYER MODEL  psu/S
  REAL(KIND=JPRB), DIMENSION(:),   POINTER, CONTIGUOUS :: PHSTD    ! STANDARD DEVIATION OF SUBGRID OROGRAPHY
  INTEGER(KIND=JPIM), DIMENSION(:), POINTER, CONTIGUOUS :: ITVH, ITVL, ISOTY ! to store vegetation indices and soil type index
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PCVL, PCVH       ! to store vegetation covers
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PLAIL, PLAIH     ! to store variable LAI
  REAL(KIND=JPRB), DIMENSION(:), POINTER, CONTIGUOUS :: PEVAPMU    ! potential evaporation
  REAL(KIND=JPRB), DIMENSION(:),  POINTER, CONTIGUOUS  :: PTLICEE1       ! tendency of lake ice temperature
  REAL(KIND=JPRB), DIMENSION(:),  POINTER, CONTIGUOUS  :: PTLMNWE1       ! tendency of lake totat layer temperature
  REAL(KIND=JPRB), DIMENSION(:),  POINTER, CONTIGUOUS  :: PTLWMLE1       ! tendency of lake mixed layer temperature
  REAL(KIND=JPRB), DIMENSION(:),  POINTER, CONTIGUOUS  :: PTLBOTE1       ! tendency of lake bottom layer temperature
  REAL(KIND=JPRB), DIMENSION(:),  POINTER, CONTIGUOUS  :: PTLSFE1        ! tendency of lake shape factor - 
  REAL(KIND=JPRB), DIMENSION(:),  POINTER, CONTIGUOUS  :: PHLICEE1       ! tendency of lake ice depth m
  REAL(KIND=JPRB), DIMENSION(:),  POINTER, CONTIGUOUS  :: PHLMLE1        ! tendency of lake mixed layer depth m/s

  TYPE(FIELD_2D), POINTER :: F_PEMIS, F_PCGPP, F_PCREC, F_PWLE1, F_PTLE1, F_PHSTD, F_PCVL, F_PCVH, F_PLAIL, &
   & F_PLAIH, F_PEVAPMU, F_PTLICEE1, F_PTLMNWE1, F_PTLWMLE1, F_PTLBOTE1, F_PTLSFE1, F_PHLICEE1, F_PHLMLE1
  TYPE(FIELD_3D), POINTER :: F_PCOVPTOT, F_PUSTRTI, F_PVSTRTI, F_PAHFSTI, F_PEVAPTI, F_PTSKTI, F_PSNSE1, F_PRSNE1, &
   & F_PTSNE1, F_PWSNE1, F_PASNE1, F_PTSAE1, F_PWSAE1, F_PTIAE1, F_PUOE1, F_PVOE1, F_PTOE1, F_PSOE1
  TYPE(FIELD_INT2D), POINTER :: F_ITVH, F_ITVL, F_ISOTY

CONTAINS
  PROCEDURE :: INIT => SURF_AND_MORE_TYPE_INIT
  PROCEDURE :: UPDATE_VIEW => SURF_AND_MORE_TYPE_UPDATE_VIEW
  PROCEDURE :: SET9TO0 => SURF_AND_MORE_TYPE_SET9TO0
  PROCEDURE :: SET1TO9 => SURF_AND_MORE_TYPE_SET1TO9
  PROCEDURE :: SET1TO0 => SURF_AND_MORE_TYPE_SET1TO0
  PROCEDURE :: SET0TO1 => SURF_AND_MORE_TYPE_SET0TO1
  PROCEDURE :: PHTFILT => SURF_AND_MORE_TYPE_PHTFILT
  PROCEDURE :: FINAL => SURF_AND_MORE_TYPE_FINAL
END TYPE SURF_AND_MORE_TYPE


TYPE SURF_AND_MORE_LOCAL_TYPE
   REAL(KIND=JPRB), DIMENSION(:),    POINTER, CONTIGUOUS  :: ZLAILI, ZLAIHI   ! Arrays for interactive LAI (CITESSEL option)
   REAL(KIND=JPRB), DIMENSION(:),    POINTER, CONTIGUOUS  :: ZWLM1M
   REAL(KIND=JPRB), DIMENSION(:,:),  POINTER, CONTIGUOUS  :: ZSNM1M, ZRSNM1M ! KLON,KLEVSN
   REAL(KIND=JPRB), DIMENSION(:),    POINTER, CONTIGUOUS  :: ZHSDFOR
   REAL(KIND=JPRB), DIMENSION(:),    POINTER, CONTIGUOUS  :: ZPCLAKE           ! lake fraction
   REAL(KIND=JPRB), DIMENSION(:),    POINTER, CONTIGUOUS  :: ZTHKICE, ZSNTICE  ! sea ice
   REAL(KIND=JPRB), DIMENSION(:),    POINTER, CONTIGUOUS  :: PCGPP, PCREC ! to store flux adjustment coefficients
   REAL(KIND=JPRB), DIMENSION(:),    POINTER, CONTIGUOUS  :: ZWLMX
   REAL(KIND=JPRB), DIMENSION(:),    POINTER, CONTIGUOUS  :: ZEMIR ! Surface emissivity outside the IR atmospheric window
   REAL(KIND=JPRB), DIMENSION(:),    POINTER, CONTIGUOUS  :: ZEMIW ! Surface emissivity inside  the IR atmospheric window
   ! Longwave surface spectral emissivity in two or more bands,
   ! dimensioned (KLON,NLWEMISS); note that ZEMIR and ZEMIW point to
   ! the first two columns of this matrix:
   REAL(KIND=JPRB), DIMENSION(:,:),  POINTER, CONTIGUOUS  :: ZSPECTRALEMISS
   REAL(KIND=JPRB), DIMENSION(:),    POINTER, CONTIGUOUS  :: ZEVAPSNW
   REAL(KIND=JPRB), DIMENSION(:,:),  POINTER, CONTIGUOUS  :: ZFRTI,ZALBTI ! KLON,KTILES
   REAL(KIND=JPRB), DIMENSION(:,:),  POINTER, CONTIGUOUS  :: ZFRSOTI
   REAL(KIND=JPRB), DIMENSION(:,:),  POINTER, CONTIGUOUS  :: ZAHFTRTI
   REAL(KIND=JPRB), DIMENSION(:,:),  POINTER, CONTIGUOUS  :: ZALBD,ZALBP ! KLON,NTSW
   !  CTESSEL: Carbon model
   REAL(KIND=JPRB), DIMENSION(:,:),  POINTER, CONTIGUOUS  :: ZANDAYVT, ZANFMVT
   REAL(KIND=JPRB), DIMENSION(:,:,:),POINTER, CONTIGUOUS  :: ZDHVEGS

  ! Storage fields to provide thread-local views
  TYPE(FIELD_2D), POINTER :: F_ZLAILI, F_ZLAIHI, F_ZWLM1M, F_ZHSDFOR, F_ZPCLAKE, F_ZTHKICE, F_ZSNTICE, F_PCGPP, F_PCREC, &
   & F_ZWLMX, F_ZEVAPSNW
  TYPE(FIELD_3D), POINTER :: F_ZSNM1M, F_ZRSNM1M, F_ZSPECTRALEMISS, F_ZFRTI, F_ZALBTI, F_ZFRSOTI, F_ZAHFTRTI, F_ZALBD, &
   & F_ZALBP, F_ZANDAYVT, F_ZANFMVT
  TYPE(FIELD_4D), POINTER :: F_ZDHVEGS

CONTAINS
  PROCEDURE :: INIT => SURF_AND_MORE_LOCAL_TYPE_INIT
  PROCEDURE :: UPDATE_VIEW => SURF_AND_MORE_LOCAL_TYPE_UPDATE_VIEW
  PROCEDURE :: FINAL => SURF_AND_MORE_LOCAL_TYPE_FINAL
END TYPE SURF_AND_MORE_LOCAL_TYPE


TYPE DDH_SURF_TYPE
  REAL(KIND=JPRB), DIMENSION(:,:,:), POINTER, CONTIGUOUS :: PDHTLS      ! Diagnostic array for tiles (see module yomcdh)
  REAL(KIND=JPRB), DIMENSION(:,:,:), POINTER, CONTIGUOUS :: PDHTSS      ! Diagnostic array for snow T (see module yomcdh)
  REAL(KIND=JPRB), DIMENSION(:,:,:), POINTER, CONTIGUOUS :: PDHTTS      ! Diagnostic array for soil T (see module yomcdh)
  REAL(KIND=JPRB), DIMENSION(:,:,:), POINTER, CONTIGUOUS :: PDHTIS      ! Diagnostic array for ice T (see module yomcdh)
  REAL(KIND=JPRB), DIMENSION(:,:,:), POINTER, CONTIGUOUS :: PDHSSS      ! Diagnostic array for snow mass (see module yomcdh)
  REAL(KIND=JPRB), DIMENSION(:,:),   POINTER, CONTIGUOUS :: PDHIIS      ! Diagnostic array for interception layer (see module yomcdh)
  REAL(KIND=JPRB), DIMENSION(:,:,:), POINTER, CONTIGUOUS :: PDHWLS      ! Diagnostic array for soil water (see module yomcdh)
  REAL(KIND=JPRB), DIMENSION(:,:),   POINTER, CONTIGUOUS :: PDHFSS

  ! Storage fields to provide thread-local views
  TYPE(FIELD_3D), POINTER :: F_PDHFSS, F_PDHIIS
  TYPE(FIELD_4D), POINTER :: F_PDHTLS, F_PDHTSS, F_PDHTTS, F_PDHTIS, F_PDHSSS, F_PDHWLS

CONTAINS
  PROCEDURE :: INIT => DDH_SURF_TYPE_INIT
  PROCEDURE :: UPDATE_VIEW => DDH_SURF_TYPE_UPDATE_VIEW
  PROCEDURE :: FINAL => DDH_SURF_TYPE_FINAL
END TYPE DDH_SURF_TYPE


CONTAINS

  SUBROUTINE SURF_AND_MORE_TYPE_INIT(SELF, REGISTRY, VARIABLES, SURFVARS, NLEVS, NLEVSN, NLEVO, PERSISTENT)
    ! Constructor of the array view type for a surface variable group
    CLASS(SURF_AND_MORE_TYPE) :: SELF
    TYPE(FIELD_REGISTRY), INTENT(INOUT) :: REGISTRY
    TYPE(FIELD_VARIABLES), INTENT(INOUT) :: VARIABLES
    TYPE(SURFACE_VARIABLES), TARGET, INTENT(INOUT) :: SURFVARS
    INTEGER(KIND=JPIM), INTENT(IN) :: NLEVS, NLEVSN, NLEVO
    LOGICAL, OPTIONAL, INTENT(IN) :: PERSISTENT

    CALL SELF%GSP_SB%INIT(SURFVARS%GSP_SB)
    CALL SELF%GSP_SG%INIT(SURFVARS%GSP_SG)
    CALL SELF%GSP_SL%INIT(SURFVARS%GSP_SL)
    CALL SELF%GSP_RR%INIT(SURFVARS%GSP_RR)
    CALL SELF%GSP_CL%INIT(SURFVARS%GSP_CL)
    CALL SELF%GSP_OM%INIT(SURFVARS%GSP_OM)
    CALL SELF%GSP_EP%INIT(SURFVARS%GSP_EP)
    CALL SELF%GSP_X2%INIT(SURFVARS%GSP_X2)
    CALL SELF%GSP_CI%INIT(SURFVARS%GSP_CI)
    CALL SELF%GSD_VF%INIT(SURFVARS%GSD_VF)
    CALL SELF%GSD_VH%INIT(SURFVARS%GSD_VH)
    CALL SELF%GSD_VK%INIT(SURFVARS%GSD_VK)
    CALL SELF%GSD_VP%INIT(SURFVARS%GSD_VP)
    CALL SELF%GSD_VV%INIT(SURFVARS%GSD_VV)
    CALL SELF%GSD_VA%INIT(SURFVARS%GSD_VA)
    CALL SELF%GSD_VN%INIT(SURFVARS%GSD_VN)
    CALL SELF%GSD_V2%INIT(SURFVARS%GSD_V2)
    CALL SELF%GSD_V3%INIT(SURFVARS%GSD_V3)
    CALL SELF%GSD_VD%INIT(SURFVARS%GSD_VD)
    CALL SELF%GSD_SM%INIT(SURFVARS%GSD_SM)
    CALL SELF%GSD_WS%INIT(SURFVARS%GSD_WS)
    CALL SELF%GSD_WW%INIT(SURFVARS%GSD_WW)
    CALL SELF%GSD_XA%INIT(SURFVARS%GSD_XA)
    CALL SELF%GSD_DI%INIT(SURFVARS%GSD_DI)
    CALL SELF%GSD_XP%INIT(SURFVARS%GSD_XP)
    CALL SELF%GSD_XP2%INIT(SURFVARS%GSD_XP2)
    CALL SELF%GSD_X2%INIT(SURFVARS%GSD_X2)
    CALL SELF%GSD_SFO%INIT(SURFVARS%GSD_SFO)
    CALL SELF%GSD_SFL%INIT(SURFVARS%GSD_SFL)
    CALL SELF%GSD_VC%INIT(SURFVARS%GSD_VC)

    ! Get references to state fields or create temporaries for local views
    SELF%F_PUSTRTI => VARIABLES%ECPHYS%USTRTI%FT0
    SELF%F_PVSTRTI => VARIABLES%ECPHYS%VSTRTI%FT0
    SELF%F_PAHFSTI => VARIABLES%ECPHYS%AHFSTI%FT0
    SELF%F_PEVAPTI => VARIABLES%ECPHYS%EVAPTI%FT0
    SELF%F_PTSKTI  => VARIABLES%ECPHYS%TSKTI%FT0

    SELF%F_PEMIS => CREATE_TEMPORARY('PEMIS', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PSNSE1 => CREATE_TEMPORARY('PSNSE1', GEOM=REGISTRY%GEOM, NLEV=NLEVSN, PERSISTENT=PERSISTENT)
    SELF%F_PASNE1 => CREATE_TEMPORARY('PASNE1', GEOM=REGISTRY%GEOM, NLEV=NLEVSN, PERSISTENT=PERSISTENT)
    SELF%F_PRSNE1 => CREATE_TEMPORARY('PRSNE1', GEOM=REGISTRY%GEOM, NLEV=NLEVSN, PERSISTENT=PERSISTENT)
    SELF%F_PTSNE1 => CREATE_TEMPORARY('PTSNE1', GEOM=REGISTRY%GEOM, NLEV=NLEVSN, PERSISTENT=PERSISTENT)
    SELF%F_PWSNE1 => CREATE_TEMPORARY('PWSNE1', GEOM=REGISTRY%GEOM, NLEV=NLEVSN, PERSISTENT=PERSISTENT)
    SELF%F_PWLE1 => CREATE_TEMPORARY('PWLE1', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PTLE1 => CREATE_TEMPORARY('PTLE1', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PHSTD => CREATE_TEMPORARY('PHSTD', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PCVL => CREATE_TEMPORARY('PCVL', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PCVH => CREATE_TEMPORARY('PCVH', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PLAIL => CREATE_TEMPORARY('PLAIL', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PLAIH => CREATE_TEMPORARY('PLAIH', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PEVAPMU => CREATE_TEMPORARY('PEVAPMU', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PTLICEE1 => CREATE_TEMPORARY('PTLICEE1', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PTLMNWE1 => CREATE_TEMPORARY('PTLMNWE1', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PTLWMLE1 => CREATE_TEMPORARY('PTLWMLE1', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PTLBOTE1 => CREATE_TEMPORARY('PTLBOTE1', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PTLSFE1 => CREATE_TEMPORARY('PTLSFE1', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PHLICEE1 => CREATE_TEMPORARY('PHLICEE1', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PHLMLE1 => CREATE_TEMPORARY('PHLMLE1', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_PTSAE1 => CREATE_TEMPORARY('PTSAE1', GEOM=REGISTRY%GEOM, NLEV=NLEVS, PERSISTENT=PERSISTENT)
    SELF%F_PWSAE1 => CREATE_TEMPORARY('PWSAE1', GEOM=REGISTRY%GEOM, NLEV=NLEVS, PERSISTENT=PERSISTENT)
    SELF%F_PTIAE1 => CREATE_TEMPORARY('PTIAE1', GEOM=REGISTRY%GEOM, NLEV=NLEVS, PERSISTENT=PERSISTENT)
    SELF%F_PUOE1 => CREATE_TEMPORARY('PUOE1', GEOM=REGISTRY%GEOM, NLEV=NLEVO, PERSISTENT=PERSISTENT)
    SELF%F_PVOE1 => CREATE_TEMPORARY('PVOE1', GEOM=REGISTRY%GEOM, NLEV=NLEVO, PERSISTENT=PERSISTENT)
    SELF%F_PTOE1 => CREATE_TEMPORARY('PTOE1', GEOM=REGISTRY%GEOM, NLEV=NLEVO, PERSISTENT=PERSISTENT)
    SELF%F_PSOE1 => CREATE_TEMPORARY('PSOE1', GEOM=REGISTRY%GEOM, NLEV=NLEVO, PERSISTENT=PERSISTENT)
    SELF%F_ITVH => CREATE_TEMPORARY_INT2D('ITVH', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_ITVL => CREATE_TEMPORARY_INT2D('ITVL', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_ISOTY => CREATE_TEMPORARY_INT2D('ISOTY', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
  END SUBROUTINE SURF_AND_MORE_TYPE_INIT

  SUBROUTINE SURF_AND_MORE_TYPE_UPDATE_VIEW(SELF, BLOCK_INDEX)
    ! Extract local array views from field objects
    CLASS(SURF_AND_MORE_TYPE) :: SELF
    INTEGER(KIND=JPIM), INTENT(IN) :: BLOCK_INDEX

    CALL SELF%GSP_SB%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSP_SG%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSP_SL%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSP_RR%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSP_CL%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSP_OM%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSP_EP%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSP_X2%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSP_CI%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_VF%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_VH%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_VK%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_VP%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_VV%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_VA%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_VN%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_V2%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_V3%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_VD%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_SM%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_WS%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_WW%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_XA%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_DI%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_XP%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_XP2%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_X2%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_SFO%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_SFL%UPDATE_VIEW(BLOCK_INDEX)
    CALL SELF%GSD_VC%UPDATE_VIEW(BLOCK_INDEX)

    ! Set up local view pointer from storage fields
    SELF%PUSTRTI => SELF%F_PUSTRTI%GET_VIEW(BLOCK_INDEX)
    SELF%PVSTRTI => SELF%F_PVSTRTI%GET_VIEW(BLOCK_INDEX)
    SELF%PAHFSTI => SELF%F_PAHFSTI%GET_VIEW(BLOCK_INDEX)
    SELF%PEVAPTI => SELF%F_PEVAPTI%GET_VIEW(BLOCK_INDEX)
    SELF%PTSKTI => SELF%F_PTSKTI%GET_VIEW(BLOCK_INDEX)
    SELF%PEMIS => SELF%F_PEMIS%GET_VIEW(BLOCK_INDEX)
    SELF%PSNSE1 => SELF%F_PSNSE1%GET_VIEW(BLOCK_INDEX)
    SELF%PASNE1 => SELF%F_PASNE1%GET_VIEW(BLOCK_INDEX)
    SELF%PRSNE1 => SELF%F_PRSNE1%GET_VIEW(BLOCK_INDEX)
    SELF%PTSNE1 => SELF%F_PTSNE1%GET_VIEW(BLOCK_INDEX)
    SELF%PWSNE1 => SELF%F_PWSNE1%GET_VIEW(BLOCK_INDEX)
    SELF%PWLE1 => SELF%F_PWLE1%GET_VIEW(BLOCK_INDEX)
    SELF%PTLE1 => SELF%F_PTLE1%GET_VIEW(BLOCK_INDEX)
    SELF%PHSTD => SELF%F_PHSTD%GET_VIEW(BLOCK_INDEX)
    SELF%PCVL => SELF%F_PCVL%GET_VIEW(BLOCK_INDEX)
    SELF%PCVH => SELF%F_PCVH%GET_VIEW(BLOCK_INDEX)
    SELF%PLAIL => SELF%F_PLAIL%GET_VIEW(BLOCK_INDEX)
    SELF%PLAIH => SELF%F_PLAIH%GET_VIEW(BLOCK_INDEX)
    SELF%PEVAPMU => SELF%F_PEVAPMU%GET_VIEW(BLOCK_INDEX)
    SELF%PTLICEE1 => SELF%F_PTLICEE1%GET_VIEW(BLOCK_INDEX)
    SELF%PTLMNWE1 => SELF%F_PTLMNWE1%GET_VIEW(BLOCK_INDEX)
    SELF%PTLWMLE1 => SELF%F_PTLWMLE1%GET_VIEW(BLOCK_INDEX)
    SELF%PTLBOTE1 => SELF%F_PTLBOTE1%GET_VIEW(BLOCK_INDEX)
    SELF%PTLSFE1 => SELF%F_PTLSFE1%GET_VIEW(BLOCK_INDEX)
    SELF%PHLICEE1 => SELF%F_PHLICEE1%GET_VIEW(BLOCK_INDEX)
    SELF%PHLMLE1 => SELF%F_PHLMLE1%GET_VIEW(BLOCK_INDEX)
    SELF%PTSAE1 => SELF%F_PTSAE1%GET_VIEW(BLOCK_INDEX)
    SELF%PWSAE1 => SELF%F_PWSAE1%GET_VIEW(BLOCK_INDEX)
    SELF%PTIAE1 => SELF%F_PTIAE1%GET_VIEW(BLOCK_INDEX)
    SELF%PUOE1 => SELF%F_PUOE1%GET_VIEW(BLOCK_INDEX)
    SELF%PVOE1 => SELF%F_PVOE1%GET_VIEW(BLOCK_INDEX)
    SELF%PTOE1 => SELF%F_PTOE1%GET_VIEW(BLOCK_INDEX)
    SELF%PSOE1 => SELF%F_PSOE1%GET_VIEW(BLOCK_INDEX)
    SELF%ITVH => SELF%F_ITVH%GET_VIEW(BLOCK_INDEX)
    SELF%ITVL => SELF%F_ITVL%GET_VIEW(BLOCK_INDEX)
    SELF%ISOTY=> SELF%F_ISOTY%GET_VIEW(BLOCK_INDEX)
  END SUBROUTINE SURF_AND_MORE_TYPE_UPDATE_VIEW

  SUBROUTINE SURF_AND_MORE_TYPE_SET9TO0(SELF)
    ! Field update operation for timestepping schemes
    CLASS(SURF_AND_MORE_TYPE) :: SELF

    CALL SELF%GSP_SB%SET9TO0()
    CALL SELF%GSP_SG%SET9TO0()
    CALL SELF%GSP_SL%SET9TO0()
    CALL SELF%GSP_RR%SET9TO0()
    CALL SELF%GSP_CL%SET9TO0()
    CALL SELF%GSP_OM%SET9TO0()
    CALL SELF%GSP_EP%SET9TO0()
    CALL SELF%GSP_X2%SET9TO0()
    CALL SELF%GSP_CI%SET9TO0()
  END SUBROUTINE SURF_AND_MORE_TYPE_SET9TO0

  SUBROUTINE SURF_AND_MORE_TYPE_SET1TO9(SELF)
    ! Field update operation for timestepping schemes
    CLASS(SURF_AND_MORE_TYPE) :: SELF

    CALL SELF%GSP_SB%SET1TO9()
    CALL SELF%GSP_SG%SET1TO9()
    CALL SELF%GSP_SL%SET1TO9()
    CALL SELF%GSP_RR%SET1TO9()
    CALL SELF%GSP_CL%SET1TO9()
    CALL SELF%GSP_OM%SET1TO9()
    CALL SELF%GSP_EP%SET1TO9()
    CALL SELF%GSP_X2%SET1TO9()
    CALL SELF%GSP_CI%SET1TO9()
  END SUBROUTINE SURF_AND_MORE_TYPE_SET1TO9

  SUBROUTINE SURF_AND_MORE_TYPE_SET1TO0(SELF)
    ! Field update operation for timestepping schemes
    CLASS(SURF_AND_MORE_TYPE) :: SELF

    CALL SELF%GSP_SB%SET1TO0()
    CALL SELF%GSP_SG%SET1TO0()
    CALL SELF%GSP_SL%SET1TO0()
    CALL SELF%GSP_RR%SET1TO0()
    CALL SELF%GSP_CL%SET1TO0()
    CALL SELF%GSP_OM%SET1TO0()
    CALL SELF%GSP_EP%SET1TO0()
    CALL SELF%GSP_X2%SET1TO0()
    CALL SELF%GSP_CI%SET1TO0()
  END SUBROUTINE SURF_AND_MORE_TYPE_SET1TO0

  SUBROUTINE SURF_AND_MORE_TYPE_SET0TO1(SELF)
    ! Field update operation for timestepping schemes
    CLASS(SURF_AND_MORE_TYPE) :: SELF

    CALL SELF%GSP_SB%SET0TO1()
    CALL SELF%GSP_SG%SET0TO1()
    CALL SELF%GSP_SL%SET0TO1()
    CALL SELF%GSP_RR%SET0TO1()
    CALL SELF%GSP_CL%SET0TO1()
    CALL SELF%GSP_OM%SET0TO1()
    CALL SELF%GSP_EP%SET0TO1()
    CALL SELF%GSP_X2%SET0TO1()
    CALL SELF%GSP_CI%SET0TO1()
  END SUBROUTINE SURF_AND_MORE_TYPE_SET0TO1

  SUBROUTINE SURF_AND_MORE_TYPE_PHTFILT(SELF, YDDYN)
    ! Field update operation for timestepping schemes
    CLASS(SURF_AND_MORE_TYPE) :: SELF
    TYPE(TDYN), INTENT(IN) :: YDDYN

    CALL SELF%GSP_SB%PHTFILT(YDDYN)
    CALL SELF%GSP_SG%PHTFILT(YDDYN)
    CALL SELF%GSP_SL%PHTFILT(YDDYN)
    CALL SELF%GSP_RR%PHTFILT(YDDYN)
    CALL SELF%GSP_CL%PHTFILT(YDDYN)
    CALL SELF%GSP_OM%PHTFILT(YDDYN)
    CALL SELF%GSP_EP%PHTFILT(YDDYN)
    CALL SELF%GSP_X2%PHTFILT(YDDYN)
    CALL SELF%GSP_CI%PHTFILT(YDDYN)
  END SUBROUTINE SURF_AND_MORE_TYPE_PHTFILT

  SUBROUTINE SURF_AND_MORE_TYPE_FINAL(SELF)
    ! Finalize underlying field storage
    CLASS(SURF_AND_MORE_TYPE) :: SELF

    CALL DELETE_TEMPORARY(SELF%F_PEMIS)
    CALL DELETE_TEMPORARY(SELF%F_PSNSE1)
    CALL DELETE_TEMPORARY(SELF%F_PASNE1)
    CALL DELETE_TEMPORARY(SELF%F_PRSNE1)
    CALL DELETE_TEMPORARY(SELF%F_PTSNE1)
    CALL DELETE_TEMPORARY(SELF%F_PWSNE1)
    CALL DELETE_TEMPORARY(SELF%F_PWLE1)
    CALL DELETE_TEMPORARY(SELF%F_PTLE1)
    CALL DELETE_TEMPORARY(SELF%F_PHSTD)
    CALL DELETE_TEMPORARY(SELF%F_PCVL)
    CALL DELETE_TEMPORARY(SELF%F_PCVH)
    CALL DELETE_TEMPORARY(SELF%F_PLAIL)
    CALL DELETE_TEMPORARY(SELF%F_PLAIH)
    CALL DELETE_TEMPORARY(SELF%F_PEVAPMU)
    CALL DELETE_TEMPORARY(SELF%F_PTLICEE1)
    CALL DELETE_TEMPORARY(SELF%F_PTLMNWE1)
    CALL DELETE_TEMPORARY(SELF%F_PTLWMLE1)
    CALL DELETE_TEMPORARY(SELF%F_PTLBOTE1)
    CALL DELETE_TEMPORARY(SELF%F_PTLSFE1)
    CALL DELETE_TEMPORARY(SELF%F_PHLICEE1)
    CALL DELETE_TEMPORARY(SELF%F_PHLMLE1)
    CALL DELETE_TEMPORARY(SELF%F_PTSAE1)
    CALL DELETE_TEMPORARY(SELF%F_PWSAE1)
    CALL DELETE_TEMPORARY(SELF%F_PTIAE1)
    CALL DELETE_TEMPORARY(SELF%F_PUOE1)
    CALL DELETE_TEMPORARY(SELF%F_PVOE1)
    CALL DELETE_TEMPORARY(SELF%F_PTOE1)
    CALL DELETE_TEMPORARY(SELF%F_PSOE1)
    CALL DELETE_TEMPORARY(SELF%F_ITVH)
    CALL DELETE_TEMPORARY(SELF%F_ITVL)
    CALL DELETE_TEMPORARY(SELF%F_ISOTY)
  END SUBROUTINE SURF_AND_MORE_TYPE_FINAL


  SUBROUTINE SURF_AND_MORE_LOCAL_TYPE_INIT(SELF, REGISTRY, NLEVSN, NTILES, NTSW, NLWEMISS, PERSISTENT)
    ! Constructor of the array view type for a surface variable group
    CLASS(SURF_AND_MORE_LOCAL_TYPE) :: SELF
    TYPE(FIELD_REGISTRY), INTENT(INOUT) :: REGISTRY
    INTEGER(KIND=JPIM), INTENT(IN) :: NLEVSN, NTILES, NTSW, NLWEMISS
    LOGICAL, OPTIONAL, INTENT(IN) :: PERSISTENT

    SELF%F_ZLAILI => CREATE_TEMPORARY('ZLAILI', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_ZLAIHI => CREATE_TEMPORARY('ZLAIHI', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_ZSNM1M => CREATE_TEMPORARY('ZSNM1M', GEOM=REGISTRY%GEOM, NLEV=NLEVSN, PERSISTENT=PERSISTENT)
    SELF%F_ZRSNM1M => CREATE_TEMPORARY('ZRSNM1M', GEOM=REGISTRY%GEOM, NLEV=NLEVSN, PERSISTENT=PERSISTENT)
    SELF%F_ZWLM1M => CREATE_TEMPORARY('ZWLM1M', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_ZHSDFOR => CREATE_TEMPORARY('ZHSDFOR', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_ZWLMX => CREATE_TEMPORARY('ZWLMX', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_ZSPECTRALEMISS => CREATE_TEMPORARY('ZSPECTRALEMISS', GEOM=REGISTRY%GEOM, NLEV=NLWEMISS, PERSISTENT=PERSISTENT)
    SELF%F_ZEVAPSNW => CREATE_TEMPORARY('ZEVAPSNW', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_ZTHKICE => CREATE_TEMPORARY('ZTHKICE', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_ZSNTICE => CREATE_TEMPORARY('ZSNTICE', GEOM=REGISTRY%GEOM, PERSISTENT=PERSISTENT)
    SELF%F_ZFRTI => CREATE_TEMPORARY('ZFRTI', GEOM=REGISTRY%GEOM, NLEV=NTILES, PERSISTENT=PERSISTENT)
    SELF%F_ZALBTI => CREATE_TEMPORARY('ZALBTI', GEOM=REGISTRY%GEOM, NLEV=NTILES, PERSISTENT=PERSISTENT)
    SELF%F_ZFRSOTI => CREATE_TEMPORARY('ZFRSOTI', GEOM=REGISTRY%GEOM, NLEV=NTILES, PERSISTENT=PERSISTENT)
    SELF%F_ZAHFTRTI => CREATE_TEMPORARY('ZAHFTRTI', GEOM=REGISTRY%GEOM, NLEV=NTILES, PERSISTENT=PERSISTENT)
    SELF%F_ZALBD => CREATE_TEMPORARY('ZALBD', GEOM=REGISTRY%GEOM, NLEV=NTSW, PERSISTENT=PERSISTENT)
    SELF%F_ZALBP => CREATE_TEMPORARY('ZALBP', GEOM=REGISTRY%GEOM, NLEV=NTSW, PERSISTENT=PERSISTENT)
    SELF%F_ZANDAYVT => CREATE_TEMPORARY('ZANDAYVT', GEOM=REGISTRY%GEOM, NLEV=IKVTYPES, PERSISTENT=PERSISTENT)
    SELF%F_ZANFMVT => CREATE_TEMPORARY('ZANFMVT', GEOM=REGISTRY%GEOM, NLEV=IKVTYPES, PERSISTENT=PERSISTENT)
    SELF%F_ZDHVEGS => CREATE_TEMPORARY('ZDHVEGS', GEOM=REGISTRY%GEOM, NLEV=IKVTYPES, NDIM=IKDHVVEGS+IKDHFVEGS, &
     & PERSISTENT=PERSISTENT)
  END SUBROUTINE SURF_AND_MORE_LOCAL_TYPE_INIT

  SUBROUTINE SURF_AND_MORE_LOCAL_TYPE_UPDATE_VIEW(SELF, BLOCK_INDEX)
    ! Extract local array views from field objects
    CLASS(SURF_AND_MORE_LOCAL_TYPE) :: SELF
    INTEGER(KIND=JPIM), INTENT(IN) :: BLOCK_INDEX

    SELF%ZLAILI => SELF%F_ZLAILI%GET_VIEW(BLOCK_INDEX)
    SELF%ZLAIHI => SELF%F_ZLAIHI%GET_VIEW(BLOCK_INDEX)
    SELF%ZSNM1M => SELF%F_ZSNM1M%GET_VIEW(BLOCK_INDEX)
    SELF%ZRSNM1M => SELF%F_ZRSNM1M%GET_VIEW(BLOCK_INDEX)
    SELF%ZWLM1M => SELF%F_ZWLM1M%GET_VIEW(BLOCK_INDEX)
    SELF%ZHSDFOR => SELF%F_ZHSDFOR%GET_VIEW(BLOCK_INDEX)
    SELF%ZWLMX => SELF%F_ZWLMX%GET_VIEW(BLOCK_INDEX)
    SELF%ZSPECTRALEMISS => SELF%F_ZSPECTRALEMISS%GET_VIEW(BLOCK_INDEX)
    SELF%ZEVAPSNW => SELF%F_ZEVAPSNW%GET_VIEW(BLOCK_INDEX)
    SELF%ZTHKICE => SELF%F_ZTHKICE%GET_VIEW(BLOCK_INDEX)
    SELF%ZSNTICE => SELF%F_ZSNTICE%GET_VIEW(BLOCK_INDEX)
    SELF%ZFRTI => SELF%F_ZFRTI%GET_VIEW(BLOCK_INDEX)
    SELF%ZALBTI => SELF%F_ZALBTI%GET_VIEW(BLOCK_INDEX)
    SELF%ZFRSOTI => SELF%F_ZFRSOTI%GET_VIEW(BLOCK_INDEX)
    SELF%ZAHFTRTI => SELF%F_ZAHFTRTI%GET_VIEW(BLOCK_INDEX)
    SELF%ZALBD => SELF%F_ZALBD%GET_VIEW(BLOCK_INDEX)
    SELF%ZALBP => SELF%F_ZALBP%GET_VIEW(BLOCK_INDEX)
    SELF%ZANDAYVT => SELF%F_ZANDAYVT%GET_VIEW(BLOCK_INDEX)
    SELF%ZANFMVT => SELF%F_ZANFMVT%GET_VIEW(BLOCK_INDEX)
    SELF%ZDHVEGS => SELF%F_ZDHVEGS%GET_VIEW(BLOCK_INDEX)
  END SUBROUTINE SURF_AND_MORE_LOCAL_TYPE_UPDATE_VIEW

  SUBROUTINE SURF_AND_MORE_LOCAL_TYPE_FINAL(SELF)
    CLASS(SURF_AND_MORE_LOCAL_TYPE) :: SELF

    CALL DELETE_TEMPORARY(SELF%F_ZLAILI)
    CALL DELETE_TEMPORARY(SELF%F_ZLAIHI)
    CALL DELETE_TEMPORARY(SELF%F_ZSNM1M)
    CALL DELETE_TEMPORARY(SELF%F_ZRSNM1M)
    CALL DELETE_TEMPORARY(SELF%F_ZWLM1M)
    CALL DELETE_TEMPORARY(SELF%F_ZHSDFOR)
    CALL DELETE_TEMPORARY(SELF%F_ZWLMX)
    CALL DELETE_TEMPORARY(SELF%F_ZSPECTRALEMISS)
    CALL DELETE_TEMPORARY(SELF%F_ZEVAPSNW)
    CALL DELETE_TEMPORARY(SELF%F_ZTHKICE)
    CALL DELETE_TEMPORARY(SELF%F_ZSNTICE)
    CALL DELETE_TEMPORARY(SELF%F_ZFRTI)
    CALL DELETE_TEMPORARY(SELF%F_ZALBTI)
    CALL DELETE_TEMPORARY(SELF%F_ZFRSOTI)
    CALL DELETE_TEMPORARY(SELF%F_ZAHFTRTI)
    CALL DELETE_TEMPORARY(SELF%F_ZALBD)
    CALL DELETE_TEMPORARY(SELF%F_ZALBP)
    CALL DELETE_TEMPORARY(SELF%F_ZANDAYVT)
    CALL DELETE_TEMPORARY(SELF%F_ZANFMVT)
    CALL DELETE_TEMPORARY(SELF%F_ZDHVEGS)
  END SUBROUTINE SURF_AND_MORE_LOCAL_TYPE_FINAL


  SUBROUTINE DDH_SURF_TYPE_INIT(SELF, REGISTRY, DIMS, PERSISTENT)
    ! Constructor of the array view type for a surface variable group
    CLASS(DDH_SURF_TYPE) :: SELF
    TYPE(FIELD_REGISTRY), INTENT(INOUT) :: REGISTRY
    TYPE(DIMENSION_TYPE), INTENT(IN) :: DIMS
    LOGICAL, OPTIONAL, INTENT(IN) :: PERSISTENT

    SELF%F_PDHTLS => CREATE_TEMPORARY('PDHTLS', GEOM=REGISTRY%GEOM, NLEV=DIMS%KTILES, NDIM=DIMS%KDHVTLS+DIMS%KDHFTLS)
    SELF%F_PDHTSS => CREATE_TEMPORARY('PDHTSS', GEOM=REGISTRY%GEOM, NLEV=DIMS%KLEVSN, NDIM=DIMS%KDHVTSS+DIMS%KDHFTSS)
    SELF%F_PDHTTS => CREATE_TEMPORARY('PDHTTS', GEOM=REGISTRY%GEOM, NLEV=DIMS%KLEVS,  NDIM=DIMS%KDHVTTS+DIMS%KDHFTTS)
    SELF%F_PDHTIS => CREATE_TEMPORARY('PDHTIS', GEOM=REGISTRY%GEOM, NLEV=DIMS%KLEVI,  NDIM=DIMS%KDHVTIS+DIMS%KDHFTIS)
    SELF%F_PDHSSS => CREATE_TEMPORARY('PDHSSS', GEOM=REGISTRY%GEOM, NLEV=DIMS%KLEVSN, NDIM=DIMS%KDHVSSS+DIMS%KDHFSSS)
    SELF%F_PDHIIS => CREATE_TEMPORARY('PDHIIS', GEOM=REGISTRY%GEOM, NLEV=DIMS%KDHVIIS+DIMS%KDHFIIS)
    SELF%F_PDHWLS => CREATE_TEMPORARY('PDHWLS', GEOM=REGISTRY%GEOM, NLEV=DIMS%KLEVS,  NDIM=DIMS%KDHVWLS+DIMS%KDHFWLS)
  END SUBROUTINE DDH_SURF_TYPE_INIT

  SUBROUTINE DDH_SURF_TYPE_UPDATE_VIEW(SELF, BLOCK_INDEX)
    ! Extract local array views from field objects
    CLASS(DDH_SURF_TYPE) :: SELF
    INTEGER(KIND=JPIM), INTENT(IN) :: BLOCK_INDEX

    SELF%PDHTLS => SELF%F_PDHTLS%GET_VIEW(BLOCK_INDEX)
    SELF%PDHTSS => SELF%F_PDHTSS%GET_VIEW(BLOCK_INDEX)
    SELF%PDHTTS => SELF%F_PDHTTS%GET_VIEW(BLOCK_INDEX)
    SELF%PDHTIS => SELF%F_PDHTIS%GET_VIEW(BLOCK_INDEX)
    SELF%PDHSSS => SELF%F_PDHSSS%GET_VIEW(BLOCK_INDEX)
    SELF%PDHIIS => SELF%F_PDHIIS%GET_VIEW(BLOCK_INDEX)
    SELF%PDHWLS => SELF%F_PDHWLS%GET_VIEW(BLOCK_INDEX)
  END SUBROUTINE DDH_SURF_TYPE_UPDATE_VIEW

  SUBROUTINE DDH_SURF_TYPE_FINAL(SELF)
    CLASS(DDH_SURF_TYPE) :: SELF

    CALL DELETE_TEMPORARY(SELF%F_PDHTLS)
    CALL DELETE_TEMPORARY(SELF%F_PDHTSS)
    CALL DELETE_TEMPORARY(SELF%F_PDHTTS)
    CALL DELETE_TEMPORARY(SELF%F_PDHTIS)
    CALL DELETE_TEMPORARY(SELF%F_PDHSSS)
    CALL DELETE_TEMPORARY(SELF%F_PDHIIS)
    CALL DELETE_TEMPORARY(SELF%F_PDHWLS)
  END SUBROUTINE DDH_SURF_TYPE_FINAL

END MODULE ECPHYS_SURFACE_TYPE_MOD
