



MODULE FIELD_HELPER_MODULE

USE FIELD_MODULE
USE YOMHOOK

IMPLICIT NONE

INTERFACE CREATE_TEMPORARY_LU
  MODULE PROCEDURE CREATE_TEMPORARY_2D_LU
  MODULE PROCEDURE CREATE_TEMPORARY_3D_LU
  MODULE PROCEDURE CREATE_TEMPORARY_4D_LU
  MODULE PROCEDURE CREATE_TEMPORARY_5D_LU
  MODULE PROCEDURE CREATE_TEMPORARY_INT2D_LU
  MODULE PROCEDURE CREATE_TEMPORARY_INT3D_LU
  MODULE PROCEDURE CREATE_TEMPORARY_LOG2D_LU
END INTERFACE CREATE_TEMPORARY_LU

INTERFACE GET_DEVICE_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_2D_GET_DEVICE_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_3D_GET_DEVICE_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_4D_GET_DEVICE_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_5D_GET_DEVICE_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_INT2D_GET_DEVICE_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_INT3D_GET_DEVICE_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_INT4D_GET_DEVICE_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_INT5D_GET_DEVICE_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_LOG2D_GET_DEVICE_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_LOG3D_GET_DEVICE_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_LOG4D_GET_DEVICE_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_LOG5D_GET_DEVICE_DATA_RDONLY
END INTERFACE GET_DEVICE_DATA_RDONLY

INTERFACE GET_DEVICE_DATA_RDWR
  MODULE PROCEDURE :: FIELD_2D_GET_DEVICE_DATA_RDWR
  MODULE PROCEDURE :: FIELD_3D_GET_DEVICE_DATA_RDWR
  MODULE PROCEDURE :: FIELD_4D_GET_DEVICE_DATA_RDWR
  MODULE PROCEDURE :: FIELD_5D_GET_DEVICE_DATA_RDWR
  MODULE PROCEDURE :: FIELD_INT2D_GET_DEVICE_DATA_RDWR
  MODULE PROCEDURE :: FIELD_INT3D_GET_DEVICE_DATA_RDWR
  MODULE PROCEDURE :: FIELD_INT4D_GET_DEVICE_DATA_RDWR
  MODULE PROCEDURE :: FIELD_INT5D_GET_DEVICE_DATA_RDWR
  MODULE PROCEDURE :: FIELD_LOG2D_GET_DEVICE_DATA_RDWR
  MODULE PROCEDURE :: FIELD_LOG3D_GET_DEVICE_DATA_RDWR
  MODULE PROCEDURE :: FIELD_LOG4D_GET_DEVICE_DATA_RDWR
  MODULE PROCEDURE :: FIELD_LOG5D_GET_DEVICE_DATA_RDWR
END INTERFACE GET_DEVICE_DATA_RDWR

INTERFACE GET_HOST_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_2D_GET_HOST_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_3D_GET_HOST_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_4D_GET_HOST_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_5D_GET_HOST_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_INT2D_GET_HOST_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_INT3D_GET_HOST_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_INT4D_GET_HOST_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_INT5D_GET_HOST_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_LOG2D_GET_HOST_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_LOG3D_GET_HOST_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_LOG4D_GET_HOST_DATA_RDONLY
  MODULE PROCEDURE :: FIELD_LOG5D_GET_HOST_DATA_RDONLY
END INTERFACE GET_HOST_DATA_RDONLY

INTERFACE GET_HOST_DATA_RDWR
  MODULE PROCEDURE :: FIELD_2D_GET_HOST_DATA_RDWR
  MODULE PROCEDURE :: FIELD_3D_GET_HOST_DATA_RDWR
  MODULE PROCEDURE :: FIELD_4D_GET_HOST_DATA_RDWR
  MODULE PROCEDURE :: FIELD_5D_GET_HOST_DATA_RDWR
  MODULE PROCEDURE :: FIELD_INT2D_GET_HOST_DATA_RDWR
  MODULE PROCEDURE :: FIELD_INT3D_GET_HOST_DATA_RDWR
  MODULE PROCEDURE :: FIELD_INT4D_GET_HOST_DATA_RDWR
  MODULE PROCEDURE :: FIELD_INT5D_GET_HOST_DATA_RDWR
  MODULE PROCEDURE :: FIELD_LOG2D_GET_HOST_DATA_RDWR
  MODULE PROCEDURE :: FIELD_LOG3D_GET_HOST_DATA_RDWR
  MODULE PROCEDURE :: FIELD_LOG4D_GET_HOST_DATA_RDWR
  MODULE PROCEDURE :: FIELD_LOG5D_GET_HOST_DATA_RDWR
END INTERFACE GET_HOST_DATA_RDWR

INTEGER (KIND=JPIM), PARAMETER, PRIVATE :: NH2D = 1, ND2H = 2, NRD = B'00000001', NWR = B'00000010'

CONTAINS


  INTEGER (KIND=JPIM) FUNCTION FIELD_2D_GET_LAST_CONTIGUOUS_DIMENSION (PTR) RESULT (JDIM)
  REAL(KIND=JPRB), POINTER :: PTR (:,:)
  INTEGER*8 :: ISTRIDE (2)
  INTEGER (KIND=JPIM) :: J

  ISTRIDE (1) = KIND (PTR)
  DO J = 2, 2
    ISTRIDE (J) = ISTRIDE (J-1) * SIZE (PTR, J-1) 
  ENDDO

  JDIM = 0
  IF (LOC (PTR (2, 1)) - LOC (PTR (1, 1)) /= ISTRIDE (1)) THEN
    RETURN
  ENDIF

  JDIM = 1

  IF (LOC (PTR (1, 2)) - LOC (PTR (1, 1)) /= ISTRIDE (2)) THEN
    RETURN
  ENDIF

  JDIM = 2

  END FUNCTION FIELD_2D_GET_LAST_CONTIGUOUS_DIMENSION

  SUBROUTINE FIELD_2D_COPY (HST, DEV, KDIR)
  REAL(KIND=JPRB), POINTER :: HST (:,:), DEV (:,:)
  INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
  INTEGER (KIND=JPIM) :: JDIM

  JDIM = FIELD_2D_GET_LAST_CONTIGUOUS_DIMENSION (HST)

  SELECT CASE (JDIM)
    CASE (0)
      CALL COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    CASE (1)
      CALL COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    CASE (2)
      CALL COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
  END SELECT

  CONTAINS

    SUBROUTINE COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    REAL(KIND=JPRB), POINTER :: HST (:,:), DEV (:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J1, J2

    DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
      DO J1 = LBOUND (HST, 1), UBOUND (HST, 1)
        ISIZE = KIND (HST)
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (J1, J2), HST (J1, J2), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (J1, J2), DEV (J1, J2), ISIZE)
#endif
          !$acc end host_data
        ENDIF
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    REAL(KIND=JPRB), POINTER :: HST (:,:), DEV (:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J2

    DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
      ISIZE = KIND (HST) * SIZE (HST (:, J2))
      IF (KDIR == NH2D) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_TO_DEVICE (DEV (:, J2), HST (:, J2), ISIZE)
#endif
        !$acc end host_data
      ELSEIF (KDIR == ND2H) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_FROM_DEVICE (HST (:, J2), DEV (:, J2), ISIZE)
#endif
        !$acc end host_data
      ENDIF
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    REAL(KIND=JPRB), POINTER :: HST (:,:), DEV (:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J

        ISIZE = KIND (HST) * SIZE (HST (:, :))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :), HST (:, :), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :), DEV (:, :), ISIZE)
#endif
          !$acc end host_data
        ENDIF
    END SUBROUTINE

  END SUBROUTINE FIELD_2D_COPY

  FUNCTION FIELD_2D_GET_HOST_DATA_ (SELF, MODE) RESULT (PTR)
    TYPE(FIELD_2D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    REAL(KIND=JPRB), TARGET, SAVE :: ZDUM (1, 1)
    REAL(KIND=JPRB), POINTER :: PTR(:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NHSTFRESH) == 0) THEN
        CALL FIELD_2D_COPY (SELF%PTR, SELF%DEVPTR, ND2H)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NHSTFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):) => SELF%PTR (:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NDEVFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_2D_GET_HOST_DATA_

  FUNCTION FIELD_2D_GET_HOST_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_2D), POINTER, INTENT (IN) :: SELF
    REAL(KIND=JPRB), POINTER :: PTR(:,:)

    PTR => FIELD_2D_GET_HOST_DATA_ (SELF, NRD)

  END FUNCTION FIELD_2D_GET_HOST_DATA_RDONLY

  FUNCTION FIELD_2D_GET_HOST_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_2D), POINTER, INTENT (IN) :: SELF
    REAL(KIND=JPRB), POINTER :: PTR(:,:)

    PTR => FIELD_2D_GET_HOST_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_2D_GET_HOST_DATA_RDWR

  FUNCTION FIELD_2D_GET_DEVICE_DATA_ (SELF, MODE) RESULT(PTR)
    TYPE(FIELD_2D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    REAL(KIND=JPRB), TARGET, SAVE :: ZDUM (1, 1)
    REAL(KIND=JPRB), POINTER :: PTR(:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NDEVFRESH) == 0) THEN
        IF (.NOT. ASSOCIATED (SELF%DEVPTR)) THEN
          ALLOCATE (SELF%DEVPTR, MOLD=SELF%PTR)
          !$acc enter data create (SELF%DEVPTR)
        ENDIF
        CALL FIELD_2D_COPY (SELF%PTR, SELF%DEVPTR, NH2D)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NDEVFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):) => SELF%DEVPTR (:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NHSTFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_2D_GET_DEVICE_DATA_

  FUNCTION FIELD_2D_GET_DEVICE_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_2D), POINTER, INTENT (IN) :: SELF
    REAL(KIND=JPRB), POINTER :: PTR(:,:)

    PTR => FIELD_2D_GET_DEVICE_DATA_ (SELF, NRD)

  END FUNCTION FIELD_2D_GET_DEVICE_DATA_RDONLY

  FUNCTION FIELD_2D_GET_DEVICE_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_2D), POINTER, INTENT (IN) :: SELF
    REAL(KIND=JPRB), POINTER :: PTR(:,:)

    PTR => FIELD_2D_GET_DEVICE_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_2D_GET_DEVICE_DATA_RDWR


  INTEGER (KIND=JPIM) FUNCTION FIELD_3D_GET_LAST_CONTIGUOUS_DIMENSION (PTR) RESULT (JDIM)
  REAL(KIND=JPRB), POINTER :: PTR (:,:,:)
  INTEGER*8 :: ISTRIDE (3)
  INTEGER (KIND=JPIM) :: J

  ISTRIDE (1) = KIND (PTR)
  DO J = 2, 3
    ISTRIDE (J) = ISTRIDE (J-1) * SIZE (PTR, J-1) 
  ENDDO

  JDIM = 0
  IF (LOC (PTR (2, 1, 1)) - LOC (PTR (1, 1, 1)) /= ISTRIDE (1)) THEN
    RETURN
  ENDIF

  JDIM = 1

  IF (LOC (PTR (1, 2, 1)) - LOC (PTR (1, 1, 1)) /= ISTRIDE (2)) THEN
    RETURN
  ENDIF

  JDIM = 2

  IF (LOC (PTR (1, 1, 2)) - LOC (PTR (1, 1, 1)) /= ISTRIDE (3)) THEN
    RETURN
  ENDIF

  JDIM = 3

  END FUNCTION FIELD_3D_GET_LAST_CONTIGUOUS_DIMENSION

  SUBROUTINE FIELD_3D_COPY (HST, DEV, KDIR)
  REAL(KIND=JPRB), POINTER :: HST (:,:,:), DEV (:,:,:)
  INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
  INTEGER (KIND=JPIM) :: JDIM

  JDIM = FIELD_3D_GET_LAST_CONTIGUOUS_DIMENSION (HST)

  SELECT CASE (JDIM)
    CASE (0)
      CALL COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    CASE (1)
      CALL COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    CASE (2)
      CALL COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    CASE (3)
      CALL COPY_DIM3_CONTIGUOUS (HST, DEV, KDIR)
  END SELECT

  CONTAINS

    SUBROUTINE COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    REAL(KIND=JPRB), POINTER :: HST (:,:,:), DEV (:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J1, J2, J3

    DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
      DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
        DO J1 = LBOUND (HST, 1), UBOUND (HST, 1)
          ISIZE = KIND (HST)
          IF (KDIR == NH2D) THEN
            !$acc host_data use_device (DEV)
#ifdef _OPENACC
            CALL ACC_MEMCPY_TO_DEVICE (DEV (J1, J2, J3), HST (J1, J2, J3), ISIZE)
#endif
            !$acc end host_data
          ELSEIF (KDIR == ND2H) THEN
            !$acc host_data use_device (DEV)
#ifdef _OPENACC
            CALL ACC_MEMCPY_FROM_DEVICE (HST (J1, J2, J3), DEV (J1, J2, J3), ISIZE)
#endif
            !$acc end host_data
          ENDIF
        ENDDO
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    REAL(KIND=JPRB), POINTER :: HST (:,:,:), DEV (:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J2, J3

    DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
      DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
        ISIZE = KIND (HST) * SIZE (HST (:, J2, J3))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, J2, J3), HST (:, J2, J3), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, J2, J3), DEV (:, J2, J3), ISIZE)
#endif
          !$acc end host_data
        ENDIF
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    REAL(KIND=JPRB), POINTER :: HST (:,:,:), DEV (:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J3

    DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
      ISIZE = KIND (HST) * SIZE (HST (:, :, J3))
      IF (KDIR == NH2D) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, J3), HST (:, :, J3), ISIZE)
#endif
        !$acc end host_data
      ELSEIF (KDIR == ND2H) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, J3), DEV (:, :, J3), ISIZE)
#endif
        !$acc end host_data
      ENDIF
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM3_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    REAL(KIND=JPRB), POINTER :: HST (:,:,:), DEV (:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J

        ISIZE = KIND (HST) * SIZE (HST (:, :, :))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, :), HST (:, :, :), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, :), DEV (:, :, :), ISIZE)
#endif
          !$acc end host_data
        ENDIF
    END SUBROUTINE

  END SUBROUTINE FIELD_3D_COPY

  FUNCTION FIELD_3D_GET_HOST_DATA_ (SELF, MODE) RESULT (PTR)
    TYPE(FIELD_3D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    REAL(KIND=JPRB), TARGET, SAVE :: ZDUM (1, 1, 1)
    REAL(KIND=JPRB), POINTER :: PTR(:,:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NHSTFRESH) == 0) THEN
        CALL FIELD_3D_COPY (SELF%PTR, SELF%DEVPTR, ND2H)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NHSTFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):, SELF%LBOUNDS(3):) => SELF%PTR (:,:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NDEVFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_3D_GET_HOST_DATA_

  FUNCTION FIELD_3D_GET_HOST_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_3D), POINTER, INTENT (IN) :: SELF
    REAL(KIND=JPRB), POINTER :: PTR(:,:,:)

    PTR => FIELD_3D_GET_HOST_DATA_ (SELF, NRD)

  END FUNCTION FIELD_3D_GET_HOST_DATA_RDONLY

  FUNCTION FIELD_3D_GET_HOST_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_3D), POINTER, INTENT (IN) :: SELF
    REAL(KIND=JPRB), POINTER :: PTR(:,:,:)

    PTR => FIELD_3D_GET_HOST_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_3D_GET_HOST_DATA_RDWR

  FUNCTION FIELD_3D_GET_DEVICE_DATA_ (SELF, MODE) RESULT(PTR)
    TYPE(FIELD_3D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    REAL(KIND=JPRB), TARGET, SAVE :: ZDUM (1, 1, 1)
    REAL(KIND=JPRB), POINTER :: PTR(:,:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NDEVFRESH) == 0) THEN
        IF (.NOT. ASSOCIATED (SELF%DEVPTR)) THEN
          ALLOCATE (SELF%DEVPTR, MOLD=SELF%PTR)
          !$acc enter data create (SELF%DEVPTR)
        ENDIF
        CALL FIELD_3D_COPY (SELF%PTR, SELF%DEVPTR, NH2D)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NDEVFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):, SELF%LBOUNDS(3):) => SELF%DEVPTR (:,:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NHSTFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_3D_GET_DEVICE_DATA_

  FUNCTION FIELD_3D_GET_DEVICE_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_3D), POINTER, INTENT (IN) :: SELF
    REAL(KIND=JPRB), POINTER :: PTR(:,:,:)

    PTR => FIELD_3D_GET_DEVICE_DATA_ (SELF, NRD)

  END FUNCTION FIELD_3D_GET_DEVICE_DATA_RDONLY

  FUNCTION FIELD_3D_GET_DEVICE_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_3D), POINTER, INTENT (IN) :: SELF
    REAL(KIND=JPRB), POINTER :: PTR(:,:,:)

    PTR => FIELD_3D_GET_DEVICE_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_3D_GET_DEVICE_DATA_RDWR


  INTEGER (KIND=JPIM) FUNCTION FIELD_4D_GET_LAST_CONTIGUOUS_DIMENSION (PTR) RESULT (JDIM)
  REAL(KIND=JPRB), POINTER :: PTR (:,:,:,:)
  INTEGER*8 :: ISTRIDE (4)
  INTEGER (KIND=JPIM) :: J

  ISTRIDE (1) = KIND (PTR)
  DO J = 2, 4
    ISTRIDE (J) = ISTRIDE (J-1) * SIZE (PTR, J-1) 
  ENDDO

  JDIM = 0
  IF (LOC (PTR (2, 1, 1, 1)) - LOC (PTR (1, 1, 1, 1)) /= ISTRIDE (1)) THEN
    RETURN
  ENDIF

  JDIM = 1

  IF (LOC (PTR (1, 2, 1, 1)) - LOC (PTR (1, 1, 1, 1)) /= ISTRIDE (2)) THEN
    RETURN
  ENDIF

  JDIM = 2

  IF (LOC (PTR (1, 1, 2, 1)) - LOC (PTR (1, 1, 1, 1)) /= ISTRIDE (3)) THEN
    RETURN
  ENDIF

  JDIM = 3

  IF (LOC (PTR (1, 1, 1, 2)) - LOC (PTR (1, 1, 1, 1)) /= ISTRIDE (4)) THEN
    RETURN
  ENDIF

  JDIM = 4

  END FUNCTION FIELD_4D_GET_LAST_CONTIGUOUS_DIMENSION

  SUBROUTINE FIELD_4D_COPY (HST, DEV, KDIR)
  REAL(KIND=JPRB), POINTER :: HST (:,:,:,:), DEV (:,:,:,:)
  INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
  INTEGER (KIND=JPIM) :: JDIM

  JDIM = FIELD_4D_GET_LAST_CONTIGUOUS_DIMENSION (HST)

  SELECT CASE (JDIM)
    CASE (0)
      CALL COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    CASE (1)
      CALL COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    CASE (2)
      CALL COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    CASE (3)
      CALL COPY_DIM3_CONTIGUOUS (HST, DEV, KDIR)
    CASE (4)
      CALL COPY_DIM4_CONTIGUOUS (HST, DEV, KDIR)
  END SELECT

  CONTAINS

    SUBROUTINE COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    REAL(KIND=JPRB), POINTER :: HST (:,:,:,:), DEV (:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J1, J2, J3, J4

    DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
      DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
        DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
          DO J1 = LBOUND (HST, 1), UBOUND (HST, 1)
            ISIZE = KIND (HST)
            IF (KDIR == NH2D) THEN
              !$acc host_data use_device (DEV)
#ifdef _OPENACC
              CALL ACC_MEMCPY_TO_DEVICE (DEV (J1, J2, J3, J4), HST (J1, J2, J3, J4), ISIZE)
#endif
              !$acc end host_data
            ELSEIF (KDIR == ND2H) THEN
              !$acc host_data use_device (DEV)
#ifdef _OPENACC
              CALL ACC_MEMCPY_FROM_DEVICE (HST (J1, J2, J3, J4), DEV (J1, J2, J3, J4), ISIZE)
#endif
              !$acc end host_data
            ENDIF
          ENDDO
        ENDDO
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    REAL(KIND=JPRB), POINTER :: HST (:,:,:,:), DEV (:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J2, J3, J4

    DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
      DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
        DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
          ISIZE = KIND (HST) * SIZE (HST (:, J2, J3, J4))
          IF (KDIR == NH2D) THEN
            !$acc host_data use_device (DEV)
#ifdef _OPENACC
            CALL ACC_MEMCPY_TO_DEVICE (DEV (:, J2, J3, J4), HST (:, J2, J3, J4), ISIZE)
#endif
            !$acc end host_data
          ELSEIF (KDIR == ND2H) THEN
            !$acc host_data use_device (DEV)
#ifdef _OPENACC
            CALL ACC_MEMCPY_FROM_DEVICE (HST (:, J2, J3, J4), DEV (:, J2, J3, J4), ISIZE)
#endif
            !$acc end host_data
          ENDIF
        ENDDO
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    REAL(KIND=JPRB), POINTER :: HST (:,:,:,:), DEV (:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J3, J4

    DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
      DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
        ISIZE = KIND (HST) * SIZE (HST (:, :, J3, J4))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, J3, J4), HST (:, :, J3, J4), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, J3, J4), DEV (:, :, J3, J4), ISIZE)
#endif
          !$acc end host_data
        ENDIF
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM3_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    REAL(KIND=JPRB), POINTER :: HST (:,:,:,:), DEV (:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J4

    DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
      ISIZE = KIND (HST) * SIZE (HST (:, :, :, J4))
      IF (KDIR == NH2D) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, :, J4), HST (:, :, :, J4), ISIZE)
#endif
        !$acc end host_data
      ELSEIF (KDIR == ND2H) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, :, J4), DEV (:, :, :, J4), ISIZE)
#endif
        !$acc end host_data
      ENDIF
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM4_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    REAL(KIND=JPRB), POINTER :: HST (:,:,:,:), DEV (:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J

        ISIZE = KIND (HST) * SIZE (HST (:, :, :, :))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, :, :), HST (:, :, :, :), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, :, :), DEV (:, :, :, :), ISIZE)
#endif
          !$acc end host_data
        ENDIF
    END SUBROUTINE

  END SUBROUTINE FIELD_4D_COPY

  FUNCTION FIELD_4D_GET_HOST_DATA_ (SELF, MODE) RESULT (PTR)
    TYPE(FIELD_4D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    REAL(KIND=JPRB), TARGET, SAVE :: ZDUM (1, 1, 1, 1)
    REAL(KIND=JPRB), POINTER :: PTR(:,:,:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NHSTFRESH) == 0) THEN
        CALL FIELD_4D_COPY (SELF%PTR, SELF%DEVPTR, ND2H)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NHSTFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):, SELF%LBOUNDS(3):, SELF%LBOUNDS(4):) => SELF%PTR (:,:,:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NDEVFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_4D_GET_HOST_DATA_

  FUNCTION FIELD_4D_GET_HOST_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_4D), POINTER, INTENT (IN) :: SELF
    REAL(KIND=JPRB), POINTER :: PTR(:,:,:,:)

    PTR => FIELD_4D_GET_HOST_DATA_ (SELF, NRD)

  END FUNCTION FIELD_4D_GET_HOST_DATA_RDONLY

  FUNCTION FIELD_4D_GET_HOST_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_4D), POINTER, INTENT (IN) :: SELF
    REAL(KIND=JPRB), POINTER :: PTR(:,:,:,:)

    PTR => FIELD_4D_GET_HOST_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_4D_GET_HOST_DATA_RDWR

  FUNCTION FIELD_4D_GET_DEVICE_DATA_ (SELF, MODE) RESULT(PTR)
    TYPE(FIELD_4D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    REAL(KIND=JPRB), TARGET, SAVE :: ZDUM (1, 1, 1, 1)
    REAL(KIND=JPRB), POINTER :: PTR(:,:,:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NDEVFRESH) == 0) THEN
        IF (.NOT. ASSOCIATED (SELF%DEVPTR)) THEN
          ALLOCATE (SELF%DEVPTR, MOLD=SELF%PTR)
          !$acc enter data create (SELF%DEVPTR)
        ENDIF
        CALL FIELD_4D_COPY (SELF%PTR, SELF%DEVPTR, NH2D)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NDEVFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):, SELF%LBOUNDS(3):, SELF%LBOUNDS(4):) => SELF%DEVPTR (:,:,:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NHSTFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_4D_GET_DEVICE_DATA_

  FUNCTION FIELD_4D_GET_DEVICE_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_4D), POINTER, INTENT (IN) :: SELF
    REAL(KIND=JPRB), POINTER :: PTR(:,:,:,:)

    PTR => FIELD_4D_GET_DEVICE_DATA_ (SELF, NRD)

  END FUNCTION FIELD_4D_GET_DEVICE_DATA_RDONLY

  FUNCTION FIELD_4D_GET_DEVICE_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_4D), POINTER, INTENT (IN) :: SELF
    REAL(KIND=JPRB), POINTER :: PTR(:,:,:,:)

    PTR => FIELD_4D_GET_DEVICE_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_4D_GET_DEVICE_DATA_RDWR


  INTEGER (KIND=JPIM) FUNCTION FIELD_5D_GET_LAST_CONTIGUOUS_DIMENSION (PTR) RESULT (JDIM)
  REAL(KIND=JPRB), POINTER :: PTR (:,:,:,:,:)
  INTEGER*8 :: ISTRIDE (5)
  INTEGER (KIND=JPIM) :: J

  ISTRIDE (1) = KIND (PTR)
  DO J = 2, 5
    ISTRIDE (J) = ISTRIDE (J-1) * SIZE (PTR, J-1) 
  ENDDO

  JDIM = 0
  IF (LOC (PTR (2, 1, 1, 1, 1)) - LOC (PTR (1, 1, 1, 1, 1)) /= ISTRIDE (1)) THEN
    RETURN
  ENDIF

  JDIM = 1

  IF (LOC (PTR (1, 2, 1, 1, 1)) - LOC (PTR (1, 1, 1, 1, 1)) /= ISTRIDE (2)) THEN
    RETURN
  ENDIF

  JDIM = 2

  IF (LOC (PTR (1, 1, 2, 1, 1)) - LOC (PTR (1, 1, 1, 1, 1)) /= ISTRIDE (3)) THEN
    RETURN
  ENDIF

  JDIM = 3

  IF (LOC (PTR (1, 1, 1, 2, 1)) - LOC (PTR (1, 1, 1, 1, 1)) /= ISTRIDE (4)) THEN
    RETURN
  ENDIF

  JDIM = 4

  IF (LOC (PTR (1, 1, 1, 1, 2)) - LOC (PTR (1, 1, 1, 1, 1)) /= ISTRIDE (5)) THEN
    RETURN
  ENDIF

  JDIM = 5

  END FUNCTION FIELD_5D_GET_LAST_CONTIGUOUS_DIMENSION

  SUBROUTINE FIELD_5D_COPY (HST, DEV, KDIR)
  REAL(KIND=JPRB), POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
  INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
  INTEGER (KIND=JPIM) :: JDIM

  JDIM = FIELD_5D_GET_LAST_CONTIGUOUS_DIMENSION (HST)

  SELECT CASE (JDIM)
    CASE (0)
      CALL COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    CASE (1)
      CALL COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    CASE (2)
      CALL COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    CASE (3)
      CALL COPY_DIM3_CONTIGUOUS (HST, DEV, KDIR)
    CASE (4)
      CALL COPY_DIM4_CONTIGUOUS (HST, DEV, KDIR)
    CASE (5)
      CALL COPY_DIM5_CONTIGUOUS (HST, DEV, KDIR)
  END SELECT

  CONTAINS

    SUBROUTINE COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    REAL(KIND=JPRB), POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J1, J2, J3, J4, J5

    DO J5 = LBOUND (HST, 5), UBOUND (HST, 5)
      DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
        DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
          DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
            DO J1 = LBOUND (HST, 1), UBOUND (HST, 1)
              ISIZE = KIND (HST)
              IF (KDIR == NH2D) THEN
                !$acc host_data use_device (DEV)
#ifdef _OPENACC
                CALL ACC_MEMCPY_TO_DEVICE (DEV (J1, J2, J3, J4, J5), HST (J1, J2, J3, J4, J5), ISIZE)
#endif
                !$acc end host_data
              ELSEIF (KDIR == ND2H) THEN
                !$acc host_data use_device (DEV)
#ifdef _OPENACC
                CALL ACC_MEMCPY_FROM_DEVICE (HST (J1, J2, J3, J4, J5), DEV (J1, J2, J3, J4, J5), ISIZE)
#endif
                !$acc end host_data
              ENDIF
            ENDDO
          ENDDO
        ENDDO
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    REAL(KIND=JPRB), POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J2, J3, J4, J5

    DO J5 = LBOUND (HST, 5), UBOUND (HST, 5)
      DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
        DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
          DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
            ISIZE = KIND (HST) * SIZE (HST (:, J2, J3, J4, J5))
            IF (KDIR == NH2D) THEN
              !$acc host_data use_device (DEV)
#ifdef _OPENACC
              CALL ACC_MEMCPY_TO_DEVICE (DEV (:, J2, J3, J4, J5), HST (:, J2, J3, J4, J5), ISIZE)
#endif
              !$acc end host_data
            ELSEIF (KDIR == ND2H) THEN
              !$acc host_data use_device (DEV)
#ifdef _OPENACC
              CALL ACC_MEMCPY_FROM_DEVICE (HST (:, J2, J3, J4, J5), DEV (:, J2, J3, J4, J5), ISIZE)
#endif
              !$acc end host_data
            ENDIF
          ENDDO
        ENDDO
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    REAL(KIND=JPRB), POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J3, J4, J5

    DO J5 = LBOUND (HST, 5), UBOUND (HST, 5)
      DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
        DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
          ISIZE = KIND (HST) * SIZE (HST (:, :, J3, J4, J5))
          IF (KDIR == NH2D) THEN
            !$acc host_data use_device (DEV)
#ifdef _OPENACC
            CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, J3, J4, J5), HST (:, :, J3, J4, J5), ISIZE)
#endif
            !$acc end host_data
          ELSEIF (KDIR == ND2H) THEN
            !$acc host_data use_device (DEV)
#ifdef _OPENACC
            CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, J3, J4, J5), DEV (:, :, J3, J4, J5), ISIZE)
#endif
            !$acc end host_data
          ENDIF
        ENDDO
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM3_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    REAL(KIND=JPRB), POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J4, J5

    DO J5 = LBOUND (HST, 5), UBOUND (HST, 5)
      DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
        ISIZE = KIND (HST) * SIZE (HST (:, :, :, J4, J5))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, :, J4, J5), HST (:, :, :, J4, J5), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, :, J4, J5), DEV (:, :, :, J4, J5), ISIZE)
#endif
          !$acc end host_data
        ENDIF
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM4_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    REAL(KIND=JPRB), POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J5

    DO J5 = LBOUND (HST, 5), UBOUND (HST, 5)
      ISIZE = KIND (HST) * SIZE (HST (:, :, :, :, J5))
      IF (KDIR == NH2D) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, :, :, J5), HST (:, :, :, :, J5), ISIZE)
#endif
        !$acc end host_data
      ELSEIF (KDIR == ND2H) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, :, :, J5), DEV (:, :, :, :, J5), ISIZE)
#endif
        !$acc end host_data
      ENDIF
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM5_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    REAL(KIND=JPRB), POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J

        ISIZE = KIND (HST) * SIZE (HST (:, :, :, :, :))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, :, :, :), HST (:, :, :, :, :), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, :, :, :), DEV (:, :, :, :, :), ISIZE)
#endif
          !$acc end host_data
        ENDIF
    END SUBROUTINE

  END SUBROUTINE FIELD_5D_COPY

  FUNCTION FIELD_5D_GET_HOST_DATA_ (SELF, MODE) RESULT (PTR)
    TYPE(FIELD_5D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    REAL(KIND=JPRB), TARGET, SAVE :: ZDUM (1, 1, 1, 1, 1)
    REAL(KIND=JPRB), POINTER :: PTR(:,:,:,:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NHSTFRESH) == 0) THEN
        CALL FIELD_5D_COPY (SELF%PTR, SELF%DEVPTR, ND2H)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NHSTFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):, SELF%LBOUNDS(3):, SELF%LBOUNDS(4):, SELF%LBOUNDS(5):) => SELF%PTR (:,:,:,:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NDEVFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_5D_GET_HOST_DATA_

  FUNCTION FIELD_5D_GET_HOST_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_5D), POINTER, INTENT (IN) :: SELF
    REAL(KIND=JPRB), POINTER :: PTR(:,:,:,:,:)

    PTR => FIELD_5D_GET_HOST_DATA_ (SELF, NRD)

  END FUNCTION FIELD_5D_GET_HOST_DATA_RDONLY

  FUNCTION FIELD_5D_GET_HOST_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_5D), POINTER, INTENT (IN) :: SELF
    REAL(KIND=JPRB), POINTER :: PTR(:,:,:,:,:)

    PTR => FIELD_5D_GET_HOST_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_5D_GET_HOST_DATA_RDWR

  FUNCTION FIELD_5D_GET_DEVICE_DATA_ (SELF, MODE) RESULT(PTR)
    TYPE(FIELD_5D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    REAL(KIND=JPRB), TARGET, SAVE :: ZDUM (1, 1, 1, 1, 1)
    REAL(KIND=JPRB), POINTER :: PTR(:,:,:,:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NDEVFRESH) == 0) THEN
        IF (.NOT. ASSOCIATED (SELF%DEVPTR)) THEN
          ALLOCATE (SELF%DEVPTR, MOLD=SELF%PTR)
          !$acc enter data create (SELF%DEVPTR)
        ENDIF
        CALL FIELD_5D_COPY (SELF%PTR, SELF%DEVPTR, NH2D)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NDEVFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):, SELF%LBOUNDS(3):, SELF%LBOUNDS(4):, SELF%LBOUNDS(5):) => SELF%DEVPTR (:,:,:,:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NHSTFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_5D_GET_DEVICE_DATA_

  FUNCTION FIELD_5D_GET_DEVICE_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_5D), POINTER, INTENT (IN) :: SELF
    REAL(KIND=JPRB), POINTER :: PTR(:,:,:,:,:)

    PTR => FIELD_5D_GET_DEVICE_DATA_ (SELF, NRD)

  END FUNCTION FIELD_5D_GET_DEVICE_DATA_RDONLY

  FUNCTION FIELD_5D_GET_DEVICE_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_5D), POINTER, INTENT (IN) :: SELF
    REAL(KIND=JPRB), POINTER :: PTR(:,:,:,:,:)

    PTR => FIELD_5D_GET_DEVICE_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_5D_GET_DEVICE_DATA_RDWR


  INTEGER (KIND=JPIM) FUNCTION FIELD_INT2D_GET_LAST_CONTIGUOUS_DIMENSION (PTR) RESULT (JDIM)
  INTEGER(KIND=JPIM), POINTER :: PTR (:,:)
  INTEGER*8 :: ISTRIDE (2)
  INTEGER (KIND=JPIM) :: J

  ISTRIDE (1) = KIND (PTR)
  DO J = 2, 2
    ISTRIDE (J) = ISTRIDE (J-1) * SIZE (PTR, J-1) 
  ENDDO

  JDIM = 0
  IF (LOC (PTR (2, 1)) - LOC (PTR (1, 1)) /= ISTRIDE (1)) THEN
    RETURN
  ENDIF

  JDIM = 1

  IF (LOC (PTR (1, 2)) - LOC (PTR (1, 1)) /= ISTRIDE (2)) THEN
    RETURN
  ENDIF

  JDIM = 2

  END FUNCTION FIELD_INT2D_GET_LAST_CONTIGUOUS_DIMENSION

  SUBROUTINE FIELD_INT2D_COPY (HST, DEV, KDIR)
  INTEGER(KIND=JPIM), POINTER :: HST (:,:), DEV (:,:)
  INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
  INTEGER (KIND=JPIM) :: JDIM

  JDIM = FIELD_INT2D_GET_LAST_CONTIGUOUS_DIMENSION (HST)

  SELECT CASE (JDIM)
    CASE (0)
      CALL COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    CASE (1)
      CALL COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    CASE (2)
      CALL COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
  END SELECT

  CONTAINS

    SUBROUTINE COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    INTEGER(KIND=JPIM), POINTER :: HST (:,:), DEV (:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J1, J2

    DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
      DO J1 = LBOUND (HST, 1), UBOUND (HST, 1)
        ISIZE = KIND (HST)
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (J1, J2), HST (J1, J2), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (J1, J2), DEV (J1, J2), ISIZE)
#endif
          !$acc end host_data
        ENDIF
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    INTEGER(KIND=JPIM), POINTER :: HST (:,:), DEV (:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J2

    DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
      ISIZE = KIND (HST) * SIZE (HST (:, J2))
      IF (KDIR == NH2D) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_TO_DEVICE (DEV (:, J2), HST (:, J2), ISIZE)
#endif
        !$acc end host_data
      ELSEIF (KDIR == ND2H) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_FROM_DEVICE (HST (:, J2), DEV (:, J2), ISIZE)
#endif
        !$acc end host_data
      ENDIF
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    INTEGER(KIND=JPIM), POINTER :: HST (:,:), DEV (:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J

        ISIZE = KIND (HST) * SIZE (HST (:, :))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :), HST (:, :), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :), DEV (:, :), ISIZE)
#endif
          !$acc end host_data
        ENDIF
    END SUBROUTINE

  END SUBROUTINE FIELD_INT2D_COPY

  FUNCTION FIELD_INT2D_GET_HOST_DATA_ (SELF, MODE) RESULT (PTR)
    TYPE(FIELD_INT2D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    INTEGER(KIND=JPIM), TARGET, SAVE :: ZDUM (1, 1)
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NHSTFRESH) == 0) THEN
        CALL FIELD_INT2D_COPY (SELF%PTR, SELF%DEVPTR, ND2H)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NHSTFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):) => SELF%PTR (:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NDEVFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_INT2D_GET_HOST_DATA_

  FUNCTION FIELD_INT2D_GET_HOST_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_INT2D), POINTER, INTENT (IN) :: SELF
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:)

    PTR => FIELD_INT2D_GET_HOST_DATA_ (SELF, NRD)

  END FUNCTION FIELD_INT2D_GET_HOST_DATA_RDONLY

  FUNCTION FIELD_INT2D_GET_HOST_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_INT2D), POINTER, INTENT (IN) :: SELF
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:)

    PTR => FIELD_INT2D_GET_HOST_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_INT2D_GET_HOST_DATA_RDWR

  FUNCTION FIELD_INT2D_GET_DEVICE_DATA_ (SELF, MODE) RESULT(PTR)
    TYPE(FIELD_INT2D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    INTEGER(KIND=JPIM), TARGET, SAVE :: ZDUM (1, 1)
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NDEVFRESH) == 0) THEN
        IF (.NOT. ASSOCIATED (SELF%DEVPTR)) THEN
          ALLOCATE (SELF%DEVPTR, MOLD=SELF%PTR)
          !$acc enter data create (SELF%DEVPTR)
        ENDIF
        CALL FIELD_INT2D_COPY (SELF%PTR, SELF%DEVPTR, NH2D)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NDEVFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):) => SELF%DEVPTR (:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NHSTFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_INT2D_GET_DEVICE_DATA_

  FUNCTION FIELD_INT2D_GET_DEVICE_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_INT2D), POINTER, INTENT (IN) :: SELF
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:)

    PTR => FIELD_INT2D_GET_DEVICE_DATA_ (SELF, NRD)

  END FUNCTION FIELD_INT2D_GET_DEVICE_DATA_RDONLY

  FUNCTION FIELD_INT2D_GET_DEVICE_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_INT2D), POINTER, INTENT (IN) :: SELF
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:)

    PTR => FIELD_INT2D_GET_DEVICE_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_INT2D_GET_DEVICE_DATA_RDWR


  INTEGER (KIND=JPIM) FUNCTION FIELD_INT3D_GET_LAST_CONTIGUOUS_DIMENSION (PTR) RESULT (JDIM)
  INTEGER(KIND=JPIM), POINTER :: PTR (:,:,:)
  INTEGER*8 :: ISTRIDE (3)
  INTEGER (KIND=JPIM) :: J

  ISTRIDE (1) = KIND (PTR)
  DO J = 2, 3
    ISTRIDE (J) = ISTRIDE (J-1) * SIZE (PTR, J-1) 
  ENDDO

  JDIM = 0
  IF (LOC (PTR (2, 1, 1)) - LOC (PTR (1, 1, 1)) /= ISTRIDE (1)) THEN
    RETURN
  ENDIF

  JDIM = 1

  IF (LOC (PTR (1, 2, 1)) - LOC (PTR (1, 1, 1)) /= ISTRIDE (2)) THEN
    RETURN
  ENDIF

  JDIM = 2

  IF (LOC (PTR (1, 1, 2)) - LOC (PTR (1, 1, 1)) /= ISTRIDE (3)) THEN
    RETURN
  ENDIF

  JDIM = 3

  END FUNCTION FIELD_INT3D_GET_LAST_CONTIGUOUS_DIMENSION

  SUBROUTINE FIELD_INT3D_COPY (HST, DEV, KDIR)
  INTEGER(KIND=JPIM), POINTER :: HST (:,:,:), DEV (:,:,:)
  INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
  INTEGER (KIND=JPIM) :: JDIM

  JDIM = FIELD_INT3D_GET_LAST_CONTIGUOUS_DIMENSION (HST)

  SELECT CASE (JDIM)
    CASE (0)
      CALL COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    CASE (1)
      CALL COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    CASE (2)
      CALL COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    CASE (3)
      CALL COPY_DIM3_CONTIGUOUS (HST, DEV, KDIR)
  END SELECT

  CONTAINS

    SUBROUTINE COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    INTEGER(KIND=JPIM), POINTER :: HST (:,:,:), DEV (:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J1, J2, J3

    DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
      DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
        DO J1 = LBOUND (HST, 1), UBOUND (HST, 1)
          ISIZE = KIND (HST)
          IF (KDIR == NH2D) THEN
            !$acc host_data use_device (DEV)
#ifdef _OPENACC
            CALL ACC_MEMCPY_TO_DEVICE (DEV (J1, J2, J3), HST (J1, J2, J3), ISIZE)
#endif
            !$acc end host_data
          ELSEIF (KDIR == ND2H) THEN
            !$acc host_data use_device (DEV)
#ifdef _OPENACC
            CALL ACC_MEMCPY_FROM_DEVICE (HST (J1, J2, J3), DEV (J1, J2, J3), ISIZE)
#endif
            !$acc end host_data
          ENDIF
        ENDDO
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    INTEGER(KIND=JPIM), POINTER :: HST (:,:,:), DEV (:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J2, J3

    DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
      DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
        ISIZE = KIND (HST) * SIZE (HST (:, J2, J3))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, J2, J3), HST (:, J2, J3), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, J2, J3), DEV (:, J2, J3), ISIZE)
#endif
          !$acc end host_data
        ENDIF
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    INTEGER(KIND=JPIM), POINTER :: HST (:,:,:), DEV (:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J3

    DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
      ISIZE = KIND (HST) * SIZE (HST (:, :, J3))
      IF (KDIR == NH2D) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, J3), HST (:, :, J3), ISIZE)
#endif
        !$acc end host_data
      ELSEIF (KDIR == ND2H) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, J3), DEV (:, :, J3), ISIZE)
#endif
        !$acc end host_data
      ENDIF
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM3_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    INTEGER(KIND=JPIM), POINTER :: HST (:,:,:), DEV (:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J

        ISIZE = KIND (HST) * SIZE (HST (:, :, :))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, :), HST (:, :, :), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, :), DEV (:, :, :), ISIZE)
#endif
          !$acc end host_data
        ENDIF
    END SUBROUTINE

  END SUBROUTINE FIELD_INT3D_COPY

  FUNCTION FIELD_INT3D_GET_HOST_DATA_ (SELF, MODE) RESULT (PTR)
    TYPE(FIELD_INT3D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    INTEGER(KIND=JPIM), TARGET, SAVE :: ZDUM (1, 1, 1)
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NHSTFRESH) == 0) THEN
        CALL FIELD_INT3D_COPY (SELF%PTR, SELF%DEVPTR, ND2H)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NHSTFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):, SELF%LBOUNDS(3):) => SELF%PTR (:,:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NDEVFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_INT3D_GET_HOST_DATA_

  FUNCTION FIELD_INT3D_GET_HOST_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_INT3D), POINTER, INTENT (IN) :: SELF
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:,:)

    PTR => FIELD_INT3D_GET_HOST_DATA_ (SELF, NRD)

  END FUNCTION FIELD_INT3D_GET_HOST_DATA_RDONLY

  FUNCTION FIELD_INT3D_GET_HOST_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_INT3D), POINTER, INTENT (IN) :: SELF
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:,:)

    PTR => FIELD_INT3D_GET_HOST_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_INT3D_GET_HOST_DATA_RDWR

  FUNCTION FIELD_INT3D_GET_DEVICE_DATA_ (SELF, MODE) RESULT(PTR)
    TYPE(FIELD_INT3D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    INTEGER(KIND=JPIM), TARGET, SAVE :: ZDUM (1, 1, 1)
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NDEVFRESH) == 0) THEN
        IF (.NOT. ASSOCIATED (SELF%DEVPTR)) THEN
          ALLOCATE (SELF%DEVPTR, MOLD=SELF%PTR)
          !$acc enter data create (SELF%DEVPTR)
        ENDIF
        CALL FIELD_INT3D_COPY (SELF%PTR, SELF%DEVPTR, NH2D)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NDEVFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):, SELF%LBOUNDS(3):) => SELF%DEVPTR (:,:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NHSTFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_INT3D_GET_DEVICE_DATA_

  FUNCTION FIELD_INT3D_GET_DEVICE_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_INT3D), POINTER, INTENT (IN) :: SELF
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:,:)

    PTR => FIELD_INT3D_GET_DEVICE_DATA_ (SELF, NRD)

  END FUNCTION FIELD_INT3D_GET_DEVICE_DATA_RDONLY

  FUNCTION FIELD_INT3D_GET_DEVICE_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_INT3D), POINTER, INTENT (IN) :: SELF
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:,:)

    PTR => FIELD_INT3D_GET_DEVICE_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_INT3D_GET_DEVICE_DATA_RDWR


  INTEGER (KIND=JPIM) FUNCTION FIELD_INT4D_GET_LAST_CONTIGUOUS_DIMENSION (PTR) RESULT (JDIM)
  INTEGER(KIND=JPIM), POINTER :: PTR (:,:,:,:)
  INTEGER*8 :: ISTRIDE (4)
  INTEGER (KIND=JPIM) :: J

  ISTRIDE (1) = KIND (PTR)
  DO J = 2, 4
    ISTRIDE (J) = ISTRIDE (J-1) * SIZE (PTR, J-1) 
  ENDDO

  JDIM = 0
  IF (LOC (PTR (2, 1, 1, 1)) - LOC (PTR (1, 1, 1, 1)) /= ISTRIDE (1)) THEN
    RETURN
  ENDIF

  JDIM = 1

  IF (LOC (PTR (1, 2, 1, 1)) - LOC (PTR (1, 1, 1, 1)) /= ISTRIDE (2)) THEN
    RETURN
  ENDIF

  JDIM = 2

  IF (LOC (PTR (1, 1, 2, 1)) - LOC (PTR (1, 1, 1, 1)) /= ISTRIDE (3)) THEN
    RETURN
  ENDIF

  JDIM = 3

  IF (LOC (PTR (1, 1, 1, 2)) - LOC (PTR (1, 1, 1, 1)) /= ISTRIDE (4)) THEN
    RETURN
  ENDIF

  JDIM = 4

  END FUNCTION FIELD_INT4D_GET_LAST_CONTIGUOUS_DIMENSION

  SUBROUTINE FIELD_INT4D_COPY (HST, DEV, KDIR)
  INTEGER(KIND=JPIM), POINTER :: HST (:,:,:,:), DEV (:,:,:,:)
  INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
  INTEGER (KIND=JPIM) :: JDIM

  JDIM = FIELD_INT4D_GET_LAST_CONTIGUOUS_DIMENSION (HST)

  SELECT CASE (JDIM)
    CASE (0)
      CALL COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    CASE (1)
      CALL COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    CASE (2)
      CALL COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    CASE (3)
      CALL COPY_DIM3_CONTIGUOUS (HST, DEV, KDIR)
    CASE (4)
      CALL COPY_DIM4_CONTIGUOUS (HST, DEV, KDIR)
  END SELECT

  CONTAINS

    SUBROUTINE COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    INTEGER(KIND=JPIM), POINTER :: HST (:,:,:,:), DEV (:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J1, J2, J3, J4

    DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
      DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
        DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
          DO J1 = LBOUND (HST, 1), UBOUND (HST, 1)
            ISIZE = KIND (HST)
            IF (KDIR == NH2D) THEN
              !$acc host_data use_device (DEV)
#ifdef _OPENACC
              CALL ACC_MEMCPY_TO_DEVICE (DEV (J1, J2, J3, J4), HST (J1, J2, J3, J4), ISIZE)
#endif
              !$acc end host_data
            ELSEIF (KDIR == ND2H) THEN
              !$acc host_data use_device (DEV)
#ifdef _OPENACC
              CALL ACC_MEMCPY_FROM_DEVICE (HST (J1, J2, J3, J4), DEV (J1, J2, J3, J4), ISIZE)
#endif
              !$acc end host_data
            ENDIF
          ENDDO
        ENDDO
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    INTEGER(KIND=JPIM), POINTER :: HST (:,:,:,:), DEV (:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J2, J3, J4

    DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
      DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
        DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
          ISIZE = KIND (HST) * SIZE (HST (:, J2, J3, J4))
          IF (KDIR == NH2D) THEN
            !$acc host_data use_device (DEV)
#ifdef _OPENACC
            CALL ACC_MEMCPY_TO_DEVICE (DEV (:, J2, J3, J4), HST (:, J2, J3, J4), ISIZE)
#endif
            !$acc end host_data
          ELSEIF (KDIR == ND2H) THEN
            !$acc host_data use_device (DEV)
#ifdef _OPENACC
            CALL ACC_MEMCPY_FROM_DEVICE (HST (:, J2, J3, J4), DEV (:, J2, J3, J4), ISIZE)
#endif
            !$acc end host_data
          ENDIF
        ENDDO
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    INTEGER(KIND=JPIM), POINTER :: HST (:,:,:,:), DEV (:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J3, J4

    DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
      DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
        ISIZE = KIND (HST) * SIZE (HST (:, :, J3, J4))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, J3, J4), HST (:, :, J3, J4), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, J3, J4), DEV (:, :, J3, J4), ISIZE)
#endif
          !$acc end host_data
        ENDIF
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM3_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    INTEGER(KIND=JPIM), POINTER :: HST (:,:,:,:), DEV (:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J4

    DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
      ISIZE = KIND (HST) * SIZE (HST (:, :, :, J4))
      IF (KDIR == NH2D) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, :, J4), HST (:, :, :, J4), ISIZE)
#endif
        !$acc end host_data
      ELSEIF (KDIR == ND2H) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, :, J4), DEV (:, :, :, J4), ISIZE)
#endif
        !$acc end host_data
      ENDIF
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM4_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    INTEGER(KIND=JPIM), POINTER :: HST (:,:,:,:), DEV (:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J

        ISIZE = KIND (HST) * SIZE (HST (:, :, :, :))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, :, :), HST (:, :, :, :), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, :, :), DEV (:, :, :, :), ISIZE)
#endif
          !$acc end host_data
        ENDIF
    END SUBROUTINE

  END SUBROUTINE FIELD_INT4D_COPY

  FUNCTION FIELD_INT4D_GET_HOST_DATA_ (SELF, MODE) RESULT (PTR)
    TYPE(FIELD_INT4D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    INTEGER(KIND=JPIM), TARGET, SAVE :: ZDUM (1, 1, 1, 1)
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:,:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NHSTFRESH) == 0) THEN
        CALL FIELD_INT4D_COPY (SELF%PTR, SELF%DEVPTR, ND2H)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NHSTFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):, SELF%LBOUNDS(3):, SELF%LBOUNDS(4):) => SELF%PTR (:,:,:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NDEVFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_INT4D_GET_HOST_DATA_

  FUNCTION FIELD_INT4D_GET_HOST_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_INT4D), POINTER, INTENT (IN) :: SELF
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:,:,:)

    PTR => FIELD_INT4D_GET_HOST_DATA_ (SELF, NRD)

  END FUNCTION FIELD_INT4D_GET_HOST_DATA_RDONLY

  FUNCTION FIELD_INT4D_GET_HOST_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_INT4D), POINTER, INTENT (IN) :: SELF
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:,:,:)

    PTR => FIELD_INT4D_GET_HOST_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_INT4D_GET_HOST_DATA_RDWR

  FUNCTION FIELD_INT4D_GET_DEVICE_DATA_ (SELF, MODE) RESULT(PTR)
    TYPE(FIELD_INT4D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    INTEGER(KIND=JPIM), TARGET, SAVE :: ZDUM (1, 1, 1, 1)
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:,:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NDEVFRESH) == 0) THEN
        IF (.NOT. ASSOCIATED (SELF%DEVPTR)) THEN
          ALLOCATE (SELF%DEVPTR, MOLD=SELF%PTR)
          !$acc enter data create (SELF%DEVPTR)
        ENDIF
        CALL FIELD_INT4D_COPY (SELF%PTR, SELF%DEVPTR, NH2D)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NDEVFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):, SELF%LBOUNDS(3):, SELF%LBOUNDS(4):) => SELF%DEVPTR (:,:,:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NHSTFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_INT4D_GET_DEVICE_DATA_

  FUNCTION FIELD_INT4D_GET_DEVICE_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_INT4D), POINTER, INTENT (IN) :: SELF
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:,:,:)

    PTR => FIELD_INT4D_GET_DEVICE_DATA_ (SELF, NRD)

  END FUNCTION FIELD_INT4D_GET_DEVICE_DATA_RDONLY

  FUNCTION FIELD_INT4D_GET_DEVICE_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_INT4D), POINTER, INTENT (IN) :: SELF
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:,:,:)

    PTR => FIELD_INT4D_GET_DEVICE_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_INT4D_GET_DEVICE_DATA_RDWR


  INTEGER (KIND=JPIM) FUNCTION FIELD_INT5D_GET_LAST_CONTIGUOUS_DIMENSION (PTR) RESULT (JDIM)
  INTEGER(KIND=JPIM), POINTER :: PTR (:,:,:,:,:)
  INTEGER*8 :: ISTRIDE (5)
  INTEGER (KIND=JPIM) :: J

  ISTRIDE (1) = KIND (PTR)
  DO J = 2, 5
    ISTRIDE (J) = ISTRIDE (J-1) * SIZE (PTR, J-1) 
  ENDDO

  JDIM = 0
  IF (LOC (PTR (2, 1, 1, 1, 1)) - LOC (PTR (1, 1, 1, 1, 1)) /= ISTRIDE (1)) THEN
    RETURN
  ENDIF

  JDIM = 1

  IF (LOC (PTR (1, 2, 1, 1, 1)) - LOC (PTR (1, 1, 1, 1, 1)) /= ISTRIDE (2)) THEN
    RETURN
  ENDIF

  JDIM = 2

  IF (LOC (PTR (1, 1, 2, 1, 1)) - LOC (PTR (1, 1, 1, 1, 1)) /= ISTRIDE (3)) THEN
    RETURN
  ENDIF

  JDIM = 3

  IF (LOC (PTR (1, 1, 1, 2, 1)) - LOC (PTR (1, 1, 1, 1, 1)) /= ISTRIDE (4)) THEN
    RETURN
  ENDIF

  JDIM = 4

  IF (LOC (PTR (1, 1, 1, 1, 2)) - LOC (PTR (1, 1, 1, 1, 1)) /= ISTRIDE (5)) THEN
    RETURN
  ENDIF

  JDIM = 5

  END FUNCTION FIELD_INT5D_GET_LAST_CONTIGUOUS_DIMENSION

  SUBROUTINE FIELD_INT5D_COPY (HST, DEV, KDIR)
  INTEGER(KIND=JPIM), POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
  INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
  INTEGER (KIND=JPIM) :: JDIM

  JDIM = FIELD_INT5D_GET_LAST_CONTIGUOUS_DIMENSION (HST)

  SELECT CASE (JDIM)
    CASE (0)
      CALL COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    CASE (1)
      CALL COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    CASE (2)
      CALL COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    CASE (3)
      CALL COPY_DIM3_CONTIGUOUS (HST, DEV, KDIR)
    CASE (4)
      CALL COPY_DIM4_CONTIGUOUS (HST, DEV, KDIR)
    CASE (5)
      CALL COPY_DIM5_CONTIGUOUS (HST, DEV, KDIR)
  END SELECT

  CONTAINS

    SUBROUTINE COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    INTEGER(KIND=JPIM), POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J1, J2, J3, J4, J5

    DO J5 = LBOUND (HST, 5), UBOUND (HST, 5)
      DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
        DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
          DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
            DO J1 = LBOUND (HST, 1), UBOUND (HST, 1)
              ISIZE = KIND (HST)
              IF (KDIR == NH2D) THEN
                !$acc host_data use_device (DEV)
#ifdef _OPENACC
                CALL ACC_MEMCPY_TO_DEVICE (DEV (J1, J2, J3, J4, J5), HST (J1, J2, J3, J4, J5), ISIZE)
#endif
                !$acc end host_data
              ELSEIF (KDIR == ND2H) THEN
                !$acc host_data use_device (DEV)
#ifdef _OPENACC
                CALL ACC_MEMCPY_FROM_DEVICE (HST (J1, J2, J3, J4, J5), DEV (J1, J2, J3, J4, J5), ISIZE)
#endif
                !$acc end host_data
              ENDIF
            ENDDO
          ENDDO
        ENDDO
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    INTEGER(KIND=JPIM), POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J2, J3, J4, J5

    DO J5 = LBOUND (HST, 5), UBOUND (HST, 5)
      DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
        DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
          DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
            ISIZE = KIND (HST) * SIZE (HST (:, J2, J3, J4, J5))
            IF (KDIR == NH2D) THEN
              !$acc host_data use_device (DEV)
#ifdef _OPENACC
              CALL ACC_MEMCPY_TO_DEVICE (DEV (:, J2, J3, J4, J5), HST (:, J2, J3, J4, J5), ISIZE)
#endif
              !$acc end host_data
            ELSEIF (KDIR == ND2H) THEN
              !$acc host_data use_device (DEV)
#ifdef _OPENACC
              CALL ACC_MEMCPY_FROM_DEVICE (HST (:, J2, J3, J4, J5), DEV (:, J2, J3, J4, J5), ISIZE)
#endif
              !$acc end host_data
            ENDIF
          ENDDO
        ENDDO
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    INTEGER(KIND=JPIM), POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J3, J4, J5

    DO J5 = LBOUND (HST, 5), UBOUND (HST, 5)
      DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
        DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
          ISIZE = KIND (HST) * SIZE (HST (:, :, J3, J4, J5))
          IF (KDIR == NH2D) THEN
            !$acc host_data use_device (DEV)
#ifdef _OPENACC
            CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, J3, J4, J5), HST (:, :, J3, J4, J5), ISIZE)
#endif
            !$acc end host_data
          ELSEIF (KDIR == ND2H) THEN
            !$acc host_data use_device (DEV)
#ifdef _OPENACC
            CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, J3, J4, J5), DEV (:, :, J3, J4, J5), ISIZE)
#endif
            !$acc end host_data
          ENDIF
        ENDDO
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM3_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    INTEGER(KIND=JPIM), POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J4, J5

    DO J5 = LBOUND (HST, 5), UBOUND (HST, 5)
      DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
        ISIZE = KIND (HST) * SIZE (HST (:, :, :, J4, J5))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, :, J4, J5), HST (:, :, :, J4, J5), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, :, J4, J5), DEV (:, :, :, J4, J5), ISIZE)
#endif
          !$acc end host_data
        ENDIF
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM4_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    INTEGER(KIND=JPIM), POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J5

    DO J5 = LBOUND (HST, 5), UBOUND (HST, 5)
      ISIZE = KIND (HST) * SIZE (HST (:, :, :, :, J5))
      IF (KDIR == NH2D) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, :, :, J5), HST (:, :, :, :, J5), ISIZE)
#endif
        !$acc end host_data
      ELSEIF (KDIR == ND2H) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, :, :, J5), DEV (:, :, :, :, J5), ISIZE)
#endif
        !$acc end host_data
      ENDIF
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM5_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    INTEGER(KIND=JPIM), POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J

        ISIZE = KIND (HST) * SIZE (HST (:, :, :, :, :))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, :, :, :), HST (:, :, :, :, :), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, :, :, :), DEV (:, :, :, :, :), ISIZE)
#endif
          !$acc end host_data
        ENDIF
    END SUBROUTINE

  END SUBROUTINE FIELD_INT5D_COPY

  FUNCTION FIELD_INT5D_GET_HOST_DATA_ (SELF, MODE) RESULT (PTR)
    TYPE(FIELD_INT5D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    INTEGER(KIND=JPIM), TARGET, SAVE :: ZDUM (1, 1, 1, 1, 1)
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:,:,:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NHSTFRESH) == 0) THEN
        CALL FIELD_INT5D_COPY (SELF%PTR, SELF%DEVPTR, ND2H)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NHSTFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):, SELF%LBOUNDS(3):, SELF%LBOUNDS(4):, SELF%LBOUNDS(5):) => SELF%PTR (:,:,:,:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NDEVFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_INT5D_GET_HOST_DATA_

  FUNCTION FIELD_INT5D_GET_HOST_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_INT5D), POINTER, INTENT (IN) :: SELF
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:,:,:,:)

    PTR => FIELD_INT5D_GET_HOST_DATA_ (SELF, NRD)

  END FUNCTION FIELD_INT5D_GET_HOST_DATA_RDONLY

  FUNCTION FIELD_INT5D_GET_HOST_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_INT5D), POINTER, INTENT (IN) :: SELF
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:,:,:,:)

    PTR => FIELD_INT5D_GET_HOST_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_INT5D_GET_HOST_DATA_RDWR

  FUNCTION FIELD_INT5D_GET_DEVICE_DATA_ (SELF, MODE) RESULT(PTR)
    TYPE(FIELD_INT5D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    INTEGER(KIND=JPIM), TARGET, SAVE :: ZDUM (1, 1, 1, 1, 1)
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:,:,:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NDEVFRESH) == 0) THEN
        IF (.NOT. ASSOCIATED (SELF%DEVPTR)) THEN
          ALLOCATE (SELF%DEVPTR, MOLD=SELF%PTR)
          !$acc enter data create (SELF%DEVPTR)
        ENDIF
        CALL FIELD_INT5D_COPY (SELF%PTR, SELF%DEVPTR, NH2D)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NDEVFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):, SELF%LBOUNDS(3):, SELF%LBOUNDS(4):, SELF%LBOUNDS(5):) => SELF%DEVPTR (:,:,:,:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NHSTFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_INT5D_GET_DEVICE_DATA_

  FUNCTION FIELD_INT5D_GET_DEVICE_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_INT5D), POINTER, INTENT (IN) :: SELF
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:,:,:,:)

    PTR => FIELD_INT5D_GET_DEVICE_DATA_ (SELF, NRD)

  END FUNCTION FIELD_INT5D_GET_DEVICE_DATA_RDONLY

  FUNCTION FIELD_INT5D_GET_DEVICE_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_INT5D), POINTER, INTENT (IN) :: SELF
    INTEGER(KIND=JPIM), POINTER :: PTR(:,:,:,:,:)

    PTR => FIELD_INT5D_GET_DEVICE_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_INT5D_GET_DEVICE_DATA_RDWR


  INTEGER (KIND=JPIM) FUNCTION FIELD_LOG2D_GET_LAST_CONTIGUOUS_DIMENSION (PTR) RESULT (JDIM)
  LOGICAL, POINTER :: PTR (:,:)
  INTEGER*8 :: ISTRIDE (2)
  INTEGER (KIND=JPIM) :: J

  ISTRIDE (1) = KIND (PTR)
  DO J = 2, 2
    ISTRIDE (J) = ISTRIDE (J-1) * SIZE (PTR, J-1) 
  ENDDO

  JDIM = 0
  IF (LOC (PTR (2, 1)) - LOC (PTR (1, 1)) /= ISTRIDE (1)) THEN
    RETURN
  ENDIF

  JDIM = 1

  IF (LOC (PTR (1, 2)) - LOC (PTR (1, 1)) /= ISTRIDE (2)) THEN
    RETURN
  ENDIF

  JDIM = 2

  END FUNCTION FIELD_LOG2D_GET_LAST_CONTIGUOUS_DIMENSION

  SUBROUTINE FIELD_LOG2D_COPY (HST, DEV, KDIR)
  LOGICAL, POINTER :: HST (:,:), DEV (:,:)
  INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
  INTEGER (KIND=JPIM) :: JDIM

  JDIM = FIELD_LOG2D_GET_LAST_CONTIGUOUS_DIMENSION (HST)

  SELECT CASE (JDIM)
    CASE (0)
      CALL COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    CASE (1)
      CALL COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    CASE (2)
      CALL COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
  END SELECT

  CONTAINS

    SUBROUTINE COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    LOGICAL, POINTER :: HST (:,:), DEV (:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J1, J2

    DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
      DO J1 = LBOUND (HST, 1), UBOUND (HST, 1)
        ISIZE = KIND (HST)
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (J1, J2), HST (J1, J2), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (J1, J2), DEV (J1, J2), ISIZE)
#endif
          !$acc end host_data
        ENDIF
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    LOGICAL, POINTER :: HST (:,:), DEV (:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J2

    DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
      ISIZE = KIND (HST) * SIZE (HST (:, J2))
      IF (KDIR == NH2D) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_TO_DEVICE (DEV (:, J2), HST (:, J2), ISIZE)
#endif
        !$acc end host_data
      ELSEIF (KDIR == ND2H) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_FROM_DEVICE (HST (:, J2), DEV (:, J2), ISIZE)
#endif
        !$acc end host_data
      ENDIF
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    LOGICAL, POINTER :: HST (:,:), DEV (:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J

        ISIZE = KIND (HST) * SIZE (HST (:, :))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :), HST (:, :), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :), DEV (:, :), ISIZE)
#endif
          !$acc end host_data
        ENDIF
    END SUBROUTINE

  END SUBROUTINE FIELD_LOG2D_COPY

  FUNCTION FIELD_LOG2D_GET_HOST_DATA_ (SELF, MODE) RESULT (PTR)
    TYPE(FIELD_LOG2D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    LOGICAL, TARGET, SAVE :: ZDUM (1, 1)
    LOGICAL, POINTER :: PTR(:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NHSTFRESH) == 0) THEN
        CALL FIELD_LOG2D_COPY (SELF%PTR, SELF%DEVPTR, ND2H)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NHSTFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):) => SELF%PTR (:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NDEVFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_LOG2D_GET_HOST_DATA_

  FUNCTION FIELD_LOG2D_GET_HOST_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_LOG2D), POINTER, INTENT (IN) :: SELF
    LOGICAL, POINTER :: PTR(:,:)

    PTR => FIELD_LOG2D_GET_HOST_DATA_ (SELF, NRD)

  END FUNCTION FIELD_LOG2D_GET_HOST_DATA_RDONLY

  FUNCTION FIELD_LOG2D_GET_HOST_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_LOG2D), POINTER, INTENT (IN) :: SELF
    LOGICAL, POINTER :: PTR(:,:)

    PTR => FIELD_LOG2D_GET_HOST_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_LOG2D_GET_HOST_DATA_RDWR

  FUNCTION FIELD_LOG2D_GET_DEVICE_DATA_ (SELF, MODE) RESULT(PTR)
    TYPE(FIELD_LOG2D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    LOGICAL, TARGET, SAVE :: ZDUM (1, 1)
    LOGICAL, POINTER :: PTR(:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NDEVFRESH) == 0) THEN
        IF (.NOT. ASSOCIATED (SELF%DEVPTR)) THEN
          ALLOCATE (SELF%DEVPTR, MOLD=SELF%PTR)
          !$acc enter data create (SELF%DEVPTR)
        ENDIF
        CALL FIELD_LOG2D_COPY (SELF%PTR, SELF%DEVPTR, NH2D)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NDEVFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):) => SELF%DEVPTR (:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NHSTFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_LOG2D_GET_DEVICE_DATA_

  FUNCTION FIELD_LOG2D_GET_DEVICE_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_LOG2D), POINTER, INTENT (IN) :: SELF
    LOGICAL, POINTER :: PTR(:,:)

    PTR => FIELD_LOG2D_GET_DEVICE_DATA_ (SELF, NRD)

  END FUNCTION FIELD_LOG2D_GET_DEVICE_DATA_RDONLY

  FUNCTION FIELD_LOG2D_GET_DEVICE_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_LOG2D), POINTER, INTENT (IN) :: SELF
    LOGICAL, POINTER :: PTR(:,:)

    PTR => FIELD_LOG2D_GET_DEVICE_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_LOG2D_GET_DEVICE_DATA_RDWR


  INTEGER (KIND=JPIM) FUNCTION FIELD_LOG3D_GET_LAST_CONTIGUOUS_DIMENSION (PTR) RESULT (JDIM)
  LOGICAL, POINTER :: PTR (:,:,:)
  INTEGER*8 :: ISTRIDE (3)
  INTEGER (KIND=JPIM) :: J

  ISTRIDE (1) = KIND (PTR)
  DO J = 2, 3
    ISTRIDE (J) = ISTRIDE (J-1) * SIZE (PTR, J-1) 
  ENDDO

  JDIM = 0
  IF (LOC (PTR (2, 1, 1)) - LOC (PTR (1, 1, 1)) /= ISTRIDE (1)) THEN
    RETURN
  ENDIF

  JDIM = 1

  IF (LOC (PTR (1, 2, 1)) - LOC (PTR (1, 1, 1)) /= ISTRIDE (2)) THEN
    RETURN
  ENDIF

  JDIM = 2

  IF (LOC (PTR (1, 1, 2)) - LOC (PTR (1, 1, 1)) /= ISTRIDE (3)) THEN
    RETURN
  ENDIF

  JDIM = 3

  END FUNCTION FIELD_LOG3D_GET_LAST_CONTIGUOUS_DIMENSION

  SUBROUTINE FIELD_LOG3D_COPY (HST, DEV, KDIR)
  LOGICAL, POINTER :: HST (:,:,:), DEV (:,:,:)
  INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
  INTEGER (KIND=JPIM) :: JDIM

  JDIM = FIELD_LOG3D_GET_LAST_CONTIGUOUS_DIMENSION (HST)

  SELECT CASE (JDIM)
    CASE (0)
      CALL COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    CASE (1)
      CALL COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    CASE (2)
      CALL COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    CASE (3)
      CALL COPY_DIM3_CONTIGUOUS (HST, DEV, KDIR)
  END SELECT

  CONTAINS

    SUBROUTINE COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    LOGICAL, POINTER :: HST (:,:,:), DEV (:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J1, J2, J3

    DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
      DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
        DO J1 = LBOUND (HST, 1), UBOUND (HST, 1)
          ISIZE = KIND (HST)
          IF (KDIR == NH2D) THEN
            !$acc host_data use_device (DEV)
#ifdef _OPENACC
            CALL ACC_MEMCPY_TO_DEVICE (DEV (J1, J2, J3), HST (J1, J2, J3), ISIZE)
#endif
            !$acc end host_data
          ELSEIF (KDIR == ND2H) THEN
            !$acc host_data use_device (DEV)
#ifdef _OPENACC
            CALL ACC_MEMCPY_FROM_DEVICE (HST (J1, J2, J3), DEV (J1, J2, J3), ISIZE)
#endif
            !$acc end host_data
          ENDIF
        ENDDO
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    LOGICAL, POINTER :: HST (:,:,:), DEV (:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J2, J3

    DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
      DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
        ISIZE = KIND (HST) * SIZE (HST (:, J2, J3))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, J2, J3), HST (:, J2, J3), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, J2, J3), DEV (:, J2, J3), ISIZE)
#endif
          !$acc end host_data
        ENDIF
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    LOGICAL, POINTER :: HST (:,:,:), DEV (:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J3

    DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
      ISIZE = KIND (HST) * SIZE (HST (:, :, J3))
      IF (KDIR == NH2D) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, J3), HST (:, :, J3), ISIZE)
#endif
        !$acc end host_data
      ELSEIF (KDIR == ND2H) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, J3), DEV (:, :, J3), ISIZE)
#endif
        !$acc end host_data
      ENDIF
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM3_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    LOGICAL, POINTER :: HST (:,:,:), DEV (:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J

        ISIZE = KIND (HST) * SIZE (HST (:, :, :))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, :), HST (:, :, :), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, :), DEV (:, :, :), ISIZE)
#endif
          !$acc end host_data
        ENDIF
    END SUBROUTINE

  END SUBROUTINE FIELD_LOG3D_COPY

  FUNCTION FIELD_LOG3D_GET_HOST_DATA_ (SELF, MODE) RESULT (PTR)
    TYPE(FIELD_LOG3D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    LOGICAL, TARGET, SAVE :: ZDUM (1, 1, 1)
    LOGICAL, POINTER :: PTR(:,:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NHSTFRESH) == 0) THEN
        CALL FIELD_LOG3D_COPY (SELF%PTR, SELF%DEVPTR, ND2H)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NHSTFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):, SELF%LBOUNDS(3):) => SELF%PTR (:,:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NDEVFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_LOG3D_GET_HOST_DATA_

  FUNCTION FIELD_LOG3D_GET_HOST_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_LOG3D), POINTER, INTENT (IN) :: SELF
    LOGICAL, POINTER :: PTR(:,:,:)

    PTR => FIELD_LOG3D_GET_HOST_DATA_ (SELF, NRD)

  END FUNCTION FIELD_LOG3D_GET_HOST_DATA_RDONLY

  FUNCTION FIELD_LOG3D_GET_HOST_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_LOG3D), POINTER, INTENT (IN) :: SELF
    LOGICAL, POINTER :: PTR(:,:,:)

    PTR => FIELD_LOG3D_GET_HOST_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_LOG3D_GET_HOST_DATA_RDWR

  FUNCTION FIELD_LOG3D_GET_DEVICE_DATA_ (SELF, MODE) RESULT(PTR)
    TYPE(FIELD_LOG3D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    LOGICAL, TARGET, SAVE :: ZDUM (1, 1, 1)
    LOGICAL, POINTER :: PTR(:,:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NDEVFRESH) == 0) THEN
        IF (.NOT. ASSOCIATED (SELF%DEVPTR)) THEN
          ALLOCATE (SELF%DEVPTR, MOLD=SELF%PTR)
          !$acc enter data create (SELF%DEVPTR)
        ENDIF
        CALL FIELD_LOG3D_COPY (SELF%PTR, SELF%DEVPTR, NH2D)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NDEVFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):, SELF%LBOUNDS(3):) => SELF%DEVPTR (:,:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NHSTFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_LOG3D_GET_DEVICE_DATA_

  FUNCTION FIELD_LOG3D_GET_DEVICE_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_LOG3D), POINTER, INTENT (IN) :: SELF
    LOGICAL, POINTER :: PTR(:,:,:)

    PTR => FIELD_LOG3D_GET_DEVICE_DATA_ (SELF, NRD)

  END FUNCTION FIELD_LOG3D_GET_DEVICE_DATA_RDONLY

  FUNCTION FIELD_LOG3D_GET_DEVICE_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_LOG3D), POINTER, INTENT (IN) :: SELF
    LOGICAL, POINTER :: PTR(:,:,:)

    PTR => FIELD_LOG3D_GET_DEVICE_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_LOG3D_GET_DEVICE_DATA_RDWR


  INTEGER (KIND=JPIM) FUNCTION FIELD_LOG4D_GET_LAST_CONTIGUOUS_DIMENSION (PTR) RESULT (JDIM)
  LOGICAL, POINTER :: PTR (:,:,:,:)
  INTEGER*8 :: ISTRIDE (4)
  INTEGER (KIND=JPIM) :: J

  ISTRIDE (1) = KIND (PTR)
  DO J = 2, 4
    ISTRIDE (J) = ISTRIDE (J-1) * SIZE (PTR, J-1) 
  ENDDO

  JDIM = 0
  IF (LOC (PTR (2, 1, 1, 1)) - LOC (PTR (1, 1, 1, 1)) /= ISTRIDE (1)) THEN
    RETURN
  ENDIF

  JDIM = 1

  IF (LOC (PTR (1, 2, 1, 1)) - LOC (PTR (1, 1, 1, 1)) /= ISTRIDE (2)) THEN
    RETURN
  ENDIF

  JDIM = 2

  IF (LOC (PTR (1, 1, 2, 1)) - LOC (PTR (1, 1, 1, 1)) /= ISTRIDE (3)) THEN
    RETURN
  ENDIF

  JDIM = 3

  IF (LOC (PTR (1, 1, 1, 2)) - LOC (PTR (1, 1, 1, 1)) /= ISTRIDE (4)) THEN
    RETURN
  ENDIF

  JDIM = 4

  END FUNCTION FIELD_LOG4D_GET_LAST_CONTIGUOUS_DIMENSION

  SUBROUTINE FIELD_LOG4D_COPY (HST, DEV, KDIR)
  LOGICAL, POINTER :: HST (:,:,:,:), DEV (:,:,:,:)
  INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
  INTEGER (KIND=JPIM) :: JDIM

  JDIM = FIELD_LOG4D_GET_LAST_CONTIGUOUS_DIMENSION (HST)

  SELECT CASE (JDIM)
    CASE (0)
      CALL COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    CASE (1)
      CALL COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    CASE (2)
      CALL COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    CASE (3)
      CALL COPY_DIM3_CONTIGUOUS (HST, DEV, KDIR)
    CASE (4)
      CALL COPY_DIM4_CONTIGUOUS (HST, DEV, KDIR)
  END SELECT

  CONTAINS

    SUBROUTINE COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    LOGICAL, POINTER :: HST (:,:,:,:), DEV (:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J1, J2, J3, J4

    DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
      DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
        DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
          DO J1 = LBOUND (HST, 1), UBOUND (HST, 1)
            ISIZE = KIND (HST)
            IF (KDIR == NH2D) THEN
              !$acc host_data use_device (DEV)
#ifdef _OPENACC
              CALL ACC_MEMCPY_TO_DEVICE (DEV (J1, J2, J3, J4), HST (J1, J2, J3, J4), ISIZE)
#endif
              !$acc end host_data
            ELSEIF (KDIR == ND2H) THEN
              !$acc host_data use_device (DEV)
#ifdef _OPENACC
              CALL ACC_MEMCPY_FROM_DEVICE (HST (J1, J2, J3, J4), DEV (J1, J2, J3, J4), ISIZE)
#endif
              !$acc end host_data
            ENDIF
          ENDDO
        ENDDO
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    LOGICAL, POINTER :: HST (:,:,:,:), DEV (:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J2, J3, J4

    DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
      DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
        DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
          ISIZE = KIND (HST) * SIZE (HST (:, J2, J3, J4))
          IF (KDIR == NH2D) THEN
            !$acc host_data use_device (DEV)
#ifdef _OPENACC
            CALL ACC_MEMCPY_TO_DEVICE (DEV (:, J2, J3, J4), HST (:, J2, J3, J4), ISIZE)
#endif
            !$acc end host_data
          ELSEIF (KDIR == ND2H) THEN
            !$acc host_data use_device (DEV)
#ifdef _OPENACC
            CALL ACC_MEMCPY_FROM_DEVICE (HST (:, J2, J3, J4), DEV (:, J2, J3, J4), ISIZE)
#endif
            !$acc end host_data
          ENDIF
        ENDDO
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    LOGICAL, POINTER :: HST (:,:,:,:), DEV (:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J3, J4

    DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
      DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
        ISIZE = KIND (HST) * SIZE (HST (:, :, J3, J4))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, J3, J4), HST (:, :, J3, J4), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, J3, J4), DEV (:, :, J3, J4), ISIZE)
#endif
          !$acc end host_data
        ENDIF
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM3_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    LOGICAL, POINTER :: HST (:,:,:,:), DEV (:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J4

    DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
      ISIZE = KIND (HST) * SIZE (HST (:, :, :, J4))
      IF (KDIR == NH2D) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, :, J4), HST (:, :, :, J4), ISIZE)
#endif
        !$acc end host_data
      ELSEIF (KDIR == ND2H) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, :, J4), DEV (:, :, :, J4), ISIZE)
#endif
        !$acc end host_data
      ENDIF
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM4_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    LOGICAL, POINTER :: HST (:,:,:,:), DEV (:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J

        ISIZE = KIND (HST) * SIZE (HST (:, :, :, :))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, :, :), HST (:, :, :, :), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, :, :), DEV (:, :, :, :), ISIZE)
#endif
          !$acc end host_data
        ENDIF
    END SUBROUTINE

  END SUBROUTINE FIELD_LOG4D_COPY

  FUNCTION FIELD_LOG4D_GET_HOST_DATA_ (SELF, MODE) RESULT (PTR)
    TYPE(FIELD_LOG4D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    LOGICAL, TARGET, SAVE :: ZDUM (1, 1, 1, 1)
    LOGICAL, POINTER :: PTR(:,:,:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NHSTFRESH) == 0) THEN
        CALL FIELD_LOG4D_COPY (SELF%PTR, SELF%DEVPTR, ND2H)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NHSTFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):, SELF%LBOUNDS(3):, SELF%LBOUNDS(4):) => SELF%PTR (:,:,:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NDEVFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_LOG4D_GET_HOST_DATA_

  FUNCTION FIELD_LOG4D_GET_HOST_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_LOG4D), POINTER, INTENT (IN) :: SELF
    LOGICAL, POINTER :: PTR(:,:,:,:)

    PTR => FIELD_LOG4D_GET_HOST_DATA_ (SELF, NRD)

  END FUNCTION FIELD_LOG4D_GET_HOST_DATA_RDONLY

  FUNCTION FIELD_LOG4D_GET_HOST_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_LOG4D), POINTER, INTENT (IN) :: SELF
    LOGICAL, POINTER :: PTR(:,:,:,:)

    PTR => FIELD_LOG4D_GET_HOST_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_LOG4D_GET_HOST_DATA_RDWR

  FUNCTION FIELD_LOG4D_GET_DEVICE_DATA_ (SELF, MODE) RESULT(PTR)
    TYPE(FIELD_LOG4D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    LOGICAL, TARGET, SAVE :: ZDUM (1, 1, 1, 1)
    LOGICAL, POINTER :: PTR(:,:,:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NDEVFRESH) == 0) THEN
        IF (.NOT. ASSOCIATED (SELF%DEVPTR)) THEN
          ALLOCATE (SELF%DEVPTR, MOLD=SELF%PTR)
          !$acc enter data create (SELF%DEVPTR)
        ENDIF
        CALL FIELD_LOG4D_COPY (SELF%PTR, SELF%DEVPTR, NH2D)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NDEVFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):, SELF%LBOUNDS(3):, SELF%LBOUNDS(4):) => SELF%DEVPTR (:,:,:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NHSTFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_LOG4D_GET_DEVICE_DATA_

  FUNCTION FIELD_LOG4D_GET_DEVICE_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_LOG4D), POINTER, INTENT (IN) :: SELF
    LOGICAL, POINTER :: PTR(:,:,:,:)

    PTR => FIELD_LOG4D_GET_DEVICE_DATA_ (SELF, NRD)

  END FUNCTION FIELD_LOG4D_GET_DEVICE_DATA_RDONLY

  FUNCTION FIELD_LOG4D_GET_DEVICE_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_LOG4D), POINTER, INTENT (IN) :: SELF
    LOGICAL, POINTER :: PTR(:,:,:,:)

    PTR => FIELD_LOG4D_GET_DEVICE_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_LOG4D_GET_DEVICE_DATA_RDWR


  INTEGER (KIND=JPIM) FUNCTION FIELD_LOG5D_GET_LAST_CONTIGUOUS_DIMENSION (PTR) RESULT (JDIM)
  LOGICAL, POINTER :: PTR (:,:,:,:,:)
  INTEGER*8 :: ISTRIDE (5)
  INTEGER (KIND=JPIM) :: J

  ISTRIDE (1) = KIND (PTR)
  DO J = 2, 5
    ISTRIDE (J) = ISTRIDE (J-1) * SIZE (PTR, J-1) 
  ENDDO

  JDIM = 0
  IF (LOC (PTR (2, 1, 1, 1, 1)) - LOC (PTR (1, 1, 1, 1, 1)) /= ISTRIDE (1)) THEN
    RETURN
  ENDIF

  JDIM = 1

  IF (LOC (PTR (1, 2, 1, 1, 1)) - LOC (PTR (1, 1, 1, 1, 1)) /= ISTRIDE (2)) THEN
    RETURN
  ENDIF

  JDIM = 2

  IF (LOC (PTR (1, 1, 2, 1, 1)) - LOC (PTR (1, 1, 1, 1, 1)) /= ISTRIDE (3)) THEN
    RETURN
  ENDIF

  JDIM = 3

  IF (LOC (PTR (1, 1, 1, 2, 1)) - LOC (PTR (1, 1, 1, 1, 1)) /= ISTRIDE (4)) THEN
    RETURN
  ENDIF

  JDIM = 4

  IF (LOC (PTR (1, 1, 1, 1, 2)) - LOC (PTR (1, 1, 1, 1, 1)) /= ISTRIDE (5)) THEN
    RETURN
  ENDIF

  JDIM = 5

  END FUNCTION FIELD_LOG5D_GET_LAST_CONTIGUOUS_DIMENSION

  SUBROUTINE FIELD_LOG5D_COPY (HST, DEV, KDIR)
  LOGICAL, POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
  INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
  INTEGER (KIND=JPIM) :: JDIM

  JDIM = FIELD_LOG5D_GET_LAST_CONTIGUOUS_DIMENSION (HST)

  SELECT CASE (JDIM)
    CASE (0)
      CALL COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    CASE (1)
      CALL COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    CASE (2)
      CALL COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    CASE (3)
      CALL COPY_DIM3_CONTIGUOUS (HST, DEV, KDIR)
    CASE (4)
      CALL COPY_DIM4_CONTIGUOUS (HST, DEV, KDIR)
    CASE (5)
      CALL COPY_DIM5_CONTIGUOUS (HST, DEV, KDIR)
  END SELECT

  CONTAINS

    SUBROUTINE COPY_DIM0_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    LOGICAL, POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J1, J2, J3, J4, J5

    DO J5 = LBOUND (HST, 5), UBOUND (HST, 5)
      DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
        DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
          DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
            DO J1 = LBOUND (HST, 1), UBOUND (HST, 1)
              ISIZE = KIND (HST)
              IF (KDIR == NH2D) THEN
                !$acc host_data use_device (DEV)
#ifdef _OPENACC
                CALL ACC_MEMCPY_TO_DEVICE (DEV (J1, J2, J3, J4, J5), HST (J1, J2, J3, J4, J5), ISIZE)
#endif
                !$acc end host_data
              ELSEIF (KDIR == ND2H) THEN
                !$acc host_data use_device (DEV)
#ifdef _OPENACC
                CALL ACC_MEMCPY_FROM_DEVICE (HST (J1, J2, J3, J4, J5), DEV (J1, J2, J3, J4, J5), ISIZE)
#endif
                !$acc end host_data
              ENDIF
            ENDDO
          ENDDO
        ENDDO
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM1_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    LOGICAL, POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J2, J3, J4, J5

    DO J5 = LBOUND (HST, 5), UBOUND (HST, 5)
      DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
        DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
          DO J2 = LBOUND (HST, 2), UBOUND (HST, 2)
            ISIZE = KIND (HST) * SIZE (HST (:, J2, J3, J4, J5))
            IF (KDIR == NH2D) THEN
              !$acc host_data use_device (DEV)
#ifdef _OPENACC
              CALL ACC_MEMCPY_TO_DEVICE (DEV (:, J2, J3, J4, J5), HST (:, J2, J3, J4, J5), ISIZE)
#endif
              !$acc end host_data
            ELSEIF (KDIR == ND2H) THEN
              !$acc host_data use_device (DEV)
#ifdef _OPENACC
              CALL ACC_MEMCPY_FROM_DEVICE (HST (:, J2, J3, J4, J5), DEV (:, J2, J3, J4, J5), ISIZE)
#endif
              !$acc end host_data
            ENDIF
          ENDDO
        ENDDO
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM2_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    LOGICAL, POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J3, J4, J5

    DO J5 = LBOUND (HST, 5), UBOUND (HST, 5)
      DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
        DO J3 = LBOUND (HST, 3), UBOUND (HST, 3)
          ISIZE = KIND (HST) * SIZE (HST (:, :, J3, J4, J5))
          IF (KDIR == NH2D) THEN
            !$acc host_data use_device (DEV)
#ifdef _OPENACC
            CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, J3, J4, J5), HST (:, :, J3, J4, J5), ISIZE)
#endif
            !$acc end host_data
          ELSEIF (KDIR == ND2H) THEN
            !$acc host_data use_device (DEV)
#ifdef _OPENACC
            CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, J3, J4, J5), DEV (:, :, J3, J4, J5), ISIZE)
#endif
            !$acc end host_data
          ENDIF
        ENDDO
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM3_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    LOGICAL, POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J4, J5

    DO J5 = LBOUND (HST, 5), UBOUND (HST, 5)
      DO J4 = LBOUND (HST, 4), UBOUND (HST, 4)
        ISIZE = KIND (HST) * SIZE (HST (:, :, :, J4, J5))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, :, J4, J5), HST (:, :, :, J4, J5), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, :, J4, J5), DEV (:, :, :, J4, J5), ISIZE)
#endif
          !$acc end host_data
        ENDIF
      ENDDO
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM4_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    LOGICAL, POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J, J5

    DO J5 = LBOUND (HST, 5), UBOUND (HST, 5)
      ISIZE = KIND (HST) * SIZE (HST (:, :, :, :, J5))
      IF (KDIR == NH2D) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, :, :, J5), HST (:, :, :, :, J5), ISIZE)
#endif
        !$acc end host_data
      ELSEIF (KDIR == ND2H) THEN
        !$acc host_data use_device (DEV)
#ifdef _OPENACC
        CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, :, :, J5), DEV (:, :, :, :, J5), ISIZE)
#endif
        !$acc end host_data
      ENDIF
    ENDDO
    END SUBROUTINE

    SUBROUTINE COPY_DIM5_CONTIGUOUS (HST, DEV, KDIR)
    USE OPENACC
    LOGICAL, POINTER :: HST (:,:,:,:,:), DEV (:,:,:,:,:)
    INTEGER (KIND=JPIM), INTENT (IN) :: KDIR
    INTEGER (KIND=JPIM) :: ISIZE
    INTEGER :: J

        ISIZE = KIND (HST) * SIZE (HST (:, :, :, :, :))
        IF (KDIR == NH2D) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_TO_DEVICE (DEV (:, :, :, :, :), HST (:, :, :, :, :), ISIZE)
#endif
          !$acc end host_data
        ELSEIF (KDIR == ND2H) THEN
          !$acc host_data use_device (DEV)
#ifdef _OPENACC
          CALL ACC_MEMCPY_FROM_DEVICE (HST (:, :, :, :, :), DEV (:, :, :, :, :), ISIZE)
#endif
          !$acc end host_data
        ENDIF
    END SUBROUTINE

  END SUBROUTINE FIELD_LOG5D_COPY

  FUNCTION FIELD_LOG5D_GET_HOST_DATA_ (SELF, MODE) RESULT (PTR)
    TYPE(FIELD_LOG5D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    LOGICAL, TARGET, SAVE :: ZDUM (1, 1, 1, 1, 1)
    LOGICAL, POINTER :: PTR(:,:,:,:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NHSTFRESH) == 0) THEN
        CALL FIELD_LOG5D_COPY (SELF%PTR, SELF%DEVPTR, ND2H)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NHSTFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):, SELF%LBOUNDS(3):, SELF%LBOUNDS(4):, SELF%LBOUNDS(5):) => SELF%PTR (:,:,:,:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NDEVFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_LOG5D_GET_HOST_DATA_

  FUNCTION FIELD_LOG5D_GET_HOST_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_LOG5D), POINTER, INTENT (IN) :: SELF
    LOGICAL, POINTER :: PTR(:,:,:,:,:)

    PTR => FIELD_LOG5D_GET_HOST_DATA_ (SELF, NRD)

  END FUNCTION FIELD_LOG5D_GET_HOST_DATA_RDONLY

  FUNCTION FIELD_LOG5D_GET_HOST_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_LOG5D), POINTER, INTENT (IN) :: SELF
    LOGICAL, POINTER :: PTR(:,:,:,:,:)

    PTR => FIELD_LOG5D_GET_HOST_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_LOG5D_GET_HOST_DATA_RDWR

  FUNCTION FIELD_LOG5D_GET_DEVICE_DATA_ (SELF, MODE) RESULT(PTR)
    TYPE(FIELD_LOG5D), POINTER, INTENT (IN) :: SELF
    INTEGER (KIND=JPIM),                INTENT (IN) :: MODE
    LOGICAL, TARGET, SAVE :: ZDUM (1, 1, 1, 1, 1)
    LOGICAL, POINTER :: PTR(:,:,:,:,:)

    IF (ASSOCIATED (SELF)) THEN
      IF (IAND (SELF%ISTATUS, NDEVFRESH) == 0) THEN
        IF (.NOT. ASSOCIATED (SELF%DEVPTR)) THEN
          ALLOCATE (SELF%DEVPTR, MOLD=SELF%PTR)
          !$acc enter data create (SELF%DEVPTR)
        ENDIF
        CALL FIELD_LOG5D_COPY (SELF%PTR, SELF%DEVPTR, NH2D)
        SELF%ISTATUS = IOR (SELF%ISTATUS, NDEVFRESH)
      ENDIF
      PTR (SELF%LBOUNDS(1):, SELF%LBOUNDS(2):, SELF%LBOUNDS(3):, SELF%LBOUNDS(4):, SELF%LBOUNDS(5):) => SELF%DEVPTR (:,:,:,:,:)
      IF (IAND (MODE, NWR) /= 0) THEN
        SELF%ISTATUS = IAND (SELF%ISTATUS, NOT (NHSTFRESH))
      ENDIF
    ELSE
      PTR => ZDUM
    ENDIF

  END FUNCTION FIELD_LOG5D_GET_DEVICE_DATA_

  FUNCTION FIELD_LOG5D_GET_DEVICE_DATA_RDONLY (SELF) RESULT (PTR)
    TYPE(FIELD_LOG5D), POINTER, INTENT (IN) :: SELF
    LOGICAL, POINTER :: PTR(:,:,:,:,:)

    PTR => FIELD_LOG5D_GET_DEVICE_DATA_ (SELF, NRD)

  END FUNCTION FIELD_LOG5D_GET_DEVICE_DATA_RDONLY

  FUNCTION FIELD_LOG5D_GET_DEVICE_DATA_RDWR (SELF) RESULT (PTR)
    TYPE(FIELD_LOG5D), POINTER, INTENT (IN) :: SELF
    LOGICAL, POINTER :: PTR(:,:,:,:,:)

    PTR => FIELD_LOG5D_GET_DEVICE_DATA_ (SELF, IOR (NRD, NWR))

  END FUNCTION FIELD_LOG5D_GET_DEVICE_DATA_RDWR



  SUBROUTINE CREATE_TEMPORARY_2D_LU (FIELD_PTR, UBOUNDS, LBOUNDS, PERSISTENT) 

    TYPE(FIELD_2D), POINTER :: FIELD_PTR
    INTEGER(KIND=JPIM), INTENT(IN) :: UBOUNDS (2)
    INTEGER(KIND=JPIM), OPTIONAL, INTENT(IN) :: LBOUNDS (2)
    LOGICAL, OPTIONAL, INTENT(IN) :: PERSISTENT
    INTEGER(KIND=JPIM) :: NBLOCKS
    INTEGER(KIND=JPIM) :: ISIZE (2)

    ISIZE = UBOUNDS
    IF (PRESENT (LBOUNDS)) ISIZE = ISIZE - LBOUNDS + 1

    ALLOCATE(FIELD_PTR)
    NBLOCKS = UBOUNDS (2)
    CALL ALLOCATE_FIELD (FIELD_PTR, SHAPE=ISIZE(1:2-1), NBLOCKS=NBLOCKS, PERSISTENT=PERSISTENT, LBOUNDS=LBOUNDS)

    FIELD_PTR%ISTATUS = NHSTFRESH
    FIELD_PTR%PTR => FIELD_PTR%DATA

  END SUBROUTINE CREATE_TEMPORARY_2D_LU

  SUBROUTINE CREATE_TEMPORARY_3D_LU (FIELD_PTR, UBOUNDS, LBOUNDS, PERSISTENT) 

    TYPE(FIELD_3D), POINTER :: FIELD_PTR
    INTEGER(KIND=JPIM), INTENT(IN) :: UBOUNDS (3)
    INTEGER(KIND=JPIM), OPTIONAL, INTENT(IN) :: LBOUNDS (3)
    LOGICAL, OPTIONAL, INTENT(IN) :: PERSISTENT
    INTEGER(KIND=JPIM) :: NBLOCKS
    INTEGER(KIND=JPIM) :: ISIZE (3)

    ISIZE = UBOUNDS
    IF (PRESENT (LBOUNDS)) ISIZE = ISIZE - LBOUNDS + 1

    ALLOCATE(FIELD_PTR)
    NBLOCKS = UBOUNDS (3)
    CALL ALLOCATE_FIELD (FIELD_PTR, SHAPE=ISIZE(1:3-1), NBLOCKS=NBLOCKS, PERSISTENT=PERSISTENT, LBOUNDS=LBOUNDS)

    FIELD_PTR%ISTATUS = NHSTFRESH
    FIELD_PTR%PTR => FIELD_PTR%DATA

  END SUBROUTINE CREATE_TEMPORARY_3D_LU

  SUBROUTINE CREATE_TEMPORARY_4D_LU (FIELD_PTR, UBOUNDS, LBOUNDS, PERSISTENT) 

    TYPE(FIELD_4D), POINTER :: FIELD_PTR
    INTEGER(KIND=JPIM), INTENT(IN) :: UBOUNDS (4)
    INTEGER(KIND=JPIM), OPTIONAL, INTENT(IN) :: LBOUNDS (4)
    LOGICAL, OPTIONAL, INTENT(IN) :: PERSISTENT
    INTEGER(KIND=JPIM) :: NBLOCKS
    INTEGER(KIND=JPIM) :: ISIZE (4)

    ISIZE = UBOUNDS
    IF (PRESENT (LBOUNDS)) ISIZE = ISIZE - LBOUNDS + 1

    ALLOCATE(FIELD_PTR)
    NBLOCKS = UBOUNDS (4)
    CALL ALLOCATE_FIELD (FIELD_PTR, SHAPE=ISIZE(1:4-1), NBLOCKS=NBLOCKS, PERSISTENT=PERSISTENT, LBOUNDS=LBOUNDS)

    FIELD_PTR%ISTATUS = NHSTFRESH
    FIELD_PTR%PTR => FIELD_PTR%DATA

  END SUBROUTINE CREATE_TEMPORARY_4D_LU

  SUBROUTINE CREATE_TEMPORARY_5D_LU (FIELD_PTR, UBOUNDS, LBOUNDS, PERSISTENT) 

    TYPE(FIELD_5D), POINTER :: FIELD_PTR
    INTEGER(KIND=JPIM), INTENT(IN) :: UBOUNDS (5)
    INTEGER(KIND=JPIM), OPTIONAL, INTENT(IN) :: LBOUNDS (5)
    LOGICAL, OPTIONAL, INTENT(IN) :: PERSISTENT
    INTEGER(KIND=JPIM) :: NBLOCKS
    INTEGER(KIND=JPIM) :: ISIZE (5)

    ISIZE = UBOUNDS
    IF (PRESENT (LBOUNDS)) ISIZE = ISIZE - LBOUNDS + 1

    ALLOCATE(FIELD_PTR)
    NBLOCKS = UBOUNDS (5)
    CALL ALLOCATE_FIELD (FIELD_PTR, SHAPE=ISIZE(1:5-1), NBLOCKS=NBLOCKS, PERSISTENT=PERSISTENT, LBOUNDS=LBOUNDS)

    FIELD_PTR%ISTATUS = NHSTFRESH
    FIELD_PTR%PTR => FIELD_PTR%DATA

  END SUBROUTINE CREATE_TEMPORARY_5D_LU

  SUBROUTINE CREATE_TEMPORARY_INT2D_LU (FIELD_PTR, UBOUNDS, LBOUNDS, PERSISTENT) 

    TYPE(FIELD_INT2D), POINTER :: FIELD_PTR
    INTEGER(KIND=JPIM), INTENT(IN) :: UBOUNDS (2)
    INTEGER(KIND=JPIM), OPTIONAL, INTENT(IN) :: LBOUNDS (2)
    LOGICAL, OPTIONAL, INTENT(IN) :: PERSISTENT
    INTEGER(KIND=JPIM) :: NBLOCKS
    INTEGER(KIND=JPIM) :: ISIZE (2)

    ISIZE = UBOUNDS
    IF (PRESENT (LBOUNDS)) ISIZE = ISIZE - LBOUNDS + 1

    ALLOCATE(FIELD_PTR)
    NBLOCKS = UBOUNDS (2)
    CALL ALLOCATE_FIELD (FIELD_PTR, SHAPE=ISIZE(1:2-1), NBLOCKS=NBLOCKS, PERSISTENT=PERSISTENT, LBOUNDS=LBOUNDS)

    FIELD_PTR%ISTATUS = NHSTFRESH
    FIELD_PTR%PTR => FIELD_PTR%DATA

  END SUBROUTINE CREATE_TEMPORARY_INT2D_LU

  SUBROUTINE CREATE_TEMPORARY_INT3D_LU (FIELD_PTR, UBOUNDS, LBOUNDS, PERSISTENT) 

    TYPE(FIELD_INT3D), POINTER :: FIELD_PTR
    INTEGER(KIND=JPIM), INTENT(IN) :: UBOUNDS (3)
    INTEGER(KIND=JPIM), OPTIONAL, INTENT(IN) :: LBOUNDS (3)
    LOGICAL, OPTIONAL, INTENT(IN) :: PERSISTENT
    INTEGER(KIND=JPIM) :: NBLOCKS
    INTEGER(KIND=JPIM) :: ISIZE (3)

    ISIZE = UBOUNDS
    IF (PRESENT (LBOUNDS)) ISIZE = ISIZE - LBOUNDS + 1

    ALLOCATE(FIELD_PTR)
    NBLOCKS = UBOUNDS (3)
    CALL ALLOCATE_FIELD (FIELD_PTR, SHAPE=ISIZE(1:3-1), NBLOCKS=NBLOCKS, PERSISTENT=PERSISTENT, LBOUNDS=LBOUNDS)

    FIELD_PTR%ISTATUS = NHSTFRESH
    FIELD_PTR%PTR => FIELD_PTR%DATA

  END SUBROUTINE CREATE_TEMPORARY_INT3D_LU

  SUBROUTINE CREATE_TEMPORARY_LOG2D_LU (FIELD_PTR, UBOUNDS, LBOUNDS, PERSISTENT) 

    TYPE(FIELD_LOG2D), POINTER :: FIELD_PTR
    INTEGER(KIND=JPIM), INTENT(IN) :: UBOUNDS (2)
    INTEGER(KIND=JPIM), OPTIONAL, INTENT(IN) :: LBOUNDS (2)
    LOGICAL, OPTIONAL, INTENT(IN) :: PERSISTENT
    INTEGER(KIND=JPIM) :: NBLOCKS
    INTEGER(KIND=JPIM) :: ISIZE (2)

    ISIZE = UBOUNDS
    IF (PRESENT (LBOUNDS)) ISIZE = ISIZE - LBOUNDS + 1

    ALLOCATE(FIELD_PTR)
    NBLOCKS = UBOUNDS (2)
    CALL ALLOCATE_FIELD (FIELD_PTR, SHAPE=ISIZE(1:2-1), NBLOCKS=NBLOCKS, PERSISTENT=PERSISTENT, LBOUNDS=LBOUNDS)

    FIELD_PTR%ISTATUS = NHSTFRESH
    FIELD_PTR%PTR => FIELD_PTR%DATA

  END SUBROUTINE CREATE_TEMPORARY_LOG2D_LU


END MODULE FIELD_HELPER_MODULE
