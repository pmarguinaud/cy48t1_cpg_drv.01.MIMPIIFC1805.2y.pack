!
! Copyright 2011 ECMWF
!
! This software was developed at ECMWF for evaluation
! and may be used for academic and research purposes only.
! The software is provided as is without any warranty.
!
! This software can be used, copied and modified but not
! redistributed or sold. This notice must be reproduced
! on each copy made.
!

!> Handle geometry for the IFS model

MODULE GEOMETRY_MOD

USE PARKIND1 , ONLY : JPIM, JPRB
USE TYPE_GEOMETRY, ONLY : GEOMETRY
USE YOMLUN, ONLY : NULOUT

IMPLICIT NONE
PRIVATE

PUBLIC :: GEOMETRY_CLONE, GEOMETRY_DELETE, GEOMETRY_SAME, GEOMETRY

SAVE
INTEGER(KIND=JPIM), PRIVATE :: NUSEGEOM=0

! ------------------------------------------------------------------------------

CONTAINS


! ------------------------------------------------------------------------------

! ------------------------------------------------------------------------------

SUBROUTINE GEOMETRY_CLONE(SELF,OTHER)
USE YOMHOOK  , ONLY : LHOOK, DR_HOOK
IMPLICIT NONE

TYPE(GEOMETRY), INTENT(INOUT) :: SELF
TYPE(GEOMETRY), INTENT(INOUT)    :: OTHER

REAL(KIND=JPRB) :: ZHOOK_HANDLE

#include "abor1.intfb.h"

IF (LHOOK) CALL DR_HOOK('GEOMETRY_MOD:GEOMETRY_CLONE',0,ZHOOK_HANDLE)

CALL ABOR1("GEOMETRY_MOD:GEOMETRY_CLONE not implemented")

IF (LHOOK) CALL DR_HOOK('GEOMETRY_MOD:GEOMETRY_CLONE',1,ZHOOK_HANDLE)

END SUBROUTINE GEOMETRY_CLONE

! ------------------------------------------------------------------------------

SUBROUTINE GEOMETRY_DELETE(SELF)
USE YOMHOOK  , ONLY : LHOOK, DR_HOOK
USE YOMCSGEOM, ONLY : DEALLO_TCSGEOM, DEALLO_TCSGEOM_NB, DEALLO_TCSGEOM_B
USE YOMGSGEOM, ONLY : DEALLO_TGSGEOM, DEALLO_TGSGEOM_NB, DEALLO_TGSGEOM_B
USE YOMVERT  , ONLY : DEALLOC_VERTICAL_GEOM
IMPLICIT NONE

TYPE(GEOMETRY), INTENT(INOUT) :: SELF

REAL(KIND=JPRB) :: ZHOOK_HANDLE

IF (LHOOK) CALL DR_HOOK('GEOMETRY_MOD:GEOMETRY_DELETE',0,ZHOOK_HANDLE)

IF (NUSEGEOM>0) CALL ABOR1("GEOMETRY_MOD:GEOMETRY_DELETE geometry is in use")

CALL DEALLO_TCSGEOM(SELF%YRCSGEOM)
CALL DEALLO_TCSGEOM_NB(SELF%YRCSGEOM_NB)
CALL DEALLO_TGSGEOM(SELF%YRGSGEOM)
CALL DEALLO_TGSGEOM_NB(SELF%YRGSGEOM_NB)
CALL DEALLO_TGSGEOM_B(SELF%YRGSGEOM_B)
CALL DEALLO_TCSGEOM_B(SELF%YRCSGEOM_B)

IF (SELF%AD_GEOM) THEN
CALL DEALLO_TCSGEOM(SELF%YRCSGEOMAD)
CALL DEALLO_TCSGEOM_NB(SELF%YRCSGEOMAD_NB)
CALL DEALLO_TGSGEOM(SELF%YRGSGEOMAD)
CALL DEALLO_TGSGEOM_NB(SELF%YRGSGEOMAD_NB)
ENDIF

CALL DEALLOC_VERTICAL_GEOM(SELF%YRVERT_GEOM)

IF (LHOOK) CALL DR_HOOK('GEOMETRY_MOD:GEOMETRY_DELETE',1,ZHOOK_HANDLE)

END SUBROUTINE GEOMETRY_DELETE
! ------------------------------------------------------------------------------
FUNCTION GEOMETRY_SAME(SELF,OTHER)
USE YOMHOOK  , ONLY : LHOOK, DR_HOOK
LOGICAL :: GEOMETRY_SAME
TYPE(GEOMETRY), INTENT(IN) :: SELF
TYPE(GEOMETRY), INTENT(IN)    :: OTHER

LOGICAL :: LLSAME
REAL(KIND=JPRB) :: ZHOOK_HANDLE

IF (LHOOK) CALL DR_HOOK('GEOMETRY_MOD:GEOMETRY_SAME',0,ZHOOK_HANDLE)
LLSAME = .TRUE.
LLSAME = LLSAME .AND. SELF%YRDIM%NSMAX == OTHER%YRDIM%NSMAX
LLSAME = LLSAME .AND. SELF%YRGEM%NGPTOTG == OTHER%YRGEM%NGPTOTG
IF(.NOT.LLSAME) THEN
  WRITE(NULOUT,*) 'GEOMETRY_SAME=FALSE ',SELF%YRDIM%NSMAX,OTHER%YRDIM%NSMAX,&
   & SELF%YRGEM%NGPTOTG,OTHER%YRGEM%NGPTOTG
ENDIF
GEOMETRY_SAME = LLSAME
IF (LHOOK) CALL DR_HOOK('GEOMETRY_MOD:GEOMETRY_SAME',1,ZHOOK_HANDLE)

END FUNCTION GEOMETRY_SAME
! ------------------------------------------------------------------------------

END MODULE GEOMETRY_MOD
