SUBROUTINE ACNPART_CLOUD_COVER(YDCST,YDML_PHY_MF,KIDIA,KFDIA,KLON,KTDIA,KLEV,PDECRDRED,PWMXOV,KL1,KL2,PDECRD,PNEB,PAPRSF,PCLC)

USE MODEL_PHYSICS_MF_MOD , ONLY : MODEL_PHYSICS_MF_TYPE
USE PARKIND1  ,ONLY : JPIM     ,JPRB
USE YOMHOOK   ,ONLY : LHOOK    ,DR_HOOK
USE YOMCST   , ONLY : TCST

! Interface:
! ----------
! INPUT:
!   KL1    - initial level
!   KL2    - final level
!   PNEB   - cloud cover on levels
!   PAPRSF - full level pressure

! OUTPUT:
!   PCLC   - cloud cover between model levels KL1 and KL2

TYPE (TCST), INTENT (IN) :: YDCST
TYPE(MODEL_PHYSICS_MF_TYPE),INTENT(IN):: YDML_PHY_MF
INTEGER(KIND=JPIM),INTENT(IN)    :: KIDIA 
INTEGER(KIND=JPIM),INTENT(IN)    :: KFDIA 
INTEGER(KIND=JPIM),INTENT(IN)    :: KLON 
INTEGER(KIND=JPIM),INTENT(IN)    :: KTDIA 
INTEGER(KIND=JPIM),INTENT(IN)    :: KLEV 
REAL(KIND=JPRB),   INTENT(IN)    :: PDECRDRED
REAL(KIND=JPRB),   INTENT(IN)    :: PWMXOV

INTEGER(KIND=JPIM),INTENT(IN) :: KL1
INTEGER(KIND=JPIM),INTENT(IN) :: KL2

REAL(KIND=JPRB),INTENT(IN)  :: PDECRD(KLON)
REAL(KIND=JPRB),INTENT(IN)  :: PNEB  (KLON,KLEV)
REAL(KIND=JPRB),INTENT(IN)  :: PAPRSF(KLON,KLEV)
REAL(KIND=JPRB),INTENT(OUT) :: PCLC  (KLON)

INTEGER(KIND=JPIM) :: JLON,JLEV

REAL(KIND=JPRB) :: ZCLOV
REAL(KIND=JPRB) :: ZHOOK_HANDLE

REAL(KIND=JPRB) :: ZOVLP(KLON)

IF (LHOOK) CALL DR_HOOK('ACNPART_CLOUD_COVER',0,ZHOOK_HANDLE)
ASSOCIATE(LACPANMX=>YDML_PHY_MF%YRPHY%LACPANMX, &
 &        LRNUMX  =>YDML_PHY_MF%YRPHY%LRNUMX,   &
 &        LRNUEXP =>YDML_PHY_MF%YRPHY%LRNUEXP)

! initialize cloud cover or its complement
IF (LRNUMX.AND.LACPANMX) THEN
  DO JLON=KIDIA,KFDIA
    PCLC(JLON)=1._JPRB-PNEB(JLON,KL1)
  ENDDO
ELSE
  DO JLON=KIDIA,KFDIA
    PCLC(JLON)=PNEB(JLON,KL1)
  ENDDO
ENDIF
 
! compute cloud cover using actual overlap hypothesis
DO JLEV=KL1+1,KL2

  IF (LRNUMX.AND.LACPANMX) THEN

    ! nearly maximum-random overlap
    DO JLON=KIDIA,KFDIA
      ZOVLP(JLON)=(MIN(1.0_JPRB-PNEB(JLON,JLEV),1.0_JPRB-PWMXOV*&
       & PNEB(JLON,JLEV-1)))/(1.0_JPRB-PWMXOV*PNEB(JLON,JLEV-1))
    ENDDO

  ELSEIF (LRNUMX.AND.LRNUEXP) THEN

    ! exponential-random overlap
    DO JLON=KIDIA,KFDIA
      ZCLOV      =EXP((PAPRSF(JLON,JLEV-1)-PAPRSF(JLON,JLEV))/&
       & (PDECRDRED*PDECRD(JLON)))
      ZOVLP(JLON)=(1._JPRB-ZCLOV)*PNEB(JLON,JLEV)*PNEB(JLON,JLEV-1)+&
       & ZCLOV*MIN(PNEB(JLON,JLEV),PNEB(JLON,JLEV-1))
    ENDDO

  ELSEIF (LRNUMX) THEN

    ! maximum-random overlap
    DO JLON=KIDIA,KFDIA
      ZOVLP(JLON)=MIN(PNEB(JLON,JLEV),PNEB(JLON,JLEV-1))
    ENDDO

  ELSE

    ! random overlap
    DO JLON=KIDIA,KFDIA
      ZOVLP(JLON)=PNEB(JLON,JLEV)*PNEB(JLON,JLEV-1)
    ENDDO

  ENDIF

  ! update cloud cover
  IF (LRNUMX.AND.LACPANMX) THEN
    DO JLON=KIDIA,KFDIA
      PCLC(JLON)=PCLC(JLON)*ZOVLP(JLON)
    ENDDO
  ELSE
    DO JLON=KIDIA,KFDIA
      PCLC(JLON)=PCLC(JLON)+(PNEB(JLON,JLEV)-ZOVLP(JLON))*&
       & (1._JPRB-PCLC(JLON))/(1._JPRB-PNEB(JLON,JLEV-1))
    ENDDO
  ENDIF

ENDDO

! convert complement of cloud cover to cloud cover
IF (LRNUMX.AND.LACPANMX) THEN
  DO JLON=KIDIA,KFDIA
    PCLC(JLON)=1._JPRB-PCLC(JLON)
  ENDDO
ENDIF

END ASSOCIATE
IF (LHOOK) CALL DR_HOOK('ACNPART_CLOUD_COVER',1,ZHOOK_HANDLE)

END SUBROUTINE ACNPART_CLOUD_COVER
