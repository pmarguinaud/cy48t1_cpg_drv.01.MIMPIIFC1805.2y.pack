SUBROUTINE ACNPART_CLOUD_COVER_WMO(YDCST,YDML_PHY_MF,KIDIA,KFDIA,KLON,KTDIA,KLEV,PDECRDRED,PWMXOV,PDECRD,PNEB,PAPHI,PAPRSF,PCLCH,PCLCM,PCLCL)

USE MODEL_PHYSICS_MF_MOD , ONLY : MODEL_PHYSICS_MF_TYPE
USE PARKIND1  ,ONLY : JPIM     ,JPRB
USE YOMHOOK   ,ONLY : LHOOK    ,DR_HOOK
USE YOMCST   , ONLY : TCST

! Interface:
! ----------
! INPUT:
!   PNEB   - cloud cover on levels
!   PAPHI  - half level geopotential
!   PAPRSF - full level pressure

! OUTPUT:
!   PCLCH  - high cloud cover
!   PCLCM  - medium cloud cover
!   PCLCL  - low cloud cover

TYPE (TCST), INTENT (IN) :: YDCST
TYPE(MODEL_PHYSICS_MF_TYPE),INTENT(IN):: YDML_PHY_MF
INTEGER(KIND=JPIM),INTENT(IN)    :: KIDIA 
INTEGER(KIND=JPIM),INTENT(IN)    :: KFDIA 
INTEGER(KIND=JPIM),INTENT(IN)    :: KLON 
INTEGER(KIND=JPIM),INTENT(IN)    :: KTDIA 
INTEGER(KIND=JPIM),INTENT(IN)    :: KLEV 
REAL(KIND=JPRB),   INTENT(IN)    :: PDECRDRED
REAL(KIND=JPRB),   INTENT(IN)    :: PWMXOV

REAL(KIND=JPRB),INTENT(IN)  :: PDECRD(KLON)
REAL(KIND=JPRB),INTENT(IN)  :: PNEB  (KLON,  KLEV)
REAL(KIND=JPRB),INTENT(IN)  :: PAPHI (KLON,0:KLEV)
REAL(KIND=JPRB),INTENT(IN)  :: PAPRSF(KLON,  KLEV)
REAL(KIND=JPRB),INTENT(OUT) :: PCLCH (KLON)
REAL(KIND=JPRB),INTENT(OUT) :: PCLCM (KLON)
REAL(KIND=JPRB),INTENT(OUT) :: PCLCL (KLON)

INTEGER(KIND=JPIM) :: JLON,JLEV

REAL(KIND=JPRB) :: ZCLOV,ZH,ZL
REAL(KIND=JPRB) :: ZHOOK_HANDLE

REAL(KIND=JPRB) :: ZOVLP(KLON)

IF (LHOOK) CALL DR_HOOK('ACNPART_CLOUD_COVER_WMO',0,ZHOOK_HANDLE)
ASSOCIATE(HWMOLOW =>YDML_PHY_MF%YRPHY2%HWMOLOW,  &
 &        HWMOHIGH=>YDML_PHY_MF%YRPHY2%HWMOHIGH, &
 &        LACPANMX=>YDML_PHY_MF%YRPHY%LACPANMX,  &
 &        LRNUMX  =>YDML_PHY_MF%YRPHY%LRNUMX,    &
 &        LRNUEXP =>YDML_PHY_MF%YRPHY%LRNUEXP)

! initialize high cloud cover or its complement
IF (LRNUMX.AND.LACPANMX) THEN
  DO JLON=KIDIA,KFDIA
    PCLCH(JLON)=1._JPRB-PNEB(JLON,KTDIA)
  ENDDO
ELSE
  DO JLON=KIDIA,KFDIA
    PCLCH(JLON)=PNEB(JLON,KTDIA)
  ENDDO
ENDIF

! compute cloud cover using actual overlap hypothesis
DO JLEV=KTDIA+1,KLEV
  IF (LRNUMX.AND.LACPANMX) THEN

    ! nearly maximum-random overlap
    DO JLON=KIDIA,KFDIA
      ZOVLP(JLON)=(MIN(1.0_JPRB-PNEB(JLON,JLEV),1.0_JPRB-PWMXOV*&
       & PNEB(JLON,JLEV-1)))/(1.0_JPRB-PWMXOV*PNEB(JLON,JLEV-1))
    ENDDO

  ELSEIF (LRNUMX.AND.LRNUEXP) THEN

    ! exponential-random overlap
    DO JLON=KIDIA,KFDIA
      ZCLOV      =EXP((PAPRSF(JLON,JLEV-1)-PAPRSF(JLON,JLEV))/&
       & (PDECRDRED*PDECRD(JLON)))
      ZOVLP(JLON)=(1._JPRB-ZCLOV)*PNEB(JLON,JLEV)*PNEB(JLON,JLEV-1)+&
       & ZCLOV*MIN(PNEB(JLON,JLEV),PNEB(JLON,JLEV-1))
    ENDDO

  ELSEIF (LRNUMX) THEN

    ! maximum-random overlap
    DO JLON=KIDIA,KFDIA
      ZOVLP(JLON)=MIN(PNEB(JLON,JLEV),PNEB(JLON,JLEV-1))
    ENDDO

  ELSE

    ! random overlap
    DO JLON=KIDIA,KFDIA
      ZOVLP(JLON)=PNEB(JLON,JLEV)*PNEB(JLON,JLEV-1)
    ENDDO

  ENDIF

  ! update cloud cover
  IF (LRNUMX.AND.LACPANMX) THEN
    DO JLON=KIDIA,KFDIA
      ZH=(PAPHI(JLON,JLEV-1)-PAPHI(JLON,KLEV))/YDCST%RG
      ZL=(PAPHI(JLON,JLEV  )-PAPHI(JLON,KLEV))/YDCST%RG
      IF (ZL >= HWMOHIGH) THEN
        PCLCH(JLON)=PCLCH(JLON)*ZOVLP(JLON)
      ELSEIF (ZH >= HWMOHIGH) THEN
        PCLCM(JLON)=1._JPRB-PNEB(JLON,JLEV)  ! complement of high cloud cover
      ELSEIF (ZL >= HWMOLOW) THEN
        PCLCM(JLON)=PCLCM(JLON)*ZOVLP(JLON)
      ELSEIF (ZH >= HWMOLOW) THEN
        PCLCL(JLON)=1._JPRB-PNEB(JLON,JLEV)  ! complement of low cloud cover
      ELSE
        PCLCL(JLON)=PCLCL(JLON)*ZOVLP(JLON)
      ENDIF
    ENDDO
  ELSE
    DO JLON=KIDIA,KFDIA
      ZH=(PAPHI(JLON,JLEV-1)-PAPHI(JLON,KLEV))/YDCST%RG
      ZL=(PAPHI(JLON,JLEV  )-PAPHI(JLON,KLEV))/YDCST%RG
      IF (ZL >= HWMOHIGH) THEN
        PCLCH(JLON)=PCLCH(JLON)+(PNEB(JLON,JLEV)-ZOVLP(JLON))*&
         & (1._JPRB-PCLCH(JLON))/(1._JPRB-PNEB(JLON,JLEV-1))
      ELSEIF (ZH >= HWMOHIGH) THEN
        PCLCM(JLON)=PNEB(JLON,JLEV)  ! initialize medium cloud cover
      ELSEIF (ZL >= HWMOLOW) THEN
        PCLCM(JLON)=PCLCM(JLON)+(PNEB(JLON,JLEV)-ZOVLP(JLON))*&
         & (1._JPRB-PCLCM(JLON))/(1._JPRB-PNEB(JLON,JLEV-1))
      ELSEIF (ZH >= HWMOLOW) THEN
        PCLCL(JLON)=PNEB(JLON,JLEV)  ! initialize low cloud cover
      ELSE
        PCLCL(JLON)=PCLCL(JLON)+(PNEB(JLON,JLEV)-ZOVLP(JLON))*&
         & (1._JPRB-PCLCL(JLON))/(1._JPRB-PNEB(JLON,JLEV-1))
      ENDIF
    ENDDO
  ENDIF

ENDDO

! convert complement of cloud cover to cloud cover
IF (LRNUMX.AND.LACPANMX) THEN
  DO JLON=KIDIA,KFDIA
    PCLCH(JLON)=1._JPRB-PCLCH(JLON)
    PCLCM(JLON)=1._JPRB-PCLCM(JLON)
    PCLCL(JLON)=1._JPRB-PCLCL(JLON)
  ENDDO
ENDIF

END ASSOCIATE
IF (LHOOK) CALL DR_HOOK('ACNPART_CLOUD_COVER_WMO',1,ZHOOK_HANDLE)

END SUBROUTINE ACNPART_CLOUD_COVER_WMO
