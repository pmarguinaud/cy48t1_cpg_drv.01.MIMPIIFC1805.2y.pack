SUBROUTINE ACNPART_CONV_BASE_TOP(YDCST,YDML_PHY_MF,KIDIA,KFDIA,KLON,KTDIA,KLEV,PNEBC,PAPRSF,PAPHIF,PTOPC)

USE MODEL_PHYSICS_MF_MOD , ONLY : MODEL_PHYSICS_MF_TYPE
USE PARKIND1  ,ONLY : JPIM     ,JPRB
USE YOMHOOK   ,ONLY : LHOOK    ,DR_HOOK
USE YOMCST   , ONLY : TCST

 ! TOP  of convective cloud
 ! If BASE is needed, add PBASEC in the arguments of this subroutine.

! Interface:
! ----------
! INPUT:
!   PNEBC     - convective cloud cover on levels (protected from 0 and 1,
!               missing in AROME)
!   PAPRSF    - full level pressure
! OUTPUT :
!!   PBASEC    - BASE of convective cloud [Pa] 
!   PTOPC     - TOP of convective cloud  [Pa]

TYPE (TCST), INTENT (IN) :: YDCST
TYPE(MODEL_PHYSICS_MF_TYPE),INTENT(IN):: YDML_PHY_MF
INTEGER(KIND=JPIM),INTENT(IN)    :: KIDIA 
INTEGER(KIND=JPIM),INTENT(IN)    :: KFDIA 
INTEGER(KIND=JPIM),INTENT(IN)    :: KLON 
INTEGER(KIND=JPIM),INTENT(IN)    :: KTDIA 
INTEGER(KIND=JPIM),INTENT(IN)    :: KLEV 

REAL(KIND=JPRB)   ,INTENT(IN)    :: PNEBC(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PAPRSF(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PAPHIF(KLON,KLEV)
!REAL(KIND=JPRB)  ,INTENT(OUT)   :: PBASEC(KLON) ! Base desactivated
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTOPC(KLON)

REAL(KIND=JPRB) :: ZNCCRIT, ZALPHA(KLON),ZBETA(KLON),ZABINV(KLON)
INTEGER(KIND=JPIM) :: JLON,JLEV
INTEGER(KIND=JPIM) :: JCTOP(KLON), JCBASE(KLON)

REAL(KIND=JPRB) :: ZHOOK_HANDLE
IF (LHOOK) CALL DR_HOOK('ACNPART_CONV_BASE_TOP',0,ZHOOK_HANDLE)

ASSOCIATE(GTOPDEPTH=>YDML_PHY_MF%YRPHY0%GTOPDEPTH)

ZNCCRIT=0.1_JPRB
JCTOP(KIDIA:KFDIA) = KLEV
JCBASE(KIDIA:KFDIA)= KLEV
! Recherche de la base et du sommet
DO JLEV=KLEV-1,1,-1
    DO JLON=KIDIA,KFDIA
      !On renverse la coordonnees verticale (KLEV-JLEV), 
      JCTOP(JLON)=KLEV-MAX((KLEV-JLEV)*INT(SIGN(1._JPRB,PNEBC(JLON,JLEV) &
            & -ZNCCRIT)),(KLEV-JCTOP(JLON)))
      JCBASE(JLON)=KLEV-MAX((KLEV-JLEV)*SIGN(1_JPIM,JCTOP(JLON)-KLEV), &
                     & KLEV-JCBASE(JLON))
    ENDDO
ENDDO
! Critere epaisseur 
!If NEBUL < 10%, JCBASE=1 et JCTOP=KLEV
DO JLON=KIDIA,KFDIA
  JCTOP(JLON)= KLEV-MAX((KLEV-JCTOP(JLON)) &
   & *INT(SIGN(1._JPRB,((PAPHIF(JLON,JCTOP(JLON))- & 
   & PAPHIF(JLON,JCBASE(JLON)))/YDCST%RG)-GTOPDEPTH)),0_JPIM)
ENDDO

DO JLON=KIDIA,KFDIA
  !Mise Ã  KLEV si pas de base convective
  !JCBASE(JLON)=MAX(SIGN(1_JPIM,JCBASE(JLON)-2_JPIM),0_JPIM)*JCBASE(JLON)&
  !          & +MAX(SIGN(1_JPIM,1_JPIM-JCBASE(JLON)),0_JPIM)*KLEV

  ! Interpolation lineaire sur Z de la base
  !ZALPHA(JLON)=ABS(PNEBC(JLON,JCBASE(JLON)-1_JPIM)-ZNCCRIT) !danger
  !ZBETA(JLON)= ABS(ZNCCRIT-PNEBC(JLON,JCBASE(JLON)))
  !ZABINV(JLON)=1._JPRB/(ZALPHA(JLON)+ZBETA(JLON))
  !PBASEC(JLON)=PAPRSF(JLON,JCBASE(JLON))*ZALPHA(JLON)*ZABINV(JLON) & 
  !     & + PAPRSF(JLON,JCBASE(JLON)-1_JPIM)*ZBETA(JLON)*ZABINV(JLON)

  ! Interpolation lineaire sur P du sommet 
  ZALPHA(JLON)=ABS(PNEBC(JLON,JCTOP(JLON))-ZNCCRIT)
  ZBETA(JLON)= ABS(ZNCCRIT-PNEBC(JLON,JCTOP(JLON)-1_JPIM))
  ZABINV(JLON)=1._JPRB/(ZALPHA(JLON)+ZBETA(JLON))
  PTOPC(JLON) = PAPRSF(JLON,JCTOP(JLON))*ZBETA(JLON)*ZABINV(JLON) &
           & +PAPRSF(JLON,JCTOP(JLON)-1_JPIM)*ZALPHA(JLON)*ZABINV(JLON)

  PTOPC(JLON) =  PAPRSF(JLON,KLEV) * FLOAT(MAX(0_JPIM, SIGN(1_JPIM, JCTOP(JLON)-KLEV)))&
    &         +  PTOPC(JLON)       * FLOAT(MAX(0_JPIM, SIGN(1_JPIM, KLEV-JCTOP(JLON)-1_JPIM)))
ENDDO



END ASSOCIATE
IF (LHOOK) CALL DR_HOOK('ACNPART_CONV_BASE_TOP',1,ZHOOK_HANDLE)
END SUBROUTINE ACNPART_CONV_BASE_TOP
