SUBROUTINE APL_AROME_CALC_IPTR (YDMODEL, KEFB1, KEFB2, KEFB3, KPTR, KPTREXT, KPTRLIMA, KPTRTKE, KRR)

USE PARKIND1, ONLY : JPIM, JPRB

USE TYPE_MODEL         , ONLY : MODEL


IMPLICIT NONE

TYPE(MODEL),        INTENT (IN)  :: YDMODEL
INTEGER(KIND=JPIM), INTENT (OUT) :: KPTREXT,KEFB1,KEFB2,KEFB3
INTEGER(KIND=JPIM), INTENT (OUT) :: KPTR(YDMODEL%YRML_GCONF%YGFL%NUMFLDS)
INTEGER(KIND=JPIM), INTENT (OUT) :: KPTRLIMA
INTEGER(KIND=JPIM), INTENT (OUT) :: KPTRTKE
INTEGER(KIND=JPIM), INTENT (OUT) :: KRR


INTEGER(KIND=JPIM) :: IPTR_CONT
INTEGER(KIND=JPIM) :: JGFL


KPTR(:) = 0 ! means no fields defined in ZGFLTENDR at start ; > 0 means defined.

! * ZTENDR     
KRR=1
IPTR_CONT = KRR
IF (YDMODEL%YRML_GCONF%YGFL%YQ%LACTIVE) THEN
  KPTR(YDMODEL%YRML_GCONF%YGFL%YQ%MP1) = IPTR_CONT ; IPTR_CONT = IPTR_CONT+1
ENDIF   
IF (YDMODEL%YRML_GCONF%YGFL%YL%LACTIVE) THEN
  KPTR(YDMODEL%YRML_GCONF%YGFL%YL%MP1) = IPTR_CONT ; IPTR_CONT = IPTR_CONT+1
ENDIF   
IF (YDMODEL%YRML_GCONF%YGFL%YR%LACTIVE) THEN
  KPTR(YDMODEL%YRML_GCONF%YGFL%YR%MP1) = IPTR_CONT ; IPTR_CONT = IPTR_CONT+1
ENDIF   
IF (YDMODEL%YRML_GCONF%YGFL%YI%LACTIVE) THEN
  KPTR(YDMODEL%YRML_GCONF%YGFL%YI%MP1) = IPTR_CONT ; IPTR_CONT = IPTR_CONT+1
ENDIF   
IF (YDMODEL%YRML_GCONF%YGFL%YS%LACTIVE) THEN
  KPTR(YDMODEL%YRML_GCONF%YGFL%YS%MP1) = IPTR_CONT ; IPTR_CONT = IPTR_CONT+1
ENDIF   
IF (YDMODEL%YRML_GCONF%YGFL%YG%LACTIVE) THEN
  KPTR(YDMODEL%YRML_GCONF%YGFL%YG%MP1) = IPTR_CONT ; IPTR_CONT = IPTR_CONT+1
ENDIF   
IF (YDMODEL%YRML_GCONF%YGFL%YH%LACTIVE) THEN
  KPTR(YDMODEL%YRML_GCONF%YGFL%YH%MP1) = IPTR_CONT ; IPTR_CONT = IPTR_CONT+1
ENDIF   

! * ZTENDTKE   
IF (YDMODEL%YRML_GCONF%YGFL%YTKE%LACTIVE) THEN
  KPTR(YDMODEL%YRML_GCONF%YGFL%YTKE%MP1) = IPTR_CONT ; IPTR_CONT = IPTR_CONT+1
  KPTRTKE=KPTR(YDMODEL%YRML_GCONF%YGFL%YTKE%MP1)
ELSE
  KPTRTKE=0
ENDIF

! * ZTENDEFB1 ZTENDEFB2 ZTENDEFB3
IF (YDMODEL%YRML_GCONF%YGFL%YEFB1%LACTIVE) THEN
  KPTR(YDMODEL%YRML_GCONF%YGFL%YEFB1%MP1) = IPTR_CONT ; IPTR_CONT = IPTR_CONT+1
  KEFB1 = KPTR(YDMODEL%YRML_GCONF%YGFL%YEFB1%MP1)
ELSE
  KEFB1 = 0
ENDIF   

IF (YDMODEL%YRML_GCONF%YGFL%YEFB2%LACTIVE) THEN
  KPTR(YDMODEL%YRML_GCONF%YGFL%YEFB2%MP1) = IPTR_CONT ; IPTR_CONT = IPTR_CONT+1
  KEFB2 = KPTR(YDMODEL%YRML_GCONF%YGFL%YEFB2%MP1)
ELSE
  KEFB2 = 0
ENDIF

IF (YDMODEL%YRML_GCONF%YGFL%YEFB3%LACTIVE) THEN   
  KPTR(YDMODEL%YRML_GCONF%YGFL%YEFB3%MP1) = IPTR_CONT ; IPTR_CONT = IPTR_CONT+1
  KEFB3 = KPTR(YDMODEL%YRML_GCONF%YGFL%YEFB3%MP1)
ELSE
  KEFB3 = 0
ENDIF

! * ZTENDEXT
IF (YDMODEL%YRML_GCONF%YGFL%NGFL_EXT > 0) THEN
  DO JGFL=1,YDMODEL%YRML_GCONF%YGFL%NGFL_EXT
    IF (YDMODEL%YRML_GCONF%YGFL%YEXT(JGFL)%LACTIVE) THEN   
      KPTR(YDMODEL%YRML_GCONF%YGFL%YEXT(JGFL)%MP1)=IPTR_CONT
      IPTR_CONT = IPTR_CONT+1   
    ENDIF
  ENDDO  
  KPTREXT=KPTR(YDMODEL%YRML_GCONF%YGFL%YEXT(1)%MP1)  
ELSE
  KPTREXT=0
ENDIF

! * LIMA
IF (YDMODEL%YRML_GCONF%YGFL%NLIMA > 0) THEN
  DO JGFL=1,YDMODEL%YRML_GCONF%YGFL%NLIMA
    IF (YDMODEL%YRML_GCONF%YGFL%YLIMA(JGFL)%LACTIVE) THEN   
      KPTR(YDMODEL%YRML_GCONF%YGFL%YLIMA(JGFL)%MP1)=IPTR_CONT
      IPTR_CONT = IPTR_CONT+1   
    ENDIF
  ENDDO  
  KPTRLIMA=KPTR(YDMODEL%YRML_GCONF%YGFL%YLIMA(1)%MP1)  
ELSE
  KPTRLIMA=0
ENDIF



END SUBROUTINE
