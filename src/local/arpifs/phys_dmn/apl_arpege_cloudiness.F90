SUBROUTINE APL_ARPEGE_CLOUDINESS (YDMF_PHYS_BASE_STATE, YDCPG_BNDS, YDCPG_OPTS, YDCPG_MISC,        &
& YDMF_PHYS, YDVARS, YDMODEL, LDREDPR, PAIPCMT, PBLH, PDECRD, PFLU_QSAT, PMSC_QW, PNEBC0,          &
& PNEBCH, PNEBS, PNEBS0, PNEB_CVPP, PPFL_FPLCH, PQI, PQL, PQLIS, PQLIS0, PQLI_CVP, PQLI_CVPP, PQV, &
& PUNEBH, YDSTA)

USE YOMHOOK, ONLY : LHOOK, DR_HOOK
USE PARKIND1, ONLY : JPIM, JPRB

USE MF_PHYS_BASE_STATE_TYPE_MOD &
                       , ONLY : MF_PHYS_BASE_STATE_TYPE
USE CPG_OPTS_TYPE_MOD   , ONLY : CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE CPG_TYPE_MOD       , ONLY : CPG_MISC_TYPE, CPG_DYN_TYPE, &
                              & CPG_SL2_TYPE, CPG_GPAR_TYPE
USE MF_PHYS_TYPE_MOD   , ONLY : MF_PHYS_TYPE
USE FIELD_VARIABLES_MOD, ONLY : FIELD_VARIABLES
USE TYPE_MODEL         , ONLY : MODEL
USE YOMSTA             , ONLY : TSTA

IMPLICIT NONE

TYPE (MF_PHYS_BASE_STATE_TYPE), INTENT(IN)    :: YDMF_PHYS_BASE_STATE
TYPE(CPG_BNDS_TYPE),            INTENT(IN)    :: YDCPG_BNDS
TYPE(CPG_OPTS_TYPE),            INTENT(IN)    :: YDCPG_OPTS
TYPE(CPG_MISC_TYPE),            INTENT(INOUT) :: YDCPG_MISC
TYPE(MF_PHYS_TYPE),             INTENT(INOUT) :: YDMF_PHYS
TYPE(FIELD_VARIABLES),          INTENT(INOUT) :: YDVARS
TYPE(MODEL),                    INTENT(IN)    :: YDMODEL
LOGICAL,                        INTENT(IN)    :: LDREDPR
REAL(KIND=JPRB),                INTENT(IN)    :: PAIPCMT(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PBLH(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PDECRD(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PFLU_QSAT (YDCPG_OPTS%KLON, 1:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PMSC_QW (YDCPG_OPTS%KLON, 1:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(INOUT) :: PNEBC0(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(INOUT) :: PNEBCH(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PNEBS(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PNEBS0(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PNEB_CVPP(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PPFL_FPLCH (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQI(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQL(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PQLIS(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PQLIS0(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQLI_CVP(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQLI_CVPP(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQV(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PUNEBH(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
TYPE(TSTA),                     INTENT(IN)    :: YDSTA

#include "acnebcond.intfb.h"
#include "acnebn.intfb.h"
#include "acnpart.intfb.h"

REAL(KIND=JPRB) :: ZICEFR1(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)! Resolved Condensate ice fraction
REAL(KIND=JPRB) :: ZRHCRI(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG) ! Smith scheme critical RH
REAL(KIND=JPRB) :: ZQSATS(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG) ! QSAT of resolved cond./evap. scheme
REAL(KIND=JPRB) :: ZRH(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)    ! Temporar storage for updated PRH
REAL(KIND=JPRB) :: ZCLCT_RAD(YDCPG_OPTS%KLON) ! total cloud cover for radiation

INTEGER (KIND=JPIM) :: JLEV
INTEGER (KIND=JPIM) :: JLON

REAL (KIND=JPRB) :: ZHOOK_HANDLE

IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_CLOUDINESS', 0, ZHOOK_HANDLE)

! CLOUDINESS COMPUTATION
CALL ACNEBCOND (YDMODEL%YRCST, YDMODEL%YRML_GCONF%YRRIP, YDMODEL%YRML_PHY_MF, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_OPTS%KLON, &
& YDMODEL%YRML_PHY_MF%YRTOPH%NTPLUI, YDCPG_OPTS%KFLEVG, LDREDPR, YDSTA, YDMF_PHYS_BASE_STATE%YCPG_DYN%PHI,           &
& YDMF_PHYS_BASE_STATE%YCPG_DYN%PHIF, YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYDF, YDMF_PHYS_BASE_STATE%YCPG_DYN%RCP%CP,   &
& YDMF_PHYS_BASE_STATE%YCPG_DYN%RCP%R, YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%DELP, YDCPG_MISC%RH, PBLH,                  &
& PQV, PQI, PQL, PMSC_QW, YDMF_PHYS_BASE_STATE%T, PNEBCH, YDVARS%GEOMETRY%GM%T0, YDMF_PHYS_BASE_STATE%YGSP_RR%T,     &
& PQLIS, PNEBS, ZRHCRI, ZRH, ZQSATS, ZICEFR1, PQLIS0, PNEBS0)



IF(YDMODEL%YRML_PHY_MF%YRPHY%LNEBN) THEN
  CALL ACNEBN (YDMODEL%YRCST, YDMODEL%YRML_PHY_MF, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_OPTS%KLON, YDMODEL%YRML_PHY_MF%YRTOPH%NTNEBU, &
  & YDCPG_OPTS%KFLEVG, YDMF_PHYS_BASE_STATE%YCPG_DYN%PHIF, YDMF_PHYS_BASE_STATE%YCPG_DYN%RCP%CP, PQV,                                      &
  & PQL, PQI, PFLU_QSAT, YDMF_PHYS_BASE_STATE%T, PPFL_FPLCH, YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%DELP,                                       &
  & YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%RDELP, YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYDF, PUNEBH, PNEBS0,                                        &
  & PQLIS0, PQLI_CVP, PNEB_CVPP, PQLI_CVPP, PAIPCMT, YDCPG_MISC%NEB, PNEBC0, YDCPG_MISC%QICE, YDCPG_MISC%QLI,                              &
  & YDSTA)
  DO JLEV=YDCPG_OPTS%KTDIA,YDCPG_OPTS%KFLEVG
!DEC$ IVDEP
    DO JLON=YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
      YDCPG_MISC%NEB(JLON,JLEV)=YDCPG_MISC%NEB(JLON,JLEV)*YDMODEL%YRML_PHY_MF%YRPHY0%GAEPS
    ENDDO
  ENDDO
ENDIF

!         Diagnostique de nebulosite partielle.
CALL ACNPART(YDMODEL%YRCST, YDMODEL%YRML_PHY_MF, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_OPTS%KLON, YDMODEL%YRML_PHY_MF%YRTOPH%NTNEBU,  &
& YDCPG_OPTS%KFLEVG, YDMF_PHYS_BASE_STATE%YCPG_DYN%PHI, YDMF_PHYS_BASE_STATE%YCPG_DYN%PHIF, YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYDF,        &
& PDECRD, YDCPG_MISC%NEB, YDMF_PHYS%OUT%CLCH, YDMF_PHYS%OUT%CLCM, YDMF_PHYS%OUT%CLCL, YDCPG_MISC%CLCT,                                    &
& ZCLCT_RAD, PCLCC=YDMF_PHYS%OUT%CLCC, PNEBC=PNEBC0, PTOPC=YDMF_PHYS%OUT%CTOP)  

IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_CLOUDINESS', 1, ZHOOK_HANDLE)

END SUBROUTINE APL_ARPEGE_CLOUDINESS
