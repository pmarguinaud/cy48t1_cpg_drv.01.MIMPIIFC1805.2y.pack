SUBROUTINE APL_ARPEGE_DPRECIPS (YDMF_PHYS_BASE_STATE, YDCPG_BNDS, YDCPG_OPTS, YDMF_PHYS, YDVARS, YDMODEL, PPRC_DPRECIPS, PPRC_DPRECIPS2)

!**** *APL_ARPEGE_DPRECIPS*

!     Author. 
!     ------- 
!      Philippe Marguinaud *METEO-FRANCE*
!      Original : 28-04-2021

USE PARKIND1, ONLY : JPIM, JPRB
USE YOMHOOK, ONLY : LHOOK, DR_HOOK

USE MF_PHYS_BASE_STATE_TYPE_MOD &
                       , ONLY : MF_PHYS_BASE_STATE_TYPE
USE CPG_OPTS_TYPE_MOD  , ONLY : CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE MF_PHYS_TYPE_MOD   , ONLY : MF_PHYS_TYPE
USE FIELD_VARIABLES_MOD, ONLY : FIELD_VARIABLES
USE TYPE_MODEL         , ONLY : MODEL


IMPLICIT NONE

TYPE(MF_PHYS_BASE_STATE_TYPE),  INTENT(IN)    :: YDMF_PHYS_BASE_STATE
TYPE(CPG_BNDS_TYPE),            INTENT(IN)    :: YDCPG_BNDS
TYPE(CPG_OPTS_TYPE),            INTENT(IN)    :: YDCPG_OPTS
TYPE(MF_PHYS_TYPE),             INTENT(INOUT) :: YDMF_PHYS
TYPE(FIELD_VARIABLES),          INTENT(INOUT) :: YDVARS
TYPE(MODEL),                    INTENT(IN)    :: YDMODEL
REAL(KIND=JPRB),                INTENT(OUT)   :: PPRC_DPRECIPS  (YDCPG_OPTS%KLON, 1:YDCPG_OPTS%NDTPREC)
REAL(KIND=JPRB),                INTENT(OUT)   :: PPRC_DPRECIPS2 (YDCPG_OPTS%KLON, 1:YDCPG_OPTS%NDTPREC2)


#include "dprecips.intfb.h"
#include "ppwetpoint.intfb.h"

REAL(KIND=JPRB) :: ZDZZ(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZFPLC(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZFPLS(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZFPLSG(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZTW(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZZZ (YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)

REAL(KIND=JPRB) :: ZINVG
INTEGER (KIND=JPIM) :: JLEV
INTEGER (KIND=JPIM) :: JLON

REAL (KIND=JPRB) :: ZHOOK_HANDLE

IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_DPRECIPS', 0, ZHOOK_HANDLE)

!=PARALLEL

! Compute wet-bulb temperature

DO JLEV=1,YDCPG_OPTS%KFLEVG
  CALL PPWETPOINT(YDMODEL%YRCST, YDMODEL%YRML_PHY_MF%YRPHY, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_OPTS%KLON, &
  & YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYDF(:, JLEV), YDMF_PHYS_BASE_STATE%T(:, JLEV), YDMF_PHYS_BASE_STATE%Q(:, JLEV), &
  & YDMF_PHYS_BASE_STATE%L(:, JLEV), YDMF_PHYS_BASE_STATE%I(:, JLEV), ZTW(:, JLEV))
ENDDO

DO JLON = YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
  ZFPLS(JLON,YDCPG_OPTS%KFLEVG)=YDMF_PHYS%OUT%FPLCN(JLON,YDCPG_OPTS%KFLEVG)+YDMF_PHYS%OUT%FPLSN(JLON,YDCPG_OPTS%KFLEVG)
  ZFPLC(JLON,YDCPG_OPTS%KFLEVG)=YDMF_PHYS%OUT%FPLCL(JLON,YDCPG_OPTS%KFLEVG)+YDMF_PHYS%OUT%FPLSL(JLON,YDCPG_OPTS%KFLEVG)
  ZFPLSG(JLON,YDCPG_OPTS%KFLEVG)=0._JPRB
ENDDO

! Initialisation de ZZZ
DO JLEV = 1,YDCPG_OPTS%KFLEVG
  DO JLON = YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
    ZZZ(JLON,JLEV)=YDMF_PHYS_BASE_STATE%YCPG_DYN%PHI(JLON,JLEV)*ZINVG
  ENDDO
ENDDO

! Initialisation de ZDZZ
DO JLEV = 2, YDCPG_OPTS%KFLEVG
  DO JLON = YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
    ZDZZ(JLON,JLEV)=ZZZ(JLON,JLEV-1)-ZZZ(JLON,JLEV)
  ENDDO
ENDDO

DO JLON = YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
  ZDZZ(JLON,1)=YDMF_PHYS_BASE_STATE%YCPG_DYN%PHI(JLON,0)*ZINVG-ZZZ(JLON,1)
ENDDO

CALL DPRECIPS (YDMODEL%YRCST, YDMODEL%YRML_PHY_MF%YRPHY%YRDPRECIPS, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG,          &
& YDVARS%GEOMETRY%OROG%T0, YDMF_PHYS%OUT%TPWCLS, YDMF_PHYS%OUT%DIAGH, YDMF_PHYS_BASE_STATE%YCPG_DYN%PHIF, ZDZZ, ZTW, YDMF_PHYS_BASE_STATE%L,         &
& ZFPLC(:, YDCPG_OPTS%KFLEVG), ZFPLS(:, YDCPG_OPTS%KFLEVG), ZFPLSG(:, YDCPG_OPTS%KFLEVG), PPRC_DPRECIPS(:, YDCPG_OPTS%NDTPRECCUR))
  
! Idem for an other time step and an other period

CALL DPRECIPS(YDMODEL%YRCST, YDMODEL%YRML_PHY_MF%YRPHY%YRDPRECIPS, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG,           &
& YDVARS%GEOMETRY%OROG%T0, YDMF_PHYS%OUT%TPWCLS, YDMF_PHYS%OUT%DIAGH, YDMF_PHYS_BASE_STATE%YCPG_DYN%PHIF, ZDZZ, ZTW, YDMF_PHYS_BASE_STATE%L,         &
& ZFPLC(:, YDCPG_OPTS%KFLEVG), ZFPLS(:, YDCPG_OPTS%KFLEVG), ZFPLSG(:, YDCPG_OPTS%KFLEVG), PPRC_DPRECIPS2(:, YDCPG_OPTS%NDTPRECCUR2))

!=END PARALLEL

IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_DPRECIPS', 1, ZHOOK_HANDLE)

END SUBROUTINE APL_ARPEGE_DPRECIPS
