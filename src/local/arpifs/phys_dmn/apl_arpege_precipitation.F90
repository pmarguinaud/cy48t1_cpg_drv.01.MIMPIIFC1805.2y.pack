SUBROUTINE APL_ARPEGE_PRECIPITATION (YDMF_PHYS_BASE_STATE, YDCPG_DIM, YDMF_PHYS, YDMF_PHYS_SURF, YDVARS, &
& YDMODEL, PFLU_NEIJ, PNEBS, PNEB_CVPP, PQC_DET_PCMT, PQI, PQL, PQLIS, PQLI_CVPP, PQR, PQS, PQV, PSEDIQI, &
& PSEDIQL, PTENHA, PTENQVA, PVETAF)

USE PARKIND1, ONLY : JPIM, JPRB

USE MF_PHYS_BASE_STATE_TYPE_MOD &
                       , ONLY : MF_PHYS_BASE_STATE_TYPE
USE CPG_DIM_TYPE_MOD   , ONLY : CPG_DIM_TYPE
USE MF_PHYS_TYPE_MOD   , ONLY : MF_PHYS_TYPE
USE MF_PHYS_SURFACE_TYPE_MOD,ONLY : MF_PHYS_SURF_TYPE
USE FIELD_VARIABLES_MOD, ONLY : FIELD_VARIABLES
USE TYPE_MODEL         , ONLY : MODEL


IMPLICIT NONE

TYPE (MF_PHYS_BASE_STATE_TYPE), INTENT(IN)    :: YDMF_PHYS_BASE_STATE
TYPE(CPG_DIM_TYPE),             INTENT(IN)    :: YDCPG_DIM
TYPE(MF_PHYS_TYPE),             INTENT(INOUT) :: YDMF_PHYS
TYPE(MF_PHYS_SURF_TYPE),        INTENT(INOUT) :: YDMF_PHYS_SURF
TYPE(FIELD_VARIABLES),          INTENT(INOUT) :: YDVARS
TYPE(MODEL),                    INTENT(IN)    :: YDMODEL
REAL(KIND=JPRB),                INTENT(IN)    :: PFLU_NEIJ (YDCPG_DIM%KLON)
REAL(KIND=JPRB),                INTENT(INOUT) :: PNEBS(YDCPG_DIM%KLON,YDCPG_DIM%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PNEB_CVPP(YDCPG_DIM%KLON,YDCPG_DIM%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQC_DET_PCMT(YDCPG_DIM%KLON,YDCPG_DIM%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQI(YDCPG_DIM%KLON,YDCPG_DIM%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQL(YDCPG_DIM%KLON,YDCPG_DIM%KFLEVG)
REAL(KIND=JPRB),                INTENT(INOUT) :: PQLIS(YDCPG_DIM%KLON,YDCPG_DIM%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQLI_CVPP(YDCPG_DIM%KLON,YDCPG_DIM%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQR(YDCPG_DIM%KLON,YDCPG_DIM%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQS(YDCPG_DIM%KLON,YDCPG_DIM%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQV(YDCPG_DIM%KLON,YDCPG_DIM%KFLEVG)
REAL(KIND=JPRB),                INTENT(INOUT) :: PSEDIQI(YDCPG_DIM%KLON,0:YDCPG_DIM%KFLEVG)
REAL(KIND=JPRB),                INTENT(INOUT) :: PSEDIQL(YDCPG_DIM%KLON,0:YDCPG_DIM%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PTENHA(YDCPG_DIM%KLON,YDCPG_DIM%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PTENQVA(YDCPG_DIM%KLON,YDCPG_DIM%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PVETAF(YDCPG_DIM%KFLEVG)

#include "acpluiz.intfb.h"
#include "acuptq.intfb.h"

LOGICAL :: LLPTQ
REAL(KIND=JPRB) :: ZFRSO(YDCPG_DIM%KLON,0:YDCPG_DIM%KFLEVG)
REAL(KIND=JPRB) :: ZFRTH(YDCPG_DIM%KLON,0:YDCPG_DIM%KFLEVG)
REAL(KIND=JPRB) :: ZQMIC(YDCPG_DIM%KLON,YDCPG_DIM%KFLEVG)
REAL(KIND=JPRB) :: ZTMIC(YDCPG_DIM%KLON,YDCPG_DIM%KFLEVG)

! ARPEGE PRECIPITATION SCHEME  

ZFRSO(:,:) = 0.0_JPRB
ZFRTH(:,:) = 0.0_JPRB
LLPTQ = .TRUE.
CALL ACUPTQ ( YDCPG_DIM%KLON, YDCPG_DIM%KIDIA, YDCPG_DIM%KFDIA, YDCPG_DIM%KFLEVG, LLPTQ, ZFRSO,                    &
& ZFRTH, YDMF_PHYS%OUT%DIFCQ, YDMF_PHYS%OUT%DIFCS, YDMF_PHYS%OUT%DIFTQ, YDMF_PHYS%OUT%DIFTS, YDMF_PHYS%OUT%FCCQL,  &
& YDMF_PHYS%OUT%FCCQN, YDMF_PHYS%OUT%FPLCL, YDMF_PHYS%OUT%FPLCN, YDMF_PHYS%OUT%FPEVPCL, YDMF_PHYS%OUT%FPEVPCN,     &
& YDMF_PHYS%OUT%FPFPCL, YDMF_PHYS%OUT%FPFPCN, YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%RDELP, YDMF_PHYS_BASE_STATE%T, YDMF_PHYS_BASE_STATE%Q, &
& YDMF_PHYS_BASE_STATE%YGSP_RR%T, PTENHA, PTENQVA )
  
      ! Microphysics occurs in the resolved state.
ZTMIC(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%KTDIA:YDCPG_DIM%KFLEVG)=YDMF_PHYS_BASE_STATE%T(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%KTDIA:YDCPG_DIM%KFLEVG)
ZQMIC(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%KTDIA:YDCPG_DIM%KFLEVG)=PQV(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%KTDIA:YDCPG_DIM%KFLEVG)

CALL ACPLUIZ ( YDMODEL%YRML_PHY_MF, YDCPG_DIM%KIDIA, YDCPG_DIM%KFDIA, YDCPG_DIM%KLON, YDMODEL%YRML_PHY_MF%YRTOPH%NTPLUI, YDCPG_DIM%KFLEVG,        &
& ZTMIC, ZQMIC, PQL, PQI, PQR, PQS, YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%DELP, &
& YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYDF, YDMF_PHYS_BASE_STATE%YCPG_DYN%RCP%CP, &
& YDMF_PHYS_BASE_STATE%YCPG_DYN%RCP%R, PNEBS, PQLIS, PNEB_CVPP, PQLI_CVPP,                        &
& PQC_DET_PCMT, PTENHA, PTENQVA, .TRUE., YDMF_PHYS_BASE_STATE%YCPG_DYN%PHI, YDMF_PHYS_BASE_STATE%YGSP_RR%T, &
& PFLU_NEIJ, YDMF_PHYS_SURF%GSD_VF%PLSM, &
& YDVARS%GEOMETRY%GM%T0, PVETAF, YDMF_PHYS%OUT%FCSQL, YDMF_PHYS%OUT%FCSQN, YDMF_PHYS%OUT%FPLSL, YDMF_PHYS%OUT%FPLSN,   &
& YDMF_PHYS%OUT%FPEVPSL, YDMF_PHYS%OUT%FPEVPSN, YDMF_PHYS%OUT%FPFPSL, YDMF_PHYS%OUT%FPFPSN, PSEDIQL,                   &
& PSEDIQI )



END SUBROUTINE
