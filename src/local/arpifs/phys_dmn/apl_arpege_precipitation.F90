SUBROUTINE APL_ARPEGE_PRECIPITATION (YDMF_PHYS_BASE_STATE, YDCPG_BNDS, YDCPG_OPTS, YDMF_PHYS,  &
& YDMF_PHYS_SURF, YDVARS, YDMODEL, PFLU_NEIJ, PNEBS, PNEB_CVPP, PQC_DET_PCMT, PQI, PQL, PQLIS, &
& PQLI_CVPP, PQR, PQS, PQV, PSEDIQI, PSEDIQL, PTENHA, PTENQVA, YDSTA)

!**** *APL_ARPEGE_PRECIPITATION*

!     Author. 
!     ------- 
!      Philippe Marguinaud *METEO-FRANCE*
!      Original : 28-04-2021

USE YOMHOOK, ONLY : LHOOK, DR_HOOK
USE PARKIND1, ONLY : JPIM, JPRB

USE MF_PHYS_BASE_STATE_TYPE_MOD &
                       , ONLY : MF_PHYS_BASE_STATE_TYPE
USE CPG_OPTS_TYPE_MOD  , ONLY : CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE MF_PHYS_TYPE_MOD   , ONLY : MF_PHYS_TYPE
USE MF_PHYS_SURFACE_TYPE_MOD  &
                       , ONLY : MF_PHYS_SURF_TYPE
USE FIELD_VARIABLES_MOD, ONLY : FIELD_VARIABLES
USE TYPE_MODEL         , ONLY : MODEL
USE YOMSTA             , ONLY : TSTA

IMPLICIT NONE

TYPE(MF_PHYS_BASE_STATE_TYPE),  INTENT(IN)    :: YDMF_PHYS_BASE_STATE
TYPE(CPG_BNDS_TYPE),            INTENT(IN)    :: YDCPG_BNDS
TYPE(CPG_OPTS_TYPE),            INTENT(IN)    :: YDCPG_OPTS
TYPE(MF_PHYS_TYPE),             INTENT(INOUT) :: YDMF_PHYS
TYPE(MF_PHYS_SURF_TYPE),        INTENT(INOUT) :: YDMF_PHYS_SURF
TYPE(FIELD_VARIABLES),          INTENT(INOUT) :: YDVARS
TYPE(MODEL),                    INTENT(IN)    :: YDMODEL
REAL(KIND=JPRB),                INTENT(IN)    :: PFLU_NEIJ (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(INOUT) :: PNEBS(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PNEB_CVPP(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQC_DET_PCMT(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQI(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQL(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(INOUT) :: PQLIS(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQLI_CVPP(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQR(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQS(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQV(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(INOUT) :: PSEDIQI(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(INOUT) :: PSEDIQL(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PTENHA(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PTENQVA(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
TYPE(TSTA),                     INTENT(IN)    :: YDSTA

#include "acpluiz.intfb.h"
#include "acuptq.intfb.h"

REAL(KIND=JPRB) :: ZFRSO(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZFRTH(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZQMIC(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZTMIC(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)

LOGICAL :: LLPTQ
INTEGER(KIND=JPIM) :: JLON, JLEV

REAL (KIND=JPRB) :: ZHOOK_HANDLE

IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_PRECIPITATION', 0, ZHOOK_HANDLE)

LLPTQ = .TRUE.

!=PARALLEL

ZFRSO(:,:) = 0.0_JPRB
ZFRTH(:,:) = 0.0_JPRB

CALL ACUPTQ (YDMODEL%YRCST,  YDCPG_OPTS%KLON, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG, LLPTQ, ZFRSO,&
& ZFRTH, YDMF_PHYS%OUT%DIFCQ, YDMF_PHYS%OUT%DIFCS, YDMF_PHYS%OUT%DIFTQ, YDMF_PHYS%OUT%DIFTS, YDMF_PHYS%OUT%FCCQL, &
& YDMF_PHYS%OUT%FCCQN, YDMF_PHYS%OUT%FPLCL, YDMF_PHYS%OUT%FPLCN, YDMF_PHYS%OUT%FPEVPCL, YDMF_PHYS%OUT%FPEVPCN,    &
& YDMF_PHYS%OUT%FPFPCL, YDMF_PHYS%OUT%FPFPCN, YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%RDELP, YDMF_PHYS_BASE_STATE%T,    &
& YDMF_PHYS_BASE_STATE%Q, YDMF_PHYS_BASE_STATE%YGSP_RR%T, PTENHA, PTENQVA)
  
! Microphysics occurs in the resolved state.

DO JLEV = YDCPG_OPTS%KTDIA, YDCPG_OPTS%KFLEVG
  DO JLON = YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
    ZTMIC(JLON,JLEV)=YDMF_PHYS_BASE_STATE%T(JLON,JLEV)
    ZQMIC(JLON,JLEV)=PQV(JLON,JLEV)
  ENDDO
ENDDO

CALL ACPLUIZ (YDMODEL%YRCST,  YDMODEL%YRML_PHY_MF, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_OPTS%KLON, YDMODEL%YRML_PHY_MF%YRTOPH%NTPLUI, &
& YDCPG_OPTS%KFLEVG, ZTMIC, ZQMIC, PQL, PQI, PQR, PQS, YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%DELP, YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYDF,      &
& YDMF_PHYS_BASE_STATE%YCPG_DYN%RCP%CP, YDMF_PHYS_BASE_STATE%YCPG_DYN%RCP%R, PNEBS, PQLIS, PNEB_CVPP,                                      &
& PQLI_CVPP, PQC_DET_PCMT, PTENHA, PTENQVA, .TRUE., YDMF_PHYS_BASE_STATE%YCPG_DYN%PHI, YDMF_PHYS_BASE_STATE%YGSP_RR%T,                     &
& PFLU_NEIJ, YDMF_PHYS_SURF%GSD_VF%PLSM, YDVARS%GEOMETRY%GM%T0, YDSTA, YDMF_PHYS%OUT%FCSQL, YDMF_PHYS%OUT%FCSQN,                           &
& YDMF_PHYS%OUT%FPLSL, YDMF_PHYS%OUT%FPLSN, YDMF_PHYS%OUT%FPEVPSL, YDMF_PHYS%OUT%FPEVPSN, YDMF_PHYS%OUT%FPFPSL,YDMF_PHYS%OUT%FPFPSN,       &
& PSEDIQL, PSEDIQI )

!=END PARALLEL

IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_PRECIPITATION', 1, ZHOOK_HANDLE)

END SUBROUTINE APL_ARPEGE_PRECIPITATION
