SUBROUTINE APL_ARPEGE_SURFACE (YDMF_PHYS_BASE_STATE, YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDCPG_MISC, &
& YDCPG_GPAR, YDMF_PHYS, YDMF_PHYS_SURF, YDVARS, YDMODEL, PALBD, PALBP, PALPHA1, PCDROV,             &
& PCEROV, PCFATH, PCFAU, PCFBTH, PCFBU, PCFBV, PCHROV, PCOEFA, PCOEFN, PCP, PDIFEXT, PDIFWQ, PDIFWS, &
& PDQSTS, PDSA_CPS, PDSA_LHS, PDTMSE, PEDMFQ, PEDMFS, PEDMFU, PEDMFV, PFLU_CD, PFLU_CDN, PFLU_EMIS,  &
& PFLU_FEVI, PFLU_NEIJ, PFLU_QSATS, PFLU_VEG, PHQ, PHTR, PHU, PKQLROV, PKQROV, PKTROV, PKUROV, PLVT, &
& PMF_UP, PNEBCH, PNEBDIFF, PNEBS, PPOID, PQI, PQICE, PQL, PQV, PRDG_MU0, PRDG_MU0N, PRHGMT,         &
& PSC_FCLL, PSC_FCLN, PSC_FEVI, PSC_FEVN, PSFSWDIF, PSFSWDIR, PSGROUPEL, PSRAIN, PSSNOW, PSTATI,     &
& PTSN, PXDROV, PXHROV, PXQRO, PXTRO, PXTROV, PXURO, PXUROV)

!**** *APL_ARPEGE_SURFACE*

!     Author. 
!     ------- 
!      Philippe Marguinaud *METEO-FRANCE*
!      Original : 28-04-2021

USE YOMHOOK, ONLY : LHOOK, DR_HOOK
USE PARKIND1, ONLY : JPIM, JPRB

USE MF_PHYS_BASE_STATE_TYPE_MOD &
                       , ONLY : MF_PHYS_BASE_STATE_TYPE
USE GEOMETRY_MOD       , ONLY : GEOMETRY
USE CPG_OPTS_TYPE_MOD  , ONLY : CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE CPG_TYPE_MOD       , ONLY : CPG_MISC_TYPE, CPG_DYN_TYPE, &
                              & CPG_SL2_TYPE, CPG_GPAR_TYPE
USE CPG_TYPE_MOD       , ONLY : CPG_MISC_TYPE, CPG_DYN_TYPE, &
                              & CPG_SL2_TYPE, CPG_GPAR_TYPE
USE MF_PHYS_TYPE_MOD   , ONLY : MF_PHYS_TYPE
USE MF_PHYS_SURFACE_TYPE_MOD  &
                       , ONLY : MF_PHYS_SURF_TYPE
USE FIELD_VARIABLES_MOD, ONLY : FIELD_VARIABLES
USE SURFACE_FIELDS_MIX , ONLY : TSURF
USE TYPE_MODEL         , ONLY : MODEL


IMPLICIT NONE

TYPE (MF_PHYS_BASE_STATE_TYPE), INTENT(IN)    :: YDMF_PHYS_BASE_STATE
TYPE(GEOMETRY),                 INTENT(IN)    :: YDGEOMETRY
TYPE(CPG_BNDS_TYPE),            INTENT(IN)    :: YDCPG_BNDS
TYPE(CPG_OPTS_TYPE),            INTENT(IN)    :: YDCPG_OPTS
TYPE(CPG_MISC_TYPE),            INTENT(INOUT) :: YDCPG_MISC
TYPE(CPG_GPAR_TYPE),            INTENT(INOUT) :: YDCPG_GPAR
TYPE(MF_PHYS_TYPE),             INTENT(INOUT) :: YDMF_PHYS
TYPE(MF_PHYS_SURF_TYPE),        INTENT(INOUT) :: YDMF_PHYS_SURF
TYPE(FIELD_VARIABLES),          INTENT(INOUT) :: YDVARS
TYPE(MODEL),                    INTENT(IN)    :: YDMODEL
REAL(KIND=JPRB),                INTENT(INOUT) :: PALBD(YDCPG_OPTS%KLON,YDCPG_OPTS%KSW)
REAL(KIND=JPRB),                INTENT(INOUT) :: PALBP(YDCPG_OPTS%KLON,YDCPG_OPTS%KSW)
REAL(KIND=JPRB),                INTENT(OUT)   :: PALPHA1(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PCDROV(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PCEROV(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(OUT)   :: PCFATH(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PCFAU(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PCFBTH(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PCFBU(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PCFBV(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PCHROV(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(OUT)   :: PCOEFA (YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PCOEFN(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PCP(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PDIFEXT(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG,YDMODEL%YRML_GCONF%YGFL%NGFL_EXT)
REAL(KIND=JPRB),                INTENT(OUT)   :: PDIFWQ (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(OUT)   :: PDIFWS (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PDQSTS(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PDSA_CPS (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(OUT)   :: PDSA_LHS (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PDTMSE
REAL(KIND=JPRB),                INTENT(IN)    :: PEDMFQ(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PEDMFS(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PEDMFU(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PEDMFV(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PFLU_CD (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PFLU_CDN (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(INOUT) :: PFLU_EMIS (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(OUT)   :: PFLU_FEVI (YDCPG_OPTS%KLON, 1:YDCPG_OPTS%KTSSG+1)
REAL(KIND=JPRB),                INTENT(IN)    :: PFLU_NEIJ (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PFLU_QSATS (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PFLU_VEG (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PHQ(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PHTR(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PHU(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PKQLROV(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PKQROV(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PKTROV(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PKUROV(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PLVT (YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PMF_UP(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PNEBCH(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(INOUT) :: PNEBDIFF(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PNEBS(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PPOID(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQI(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PQICE  (YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQL(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQV(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PRDG_MU0 (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PRDG_MU0N (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PRHGMT
REAL(KIND=JPRB),                INTENT(OUT)   :: PSC_FCLL(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(OUT)   :: PSC_FCLN(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(OUT)   :: PSC_FEVI (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(OUT)   :: PSC_FEVN(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(INOUT) :: PSFSWDIF (YDCPG_OPTS%KLON,YDCPG_OPTS%KSW)
REAL(KIND=JPRB),                INTENT(INOUT) :: PSFSWDIR (YDCPG_OPTS%KLON,YDCPG_OPTS%KSW)
REAL(KIND=JPRB),                INTENT(INOUT) :: PSGROUPEL(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(INOUT) :: PSRAIN(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(INOUT) :: PSSNOW(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PSTATI
REAL(KIND=JPRB),                INTENT(INOUT) :: PTSN(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(INOUT) :: PXDROV(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(INOUT) :: PXHROV(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(OUT)   :: PXQRO(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PXTRO(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(INOUT) :: PXTROV(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(INOUT) :: PXURO(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(INOUT) :: PXUROV(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)

#include "acaa1.intfb.h"
#include "acdifv1.intfb.h"
#include "acdifv2.intfb.h"
#include "aro_ground_diag.h"
#include "aro_ground_diag_2isba.h"
#include "aro_ground_param.h"
#include "arp_ground_param.intfb.h"

REAL(KIND=JPRB) :: ZZS(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZTWSNOW(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZTOWNS(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZSVM (YDCPG_OPTS%KLON,1,1)
REAL(KIND=JPRB) :: ZSSO_STDEV(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZSFSV (YDCPG_OPTS%KLON,1)
REAL(KIND=JPRB) :: ZSFCO2(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZRHODREFM(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZQT(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZHV2(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZFMDV(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZFMDU(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZFEVS(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZFEV(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZFCLL  (YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZDSE(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZDEPTH_HEIGHT(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZCFBSV(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG,1:YDMODEL%YRML_GCONF%YGFL%NGFL_EXT)
REAL(KIND=JPRB) :: ZCFBS(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZCFBQ(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZCFASV(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG,1:YDMODEL%YRML_GCONF%YGFL%NGFL_EXT)
REAL(KIND=JPRB) :: ZCFAS(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZCFAQ(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZCD(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZBUDTH (YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZBUDSO (YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZCARDI
INTEGER(KIND=JPIM) :: IRR
INTEGER(KIND=JPIM) :: JLEV
INTEGER(KIND=JPIM) :: JLON
INTEGER(KIND=JPIM) :: JSG

REAL (KIND=JPRB) :: ZHOOK_HANDLE

IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SURFACE', 0, ZHOOK_HANDLE)

ASSOCIATE (YDCST => YDMODEL%YRCST)

! VERTICAL DIFFUSION AND IMPLICIT SURFACE
! Sauvegarde temporaire de l'ancien acdifus pour les besoins du Climat
    
!=PARALLEL

CALL ACDIFV1 (YDMODEL%YRCST, YDMODEL%YRML_GCONF%YGFL, YDMODEL%YRML_PHY_MF, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_OPTS%KLON,&
& YDCPG_OPTS%KTDIA, YDCPG_OPTS%KFLEVG, YDMF_PHYS_BASE_STATE%YCPG_DYN%PHIF, YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYDF,              &
& PCP, YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%DELP, PKTROV, PKQROV, PKUROV, PQV, PQL, PQI, YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%RDELP, &
& YDMF_PHYS_BASE_STATE%T, YDMF_PHYS_BASE_STATE%U, YDMF_PHYS_BASE_STATE%V, ZSVM, PXTROV, PXUROV,                                &
& PXDROV, PXHROV, PEDMFS, PEDMFQ, PEDMFU, PEDMFV, PMF_UP, PXURO, PXQRO, PXTRO, ZCFAQ, ZCFAS, PCFATH,                           &
& PCFAU, ZCFASV, ZCFBQ, ZCFBS, PCFBTH, PCFBU, PCFBV, ZCFBSV, ZDSE, ZQT)   

!=END PARALLEL
        
IF ( YDMODEL%YRML_PHY_MF%YRARPHY%LMSE.AND.YDCPG_OPTS%LCALLSFX ) THEN

  ZCARDI=YDMODEL%YRML_PHY_RAD%YRERDI%RCARDI
  IRR=2

!=PARALLEL

  DO JLON=YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
    ZRHODREFM(JLON)=YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYDF(JLON,YDCPG_OPTS%KFLEVG)/(YDMF_PHYS_BASE_STATE%T(JLON,YDCPG_OPTS%KFLEVG)*YDMF_PHYS_BASE_STATE%YCPG_DYN%RCP%R(JLON,YDCPG_OPTS%KFLEVG))
    ZZS(JLON)=YDMF_PHYS_BASE_STATE%YCPG_DYN%PHI(JLON,YDCPG_OPTS%KFLEVG)/YDCST%RG
  ENDDO

  DO JLEV = 1, YDCPG_OPTS%KFLEVG
    DO JLON=YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
      ZDEPTH_HEIGHT(JLON,JLEV)=(YDMF_PHYS_BASE_STATE%YCPG_DYN%PHIF(JLON,JLEV)-YDMF_PHYS_BASE_STATE%YCPG_DYN%PHI(JLON,YDCPG_OPTS%KFLEVG))/YDCST%RG
    ENDDO
  ENDDO

  CALL ARO_GROUND_PARAM( YDCPG_BNDS%KBL, YDCPG_OPTS%KGPCOMP, YDCPG_BNDS%KFDIA-YDCPG_BNDS%KIDIA+1, YDCPG_BNDS%KIDIA,                                                                                 &
  & YDCPG_BNDS%KFDIA, YDCPG_OPTS%NSTEP, IRR, YDMODEL%YRML_PHY_RAD%YRERAD%NSW, YDMODEL%YRML_GCONF%YGFL%NGFL_EXT,                                                                                     &
  & YDGEOMETRY%YRDIM%NDGUNG, YDGEOMETRY%YRDIM%NDGUXG, YDGEOMETRY%YRDIM%NDLUNG, YDGEOMETRY%YRDIM%NDLUXG,                                                                                             &
  & YDMODEL%YRML_PHY_MF%YRARPHY%LSURFEX_KFROM, YDMODEL%YRML_PHY_MF%YRARPHY%LMPA, YDMODEL%YRML_PHY_MF%YRARPHY%CCOUPLING,                                                                             &
  & YDCPG_OPTS%LCONFX, YDCPG_OPTS%NINDAT, PRHGMT, PSTATI, YDMODEL%YRML_GCONF%YRRIP%RSOVR, YDMODEL%YRML_GCONF%YRRIP%RCODEC,                                                                          &
  & YDMODEL%YRML_GCONF%YRRIP%RSIDEC, YDVARS%GEOMETRY%RINDX%T0(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), YDVARS%GEOMETRY%RINDY%T0(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA),                                      &
  & YDMF_PHYS_BASE_STATE%U(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG:YDCPG_OPTS%KFLEVG), YDMF_PHYS_BASE_STATE%V(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG:YDCPG_OPTS%KFLEVG), &
  & YDMF_PHYS_BASE_STATE%T(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG:YDCPG_OPTS%KFLEVG), YDMF_PHYS_BASE_STATE%Q(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG:YDCPG_OPTS%KFLEVG), &
  & ZSVM, ZCARDI, ZRHODREFM(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYDF(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG:YDCPG_OPTS%KFLEVG),                      &
  & YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYD(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG:YDCPG_OPTS%KFLEVG),                                                                                   &
  & PDTMSE, ZDEPTH_HEIGHT(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG), ZZS(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA),                                                                            &
  & YDMODEL%YRML_PHY_MF%YRMSE%XZSEPS, PRDG_MU0(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), PRDG_MU0N(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA),                                                                    &
  & YDVARS%GEOMETRY%GELAM%T0(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), YDVARS%GEOMETRY%GEMU%T0(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA),                                                                        &
  & YDMODEL%YRML_PHY_MF%YRPARAR%XSW_BANDS, PSRAIN(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), PSSNOW(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA),                                                                    &
  & PSGROUPEL(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), YDMF_PHYS%OUT%FRTHDS(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA),                                                                                          &
  & PSFSWDIF(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDMODEL%YRML_PHY_RAD%YRERAD%NSW), PSFSWDIR(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDMODEL%YRML_PHY_RAD%YRERAD%NSW),                                 &
  & ZCFAQ(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG:YDCPG_OPTS%KFLEVG), PCFATH(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG:YDCPG_OPTS%KFLEVG),                                  &
  & PCFAU(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG:YDCPG_OPTS%KFLEVG), ZCFBQ(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG:YDCPG_OPTS%KFLEVG),                                   &
  & PCFBTH(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG:YDCPG_OPTS%KFLEVG), PCFBU(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG:YDCPG_OPTS%KFLEVG),                                  &
  & PCFBV(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG:YDCPG_OPTS%KFLEVG), YDMF_PHYS%OUT%FCS(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1),                                                         &
  & ZFEV(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), ZSFSV, ZSFCO2(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), ZFMDU(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA),                                                            &
  & ZFMDV(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), PALBP(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDMODEL%YRML_PHY_RAD%YRERAD%NSW),                                                                          &
  & PALBD(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDMODEL%YRML_PHY_RAD%YRERAD%NSW), PFLU_EMIS(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA),                                                                      &
  & PTSN(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), YDMF_PHYS%OUT%FRTH(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG, 1))

! Opposite water vapor flux

  ZFEVS(:)=-ZFEV(:)

  CALL ARO_GROUND_DIAG( YDCPG_BNDS%KBL, YDCPG_OPTS%KGPCOMP, YDCPG_BNDS%KFDIA-YDCPG_BNDS%KIDIA+1, YDCPG_BNDS%KIDIA,                                            &
  & YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG, -1, YDGEOMETRY%YRDIM%NDGUNG, YDGEOMETRY%YRDIM%NDGUXG, YDGEOMETRY%YRDIM%NDLUNG,                                       &
  & YDGEOMETRY%YRDIM%NDLUXG, YDMODEL%YRML_PHY_MF%YRARPHY%LSURFEX_KFROM, ZZS(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA),                                               &
  & ZFEVS(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), YDMF_PHYS_BASE_STATE%U(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDCPG_OPTS%KFLEVG),                                 &
  & YDMF_PHYS_BASE_STATE%V(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDCPG_OPTS%KFLEVG), ZDEPTH_HEIGHT(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDCPG_OPTS%KFLEVG),    &
  & YDMF_PHYS%OUT%FRTH(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG, 1), YDMF_PHYS%OUT%FRSO(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDCPG_OPTS%KFLEVG, 1), &
  & YDVARS%GEOMETRY%RINDX%T0(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), YDVARS%GEOMETRY%RINDY%T0(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA),                                 &
  & YDCPG_MISC%QS(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), YDMF_PHYS%OUT%GZ0(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA),                                                   &
  & YDMF_PHYS%OUT%GZ0H(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), YDMF_PHYS%OUT%TCLS (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA),                                            &
  & YDMF_PHYS%OUT%QCLS(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), YDMF_PHYS%OUT%RHCLS(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA),                                            &
  & YDMF_PHYS%OUT%UCLS(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), YDMF_PHYS%OUT%VCLS(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA),                                             &
  & YDMF_PHYS%OUT%NUCLS(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), YDMF_PHYS%OUT%NVCLS(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA),                                           &
  & YDMF_PHYS%OUT%FCLL(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1), YDMF_PHYS%OUT%FCLN(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1),                                       &
  & YDMF_PHYS%OUT%FEVL(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1), YDMF_PHYS%OUT%FEVN(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1),                                       &
  & ZSSO_STDEV(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), ZTWSNOW(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), ZBUDTH(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA),                     &
  & ZBUDSO(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), ZFCLL(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), ZTOWNS(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA),                           &
  & ZCD(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)                        )

  DO JLON=YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
    YDCPG_GPAR%GZ0(JLON)   = YDMF_PHYS%OUT%GZ0 (JLON)
    YDCPG_GPAR%GZ0H(JLON)  = YDMF_PHYS%OUT%GZ0H(JLON)
    YDCPG_GPAR%VEMIS(JLON) = PFLU_EMIS(JLON)
    YDCPG_GPAR%VQS(JLON)   = YDCPG_MISC%QS  (JLON)
    YDCPG_GPAR%CD(JLON)    = ZCD  (JLON)
  ENDDO

  DO JSG=1,YDMODEL%YRML_PHY_RAD%YRERAD%NSW
    YDCPG_GPAR%ALBSCA(:,JSG) = PALBD(:,JSG)
    YDCPG_GPAR%ALBDIR(:,JSG) = PALBP(:,JSG)
  ENDDO

  DO JSG  = 1, YDMODEL%YRML_PHY_G%YRDPHY%NTSSG+1
    DO JLEV = 0, YDCPG_OPTS%KFLEVG
      DO JLON = YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
        YDMF_PHYS%OUT%FRTH(JLON,JLEV,JSG)=YDMF_PHYS%OUT%FRTH(JLON,JLEV,JSG)+ZBUDTH(JLON)
      ENDDO
    ENDDO
  ENDDO

! calculation of variables for the old "ISBA" atmosphere scheme
        
  CALL ARO_GROUND_DIAG_2ISBA( YDCPG_BNDS%KBL, YDCPG_OPTS%KGPCOMP, YDCPG_BNDS%KFDIA-YDCPG_BNDS%KIDIA+1,                                       &
  & YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIM%NDGUNG, YDGEOMETRY%YRDIM%NDGUXG, YDGEOMETRY%YRDIM%NDLUNG,                           &
  & YDGEOMETRY%YRDIM%NDLUXG, YDMODEL%YRML_PHY_MF%YRARPHY%LSURFEX_KFROM, YDVARS%GEOMETRY%RINDX%T0(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA),         &
  & YDVARS%GEOMETRY%RINDY%T0(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), YDMF_PHYS_SURF%GSD_VF%PLSM, YDMF_PHYS_SURF%GSD_VV%PARG,                     &
  & YDMF_PHYS_SURF%GSD_VV%PSAB, YDMF_PHYS_SURF%GSD_VV%PD2, PTSN, ZTWSNOW, YDMF_PHYS_SURF%GSP_SB%PT_T1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1), &
  & YDMF_PHYS_SURF%GSP_RR%PW_T1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), YDMF_PHYS_SURF%GSP_SB%PQ_T1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1),       &
  & YDMF_PHYS_SURF%GSP_RR%PIC_T1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), YDMF_PHYS_SURF%GSP_SB%PTL_T1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1),     &
  & YDMF_PHYS_SURF%GSP_RR%PFC_T1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA), YDMF_PHYS_SURF%GSP_SG%PA_T1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1),      &
  & YDMF_PHYS_SURF%GSP_SG%PR_T1(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1), ZHV2 )
  DO JLON=YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
    YDMF_PHYS_SURF%GSD_VV%PHV(JLON) = ZHV2(JLON)
  ENDDO        

  IF (.NOT.YDMODEL%YRML_PHY_MF%YRPHY%LNODIFQC) THEN
    CALL ACAA1 (YDMODEL%YRCST, YDMODEL%YRML_PHY_MF, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_OPTS%KLON, YDCPG_OPTS%KTDIA,&
    & YDCPG_OPTS%KFLEVG, YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYD, PCOEFN, YDMF_PHYS_BASE_STATE%YCPG_DYN%RCP%CP,              &
    & PQL, PQI, YDMF_PHYS_BASE_STATE%T, PALPHA1, PCOEFA, PLVT, PQICE)
  ENDIF

!=END PARALLEL

ELSEIF (.NOT.YDMODEL%YRML_PHY_MF%YRARPHY%LMSE) THEN

!=PARALLEL

  IF(YDMODEL%YRML_PHY_MF%YRPHY%NDIFFNEB == 5) THEN
    PNEBDIFF(:,:)=PNEBS(:,:)
  ELSEIF(YDMODEL%YRML_PHY_MF%YRPHY%NDIFFNEB == 2) THEN
    DO JLEV = 1, YDCPG_OPTS%KFLEVG
      DO JLON = YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
        PNEBDIFF(JLON,JLEV)=YDCPG_MISC%NEB(JLON,JLEV)
      ENDDO
    ENDDO
  ELSEIF(YDMODEL%YRML_PHY_MF%YRPHY%NDIFFNEB == 3) THEN
    PNEBDIFF(:,:)=PNEBS(:,:)+(1.0_JPRB-PNEBS(:,:))*PNEBCH(:,:)
  ENDIF

             
  CALL ARP_GROUND_PARAM (YDMODEL%YRCST,  YDMODEL%YRML_AOC%YRMCC, YDMODEL%YRML_PHY_MF, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA,          &
  & YDCPG_OPTS%KLON, YDCPG_OPTS%KTDIA, YDCPG_OPTS%KFLEVG, YDCPG_OPTS%YRSURF_DIMS%YSP_SBD%NLEVS, YDMF_PHYS_BASE_STATE%YCPG_DYN%PHI, &
  & PCP, YDMF_PHYS%OUT%FRSO, PQV, YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%RDELP, YDMF_PHYS_BASE_STATE%T, YDMF_PHYS_BASE_STATE%U,         &
  & YDMF_PHYS_BASE_STATE%V, PXURO, PXQRO, PXTRO, YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYD, PQL, PQI,                                   &
  & PNEBDIFF, PFLU_CD, PFLU_CDN, PCDROV, PCHROV, PCEROV, PDSA_CPS, YDMF_PHYS%OUT%CT, PDQSTS,                                       &
  & PFLU_EMIS, YDMF_PHYS_SURF%GSD_VH%PSPSH, PHQ, PHTR, PHU, YDMF_PHYS_SURF%GSD_VV%PHV, YDMF_PHYS_SURF%GSD_VF%PLSM,                 &
  & YDMF_PHYS_SURF%GSD_VV%PIVEG, PFLU_NEIJ, YDCPG_MISC%QS, PFLU_QSATS, YDMF_PHYS_BASE_STATE%YGSP_SB%T,                             &
  & YDMF_PHYS_BASE_STATE%YGSP_RR%T, PFLU_VEG, PXDROV, PXHROV, YDMF_PHYS_BASE_STATE%YGSP_RR%W, YDMF_PHYS_BASE_STATE%YGSP_RR%IC,     &
  & ZDSE, ZCFAS, PCFAU, ZCFBS, PCFBU, PCFBV, ZCFBQ, PCOEFA, PALPHA1, PLVT, PQICE, PDIFWQ, PDIFWS,                                  &
  & ZFMDU, ZFMDV, PSC_FEVI, PSC_FEVN, PSC_FCLL, PSC_FCLN, YDMF_PHYS%OUT%FCHSP, YDMF_PHYS%OUT%FCLL, YDMF_PHYS%OUT%FCLN,             &
  & YDMF_PHYS%OUT%FCS, PFLU_FEVI, YDMF_PHYS%OUT%FEVL, YDMF_PHYS%OUT%FEVN, YDMF_PHYS%OUT%FEVV, YDMF_PHYS%OUT%FTR,                   &
  & PDSA_LHS, YDMF_PHYS_SURF%GSD_VH%PQSH, YDMF_PHYS%OUT%FRTH, YDMF_PHYS_SURF%GSD_VF%PZ0F, YDMF_PHYS_SURF%GSD_VV%PZ0H               &
  &                                             )

  DO JLON=YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
    YDMF_PHYS%OUT%DIFTQ(JLON,YDCPG_OPTS%KFLEVG)=PDIFWQ(JLON)
    YDMF_PHYS%OUT%DIFTS(JLON,YDCPG_OPTS%KFLEVG)=PDIFWS(JLON)
  ENDDO

!=END PARALLEL
             
ELSEIF (.NOT. YDCPG_OPTS%LCALLSFX) THEN

!=PARALLEL

  DO JSG = 1, YDCPG_OPTS%KTSSG+1
    YDMF_PHYS%OUT%FCS(:,JSG) = 0.0_JPRB
  ENDDO
  ZFEV(:)   = 0.0_JPRB

!=END PARALLEL

ENDIF

!=PARALLEL

CALL ACDIFV2 (YDCPG_OPTS%LSFORCS, YDMODEL%YRCST, YDMODEL%YRML_GCONF%YGFL, YDMODEL%YRML_PHY_MF, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA,      &
& YDCPG_OPTS%KLON, YDCPG_OPTS%KTDIA, YDCPG_OPTS%KFLEVG, YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYD, ZCFAQ, ZCFAS, PCFAU,                      &
& ZCFASV, ZCFBQ, ZCFBS, PCFBU, PCFBV, ZCFBSV, PKTROV, PKQROV, PKQLROV, PKUROV, ZDSE, ZQT, YDMF_PHYS_BASE_STATE%U,                       &
& YDMF_PHYS_BASE_STATE%V, PPOID, YDMF_PHYS_BASE_STATE%T, PQL, PQI, YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%RDELP,                             &
& PCOEFA, PALPHA1, PLVT, PQICE, ZSFSV, YDMF_PHYS%OUT%FCS, ZFEV, ZFMDU, ZFMDV, PTSN, PXHROV, PDIFEXT,                                    &
& YDMF_PHYS%OUT%DIFTQ, YDMF_PHYS%OUT%DIFTS, YDMF_PHYS%OUT%STRTU, YDMF_PHYS%OUT%STRTV, YDMF_PHYS%OUT%DIFTQL,                             &
& YDMF_PHYS%OUT%DIFTQN, YDMF_PHYS%OUT%DIFCQ, YDMF_PHYS%OUT%DIFCS, YDMF_PHYS%OUT%STRCU, YDMF_PHYS%OUT%STRCV,                             &
& YDVARS%SHTUR%T0          )
      
!=END PARALLEL

IF ( YDMODEL%YRML_PHY_MF%YRARPHY%LMSE ) THEN

!=PARALLEL

  DO JLON=YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
    YDCPG_GPAR%VTS(JLON) = PTSN (JLON)
    YDMF_PHYS_SURF%GSP_SG%PF_T1(JLON,1) = ZTWSNOW (JLON)
  ENDDO

!=END PARALLEL

ENDIF


END ASSOCIATE

IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SURFACE', 1, ZHOOK_HANDLE)

END SUBROUTINE APL_ARPEGE_SURFACE
