SUBROUTINE APL_ARPEGE_SURFACE_UPDATE (YDCPG_DIM, YDCPG_GPAR, YDMF_PHYS, YDMF_PHYS_SURF, &
& YDSURF, YDMODEL, LDCONFX, PDTPHY, PDSA_C1, PDSA_C2, PFLU_FEVI, PFLU_VEG )

USE PARKIND1, ONLY : JPIM, JPRB

USE CPG_DIM_TYPE_MOD   , ONLY : CPG_DIM_TYPE
USE CPG_TYPE_MOD       , ONLY : CPG_MISC_TYPE, CPG_DYN_TYPE, &
                              & CPG_SL2_TYPE, CPG_GPAR_TYPE
USE MF_PHYS_TYPE_MOD   , ONLY : MF_PHYS_TYPE
USE MF_PHYS_SURFACE_TYPE_MOD,ONLY : MF_PHYS_SURF_TYPE
USE SURFACE_FIELDS_MIX , ONLY : TSURF
USE TYPE_MODEL         , ONLY : MODEL


IMPLICIT NONE

TYPE(CPG_DIM_TYPE),             INTENT(IN)    :: YDCPG_DIM
TYPE(CPG_GPAR_TYPE),            INTENT(INOUT) :: YDCPG_GPAR
TYPE(MF_PHYS_TYPE),             INTENT(INOUT) :: YDMF_PHYS
TYPE(MF_PHYS_SURF_TYPE),        INTENT(INOUT) :: YDMF_PHYS_SURF
TYPE(TSURF),                    INTENT(IN)    :: YDSURF
TYPE(MODEL),                    INTENT(IN)    :: YDMODEL
LOGICAL,                        INTENT(IN)    :: LDCONFX
REAL(KIND=JPRB),                INTENT(IN)    :: PDTPHY
REAL (KIND=JPRB),               INTENT(IN)    :: PDSA_C1 (YDCPG_DIM%KLON)
REAL (KIND=JPRB),               INTENT(IN)    :: PDSA_C2 (YDCPG_DIM%KLON)
REAL (KIND=JPRB),               INTENT(IN)    :: PFLU_FEVI (YDCPG_DIM%KLON, 1:YDCPG_DIM%KTSSG+1)
REAL (KIND=JPRB),               INTENT(IN)    :: PFLU_VEG (YDCPG_DIM%KLON)

#include "cptends.intfb.h"
#include "cpwts.intfb.h"

REAL (KIND=JPRB)     :: ZPFL_FPLSN (YDCPG_DIM%KLON, 0:YDCPG_DIM%KFLEVG)
REAL (KIND=JPRB)     :: ZTDS_TDALBNS (YDCPG_DIM%KLON)
REAL (KIND=JPRB)     :: ZTDS_TDRHONS (YDCPG_DIM%KLON)
REAL (KIND=JPRB)     :: ZTDS_TDSNS (YDCPG_DIM%KLON)
REAL (KIND=JPRB)     :: ZTDS_TDTP (YDCPG_DIM%KLON, 1:YDCPG_DIM%YRSURF%YSP_SBD%NLEVS)
REAL (KIND=JPRB)     :: ZTDS_TDTS (YDCPG_DIM%KLON)
REAL (KIND=JPRB)     :: ZTDS_TDWL (YDCPG_DIM%KLON)
REAL (KIND=JPRB)     :: ZTDS_TDWP (YDCPG_DIM%KLON)
REAL (KIND=JPRB)     :: ZTDS_TDWPI (YDCPG_DIM%KLON)
REAL (KIND=JPRB)     :: ZTDS_TDWS (YDCPG_DIM%KLON)
REAL (KIND=JPRB)     :: ZTDS_TDWSI (YDCPG_DIM%KLON)

INTEGER (KIND=JPIM) :: JLEV
INTEGER (KIND=JPIM) :: JROF


IF (.NOT.YDMODEL%YRML_PHY_MF%YRARPHY%LMSE) THEN
  DO JLEV=0,YDCPG_DIM%KFLEVG
    DO JROF=YDCPG_DIM%KIDIA,YDCPG_DIM%KFDIA
      ZPFL_FPLSN(JROF,JLEV)=YDMF_PHYS%OUT%FPLSN(JROF,JLEV)+YDMF_PHYS%OUT%FPLSG(JROF,JLEV)
    ENDDO
  ENDDO
  CALL CPTENDS( YDMODEL%YRML_PHY_MF, YDCPG_DIM%KLON, YDCPG_DIM%KIDIA, YDCPG_DIM%KFDIA, YDCPG_DIM%KFLEVG,                  &
  & YDSURF%YSP_SBD%NLEVS, PDTPHY, YDMF_PHYS%OUT%FPLCL, YDMF_PHYS%OUT%FPLSL, YDMF_PHYS%OUT%FPLCN, ZPFL_FPLSN,              &
  & YDMF_PHYS  %OUT%FRSO, YDMF_PHYS%OUT%FRTH, YDMF_PHYS_SURF%GSP_SG%PA_T1, YDMF_PHYS%OUT%CT, PDSA_C1,                     &
  & PDSA_C2, YDMF_PHYS%OUT%FCHSP, YDMF_PHYS%OUT%FCLL, YDMF_PHYS  %OUT%FCLN, YDMF_PHYS%OUT%FCS,                            &
  & PFLU_FEVI, YDMF_PHYS%OUT%FEVL, YDMF_PHYS%OUT  %FEVN, YDMF_PHYS%OUT%FEVV, YDMF_PHYS%OUT%FGEL, YDMF_PHYS%OUT%FGELS,     &
  & YDMF_PHYS%OUT%FLWSP, YDMF_PHYS%OUT%FONTE, YDMF_PHYS%OUT%FTR, YDMF_PHYS_SURF%GSD_VF%PLSM, YDMF_PHYS_SURF%GSP_SG%PR_T1, &
  & YDMF_PHYS%OUT%RUISL, YDMF_PHYS%OUT%RUISP, YDMF_PHYS%OUT%RUISS, YDMF_PHYS_SURF%GSP_SG%PF_T1,                           &
  & PFLU_VEG, ZTDS_TDTS, ZTDS_TDTP, ZTDS_TDWS, ZTDS_TDWSI, ZTDS_TDWP, ZTDS_TDWPI, ZTDS_TDWL,                              &
  & ZTDS_TDSNS, ZTDS_TDALBNS, ZTDS_TDRHONS)  

  CALL CPWTS(YDSURF, YDMODEL%YRML_AOC%YRMCC, YDMODEL%YRML_PHY_MF%YRPHY, YDMODEL%YRML_PHY_MF%YRPHY1, YDCPG_DIM%KLON, YDCPG_DIM%KIDIA,           &
  & YDCPG_DIM%KFDIA, YDSURF%YSP_SBD%NLEVS, PDTPHY, ZTDS_TDTS, ZTDS_TDTP, ZTDS_TDWS, ZTDS_TDWSI, ZTDS_TDWP,                        &
  & ZTDS_TDWPI, ZTDS_TDWL, ZTDS_TDSNS, ZTDS_TDALBNS, ZTDS_TDRHONS, YDMF_PHYS_SURF%GSD_VP%PTPC, YDMF_PHYS_SURF%GSD_VP%PWPC, &
  & YDMF_PHYS_SURF%GSD_VF%PLSM, YDMF_PHYS_SURF%GSD_VV%PIVEG, YDMF_PHYS_SURF%GSP_RR%PT_T1, YDMF_PHYS_SURF%GSP_SB%PT_T1,     &
  & YDMF_PHYS_SURF%GSP_RR%PW_T1, YDMF_PHYS_SURF%GSP_RR%PIC_T1, YDMF_PHYS_SURF%GSP_SB%PQ_T1, YDMF_PHYS_SURF%GSP_SB%PTL_T1,  &
  & YDMF_PHYS_SURF%GSP_RR%PFC_T1, YDMF_PHYS_SURF%GSP_SG%PF_T1, YDMF_PHYS_SURF%GSP_SG%PA_T1, YDMF_PHYS_SURF%GSP_SG%PR_T1    &
  &                   )  
ELSE
  IF (LDCONFX) THEN
    DO JROF=YDCPG_DIM%KIDIA,YDCPG_DIM%KFDIA
      YDMF_PHYS_SURF%GSP_RR%PT_T0(JROF)=YDCPG_GPAR%VTS(JROF)
    ENDDO
  ELSE
    DO JROF=YDCPG_DIM%KIDIA,YDCPG_DIM%KFDIA
      YDMF_PHYS_SURF%GSP_RR%PT_T1(JROF)=YDCPG_GPAR%VTS(JROF)
    ENDDO
  ENDIF
ENDIF



END SUBROUTINE
