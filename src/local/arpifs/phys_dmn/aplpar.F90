!OPTIONS XOPT(NOEVAL)
SUBROUTINE APLPAR(YDGEOMETRY,YDCPG_DYN,YDMF_PHYS_SURF,YDVARS,YDSURF, YDXFU,YDCFU,YDMODEL,KIDIA , KFDIA  , KLON      ,&
 & KTDIA  , KLEV   , KSTGLO ,&
 & KVCLIS , KVCLIV , KSTEP  ,&
 & KSGST  , KCSS   ,&
 & KBL    , KGPCOMP, KNFRRC , PDT,&
 !---------------------------------------------------------------------
 ! - INPUT .
 & PINDX  , PINDY  ,&
 & LDXFUMSE,PAPHI  , PAPRS  , PAPHIF , PAPRSF , PALPH  , &
 & PDELP  , PLNPR  , PRDELP , &
 & PRCORI ,&
 & PSV    , PU     , PV     , PT     , PQ     , PQI    , PQL    ,&
 & PQSRES , PQRRES  , PG     , PTKE   , PEFB1  , PEFB2  , PEFB3  , PCVV ,&
 & PO3    , PCHEM, PNOGWDU, PNOGWDV, PGFL, PVORT0 ,&
 & PCP    , PCVGQ  , PR     , PKOZO  ,&
 & PFPLCH , PFPLSH ,&
 & PEVEL0,&
 & PGPAR  , PCUCONVCA, PNLCONVCA,&
 & PSNS   , PALBNS , PRHONS ,&
 & PTP    , PTS    , PWL    , PWP    , PWPI   , PWS    , PWSI   ,&
 & PVERVEL,&
 & PEMTD  , PEMTU  , PTRSO  ,&
 & PVRMOON, PMU0   , PMU0LU ,&
 & PMU0M  , PMU0N   ,PGELAM ,&
 & PGEMU  , PGM    , POMPAC , PAC    , PCOR   , PMMU0  , PDHSF  ,&
 & PRAB3C , PRAB3N , PRAB4C , PRAB4N , PRAB6C , PRAB6N ,&
 & PRAT1C , PRAT1N , PRAT2C , PRAT2N , PRAT3C , PRAT3N ,&
 & PRAT4C , PRAT4N , PRAT5C , PRAT5N,&
 & POROG  ,&
 & PWW    , PDIV   , PUL    , PVL    , PWWL   , PWWM  ,&
 ! - INPUT/OUTPUT .
 & PGDEOSI, PGUEOSI, PGMU0, PGMU0_MIN, PGMU0_MAX,&
 & PGDEOTI, PGDEOTI2, PGUEOTI, PGUEOTI2, PGEOLT, PGEOXT,&
 & PGRPROX, PGMIXP, PGFLUXC, PGRSURF,&
 ! - OUTPUT .
 & PDIFCQ , PDIFCQI, PDIFCQL, PDIFCS , PDIFSV , PDIFTQ , PDIFTQI, PDIFTQL,&
 & PDIFTS , PFCCQL , PFCCQN , PFCSQL , PFCSQN , PFCQVNG , PFCQING,&
 & PFCQLNG, PFCQRNG, PFCQSNG, PFCQGNG,&
 & PFPLCL , PFPLCN , PFPLCG,  PFPLSL , PFPLSN , PFPLSG , PFRSO  , PFRSOC ,&
 & PFRTH  , PFRTHC , PSTRCU , PSTRCV , PSTRDU , PSTRDV , PSTRTU ,&
 & PSTRTV , PSTRMU , PSTRMV , PFRMH  , PFRMQ  ,&
 & PDIFCQLC,PDIFCQIC,PFIMCC,&
 & PFEDQLC, PFEDQIC, PFEDQRC, PFEDQSC,&
 & PFCNEGQLC,PFCNEGQIC,PFCNEGQRC,PFCNEGQSC,&
 & PFCHOZ , PCPS   , PLHS   ,&
 & PRS    , PLH    , PLSCPE , PNEB   , PQICE  , PQLI   ,&
 & PQRCONV1, PQSCONV1,&
 & PQSAT  ,&
 & PQW    , PRH    , PTW    , PALB   , PCD    , PCDN   , PCH    ,&
 & PC1    , PC2    , PCT    , PEMIS  , PFCHSP , PFCLL  , PFCLN  ,&
 & PFCS   , PFEVI  , PFEVL  , PFEVN  , PFEVV  , PFLASH , PFTR   , PFLWSP ,&
 & PFONTE , &
 & PFGEL  , PFGELS , PFRSGNI,&
 & PFRSDNI, PFRSODS, PFRSOPS, PFRSOPT, PFRSOLU, PFRTHDS,&
 & PFPFPSL, PFPFPSN, PFPFPSG, PFPFPCL, PFPFPCN, PFPEVPSL,PFPEVPSN,PFPEVPSG,PFPEVPCL,&
 & PFPEVPCN,PFPEVPCG,PFTKE  , PFTKEI,  PFEFB1 , PFEFB2 , PFEFB3  ,PGZ0   , PGZ0H,&
 & PNEIJ  , PVEG   , PQS    ,&
 & PQSATS , PRUISL , PRUISP , PRUISS ,&
 & PUCLS  , PVCLS  , PNUCLS , PNVCLS , PTCLS  , PMRT   ,&
 & PQCLS  , PRHCLS , PCLCT  , PCLCH  , PCLCM  , PCLCL  , PCLCC  ,&
 & PCAPE  , PCTOP  , KCLPH  , PCLPH  , PVEIN  , PUGST  , PVGST  , PDIAGH , &
 & PTPWCLS,PDPRECIPS,PDPRECIPS2,PVISICLD,PVISIHYDRO,PMXCLWC,&
 & PTENDPTKE,PKUROV_H,PKTROV_H,&
 & PDERNSHF, PTENDEXT_DEP, PTRAJ_PHYS,PTDISS,YDDDH,&
 & PFTCNS, &
 & PGP2DSPP )

!**** *APLPAR * - APPEL DES PARAMETRISATIONS PHYSIQUES.

!     Sujet.
!     ------
!     - APPEL DES SOUS-PROGRAMMES DE PARAMETRISATION
!       INTERFACE AVEC LES PARAMETRISATIONS PHYSIQUES (IALPP).
!     - CALL THE SUBROUTINES OF THE E.C.M.W.F. PHYSICS PACKAGE.

!**   Interface.
!     ----------
!        *CALL* *APLPAR*

!-----------------------------------------------------------------------

! -   ARGUMENTS D'ENTREE.
! -   INPUT ARGUMENTS.
!     -------------------

! - NOM DES PARAMETRES DE DIMENSIONNEMENT DE LA PHYSIQUE.
! - DIMENSIONS.

! KBL  : NUMERO DE BLOC NPROMA
! KBL  : NPROMA-PACKETS NUMBER
! KGPCOMP : NOMBRE TOTAL DE POINTS DE GRILLE SUR LE DOMAINE
! KGPCOMP : TOTAL GRID POINTS NUMBER IN THE DOMAIN
! KIDIA, KFDIA : BORNES BOUCLES HORIZONTALES   (IST,IEND DANS CPG).
! KIDIA, KFDIA : START/END OF HORIZONTAL LOOP  (IST,IEND IN *CPG*).
! KLON : DIMENSION HORIZONTALE                 (NPROMA DANS CPG).
! KLON : HORIZONTAL DIMENSION                  (NPROMA IN *CPG*).
! KLON: IDEM BUT FOR ARRAYS USED SOLELY BY DMN PHYSICS
! KTDIA : DEBUT BOUCLE VERTICALE DANS LA PHYSIQUE.
! KTDIA : START OF THE VERTICAL LOOP IN THE PHYSICS (IF SOME LEVELS ARE
!                     SKIPPED AT THE TOP OF THE MODEL).
! KLEV : FIN BOUCLE VERTICE ET DIMENSION VERTICALE (NFLEVG DANS CPG).
! KLEV : END OF VERTICAL LOOP AND VERTICAL DIMENSION(NFLEVG IN *CPG*).
! KSTGLO     : global offset.
! KVCLIS     : NOMBRE DE CHAMPS POUR LA PHOTO-CHIMIE DE L'OZONE.
!                     (NVCLIS DANS CPG).
! KVCLIS     : NUMBER OF FIELDS FOR OZONE PHOTO-CHEMISTRY.
!                     (NVCLIS IN CPG).
! KVCLIV     : NOMBRE DE CHAMPS POUR LA VEGETATION (NVCLIV DANS CPG).
! KVCLIV     : NUMBER OF FIELDS FOR VEGETATION (NVCLIV IN CPG).
! KSGST      : NOMBRE DE TEMPERATURES ET DE FLUX DE SURFACE SOUS-MAILLE
!                     (NTSSG DANS CPG)
! KSGST      : NUMBER OF SUBGRID SURFACE TEMPERATURES AND FLUXES
!                     (NTSSG IN *CPG*)
! KCSS       : NBRE DE NIVEAUX DANS LE SOL PROFOND
! KCSS       : NBR OF VERTICAL LAYERS IN THE DEEP SOIL
! KNFRRC     : FREQUENCE DE CALCUL DU RAYONNEMENT CLEAR SKY
! KNFRRC     : FREQUENCY FOR CLEAR SKY RADIATION CALCULATION
! PDT        : TIME STEP (in s)

! LOGICAL
! LDXFUMSE   : T if CDCONF=X in order not to increment surfex timer in that case

! - NOM DES VARIABLES DE LA PHYSIQUE (PAR ORDRE ALPHABETIQUE DANS CHAQUE
!   CATEGORIE).

! - 2D (0:KLEV) .

! PAPHI      : GEOPOTENTIEL AUX DEMI-NIVEAUX.
! PAPHI      : GEOPOTENTIAL ON HALF-LEVELS.
! PAPRS      : PRESSION AUX DEMI-NIVEAUX.
! PAPRS      : PRESSURE ON HALF-LEVELS.

! - 2D (1:KLEV) .

! PAPHIF     : GEOPOTENTIEL AUX NIVEAUX DES COUCHES.
! PAPHIF     : GEOPOTENTIAL ON FULL LEVELS.
! PAPRSF     : PRESSION AUX NIVEAUX DES COUCHES.
! PAPRSF     : PRESSURE ON FULL LEVELS.
! PALPH      : LOG(PAPRS(JLEV)/PAPRSF(JLEV)) (POUR L'HYDROSTATIQUE).
! PALPH      : LOG(PAPRS(JLEV)/PAPRSF(JLEV)) (FOR HYDROSTATICS).
! PDDAL      : FRACTION DE LA MAILLE POUR LE DOWNDRAUGHT
! PDDAL      : DOWNDRAUGHT MESH FRACTION
! PDDOM      : VITESSE VERTICALE DU DOWNDRAUGHT
! PDDOM      : DOWNDRAUGHT VERTICAL VELOCITY
! PDELP      : EPAISSEUR EN PRESSION DE LA COUCHE.
! PDELP      : LAYER THICKNESS IN PRESSURE UNITS.
! PENTCH     : L'ENTRAINMENT PRONOSTIQUE/ PSEUDO HISTORIQUE
! PENTCH     : PROGNOSTIC/ PSEUDO HISTORIC  ENTRAINMENT
! PEVEL0     : ETA_dot*d(Pi)/d(ETA) aux niveaux des couches
! PEVEL0     : ETA_dot*d(Pi)/d(ETA)at full levels
! PLNPR      : LOG(PAPRS(JLEV)/PAPRS(JLEV-1)) (POUR L'HYDROSTATIQUE).
! PLNPR      : LOG(PAPRS(JLEV)/PAPRS(JLEV-1)) (FOR HYDROSTATICS).
! PRDELP     : INVERSE DE L'EPAISSEUR EN PRESSION DE LA COUCHE.
! PRDELP     : INVERSE OF PDELP.
! PSV        : SCALAIRES PASSIFS
! PSV        : PASSIVE SCALAR
! PU         : COMPOSANTE EN X DU VENT.
! PU         : X-COMPONENT OF WIND.
! PUDAL      : FRACTION DE LA MAILLE POUR L'UPDRAUGHT
! PUDAL      : UPDRAUGHT MESH FRACTION
! PUDOM      : VITESSE VERTICALE DE L'UPDRAUGHT
! PUDOM      : UPDRAUGHT VERTICAL VELOCITY
! PUNEBH     : FRACTION DETRAINEE (PSEUDO) HISTORIQUE
! PUNEBH     : (PSEUDO) HISTORIC DETRAINED FRACTION
! PRKTH      : RASCH-KRISTJANSSON - TENDENCE D'ENTHALPY
! PRKTQV     : RASCH-KRISTJANSSON - TENDENCE DE LA VAPEUR D'EAU
! PRKTQC     : RASCH-KRISTJANSSON - TENDENCE DE CONDENSATS
! PTTE       : TOTAL TURBULENT ENERGY.
! PMXL       : PROGNOSTIC MIXING LENGTH.
! PSCC2      : DEFICIT TO SATURATION^2 IN TOMPKINS.
! PGCCA      : SKEWNES IN TOMPKINS.
! PV         : COMPOSANTE EN Y DU VENT.
! PV         : Y-COMPONENT OF WIND.
! PT         : TEMPERATURE.
! PQ         : HUMIDITE SPECIFIQUE DE LA VAPEUR D'EAU.
! PQ         : SPECIFIC HUMIDITY OF WATER VAPOUR.
! PQI        : GLACE.
! PQI        : ICE.
! PQSRES     : NEIGE
! PQSRES     : SNOW
! PQRRES     : RAIN (PR is already used by gas constant !)
! PQRRES     : PLUIE
! PG         : GRAUPEL
! PTKE       : Energie Cinetique Turbulente
! PTKE       : TKE
! PQL        : EAU LIQUIDE.
! PQL        : LIQUID WATER.
! PQLCONV    : LIQUID WATER (CONVECTIVE).
! PQICONV    : ICE    WATER (CONVECTIVE).
! PQRCONV    : RAIN   WATER (CONVECTIVE).
! PQSCONV    : SNOW   WATER (CONVECTIVE).
! PVORT0     : TOURBILLON RELATIF.
! PVORT0     : RELATIVE VORTICITY.
! PCVV       : Convective Vertical Velocity
! PO3        : GFL OZONE.
! PCHEM      : GFL CHEMISTRY
! PGFL       : GFL FIELDS
! PNOGWDU    : GFL NON OROG. GRAVITY WAVE DRAG (ZONAL)
! PNOGWDV    : GFL NON OROG. GRAVITY WAVE DRAG (MERID)
! PCP        : CHALEUR MASSIQUE A PRESSION CONSTANTE DE L'AIR.
! PCP        : SPECIFIC HEAT AT CONSTANT PRESSURE FOR AIR.
! PCVGQ      : CONVERGENCE D'HUMIDITE (CONDITION DE "KUO").
! PCVGQ      : CONVERGENCE OF HUMIDITY ("KUO" CONDITION).
! PKOZO      : CHAMPS POUR LA PHOTOCHIMIE DE L'OZONE (KVCLIS CHAMPS).
! PKOZO      : FIELDS FOR PHOTOCHEMISTERY OF OZONE   (KVCLIS FIELDS).
! PR         : CONSTANTE DES GAZ POUR L'AIR.
! PR         : GAS CONSTANT FOR AIR.
! PWW        : VERTICAL VELOCITY (PWL is reserved so Z-component of wind is WW)
! PDIV       : HORIZONTAL DIVERGENCE
! PUL        : ZONAL DERIVATIVE OF X-COMPONENT OF WIND
! PVL        : ZONAL DERIVATIVE OF Y-COMPONENT OF WIND
! PWWL       : ZONAL DERIVATIVE OF Z-COMPONENT OF WIND
! PWWM       : MERIDIONAL DERIVATIVE OF Z-COMPONENT OF WIND

! - 1D (PROGNOSTIQUE) .
! - 1D (PROGNOSTIC QUANTITIES) .

! PALBNS     : ALBEDO DE LA NEIGE.
! PALBNS     : SNOW ALBEDO.
! PRHONS     : DENSITE DE LA NEIGE.
! PRHONS     : SNOW DENSITY.
! PSNS       : MASSE PAR UNITE DE SURFACE DE LA COUCHE NEIGEUSE.
! PSNS       : MASS OF SNOW PER UNIT SURFACE.
! PTP        : TEMPERATURE EN PROFONDEUR.
! PTP        : DEEP-LAYER TEMPERATURE.
! PTS        : TEMPERATURE DE SURFACE.
! PTS        : SURFACE LAYER TEMPERATURE.
! PWL        : CONTENU EN EAU DU RESERVOIR SUPERFICIEL
! PWL        : SKIN RESERVOIR WATER CONTENT
! PWP        : CONTENU EN EAU DU RESERVOIR EN PROFONDEUR.
! PWP        : DEEP-LAYER WATER CONTENT.
! PWPI       : CONTENU EN EAU GELEE DU RESERVOIR EN PROFONDEUR.
! PWPI       : DEEP-LAYER ICE CONTENT.
! PWS        : CONTENU EN EAU DU RESERVOIR DE SURFACE.
! PWS        : SURFACE LAYER WATER CONTENT.
! PWSI       : CONTENU EN EAU GELEE DU RESERVOIR DE SURFACE.
! PWSI       : SURFACE LAYER ICE CONTENT.

! - 1D (GEOGRAPHIQUE) .
! - 1D (GEOGRAPHICAL DISTRIBUTION) .

! PAESEA     : AEROSOLS MARINS (SI LAEROSEA=.T.)
! PAESEA     : MARINE AEROSOLS (IF LAEROSEA=.T.)
! PAELAN     : AEROSOLS CONTINENTAUX (SI LAEROLAN=.T.)
! PAELAN     : CONTINENTAL AEROSOLS (IF LAEROLAN=.T.)
! PAESOO     : AEROSOLS CARBONES (SI LAEROSOO=.T.)
! PAESOO     : SOOT AEROSOLS (IF LAEROSOO=.T.)
! PAEDES     : AEROSOLS DESERTIQUES (SI LAERODES=.T.)
! PAEDES     : DESERT AEROSOLS (IF LAERODES=.T.=
! PAESUL     : AEROSOLS SULFATES (SI LAEROSUL=.T.)
! PAESUL     : SULFATE AEROSOLS  (IF LAEROSUL=.T.)
! PAEVOL     : AEROSOLS VOLCAN   (SI LAEROVOL=.T.)
! PAEVOL     : VOLCANO AEROSOLS  (IF LAEROVOL=.T.)
! PALV       : ALBEDO DE LA VEGETATION.
! PALV       : VEGETATION ALBEDO.
! PALBF      : ALBEDO FIXE (SOL SANS NEIGE).
! PALBF      : BACKGROUND SURFACE SHORTWAVE ALBEDO (SNOW-FREE).
! PALBSF     : ALBEDO FIXE DU SOL (SOL SANS NEIGE).
! PALBSF     : BACKGROUND SOIL SHORTWAVE ALBEDO (SNOW-FREE).
! PARG       : POURCENTAGE D'ARGILE DANS LE SOL.
! PARG       : SILT PERCENTAGE WITHIN THE SOIL.
! PD2        : EPAISSEUR DU RESERVOIR PROFOND.
! PD2        : DEEP-LAYER OF THE OF THE PROFOUND WATER-TANK.
! PEMISF     : EMISSIVITE FIXE (SOL SANS NEIGE).
! PEMISF     : BACKGROUND SURFACE LONGWAVE EMISSIVITY (SNOW-FREE).
! PGETRL     : ECART TYPE DE L'OROGRAPHIE (EN J/KG).
! PGETRL     : STANDARD DEVIATION OF OROGRAPHY  (UNIT: J/KG).
! PLSM       : INDICE TERRE/MER.
! PLSM       : LAND/SEA MASK.
! PIVEG      : TYPE DE VEGETATION.
! PIVEG      : TYPE OF VEGETATION.
! PLAI       : INDICE FOLIAIRE.
! PLAI       : FOLIAIRE INDICE.
! PRCORI     : FACTEUR DE CORIOLIS.
! PRCORI     : CORIOLIS FACTOR.
! PRSMIN     : RESISTANCE STOMATIQUE MINIMALE.
! PRSMIN     : STOMATAL MINIMAL RESISTANCE.
! PSAB       : POURCENTAGE DE SABLE DANS LE SOL.
! PSAB       : PERCENTAGE OF SAND WITHIN THE SOIL.
! PVEG0      : PROPORTION DE SOL COUVERTE DE VEGETATION.
! PVEG0      : FRACTIONAL COVER BY VEGETATION.
! PVRLAN     : ANISOTROPIE DU RELIEF SOUS MAILLE.
! PVRLDI     : ANGLE DE LA DIRECTION DU RELIEF AVEC L'AXE DES X.
! PVO3ABC    : A,B and C coef for climatological ozone profiles
! PVRMOON    : Moon radiation
! PGZ0F      : GRAVITY * ROUGHNESS LENGTH (TIME VARIABLE).
! PGZ0F      : CHAMP TEMPOREL DE G FOIS LA LONGUEUR DE RUGOSITE.
! PGZ0RLF    : GRAVITY * RELIEF ROUGHNESS LENGTH (TIME VARIABLE).
! PGZ0RLF    : CHAMP TEMPOREL DE G FOIS LA LONGUEUR DE RUGOSITE
!              DUE AU RELIEF.
! PGZ0HF     : G*LONGUEUR DE RUGOSITE THERMIQUE (SI KVCLIV >= 8)
! PGZ0HF     : G*THERMAL ROUGHNESS LENGTH (IF KVCLIV >= 8)

! - 1D (DIAGNOSTIQUE) .
! - 1D (DIAGNOSTIC QUANTITIES).

! PHV        : RESISTANCE A L'EVAPOTRANSPIRATION.
! PHV        : RESISTANCE TO EVAPOTRANSPIRATION.
! PVERVEL    : (OMEGA/P) VERT. VEL. DIVIDED BY PRESSURE.
! PMU0       : COSINUS LOCAL INSTANTANE DE L'ANGLE ZENITHAL SOLAIRE.
! PMU0LU     : COSINUS LOCAL INSTANTANE DE L'ANGLE ZENITHAL LUNAIRE.
! PMU0       : LOCAL COSINE OF INSTANTANEOUS SOLAR ZENITH ANGLE.
! PMU0LU     : LOCAL COSINE OF INSTANTANEOUS LUNAR ZENITH ANGLE.
! PMU0M      : COSINUS LOCAL MOYEN DE L'ANGLE ZENITHAL.
! PMU0M      : LOCAL COSINE OF AVERAGED SOLAR ZENITH ANGLE.
! PMU0N      : COSINUS LOCAL AU PAS DE TEMPS SUIVANT DE L'ANGLE ZENITHAL SOLAIRE.
! PMU0N      : NEXT TIME STEP COSINUS LOCAL INSTANTANE DE L'ANGLE ZENITHAL SOLAIRE.
! PFPLCH     : CHAMP "HISTORIQUE" POUR LES PRECIPITATIONS CONVECTIVES.
! PFPLCH     : HISTORICAL FIELD FOR CONVECTIVE PRECIPITATIONS.
! PFPLSH     : CHAMP "HISTORIQUE" POUR LES PRECIPITATIONS STRATIFORMES.
! PFPLSH     : HISTORICAL FIELD FOR STRATIFORM PRECIPITATIONS.
! PGPAR       : BUFFER FOR 2D FIELDS - CONTAINS PRECIP, ALBEDO, EMISS, TS
!             : SURFACE FLUXES

! PMMU0      : MEAN SOLAR ANGLE FOR GIVEN GRID POINT FOR SIMPL.
!              RADIATION SCHEME.
! PDHSF      : DISTRIBUTION OF HORIZONTAL MEAN WEIGHTS USED FOR
!              SIMPLIFIED RADIATION SCHEME.

! PFHPS      : PSEUDO-HISTORICAL ARRAY FOR SURF PRECIP SENSIBLE HEAT FLUX
! PTCCH      : PSEUDO-HISTORICAL ARRAY FOR TOTAL CONVECTIVE CLOUDINESS (1D).
! PSCCH      : PSEUDO-HISTORICAL ARRAY FOR CONVECTIVE CLOUD SUMMIT (1D).
! PBCCH      : PSEUDO-HISTORICAL ARRAY FOR CONVECTIVE CLOUD BASE (1D).
! PPBLH      : PSEUDO-HISTORICAL ARRAY FOR PBL HEIGHT (1D).
! PQSH       : PSEUDO-HISTORICAL ARRAY FOR SURFACE MOISTURE (1D).
! PUDGRO     : PSEUDO-HISTORICAL ARRAY FOR UPDRAFT RISING TOP (1D) - ACCSU
!              FRACTION OF PATH COMPLETED ABOVE LAST ACTIVE LEVEL AT T9

! - CONSTANTES

! POMPAC    : Horizontally variable Curtis matrix for thermal rad. (clear sky)
! PAC       : Horizontally cst Curtis matrix for thermal rad. (clear sky)
! PCOR      : CORRECTION FOR CLOUDINESS FOR THERMAL RADIATION

! PRAB3C    : CLEAR-SKY PARALLEL/DIFFUSE REFLECTIVITY.  ---
! PRAB4C    : CLEAR-SKY DIFFUSE TRANSMISSIVITY.            | equivalent
! PRAB6C    : CLEAR-SKY DIFFUSE REFLECTIVITY.              | coefficients
! PRAB3N    : CLOUDY PARALLEL/DIFFUSE REFLECTIVITY.        | from bottom
! PRAB4N    : CLOUDY DIFFUSE TRANSMISSIVITY.               | to given
! PRAB6N    : CLOUDY DIFFUSE REFLECTIVITY.              ---  level

! PRAT1C    : CLEAR-SKY PARALLEL TRANSMISSIVITY.        ---
! PRAT2C    : CLEAR-SKY PARALLEL/DIFFUSE TRANSMISSIVITY.   |
! PRAT3C    : CLEAR-SKY PARALLEL/DIFFUSE REFLECTIVITY.     |
! PRAT4C    : CLEAR-SKY DIFFUSE TRANSMISSIVITY.            | equivalent
! PRAT5C    : CLEAR-SKY DIFFUSE REFLECTIVITY.              | coefficients
! PRAT1N    : CLOUDY PARALLEL TRANSMISSIVITY.              | from top
! PRAT2N    : CLOUDY PARALLEL/DIFFUSE TRANSMISSIVITY.      | to given
! PRAT3N    : CLOUDY PARALLEL/DIFFUSE REFLECTIVITY.        | level
! PRAT4N    : CLOUDY DIFFUSE TRANSMISSIVITY.               |
! PRAT5N    : CLOUDY DIFFUSE REFLECTIVITY.              ---

!-----------------------------------------------------------------------

! -   INPUT/OUTPUT ARGUMENTS.
!     -----------------------

! - 2D (ACRANEB2 INTERMITTENCY STORAGE)

! PGDEOSI   : DESCENDING INCREMENTAL OPTICAL DEPTHS, SOLAR
! PGUEOSI   : ASCENDING  INCREMENTAL OPTICAL DEPTHS, SOLAR
! PGMU0     : COSINE OF SOLAR ZENITH ANGLE, APPROXIMATE ACTUAL VALUE
! PGMU0_MIN : COSINE OF SOLAR ZENITH ANGLE, MIN VALUE
! PGMU0_MAX : COSINE OF SOLAR ZENITH ANGLE, MAX VALUE
! PGDEOTI   : DESCENDING INCREMENTAL OPTICAL DEPTHS, dB/dT(T0) WEIGHTS
! PGDEOTI2  : DESCENDING INCREMENTAL OPTICAL DEPTHS, B WEIGHTS WITH
!             LINEAR T_e CORRECTION
! PGUEOTI   : ASCENDING INCREMENTAL OPTICAL DEPTHS, dB/dT(T0) WEIGHTS
! PGUEOTI2  : ASCENDING INCREMENTAL OPTICAL DEPTHS, B WEIGHTS WITH
!             LINEAR T_e CORRECTION
! PGEOLT    : LOCAL OPTICAL DEPTHS, dB/dT(T0) WEIGHTS
! PGEOXT    : MAXIMUM OPTICAL DEPTHS FOR EBL-EAL, dB/dT(T0) WEIGHTS
! PGRPROX   : CORRECTION TERM FOR ADJACENT EXCHANGES
! PGMIXP    : NON-STATISTICAL WEIGHTS FOR BRACKETING
! PGFLUXC   : OUT OF BRACKET PART OF CLEARSKY EBL, RESP. EBL-EAL FLUX

! - 1D (ACRANEB2 INTERMITTENCY STORAGE)

! PGRSURF   : CORRECTIVE RATIO FOR SURFACE CTS CONTRIBUTION

!-----------------------------------------------------------------------

! -   ARGUMENTS DE SORTIE.
! -   OUTPUT ARGUMENTS.
!     --------------------

! - NOM DES VARIABLES DE LA PHYSIQUE (PAR ORDRE ALPHABETIQUE DANS CHAQUE
!   CATEGORIE).

! - 2D (0:KLEV) .

! PDIFCQ     : FLUX CONVECTIF D'HUMIDITE SPECIFIQUE (HORS PLUIE/NEIGE).
! PDIFCQ     : CONVECTIVE FLUX OF SPECIFIC HUMIDITY (NOT RAIN/SNOW).
! PDIFCQI    : FLUX CONVECTIF D'EAU SOLIDE (HORS PLUIE/NEIGE).
! PDIFCQI    : CONVECTIVE FLUX OF SOLID WATER (NOT RAIN/SNOW).
! PDIFCQL    : FLUX CONVECTIF D'EAU LIQUIDE (HORS PLUIE/NEIGE).
! PDIFCQL    : CONVECTIVE FLUX OF LIQUID WATER (NOT RAIN/SNOW).
! PDIFCS     : FLUX CONVECTIF D'ENTHALPIE (HORS PLUIE/NEIGE).
! PDIFCS     : CONVECTIVE FLUX OF ENTHALPY (NOT RAIN/SNOW).
! PDIFSV     : FLUX TURBULENT DES SCALAIRES PASSIFS.
! PDIFSV     : TURBULENT FLUX OF PASSIVE SCALAR.
! PDIFTQ     : FLUX TURBULENT (ET Q NEGATIF) D'HUMIDITE SPECIFIQUE.
! PDIFTQ     : TURBULENT FLUX (INC. Q NEGATIVE) OF SPECIFIC HUMIDITY.
! PDIFTQI    : FLUX TURBULENT (ET Q NEGATIF) D'EAU GLACE.
! PDIFTQI    : TURBULENT FLUX (INC. Q NEGATIVE) OF SOLID WATER.
! PDIFTQL    : FLUX TURBULENT (ET Q NEGATIF) D'EAU LIQUIDE.
! PDIFTQL    : TURBULENT FLUX (INC. Q NEGATIVE) OF LIQUID WATER.
! PDIFTS     : FLUX TURBULENT D'ENTHALPIE (OU D'ENERGIE STATIQUE SECHE).
! PDIFTS     : TURBULENT FLUX OF ENTHALPY (OR DRY STATIC ENERGY).
! PFCHOZ     : FLUX PHOTO-CHIMIQUE D'OZONE.
! PFCHOZ     : OZONE PHOTO-CHEMICAL FLUX.
! PFCCQN     : FLUX DE CONDENSATION LIE AUX RR CONVECTIVES NEIGEUSES.
! PFCCQN     : CONVECTIVE CONDENSATION FLUX FOR ICE.
! PFCCQL     : FLUX DE CONDENSATION LIE AUX RR CONVECTIVES LIQUIDES.
! PFCCQL     : CONVECTIVE CONDENSATION FLUX FOR LIQUID WATER.
! PFCQVNG    : FLUX FICTIF DE VAPEUR POUR CORRIGER LES Q<0.
! PFCQVNG    : PSEUDO-FLUX OF WATER VAPOUR TO CORRECT FOR Q<0.
! PFCQING    : FLUX FICTIF DE GLACE POUR CORRIGER LES QI<0.
! PFCQING    : PSEUDO-FLUX OF ICE TO CORRECT FOR QI<0.
! PFCQLNG    : FLUX FICTIF D'EAU LIQUIDE POUR CORRIGER LES QL<0.
! PFCQLNG    : PSEUDO-FLUX OF LIQUID WATER TO CORRECT FOR QL<0.
! PFCQSNG    : FLUX FICTIF DE GLACE POUR CORRIGER LES QS<0.
! PFCQSNG    : PSEUDO-FLUX OF ICE TO CORRECT FOR QS<0.
! PFCQRNG    : FLUX FICTIF D'EAU LIQUIDE POUR CORRIGER LES QR<0.
! PFCQRNG    : PSEUDO-FLUX OF LIQUID WATER TO CORRECT FOR QR<0.
! PFPEVPSL   : FLUX DE PRECIPITATIONS DU A L'EVAPORATION RESOLUE.
! PFPEVPSL   : PRECIPITATION FLUX DUE TO RESOLVED EVAPORATION.
! PFPEVPSN   : FLUX DE PRECIPITATIONS DU A LA SUBLIMATION RESOLUE.
! PFPEVPSN   : PRECIPITATION FLUX DUE TO RESOLVED SUBLIMATION.
! PFPEVPSG   : FLUX DE PRECIPITATIONS (GRAUPEL) DU A LA SUBLIMATION RESOLU>
! PFPEVPSG   : PRECIPITATION FLUX (GRAUPEL) DUE TO RESOLVED SUBLIMATION
! PFPEVPCL   : FLUX DE PRECIPITATIONS DU A L'EVAPORATION CONVECTIVE.
! PFPEVPCL   : PRECIPITATION FLUX DUE TO CONVECTIVE EVAPORATION.
! PFPEVPCN   : FLUX DE PRECIPITATIONS DU A LA SUBLIMATION CONVECTIVE. (NEIGE)
! PFPEVPCN   : PRECIPITATION FLUX DUE TO CONVECTIVE SUBLIMATION. (SNOW)
! PFPEVPCG   : FLUX DE PRECIPITATIONS DU A LA SUBLIMATION CONVECTIVE (GRAUPEL).
! PFPEVPCG   : PRECIPITATION FLUX DUE TO CONVECTIVE SUBLIMATION (GRAUPEL).
! PFTKE      : FLUX DE TKE.
! PFTKE      : TKE FLUX.
! PFPFPSL    : FLUX DE PRECIPITATION RESOLUE : TERME DE GENERATION/FORMATION.
! PFPFPSL    : FLUX OF RESOLVED PRECIPITATION : THE GENERATION TERM.
! PFPFPSN    : FLUX DE PRECIPITATION RESOLUE : TERME DE GENERATION/FORMATION.
! PFPFPSN    : FLUX OF RESOLVED PRECIPITATION : THE GENERATION TERM.
! PFPFPSG    : FLUX DE PRECIPITATION RESOLU (GRAUPEL) : TERME DE GENERATION/FORMATION.
! PFPFPSG    : FLUX OF RESOLVED PRECIPITATION (GRAUPEL) : THE GENERATION TERM
! PFPFPCL    : FLUX DE PRECIPITATION CONVECTIVE: TERME DE GENERATION/FORMATION.
! PFPFPCL    : FLUX OF CONVECTIVE PRECIPITATION : THE GENERATION TERM.
! PFPFPCN    : FLUX DE PRECIPITATION CONVECTIVE: TERME DE GENERATION/FORMATION.
! PFPFPCN    : FLUX OF CONVECTIVE PRECIPITATION : THE GENERATION TERM.
! PFPLCL     : PRECIPITATIONS CONVECTIVES SOUS FORME LIQUIDE.
! PFPLCL     : CONVECTIVE PRECIPITATION AS RAIN.
! PFPLCN     : PRECIPITATIONS CONVECTIVES SOUS FORME NEIGE.
! PFPLCN     : CONVECTIVE PRECIPITATION AS SNOW.
! PFPLCG     : PRECIPITATIONS CONVECTIVES SOUS FORME GRAUPEL 
! PFPLCG     : CONVECTIVE PRECIPITATION AS GRAUPEL
! PFPLSL     : PRECIPITATIONS STRATIFORMES SOUS FORME LIQUIDE.
! PFPLSL     : STRATIFORM PRECIPITATION AS RAIN.
! PFPLSN     : PRECIPITATIONS STRATIFORMES SOUS FORME NEIGE.
! PFPLSN     : STRATIFORM PRECIPITATION AS SNOW.
! PFPLSG     : PRECIPITATIONS STRATIFOR:ES SOUS FORME GRAUPEL.
! PFPLSG     : STRATIFORMES PRECIPITATION AS GRAUPEL.
! PFRMH      : FLUX MESOSPHERIQUE D'ENTHALPIE.
! PFRMH      : MESOSPHERIC ENTHALPY FLUX.
! PFRMQ      : FLUX MESOSPHERIQUE D'humidite.
! PFRMQ      : MESOSPHERIC humidity flux
! PFRSO      : FLUX DE RAYONNEMENT SOLAIRE.
! PFRSO      : SHORTWAVE RADIATIVE FLUX.
! PFRTH      : FLUX DE RAYONNEMENT THERMIQUE.
! PFRTH      : LONGWAVE RADIATIVE FLUX.
! PFCSQN     : FLUX DE CONDENSATION LIE AUX RR STRATIFORMES NEIGEUSES.
! PFCSQN     : STRATIFORM CONDENSATION FLUX FOR ICE.
! PFCSQL     : FLUX DE CONDENSATION LIE AUX RR STRATIFORMES LIQUIDES.
! PFCSQL     : STRATIFORM CONDENSATION FLUX FOR LIQUID WATER.
! PSTRCU     : FLUX CONVECTIF DE QUANTITE DE MOUVEMENT "U".
! PSTRCU     : CONVECTIVE FLUX OF MOMENTUM "U".
! PSTRCV     : FLUX CONVECTIF DE QUANTITE DE MOUVEMENT "V".
! PSTRCV     : CONVECTIVE FLUX OF MOMENTUM "V".
! PSTRDU     : FLUX "GRAVITY WAVE DRAG" "U".
! PSTRDU     : GRAVITY WAVE DRAG FLUX "U".
! PSTRDV     : FLUX "GRAVITY WAVE DRAG" "V".
! PSTRDV     : GRAVITY WAVE DRAG FLUX "V".
! PSTRTU     : FLUX TURBULENT DE QUANTITE DE MOUVEMENT "U".
! PSTRTU     : TURBULENT FLUX OF MOMENTUM "U".
! PSTRTV     : FLUX TURBULENT DE QUANTITE DE MOUVEMENT "V".
! PSTRTV     : TURBULENT FLUX OF MOMENTUM "V".
! PSTRMU     : FLUX MESOSPHERIQUE DE QUANTITE DE MOUVEMENT "U".
! PSTRMU     : MESOSPHERIC FLUX FOR "U"-MOMENTUM.
! PSTRMV     : FLUX MESOSPHERIQUE DE QUANTITE DE MOUVEMENT "V".
! PSTRMV     : MESOSPHERIC FLUX FOR "V"-MOMENTUM.
! PDIFCQLC   : CONVECTIVE TRANSPORT FLUX OF QLC (LIQUID CONVECTIVE).
! PDIFCQIC   : CONVECTIVE TRANSPORT FLUX OF QIC (ICE CONVECTIVE).
! PFIMCC     : Q FLUX DUE TO ICING-MELTING FOLLOWING CONVECTIVE TRANSPORT OF CONVECTIVE LIQUID AND ICE WATER.
! PFEDQLC    : ENTRAINMENT-DETRAINMENT OF QLC AND QLR (LIQUID CONVECTIVE AND RESOLVED).
! PFEDQIC    : ENTRAINMENT-DETRAINMENT OF QIC AND QIR (ICE    CONVECTIVE AND RESOLVED).
! PFEDQRC    : ENTRAINMENT-DETRAINMENT OF QRC AND QRR (RAIN   CONVECTIVE AND RESOLVED).
! PFEDQSC    : ENTRAINMENT-DETRAINMENT OF QSC AND QSR (SNOW   CONVECTIVE AND RESOLVED).
! PFCNEGQLC  : CORRECT NEGATIVE VALUES OF QLC (LIQUID CONVECTIVE).
! PFCNEGQIC  : CORRECT NEGATIVE VALUES OF QIC (ICE    CONVECTIVE).
! PFCNEGQRC  : CORRECT NEGATIVE VALUES OF QRC (RAIN   CONVECTIVE).
! PFCNEGQSC  : CORRECT NEGATIVE VALUES OF QSC (SNOW   CONVECTIVE).

! - 2D (1:KLEV) .

! PLH        : CHALEUR LATENTE A LA TEMPERATURE DE L'AIR.
! PLH        : LATENT HEAT AT AIR TEMPERATURE.
! PLSCPE     : RAPPORT EFECTIF DES L ET CP EN CONDENSATION/EVAPORATION.
! PLSCPE     : EFFECTIVE RATIO OF L AND CP FOR CONDENSATION/EVAPORATION.
! PNEB       : NEBULOSITE PARTIELLE "RADIATIVE".
! PNEB       : FRACTIONAL CLOUDINESS FOR RADIATION.
! PQICE      : HUMIDITE SPECIFIQUE SOLIDE "RADIATIVE".
! PQICE      : SPECIFIC HUMIDITY OF SOLID WATER FOR RADIATION.
! PQLI       : HUMIDITE SPECIFIQUE LIQUIDE "RADIATIVE".
! PQLI       : SPECIFIC HUMIDITY OF LIQUID WATER FOR RADIATION.
! PQSAT      : HUMIDITE SPECIFIQUE DE SATURATION.
! PQSAT      : SPECIFIC HUMIDITY AT SATURATION.
! PQW        : HUMIDITE SPECIFIQUE DU THERMOMETRE MOUILLE.
! PQW        : SPECIFIC HUMIDITY OF THE WET THERMOMETER.
! PRH        : HUMIDITE RELATIVE.
! PRH        : RELATIVE HUMIDITY.
! PTW        : TEMPERATURE DU THERMOMETRE MOUILLE.
! PTW        : TEMPERATURE OF THE WET THERMOMETER.
! PTENDPTKE  : INCREMENT DE LA ENERGIE CINETIQUE TURBULENTE (schema pTKE)
! PTENDPTKE  : TKE INCREMENT (USED BY PSEUDOPROGNOSTIC TKE SCHEME)
! PKUROV_H   : Coefficient d'echange horizontal de u et v
! PKUROV_H   : Horizontal exchange coefficient for momentum
! PKTROV_H   : Coefficient d'echange horizontal de T et q
! PKTROV_H   : Horizontal exchange coefficient for heat

! - 2D (CLOUD AND RADIATION I/O FOR ECMWF PHYSICS)

! PEMTD      : DOWNWARD LONGWAVE EMISSIVITY
! PEMTU      : UPWARD   LONGWAVE EMISSIVITY
! PTRSO      : SHORTWAVE TRANSMISSIVITY
! ZTENT      : TENDENCY OF TEMPERATURE.
! PDERNSHF   : DERIVATIVE OF THE NON SOLAR SURFACE WITH RESPECT TO Tsurf

! - 2D (0:1)
! PFRSOC     : SHORTWAVE CLEAR SKY RADIATIVE FLUX
! PFRTHC     : LONGWAVE CLEAR SKY RADIATIVE FLUX

! - 1D (DIAGNOSTIQUE) .

! PALB       : ALBEDO DE SURFACE COURANT.
! PALB       : MODEL SURFACE SHORTWAVE ALBEDO.
! PCD        : COEFFICIENT D'ECHANGE EN SURFACE POUR U ET V.
! PCD        : EXCHANGE COEFFICIENT AT SURFACE LEVEL FOR U AND V.
! PCDN       : COEFFICIENT NEUTRE D'ECHANGE EN SURFACE.
! PCDN       : EXCHANGE COEFF. AT SURFACE LEVEL IN NEUTRAL CONDITIONS.
! PCH        : COEFFICIENT D'ECHANGE EN SURFACE POUR T ET Q.
! PCH        : EXCHANGE COEFFICIENT AT SURFACE LEVEL FOR T AND Q.
! PCPS       : CHALEUR MASSIQUE DE L'AIR EN SURFACE.
! PC1        : COEFF. HYDRIQUE REPRESENTANT L'INTENSITE AVEC LAQUELLE
!              LES FLUX DE SURFACE PARTICIPENT A L'EVOLUTION DE WS.
! PC1        : HYDROLOGICAL COEFF. SHOWING THE CONTRIBUTION OF SURFACE
!              FLUXES IN THE WS EVOLUTION.
! PC2        : COEFF. HYDRIQUE TRADUISANT LA RAPIDITE DES TRANSFERTS
!              D'EAU ENTRE LES DEUX RESERVOIRS.
! PC2        : HYDROLOGICAL COEFFICIENT SHOWING THE QUICKNESS OF WATER
!              TRANSFERS BETWEEN BOTH TANKS.
! PCT        : COEFFICIENT THERMIQUE DU MILIEU SOL-VEGETATION.
! PCT        : THERMICAL COEFFICIENT OF SOIL-VEGETATION MIDDEL.
! PEMIS      : EMISSIVITE DE SURFACE COURANTE.
! PEMIS      : MODEL SURFACE LONGWAVE EMISSIVITY.
! PFCHSP     : FLUX DE CHALEUR DE LA SURFACE VERS LE SOL PROFOND.
! PFCHSP     : HEAT FLUX FROM SURFACE TO DEEP SOIL.
! PFCLL      : FLUX DE CHALEUR LATENTE SUR EAU LIQUIDE (OU SOL HUMIDE).
! PFCLL      : LATENT HEAT FLUX OVER LIQUID WATER (OR WET SOIL).
! PFCLN      : FLUX DE CHALEUR LATENTE SUR NEIGE (OU GLACE).
! PFCLN      : LATENT HEAT FLUX OVER SNOW (OR ICE).
! PFCS       : FLUX DE CHALEUR SENSIBLE EN SURFACE.
! PFCS       : SENSIBLE HEAT FLUX AT SURFACE LEVEL.
! PFEVI      : FLUX DE VAPEUR D'EAU SUR SOL GELE.
! PFEVI      : WATER VAPOUR FLUX OVER FROZEN SOIL.
! PFEVL      : FLUX DE VAPEUR D'EAU SUR EAU LIQUIDE (OU SOL HUMIDE).
! PFEVL      : WATER VAPOUR FLUX OVER LIQUID WATER (OR WET SOIL)
! PFEVN      : FLUX DE VAPEUR D'EAU SUR NEIGE (OU GLACE) ET SOL GELE.
! PFEVN      : WATER VAPOUR FLUX OVER SNOW (OR ICE) AND FROZEN SOIL.
! PFEVV      : FLUX D'EVAPOTRANSPIRATION.
! PFEVV      : EVAPOTRANSPIRATION FLUX.
! PFLASH     : FLUX D'ECLAIRS (ECLAIRS / KM2 / S).
! PFLASH     : FLASH DENSITY FLUX (FL / KM2 / S).
! PFTR       : FLUX DE TRANSPIRATION.
! PFTR       : TRANSPIRATION FLUX.
! PFLWSP     : FLUX D'EAU LIQUIDE DE LA SURFACE VERS LE SOL PROFOND.
! PFLWSP     : WATER FLUX FROM SURFACE TO DEEP SOIL.
! PFONTE     : FLUX D'EAU CORRESPONDANT A LA FONTE DE NEIGE EN SURFACE.
! PFONTE     : WATER FLUX CORRESPONDING TO SURFACE SNOW MELT.
! PALBH      : ALBEDO TOTAL UTILISE DANS LA PREVISION.
! PALBH      : TOTAL ALBEDO USED DURING THE FORECAST.
! PFRSGNI    : SURFACE GLOBAL NORMAL SOLAR FLUX.
! PFRSDNI    : SURFACE DIRECT NORMAL SOLAR FLUX.
! PFRSODS    : FLUX SOLAIRE DESCENDANT EN SURFACE
! PFRSODS    : SURFACE DOWNWARDS SOLAR FLUX
! PFRSOPS    : FLUX SOLAIRE PARALLELE EN SURFACE
! PFRSOPS    : SURFACE PARALLEL SOLAR FLUX
! PFRTHDS    : FLUX IR DESCENDANT EN SURFACE
! PFRTHDS    : SURFACE DOWNWARDS IR FLUX
! PGZ0       : G FOIS LA LONGUEUR DE RUGOSITE COURANTE.
! PGZ0       : G * ROUGHNESS LENGTH (CURRENT).
! PGZ0H      : G*LONGUEUR DE RUGOSITE THERMIQUE COURANTE (SI KVCLIV >= 8)
! PGZ0H      : CURRENT G*THERMAL ROUGHNESS LENGTH (IF KVCLIV >= 8)
! PLHS       : CHALEUR LATENTE EN SURFACE.
! PNEIJ      : PROPORTION DE SOL ENNEIGE.
! PNEIJ      : FRACTION OF SOIL COVERED BY SNOW.
! PVEG       : FRACTION DE VEGETATION APPARENTE.
! PVEG       : FRACTIONAL COVER BY APPARENT VEGETATION.
! PQS        : HUMIDITE SPECIFIQUE DE SURFACE.
! PQS        : SPECIFIC HUMIDITY AT SURFACE LEVEL.
! PQSATS     : HUMIDITE SPECIFIQUE DE SATURATION EN SURFACE.
! PQSATS     : SATURATED SPECIFIC HUMIDITY AT SURFACE LEVEL.
! PRS        : CONSTANTE DES GAZ DE L'AIR EN SURFACE.
! PRUISP     : FLUX DE RUISSELLEMENT EN PROFONDEUR.
! PRUISP     : RUN-OFF FLUX IN SOIL.
! PRUISL     : FLUX DE RUISSELLEMENT DU RESERVOIR D'INTERCEPTION.
! PRUISL     : RUN-OFF FLUX OUT THE INTERCEPTION WATER-TANK.
! PRUISS     : FLUX DE RUISSELLEMENT EN SURFACE.
! PRUISS     : RUN-OFF FLUX AT SURFACE LEVEL.
! PFGEL      : FLUX DE GEL DE L'EAU DU SOL.
! PFGEL      : FREEZING FLUX OF SOIL WATER.
! PFGELS     : FLUX DE GEL DE L'EAU DU RESERVOIR DE SURFACE.
! PFGELS     : FREEZING FLUX OF SOIL WATER AT SURFACE LEVEL.
! PUCLS      : SORTIE DIAGNOSTIQUE DU VENT EN X A HUV METEO.
! PUCLS      : U-COMPONENT OF WIND AT 10 METERS (DIAGNOSTIC).
! PVCLS      : SORTIE DIAGNOSTIQUE DU VENT EN Y A HUV METEO.
! PVCLS      : V-COMPONENT OF WIND AT 10 METERS (DIAGNOSTIC).
! PNUCLS     : SORTIE DIAGNOSTIQUE DU VENT NEUTRE EN X A HUV METEO.
! PNUCLS     : U-COMPONENT OF NEUTRAL WIND AT 10 METERS (DIAGNOSTIC).
! PNVCLS     : SORTIE DIAGNOSTIQUE DU VENT NEUTRE EN Y A HUV METEO.
! PNVCLS     : V-COMPONENT OF NEUTRAL WIND AT 10 METERS (DIAGNOSTIC).
! PTCLS      : SORTIE DIAGNOSTIQUE DE LA TEMPERATURE A HTQ METEO.
! PTCLS      : TEMPERATURE AT 2 METERS (DIAGNOSTIC).
! PTPWCLS    : SORTIE DIAGNOSTIQUE DE LA T'W A HTQ METEO.
! PTPWCLS    : WET BULB TEMPERATURE AT 2 METERS (DIAGNOSTIC).
! PMRT       : SORTIE DIAGNOSTIQUE DE LA TEMPERATURE RADIANTE MOYENNE.
! PMRT       : MEAN RADIANTE TEMPERATURE AT 2 METERS (DIAGNOSTIC).
! PQCLS      : SORTIE DIAGNOSTIQUE DE L'HUMIDITE SPECIFIQUE A HTQ METEO.
! PQCLS      : SPECIFIC HUMIDITY AT 2 METERS (DIAGNOSTIC).
! PRHCLS     : SORTIE DIAGNOSTIQUE DE L'HUMIDITE RELATIVE A HTQ METEO.
! PRHCLS     : RELATIVE HUMIDITY AT 2 METERS (DIAGNOSTIC).
! PCLCC      : SORTIE DIAGNOSTIQUE DE LA NEBULOSITE CONVECTIVE.
! PCLCC      : CONVECTIVE CLOUD COVER (DIAGNOSTIC).
! PCLCH      : SORTIE DIAGNOSTIQUE DE LA NEBULOSITE HAUTE.
! PCLCH      : HIGH CLOUD COVER (DIAGNOSTIC).
! PCLCL      : SORTIE DIAGNOSTIQUE DE LA NEBULOSITE BASSE.
! PCLCL      : LOW CLOUD COVER (DIAGNOSTIC).
! PCLCM      : SORTIE DIAGNOSTIQUE DE LA NEBULOSITE MOYENNE.
! PCLCM      : MEDIUM CLOUD COVER (DIAGNOSTIC).
! PCLCT      : SORTIE DIAGNOSTIQUE DE LA NEBULOSITE TOTALE.
! PCLCT      : TOTAL CLOUD COVER (DIAGNOSTIC).
! PCAPE      : CAPE.
! PCTOP      : PRESSION DU SOMMET DE LA NEBULOSITE CONVECTIVE
! PCTOP      : PRESSURE OF TOP OF CONVECTIVE CLOUD COVER
! PCLPH      : HAUTEUR (EN METRES) DE LA COUCHE LIMITE PLANETAIRE
! PCLPH      : HEIGHT (IN METERS) OF THE PBL
! PVEIN      : INDEX DE VENTILATION EN COUCHE LIMITE PLANETAIRE             
! PVEIN      : VENTILATION INDEX IN PBL.
! PUGST      : SORTIE DIAGNOSTIQUE DES RAFALES EN X
! PUGST      : U-COMPONENT OF GUSTS (DIAGNOSTIC).
! PVGST      : SORTIE DIAGNOSTIQUE DES RAFALES EN Y
! PVGST      : V-COMPONENT OF GUSTS (DIAGNOSTIC).
! PDIAGH     : DIAGNOSTQUE DE LA GRELE.
! PDIAGH     : HAIL DIAGNOSTICS.
! PSPSG      : CONTENU EN EAU DU PACK NEIGEUX AVEC SURFEX
! PSPSG      : SNOW WATER EQUIVALENT WITH SURFEX
! PSDUR      : DUREE d'INSOLATION (secondes)
! PSDUR      : Sunshine Hours (seconds)
! PVISICLD   : VISIBILITY DUE TO CLOUD WATER AND CLOUD ICE
! PVISIHYDRO : VISIBILITY DUE TO RAIN AND SNOW AND GRAUPEL
! PMXCLWC    : CLOUD WATER LIQUID CONTENT AT HVISI METERS
! PDPRECIPS  : PRECIPITATION TYPE
! PDPRECIPS2 : PRECIPITATION TYPE FOR 2NDE PERIOD
! PTENDEXT_DEP:WET TENDENCY OF PASSIVES SCALAIRE
! PTENDEXT_DEP:TENDANCE HUMIDE DES SCALAR PASSIFS
! - INPUT/OUTPUT 1D
!  PCUCONVCA : CA array for interaction with the convection
!  PNLCONVCA : CA array for interaction with the convection
! YDDDH      : DDH superstructure
!-----------------------------------------------------------------------

! -   ARGUMENTS IMPLICITES.
! -   IMPLICIT ARGUMENTS.
!     ---------------------

!-----------------------------------------------------------------------

!     Externes.
!     ---------

!     Methode.
!     --------
!     - TERMINE LES INITIALISATIONS.
!     - APPELLE LES SS-PRGMS TAMPONS SUIVANT LA LOGIQUE TROUVEE
!        DANS /YOMPHY/. EUX MEMES VONT DECLARER LES TABLEAUX DE TRAVAIL
!        ET APPELER LES PARAMETRISATIONS ELLES MEMES.
!     - FINISH UP THE INITIALIZATION.
!     - CALL THE BUFFER SUBROUTINES FOLLOWING /YOEPHY/ REQUIREMENTS
!        WHICH IN TURN CALL THE ACTUAL PHYSICS SUBROUTINES
!        (THIS LAST POINT NOT PARTIALLY DONE)

!     Auteur.
!     -------
!     90-09-28: A. Joly, *CNRM*.

!     Modifications.
!     --------------
!     2007-02-01 M.Janousek : Introduction of 3MT routines
!     2007-02-19 R.Brozkova : Cleaning obsolet features (LSRCON, LSRCONT, LNEBT,
!                             pre-ISBA, modularisation and racionalisation.
!     2007-04-17 S.Ivatek-S : Over dimensioning of PGPAR (KLON,NGPAR+1) is used
!                             boundary checking bf
!     2007-05-10 E. Bazile  : Introduction of the AROME shallow convection (LCVPPKF)
!     2007-03-21 A. Alias   : Modifications for SURFEX (IGFL_EXT)
!     2007-05-07 F. Bouyssel: Several modifications for SURFEX
!     2007-05-07 F. Bouyssel: New argument in ACCOEFK
!     2007-06-27 A. Alias   : Use NGFL_EXT instead of IGFL_EXT
!     2008-02-18 F. Bouyssel: New acdifv1 & acdifv2 & arp_ground_param
!     2008-02-21 E. Bazile  : Cleaning for the call of the AROME shallow convection (LCVPPKF)
!     4-Mar-2008 Y. Seity : Cleaning IR and WV similated sat radiances
!                            (replaced by Fullpos Calculations)
!     2008-03-14 Y. Bouteloup: Store diffusion coefficients from non-linear model
!     2007-10-11 A. Alias   : New Call to ACHMT/ACNEBR/ACPBLH (P. Marquet/JF. Gueremy)
!     2008-02-01 P. Marquet : modify ZALBD/ZALBP and PFRSODS if LRAYFM15 (idem V4)
!     2008-03-26 F. Bouyssel: Intrduction of LACDIFUS
!     2008-04-28 E. Bazile  : Introduction of ZPROTH_CVPP for the TKE scheme
!     2008-05-09, J.F. Gueremy : Flux MEMO sur mer (ACFLUSO/LFLUSO) +
!            and  P. Marquet   : ZCEROV as new argument in ACDIFUS
!     2008-06-01 F. Bouyssel: Interface of radozc (ECMWF ozone)
!     2008-09-02 F. Vana  : Better split of ACPTKE and ACDIFV1 code
!     2008-10-01 F. Bouyssel: Call of radozcmf instead of radozc (ECMWF ozone)
!     2008-10-05 E. Bazile : Computation of the PBL height from the TKE.
!     03-Oct-2008 J. Masek    parameters for NER statistical model via namelist
!     2009-Jan-21 F. Vana : new mixing lengths for pTKE + few fixes
!     2008-11    C. Payan: Neutral Wind (new arg in the call of ACHMT)
!     2008-11-15 F. Bouyssel: Correction of negative humidities
!     2009-05-01 Y. Bouteloup : Store radiative cloud water and ice in GFL (YIRAD and YLRAD)
!     2009-05-25 F. Bouyssel: Cleaning
!     K. Yessad (Jul 2009): remove CDLOCK + some cleanings
!     2009-08-07 A. Alias   : LCALLSFX introduced to call only once SURFEX at NSTEP=0
!                             Computation of ZRTI (INVERSE DE R*T) added (after ACHMTLS)-not done
!                             Negatives humidity correction PFCQVNG in acdifus (J.F. Gueremy)
!                             add ZAESUL/ZAEVOL to CALL RADAER
!     2009-09-21  D. Banciu: complete the cascade within 3MT frame;
!            prepare the environment for Rash and Kristjansson condensation (RK) scheme
!            remove some arguments of ACPUM and ACUPD (LUDEN option was removed)
!     12-Oct-2009 F. Vana : optimization + update of mixing lengths for p/eTKE
!     2009-10-15 Y. Bouteloup : Store radiative cloud water and ice in GFL (YIRAD and YLRAD)
!     2009-10-23 O.Riviere Intro. of LGWDSPNL for GWD in simpl. phys.
!     2010-01-21 S. Riette: PU, PV and ZDEPTH_HEIGHT in 3D for ARO_GROUND_DIAG
!     2010-05-11 F. Bouyssel : Use of PINDX, PINDY
!     2010-06-20 Y. Seity : Use AROCLDIA to compute PBLH
!     2010-10    A. Alias Compute Sunshine duration
!     2010-10    A. Alias modify ZALBD/ZALBP and PEMIS if LRAYFM for CLIMAT (JF Gueremy)
!     2010-08-10 P.marguinaud : Cleaning
!     2011-01-10 F. Bouyssel: Intro. of LADJCLD and some cleaning.
!     2010-12-01 E. Bazile: TKE1 for AROCLDIA and contributions terms of the
!          TKE equations for DDH.
!     2010-12 S. Riette: aro_ground_diag interface modified to add snow cover
!     2010-12    B. Decharme  : modify the radiative coupling with surfex (SW per band in ACRADIN and RADHEAT)
!     2011-02    A. Alias     : Computation of ZRTI (INVERSE DE R*T) added (after ACHMTLS)
!     2011-02    A. Voldoire : add ZAERINDS to CALL RADAER and ACRADIN
!                              for sulfate indirect effect computation
!     L. Bengtsson-Sedlar & F. Vana 18-Feb-2011 : CA scheme for convection
!     I. Bastak-Duran, F. Vana & R. Brozkova  16-Mar-2011: TOUCANS, version 0
!     2011-02-01 M. Mokhtari: Several modifications for aplpar and introduction of the key LMDUST
!                             (treatment of the desert aerosols)
!     2011-02-24 Y. Bouteloup : EDKF + Surface forcing for MUSC
!     2011-03-26 F. Bouyssel: Intro. of PSPSG (snow cover with surfex)
!     2011-09-07 J.M. Piriou: PCMT convection scheme.
!     2011-11-17 J.F. Gueremy: ZQLI_CVP diagnostic convective water content
!     2011-06: M. Jerczynski - some cleaning to meet norms
!     2011-11-29 K-I. Ivarsson, L. Bengtsson: RK-scheme modifications   
!     26-Jan-2012: F. Vana + I. Bastak-Duran - TOUCANS update + bugfixes 
!     2012-04-24 F. Bouyssel: Bug correction on surface water fluxes with surfex
!     2012-06-09 M. Mile: Bug correction for undefined z0;z0h at 0th step CALL ARO_GROUND_DIAG_Z0
!     2012-09-11 : P.Marguinaud : Add control threshold for
!     2013-06-17 J.M. Piriou: evaporation for PCMT scheme.
!     T. Wilhelmsson (Sept 2013) Geometry and setup refactoring.
!     2013-11-08 Y. Bouteloup New version of ACDIFV1 and ACDIFV2 for "full implicit PMMC09 scheme"
!     F. Vana  28-Nov-2013 : Redesigned trajectory handling.
!     2013-11, J. Masek: Introduction of ACRANEB2 scheme, externalized
!                        computation of direct albedo for ACRANEB/ACRANEB2.
!                        Phasing to cy40t1.
!     K. Yessad (July 2014): Move some variables.
!     2014-09, C. Wastl: Adaptations for orographic shadowing
!     2014-10, R. Brozkova: phasing TOUCANS.
!     2016-03, E. Bazile: phasing MUSC for surf_ideal_flux
!     2016-03, L. Gerard: LNSDO AND LCVCSD
!     2016-04, J. Masek: Exponential-random cloud overlap with variable
!                        decorrelation depth.
!     2016-09, J. Masek: Proper diagnostics of sunshine duration in ACRANEB2.
!     2016-09, M. Mokhtari & A. Ambar: preliminary calculation for passive scalar
!     2016-10, P. Marguinaud : Port to single precision
!     K. Yessad (Dec 2016): Prune obsolete options.
!     2016-06, F.Taillefer: add of aro_ground_diag_2isba call
!     2017-09, Y.Bouteloup: Phased Francoise's modification on cy45
!     2017-09, J. Masek: Fix for protected convective cloudiness,
!                        shifted dimensioning of PGMU0.
!     R. El Khatib 05-Feb-2018 fix bounds violations
!     2018-09, F. Duruisseau: Add PQRCONV1 and PQSCONV1 out (BAYRAD)
!     2018-09, D. St-Martin: Add non-orographic GWD scheme (ACNORGWD)
!     2018-09, R. Roehrig: add ACTKE input/output (ZQLC/ZQIC and ZKQROV/ZKQLROV) (from JF Guérémy)
!     2018-09, M. Michou: Add call to chem_main to activate ARPEGE-Climat chemistry scheme
!     2018-09, R. Brozkova: Fixes in thermodynamic adjustment - deep convective
!                           condensates protection. Passing of diagnostic hail.
!     2018-09, J. Masek: Calculation of snow fractions over bare ground and
!                        vegetation moved to ACSOL (case LVGSN=T). Coding of
!                        ALARO-1 fixes for LZ0HSREL=T. Diagnostics of global
!                        normal irradiance and mean radiant temperature.
!     2018-11, J.M. Piriou: correct 2010 historical bug about adding cloud sedimentation to resolved surface precipitation.
!     R. Hogan     24-Jan-2019 Removed radiation scheme from cycle 15
!     R. El Khatib 30-Apr-2019 fix uninitialized variable
!     2018-10, I. Etchevers : add Visibilities
!     2019-01, I. Etchevers, Y. Seity : add Precipitation Type
!     2019-05, J.M. Piriou: LCVRESDYN + LADJCLD.
!     2019-09, M. Hrastinski: Dataflow for TKE and TTE terms in ALARO DDH (PFTCNS).
!     2019-09, L. Gerard: Modified call to ACNSDO.
!     2019-09, R. Brozkova: Introduction of new NDIFFNEB options.
!     2019-09, J. Masek: Introduction of ETKE_MIN, efficient ACRANEB2 clearsky
!                        computations.
!    2019-10, I. Etchevers : Visibilities in ACVISIH, AROCLDIA=>ACCLDIA
!    2019-10, Y.Bouteloup : New anti-GPS in accvimp.F90 
!    2019-10, Y.Bouteloup and M. Bouzghaiam : Radiation modifications. Remove of FMR15, remove acradin.F90 direct
!                   call to recmwf.F90 and add interface to ecrad (in recmwf !)
!    2020-07, J.M. Piriou and O. Jaron: lightning flash density.
!    2020-10, J. Masek : modified call to ACCLDIA
!    2020-10, M. Hrastinski: Reorganized computation of the moist gustiness
!             correction. Modified call of ACMRIP and ACMIXELEN subroutines.
!    2020-11, Y.Bouteloup : Interface to IFS deep convection scheme under LCVTDK key
!    2020-12, U.Andrae : Introduce SPP for HARMONIE-AROME
! End Modifications
!-------------------------------------------------------------------------------

!-----------------------------------------------------------------------
!     ******************************************************************
!     ****** IDIOSYNCRASIES *** IDIOSYNCRASIES *** IDIOSYNCRASIES ******
!     ******************************************************************
!     ***  HEALTH WARNING:                                           ***
!     ***  ===============                                           ***
!     ***  NOTE THAT WITHIN THE E.C.M.W.F. PHYSICS HALF-LEVELS       ***
!     ***  ARE INDEXED FROM 1 TO NFLEVG+1 WHILE THEY ARE BETWEEN     ***
!     ***  0 AND NFLEVG IN THE REST OF THE MODEL. THE CHANGE IS TAKEN***
!     ***  CARE OF IN THE CALL TO THE VARIOUS SUBROUTINES OF THE     ***
!     ***  PHYSICS PACKAGE                                           ***
!     ***                                                            ***
!     ***    THIS IS SUPPOSED TO BE A "TEMPORARY" FEATURE TO BE      ***
!     ***    STRAIGHTENED OUT IN THE "NEAR" FUTURE                   ***
!     ******************************************************************

!     ------------------------------------------------------------------

USE GEOMETRY_MOD       , ONLY : GEOMETRY
USE CPG_DYN_TYPE_MOD   , ONLY : CPG_DYN_TYPE
USE MFPHYS_SURFACE_TYPE_MOD,ONLY : MFPHYS_SURF_TYPE
USE FIELD_VARIABLES_MOD, ONLY : FIELD_VARIABLES
USE SURFACE_FIELDS_MIX , ONLY : TSURF
USE YOMXFU             , ONLY : TXFU
USE TYPE_MODEL         , ONLY : MODEL
USE PARKIND1           , ONLY : JPIM     ,JPRB
USE YOMHOOK            , ONLY : LHOOK    ,DR_HOOK
USE YOMMP0             , ONLY : NPRINTLEV
USE YOMVERT            , ONLY : VP00
USE YOMCST             , ONLY : RG       ,RSIGMA   ,RV       ,RD       ,&
                              & RCPV     ,RETV     ,RCW      ,RCS      ,RLVTT    ,&
                              & RLSTT    ,RTT      ,RALPW    ,RBETW    ,RGAMW    ,&
                              & RALPS    ,RBETS    ,RGAMS    ,RALPD    ,RBETD    ,&
                              & RGAMD    ,RCPD     ,RATM     ,RKAPPA   ,RLMLT
USE YOMCT0             , ONLY : LCALLSFX ,LSFORCS, LELAM
USE YOMDYNA            , ONLY : L3DTURB
USE YOMRIP0            , ONLY : NINDAT
USE DDH_MIX            , ONLY : ADD_FIELD_3D ,ADD_FIELD_2D ,NTOTSVAR , & 
                              & NTOTSURF ,NTOTSVFS, NEW_ADD_FIELD_3D, NEW_ADD_FIELD_2D, &
                              & TYP_DDH
USE YOMLUN             , ONLY : NULOUT
USE YOMLSFORC          , ONLY : LMUSCLFA,NMUSCLFA
USE YOMTRAJ            , ONLY : TRAJ_PHYS_TYPE
USE YOMCFU             , ONLY : TCFU !!! for parameters of FLASH
USE SPP_MOD  , ONLY : YSPP, YSPP_CONFIG

!     ------------------------------------------------------------------

IMPLICIT NONE

TYPE(GEOMETRY)    ,INTENT(IN)    :: YDGEOMETRY
TYPE(CPG_DYN_TYPE),INTENT(INOUT) :: YDCPG_DYN
TYPE(MFPHYS_SURF_TYPE),INTENT(INOUT) :: YDMF_PHYS_SURF
TYPE(FIELD_VARIABLES),INTENT(INOUT) :: YDVARS
TYPE(TSURF)       ,INTENT(INOUT) :: YDSURF
TYPE(TXFU)        ,INTENT(INOUT) :: YDXFU
TYPE(TCFU)        ,INTENT(INOUT) :: YDCFU
TYPE(MODEL)       ,INTENT(INOUT),TARGET :: YDMODEL
INTEGER(KIND=JPIM),INTENT(IN)    :: KLON
INTEGER(KIND=JPIM),INTENT(IN)    :: KLEV
INTEGER(KIND=JPIM),INTENT(IN)    :: KBL
INTEGER(KIND=JPIM),INTENT(IN)    :: KGPCOMP
INTEGER(KIND=JPIM),INTENT(IN)    :: KNFRRC
INTEGER(KIND=JPIM),INTENT(IN)    :: KVCLIS
INTEGER(KIND=JPIM),INTENT(IN)    :: KSGST
INTEGER(KIND=JPIM),INTENT(IN)    :: KCSS
INTEGER(KIND=JPIM),INTENT(IN)    :: KIDIA
INTEGER(KIND=JPIM),INTENT(IN)    :: KFDIA
INTEGER(KIND=JPIM),INTENT(IN)    :: KTDIA
INTEGER(KIND=JPIM),INTENT(IN)    :: KSTGLO
INTEGER(KIND=JPIM),INTENT(IN)    :: KVCLIV
INTEGER(KIND=JPIM),INTENT(IN)    :: KSTEP
REAL(KIND=JPRB)   ,INTENT(IN)    :: PDT
LOGICAL           ,INTENT(IN)    :: LDXFUMSE
REAL(KIND=JPRB)   ,INTENT(IN)    :: PINDX(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PINDY(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PAPHI(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PAPRS(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PAPHIF(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PAPRSF(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PALPH(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PDELP(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PLNPR(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PRDELP(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PCUCONVCA(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PNLCONVCA(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PRCORI(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PSV(KLON,KLEV,YDMODEL%YRML_GCONF%YGFL%NGFL_EXT)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PU(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PV(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PT(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PQ(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PQSRES(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PQRRES(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PG(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PTKE(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PEFB1(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PEFB2(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PEFB3(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PCVV(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PQI(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PQL(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PDIFCQLC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PDIFCQIC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFIMCC (KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFEDQLC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFEDQIC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFEDQRC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFEDQSC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCNEGQLC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCNEGQIC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCNEGQRC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCNEGQSC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PO3(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PCHEM(KLON,KLEV,YDMODEL%YRML_GCONF%YGFL%NCHEM)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGFL(KLON,KLEV,YDMODEL%YRML_GCONF%YGFL%NDIM)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PNOGWDU(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PNOGWDV(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PVORT0(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PCP(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PCVGQ(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PR(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PEVEL0(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PKOZO(KLON,KLEV,KVCLIS)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPLCH(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPLSH(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PSNS(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGPAR(KLON,YDMODEL%YRML_PHY_MF%YRPARAR%NGPAR+1)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PALBNS(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PRHONS(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PTP(KLON,KCSS)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PTS(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PWL(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PWP(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PWPI(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PWS(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PWSI(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PVERVEL(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PEMTD(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PEMTU(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PTRSO(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PVRMOON(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PMU0(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PMU0LU(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PMU0M(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PMU0N(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PGELAM(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PGEMU(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PGM(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: POROG(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PWW(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PDIV(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PUL(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PVL(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PWWL(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PWWM(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGDEOSI(KLON,0:KLEV,2)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGUEOSI(KLON,0:KLEV,2)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGMU0(KLON,0:YDMODEL%YRML_PHY_MF%YRPHY%NSORAYFR-1)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGMU0_MIN(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGMU0_MAX(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGDEOTI(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGDEOTI2(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGUEOTI(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGUEOTI2(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGEOLT(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGEOXT(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGRPROX(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGMIXP(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGFLUXC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGRSURF(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: POMPAC(KLON,0:KLEV,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PAC(KLEV+1,KLEV+1)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PCOR(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PMMU0(KLON)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PDHSF(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRAB3C(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRAB3N(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRAB4C(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRAB4N(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRAB6C(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRAB6N(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRAT1C(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRAT1N(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRAT2C(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRAT2N(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRAT3C(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRAT3N(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRAT4C(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRAT4N(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRAT5C(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRAT5N(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PDIFCQ(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PDIFCQI(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PDIFCQL(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PDIFCS(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PDIFSV(KLON,0:KLEV,1:YDMODEL%YRML_GCONF%YGFL%NGFL_EXT)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PDIFTQ(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PDIFTQI(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PDIFTQL(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PDIFTS(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCCQL(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCCQN(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCSQL(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCSQN(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCQVNG(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCQING(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCQLNG(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCQRNG(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCQSNG(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCQGNG(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPLCL(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPLCN(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPLCG(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPLSL(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPLSN(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPLSG(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFRSO(KLON,0:KLEV,KSGST+1)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFRSOC(KLON,0:1)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFRTH(KLON,0:KLEV,KSGST+1)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFRTHC(KLON,0:1)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PSTRCU(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PSTRCV(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PSTRDU(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PSTRDV(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PSTRTU(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PSTRTV(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PSTRMU(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PSTRMV(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFRMH(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFRMQ(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCHOZ(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPFPSL(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPFPSN(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPFPSG(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPFPCL(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPFPCN(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPEVPSL(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPEVPSN(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPEVPSG(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPEVPCL(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPEVPCN(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFPEVPCG(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFTKE(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFTKEI(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFEFB1(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFEFB2(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFEFB3(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PCPS(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PLHS(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRS(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PLH(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PLSCPE(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PNEB(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PQICE(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PQLI(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PQRCONV1(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PQSCONV1(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PQSAT(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PQW(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRH(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PTW(KLON,KLEV)
! Prognostic convection variables (MUST BE 1:KLEV for GFL)
! Unless mf_phys has copied them into a 0:KLEV array
! Up to now, we leave 1:KLEV for pentch: see later.
!---------------------------------------------------
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PALB(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PCD(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PCDN(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PCH(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PC1(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PC2(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PCT(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PEMIS(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCHSP(KLON,KCSS)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCLL(KLON,KSGST+1)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCLN(KLON,KSGST+1)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCS(KLON,KSGST+1)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFEVI(KLON,KSGST+1)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFEVL(KLON,KSGST+1)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFEVN(KLON,KSGST+1)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFEVV(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFLASH(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFTR(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFLWSP(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFONTE(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFGEL(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFGELS(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFRSGNI(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFRSDNI(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFRSODS(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFRSOPS(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFRSOPT(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFRSOLU(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PFRTHDS(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGZ0(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGZ0H(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PNEIJ(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PVEG(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PQS(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PQSATS(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRUISL(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRUISP(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRUISS(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PUCLS(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PVCLS(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PNUCLS(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PNVCLS(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PTCLS(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTPWCLS(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PMRT(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PQCLS(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PRHCLS(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PCLCT(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PCLCH(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PCLCM(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PCLCL(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PCLCC(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PCAPE(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PCTOP(KLON)
INTEGER(KIND=JPIM),INTENT(OUT)   :: KCLPH(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PCLPH(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PVEIN(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PUGST(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PVGST(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PDIAGH(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFTCNS(KLON,0:KLEV,6)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PTENDPTKE(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PKUROV_H(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PKTROV_H(KLON,KLEV)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PDERNSHF(KLON)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PTENDEXT_DEP(KLON,KLEV,YDMODEL%YRML_GCONF%YGFL%NGFL_EXT)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PVISICLD(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PVISIHYDRO(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PMXCLWC(KLON)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PDPRECIPS(KLON,YDMODEL%YRML_PHY_MF%YRPHY%YRDPRECIPS%NDTPREC)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PDPRECIPS2(KLON,YDMODEL%YRML_PHY_MF%YRPHY%YRDPRECIPS%NDTPREC2)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PTDISS(KLON,KLEV)
TYPE (TRAJ_PHYS_TYPE), INTENT(INOUT) :: PTRAJ_PHYS
TYPE(TYP_DDH), INTENT(INOUT)     :: YDDDH
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGP2DSPP(KLON,YSPP%N2D)

!     ------------------------------------------------------------------
!        ATTENTION SI KVCLIG < 7 LES CHAMPS SUIVANTS NE SONT
!        PAS REELLEMENT ALLOUES EN MEMOIRE.
!*
!     ------------------------------------------------------------------
!     DECLARATION DES TABLEAUX LOCAUX-GLOBAUX DES PARAMETRISATIONS
INTEGER(KIND=JPIM) :: INLAB(KLON,KLEV), INLAB_CVPP(KLON,KLEV)
REAL(KIND=JPRB) :: ZVETAH(0:KLEV),ZNLAB(KLON,KLEV),ZNLABCVP(KLON,KLEV)
REAL(KIND=JPRB) :: ZVETAF(KLEV)

!     ------------------------------------------------------------------
!     WARNING: THE ARRAYS ZXTROV, ZXUROV, ZKTROV,ZKUROV, ZKNROV AND ZNBVNO
!     ARE DIMENSIONNED 0:KLEV ONLY IN ORDER TO KEEP IN MIND
!     THAT THEY ARE COMPUTED AT "HALF LEVELS".
!     THEY ARE USED HOWEVER FROM 1 TO KLEV.

REAL(KIND=JPRB) :: ZXTROV(KLON,0:KLEV),ZXUROV(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZXPTKEROV(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZRRCOR(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZMRIPP(KLON,0:KLEV),ZMRIFPP(KLON,0:KLEV),ZBNEBCVPP(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZBNEBQ(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZMN2PP(KLON,0:KLEV),ZMN2_ES(KLON,0:KLEV),ZMN2_EQ(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZMN2_DS(KLON,0:KLEV),ZMN2_DQ(KLON,0:KLEV)
! ZMRIMC     : M(C) from P. Marquet's moist Ri computation - for TKE correction after TOMs
! ZMRICTERM  : Rv/R.F(C)-1/M(C).T/Tv from P. Marquet's moist Ri computation - for TKE correction after TOMs
REAL(KIND=JPRB) :: ZMRIMC(KLON,0:KLEV),ZMRICTERM(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZTSTAR(KLON,KLEV),ZTSTAR2(KLON,0:KLEV) !diag 
REAL(KIND=JPRB) :: ZTSTARQ(KLON,KLEV),ZTSTAR2Q(KLON,0:KLEV)!diag
REAL(KIND=JPRB) :: ZTAU_TKE(KLON,0:KLEV)!DISSIPATION TIME SCALE TAU  -FOR TOM's CALCULATION
REAL(KIND=JPRB) :: ZF_EPS(KLON,0:KLEV)   !  Conversion function lm-L
REAL(KIND=JPRB) :: ZFUN_TTE(KLON,0:KLEV)   !  Function in computation of tte_tilde
REAL(KIND=JPRB) :: ZKTROV(KLON,0:KLEV),ZKUROV(KLON,0:KLEV),ZNBVNO(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZKQROV(KLON,0:KLEV),ZKQLROV(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZKNROV(KLON,0:KLEV)

REAL(KIND=JPRB) :: ZFHORM(KLON,0:KLEV),ZFHORH(KLON,0:KLEV) ! arrays for 3D turb
! ZFMTKE - F_m function for static K_m computation
! ZFHTKE - F_h function for static K_h computation
REAL(KIND=JPRB) :: ZFMTKE(KLON,0:KLEV),ZFTTKE(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZRHS(KLON,KLEV)
! ZAUTKE - alpha_u for dry AF scheme
! ZATTKE - alpha_theta for dry AF scheme
REAL(KIND=JPRB) :: ZAUTKE(KLON,0:KLEV),ZATTKE(KLON,0:KLEV)
!ZTH_FUN, ZWW_FUN - T_h, A_h, F_ww - stability functions for TOMs par.
REAL(KIND=JPRB) :: ZTH_FUN(KLON,0:KLEV),ZWW_FUN(KLON,0:KLEV)
! ZFMGST - stability function F_m for moist gustiness correction
REAL(KIND=JPRB) :: ZFMGST(KLON,0:KLEV)


!     ------------------------------------------------------------------
REAL(KIND=JPRB) :: ZATSLC(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZNEBS(KLON,KLEV),ZQLIS(KLON,KLEV)
REAL(KIND=JPRB) :: ZNEBS0(KLON,KLEV),ZQLIS0(KLON,KLEV)
REAL(KIND=JPRB) :: ZNEBC0(KLON,KLEV)   !Nebulosite convective radiative
REAL(KIND=JPRB) :: ZNEBDIFF(KLON,KLEV) !Nebulosite: calcul de la diffusion
REAL(KIND=JPRB) :: ZNEBCH(KLON,KLEV)   !Nebulosite convective condensation
REAL(KIND=JPRB) :: ZUNEBH(KLON,KLEV)   !Nebulosite convective histo
REAL(KIND=JPRB) :: ZDETFI(KLON,KLEV)   !fraction of instantaneous detrained air
REAL(KIND=JPRB) :: ZFPCOR(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZFHP(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZLMT(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZZLMT(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZLMU(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZLMU2(KLON,0:KLEV),ZLMT2(KLON,0:KLEV) ! temporary storage of lm,lh
REAL(KIND=JPRB) :: ZLML(KLON,0:KLEV) ! TKE type mixing length
REAL(KIND=JPRB) :: ZLMLTILD(KLON,0:KLEV) ! 'STATIC' TKE type mixing length
REAL(KIND=JPRB) :: ZOME(KLON,KLEV)   ! updraught envt vert vel*dt
REAL(KIND=JPRB) :: ZFALLR(KLON,KLEV) ! fall velocity of rain
REAL(KIND=JPRB) :: ZFALLS(KLON,KLEV) ! fall velocity of snow
REAL(KIND=JPRB) :: ZFALLG(KLON,KLEV) ! fall velocity of graupel
REAL(KIND=JPRB) :: ZICEFR1(KLON,KLEV)! Resolved Condensate ice fraction
REAL(KIND=JPRB) :: ZRHCRI(KLON,KLEV) ! Smith scheme critical RH
REAL(KIND=JPRB) :: ZRHDFDA(KLON,KLEV)! RK scheme change in RH over cloud
REAL(KIND=JPRB) :: ZLHS(KLON,KLEV)   ! Sublimation latent heat
REAL(KIND=JPRB) :: ZLHV(KLON,KLEV)   ! Evaporation latent heat
REAL(KIND=JPRB) :: ZLH(KLON,KLEV)    ! Temporar storage for updated PLH
REAL(KIND=JPRB) :: ZLSCPE(KLON,KLEV) ! Temporar storage for updated PLSCPE
REAL(KIND=JPRB) :: ZQSAT(KLON,KLEV)  ! Temporar storage for updated PQSAT
REAL(KIND=JPRB) :: ZQSATS(KLON,KLEV) ! QSAT of resolved cond./evap. scheme
REAL(KIND=JPRB) :: ZQW(KLON,KLEV)    ! Temporar storage for updated PQW
REAL(KIND=JPRB) :: ZRH(KLON,KLEV)    ! Temporar storage for updated PRH
REAL(KIND=JPRB) :: ZTW(KLON,KLEV)    ! Temporar storage for updated PTW)
REAL(KIND=JPRB) :: ZDQ(KLON,KLEV)    ! Saturation departure for a given thermodynamic state
REAL(KIND=JPRB) :: ZDQM(KLON,KLEV)   ! maximum saturation departure
REAL(KIND=JPRB) :: ZPOID(KLON,KLEV)  ! DP/(RG*DT) FOR A GIVEN LEVEL AND A GIVEN TIME STEP.
REAL(KIND=JPRB) :: ZIPOI(KLON,KLEV)  ! INVERSE OF ZPOID.

REAL(KIND=JPRB) :: ZQU(KLON,KLEV) ! Updraught Specific moisture
REAL(KIND=JPRB) :: ZTU(KLON,KLEV) ! Updraught Temperature
REAL(KIND=JPRB) :: ZUU(KLON,KLEV) ! Updraught zonal wind
REAL(KIND=JPRB) :: ZVU(KLON,KLEV) ! Updraught merid. wind

REAL(KIND=JPRB) :: ZTMIC(KLON,KLEV) ! Temperature for microphysics
REAL(KIND=JPRB) :: ZQMIC(KLON,KLEV) ! Specific moisture for microphysics

REAL(KIND=JPRB) :: ZT(KLON,KLEV)     ! updated temperature T for cascading parameterization
REAL(KIND=JPRB) :: ZTCORR(KLON,KLEV) ! temperature corr. for convective cloud
REAL(KIND=JPRB) :: ZMELNET(KLON,KLEV) ! net melting (-freezing) rate of ice
REAL(KIND=JPRB) :: ZMELGET(KLON,KLEV)! net melting (-freezing) rate of graupel
REAL(KIND=JPRB) :: ZU(KLON,KLEV)     ! updated zonal velocity
REAL(KIND=JPRB) :: ZV(KLON,KLEV)     ! updated meridional velocity

REAL(KIND=JPRB) :: ZQV(KLON,KLEV)    ! corrected (for negative values) vapour
                                     ! updated value for cascading parameterization
REAL(KIND=JPRB) :: ZQI(KLON,KLEV)    ! corrected (for negative values) cloud ice
                                     ! updated value for cascading parameterization
REAL(KIND=JPRB) :: ZQL(KLON,KLEV)    ! corrected (for negative values) cloud liquid
                                     ! updated value for cascading parameterization
REAL(KIND=JPRB) :: ZQR(KLON,KLEV)    ! corrected (for negative values) rain
                                     ! updated value for cascading parameterization
REAL(KIND=JPRB) :: ZQS(KLON,KLEV)    ! corrected (for negative values) snow
                                     ! updated value for cascading parameterization
REAL(KIND=JPRB) :: ZCP(KLON,KLEV)    ! new cp for turbulent diffusion
REAL(KIND=JPRB) :: ZQT(KLON,KLEV)
REAL(KIND=JPRB) :: ZTENHA(KLON,KLEV)
REAL(KIND=JPRB) :: ZTENQVA(KLON,KLEV)
REAL(KIND=JPRB) :: ZFCQVNG(KLON,0:KLEV) ! correction flux increment for neg vapour
REAL(KIND=JPRB) :: ZFCQING(KLON,0:KLEV) ! correction flux increment for neg ice
REAL(KIND=JPRB) :: ZFCQLNG(KLON,0:KLEV) ! correction flux increment for neg liquid water
REAL(KIND=JPRB) :: ZFPLSL(KLON,0:KLEV) ! total liquid water flux: diff+sedi+rain
REAL(KIND=JPRB) :: ZFPLSN(KLON,0:KLEV) ! total solid water flux: diff+sedi+snow
REAL(KIND=JPRB) :: ZFCQL(KLON,0:KLEV)   ! condensation flux(liquid)
REAL(KIND=JPRB) :: ZFCQI(KLON,0:KLEV)   ! condensation flux(ice)
REAL(KIND=JPRB) :: ZDIFCQD(KLON,0:KLEV) ! downdraft flux of specific humidity
REAL(KIND=JPRB) :: ZDIFCQLD(KLON,0:KLEV) ! downdraft flux of liquid water
REAL(KIND=JPRB) :: ZDIFCQID(KLON,0:KLEV) ! downdraft flux of  solid water
REAL(KIND=JPRB) :: ZSEDIQL(KLON,0:KLEV) ! sedimentation flux of cloud liquid water
REAL(KIND=JPRB) :: ZSEDIQI(KLON,0:KLEV) ! sedimentation flux of cloud ice water
REAL(KIND=JPRB) :: ZDIFCSD(KLON,0:KLEV) ! downdraft entalphy flux
REAL(KIND=JPRB) :: ZSTRCUD(KLON,0:KLEV) ! change in horizontal mom.
REAL(KIND=JPRB) :: ZSTRCVD(KLON,0:KLEV) ! change in horizontal mom.
REAL(KIND=JPRB) :: ZRCVOTT(KLON,0:KLEV) ! degree of inhomogeneity in precips.
REAL(KIND=JPRB) :: ZSIGPC(KLON)         ! Convective precipit mesh fraction
REAL(KIND=JPRB) :: ZSIGP(KLON)         ! Precipitation mesh fraction
REAL(KIND=JPRB) :: ZAUXPRC(KLON)        ! Precipitation auxilary
REAL(KIND=JPRB) :: ZDIFCVPPQ(KLON,0:KLEV) ! Flux de CVPP (KFB or EDKF) sur Qv
REAL(KIND=JPRB) :: ZDIFCVPPS(KLON,0:KLEV) ! Flux de CVPP (KFB or EDKF) sur CpT
REAL(KIND=JPRB) :: ZDIFCVTH(KLON,0:KLEV) ! Flux de CV sur Theta air sec
REAL(KIND=JPRB) :: ZDIFCVPPU(KLON,0:KLEV) ! Flux de CVPP (EDKF) sur U
REAL(KIND=JPRB) :: ZDIFCVPPV(KLON,0:KLEV) ! Flux de CVPP (EDKF) sur V

REAL(KIND=JPRB) :: ZEDMFQ(KLON,0:KLEV) ! Mass flux part of EDMF flux for Qv
REAL(KIND=JPRB) :: ZEDMFS(KLON,0:KLEV) ! Mass flux part of EDMF flux for CpT
REAL(KIND=JPRB) :: ZEDMFU(KLON,0:KLEV) ! Mass flux part of EDMF flux for U
REAL(KIND=JPRB) :: ZEDMFV(KLON,0:KLEV) ! Mass flux part of EDMF flux for V
REAL(KIND=JPRB) :: ZMF_UP(KLON,0:KLEV) ! Mass flux for implicit formulation of EDMF equation (LEDMFI)
REAL(KIND=JPRB) :: ZMU(KLON,0:KLEV) ! Flux de masse (updraft) pour XIOS output
REAL(KIND=JPRB) :: ZMD(KLON,0:KLEV) ! Flux de masse (downdraft) pour XIOS output

REAL(KIND=JPRB) :: ZCONDCVPPL(KLON,0:KLEV) ! Flux de condensation liquide du a CVVPP (KFB)
REAL(KIND=JPRB) :: ZCONDCVPPI(KLON,0:KLEV) ! Flux de condensation glace du a CVVPP (KFB)
REAL(KIND=JPRB) :: ZPRODTH_CVPP(KLON,0:KLEV) ! Flux de production thermique de TKE du a CVPP(KFB)
REAL(KIND=JPRB) :: ZDTRAD(KLON,KLEV) ! radiation contribution to T tendency
REAL(KIND=JPRB) :: ZDQVDIFF(KLON,KLEV) ! turtb.diff contribution to Qv tendency
REAL(KIND=JPRB) :: ZRKQCTEND(KLON,KLEV) ! Qc input for RK condensation scheme
REAL(KIND=JPRB) :: ZRKQVTEND(KLON,KLEV) ! Qv input for RK condensation scheme
REAL(KIND=JPRB) :: ZRKTTEND(KLON,KLEV) ! T input for RK condensation scheme
REAL(KIND=JPRB) :: ZDQV, ZDQI, ZDQL, ZDQR, ZDQS, ZDQC, ZGDT, ZGDTI,&
                 & ZQV0, ZQX0, ZQX1,&
                 & ZCONVC, ZTOTC,ZDTURDIFF
REAL(KIND=JPRB) :: ZTMPAF(KLON,KLEV)    ! temporary array for Add_Field_3d.
REAL(KIND=JPRB) :: ZTMPAS(KLON)         ! temporary array for Add_Field_2d..
REAL(KIND=JPRB) :: ZTMPPRODTH(KLON,0:KLEV) ! temporary array

!!for BAYRAD
REAL(KIND=JPRB) :: ZDE2MR(KLON,KLEV) ! temporary array for conversion of density to mixing ratio
REAL(KIND=JPRB) :: ZCOEFRAIN(2) ! RTTOVSCATT coefficients to convert flux to density for rain
REAL(KIND=JPRB) :: ZCOEFSNOW(2) ! RTTOVSCATT coefficients to convert flux to density for snow
REAL(KIND=JPRB) :: ZRHORAIN ! RTTOVSCATT fixed density for rain
REAL(KIND=JPRB) :: ZRHOSNOW ! RTTOVSCATT fixed density of snow
!-----------------------------------------------------------------

! - 2D (0:KLEV) .

! ZKTROV     : COEFFICIENT D'ECHANGE VERTICAL DE T ET Q EN KG/(M*M*S).
! ZKUROV     : COEFFICIENT D'ECHANGE VERTICAL DE U ET V EN KG/(M*M*S).
! ZKNROV     : COEFFICIENT D'ECHANGE VERTICAL NEUTRE EN KG/(M*M*S).
! ZNBVNO     : FREQUENCE DE BRUNT-VAISALA DIVISEE PAR G FOIS LA DENSITE.

! ZNEBS      : NEBULOSITE STRATIFORME (SCHEMA STATISTIQUE DE NUAGES).
!            : STRATIFORM CLOUDINESS (STATISTICAL CLOUD SCHEME)
! ZQLIS      : QUANTITE D'EAU LIQUIDE STRATIFORME (SCHEMA STATISTIQUE).
!            : STRATIFORM LIQUID WATER (STATISTICAL CLOUD SCHEME)

! ZCFRSO     : FLUX SOLAIRE RADIATIF EN CIEL CLAIR.
! ZCFRTH     : FLUX THERMIQUE RADIATIF EN CIEL CLAIR.

! - 2D (1:KLEV) .

! INLAB      : INDICE D'INSTABILITE CONVECTIVE.

INTEGER(KIND=JPIM) :: INND(KLON)
REAL(KIND=JPRB) :: ZXDROV(KLON),ZXHROV(KLON)
REAL(KIND=JPRB) :: ZUGST(KLON),ZVGST(KLON)
REAL(KIND=JPRB) :: ZCDROV(KLON),ZCHROV(KLON),ZDQSTS(KLON),ZGWDCS(KLON),&
 & ZHQ(KLON),ZHU(KLON),ZHTR(KLON),ZCDNH(KLON),ZMOD(KLON),&
 & ZRTI(KLON),ZDPHI(KLON),ZPRS(KLON),ZSTAB(KLON),ZTAUX(KLON)
REAL(KIND=JPRB) :: ZWFC(KLON),ZWPMX(KLON),ZWLMX(KLON),ZWSEQ(KLON),&
 & ZWSMX(KLON),ZWWILT(KLON),&
 & ZC3(KLON),ZCG(KLON),ZCN(KLON),&
 & ZNEIJG(KLON),ZNEIJV(KLON)
REAL(KIND=JPRB) :: ZPCLS(KLON)
REAL(KIND=JPRB) :: ZPREN(KLON)
REAL(KIND=JPRB) :: ZFRSODS(KLON)
REAL(KIND=JPRB) :: ZCD(KLON)

! - 1D (DIAGNOSTIQUE) .

! ZCDROV     : PCD RENORME EN DENSITE FOIS VITESSE.
! ZCDNH      : COEFFICIENT NEUTRE D'ECHANGE EN SURFACE POUR LA CHALEUR.
! ZCDNH      : EXCHANGE COEFF. AT SURFACE LEVEL IN NEUTRAL CONDITIONS FOR HEAT.
! ZCG        : COEFFICIENT THERMIQUE DU SOL NU.
! ZCG        : THERMICAL COEFFICIENT OF BARE GROUND.
! ZCN        : COEFFICIENT THERMIQUE DE LA NEIGE.
! ZCN        : THERMICAL COEFFICIENT OF SNOW.
! ZCHROV     : PCH RENORME EN DENSITE FOIS VITESSE.
! ZC3        : COEFFICIENT UTILE POUR LE CALCUL DU DRAINAGE
! ZDQSTS     : DERIVEE DE PQSATS PAR RAPPORT A LA TEMPERATURE.
! ZGWDCS     : VARIABLE DE SURFACE POUR LE DRAG OROGRAPHIQUE (RHO*N0/G).
! ZHQ        : POIDS DE L'HUMIDITE DE L'AIR DANS L'HUMIDITE DE SURFACE.
! ZHTR       : RESISTANCE A LA TRANSPIRATION DU COUVERT VEGETAL.
! ZHTR       : FOLIAGE TRANSPIRATION RESISTANCE.
! ZHU        : POIDS DE L'HUMIDITE SATURANTE DANS L'HUMIDITE DE SURFACE.
! ZNEIJG     : FRACTION DE NEIGE RECOUVRANT LE SOL.
! ZNEIJV     : FRACTION DE NEIGE RECOUVRANT LA VEGETATION.
! ZRTI       : INVERSE DE R*T.
! ZDPHI      : EPAISSEUR EN GEOPOTENTIEL DU NIVEAU DE SURFACE.
! ZPRS       : CONSTANTE DES GAZ POUR L'AIR AU SOL.
! ZSTAB      : INDICE DE STABILITE A LA SURFACE.
! INND       : INDICE DE PRECIPITATIONS CONVECTIVES.
! ZSFRTP     : FLUX RADIATIFS SPECTRAUX AU SOMMET.
! ZSFRBM     : FLUX RADIATIFS SPECTRAUX A LA SURFACE.
! ZWFC       : TENEUR EN EAU A LA CAPACITE AUX CHAMPS.
! ZWFC       : FIELD CAPACITY WATER CONTENT.
! ZWPMX      : TENEUR EN EAU MAXIMALE DU RESERVOIR PROFOND.
! ZWPMX      : MAXIMUM WATER CONTENT OF THE DEEP WATER-TANK.
! ZWLMX      : TENEUR EN EAU MAXIMALE DU RESERVOIR D'INTERCEPTION.
! ZWLMX      : MAXIMUM WATER CONTENT OF THE INTERCEPTION WATER-TANK.
! ZWSEQ      : TENEUR EN EAU A L'EQUILIBRE (EQUILIBRE ENTRE GRAVITE ET
!              CAPILLARITE) EN SURFACE.
! ZWSEQ      : SURFACE WATER CONTENT FOR THE BALANCE BETWEEN GRAVITY
!              AND CAPILLARITY
! ZWSMX      : TENEUR EN EAU MAXIMALE DU RESERVOIR SUPERFICIEL.
! ZWSMX      : MAXIMUM WATER CONTENT FOR THE SUPERFICIAL WATER-TANK.
! ZWWILT     : TENEUR EN EAU AU POINT DE FLETRISSEMENT.
! ZWWILT     : WATER CONTENT AT THE WILTING POINT.
! ZSSO_STDEV : OROGRAPHY STANDARD DEVIATION
! ZTWSNOW    : SNOW COVER FROM SURFEX
! ZTOWNS     : FRACTION OF TOWN FROM SURFEX
REAL(KIND=JPRB) :: ZDAER(KLEV), ZHUC(KLEV), ZBLH(KLON)
REAL(KIND=JPRB) :: ZQO3(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZAER(KLON,KLEV,6)
REAL(KIND=JPRB) :: ZAERD(KLON,KLEV)
REAL(KIND=JPRB) :: ZAERINDS(KLON,KLEV)
REAL(KIND=JPRB) :: ZQCO2(KLON,KLEV)
REAL(KIND=JPRB) :: ZROZ(KLON,KLEV)
REAL(KIND=JPRB) :: ZDPHIV(KLON),ZDPHIT(KLON)

REAL(KIND=JPRB) :: ZMAN(0:KLEV), ZMAK(0:KLEV)
REAL(KIND=JPRB) :: ZSSO_STDEV(KLON)
REAL(KIND=JPRB) :: ZTWSNOW(KLON),ZTOWNS(KLON)
! - (PROFILS DIAGNOSTIQUES)
! ZDAER     : EPAISSEUR OPTIQUE DES AEROSOLS STANDARDS DANS LA COUCHE
! ZDAER     : OPTICAL DEPTH OF STANDARD AEROSOLS IN THE LAYER.
! ZHUC      : HUMIDITE CRITIQUE PAR NIVEAU POUR LE CALCUL DE PNEB
! ZHUC      : CRITICAL MOISTURE FOR EACH LEVEL FOR PNEB CALCULATION.
!   ZQO3    : RAPPORT DE MELANGE MASSIQUE D'OZONE
!        (0):     "         "    MOYEN AU-DESSUS DU MODELE
!   ZQO3    : OZONE MIXING RATIO (MASS).
!        (0):AVERAGED-ABOVE      "         " .
!   ZQCO2   : RAPPORT MASSIQUE LOCAL DU CO2.
!   ZQCO2   : CO2 MIXING RATIO (MASS).

! IJN        : DIMENSION TABLEAUX ETENDUS POUR CYCLE DIURNE RAYONNEMENT
!              IJN AU PLUSL A KLON

!* INPUT ARGUMENTS FOR ACRADIN ( RAYT ECMWF POUR CLIMAT )

!            1-D ARRAYS
!            ----------

REAL(KIND=JPRB) :: ZTRSOD(KLON)

!            2-D ARRAYS
!            ----------

!* OUTPUT ARGUMENTS FOR THE ECMWF PHYSICS

!            0.2  LOCAL ARRAYS FOR ECMWF PHYSICS PACKAGE
!                 --------------------------------------

REAL(KIND=JPRB) :: ZCEMTR(KLON,0:1) , ZCTRSO(KLON,0:1)
REAL(KIND=JPRB) :: ZALBD(KLON,YDMODEL%YRML_PHY_RAD%YRERAD%NSW), ZALBP(KLON,YDMODEL%YRML_PHY_RAD%YRERAD%NSW),&
                 & ZALB(KLON)
REAL(KIND=JPRB) :: ZSFSWDIR (KLON,YDMODEL%YRML_PHY_RAD%YRERAD%NSW), ZSFSWDIF (KLON,YDMODEL%YRML_PHY_RAD%YRERAD%NSW)
REAL(KIND=JPRB) :: ZTRSODIR (KLON,YDMODEL%YRML_PHY_RAD%YRERAD%NSW), ZTRSODIF (KLON,YDMODEL%YRML_PHY_RAD%YRERAD%NSW)
REAL(KIND=JPRB) :: ZFSDNN(KLON),ZFSDNV(KLON)

!            1-D ARRAYS
!            ----------

REAL(KIND=JPRB) :: ZSUDU(KLON) , ZDSRP(KLON) , ZSDUR(KLON)
REAL(KIND=JPRB) :: ZTHETAVS(KLON), ZTHETAS(KLON)
REAL(KIND=JPRB) :: ZAESEA(KLON), ZAELAN(KLON), ZAESOO(KLON), ZAEDES(KLON)
REAL(KIND=JPRB) :: ZAESUL(KLON), ZAEVOL(KLON)
REAL(KIND=JPRB) :: ZMERL(KLON)

!            2-D ARRAYS
!            ----------

REAL(KIND=JPRB) :: ZTENT(KLON,KLEV), ZGEOSLC(KLON,KLEV)
REAL(KIND=JPRB) :: ZTHETAV(KLON,KLEV)

!            LOCAL ARRAYS FOR TKE
! ZCOEFN : COEFFICIENT STATISTIQUE POUR LES FLUX D'EAUX CONDENSEES.

REAL(KIND=JPRB) :: ZCOEFN(KLON,KLEV)

!            LOCAL ARRAYS FOR ACVPPKF
REAL(KIND=JPRB) :: ZQLI_CVPP(KLON,KLEV)
REAL(KIND=JPRB) :: ZNEB_CVPP(KLON,KLEV)
!            LOCAL ARRAYS FOR EDKF
REAL(KIND=JPRB) :: ZIMPL

!           2-D ARRAY FOR SIMPL.RADIATION SCHEME

REAL(KIND=JPRB) :: ZZNEB(KLON,KLEV)

INTEGER(KIND=JPIM) :: IJN, IMLTYPE, JCHA, JLEV, JLON, JSG, JGFL, JDIAG
INTEGER(KIND=JPIM) :: ILONMNH, IKRR, ISPLITR ! useful size of klon arrays for mesonh physics
LOGICAL :: LLCLS, LLHMT, LLMAF, LLREDPR

REAL(KIND=JPRB) :: ZAEN, ZAEO, ZALBV, ZCARDI, ZEPS, ZEPS0, ZEPSNEB, ZEPSO3
REAL(KIND=JPRB) :: ZEPSA, ZALBPMER

!            2-D ARRAYS

! ZNEBC      : NEBULOSITE  CONVECTIVE A L'ECHELLE DE LA MAILLE.
! ZQLIC      : EAU LIQUIDE CONVECTIVE A L'ECHELLE DE LA MAILLE.
! ZQCL       : CONDENSAT STRATIFORME LIQUIDE
! ZQCI       : CONDENSAT STRATIFORME SOLIDE
! ZFHEVPPC   : FLUX DE CHALEUR DU A L'EVAPORATION DES PREC. CONVECTIVES.
! ZFHMLTSC   : FLUX DE CHALEUR DU A LA FONTE/GEL DES PREC. CONVECTIVES.
! ZFPEVPPC   : EVAPORATION DES PREC. CONVECTIVES.
! ICIS       : INDICE DE NIVEAU D'INSTABILITE SECHE.

REAL(KIND=JPRB) :: ZNEBC(KLON,KLEV),ZQLIC(KLON,KLEV)
REAL(KIND=JPRB) :: ZQCL(KLON,KLEV),ZQCI(KLON,KLEV)
REAL(KIND=JPRB) :: ZFHEVPPC(KLON,0:KLEV),ZFHMLTSC(KLON,0:KLEV)&
 & ,ZFPEVPPC(KLON,0:KLEV)
INTEGER(KIND=JPIM) :: ICIS(KLON,KLEV)


!           SURFEX local VARIABLES
!           ----------------------------

! Implicit coupling coefficients
INTEGER(KIND=JPIM) :: IRR
REAL(KIND=JPRB) :: ZDTMSE,ZRHGMT,ZSTATI
REAL(KIND=JPRB) :: ZCFAQ(KLON,KLEV),ZCFAS(KLON,KLEV),&
 & ZCFATH(KLON,KLEV),ZCFAU(KLON,KLEV),ZCFBQ(KLON,KLEV),&
 & ZCFBS(KLON,KLEV),ZCFBTH(KLON,KLEV),&
 & ZCFBU(KLON,KLEV),ZCFBV(KLON,KLEV),&
 & ZCFBU_G(KLON,KLEV),ZCFBV_G(KLON,KLEV),&
 & ZCFBS_G(KLON,KLEV),ZCFBQ_G(KLON,KLEV)

REAL(KIND=JPRB) :: ZDSE(KLON,KLEV)
REAL(KIND=JPRB) :: ZFEV(KLON),ZFMDU(KLON),ZFMDV(KLON),ZFEVS(KLON)
REAL(KIND=JPRB) :: ZSRAIN(KLON), ZSSNOW(KLON), ZSGROUPEL(KLON)
REAL(KIND=JPRB) :: ZSFCO2(KLON), ZRHODREFM(KLON)
REAL(KIND=JPRB) :: ZDEPTH_HEIGHT(KLON,KLEV), ZZS(KLON)
REAL(KIND=JPRB) :: ZTSN(KLON),ZTN(KLON)
REAL(KIND=JPRB)   :: ZBUDTH (KLON)
REAL(KIND=JPRB)   :: ZBUDSO (KLON)
REAL(KIND=JPRB)   :: ZFCLL  (KLON)
! FOR Hv
REAL(KIND=JPRB)   :: ZHV2(KLON)
! FOR DUST
REAL(KIND=JPRB), DIMENSION (KLON,KLEV) ::  ZQDM
REAL(KIND=JPRB) :: ZCFASV(KLON,KLEV,1:YDMODEL%YRML_GCONF%YGFL%NGFL_EXT) ! SCOND MEMBRE POUR LES SCALAIRES PASSIFS
REAL(KIND=JPRB) :: ZCFBSV(KLON,KLEV,1:YDMODEL%YRML_GCONF%YGFL%NGFL_EXT) ! SCOND MEMBRE POUR LES SCALAIRES PASSIFS
REAL(KIND=JPRB) :: ZSMOOTRAC(1:YDMODEL%YRML_GCONF%YGFL%NGFL_EXT) ! SCOND MEMBRE POUR LES SCALAIRES PASSIFS
REAL(KIND=JPRB) :: ZINVDT, ZINVG, ZRSCP, ZINVATM

REAL(KIND=JPRB),  DIMENSION(KLON,1,KLEV,YDMODEL%YRML_GCONF%YGFL%NGFL_EXT):: ZZI_SVM
REAL(KIND=JPRB),  DIMENSION (KLON,KLEV,YDMODEL%YRML_GCONF%YGFL%NGFL_EZDIAG):: ZZI_PEZDIAG
REAL(KIND=JPRB), DIMENSION (:,:,:), ALLOCATABLE  :: ZSVM, ZPSV
REAL(KIND=JPRB), DIMENSION (:,:),   ALLOCATABLE  :: ZSFSV  ! passifs scalaires surf flux
! TRAITEMENT DES SCALAIRES PASSIFS
REAL(KIND=JPRB) :: ZTM(KLON,KLEV)
REAL(KIND=JPRB), DIMENSION (KLON,1,KLEV) :: ZZZ,ZDZZ,ZZI_PABSM, ZZI_THM,&
                & ZZI_EXNREFM, ZZI_RHODREFM,ZEVAP,ZZDEP,ZZI_RHO
REAL(KIND=JPRB) :: ZZI_APHI(KLON,0:KLEV)
REAL(KIND=JPRB), DIMENSION (KLON,1,KLEV,6) :: ZZI_RM
!            3-D ARRAYS
REAL(KIND=JPRB), DIMENSION(KLON,KLEV,YDMODEL%YRML_PHY_RAD%YRERAD%NSW):: ZPIZA_DST !Single scattering
                                             ! albedo of dust (points,lev,wvl)
REAL(KIND=JPRB), DIMENSION(KLON,KLEV,YDMODEL%YRML_PHY_RAD%YRERAD%NSW):: ZCGA_DST  !Assymetry factor
                                             ! for dust (points,lev,wvl)
REAL(KIND=JPRB), DIMENSION(KLON,KLEV,YDMODEL%YRML_PHY_RAD%YRERAD%NSW):: ZTAUREL_DST !tau/tau_{550}
                                             !dust (points,lev,wvl)

!         ACFLUSO (ECUME) local variable
!-------------------------------------------
REAL(KIND=JPRB) :: ZCE(KLON), ZCEROV(KLON), ZCRTI(KLON)


!        New ACDIFV1 local variable
!--------------------------------------------
REAL(KIND=JPRB)   :: ZXURO(KLON,0:KLEV)
REAL(KIND=JPRB)   :: ZXQRO(KLON,0:KLEV)
REAL(KIND=JPRB)   :: ZXTRO(KLON,0:KLEV)

!        New ACNORGWD local variables
!--------------------------------------------
REAL(KIND=JPRB) :: ZD_U(KLON,KLEV), ZD_V(KLON,KLEV)
REAL(KIND=JPRB) :: Z_PP(KLON,KLEV) 
REAL(KIND=JPRB) :: Z_UU(KLON,KLEV) 
REAL(KIND=JPRB) :: Z_VV(KLON,KLEV)
REAL(KIND=JPRB) :: Z_TT(KLON,KLEV)
REAL(KIND=JPRB) :: Z_VO(KLON,KLEV)  
REAL(KIND=JPRB) :: ZFLX_LOTT_GWU(KLON,0:KLEV), ZFLX_LOTT_GWV(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZPRECGWD(KLON)

!    TKE+ for ACCLDIA
REAL(KIND=JPRB)   :: ZTKE1(KLON,KLEV)
REAL(KIND=JPRB)   :: ZTPRDY(KLON,KLEV)

!   For ACVISIH
REAL(KIND=JPRB)   :: ZQGM(KLON,KLEV)


!        New ARP_GROUND_PARAM local variable
!------------------------------------------------

REAL(KIND=JPRB)   :: ZALPHA1(KLON,0:KLEV)
REAL(KIND=JPRB)   :: ZCOEFA (KLON,0:KLEV)
REAL(KIND=JPRB)   :: ZLVT   (KLON,0:KLEV)
REAL(KIND=JPRB)   :: ZQICE  (KLON,0:KLEV)
REAL(KIND=JPRB)   :: ZDIFWQ (KLON)
REAL(KIND=JPRB)   :: ZDIFWS (KLON)
REAL(KIND=JPRB)   :: ZSC_FEVI (KLON),ZSC_FEVN(KLON),ZSC_FCLL(KLON),ZSC_FCLN(KLON)

!           TRAJECTORY (For diffusion !) local VARIABLES
!           ----------------------------
REAL(KIND=JPRB) :: ZCDROV_SAVE(KLON),ZCHROV_SAVE(KLON)
REAL(KIND=JPRB) :: ZKTROV_SAVE(KLON,0:KLEV),ZKUROV_SAVE(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZTRAJGWD(KLON,0:KLEV) !Traj buffer saved for TL/AD (YDMODEL%YRML_PHY_MF%YRSIMPHL%LGWDSPNL)

REAL(KIND=JPRB)    :: ZRVMD,ZDELTA
LOGICAL            :: LLAERO, LLAROME, LLCALLRAD
REAL(KIND=JPRB)    :: ZAIPCMT(KLON) ! Activity Index of PCMT: 1. if PCMT is active, 0. else case.
REAL(KIND=JPRB)    :: ZALF_CAPE(KLON)
REAL(KIND=JPRB)    :: ZALF_CVGQ(KLON)
REAL(KIND=JPRB)    :: ZQIC(KLON,KLEV),ZQLC(KLON,KLEV),ZQRC(KLON,KLEV),ZQSC(KLON,KLEV),ZQVI
REAL(KIND=JPRB)    :: ZQLI_CVP(KLON,KLEV)
REAL(KIND=JPRB)    :: ZQC_DET_PCMT(KLON,KLEV)
REAL(KIND=JPRB)    :: ZFPLS(KLON,0:KLEV),ZFPLC(KLON,0:KLEV),ZFPL(KLON,0:KLEV)
REAL(KIND=JPRB)    :: ZCSGC(KLON,KLEV)
REAL(KIND=JPRB)    :: ZTZER
CHARACTER(LEN=200) :: CLERR

! Tracers: prognostique aerosols, passive scalars...
INTEGER(KIND=JPIM) :: INBTRA
INTEGER(KIND=JPIM) :: INBTRA_DEP
REAL(KIND=JPRB), ALLOCATABLE :: ZSTRCTRA(:,:,:)
REAL(KIND=JPRB), ALLOCATABLE :: ZTRA(:,:,:)

!        New chemistry local variables
!-------------------------------------
INTEGER(KIND=JPIM)               :: IFLDX, IFLDX2, ILEVX 
INTEGER(KIND=JPIM), ALLOCATABLE  :: INDCHEM(:), IGPLAT(:)
REAL(KIND=JPRB), ALLOCATABLE     :: ZSD_XA(:,:,:), ZSD_X2(:,:), ZTENGFL(:,:,:)
REAL(KIND=JPRB), ALLOCATABLE     :: ZCFLX(:,:), ZCFLXO(:,:), ZCHEMDV(:,:), ZAEROP(:,:,:)
REAL(KIND=JPRB), ALLOCATABLE     :: ZTENC(:,:,:), ZDELP(:,:), ZWND(:), ZDUMMY1(:,:), ZGELAT(:)
REAL(KIND=JPRB), ALLOCATABLE     :: ZNEEFLX(:), ZCHEM2AER(:,:,:)
CHARACTER (LEN = 20) , POINTER ::   CGMIXLEN
REAL(KIND=JPRB) :: ZDCAPE(KLON) ! Descending CAPE for gusts.

! ACRANEB/ACRANEB2 local variables
! --------------------------------
REAL(KIND=JPRB) :: ZLAMB           ! proportion of Lambertian scattering
REAL(KIND=JPRB) :: ZALBDIR  (KLON) ! direct (parallel) surface albedo
REAL(KIND=JPRB) :: ZCLCT_RAD(KLON) ! total cloud cover for radiation
REAL(KIND=JPRB) :: ZDECRD   (KLON) ! decorrelation depth for cloud overlaps
REAL(KIND=JPRB) :: ZDECRD_MF(KLON) ! decorrelation depth for cloud overlaps
                                   ! in microphysics

REAL(KIND=JPRB) :: ZQG(KLON,KLEV)
REAL(KIND=JPRB) :: ZDQG

! IFS deep convection scheme local variables
! --------------------------------
INTEGER(KIND=JPIM) :: ITOPC(KLON),IBASC(KLON),ITYPE(KLON),ISPPN2D
INTEGER(KIND=JPIM) :: ICBOT(KLON),ICTOP(KLON),IBOTSC(KLON)
LOGICAL :: LLDSLPHY,LLPTQ,LLLAND(KLON),LLCUM(KLON),LLSC(KLON),LLSHCV(KLON),LLLINOX(KLON)
REAL(KIND=JPRB) :: ZLIGH_CTG(KLON),ZCTOPH(KLON),ZPRECMX(KLON),ZICE(KLON),ZCDEPTH(KLON),ZWMFU(KLON)
REAL(KIND=JPRB) :: ZVERVEL(KLON,KLEV), ZGEOM1(KLON,KLEV), ZGEOMH(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZTENQ(KLON,KLEV),ZTENU(KLON,KLEV),ZTENV(KLON,KLEV)
REAL(KIND=JPRB) :: ZLCRIT_AER(KLON,KLEV),ZSNDE(KLON,KLEV,2)
REAL(KIND=JPRB) :: ZCUCONVCA(KLON),ZGAW(KLON),ZVDIFTS,ZDXTDK(KLON)
REAL(KIND=JPRB) :: ZLU(KLON,KLEV),ZLUDE(KLON,KLEV),ZMFU(KLON,KLEV)
REAL(KIND=JPRB) :: ZLISUM(KLON,KLEV),ZMFD(KLON,KLEV)
REAL(KIND=JPRB) :: ZWMEAN(KLON),ZACPR(KLON),ZDIFF(KLON,KLEV)
REAL(KIND=JPRB) :: ZMFUDE_RATE(KLON,KLEV),ZMFDDE_RATE(KLON,KLEV)
REAL(KIND=JPRB) :: ZFHPCL(KLON,0:KLEV),ZFHPCN(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZFCQLF(KLON,0:KLEV),ZFCQLI(KLON,0:KLEV),ZFRSO(KLON,0:KLEV),ZFRTH(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZGP2DSPP(KLON,1),ZLUDELI(KLON,KLEV,4),ZLRAIN(KLON,KLEV),ZRSUD(KLON,KLEV,2)
REAL(KIND=JPRB), ALLOCATABLE :: ZCEN(:,:,:),ZSCAV(:)

! Precipitation type diagnostics
!--------------------------------
REAL(KIND=JPRB)   :: ZFPLSG(KLON,0:KLEV)

REAL(KIND=JPRB) :: ZENTCH(KLON,KLEV)

REAL(KIND=JPRB) :: ZHOOK_HANDLE

!     ------------------------------------------------------------------

#include "abor1.intfb.h"
#include "acclph.intfb.h"
#include "accoefk.intfb.h"
#include "accvimp.intfb.h"
#include "accvimp_v3.intfb.h"
#include "accvimpgy.intfb.h"
#include "cucalln_mf.intfb.h"
#include "acdifoz.intfb.h"
#include "acdifus.intfb.h"
#include "acdnshf.intfb.h"
#include "acdrac.intfb.h"
#include "acnorgwd.intfb.h"
#include "acdrag.intfb.h"
#include "acdrme.intfb.h"
#include "acdrov.intfb.h"
#include "acfluso.intfb.h"
#include "achmt.intfb.h"
#include "acmixlenz.intfb.h"
#include "acmixlentm.intfb.h"
#include "acmixelen.intfb.h"
#include "acnebc.intfb.h"
#include "acnebn.intfb.h"
#include "acnebr.intfb.h"
#include "acozone.intfb.h"
#include "acpblh.intfb.h"
#include "acpblhtm.intfb.h"
#include "acpluie.intfb.h"
#include "acpluis.intfb.h"
#include "acpluiz.intfb.h"
#include "acradcoef.intfb.h"
#include "recmwf.intfb.h"
#include "acdayd.intfb.h"
#include "acrso.intfb.h"
#include "acraneb.intfb.h"
#include "acraneb2.intfb.h"
#include "acsol.intfb.h"
#include "actqsat.intfb.h"
#include "actqsats.intfb.h"
#include "acupu.intfb.h"
#include "acupm.intfb.h"
#include "acupd.intfb.h"
#include "acuptq.intfb.h"
#include "acveg.intfb.h"
#include "aplmphys.intfb.h"
#include "qngcor.intfb.h"
#include "radaer.intfb.h"
#include "radheat.intfb.h"
#include "radozcmf.intfb.h"
#include "suozon.intfb.h"
#include "actke.intfb.h"
#include "acdifv1.intfb.h"
#include "acdifv2.intfb.h"
#include "acdifv3.intfb.h"
#include "achmtls.intfb.h"
#include "aro_ground_param.h"
#include "aro_ground_diag.h"
#include "aro_ground_diag_2isba.h"
#include "aro_ground_diag_z0.h"
#include "accvud.intfb.h"
#include "accsu.intfb.h"
#include "acpcmt.intfb.h"
#include "acmodo.intfb.h"
#include "acnsdo.intfb.h"
#include "acnebcond.intfb.h"
#include "accdev.intfb.h"
#include "acnpart.intfb.h"
#include "acvppkf.intfb.h"
#include "acptke.intfb.h"
#include "arp_ground_param.intfb.h"
#include "wrphtrajtm_nl.intfb.h"
#include "accldia.intfb.h"
#include "surf_ideal_flux.intfb.h"
#include "actkecoefk.intfb.h"
#include "actkehmt.intfb.h"
#include "acmrip.intfb.h"
#include "acmris.intfb.h"
#include "acmriss.intfb.h"
#include "actkecoefkh.intfb.h"
#include "actkezotls.intfb.h"
#include "aro_mnhdust.h"
#include "wrscmr.intfb.h"
#include "checkmv.intfb.h"
#include "acaa1.intfb.h"
#include "chem_main.intfb.h"
#include "mean_rad_temp.intfb.h"
#include "acevadcape.intfb.h"
#include "ppwetpoint.intfb.h"
#include "dprecips.intfb.h"
#include "acvisih.intfb.h"
#include "culight.intfb.h"

!     ------------------------------------------------------------------

#include "fcttrm.func.h"
!!#include "fctdoi.func.h"

!     ------------------------------------------------------------------

IF (LHOOK) CALL DR_HOOK('APLPAR',0,ZHOOK_HANDLE)
ASSOCIATE(YDDIM=>YDGEOMETRY%YRDIM,YDDIMV=>YDGEOMETRY%YRDIMV,YDGEM=>YDGEOMETRY%YRGEM, YDMP=>YDGEOMETRY%YRMP, &
 &   YDSTA=>YDGEOMETRY%YRSTA, YDVETA=>YDGEOMETRY%YRVETA, YDVFE=>YDGEOMETRY%YRVFE,  YDLAP=>YDGEOMETRY%YRLAP, &
 &  YDCSGLEG=>YDGEOMETRY%YRCSGLEG,  YDVSPLIP=>YDGEOMETRY%YRVSPLIP, YDVSLETA=>YDGEOMETRY%YRVSLETA, &
 &  YDHSLMER=>YDGEOMETRY%YRHSLMER,  YDCSGEOM=>YDGEOMETRY%YRCSGEOM, YDCSGEOM_NB=>YDGEOMETRY%YRCSGEOM_NB, &
 &  YDGSGEOM=>YDGEOMETRY%YRGSGEOM, YDGSGEOM_NB=>YDGEOMETRY%YRGSGEOM_NB,  YDSPGEOM=>YDGEOMETRY%YSPGEOM, YDVAB=>YDGEOMETRY%YRVAB, &
 &  YDPHY=>YDMODEL%YRML_PHY_MF%YRPHY,YDLDDH=>YDMODEL%YRML_DIAG%YRLDDH, &
 & YDTOPH=>YDMODEL%YRML_PHY_MF%YRTOPH,YDRCOEF=>YDMODEL%YRML_PHY_RAD%YRRCOEF, &
 & YDERDI=>YDMODEL%YRML_PHY_RAD%YRERDI, YDSIMPHL=>YDMODEL%YRML_PHY_MF%YRSIMPHL, &
 & YDMCC=>YDMODEL%YRML_AOC%YRMCC,YDRIP=>YDMODEL%YRML_GCONF%YRRIP,YDARPHY=>YDMODEL%YRML_PHY_MF%YRARPHY,  &
 & YDERAD=>YDMODEL%YRML_PHY_RAD%YRERAD,YDPHY3=>YDMODEL%YRML_PHY_MF%YRPHY3,  &
 & YDPHY2=>YDMODEL%YRML_PHY_MF%YRPHY2,YDPHY1=>YDMODEL%YRML_PHY_MF%YRPHY1,YDPHY0=>YDMODEL%YRML_PHY_MF%YRPHY0,  &
 & YGFL=>YDMODEL%YRML_GCONF%YGFL, &
 & YDNORGWD=>YDMODEL%YRML_PHY_MF%YRNORGWD, &
  & YDPARAR=>YDMODEL%YRML_PHY_MF%YRPARAR,YDMSE=>YDMODEL%YRML_PHY_MF%YRMSE,  &
  & YDPHYDS=>YDMODEL%YRML_PHY_MF%YRPHYDS,YDEPHY=>YDMODEL%YRML_PHY_EC%YREPHY)

ASSOCIATE(XMINLM=>YDPHY0%XMINLM, RTCAPE=>YDPHY0%RTCAPE, GRSO=>YDPHY0%GRSO, GCVTSMO=>YDPHY0%GCVTSMO, &
 & XKLM=>YDPHY0%XKLM, GAEPS=>YDPHY0%GAEPS, AERCS1=>YDPHY0%AERCS1, &
 & AERCS3=>YDPHY0%AERCS3, AERCS5=>YDPHY0%AERCS5, HUTIL2=>YDPHY0%HUTIL2, &
 & HUTIL1=>YDPHY0%HUTIL1, XMAXLM=>YDPHY0%XMAXLM, RDTFAC=>YDPHY0%RDTFAC, &
 & TEQK=>YDPHY0%TEQK, HUCOE=>YDPHY0%HUCOE, &
 & LCVNHD=>YDPHY0%LCVNHD, TEQC=>YDPHY0%TEQC, UHDIFV=>YDPHY0%UHDIFV, &
 & HUTIL=>YDPHY0%HUTIL, NPCLO1=>YDPHY0%NPCLO1, NPCLO2=>YDPHY0%NPCLO2, &
 & RDECRD=>YDPHY0%RDECRD, RDECRD1=>YDPHY0%RDECRD1, RDECRD2=>YDPHY0%RDECRD2, &
 & RDECRD3=>YDPHY0%RDECRD3, RDECRD4=>YDPHY0%RDECRD4, &
 & ETKE_MIN=>YDPHY0%ETKE_MIN, &
 & HSOLIWR=>YDPHY1%HSOLIWR, ALCRIN=>YDPHY1%ALCRIN, ALBMED=>YDPHY1%ALBMED, &
 & WSMX=>YDPHY1%WSMX, LALBMERCLIM=>YDPHY1%LALBMERCLIM, &
 & HSOLIT0=>YDPHY1%HSOLIT0, HSOL=>YDPHY1%HSOL, WPMX=>YDPHY1%WPMX, &
 & EMCRIN=>YDPHY1%EMCRIN, EMMMER=>YDPHY1%EMMMER, TMERGL=>YDPHY1%TMERGL, &
 & RTINER=>YDPHY1%RTINER, EMMGLA=>YDPHY1%EMMGLA, &
 & TSPHY=>YDPHY2%TSPHY, LRAFTKE=>YDPHY2%LRAFTKE, LRAFTUR=>YDPHY2%LRAFTUR, &
 & HVCLS=>YDPHY2%HVCLS, HTCLS=>YDPHY2%HTCLS, &
 & FSM_HH=>YDPHY3%FSM_HH, FSM_GG=>YDPHY3%FSM_GG, FSM_FF=>YDPHY3%FSM_FF, &
 & FSM_EE=>YDPHY3%FSM_EE, FSM_II=>YDPHY3%FSM_II, FSM_CC=>YDPHY3%FSM_CC, &
 & FSM_DD=>YDPHY3%FSM_DD, RLAMB_WATER=>YDPHY3%RLAMB_WATER, RII0=>YDPHY3%RII0, &
 & QCO2=>YDPHY3%QCO2, RLAMB_SOLID=>YDPHY3%RLAMB_SOLID, &
 & NDLUNG=>YDDIM%NDLUNG, NDGUNG=>YDDIM%NDGUNG, NPROMA=>YDDIM%NPROMA, &
 & NDLUXG=>YDDIM%NDLUXG, NDGUXG=>YDDIM%NDGUXG, &
 & LRDEPOS=>YDARPHY%LRDEPOS, LMPA=>YDARPHY%LMPA, CCOUPLING=>YDARPHY%CCOUPLING, &
 & LMDUST=>YDARPHY%LMDUST, LMSE=>YDARPHY%LMSE, &
 & LSURFEX_KFROM=>YDARPHY%LSURFEX_KFROM, &
 & YA=>YGFL%YA, NGFL_EZDIAG=>YGFL%NGFL_EZDIAG, YFQTUR=>YGFL%YFQTUR, &
 & YFSTUR=>YGFL%YFSTUR, YIRAD=>YGFL%YIRAD, YLRAD=>YGFL%YLRAD, &
 & XZSEPS=>YDMSE%XZSEPS, &
 & NSFLUX=>YDPHYDS%NSFLUX, NSFORC=>YDPHYDS%NSFORC, &
 & LTRAJPS=>YDSIMPHL%LTRAJPS, LVDIFSPNL=>YDSIMPHL%LVDIFSPNL, &
 & LGWDSPNL=>YDSIMPHL%LGWDSPNL, LRAYSP=>YDSIMPHL%LRAYSP, &
 & LSTRA=>YDPHY%LSTRA, LAEROSOO=>YDPHY%LAEROSOO, LCDDPRO=>YDPHY%LCDDPRO, &
 & LRKCDEV=>YDPHY%LRKCDEV, LHUCN=>YDPHY%LHUCN, LCOEFK_TOMS=>YDPHY%LCOEFK_TOMS, &
 & LVDIF=>YDPHY%LVDIF, LRRMES=>YDPHY%LRRMES, LCVRA=>YDPHY%LCVRA, LCVTDK=>YDPHY%LCVTDK, &
 & LPTKE=>YDPHY%LPTKE, LCOEFK_RIS=>YDPHY%LCOEFK_RIS, LAEROLAN=>YDPHY%LAEROLAN, &
 & LNEBECT=>YDPHY%LNEBECT, LCVPGY=>YDPHY%LCVPGY, LAERODES=>YDPHY%LAERODES, &
 & LNEWSTAT=>YDPHY%LNEWSTAT, LTHERMO=>YDPHY%LTHERMO, LO3FL=>YDPHY%LO3FL, &
 & LRRGUST=>YDPHY%LRRGUST, LPHSPSH=>YDPHY%LPHSPSH, LSNV=>YDPHY%LSNV, &
 & LECSHAL=>YDPHY%LECSHAL, LECT=>YDPHY%LECT, LSTRAPRO=>YDPHY%LSTRAPRO, &
 & LDIFCONS=>YDPHY%LDIFCONS, LNODIFQC=>YDPHY%LNODIFQC, &
 & LAEROVOL=>YDPHY%LAEROVOL, LRSTAER=>YDPHY%LRSTAER, LOZONE=>YDPHY%LOZONE, &
 & NCALLRAD=>YDPHY%NCALLRAD, LNCVPGY=>YDPHY%LNCVPGY, LRAYLU=>YDPHY%LRAYLU, &
 & LAEROSUL=>YDPHY%LAEROSUL, LO3ABC=>YDPHY%LO3ABC, LSTRAS=>YDPHY%LSTRAS, &
 & LCOEFK_PTTE=>YDPHY%LCOEFK_PTTE, LSFHYD=>YDPHY%LSFHYD, &
 & LAEROSEA=>YDPHY%LAEROSEA, NDIFFNEB=>YDPHY%NDIFFNEB, LEDKF=>YDPHY%LEDKF, &
 & LRCVOTT=>YDPHY%LRCVOTT, LNEBR=>YDPHY%LNEBR, LNEBN=>YDPHY%LNEBN, &
 & LMPHYS=>YDPHY%LMPHYS, NSORAYFR=>YDPHY%NSORAYFR, LZ0HSREL=>YDPHY%LZ0HSREL, &
 & LCAMOD=>YDPHY%LCAMOD, LCOMOD=>YDPHY%LCOMOD, LCONDWT=>YDPHY%LCONDWT, &
 & LCVCSD=>YDPHY%LCVCSD, LNSDO=>YDPHY%LNSDO, LUDEVOL=>YDPHY%LUDEVOL, &
 & LRAY=>YDPHY%LRAY, LGWD=>YDPHY%LGWD, LCOEFKTKE=>YDPHY%LCOEFKTKE, &
 & L3MT=>YDPHY%L3MT, LRAYFM=>YDPHY%LRAYFM, LECDEEP=>YDPHY%LECDEEP, &
 & LCVGQD=>YDPHY%LCVGQD, LGWDC=>YDPHY%LGWDC, LNORGWD=>YDPHY%LNORGWD, LFLUSO=>YDPHY%LFLUSO, &
 & LNEBCO=>YDPHY%LNEBCO, LNEBCV=>YDPHY%LNEBCV, LSOLV=>YDPHY%LSOLV, &
 & LCOEFKSURF=>YDPHY%LCOEFKSURF, LRNUEXP=>YDPHY%LRNUEXP, &
 & NRAY=>YDPHY%NRAY, LDAYD=>YDPHY%LDAYD, &
 & LEDMFI=>YDPHY%LEDMFI, LGPCMT=>YDPHY%LGPCMT, LFPCOR=>YDPHY%LFPCOR, &
 & LRPROX=>YDPHY%LRPROX, LPROCLD=>YDPHY%LPROCLD, &
 & LACDIFUS=>YDPHY%LACDIFUS, LCAPE=>YDPHY%LCAPE, LCVRAV3=>YDPHY%LCVRAV3, &
 & LHMTO=>YDPHY%LHMTO,  LVGSN=>YDPHY%LVGSN, &
 & LCVPPKF=>YDPHY%LCVPPKF, LCVPRO=>YDPHY%LCVPRO, LADJCLD=>YDPHY%LADJCLD, &
 & LGRAPRO=>YDPHY%LGRAPRO, RDECLI=>YDRIP%RDECLI, &
 & MVTS=>YDPARAR%MVTS, MALBSCA=>YDPARAR%MALBSCA, MVQS=>YDPARAR%MVQS, &
 & NGPAR=>YDPARAR%NGPAR, MRAIN=>YDPARAR%MRAIN, CMF_CLOUD=>YDPARAR%CMF_CLOUD, &
 & MALBDIR=>YDPARAR%MALBDIR, XSW_BANDS=>YDPARAR%XSW_BANDS, &
 & MVEMIS=>YDPARAR%MVEMIS, MGZ0H=>YDPARAR%MGZ0H, MGZ0=>YDPARAR%MGZ0, &
 & MCD=>YDPARAR%MCD, &
 & NSWB_MNH=>YDPARAR%NSWB_MNH, MSWDIR=>YDPARAR%MSWDIR, LMIXUV=>YDPARAR%LMIXUV, &
 & MSWDIF=>YDPARAR%MSWDIF, MSNOW=>YDPARAR%MSNOW, &
 & CMF_UPDRAFT=>YDPARAR%CMF_UPDRAFT, &
 & NTRADI=>YDTOPH%NTRADI, NTPLUI=>YDTOPH%NTPLUI, NTNEBU=>YDTOPH%NTNEBU, &
 & NTDIFU=>YDTOPH%NTDIFU, NTOZON=>YDTOPH%NTOZON, NTDRME=>YDTOPH%NTDRME, &
 & NTCVIM=>YDTOPH%NTCVIM, NTCOET=>YDTOPH%NTCOET, NTDRAG=>YDTOPH%NTDRAG, &
 & RMESOQ=>YDTOPH%RMESOQ, RMESOT=>YDTOPH%RMESOT, RMESOU=>YDTOPH%RMESOU, &
 & NTQSAT=>YDTOPH%NTQSAT, NTCOEF=>YDTOPH%NTCOEF, &
 & NAER=>YDERAD%NAER, NOZOCL=>YDERAD%NOZOCL, &
 & NRADFR=>YDERAD%NRADFR, NSW=>YDERAD%NSW, RCARDI=>YDERDI%RCARDI, &
 & RSUNDUR=>YDERDI%RSUNDUR, LXVISI=>YDXFU%LXVISI,&
 & LFLEXDIA=>YDLDDH%LFLEXDIA, LXVISI2=>YDXFU%LXVISI2,&
 & LDDH_OMP=>YDLDDH%LDDH_OMP, &
 & LMCC03=>YDMCC%LMCC03, &
 & LRCOEF=>YDRCOEF%LRCOEF, &
 & NSTOP=>YDRIP%NSTOP, &
 & RCODEC=>YDRIP%RCODEC, &
 & RHGMT=>YDRIP%RHGMT, &
 & RSIDEC=>YDRIP%RSIDEC, &
 & RSOVR=>YDRIP%RSOVR, &
 & RSTATI=>YDRIP%RSTATI, &
 & TSTEP=>YDRIP%TSTEP, &
 & LDPRECIPS=>YDPHY%LDPRECIPS,LDPRECIPS2=>YDPHY%LDPRECIPS2,&
 & NDTPREC=>YDPHY%YRDPRECIPS%NDTPREC,NDTPREC2=>YDPHY%YRDPRECIPS%NDTPREC2,&
 & NDTPRECCUR=>YDPHY%YRDPRECIPS%NDTPRECCUR,NDTPRECCUR2=>YDPHY%YRDPRECIPS%NDTPRECCUR2,&
 & STPRE=>YDSTA%STPRE,STPREH=>YDSTA%STPREH, STTEM=>YDSTA%STTEM, &
 & NORGWD_NNOVERDIF=>YDNORGWD%NORGWD_NNOVERDIF, &
 & LGCHECKMV=>YDPHY%LGCHECKMV, NAERO=>YGFL%NAERO, NGFL_EXT=>YGFL%NGFL_EXT, &
 & LCHEM_ARPCLIM=>YDMODEL%YRML_CHEM%YRCHEM%LCHEM_ARPCLIM,NCHEM=>YDMODEL%YRML_GCONF%YGFL%NCHEM, &
 & NACTAERO=>YGFL%NACTAERO, LXMRT=>YDXFU%LXMRT,RDELXN=>YDGEM%RDELXN,LFLASH =>YDCFU%LFLASH)
 CGMIXLEN=>YDMODEL%YRML_PHY_MF%YRPHY%CGMIXLEN
!
!-------------------------------------------------
! Check magnitude of model variables.
!-------------------------------------------------
!
IF(LGCHECKMV) CALL CHECKMV(YDRIP,YDPHY0,YDPHY2,KIDIA,KFDIA,KLON,KLEV,KSTEP,PAPHI,PAPHIF &
& ,PAPRS,PAPRSF,PGELAM,PGEMU,PMU0,YDMF_PHYS_SURF%GSD_VF%PLSM,PT,PQ,PTS)
!     ------------------------------------------------------------------

LLREDPR=LCVCSD
ZRVMD=RV-RD
! SURFEX  and passive scalar
IF (LDXFUMSE) THEN
  ZDTMSE=0.01_JPRB
  ZSTATI=REAL(RSTATI,JPRB)-ZDTMSE/2._JPRB
ELSE
  ZDTMSE=TSPHY
  ZSTATI=REAL(RSTATI,JPRB)
ENDIF
ZRHGMT=REAL(RHGMT,JPRB)
ZAIPCMT(:)=0._JPRB

ALLOCATE(ZSVM   (KLON,KLEV,NGFL_EXT))
ALLOCATE(ZSFSV  (KLON,NGFL_EXT))
ALLOCATE(ZPSV   (KLON,KLEV,NGFL_EXT))

!     ------------------------------------------------------------------
!     1.- INITIALISATIONS COMPLEMENTAIRES
!     -----------------------------------
IJN = KLON

!     CALCUL FIN DE IJN
!      IJN = 1
!      ZMU0 = MAX(0.,-SIGN(1.,-PMU0(KIDIA)))
!      DO 1  JLON = KIDIA+1, KFDIA
!      ZMUN = MAX(0.,-SIGN(1.,-PMU0(JLON)))
!      IJN = IJN + IABS(NINT(ZMUN)-NINT(ZMU0))
!      ZMU0 = ZMUN
!   1  CONTINUE

!*        1.0 DECORRELATION DEPTH FOR CLOUD OVERLAPS
IF ( RDECRD <= 0._JPRB .OR. LRNUEXP ) THEN
  DO JLON=KIDIA,KFDIA
    ZDECRD(JLON)=RDECRD1+RDECRD2* &
     & EXP(-((ASIN(PGEMU(JLON))-RDECRD3*RDECLI)/RDECRD4)**2)
  ENDDO
ENDIF
IF ( RDECRD <= 0._JPRB ) THEN 
  DO JLON=KIDIA,KFDIA
    ZDECRD_MF(JLON)=ZDECRD(JLON)
  ENDDO
ELSE
  DO JLON=KIDIA,KFDIA
    ZDECRD_MF(JLON)=RDECRD
  ENDDO
ENDIF

!*        1.1 INITIALISATION DE L'OZONE

IF (LMPHYS) THEN
  IF (LOZONE) THEN

    ! L'ozone est initialise par PO3 (ozone GFL).
    ! Ozone is computed from PO3 (GFL ozone).

    ZEPSO3=1.E-11_JPRB
    DO JLON=KIDIA,KFDIA
      ZQO3(JLON,0)=1.E-9_JPRB
    ENDDO
    DO JLEV=KTDIA,KLEV
      DO JLON=KIDIA,KFDIA
        ZQO3(JLON,JLEV) = MAX(ZEPSO3,PO3(JLON,JLEV))
      ENDDO
    ENDDO

  ELSEIF(KVCLIS == 1) THEN
    ZEPSO3=1.E-11_JPRB
    DO JLON=KIDIA,KFDIA
      ZQO3(JLON,0)=1.E-9_JPRB
    ENDDO
    DO JLEV=KTDIA,KLEV
      DO JLON=KIDIA,KFDIA
        ZQO3(JLON,JLEV) = PKOZO(JLON,JLEV,1)
      ENDDO
    ENDDO

  ELSEIF ((LO3FL).AND.(NOZOCL == 1).AND.(LRAYFM)) THEN
    IF (MOD(KSTEP,NRADFR) == 0) THEN
      CALL RADOZCMF(KIDIA,KFDIA,KLON,KLEV,PAPRS,PGEMU,ZROZ)
      DO JLON=KIDIA,KFDIA
        ZQO3(JLON,0)=1.E-9_JPRB
      ENDDO
      DO JLEV=KTDIA,KLEV
        DO JLON=KIDIA,KFDIA
          ZQO3(JLON,JLEV)=ZROZ(JLON,JLEV)*PRDELP(JLON,JLEV)
        ENDDO
      ENDDO
    ENDIF

  ELSE
    CALL SUOZON(KIDIA,KFDIA,KLON,KLEV,ZQO3,.FALSE.,PAPRS,PRDELP,LO3ABC,YDMF_PHYS_SURF%GSD_VC%PGROUP)
  ENDIF

!     GAZ CARBONIQUE.

  DO JLEV=KTDIA,KLEV
    DO JLON=KIDIA,KFDIA
      ZQCO2(JLON,JLEV)=QCO2
    ENDDO
  ENDDO


  ! INITIALISATION DE LA COORDONNEE ETA.
  ! INITIALISATION DE LA COORDONNEE ETA.

  ZVETAH(KTDIA-1)=STPREH(KTDIA-1)/VP00
  DO JLEV=KTDIA,KLEV
    ZVETAH(JLEV)=STPREH(JLEV)/VP00
    ZVETAF(JLEV)=STPRE (JLEV)/VP00
  ENDDO

!     EPAISSEUR STD AEROSOLS
  ZAEO = AERCS1*ZVETAH(KTDIA-1) + AERCS3*ZVETAH(KTDIA-1)**3&
   & + AERCS5*ZVETAH(KTDIA-1)**5
  DO JLEV = KTDIA, KLEV
    ZAEN = AERCS1*ZVETAH(JLEV) + AERCS3*ZVETAH(JLEV)**3&
     & + AERCS5*ZVETAH(JLEV)**5
    ZDAER(JLEV) = ZAEN - ZAEO
    ZAEO = ZAEN
  ENDDO

!     HUMIDITE CRITIQUE
  ZEPS=1.E-12_JPRB
  IF(LHUCN) THEN
    DO JLEV = KTDIA, KLEV
      ZHUC(JLEV)=1.0_JPRB-MAX( HUCOE*ZVETAF(JLEV)*(1.0_JPRB-ZVETAF(JLEV))/((&
      & 1.0_JPRB+HUTIL1*(ZVETAF(JLEV)-0.5_JPRB))*(&
      & 1.0_JPRB+HUTIL2*(ZVETAF(JLEV)-0.5_JPRB))),ZEPS)
    ENDDO
  ELSE
    DO JLEV = KTDIA, KLEV
      ZHUC(JLEV)=1.0_JPRB-MAX( HUCOE*ZVETAF(JLEV)**NPCLO1*(&
       & 1.0_JPRB-ZVETAF(JLEV))**NPCLO2*(&
       & 1.0_JPRB+SQRT(HUTIL)*(ZVETAF(JLEV)-0.5_JPRB)),ZEPS)
    ENDDO
  ENDIF

  IF ( LNEWSTAT ) THEN

    DO JLEV = KTDIA, KLEV-1
      ZMAN(JLEV) = FSM_CC * TANH(FSM_DD*ZVETAH(JLEV))
      ZMAK(JLEV) = FSM_EE * ZVETAH(JLEV)**FSM_FF +&
       & FSM_GG * (1-ZVETAH(JLEV))**FSM_HH + FSM_II
    ENDDO

!     MATHEMATICAL FILTER FOR THE EDGES

    IF ( LRPROX ) THEN
      DO JLEV = KTDIA, KTDIA+3
        ZMAK(JLEV) = ZMAK(JLEV) / 2**(KTDIA+4-JLEV)
      ENDDO
      DO JLEV = KLEV-4, KLEV-1
        ZMAK(JLEV) = ZMAK(JLEV) / 2**(5-KLEV+JLEV)
      ENDDO
    ENDIF

  ELSE
    DO JLEV = KTDIA, KLEV-1
      ZMAN(JLEV) = 0.3_JPRB*ZVETAH(JLEV)
      ZMAK(JLEV) = 0.1_JPRB
    ENDDO
  ENDIF   !LNEWSTAT

!3MT
!     INCREMENTAL CORRECTION FLUX FOR NEGAVTIVE HUMIDITY VALUES

  ZFCQVNG(:,:)=0.0_JPRB
  ZFCQING(:,:)=0.0_JPRB
  ZFCQLNG(:,:)=0.0_JPRB

  ZPRODTH_CVPP(:,:)=0.0_JPRB

  ZGDT=RG*TSPHY
  ZGDTI=1.0_JPRB/ZGDT

  DO JLEV=KTDIA,KLEV
    DO JLON=KIDIA,KFDIA

!     LAYER WEIGHTS

      ZPOID(JLON,JLEV)=PDELP(JLON,JLEV)*ZGDTI
      ZIPOI(JLON,JLEV)=PRDELP(JLON,JLEV)*ZGDT

!     CALCULATION OF LATENT HEATS

      ZLHV(JLON,JLEV)=FOLH(PT(JLON,JLEV),0.0_JPRB)
      ZLHS(JLON,JLEV)=FOLH(PT(JLON,JLEV),1.0_JPRB)

    ENDDO
  ENDDO

!    ------------------------------------------------------------------
!     PROGNOSTIC GEMS/MACC AEROSOLS - INITIAL COMPUTATIONS
!     IMPORTANT for IFS: Tracer order is : CO2 - other tracers - react Gases - Aerosol - extra GFL
!    ------------------------------------------------------------------

  ! Preliminary for prog. aerosol or extra gfl
  INBTRA=0
  IF (LMDUST.AND.(NGFL_EXT/=0)) INBTRA=NGFL_EXT
  IF (NAERO>0)                  INBTRA=NAERO           ! the two cases exclude each other
  ALLOCATE(ZSTRCTRA(KLON,0:KLEV,INBTRA)) ! to cover both prog aero and extra gfl cases
  ALLOCATE(ZTRA    (KLON,  KLEV,INBTRA))
  IF (INBTRA > 0) THEN
    ZSTRCTRA(:,:,:) = 0._JPRB
    ZTRA(:,:,:)     = 0._JPRB
  ENDIF 
  IF(INBTRA == 0) THEN
    INBTRA_DEP=0
  ELSE
    INBTRA_DEP=1
  ENDIF

!    ------------------------------------------------------------------
!      - CHANGEMENTS DE VARIABLES ET INVERSION DES NIVEAUX
!          POUR LE TRAITEMENT DES SCALAIRES PASSIFS
!     --------------------------------------------------------------------

  ZSFSV=0.0_JPRB    ! surf. flux of scalars
  IF (LMDUST.AND.(NGFL_EXT/=0)) THEN
!  SIZE OF ARRAY FOR MSE
  ILONMNH=KFDIA-KIDIA+1
  ZINVDT=1/PDT
  ZINVG=1/RG
  ZZI_APHI=PAPHI
  ZTM=PT
!SETUP
  ZZI_SVM=0.0_JPRB
  ZZI_PEZDIAG=0.0_JPRB
  ZZI_PABSM=101325._JPRB
  ZZI_RHODREFM=1.0_JPRB
  ZZI_RHO=1.0_JPRB
  ZZZ=0.0_JPRB
  ZAERD=0.0_JPRB

  DO JDIAG = 1, YDMODEL%YRML_GCONF%YGFL%NGFL_EZDIAG
    YDVARS%EZDIAG(JDIAG)%T0 = 0._JPRB
  ENDDO

!Initialisation des scalaires passifs pour aro_ground_param
  DO JGFL=1,NGFL_EXT
    DO JLEV=KTDIA,KLEV
      DO JLON=KIDIA,KFDIA
       ZSVM(JLON,JLEV,JGFL)=MAX(PSV(JLON,JLEV,JGFL),0.0_JPRB)
      ENDDO
    ENDDO
  ENDDO

  !initialisation de ZZZ
  DO JLEV = 1,KLEV
    DO JLON = KIDIA,KFDIA
      ZZZ(JLON,1,JLEV)=ZZI_APHI(JLON,JLEV)*ZINVG
    ENDDO
  ENDDO

  !initialisation de ZDZZ
  DO JLEV = 2, KLEV
    DO JLON = KIDIA,KFDIA
      ZDZZ(JLON,1,JLEV)=ZZZ(JLON,1,JLEV-1)-ZZZ(JLON,1,JLEV)
    ENDDO
  ENDDO
  DO JLON = KIDIA,KFDIA
      ZDZZ(JLON,1,1)=ZZI_APHI(JLON,0)*ZINVG-ZZZ(JLON,1,1)
  ENDDO


!Initialisation de ZZI_RHODREFM
  DO JLEV = 1 , KLEV
    DO JLON=KIDIA,KFDIA
      ZZI_RHODREFM(JLON,1,JLEV)=PAPRSF(JLON,JLEV)/&
       & (PT(JLON,JLEV)*PR(JLON,JLEV))
     ENDDO
  ENDDO

!Initialisation de ZZI_PABSM
  DO JLON = KIDIA,KFDIA
    DO JLEV = 1 , KLEV
      ZZI_PABSM(JLON,1,JLEV)=PAPRSF(JLON,JLEV)
    ENDDO
  ENDDO

!Initialisation de ZZI_EXNREFM
  ZRSCP=RD/RCPD
  ZINVATM=1/RATM
  DO JLEV = 1 , KLEV
    DO JLON = KIDIA,KFDIA
      ZZI_EXNREFM(JLON,1,JLEV)=(PAPRSF(JLON,JLEV)*ZINVATM)**(ZRSCP)
    ENDDO
  ENDDO

!Initialisation de ZZI_THM
  DO JLEV = 1 , KLEV
    DO JLON = KIDIA,KFDIA
      ZZI_THM(JLON,1,JLEV)=ZTM(JLON,JLEV)/ZZI_EXNREFM(JLON,1,JLEV)
    ENDDO
  ENDDO

!Initialisation des scalaires passifs pour aro_mnhdust (inversion des niveaux)
  DO JGFL=1,NGFL_EXT
    DO JLON=1,KLON
      DO JLEV=1,KLEV
        ZZI_SVM(JLON,1,JLEV,JGFL)=ZSVM(JLON,JLEV,JGFL)
      ENDDO
    ENDDO
  ENDDO

  ENDIF  ! ENDIF  (LMDUST & NGFL_EXT)
ENDIF  !LMPHYS
!**
!     ------------------------------------------------------------------
!     2.- MISES A ZERO DE SECURITE EN CAS DE NON-APPEL DES PARAMETRIS.
!     ------------------------------------------------------------------
ZEPS0=1.E-12_JPRB
ZEPSNEB=1.E-10_JPRB

! To profitize from the vectorization collapsing the (:,:) form is preferable.
! (Even better would be to completely avoid any useless initialization.)

! arrays dimensioned from 0:KLEV (half level quantities)
ZFPCOR  (:,:) = 0.0_JPRB
ZFHP    (:,:) = 0.0_JPRB
ZXTROV  (:,:) = 1.0_JPRB
ZXUROV  (:,:) = 1.0_JPRB
ZLMT    (:,:) = 0.0_JPRB
ZZLMT   (:,:) = 0.0_JPRB
ZLMU    (:,:) = 0.0_JPRB
ZLMU2   (:,:) = 0.0_JPRB
ZLMT2   (:,:) = 0.0_JPRB
ZKTROV  (:,:) = 0.0_JPRB
ZKQROV  (:,:) = 0.0_JPRB
ZKQLROV (:,:) = 0.0_JPRB
ZKUROV  (:,:) = 0.0_JPRB
ZFHEVPPC(:,:) = 0.0_JPRB
ZFHMLTSC(:,:) = 0.0_JPRB
ZFPEVPPC(:,:) = 0.0_JPRB
ZFCQL   (:,:) = 0.0_JPRB
ZFCQI   (:,:) = 0.0_JPRB
ZDIFCVPPQ (:,:) = 0.0_JPRB
ZDIFCVPPS (:,:) = 0.0_JPRB
ZDIFCVTH (:,:) = 0.0_JPRB
ZDIFCVPPU (:,:) = 0.0_JPRB
ZDIFCVPPV (:,:) = 0.0_JPRB
ZCONDCVPPL(:,:) = 0.0_JPRB
ZCONDCVPPI(:,:) = 0.0_JPRB
ZSEDIQL(:,:) = 0.0_JPRB
ZSEDIQI(:,:) = 0.0_JPRB

ZXURO   (:,:) = 0.0_JPRB
ZXQRO   (:,:) = 0.0_JPRB
ZXTRO   (:,:) = 0.0_JPRB

ZALPHA1 (:,:) = 0.0_JPRB
ZCOEFA  (:,:) = 0.0_JPRB
ZLVT    (:,:) = 0.0_JPRB
ZQICE   (:,:) = 0.0_JPRB

ZF_EPS (:,:) = 1.0_JPRB
ZFUN_TTE (:,:) = 1.0_JPRB
ZMRIPP (:,:) = 1.E-12_JPRB
ZMRIMC  (:,:) = 1.0_JPRB
ZMRICTERM (:,:) = 1.0_JPRB
ZRRCOR (:,:) = 1.0_JPRB
ZTAU_TKE (:,:) = 0.0_JPRB
ZTH_FUN (:,:) = 1.0_JPRB
ZMRIFPP (:,:) = 1.E-12_JPRB
ZMN2PP (:,:) = 1.E-12_JPRB
ZMN2_ES (:,:) = 1.0_JPRB
ZMN2_EQ (:,:) = 1.0_JPRB
ZMN2_DS (:,:) = 1.0_JPRB
ZMN2_DQ (:,:) = 1.0_JPRB
ZTSTAR (:,:) = 1.E-12_JPRB
ZTSTAR2 (:,:) = 1.E-12_JPRB
ZTSTARQ (:,:) = 1.E-12_JPRB
ZTSTAR2Q (:,:) = 1.E-12_JPRB
ZFMGST (:,:) = 1.0_JPRB
ZFMTKE (:,:) = 1.0_JPRB
ZFTTKE (:,:) = 1.0_JPRB
ZAUTKE (:,:) = 1.0_JPRB
ZATTKE (:,:) = 1.0_JPRB
ZTH_FUN(:,:) = 1.0_JPRB
ZWW_FUN(:,:) = 1.0_JPRB
ZBNEBCVPP(:,:) = 0.0_JPRB
ZBNEBQ(:,:)   = 0.0_JPRB
ZRHS(:,:)     = 0.0_JPRB
ZLML(:,:)     = 1.0_JPRB
ZLMLTILD(:,:) = 1.0_JPRB

ZDIFWQ  (:) = 0.0_JPRB
ZDIFWS  (:) = 0.0_JPRB
ZSC_FEVI(:) = 1.0_JPRB     
ZSC_FEVN(:) = 1.0_JPRB     
ZSC_FCLL(:) = 1.0_JPRB     
ZSC_FCLN(:) = 1.0_JPRB
ZCDNH(:)    = 1.0_JPRB

! arrays dimensioned from 1:KLEV (full level quantities)
ZTENT   (:,:) = 0.0_JPRB
ZNEBS   (:,:) = ZEPS0
ZNEBC   (:,:) = ZEPS0
ZNEBS0  (:,:) = ZEPS0
ZNEBC0  (:,:) = ZEPS0
ZNEBCH  (:,:) = 0.0_JPRB
ZUNEBH  (:,:) = 0.0_JPRB
ZDETFI (:,:) = 0.0_JPRB
ZNEBDIFF(:,:) = 0.0_JPRB
ZQLIS   (:,:) = 0.0_JPRB
ZQLIS0  (:,:) = 0.0_JPRB
ZCFATH  (:,:) = 0.0_JPRB
ZCFAU   (:,:) = 0.0_JPRB
ZCFBTH  (:,:) = 0.0_JPRB
ZCFBU   (:,:) = 0.0_JPRB
ZCFBV   (:,:) = 0.0_JPRB
ZQLIC   (:,:) = 0.0_JPRB
INLAB   (:,:) = 0
INLAB_CVPP(:,:) = 0
ICIS    (:,:) = 1
ZQLI_CVPP(:,:) = 0.0_JPRB
ZNEB_CVPP(:,:) = ZEPS0

ZEDMFQ  (:,:)  = 0.0_JPRB
ZEDMFS  (:,:)  = 0.0_JPRB
ZEDMFU  (:,:)  = 0.0_JPRB
ZEDMFV  (:,:)  = 0.0_JPRB
ZMF_UP  (:,: ) = 0.0_JPRB
ZQLI_CVP(:,:) = 0.0_JPRB
ZQC_DET_PCMT(:,:) = 0.0_JPRB
ZTENHA(:,:)   = 0.0_JPRB
ZTENQVA(:,:)  = 0.0_JPRB
ZRHDFDA(:,:)  = 0.0_JPRB
ZQIC   (:,:)  = 0.0_JPRB
ZQLC   (:,:)  = 0.0_JPRB
ZQRC   (:,:)  = 0.0_JPRB
ZQSC   (:,:)  = 0.0_JPRB
ZQG    (:,:)  = 0.0_JPRB

!  ---------------------------------------------------------------------
!  Correction of negative advected humidity and precipitation values
!  ---------------------------------------------------------------------

IF (LCONDWT) THEN
  IF (L3MT .OR. LSTRAPRO .OR. LPROCLD) THEN
    IF (LGRAPRO) THEN
!cdir unroll=8
      DO JLEV = 1, KLEV
        DO JLON = KIDIA,KFDIA
          ZQI(JLON,JLEV)=MAX(0.0_JPRB,PQI(JLON,JLEV))
          ZQL(JLON,JLEV)=MAX(0.0_JPRB,PQL(JLON,JLEV))
          ZQR(JLON,JLEV)=MAX(0.0_JPRB,PQRRES(JLON,JLEV))
          ZQS(JLON,JLEV)=MAX(0.0_JPRB,PQSRES(JLON,JLEV))
          ZQG(JLON,JLEV)=MAX(0.0_JPRB,PG(JLON,JLEV))
  ! CORRECTION OF NEGATIVE ADVECTED VALUES:
  !                         VAPOUR PUT IN PFCQVNG
  !                         LIQUID,ICE PUT IN PFCQL/ING
  !                         FOR RAIN/SNOW/GRAUPEL PUT IN PFCQR/S/GNG

          ZDQI=ZQI(JLON,JLEV)-PQI(JLON,JLEV)
          ZDQL=ZQL(JLON,JLEV)-PQL(JLON,JLEV)
          ZDQR=ZQR(JLON,JLEV)-PQRRES(JLON,JLEV)
          ZDQS=ZQS(JLON,JLEV)-PQSRES(JLON,JLEV)
          ZDQG=ZQG(JLON,JLEV)-PG(JLON,JLEV)
          ZDQC=ZDQI+ZDQL+ZDQR+ZDQS+ZDQG

          ZQV0=PQ(JLON,JLEV)-ZIPOI(JLON,JLEV)*(0.0_JPRB- PFCQVNG(JLON,JLEV-1) &
          & -PFCQING(JLON,JLEV-1)-PFCQLNG(JLON,JLEV-1)-PFCQRNG(JLON,JLEV-1) &
          & -PFCQSNG(JLON,JLEV-1)-PFCQGNG(JLON,JLEV-1))
          ZQV(JLON,JLEV)=MAX(0.0_JPRB,ZQV0-ZDQC)
          ZDQV=MAX(0.0_JPRB,ZQV0-ZDQC)-PQ(JLON,JLEV)

          PFCQVNG(JLON,JLEV)=PFCQVNG(JLON,JLEV-1)-ZDQV*ZPOID(JLON,JLEV)
          PFCQING(JLON,JLEV)=PFCQING(JLON,JLEV-1)-ZDQI*ZPOID(JLON,JLEV)
          PFCQLNG(JLON,JLEV)=PFCQLNG(JLON,JLEV-1)-ZDQL*ZPOID(JLON,JLEV)
          PFCQRNG(JLON,JLEV)=PFCQRNG(JLON,JLEV-1)-ZDQR*ZPOID(JLON,JLEV)
          PFCQSNG(JLON,JLEV)=PFCQSNG(JLON,JLEV-1)-ZDQS*ZPOID(JLON,JLEV)
          PFCQGNG(JLON,JLEV)=PFCQGNG(JLON,JLEV-1)-ZDQG*ZPOID(JLON,JLEV)
        ENDDO
      ENDDO
    ELSE
      DO JLEV = 1, KLEV
        DO JLON = KIDIA,KFDIA
          ZQI(JLON,JLEV)=MAX(0.0_JPRB,PQI(JLON,JLEV))
          ZQL(JLON,JLEV)=MAX(0.0_JPRB,PQL(JLON,JLEV))
          ZQR(JLON,JLEV)=MAX(0.0_JPRB,PQRRES(JLON,JLEV))
          ZQS(JLON,JLEV)=MAX(0.0_JPRB,PQSRES(JLON,JLEV))

    ! CORRECTION OF NEGATIVE ADVECTED VALUES:
    !                         VAPOUR PUT IN PFCQVNG
    !                         LIQUID,ICE PUT IN PFCQL/ING
    !                         FOR RAIN/SNOW PUT IN PFCQR/SNG

          ZDQI=ZQI(JLON,JLEV)-PQI(JLON,JLEV)
          ZDQL=ZQL(JLON,JLEV)-PQL(JLON,JLEV)
          ZDQR=ZQR(JLON,JLEV)-PQRRES(JLON,JLEV)
          ZDQS=ZQS(JLON,JLEV)-PQSRES(JLON,JLEV)
          ZDQC=ZDQI+ZDQL+ZDQR+ZDQS

          ZQV0=PQ(JLON,JLEV)-ZIPOI(JLON,JLEV)*(0.0_JPRB- PFCQVNG(JLON,JLEV-1)&
          & -PFCQING(JLON,JLEV-1)-PFCQLNG(JLON,JLEV-1)-PFCQRNG(JLON,JLEV-1)&
          & -PFCQSNG(JLON,JLEV-1))
          ZQV(JLON,JLEV)=MAX(0.0_JPRB,ZQV0-ZDQC)
          ZDQV=MAX(0.0_JPRB,ZQV0-ZDQC)-PQ(JLON,JLEV)

          PFCQVNG(JLON,JLEV)=PFCQVNG(JLON,JLEV-1)-ZDQV*ZPOID(JLON,JLEV)
          PFCQING(JLON,JLEV)=PFCQING(JLON,JLEV-1)-ZDQI*ZPOID(JLON,JLEV)
          PFCQLNG(JLON,JLEV)=PFCQLNG(JLON,JLEV-1)-ZDQL*ZPOID(JLON,JLEV)
          PFCQRNG(JLON,JLEV)=PFCQRNG(JLON,JLEV-1)-ZDQR*ZPOID(JLON,JLEV)
          PFCQSNG(JLON,JLEV)=PFCQSNG(JLON,JLEV-1)-ZDQS*ZPOID(JLON,JLEV)
        ENDDO
      ENDDO
    ENDIF

    IF (LGPCMT) THEN
      DO JLEV = 1, KLEV
        DO JLON = KIDIA,KFDIA
          ZTZER=MAX(0.0_JPRB,-SIGN(1.0_JPRB,-(YDVARS%ICONV%T0(JLON,JLEV)-ZEPS0)+0.0_JPRB))
          ZQIC(JLON,JLEV)=ZTZER*YDVARS%ICONV%T0(JLON,JLEV)
          ZDQI=ZQIC(JLON,JLEV)-YDVARS%ICONV%T0(JLON,JLEV)

          ZTZER=MAX(0.0_JPRB,-SIGN(1.0_JPRB,-(YDVARS%LCONV%T0(JLON,JLEV)-ZEPS0)+0.0_JPRB))
          ZQLC(JLON,JLEV)=ZTZER*YDVARS%LCONV%T0(JLON,JLEV)
          ZDQL=ZQLC(JLON,JLEV)-YDVARS%LCONV%T0(JLON,JLEV)

          ZTZER=MAX(0.0_JPRB,-SIGN(1.0_JPRB,-(YDVARS%RCONV%T0(JLON,JLEV)-ZEPS0)+0.0_JPRB))
          ZQRC(JLON,JLEV)=ZTZER*YDVARS%RCONV%T0(JLON,JLEV)
          ZDQR=ZQRC(JLON,JLEV)-YDVARS%RCONV%T0(JLON,JLEV)

          ZTZER=MAX(0.0_JPRB,-SIGN(1.0_JPRB,-(YDVARS%SCONV%T0(JLON,JLEV)-ZEPS0)+0.0_JPRB))
          ZQSC(JLON,JLEV)=ZTZER*YDVARS%SCONV%T0(JLON,JLEV)
          ZDQS=ZQSC(JLON,JLEV)-YDVARS%SCONV%T0(JLON,JLEV)

          ZDQC=ZDQI+ZDQL+ZDQR+ZDQS

          ZQV0=ZQV(JLON,JLEV)-ZIPOI(JLON,JLEV)*(0.0_JPRB-ZFCQVNG(JLON,JLEV-1)&
          & -PFCNEGQIC(JLON,JLEV-1)-PFCNEGQLC(JLON,JLEV-1)&
          & -PFCNEGQRC(JLON,JLEV-1)-PFCNEGQSC(JLON,JLEV-1))
          ZQVI=MAX(0.0_JPRB,ZQV0-ZDQC)
          ZDQV=ZQVI-ZQV(JLON,JLEV)
          ZQV(JLON,JLEV)=ZQVI

          ZFCQVNG(JLON,JLEV)=ZFCQVNG(JLON,JLEV-1)-ZDQV*ZPOID(JLON,JLEV)
          PFCQVNG(JLON,JLEV)=PFCQVNG(JLON,JLEV)+ZFCQVNG(JLON,JLEV)
          PFCNEGQIC(JLON,JLEV)=PFCNEGQIC(JLON,JLEV-1)-ZDQI*ZPOID(JLON,JLEV)
          PFCNEGQLC(JLON,JLEV)=PFCNEGQLC(JLON,JLEV-1)-ZDQL*ZPOID(JLON,JLEV)
          PFCNEGQRC(JLON,JLEV)=PFCNEGQRC(JLON,JLEV-1)-ZDQR*ZPOID(JLON,JLEV)
          PFCNEGQSC(JLON,JLEV)=PFCNEGQSC(JLON,JLEV-1)-ZDQS*ZPOID(JLON,JLEV)
        ENDDO
      ENDDO
      ZFCQVNG(:,:)=0.0_JPRB
    ENDIF
  ELSE
    DO JLEV = 1, KLEV
      DO JLON = KIDIA,KFDIA
        ZQI(JLON,JLEV)=PQI(JLON,JLEV)
        ZQL(JLON,JLEV)=PQL(JLON,JLEV)
        ZQR(JLON,JLEV)=PQRRES(JLON,JLEV)
        ZQS(JLON,JLEV)=PQSRES(JLON,JLEV)
        IF (LGRAPRO) THEN
          ZQG(JLON,JLEV)=PG(JLON,JLEV)
        ENDIF
        ZQV(JLON,JLEV)=PQ(JLON,JLEV)
      ENDDO
    ENDDO
  ENDIF
ELSE
  DO JLEV = 1, KLEV
    DO JLON = KIDIA,KFDIA
      ZQI(JLON,JLEV)=0.0_JPRB
      ZQL(JLON,JLEV)=0.0_JPRB
      ZQV(JLON,JLEV)=PQ(JLON,JLEV)
    ENDDO
  ENDDO
ENDIF ! LCONDWT

DO JCHA = 1, 6
  DO JLEV = KTDIA, KLEV
    DO JLON = 1, KLON
      ZAER(JLON,JLEV,JCHA)=0.0_JPRB
    ENDDO
  ENDDO
ENDDO

DO JLEV = KTDIA, KLEV
  DO JLON = 1, KLON
    ZAERINDS(JLON,JLEV)=0.0_JPRB
  ENDDO
ENDDO

DO JLON = KIDIA,KFDIA
  ZCEMTR  (JLON,0) = 0.0_JPRB
  ZCEMTR  (JLON,1) = 0.0_JPRB
  ZCTRSO  (JLON,0) = 0.0_JPRB
  ZCTRSO  (JLON,1) = 0.0_JPRB
  ZTRSOD  (JLON)   = 0.0_JPRB
  ZSUDU   (JLON)   = 0.0_JPRB
  ZXDROV  (JLON)   = 1.0_JPRB
  ZXHROV  (JLON)   = 1.0_JPRB
  ZTAUX   (JLON)   = ZEPS0
  KCLPH   (JLON)   = KLEV
ENDDO
DO JSG = 1, NSW
  DO JLON = KIDIA,KFDIA
    ZALBD   (JLON,JSG) = 0.0_JPRB
    ZALBP   (JLON,JSG) = 0.0_JPRB
    ZSFSWDIF(JLON,JSG) = 0.0_JPRB
    ZSFSWDIR(JLON,JSG) = 0.0_JPRB
    ZTRSODIF(JLON,JSG) = 0.0_JPRB
    ZTRSODIR(JLON,JSG) = 0.0_JPRB
  ENDDO
ENDDO

!  -------------------------------------------------------
!  Security values for pseudo-historical arrays at KSTEP=0
!  -------------------------------------------------------

IF((LNEBR.OR.(TRIM(CGMIXLEN) == 'TM')&
       & .OR.(TRIM(CGMIXLEN) == 'TMC')).AND.KSTEP == 0) THEN
!DEC$ IVDEP
  DO JLON=KIDIA,KFDIA
    YDMF_PHYS_SURF%GSD_VH%PPBLH(JLON)=(XMINLM+XMAXLM)*0.5_JPRB
  ENDDO
ENDIF
IF((LNEBCO.OR.LGWDC).AND.KSTEP == 0) THEN
  DO JLON=KIDIA,KFDIA
    YDMF_PHYS_SURF%GSD_VH%PTCCH(JLON)=0.0_JPRB
    YDMF_PHYS_SURF%GSD_VH%PSCCH(JLON)=0.0_JPRB
    YDMF_PHYS_SURF%GSD_VH%PBCCH(JLON)=0.0_JPRB
  ENDDO
ENDIF

IF((LNEBN.OR.LNEBR.OR.LRRGUST).AND.KSTEP == 0) THEN
  DO JLEV=KTDIA-1,KLEV
    DO JLON=KIDIA,KFDIA
      PFPLCH(JLON,JLEV)=0.0_JPRB
    ENDDO
  ENDDO
ENDIF
IF(LRRGUST.AND.KSTEP == 0) THEN
  DO JLEV=KTDIA-1,KLEV
    DO JLON=KIDIA,KFDIA
      PFPLSH(JLON,JLEV)=0.0_JPRB
    ENDDO
  ENDDO
ENDIF
IF(LCVPGY.AND.KSTEP == 0) THEN
  DO JLEV=KTDIA,KLEV
    DO JLON=KIDIA,KFDIA
      PCVV(JLON,JLEV)=0.0_JPRB
    ENDDO
  ENDDO
ENDIF
IF(LPHSPSH.AND.KSTEP == 0) THEN
  YDMF_PHYS_SURF%GSD_VH%PSPSH(KIDIA:KFDIA)=0._JPRB
ENDIF
IF(LCOEFKTKE.AND.KSTEP == 0) THEN
  YDMF_PHYS_SURF%GSD_VH%PQSH(KIDIA:KFDIA)=PQ(KIDIA:KFDIA,KLEV)
ENDIF
IF(LCVCSD.AND.LUDEVOL.AND.KSTEP==0) THEN
  YDMF_PHYS_SURF%GSD_VK%PUDGRO(KIDIA:KFDIA)=0._JPRB
ENDIF
IF(LRKCDEV.AND.KSTEP == 0) THEN
  DO JLEV=KTDIA,KLEV
     DO JLON=KIDIA,KFDIA
        ZDTRAD(JLON,JLEV)=0.0_JPRB
        ZRKTTEND(JLON,JLEV)=0.0_JPRB
        ZRKQVTEND(JLON,JLEV)=0.0_JPRB
        ZRKQCTEND(JLON,JLEV)=0.0_JPRB
        ZDQVDIFF(JLON,JLEV)=0.0_JPRB
        YDVARS%RKTH%T0(JLON,JLEV) = 0.0_JPRB
        YDVARS%RKTQV%T0(JLON,JLEV)= 0.0_JPRB
        YDVARS%RKTQC%T0(JLON,JLEV)= 0.0_JPRB
     ENDDO
  ENDDO
ENDIF
IF (L3MT) THEN
  IF (LCVPRO) THEN
    YDVARS%UNEBH%T0(KIDIA:KFDIA,:)=MAX(0._JPRB,YDVARS%UNEBH%T0(KIDIA:KFDIA,:))
    ZUNEBH(:,:)=MIN(1.0_JPRB-ZEPS0,YDVARS%UNEBH%T0(:,:)+MAX(0._JPRB,YDVARS%UAL%T0(:,:)))
  ELSE
    ZUNEBH(:,:)=YDVARS%UNEBH%T0(:,:)
  ENDIF
ENDIF

!     ------------------------------------------------------------------
!  The LMPHYS and LEPHYS keys should in the following be
! dispached to individual parametrizations.
IF(LMPHYS) THEN
!*
!     ------------------------------------------------------------------
!     4.- CALCULS THERMODYNAMIQUES
!     ----------------------------
  IF ( LTHERMO ) THEN
    CALL ACTQSAT ( YDPHY,KIDIA,KFDIA,KLON,NTQSAT,KLEV,&
     & PAPRSF, PCP, ZQV, PT,&
     & ZGEOSLC, PLH, PLSCPE, PQSAT, PQW, PRH, PTW)
  ENDIF

!*
!     ------------------------------------------------------------------
!     4.BIS. COEFFICIENTS THERMO-HYDRIQUES DU SOL
!     -------------------------------------------

  IF (LSFORCS) THEN  ! Surface forcing for 1D model MUSC
     DO JLON=KIDIA,KFDIA
        ZTSN(JLON)=PTS(JLON)
        ZTN(JLON) =PT(JLON,KLEV)
     ENDDO
     DO JLON=KIDIA,KFDIA
        ZRHODREFM(JLON) = PAPRSF(JLON,KLEV)/(PT(JLON,KLEV)*PR(JLON,KLEV))
        ZTHETAS(JLON)   = ZTSN(JLON)*(RATM/PAPRS(JLON,KLEV))**RKAPPA
     ENDDO
     LLAROME = .FALSE.
     CALL SURF_IDEAL_FLUX(YDRIP,YDPHY0,YDPHYDS,LLAROME,KIDIA,KFDIA,KLON,PAPHIF(:,KLEV),ZRHODREFM,YDMF_PHYS_SURF%GSD_SFO%PGROUP,&
        & ZTN,ZTSN,YDMF_PHYS_SURF%GSD_VF%PLSM,PQ(:,KLEV),PU(:,KLEV),PV(:,KLEV),ZTHETAS,PFCS(KIDIA:KFDIA,1),ZFEV,ZFMDU,ZFMDV)
     DO JLON=KIDIA,KFDIA
        PTS(JLON)=ZTSN(JLON)
     ENDDO
     DO JLON=KIDIA,KFDIA
        ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-PTS(JLON)))
        ! To be equivalent to surfex forcing
        PFEVL(JLON,1)=ZFEV(JLON)*(1.0_JPRB-ZDELTA)
        PFEVN(JLON,1)=ZFEV(JLON)*ZDELTA
        PFCLL(JLON,1)=PFEVL(JLON,1)*PLH(JLON,KLEV)
        PFCLN(JLON,1)=PFEVN(JLON,1)*PLH(JLON,KLEV)
        PLHS(JLON)=FOLH(PTS(JLON),0.0_JPRB)
     ENDDO
  ENDIF  ! End of surface forcing for 1D model MUSC

  IF ( .NOT.LMSE ) THEN
    IF ( LSOLV ) THEN
      LLHMT=.FALSE.
      CALL ACSOL ( YDPHY,YDPHY1,KIDIA,KFDIA,KLON,&
       & YDMF_PHYS_SURF%GSD_VV%PARG,YDMF_PHYS_SURF%GSD_VV%PD2,YDMF_PHYS_SURF%GSD_VF%PZ0F,YDMF_PHYS_SURF%GSD_VV%PZ0H,YDMF_PHYS_SURF%GSD_VF%PZ0RLF,YDMF_PHYS_SURF%GSD_VF%PLSM,YDMF_PHYS_SURF%GSD_VV%PIVEG,YDMF_PHYS_SURF%GSD_VV%PLAI,PALBNS,&
       & PRHONS,YDMF_PHYS_SURF%GSD_VV%PSAB,PSNS,PTS,YDMF_PHYS_SURF%GSD_VF%PVEG,PWP,PWPI,PWS,PWSI,&
       & LLHMT,&
       & PC1,PC2,ZC3,ZCG,ZCN,PCT,ZNEIJG,ZNEIJV,&
       & ZWFC,ZWPMX,ZWSEQ,ZWSMX,ZWWILT)
    ELSE

!            INITIALISATION DE L'INERTIE THERMIQUE DU SOL.

!DEC$ IVDEP
      DO JLON = KIDIA,KFDIA
        PCT(JLON)=HSOL /(&
         & 1.0_JPRB+HSOLIWR*(PWS(JLON)+PWP(JLON))/(WSMX+WPMX)&
         & *EXP(-0.5_JPRB*(HSOLIT0*(PTS(JLON)-RTT))**2))
      ENDDO
    ENDIF
  ENDIF

!*
!     ------------------------------------------------------------------
!     4.TER.- INITIALISATIONS LIEES AU SCHEMA DE SURFACE EXTERNALISE
!     ------------------------------------------------------------------

  IF (LMSE) THEN

!     INITIALISATION DU SCHEMA DE SURFACE EXTERNALISE ET DES
!     VARIABLES PSEUDO-HISTORIQUES ASSOCIEES

    IF ( (NSWB_MNH /= NSW) .AND. LRAYFM ) CALL ABOR1('APLPAR: NSWB_MNH not = NSW')

    DO JLON=KIDIA,KFDIA
      PGZ0     (JLON) = PGPAR(JLON,MGZ0)
      PGZ0H    (JLON) = PGPAR(JLON,MGZ0H)
      PEMIS    (JLON) = PGPAR(JLON,MVEMIS)
      PQS      (JLON) = PGPAR(JLON,MVQS)
      PTS      (JLON) = PGPAR(JLON,MVTS)
      ZSRAIN   (JLON) = PGPAR(JLON,MRAIN)
      ZSSNOW   (JLON) = PGPAR(JLON,MSNOW)
      ZSGROUPEL(JLON) = 0._JPRB
      ZTSN     (JLON) = PTS(JLON)
    ENDDO

    IF ( LRAY ) THEN
      ! ACRANEB/ACRANEB2 radiation => one solar band
      DO JLON=KIDIA,KFDIA
        PALB   (JLON) = PGPAR(JLON,MALBSCA)
        ZALBDIR(JLON) = PGPAR(JLON,MALBDIR)
      ENDDO
    ELSE
      ! FMR  radiation => NSW solar bands
      DO JSG=1,NSW
        DO JLON=KIDIA,KFDIA
          ZALBP(JLON,JSG) = PGPAR(JLON,MALBDIR-1+JSG)
          ZALBD(JLON,JSG) = PGPAR(JLON,MALBSCA-1+JSG)
        ENDDO
      ENDDO
      DO JLON=KIDIA,KFDIA
        PALB(JLON)=0.0_JPRB
      ENDDO
      DO JSG=1,NSW
        DO JLON=KIDIA,KFDIA
          PALB(JLON)=PALB(JLON)+0.5*(ZALBP(JLON,JSG)+ZALBD(JLON,JSG))
        ENDDO
      ENDDO
      DO JLON=KIDIA,KFDIA
        PALB(JLON)=PALB(JLON)/REAL(NSW,JPRB)
      ENDDO
    ENDIF

    DO JLON=KIDIA,KFDIA
      IF (PEMIS(JLON)==0._JPRB) THEN
        PEMIS(JLON) = 0.99_JPRB
        PTS  (JLON) = 288.0_JPRB
        PALB (JLON) = 0.1_JPRB
      ENDIF
    ENDDO

  ENDIF  ! LMSE
!
! Define z0;z0h if it's necessary
!
  IF (LMSE.AND.(.NOT.LCOEFKTKE).AND.(.NOT.LCOEFK_TOMS).AND.KSTEP == 0) THEN
  CALL ARO_GROUND_DIAG_Z0( KBL, KGPCOMP,&
          & KFDIA-KIDIA+1, KIDIA, KFDIA,&
          & NDGUNG, NDGUXG, NDLUNG, NDLUXG,&
          & PINDX(KIDIA:KFDIA), PINDY(KIDIA:KFDIA),&
          & LSURFEX_KFROM,&
          & PGZ0(KIDIA:KFDIA), PGZ0H(KIDIA:KFDIA))
  ENDIF
!*
!     ------------------------------------------------------------------
!     5.- STRUCTURE ET CHAMPS DANS LA COUCHE LIMITE DE SURFACE
!     ------------------------------------------------------------------

!        INITIALISATION DES HAUTEURS "METEO".

  IF ( LHMTO ) THEN
    DO JLON=KIDIA,KFDIA
      ZDPHIV(JLON)=RG*HVCLS
      ZDPHIT(JLON)=RG*HTCLS
    ENDDO
  ENDIF

  IF ( LVDIF.OR.LHMTO.OR.LGWD ) THEN
    LLCLS=LGWD.OR.LVDIF
    LLHMT=LHMTO
    IF (LMSE) THEN
      IF(LCOEFKTKE.AND.LCOEFKSURF) THEN

       IF (KSTEP == 0) THEN 
         CALL ARO_GROUND_DIAG_Z0( KBL, KGPCOMP, &
          & KFDIA-KIDIA+1, KIDIA, KFDIA, &
          & NDGUNG, NDGUXG, NDLUNG, NDLUXG, &
          & PINDX(KIDIA:KFDIA), PINDY(KIDIA:KFDIA), &
          & LSURFEX_KFROM, &
          & PGZ0(KIDIA:KFDIA), PGZ0H(KIDIA:KFDIA))
        ENDIF


        CALL ACTKEZOTLS ( YDPHY0,KIDIA,KFDIA,KLON,KLEV,&
         & PAPHI, PAPHIF, PR, PT,&
         & PGZ0, PGZ0H, PTS, PQS,&
         & PCDN, ZCDNH, PCPS, ZRTI, PRS)
         
      ELSE
        CALL ACHMTLS ( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,KLEV,&
          & PAPHI,PAPHIF,PAPRS,PAPRSF,PR,PT,PU,PV,&
          & PTS,PQS,ZDPHIT,PGZ0,PGZ0H,LLCLS,&
          & ZNBVNO,ZMRIPP,PCPS,ZGWDCS,PLHS,ZPCLS,PCD,PCDN)
!       Computation of ZRTI
        DO JLON=KIDIA,KFDIA
          ZDPHI(JLON)=PAPHIF(JLON,KLEV)-PAPHI(JLON,KLEV)
          ZPRS(JLON)=RD+ZRVMD*PQS(JLON)
          ZRTI(JLON)=2.0_JPRB/(PR(JLON,KLEV)*PT(JLON,KLEV)+RKAPPA*ZDPHI(JLON)&
           & +ZPRS(JLON)*PTS(JLON))
        ENDDO
      ENDIF
    ELSE
      IF (LCOEFKSURF) THEN
        CALL ACTKEHMT ( KIDIA,KFDIA,KLON,KLEV,KVCLIV>=8.AND.LSOLV,&
         & PAPHI, PAPHIF, PAPRS, PAPRSF, PCP, ZQV, PR, PT, PU, PV,&
         & PFPLSH,PFPLCH,&
         & ZDPHIT, ZDPHIV, YDMF_PHYS_SURF%GSD_VF%PZ0F, YDMF_PHYS_SURF%GSD_VV%PZ0H, YDMF_PHYS_SURF%GSD_VF%PZ0RLF, YDMF_PHYS_SURF%GSD_VV%PHV, YDMF_PHYS_SURF%GSD_VF%PLSM,&
         & ZNEIJG, ZNEIJV, PSNS, PTS, YDMF_PHYS_SURF%GSD_VF%PVEG, ZWFC, PWS, PWSI,&
         & LLCLS, LLHMT,&
         & ZNBVNO,ZMRIPP,&
         & PCD, PCDN, ZCDROV, PCH, ZCHROV, PCPS, ZDQSTS, ZGWDCS,&
         & PGZ0, PGZ0H, ZHQ, ZHU, PNEIJ, PQCLS, PQS, PQSATS, PRHCLS,&
         & PRS, ZRTI, ZSTAB, PTCLS, PUCLS, PVCLS, PNUCLS, PNVCLS, ZPCLS, PVEG,&
         & ZXDROV, ZXHROV,PUGST,PVGST)
      ELSE
        CALL ACHMT ( KIDIA,KFDIA,KLON,KLEV,KVCLIV>=8.AND.LSOLV,&
         & PAPHI, PAPHIF, PAPRS, PAPRSF, PCP, ZQV, PR, PT, PU, PV,&
         & PFPLSH,PFPLCH,&
         & ZDPHIT, ZDPHIV, YDMF_PHYS_SURF%GSD_VF%PZ0F, YDMF_PHYS_SURF%GSD_VV%PZ0H, YDMF_PHYS_SURF%GSD_VF%PZ0RLF, YDMF_PHYS_SURF%GSD_VV%PHV, YDMF_PHYS_SURF%GSD_VF%PLSM,&
         & ZNEIJG, ZNEIJV, PSNS, PTS, YDMF_PHYS_SURF%GSD_VF%PVEG, ZWFC, PWS, PWSI,&
         & LLCLS, LLHMT,&
         & ZNBVNO,ZMRIPP,&
         & PCD, PCDN, ZCDROV, PCH, ZCHROV, PCPS, ZDQSTS, ZGWDCS,&
         & PGZ0, PGZ0H, ZHQ, ZHU, PNEIJ, PQCLS, PQS, PQSATS, PRHCLS,&
         & PRS, ZRTI, ZSTAB, PTCLS, PUCLS, PVCLS, PNUCLS, PNVCLS, ZPCLS, PVEG,&
         & ZXDROV, ZXHROV,PUGST,PVGST)
      ENDIF
    ENDIF

    IF (LPTKE) THEN
      PTKE(KIDIA:KFDIA,1:KLEV) = MAX(PTKE(KIDIA:KFDIA,1:KLEV),ETKE_MIN)
    ENDIF
    IF (LCOEFK_PTTE) THEN
      YDVARS%TTE%T0(KIDIA:KFDIA,1:KLEV) = MAX(YDVARS%TTE%T0(KIDIA:KFDIA,1:KLEV),ETKE_MIN)
    ENDIF

    IF(LCOEFKTKE) THEN
      ZCP(KIDIA:KFDIA,1:KLEV) = RCPD*(1.0_JPRB+(RCPV/RCPD-1.0_JPRB)*(&
        & ZQV(KIDIA:KFDIA,1:KLEV)+ZQI(KIDIA:KFDIA,1:KLEV)+&
        & ZQL(KIDIA:KFDIA,1:KLEV)))
    ELSE
      ZCP(KIDIA:KFDIA,1:KLEV) = PCP(KIDIA:KFDIA,1:KLEV)
    ENDIF

    IF(LCOEFK_RIS .AND. LCOEFKTKE) THEN
      !  computation of Ri*,Ri** for mixing lenth computation
      CALL ACMRISS ( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTCOEF,KLEV,&
       & PAPHI, PAPHIF, PAPRS, PAPRSF, PCP, ZQV, ZQL, ZQI, PQSAT,&
       & PR, PT, PU, PV, PLSCPE,PGZ0,&
       & ZMN2PP,ZMRIPP)
    ENDIF

    ! COMPUTATION OF mixing lengths from  Ri*,Ri** - FIRST GUES for moist AF

    !---------------------------------------------------
    ! COMPUTATION OF 'DRY' mixing lengths : lm_d lh_d
    ! COMPUTATION OF ZPBLH - PBL HEIGHT

    IF (CGMIXLEN == 'Z'  .OR. &
     &  CGMIXLEN == 'EL0'.OR. &
     &  CGMIXLEN == 'EL1'.OR. &
     &  CGMIXLEN == 'EL2'.OR. &
     &  CGMIXLEN == 'AY' .OR. &
     &  CGMIXLEN == 'AYC'.AND.(.NOT.LECT)) THEN
      DO JLEV=KTDIA,KLEV
        DO JLON=KIDIA,KFDIA
          ZTHETAV(JLON,JLEV)=PT(JLON,JLEV)*(1.0_JPRB+RETV*ZQV(JLON,JLEV))&
           & *(RATM/PAPRSF(JLON,JLEV))**RKAPPA  
        ENDDO
      ENDDO
      DO JLON=KIDIA,KFDIA
        ZTHETAVS(JLON)=PTS(JLON)*(1.0_JPRB+RETV*PQS(JLON))&
         & *(RATM/PAPRS(JLON,KLEV))**RKAPPA  
      ENDDO
      CALL ACCLPH ( YDPHY0,YDPHY2,KIDIA,KFDIA,KLON,KTDIA,KLEV,&
       & ZTHETAV,PAPHI,PAPHIF,PU,PV,ZTHETAVS,&
       & KCLPH,PCLPH,PVEIN,ZUGST,ZVGST)
      ZBLH(KIDIA:KFDIA)=PCLPH(KIDIA:KFDIA)
      IF (.NOT.LRAFTUR) THEN
        PUGST(KIDIA:KFDIA)=ZUGST(KIDIA:KFDIA)
        PVGST(KIDIA:KFDIA)=ZVGST(KIDIA:KFDIA)
      ENDIF
    ELSE
      ZBLH(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VH%PPBLH(KIDIA:KFDIA)
    ENDIF

  ENDIF ! end of LVDIF or LHMTO or LGWD

  IF ( (LVDIF.OR.LGWD).AND.(.NOT.(LNEBR.OR.LECT)) ) THEN

    IF(TRIM(CGMIXLEN) == 'Z') THEN
      !-------------------------------------------------
      ! "z dependent" mixing length.
      !-------------------------------------------------
      ZBLH(KIDIA:KFDIA)=1.0_JPRB/UHDIFV
      CALL ACMIXLENZ ( YDPHY,YDPHY0,KIDIA,KFDIA,KLON,1,KLEV,.FALSE.,&
       & PAPHI,PAPHIF,ZBLH,PGZ0,PGZ0H,ZLMU,ZLMT)

    ELSEIF((TRIM(CGMIXLEN) == 'TMC').OR.(TRIM(CGMIXLEN) == 'AYC')) THEN
      !     Cubique du climat
      ZBLH(KIDIA:KFDIA)=MIN(XMAXLM,MAX(XMINLM,ZBLH(KIDIA:KFDIA)))
      CALL ACMIXLENTM ( YDPHY0,KIDIA,KFDIA,KLON,KLEV, &
       & PAPHI,PAPHIF,PGZ0,PGZ0H,ZBLH,ZLMU,ZLMT)

    ELSEIF(TRIM(CGMIXLEN) == 'TM') THEN
      !     Ancienne formulation pour Lm
      ZBLH(KIDIA:KFDIA)=MIN(XMAXLM,MAX(XMINLM,ZBLH(KIDIA:KFDIA)))*XKLM
      CALL ACMIXLENZ ( YDPHY,YDPHY0,KIDIA,KFDIA,KLON,1,KLEV,.FALSE.,&
       & PAPHI,PAPHIF,ZBLH,PGZ0,PGZ0H,ZLMU,ZLMT)

      !     Cubique du climat pour Lh
      ZBLH(KIDIA:KFDIA)=ZBLH(KIDIA:KFDIA)/XKLM
      CALL ACMIXLENTM ( YDPHY0,KIDIA,KFDIA,KLON,KLEV,&
       & PAPHI,PAPHIF,PGZ0,PGZ0H,ZBLH,ZZLMT,ZLMT)

    ELSEIF(TRIM(CGMIXLEN) == 'AY') THEN
      !     new Ayotte-Tudor ZBLH & mixing length
      CALL ACMIXLENZ ( YDPHY,YDPHY0,KIDIA,KFDIA,KLON,1,KLEV,.FALSE.,&
       & PAPHI,PAPHIF,ZBLH,PGZ0,PGZ0H,ZLMU,ZLMT)

    ELSEIF((CGMIXLEN(1:2) == 'EL').AND.LPTKE) THEN
      !     e-type mixing length converted to Prandtl type
      CALL ACMIXLENZ(YDPHY,YDPHY0,KIDIA,KFDIA,KLON,1,KLEV,.TRUE.,&
       & PAPHI,PAPHIF,ZBLH,PGZ0,PGZ0H,ZLMU,ZLMT)
      ZLMU2(:,:)=ZLMU(:,:)
      ZLMT2(:,:)=ZLMT(:,:)
      IF     (CGMIXLEN == 'EL0') THEN
        IMLTYPE=0
        ! to have identical mixing length like in pTKE
        ! e-type mixing length converted to Prandtl type
        CALL ACMIXLENZ(YDPHY,YDPHY0,KIDIA,KFDIA,KLON,1,KLEV,.FALSE.,&
         & PAPHI,PAPHIF,ZBLH,PGZ0,PGZ0H,ZLMU,ZLMT)
        ZLMU2(:,:)=ZLMU(:,:)
        ZLMT2(:,:)=ZLMT(:,:)
      ELSEIF (CGMIXLEN == 'EL1') THEN
        IMLTYPE=1
      ELSEIF (CGMIXLEN == 'EL2') THEN
        IMLTYPE=2
      ELSE
        CLERR='APLPAR: UNEXPECTED VALUE FOR CGMIXLEN: '//TRIM(CGMIXLEN)
        CALL ABOR1(CLERR)
      ENDIF

      IF( LCOEFK_RIS) THEN
        LLMAF=.TRUE.
        CALL ACMIXELEN(YGFL,YDPHY,YDPHY0,&
         & KIDIA,KFDIA,KLON,KTDIA,KLEV,KSTEP,IMLTYPE,&
         & PAPHI,PAPHIF,PAPRS,PAPRSF,PT,ZQV,ZQL,ZQI,PQRRES,PQSRES,PTKE,&
         & PR,PU,PV,PALPH,PLNPR,ZMN2PP,ZFMGST,PFPLSH,PFPLCH,&
         & PGZ0,PTS,PCDN,ZBLH,ZLMU,ZLMT,YDVARS%MXL%T0,ZLML,ZLMLTILD,ZRRCOR,LLMAF)
      ENDIF

    ELSE
      CLERR='APLPAR: UNEXPECTED VALUE FOR CGMIXLEN: '//TRIM(CGMIXLEN)
      CALL ABOR1(CLERR)
    ENDIF

    IF(LCOEFKTKE) THEN

      ! ------------------------------------------------------------- 
      ! COMPUTATION OF Ri', NCVPP AND COEFFICIENT FOR MOIST GUSTINESS
      ! ------------------------------------------------------------- 
      IF(LCOEFK_RIS) THEN
        CALL ACMRIS ( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTCOEF,KLEV,&
         & PAPHI, PAPHIF, PAPRS, PAPRSF, PCP, PDELP, PLSCPE,&
         & ZQV, ZQL, ZQI, PQSAT,&
         & PR, PT, PU, PV, ZLMU, ZLMT,PGZ0,&
         & ZMRIPP)
      ENDIF

      CALL ACMRIP(YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTCOEF,KLEV,KSTEP,&
       & PAPHI, PAPHIF, PAPRS, PAPRSF,&
       & ZQV, ZQL, ZQI,ZCP,&
       & PALPH,PLNPR,PQSAT,PQW,PTW,&
       & PR,PT,PU,PV,&
       & YDVARS%FQTUR%T0,YDVARS%FSTUR%T0,YDVARS%SHTUR%T0,&
       & PTKE,YDVARS%TTE%T0,&
       & PTS,YDMF_PHYS_SURF%GSD_VH%PQSH,PRS,PCPS,ZRTI,PGZ0,&
       & LLCLS,&
       & ZMRIPP,ZMRIFPP,&
       & ZBNEBCVPP,ZBNEBQ,ZNBVNO,&
       & ZFMTKE,ZFTTKE,ZF_EPS,ZFUN_TTE,&
       & ZAUTKE,ZATTKE,&
       & ZFHORM,ZFHORH,&
       & ZTH_FUN,ZWW_FUN,&
       & ZMRIMC,ZMRICTERM,ZMN2PP,&
       & ZMN2_ES,ZMN2_EQ,ZMN2_DS,ZMN2_DQ,ZFMGST)

    ENDIF ! LCOEFTKE

    ! FINISHING MIXING LENGTH COMPUTATION
    IF((CGMIXLEN(1:2) == 'EL').AND.LPTKE) THEN
      ZLMU(:,:)=ZLMU2(:,:)
      ZLMT(:,:)=ZLMT2(:,:)
      IF     (CGMIXLEN == 'EL0') THEN
        IMLTYPE=0
      ELSEIF (CGMIXLEN == 'EL1') THEN
        IMLTYPE=1
      ELSEIF (CGMIXLEN == 'EL2') THEN
        IMLTYPE=2
      ENDIF
      LLMAF=.FALSE.
      CALL ACMIXELEN(YGFL,YDPHY,YDPHY0,&
       & KIDIA,KFDIA,KLON,KTDIA,KLEV,KSTEP,IMLTYPE,&
       & PAPHI,PAPHIF,PAPRS,PAPRSF,PT,ZQV,ZQL,ZQI,PQRRES,PQSRES,PTKE,&
       & PR,PU,PV,PALPH,PLNPR,ZMN2PP,ZFMGST,PFPLSH,PFPLCH,&
       & PGZ0,PTS,PCDN,ZBLH,ZLMU,ZLMT,YDVARS%MXL%T0,ZLML,ZLMLTILD,ZRRCOR,LLMAF)
    ENDIF

  ENDIF ! (LVDIF or LGWD) and( not(LNEBR or LECT))

  IF ( LVDIF.OR.LHMTO.OR.LGWD ) THEN

    IF (LFLUSO.AND.(.NOT.LMSE)) THEN
      DO JLON=KIDIA,KFDIA
        ZCRTI(JLON) = 1.0_JPRB/(PTS(JLON)*PRS(JLON))
      ENDDO
      CALL ACFLUSO ( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,KLEV,&
       & PAPHI,PAPHIF,PAPRS,PAPRSF,PQ,PT,PU,PV,&
       & ZDPHIT,ZDPHIV,PGZ0,YDMF_PHYS_SURF%GSD_VF%PLSM,PQSATS,ZCRTI,PTS,&
       & LLHMT,PCD,PCDN,ZCDROV,ZCE,ZCEROV,PCH,ZCHROV,&
       & PQCLS,PRHCLS,PTCLS,PUCLS,PVCLS,PUGST,PVGST)
    ELSE
      DO JLON=KIDIA,KFDIA
        ZCE   (JLON) = PCH   (JLON)
        ZCEROV(JLON) = ZCHROV(JLON)
      ENDDO
    ENDIF

  ENDIF ! LVDIF or LHMTO or LGWD

  IF (LRAFTKE) THEN
    PCAPE(:)=0._JPRB
    ZDCAPE(:)=0._JPRB
    CALL ACCLDIA(YDXFU,YDPHY,YDPHY2,YDTOPH,KIDIA,KFDIA, KLON, KLEV,&
      & PUCLS, PVCLS, PU, PV, PCAPE, ZDCAPE, PTKE, PAPHIF, POROG, PUGST, PVGST,ZBLH,KCLPH)
  ENDIF

!**
!     ------------------------------------------------------------------
!     6.- TURBULENCE: COEFFICIENTS D'ECHANGE
!     ------------------------------------------------------------------

  IF ( (LVDIF.OR.LGWD).AND.(.NOT.(LNEBR.OR.LECT)) ) THEN
     !-------------------------------------------------
     ! Compute diffusion coefficients.
     !-------------------------------------------------

    IF(LCOEFKTKE) THEN
      CALL ACTKECOEFK ( YDPHY0,YDPHY2,KIDIA,KFDIA,KLON,NTCOEF,KLEV,&
       & PAPHI, PAPHIF, PAPRS,&
       & ZFMTKE,ZFTTKE,ZAUTKE,ZATTKE,&
       & PR, PT, PU, PV, ZLMU, ZLMT, PGZ0,&
       & ZKTROV, ZKUROV, ZKNROV, ZXTROV, ZXUROV, ZXPTKEROV)
    ELSE
      CALL ACCOEFK ( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTCOEF,KLEV,&
       & PAPHI, PAPHIF, PAPRS, PAPRSF, PCP, PDELP, PLSCPE, ZQV, ZQL, ZQI, PQSAT,&
       & PR, PT, PU, PV, PFPLSH, PFPLCH, ZLMU, ZLMT, PGZ0, PGZ0H, ZBLH,&
       & ZKTROV, ZKUROV, ZKNROV, ZNBVNO, ZXTROV, ZXUROV, ZXPTKEROV)
    ENDIF
  ENDIF

  IF (LCVPPKF) THEN
    CALL ACVPPKF( YDMODEL%YRML_PHY_MF,KIDIA, KFDIA, KLON, NTCVIM, KLEV,&
     & PAPRSF, PAPHIF, PDELP, PR, PT, ZQV,&
     & ZQL, ZQI, PU, PV, PVERVEL, PCP, PTKE,&
     & ZDIFCVPPQ, ZDIFCVPPS, ZCONDCVPPL, ZCONDCVPPI,&
     & ZPRODTH_CVPP, INLAB_CVPP, ZQLI_CVPP, ZNEB_CVPP, INND)
  ENDIF

     !-------------------------------------------------
     !  Call to EDKF
     !-------------------------------------------------
  IF (LEDKF) THEN
    IF (LEDMFI) THEN
       ZIMPL=0._JPRB
    ELSE  
       ZIMPL=1._JPRB 
    ENDIF
      
    IF (KSTEP == 0) YDMF_PHYS_SURF%GSD_SFL%PGROUP(:,:) = 0.0_JPRB
    CALL ARP_SHALLOW_MF( KIDIA,KFDIA,KLON,KTDIA,KLEV,ZIMPL,TSPHY,PAPHI,PAPHIF,PR,PCP, &
                      & CMF_UPDRAFT,CMF_CLOUD,LMIXUV, &
                      & PU,PV,PT,ZQV,ZQL,ZQI,ZQR,ZQS,PTKE,PAPRSF,PDELP,          &
                      & ZEDMFQ,ZEDMFS,ZEDMFU,ZEDMFV,                &
                      & YDMF_PHYS_SURF%GSD_SFL%PGROUP(:,1),YDMF_PHYS_SURF%GSD_SFL%PGROUP(:,2),ZPRODTH_CVPP,ZQLI_CVPP,ZNEB_CVPP,INLAB_CVPP,ZMF_UP)

  ENDIF

  IF ( LVDIF.AND.LECT ) THEN
    IF ( LCONDWT ) THEN
       PQICE(:,:)= ZQI(:,:)
       PQLI(:,:) = ZQL(:,:)
    ELSE
       PQICE(:,:)= 0.0_JPRB
       PQLI(:,:) = 0.0_JPRB
    ENDIF

! Computation of the 2 znlab used in acbl89
    IF (.NOT. LECSHAL) INLAB_CVPP(:,:) = 0
    IF (LECDEEP) THEN
       ZNLABCVP(:,:) = 1.0_JPRB
    ELSE
       ZNLABCVP(:,:) = 0.0_JPRB
    ENDIF
    IF(LNEBN.OR.LNEBR.OR.LRRGUST) THEN
      DO JLEV=KTDIA,KLEV
        DO JLON=KIDIA,KFDIA
          ZNLABCVP(JLON,JLEV) = ZNLABCVP(JLON,JLEV)&
         & *MAX(0.0_JPRB,SIGN(1.0_JPRB,PFPLCH(JLON,JLEV)-PFPLCH(JLON,JLEV-1)-ZEPS))
          ZNLAB(JLON,JLEV) = REAL(INLAB_CVPP(JLON,JLEV),JPRB)
        ENDDO
      ENDDO
    ENDIF
    DO JLEV=KTDIA,KLEV
      DO JLON=KIDIA,KFDIA
        ZNLAB(JLON,JLEV) = REAL(INLAB_CVPP(JLON,JLEV),JPRB)
      ENDDO
    ENDDO

    CALL ACTKE ( YDLDDH,YDMODEL%YRML_DIAG%YRMDDH,YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTCOEF,NTCOET,KLEV,&
     & PAPHI, PAPHIF, PAPRS, PAPRSF, PDELP,&
     & PR, PT, PU, PV, ZQV, ZQIC, ZQLC, PLSCPE,&
     & PCD, PCH, PGZ0, PTS, PQS,&
     & PQICE, PQLI, PTKE, ZPRODTH_CVPP, ZNLAB, ZNLABCVP,&
     & ZKTROV, ZKQROV, ZKQLROV, ZKUROV, ZXTROV, ZXUROV,&
     & ZNBVNO, ZNEBS, ZQLIS, ZNEBS0, ZQLIS0, ZCOEFN , PFTKE, PFTKEI, ZTKE1,ZTPRDY,&
     & PTDISS,YDDDH)
    PCLPH(KIDIA:KFDIA)=MIN(XMAXLM,MAX(XMINLM,PCLPH(KIDIA:KFDIA)))
  ENDIF


     !-------------------------------------------------
     ! Store diffusion coefficients in trajectory in temporary variables
     ! before final writing.
     !-------------------------------------------------
  ZKTROV_SAVE(:,:)=ZKTROV(:,:)
  ZKUROV_SAVE(:,:)=ZKUROV(:,:)
  ZCDROV_SAVE(:)=ZCDROV(:)
  ZCHROV_SAVE(:)=ZCHROV(:)

!**
!     ------------------------------------------------------------------
!     7.- RAYONNEMENT
!     ----------------
!     --------------------------------------------------------------------
!      - COMPUTE DUST PROPERTIES FOR RADIATION IF LMDUST=T
!     --------------------------------------------------------------------
  IF (LMDUST.AND.(NGFL_EXT/=0)) THEN
! input dust scalar concentration in ppp from

  CALL ARO_MNHDUST (1,ILONMNH,KLEV,NGFL_EXT, PDT,&
                 & ZZI_SVM(KIDIA:KFDIA,:,:,1:NGFL_EXT),&
                 & ZZZ(KIDIA:KFDIA,:,:),&
                 & ZDZZ(KIDIA:KFDIA,:,:),&
                 & ZZI_PABSM(KIDIA:KFDIA,:,:),&
                 & ZZI_THM(KIDIA:KFDIA,:,:),&
                 & ZZI_RHODREFM(KIDIA:KFDIA,:,:),&
                 & NSWB_MNH,&
                 & KSTEP+1,&
                 & ZZI_SVM(KIDIA:KFDIA,:,:,1:NGFL_EXT),&
                 & ZPIZA_DST(KIDIA:KFDIA,:,:),&
                 & ZCGA_DST(KIDIA:KFDIA,:,:),&
                 & ZTAUREL_DST(KIDIA:KFDIA,:,:),&
                 & ZAERD(KIDIA:KFDIA,:),&
                 & NGFL_EZDIAG,&
                 & ZZI_PEZDIAG(KIDIA:KFDIA,:,:)           )


  DO JDIAG = 1, YDMODEL%YRML_GCONF%YGFL%NGFL_EZDIAG
    YDVARS%EZDIAG(JDIAG)%T0 (KIDIA:KFDIA,:) = ZZI_PEZDIAG(KIDIA:KFDIA,:,JDIAG)
  ENDDO

! return to aladin environment (inversion des niveaux)
   DO JGFL=1,NGFL_EXT
     DO JLON=1,KLON
       DO JLEV=1,KLEV
         ZSVM(JLON,JLEV,JGFL)=ZZI_SVM(JLON,1,JLEV,JGFL)
       ENDDO
     ENDDO
   ENDDO
  ENDIF

!      7.1 Albedo et emissivite en presence de neige
!          Albedo and emissivity with snow

  IF (.NOT.LMSE) THEN
!DEC$ IVDEP
    DO JLON=KIDIA,KFDIA
      IF (LSNV) THEN
        IF ((YDMF_PHYS_SURF%GSD_VF%PVEG(JLON) < 0.01_JPRB).OR.(YDMF_PHYS_SURF%GSD_VF%PALBF(JLON) >= 0.60_JPRB)) THEN
          ZALBV=0.0_JPRB
          YDMF_PHYS_SURF%GSD_VF%PALBSF(JLON)=YDMF_PHYS_SURF%GSD_VF%PALBF(JLON)
        ELSE
          ZALBV=(YDMF_PHYS_SURF%GSD_VF%PALBF(JLON)-(1.0_JPRB-YDMF_PHYS_SURF%GSD_VF%PVEG(JLON))*YDMF_PHYS_SURF%GSD_VF%PALBSF(JLON))/YDMF_PHYS_SURF%GSD_VF%PVEG(JLON)
        ENDIF
        PALB(JLON)= (1.0_JPRB-YDMF_PHYS_SURF%GSD_VF%PVEG(JLON))*(1.0_JPRB-ZNEIJG(JLON)) *&
         & YDMF_PHYS_SURF%GSD_VF%PALBSF(JLON)&
         & + (1.0_JPRB-YDMF_PHYS_SURF%GSD_VF%PVEG(JLON))*ZNEIJG(JLON) *&
         & MAX(YDMF_PHYS_SURF%GSD_VF%PALBSF(JLON),PALBNS(JLON))&
         & + YDMF_PHYS_SURF%GSD_VF%PVEG(JLON)*ZNEIJV(JLON) *&
         & MAX(ZALBV,PALBNS(JLON))&
         & + YDMF_PHYS_SURF%GSD_VF%PVEG(JLON)*(1.0_JPRB-ZNEIJV(JLON)) * ZALBV
        PEMIS(JLON)= (1.0_JPRB-YDMF_PHYS_SURF%GSD_VF%PVEG(JLON))*(1.0_JPRB-ZNEIJG(JLON)) *&
         & YDMF_PHYS_SURF%GSD_VF%PEMISF(JLON)&
         & + (1.0_JPRB-YDMF_PHYS_SURF%GSD_VF%PVEG(JLON))*ZNEIJG(JLON) * EMCRIN&
         & + YDMF_PHYS_SURF%GSD_VF%PVEG(JLON)*ZNEIJV(JLON) * EMCRIN&
         & + YDMF_PHYS_SURF%GSD_VF%PVEG(JLON)*(1.0_JPRB-ZNEIJV(JLON)) * YDMF_PHYS_SURF%GSD_VF%PEMISF(JLON)
      ELSE
        IF (LVGSN) THEN
          IF (LZ0HSREL.AND.LCOEFKSURF) THEN
            ! new treatment, PNEIJ is gridbox snow fraction
            PALB(JLON)=(1.0_JPRB-PVEG(JLON)-PNEIJ(JLON))*YDMF_PHYS_SURF%GSD_VF%PALBF(JLON)+ &
             & PVEG(JLON)*YDMF_PHYS_SURF%GSD_VV%PALV(JLON)+PNEIJ(JLON)*PALBNS(JLON)
          ELSE
            ! old treatment, PNEIJ is snow fraction for bare ground
            PALB(JLON)=YDMF_PHYS_SURF%GSD_VF%PALBF(JLON)-PNEIJ(JLON)*(YDMF_PHYS_SURF%GSD_VF%PALBF(JLON)- &
             & PALBNS(JLON))+(PNEIJ(JLON)-ZNEIJV(JLON))*     &
             & YDMF_PHYS_SURF%GSD_VF%PVEG(JLON)*(YDMF_PHYS_SURF%GSD_VV%PALV(JLON)-PALBNS(JLON))
          ENDIF

          PALB(JLON)=MIN(ABS(YDMF_PHYS_SURF%GSD_VV%PIVEG(JLON)-2._JPRB),1.0_JPRB) * PALB(JLON) +(&
           & 1.0_JPRB-MIN(ABS(YDMF_PHYS_SURF%GSD_VV%PIVEG(JLON)-2._JPRB),1.0_JPRB))&
           & * MAX(ALCRIN,PALB(JLON))
          YDMF_PHYS_SURF%GSP_SG%PT_T1(JLON,1)=PALB(JLON)

          PEMIS(JLON)=YDMF_PHYS_SURF%GSD_VF%PEMISF(JLON)-PNEIJ(JLON)*(YDMF_PHYS_SURF%GSD_VF%PEMISF(JLON)-EMCRIN)

        ELSE
          PALB(JLON)=YDMF_PHYS_SURF%GSD_VF%PALBF(JLON)-PNEIJ(JLON)*(YDMF_PHYS_SURF%GSD_VF%PALBF(JLON)&
           & -MAX(YDMF_PHYS_SURF%GSD_VF%PALBF(JLON),ALCRIN))
          PEMIS(JLON)=YDMF_PHYS_SURF%GSD_VF%PEMISF(JLON)-PNEIJ(JLON)*(YDMF_PHYS_SURF%GSD_VF%PEMISF(JLON)-EMCRIN)
        ENDIF
      ENDIF
    ENDDO

    IF (LRAYFM) THEN
      ! diffuse and direct (parallel) albedo in NSW solar intervals
      IF (LALBMERCLIM) THEN
        DO JSG=1,NSW
          DO JLON=KIDIA,KFDIA
            ZALBD(JLON,JSG)=PALB(JLON)
            ZALBPMER=(1.0_JPRB+&
             & 0.5_JPRB*PMU0M(JLON)*(1.0_JPRB/PALB(JLON)-1.0_JPRB))/   (&
             & 1.0_JPRB+PMU0M(JLON)*(1.0_JPRB/PALB(JLON)-1.0_JPRB))**2
            ZALBP(JLON,JSG)=PALB(JLON)*          YDMF_PHYS_SURF%GSD_VF%PLSM(JLON)+&
                          & ZALBPMER  *(1.0_JPRB-YDMF_PHYS_SURF%GSD_VF%PLSM(JLON))
          ENDDO
        ENDDO
      ELSE
!DEC$ IVDEP
        DO JLON=KIDIA,KFDIA
          ZMERL(JLON)=(1.0_JPRB-YDMF_PHYS_SURF%GSD_VF%PLSM(JLON))*(1.0_JPRB&
            & -MAX(0.0_JPRB,SIGN(1.0_JPRB,TMERGL-PTS(JLON))))
          PEMIS(JLON)=PEMIS(JLON)*YDMF_PHYS_SURF%GSD_VF%PLSM(JLON)+ZMERL(JLON)*EMMMER&
            & +(1.0_JPRB-YDMF_PHYS_SURF%GSD_VF%PLSM(JLON))*(1.0_JPRB-ZMERL(JLON))*EMMGLA
        ENDDO
        DO JSG=1,NSW
          DO JLON=KIDIA,KFDIA
            ZALBD(JLON,JSG)=(1.0_JPRB-ZMERL(JLON))*PALB(JLON)+&
                                    & ZMERL(JLON) *ALBMED
            ZALBP(JLON,JSG)=(1.0_JPRB-ZMERL(JLON))*PALB(JLON)+&
             & ZMERL(JLON) *&
             & MAX(0.037_JPRB/(1.1_JPRB*PMU0(JLON)**1.4_JPRB+0.15_JPRB),ZEPS0)
          ENDDO
        ENDDO
      ENDIF
    ELSEIF (LRAY) THEN
      ! direct (parallel) albedo for ACRANEB/ACRANEB2, Geleyn's formula
      ! with given proportion of Lambertian scattering
      DO JLON=KIDIA,KFDIA
        IF ( YDMF_PHYS_SURF%GSD_VF%PLSM(JLON) < 0.5_JPRB .AND. PTS(JLON) >= TMERGL ) THEN
          ZLAMB=RLAMB_WATER  ! water surface (open sea)
        ELSE
          ZLAMB=RLAMB_SOLID  ! solid surface (frozen sea or land)
        ENDIF
        ZALBDIR(JLON)=ZLAMB*PALB(JLON)+(1._JPRB-ZLAMB)*(1._JPRB+&
         & 0.5_JPRB*PMU0(JLON)*(1.0_JPRB/PALB(JLON)-1.0_JPRB))/   (&
         & 1.0_JPRB+PMU0(JLON)*(1.0_JPRB/PALB(JLON)-1.0_JPRB))**2
      ENDDO
    ENDIF

  ENDIF  ! .NOT.LMSE

  ! Appel de la routine d'aerosols

  LLAERO=LAEROSEA.AND.LAEROLAN.AND.LAEROSOO.AND.LAERODES

  IF ( .not. LRAYFM) THEN
    NAER=0
    NRADFR=NSTOP+1
  ENDIF

  IF    (   (LRAYFM.AND.(MOD(KSTEP,NRADFR) == 0)) &
  & .OR.  ( (LRAY.OR.LRAYSP).AND.(.NOT.LRSTAER)) ) THEN

    IF (LLAERO) THEN
      DO JLON = KIDIA,KFDIA
        ZAESEA(JLON) = YDMF_PHYS_SURF%GSD_VA%PSEA(JLON)
        ZAELAN(JLON) = YDMF_PHYS_SURF%GSD_VA%PLAN(JLON)
        ZAESOO(JLON) = YDMF_PHYS_SURF%GSD_VA%PSOO(JLON)
        ZAEDES(JLON) = YDMF_PHYS_SURF%GSD_VA%PDES(JLON)
      ENDDO
    ELSE
      DO JLON = KIDIA,KFDIA
        ZAESEA(JLON) = 0.0_JPRB
        ZAELAN(JLON) = 0.0_JPRB
        ZAESOO(JLON) = 0.0_JPRB
        ZAEDES(JLON) = 0.0_JPRB
      ENDDO
    ENDIF
    IF (LAEROSUL) THEN
      DO JLON = KIDIA,KFDIA
        ZAESUL(JLON) = YDMF_PHYS_SURF%GSD_VA%PSUL(JLON)
      ENDDO
    ELSE
      DO JLON = KIDIA,KFDIA
        ZAESUL(JLON) = 0.0_JPRB
      ENDDO
    ENDIF
    IF (LAEROVOL) THEN
       DO JLON = KIDIA,KFDIA
        ZAEVOL(JLON) = YDMF_PHYS_SURF%GSD_VA%PVOL(JLON)
      ENDDO
    ELSE
      DO JLON = KIDIA,KFDIA
        ZAEVOL(JLON) = 0.0_JPRB
      ENDDO
    ENDIF

    IF ( ( (LRAYFM.AND.NAER /= 0) .OR.LRAY.OR.LRAYSP).AND.LLAERO )  THEN
      CALL RADAER ( YDMODEL%YRML_PHY_RAD%YREAERD,YDERAD,YDPHY, KIDIA , KFDIA , KLON  , KLEV,&
       & PAPRS , PAPRSF, PT    , PTS,&
       & ZAESEA, ZAELAN, ZAESOO, ZAEDES, ZAESUL, ZAEVOL,&
       & ZAER,ZAERINDS                                 )
    ENDIF

  ELSEIF ( (LRAY.OR.LRAYSP).AND.LRSTAER ) THEN

    DO JLEV=KTDIA,KLEV
      DO JLON=KIDIA,KFDIA
        ZAER(JLON,JLEV,1)=ZDAER(JLEV)
        ZAER(JLON,JLEV,2:6)=0._JPRB
      ENDDO
    ENDDO

  ENDIF ! FOR AEROSOLS

! We uses the extinction coefficient explicitely solved by ARO_MNHDUST
  IF (LMDUST.AND.(NGFL_EXT/=0)) THEN
         ZAER(KIDIA:KFDIA,:,3) = ZAERD(KIDIA:KFDIA,:)
  ENDIF


!      7.2 Flux radiatifs par ciel clair (Code Geleyn)
!          Clear sky radiative fluxes    (Geleyn's scheme)

  ! separate clearsky call is kept only for old ACRANEB; for ACRANEB2
  ! duplicit calculation of gaseous transmissions is avoided
  IF (LRAY.AND.NRAY == 1.AND.KNFRRC /= 0) THEN
    IF (MOD(KSTEP,KNFRRC) == 0) THEN
      CALL ACRANEB(YDRIP,YDMODEL%YRML_PHY_MF, &
       & KIDIA,KFDIA,KLON,NTRADI,KLEV,IJN,&
       & PAPHIF,PAPRS,PAPRSF,PCP,PR,PDELP,PNEB,&
       & ZQV,ZQCO2,PQICE,PQLI,ZQO3,PT,&
       & PALB,ZALBDIR,PEMIS,PMU0,PGEMU,PGELAM,PMU0LU,PTS,&
       & PFRSO,PFRTH,&
       & ZFRSODS,PFRSOPS,PFRSOLU,PFRTHDS,ZAER,&
       & ZMAK,ZMAN)
      DO JLON=KIDIA,KFDIA
        PFRSOC(JLON,0)=PFRSO(JLON,NTRADI-1,1)
        PFRSOC(JLON,1)=PFRSO(JLON,KLEV,1)
        PFRTHC(JLON,0)=PFRTH(JLON,NTRADI-1,1)
        PFRTHC(JLON,1)=PFRTH(JLON,KLEV,1)
      ENDDO
    ENDIF
  ENDIF

!      7.3 Nebulosite et Convection
!          Cloud cover and Convection
!      7.3.1 Shallow + Deep convection

  IF (LCVPGY) THEN
    ! Le schema de convection de J. F. Gueremy
    IF (LCONDWT) THEN
      DO JLEV=KTDIA,KLEV
        DO JLON=KIDIA,KFDIA
          ZQCL(JLON,JLEV)=ZQL(JLON,JLEV)
          ZQCI(JLON,JLEV)=ZQI(JLON,JLEV)
        ENDDO
      ENDDO
    ELSE
      DO JLEV=KTDIA,KLEV
        DO JLON=KIDIA,KFDIA
          ZQCL(JLON,JLEV)=0.0_JPRB
          ZQCI(JLON,JLEV)=0.0_JPRB
        ENDDO
      ENDDO
    ENDIF
    CALL ACCVIMPGY ( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTCVIM,KLEV,&
     & PALPH, PAPHIF, PAPRS, PAPRSF, PCP,&
     & PDELP,PLH,PLNPR,ZQV,ZQCI,ZQCL,ZQLIS,PQSAT,PQW,&
     & PR,PRDELP,PT,PTW, PU, PV,&
     & PCPS,PGM,PTS,&
     & PDIFCQ,PDIFCQL,PDIFCQI,PDIFCS,PFCCQL,PFCCQN,&
     & PFPFPCL,PFPFPCN,PFPEVPCL,PFPEVPCN,&
     & ZFHMLTSC,ZFHEVPPC,ZFPEVPPC,&
     & PFPLCL,PFPLCN,ZNEBC,ZQLIC,PSTRCU,PSTRCV,&
     & ICIS,INLAB,&
     & INND,&
     & PCVV)

    DO JLEV = KTDIA, KLEV
      DO JLON = KIDIA, KFDIA
        PDIFCS(JLON,JLEV) = PDIFCS(JLON,JLEV) - ZFHEVPPC(JLON,JLEV)&
                                            & - ZFHMLTSC(JLON,JLEV)
        PDIFCQ(JLON,JLEV) = PDIFCQ(JLON,JLEV) + PFPEVPCL(JLON,JLEV)&
                                            & + PFPEVPCN(JLON,JLEV)
      ENDDO
    ENDDO
    PFPEVPCL=0._JPRB
    PFPEVPCN=0._JPRB
    IF (LGRAPRO) THEN
      PFPEVPCG=0._JPRB
    ENDIF
    ! Prise en compte des nuages convectifs diagnostiques sortant d'ACMTUD
    IF (LNCVPGY) THEN
      DO JLEV=KTDIA,KLEV
        DO JLON=KIDIA,KFDIA
          ZNEBC0(JLON,JLEV)=ZNEBC(JLON,JLEV)
          ZQLI_CVP(JLON,JLEV)=ZQLIC(JLON,JLEV)
        ENDDO
      ENDDO
    ENDIF

    ! Annulation possible des flux convectifs pour les eaux condensees.
    IF (.FALSE.) THEN
      DO JLEV=0,KLEV
        DO JLON=KIDIA,KFDIA
          PDIFCQL(JLON,JLEV)=0.0_JPRB
          PDIFCQI(JLON,JLEV)=0.0_JPRB
        ENDDO
      ENDDO
    ENDIF
  ENDIF !  (LCVPGY)

  IF ( LCONDWT.AND.(.NOT.LNEBECT)) THEN

    IF(LCVPRO.AND.LNEBCV) THEN
! convective cloudiness in case we need protection of convective cloud water.
      DO JLEV=KTDIA,KLEV
        DO JLON=KIDIA,KFDIA
          ZNEBCH(JLON,JLEV)=ZUNEBH(JLON,JLEV)
        ENDDO
      ENDDO
      IF (LCVCSD) THEN
        DO JLEV=KTDIA,KLEV
          DO JLON=KIDIA,KFDIA
            ZNEBC0(JLON,JLEV)=MAX(ZEPSNEB,&
                            & MIN(1._JPRB-ZEPSNEB,ZUNEBH(JLON,JLEV)))
          ENDDO
        ENDDO
      ENDIF
    ENDIF

    CALL ACNEBCOND ( YDRIP,YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTPLUI,KLEV,LLREDPR,&
     & ZHUC,ZVETAF,PAPHI,PAPHIF,PAPRSF,PCP,PR,PDELP,PRH,ZBLH,ZQV,ZQI,ZQL,&
     & PQW,PT,ZNEBCH,PGM,PTS,&
     & ZQLIS,ZNEBS,ZRHCRI,ZRH,ZQSATS,ZICEFR1,ZQLIS0,ZNEBS0)
     
    IF (LMUSCLFA) CALL WRSCMR(NMUSCLFA,'ZRHCRI',ZRHCRI,KLON,KLEV) 
    IF (LMUSCLFA) CALL WRSCMR(NMUSCLFA,'ZQLIS0',ZQLIS0,KLON,KLEV)
    IF (LMUSCLFA) CALL WRSCMR(NMUSCLFA,'ZQLIS',ZQLIS,KLON,KLEV)

    IF(LRKCDEV) THEN
! Rash-Kristiansson cloud water scheme - second part.
      DO JLEV=KTDIA,KLEV
        DO JLON=KIDIA,KFDIA
        ! analytical solution dRH/dCLOUD:                                                
          ZRHDFDA(JLON,JLEV)=2._JPRB*(1._JPRB - ZNEBS(JLON,JLEV))&
               & *(1.0_JPRB-ZRHCRI(JLON,JLEV))
        ENDDO
      ENDDO
    ENDIF


  ENDIF ! LCONDWT .AND. .NOT.LNEBECT

  !-------------------------------------------------
  ! PCMT convection scheme.
  !-------------------------------------------------
  IF(LGPCMT) THEN
    ZSMOOTRAC(1:INBTRA) = GCVTSMO ! as usual 

    IF(LEDMFI) THEN
      CALL ACPCMT(YDGEM,YDGEOMETRY%YRDIM,YDGEOMETRY%YREGEO,  YDLDDH,YDMODEL%YRML_DIAG%YRMDDH,YDRIP,YDMODEL%YRML_PHY_MF, &
      & KIDIA,KFDIA,KLON,NTCVIM,KLEV,INBTRA,&
      ! - INPUT  2D .
      & PALPH,PAPHI,PAPHIF,PAPRS,PAPRSF,PVERVEL,PCP,PLH,PR,&
      & PDELP,PLNPR,&
      & PQ,ZQI,ZQL,PQRRES,PQSRES,ZQLIS,PQSAT,PQW,&
      & PRDELP,PCVGQ,PT,PTW,PU,PV,PTKE,ZTRA(:,:,INBTRA_DEP:INBTRA),ZSMOOTRAC(1:INBTRA),&
      & ZQLC, ZQIC, ZQRC, ZQSC, &
      ! - INPUT 1D .
      & PGM, PTS, PQS, PNEIJ, YDMF_PHYS_SURF%GSD_VF%PLSM, ZVETAF, &
      ! - OUTPUT 2D .
      & ZEDMFQ,PDIFCQL,PDIFCQI, PDIFCQLC, PDIFCQIC,&
      & ZEDMFS,ZDIFCVTH,ZTMPPRODTH,&
      & PFCCQL,PFCCQN,ZEDMFU,ZEDMFV,ZSTRCTRA(:,:,INBTRA_DEP:INBTRA),&
      & PFIMCC,PFPEVPCL,PFPEVPCN,&
      & PFPLCL,PFPLCN,ZMF_UP,ZMU,ZMD,&
      & PFPFPCL,PFPFPCN,&
      & PFEDQLC, PFEDQIC, PFEDQRC, PFEDQSC,&
      & PFCNEGQLC,PFCNEGQIC,PFCNEGQRC,PFCNEGQSC, &
      & INLAB,&
      & ZNEBC0,ZQLI_CVP,ZTU,ZQU,ZQC_DET_PCMT,ZCSGC,ZENTCH, &
      ! - OUTPUT 1D .
      & INND,PCAPE,ZAIPCMT,ZALF_CAPE,ZALF_CVGQ,&
      ! - INPUT/OUTPUT 2D .
      & YDVARS%UAL%T0,YDVARS%UOM%T0,YDVARS%DAL%T0,YDVARS%DOM%T0,YDDDH)
    ELSE
      CALL ACPCMT(YDGEM,YDGEOMETRY%YRDIM,YDGEOMETRY%YREGEO,  YDLDDH,YDMODEL%YRML_DIAG%YRMDDH,YDRIP,YDMODEL%YRML_PHY_MF, &
      & KIDIA,KFDIA,KLON,NTCVIM,KLEV,INBTRA,&
      ! - INPUT  2D .
      & PALPH,PAPHI,PAPHIF,PAPRS,PAPRSF,PVERVEL,PCP,PLH,PR,&
      & PDELP,PLNPR,&
      & PQ,ZQI,ZQL,PQRRES,PQSRES,ZQLIS,PQSAT,PQW,&
      & PRDELP,PCVGQ,PT,PTW,PU,PV,PTKE,ZTRA(:,:,INBTRA_DEP:INBTRA),ZSMOOTRAC(1:INBTRA),&
      & ZQLC, ZQIC, ZQRC, ZQSC, &
      ! - INPUT 1D .
      & PGM, PTS, PQS, PNEIJ, YDMF_PHYS_SURF%GSD_VF%PLSM, ZVETAF, &
      ! - OUTPUT 2D .
      & PDIFCQ,PDIFCQL,PDIFCQI, PDIFCQLC, PDIFCQIC,&
      & PDIFCS,ZDIFCVTH,ZTMPPRODTH,&
      & PFCCQL,PFCCQN,PSTRCU,PSTRCV,ZSTRCTRA(:,:,INBTRA_DEP:INBTRA),&
      & PFIMCC,PFPEVPCL,PFPEVPCN,&
      & PFPLCL,PFPLCN,ZMF_UP,ZMU,ZMD,&
      & PFPFPCL,PFPFPCN,&
      & PFEDQLC, PFEDQIC, PFEDQRC, PFEDQSC,&
      & PFCNEGQLC,PFCNEGQIC,PFCNEGQRC,PFCNEGQSC, &
      & INLAB,&
      & ZNEBC0,ZQLI_CVP,ZTU,ZQU,ZQC_DET_PCMT,ZCSGC,ZENTCH, &
      ! - OUTPUT 1D .
      & INND,PCAPE,ZAIPCMT,ZALF_CAPE,ZALF_CVGQ,&
      ! - INPUT/OUTPUT 2D .
      & YDVARS%UAL%T0,YDVARS%UOM%T0,YDVARS%DAL%T0,YDVARS%DOM%T0,YDDDH)
    ENDIF

  ENDIF

!         Appel du calcul de nebulosite.

  IF(LNEBN) THEN
    CALL ACNEBN ( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTNEBU,KLEV,&
     & PAPHIF,PCP,ZQV,ZQL,ZQI,PQSAT,PT,PFPLCH,PDELP,PRDELP,PAPRSF,&
     & ZUNEBH,&
     & ZNEBS0,ZQLIS0,ZQLI_CVP,ZNEB_CVPP,ZQLI_CVPP,&
     & ZAIPCMT,PNEB,ZNEBC0,PQICE,PQLI,&
     & ZHUC,ZVETAF)
    DO JLEV=KTDIA,KLEV
!DEC$ IVDEP
      DO JLON=KIDIA,KFDIA
        PNEB(JLON,JLEV)=PNEB(JLON,JLEV)*GAEPS
      ENDDO
    ENDDO
  ENDIF

  IF ( LNEBR ) THEN
    CALL ACNEBR ( YDERAD,YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTCOEF,NTNEBU,KLEV,&
     & PAPHI,PAPHIF,PAPRS,PAPRSF,PLSCPE,ZQV,&
     & PQSAT,PR,PT,PU,PV,PRDELP,PDELP,&
     & PGZ0,PFPLCH,YDMF_PHYS_SURF%GSD_VH%PPBLH,PQS,PTS,&
     & ZKTROV,ZKUROV,ZNBVNO,PNEB,ZNEBS,PQICE,PQLI,&
     & ZQLIS)
  ENDIF

!         Diagnostique de nebulosite partielle.
  CALL ACNPART(YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTNEBU,KLEV,&
   & PAPHI,PAPHIF,PAPRSF,ZDECRD,PNEB,&
   & PCLCH,PCLCM,PCLCL,PCLCT,ZCLCT_RAD,&
   ! optional arguments (convective cloud cover)
   & PCLCC=PCLCC,PNEBC=ZNEBC0,PTOPC=PCTOP)

!     7.3.5 Computation of the equivalent coefficients for simplified
!           radiation scheme

  IF ( LRAYSP .AND.(KSTEP == 1).AND.LRCOEF ) THEN
    DO JLEV=KTDIA,KLEV
      DO JLON=KIDIA,KFDIA
        ZZNEB(JLON,JLEV)=0.0_JPRB
      ENDDO
    ENDDO

    CALL ACRADCOEF ( YDRCOEF,YDPHY3,KIDIA,KFDIA,KLON,KTDIA,KLEV,&
     & PAPRS,PAPRSF,PDELP,ZZNEB,ZQV,ZQCO2,PQICE,PQLI,&
     & ZQO3,PT,&
     & PMMU0,PDHSF,PEMIS,&
     & ZAER,&
     & POMPAC,PAC,PCOR,&
     & PRAB3C,PRAB3N,PRAB4C,PRAB4N,PRAB6C,PRAB6N,&
     & PRAT1C,PRAT1N,PRAT2C,PRAT2N,PRAT3C,PRAT3N,&
     & PRAT4C,PRAT4N,PRAT5C,PRAT5N)
  ENDIF

!     7.3.6 Module chimique - Chemistry module

  IF (LCHEM_ARPCLIM) THEN ! at this stage call when ARPEGE-Climat chemistry only

     ! initialisation below needs to be refined later for more general use
     IFLDX  = 1_JPIM
     IFLDX2 = 1_JPIM
     ILEVX  = 1_JPIM
     ALLOCATE(ZSD_XA(KLON,KLEV,IFLDX), ZSD_X2(KLON,IFLDX2))
     ALLOCATE(INDCHEM(NCHEM),IGPLAT(KLON))
     ALLOCATE(ZCFLX(KLON,NCHEM), ZCFLXO(KLON,NCHEM), ZCHEMDV(KLON,0)) ! no species with dry deposition in ARPCLIM
     ALLOCATE(ZAEROP(KLON,KLEV,NACTAERO),ZTENC(KLON,KLEV,NCHEM))
     ALLOCATE(ZDELP(KLON,KLEV), ZWND(KLON),ZDUMMY1(KLON,KLEV), ZGELAT(KLON))
     ALLOCATE(ZNEEFLX(KLON),ZCHEM2AER(KLON,KLEV,4))
     INDCHEM(:)     = 1_JPIM ! we should have here the indexes of the chemical species in the YCHEM array, to be implemented later
     IGPLAT (:)     = 1_JPIM
     ZSD_XA (:,:,:) = 0._JPRB
     ZSD_X2 (:,:)   = 0._JPRB
     DO JLEV=KTDIA,KLEV
       DO JLON=KIDIA,KFDIA
         ZDELP(JLON,JLEV) = PAPRS(JLON,JLEV) - PAPRS(JLON,JLEV-1)
       ENDDO
     ENDDO
     ZWND  (:)      = 0._JPRB  ! not used in  ARPEGE-Climat chemistry
     ZDUMMY1 (:,:)  = 1.0E-18_JPRB
     ZGELAT(KIDIA:KFDIA) = ASIN(PGEMU(KIDIA:KFDIA))
     ZCFLX (:,:)        = 0._JPRB
     ZCFLXO (:,:)       = 0._JPRB
     ZCHEMDV (:,:)      = 0._JPRB
     ZAEROP (:,:,:)     = 0._JPRB  ! no interaction aerosol/chemistry in ARPCLIM
     ZTENGFL(:,:,:)     = 0._JPRB  ! only used later for diagnostics
     ZTENC (:,:,:)      = 0._JPRB  ! not used in  ARPEGE-Climat chemistry
     ZNEEFLX (:)        = 0._JPRB  ! not used in  ARPEGE-Climat chemistry
     ZCHEM2AER (:,:,:)  = 0._JPRB  ! not used in  ARPEGE-Climat chemistry
     
#if false
 !   YDVAB YDDIMV not used for ARPEGE-Climat chemistry
      CALL CHEM_MAIN &
    &( YDVAB, YDDIMV, YDMODEL, KIDIA , KFDIA , KLON , KLEV, KVCLIS, NCHEM, INDCHEM,&
    &  TSPHY , IGPLAT,  IFLDX  , IFLDX2 , ILEVX,&
    &  ZSD_XA , ZSD_X2,  ZDELP, PAPRS, PAPRSF, PAPHI, PQ, PT,&
    &  ZDUMMY1, ZDUMMY1, ZDUMMY1, ZDUMMY1,  PNEB,& 
    &  PFPLCL, PFPLCN, PFPLSL, PFPLSN, ZDUMMY1,& 
    &  PALB, ZWND, PLSM,& 
    &  PMU0, ZGELAT, PGELAM, PGEMU, PKOZO, ZCFLX, ZCFLXO, ZCHEMDV, PGFL,&
    &  ZAEROP, ZTENGFL, PCHEM, ZTENC, ZNEEFLX, ZCHEM2AER )
#endif     
  ENDIF

  
!      7.4 Rayonnement Geleyn
!          Geleyn's radiation

  IF ( LRAY ) THEN
    SELECT CASE (NRAY)
      CASE(1)
        CALL ACRANEB(YDRIP,YDMODEL%YRML_PHY_MF,&
         & KIDIA,KFDIA,KLON,NTRADI,KLEV,IJN,&
         & PAPHIF,PAPRS,PAPRSF,PCP,PR,PDELP,PNEB,&
         & ZQV,ZQCO2,PQICE,PQLI,ZQO3,PT,&
         & PALB,ZALBDIR,PEMIS,PMU0,PGEMU,PGELAM,PMU0LU,PTS,&
         & PFRSO,PFRTH,&
         & ZFRSODS,PFRSOPS,PFRSOLU,PFRTHDS,ZAER,&
         & ZMAK,ZMAN)

        ! update sunshine duration [s]
!DEC$ IVDEP
        DO JLON=KIDIA,KFDIA
          IF ( PFRSOPS(JLON) > RSUNDUR*PMU0(JLON) ) THEN
            YDMF_PHYS_SURF%GSD_VD%PSUND(JLON)=YDMF_PHYS_SURF%GSD_VD%PSUND(JLON)+TSTEP
          ENDIF
        ENDDO
      CASE(2)
        CALL ACRANEB2(YDERDI,YDRIP,YDMODEL%YRML_PHY_MF,&
         & KIDIA,KFDIA,KLON,NTRADI,KLEV,IJN,KSTEP,KNFRRC,&
         & PAPRS,PAPRSF,PCP,PR,PDELP,PNEB,&
         & ZQV,ZQCO2,PQICE,PQLI,ZQO3,PT,&
         & PALB,ZALBDIR,PEMIS,PGELAM,PGEMU,PMU0,PMU0LU,PTS,ZDECRD,ZCLCT_RAD,&
         & PGDEOSI,PGUEOSI,PGMU0,PGMU0_MIN,PGMU0_MAX,&
         & PGDEOTI,PGDEOTI2,PGUEOTI,PGUEOTI2,PGEOLT,PGEOXT,&
         & PGRPROX,PGMIXP,PGFLUXC,PGRSURF,YDMF_PHYS_SURF%GSD_VD%PSUND,&
         & PFRSO,PFRTH,&
         & PFRSOC,PFRTHC,ZFRSODS,PFRSOPS,PFRSOLU,PFRTHDS,ZAER)
    ENDSELECT

    ! sum downward diffuse and direct solar radiation at surface
    DO JLON=KIDIA,KFDIA
      PFRSODS(JLON)=ZFRSODS(JLON)+PFRSOPS(JLON)
    ENDDO

!      7.5 Rayonnement Morcrette
!          Morcrette's radiation

  ELSEIF ( LRAYFM ) THEN

    LLCALLRAD=(MOD(KSTEP,NRADFR) == 0 )
!    IF (NCALLRAD==1) ! <== not yet
    IF (NCALLRAD==2) LLCALLRAD=(LLCALLRAD.AND.(KSTEP<=NSTOP-1))
!    IF (NCALLRAD==3) ! <== not yet

    ! ---- Intermittent call to radiation scheme
    IF (LLCALLRAD) THEN
      CALL RECMWF(YDGEOMETRY%YRDIMV,YDMODEL,     &
       &  KIDIA , KFDIA, KLON  , KLEV   ,         &
       &  ZALBD , ZALBP, PAPRS , PAPRSF ,         &
       &  PNEB  , ZQO3 , ZAER  , PDELP  , PEMIS , &
       &  PMU0M , ZQV  , PQSAT , PQICE  , PQLI  , & 
       &  ZQS   , ZQR  , YDMF_PHYS_SURF%GSD_VF%PLSM  , PT     , PTS   , &
       &  PGP2DSPP, YDVARS%EZDIAG(YSPP_CONFIG%IEZDIAG_POS)%T0, &
       &  PEMTD , PEMTU, PTRSO ,                   &
       &  PFRTHC, PFRTH, PFRSOC   , PFRSO ,&
       &  ZSFSWDIR     , ZSFSWDIF , ZFSDNN , ZFSDNV,&
       &  ZCTRSO,ZCEMTR, ZTRSOD ,&
       &  ZTRSODIR, ZTRSODIF,&
       &  ZPIZA_DST,ZCGA_DST,ZTAUREL_DST,ZAERINDS,&
       &  PGELAM, PGEMU, PGPAR, PMU0LU , PALB, PVRMOON)
    ELSE
      IF (LMSE) THEN
      DO JSG=1,NSW
        ZTRSODIR(KIDIA:KFDIA,JSG)=PGPAR(KIDIA:KFDIA,MSWDIR+JSG-1)
        ZTRSODIF(KIDIA:KFDIA,JSG)=PGPAR(KIDIA:KFDIA,MSWDIF+JSG-1)
      ENDDO
      ENDIF
    ENDIF

    IF (LRAYLU)  PFRSOLU(KIDIA:KFDIA)=PVRMOON(KIDIA:KFDIA)

    ! ---- Flux update and radiative heating rates
    CALL RADHEAT ( YDERAD,YDERDI,YDMODEL%YRML_PHY_MF, &
    &   KIDIA  , KFDIA  , KLON    , KLEV,&
    &   PAPRS  , PEMIS  , PEMTD   , PMU0, ZQV  ,&
    &   ZTENT  , PTRSO   , ZTRSOD , PTS , TSPHY,&
    &   ZTRSODIR, ZTRSODIF, ZALBD , ZALBP,&
    &   PFRSO  , PFRTH  , PFRSODS , PFRTHDS,&
    &   ZCEMTR , ZCTRSO , PFRSOC  , PFRTHC,&
    &   ZSUDU  , ZSDUR  , ZDSRP  , ZSFSWDIR , ZSFSWDIF, PFRSOPS, ZFRSODS, PFRSOPT )


    ! ---- Take into account day duration depending on altitude.
    IF(LDAYD) CALL ACDAYD(YDRIP,KIDIA,KFDIA,KLON,KLEV,KTDIA,KSGST,PGEMU ,PMU0,PAPHIF,PDELP,PFRSO)

    ! ---- Correct solar absorption as a function of pmu0.
    IF(GRSO < 1._JPRB) CALL ACRSO(YDPHY0,KIDIA,KFDIA,KLON,KLEV,KTDIA,KSGST,PGEMU  ,PMU0,PAPHIF,PDELP,PFRSO)

    IF(.NOT.LMSE) THEN
      DO JLON=KIDIA,KFDIA
        ZALB(JLON)=0.0_JPRB
        DO JSG=1,NSW
          ZALB(JLON)=ZALB(JLON)+0.5_JPRB*(ZALBD(JLON,JSG)+ZALBP(JLON,JSG))
        ENDDO
        ZALB(JLON)=ZALB(JLON)/FLOAT(NSW)
        PFRSODS(JLON)=PFRSO(JLON,KLEV,1)/(1.0_JPRB-ZALB(JLON))
      ENDDO
    ENDIF
    ! Compute Sunshine Duration (in seconds)
!DEC$ IVDEP
    DO JLON=KIDIA,KFDIA
      IF(PFRSODS(JLON) >= RSUNDUR) THEN
        YDMF_PHYS_SURF%GSD_VD%PSUND(JLON)=YDMF_PHYS_SURF%GSD_VD%PSUND(JLON)+1.0_JPRB*TSTEP
      ENDIF
    ENDDO

  ENDIF

  IF (LRAY.OR.LRAYFM ) THEN

    ! Direct normal irradiance with securities
    DO JLON = KIDIA, KFDIA
      PFRSDNI(JLON)=PFRSOPS(JLON)
      IF (PMU0(JLON) > 3.0E-02_JPRB) THEN
        PFRSDNI(JLON)=PFRSOPS(JLON)/PMU0(JLON)
      ENDIF
      PFRSDNI(JLON)=MAX(0.0_JPRB,PFRSDNI(JLON))
    ENDDO
  ENDIF

  IF (LRAY.OR.LRAYFM) THEN

    ! global normal irradiance
    DO JLON=KIDIA,KFDIA
      PFRSGNI(JLON)=PFRSDNI(JLON)+0.5_JPRB*(                         &
       & (1.0_JPRB+PMU0(JLON))*(PFRSODS(JLON)-PFRSOPS(JLON)       )+ &
       & (1.0_JPRB-PMU0(JLON))*(PFRSODS(JLON)-PFRSO  (JLON,KLEV,1)))
    ENDDO

    ! mean radiant temperature
    IF (LXMRT) THEN
      CALL MEAN_RAD_TEMP(KIDIA,KFDIA,KLON,                             &
       & PMU0,PFRSO(1,KLEV,1),PFRSODS,PFRSOPS,PFRTH(1,KLEV,1),PFRTHDS, &
       & PMRT) 
    ENDIF

  ENDIF

!*
!     ------------------------------------------------------------------

!     7.BIS. BILAN HYDRIQUE DU SOL
!     ----------------------------
!     CALCUL DES RESISTANCES A L'EVAPOTRANSPIRATION HV ET
!     A LA TRANSPIRATION
!     ------------------------------------------------------------------
!     HTR DU COUVERT VEGETAL
!     ----------------------

  IF (LSOLV.AND.(.NOT.LMSE)) THEN
    CALL ACVEG ( YDPHY,YDPHY1,KIDIA,KFDIA,KLON,KLEV,&
     & PFRSO,ZQV,PQSAT,PT,&
     & YDMF_PHYS_SURF%GSD_VV%PD2,YDMF_PHYS_SURF%GSD_VF%PLSM,YDMF_PHYS_SURF%GSD_VV%PIVEG,YDMF_PHYS_SURF%GSD_VV%PLAI,PNEIJ,PVEG,YDMF_PHYS_SURF%GSD_VV%PRSMIN,&
     & ZCHROV,ZGWDCS,ZWFC,PWL,ZWWILT,PWP,PQSATS,&
     & ZHQ,ZHTR,ZHU,YDMF_PHYS_SURF%GSD_VV%PHV,ZWLMX)
  ENDIF

!     ------------------------------------------------------------------
!     8.- DIFFUSION VERTICALE TURBULENTE
!     ----------------------------------
  IF ( LVDIF ) THEN

!   Sauvegarde temporaire de l'ancien acdifus pour les besoins du Climat
    IF ( LACDIFUS ) THEN

      IF(NDIFFNEB == 1) THEN
        ZNEBDIFF(:,:)=ZNEBS(:,:)
      ELSEIF(NDIFFNEB == 2) THEN
        ZNEBDIFF(:,:)=PNEB(:,:)
      ELSEIF(NDIFFNEB == 3) THEN
        ZNEBDIFF(:,:)=ZNEBS(:,:)+(1.0_JPRB-ZNEBS(:,:))*ZNEBCH(:,:)
      ENDIF

      CALL ACDIFUS ( YDMCC,YGFL,YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTDIFU,KLEV,KCSS,&
       & PAPHI, PAPHIF, PCP, PDELP, PFRSO, ZKTROV, ZKUROV, ZKNROV,&
       & ZQV, PRDELP, PT, PU, PV, ZXTROV, ZXUROV, ZXPTKEROV, PALPH,&
       & PAPRS, PR, ZQL, ZQI, ZNEBDIFF, PTKE, ZLMU, PLNPR,&
       & PCD, PCDN, ZCDROV, ZCHROV, ZCEROV, PCPS, PCT,ZDQSTS,&
       & PEMIS, YDMF_PHYS_SURF%GSD_VH%PSPSH, ZHQ, ZHTR, ZHU, YDMF_PHYS_SURF%GSD_VV%PHV,&
       & YDMF_PHYS_SURF%GSD_VF%PLSM, YDMF_PHYS_SURF%GSD_VV%PIVEG, PNEIJ, PQS, PQSATS, PTP, PTS, PVEG,&
       & ZXDROV, ZXHROV, PWS, PWSI,&
       & PDIFTQ, PDIFTS, PFCQVNG, PSTRTU, PSTRTV,&
       & PDIFTQL, PDIFTQI, PTENDPTKE,&
       & PFCHSP, PFCLL, PFCLN, PFCS, PFEVI, PFEVL, PFEVN, PFEVV,&
       & PFTR, PLHS, PFRTH, YDMF_PHYS_SURF%GSD_VF%PZ0F, YDMF_PHYS_SURF%GSD_VV%PZ0H)

    ELSE

      IF ( LPTKE ) THEN
        IF ( LMSE.AND.LCALLSFX ) THEN       
          IF (KSTEP == 0) THEN
            PCD(:)=PCDN(:)   ! very first approximation
          ELSE
            PCD(:)=MAX(PGPAR(:,MCD),ZEPS0)
          ENDIF
        ENDIF
        CALL ACPTKE(YGFL,YDLDDH,YDMODEL%YRML_PHY_MF,&
          & KIDIA,KFDIA,KLON,KTDIA,KLEV,KSTEP,&
          & PAPHI,PAPHIF,PDELP,PRDELP,ZKNROV,&
          & PT,PU,PV,PALPH,&
          & PAPRS,PAPRSF,PR,PTKE,ZLMU,PLNPR,ZF_EPS,ZFUN_TTE,&
          & ZMRIPP,ZMRIFPP,ZRHS,&
          & ZMN2_ES,ZMN2_EQ,ZRRCOR,YDVARS%FQTUR%T0,YDVARS%FSTUR%T0,YDVARS%SHTUR%T0,&
          & PCD,PGZ0,&
          & ZKUROV,ZKTROV,ZXPTKEROV,&
          & ZLMLTILD,YDVARS%MXL%T0,ZLML,&
          & ZTH_FUN,ZWW_FUN,&
          & PTENDPTKE,YDVARS%TTE%T0,PFTCNS)
      ENDIF

      CALL ACDIFV1 ( YGFL,YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,KTDIA,KLEV,&
        & PAPHIF,PAPRSF,ZCP,PDELP,ZKTROV,ZKQROV,ZKUROV,&
        & ZQV,ZQL,ZQI,PRDELP,PT,PU,PV,ZSVM,ZXTROV,ZXUROV,&
        & ZXDROV,ZXHROV,&
        & ZEDMFS,ZEDMFQ,ZEDMFU,ZEDMFV,ZMF_UP, &
        & ZXURO,ZXQRO,ZXTRO,&
        & ZCFAQ,ZCFAS,ZCFATH,ZCFAU,ZCFASV,&
        & ZCFBQ,ZCFBS,ZCFBTH,ZCFBU,ZCFBV,ZCFBSV,&
        & ZDSE,ZQT)   
        

      IF ( LMSE.AND.LCALLSFX ) THEN

        IF (LRAYFM) THEN
          ZCARDI=RCARDI
        ELSEIF (LRAY) THEN
          ZCARDI=QCO2
          DO JLON=KIDIA,KFDIA
            ZSFSWDIF(JLON,1)=ZFRSODS(JLON)
            ZSFSWDIR(JLON,1)=PFRSOPS(JLON)
          ENDDO
        ENDIF

        DO JLON=KIDIA,KFDIA
          ZRHODREFM(JLON)=PAPRSF(JLON,KLEV)/(PT(JLON,KLEV)*PR(JLON,KLEV))
          ZDEPTH_HEIGHT(JLON,:)=(PAPHIF(JLON,:)-PAPHI(JLON,KLEV))/RG
          ZZS(JLON)=PAPHI(JLON,KLEV)/RG
        ENDDO

        IRR=2

        CALL ARO_GROUND_PARAM( KBL, KGPCOMP,&
          & KFDIA-KIDIA+1, KIDIA, KFDIA, KSTEP,&
          & IRR, NSW, NGFL_EXT,NDGUNG, NDGUXG, NDLUNG, NDLUXG,LSURFEX_KFROM,&
          & LMPA, CCOUPLING,LDXFUMSE, &
          & NINDAT, ZRHGMT,ZSTATI,RSOVR,RCODEC,RSIDEC, &
          & PINDX(KIDIA:KFDIA), PINDY(KIDIA:KFDIA), &
          & PU(KIDIA:KFDIA,KLEV:KLEV),PV(KIDIA:KFDIA,KLEV:KLEV), &
          & PT(KIDIA:KFDIA,KLEV:KLEV),PQ(KIDIA:KFDIA,KLEV:KLEV),&
          & ZSVM(KIDIA:KFDIA,KLEV:KLEV,1:NGFL_EXT),&
          & ZCARDI,&
          & ZRHODREFM(KIDIA:KFDIA),&
          & PAPRSF(KIDIA:KFDIA,KLEV:KLEV),PAPRS(KIDIA:KFDIA,KLEV:KLEV),&
          & ZDTMSE,ZDEPTH_HEIGHT(KIDIA:KFDIA,KLEV),ZZS(KIDIA:KFDIA), XZSEPS,&
          & PMU0(KIDIA:KFDIA),PMU0N(KIDIA:KFDIA),PGELAM(KIDIA:KFDIA),&
          & PGEMU(KIDIA:KFDIA),XSW_BANDS,&
          & ZSRAIN(KIDIA:KFDIA),ZSSNOW(KIDIA:KFDIA),&
          & ZSGROUPEL(KIDIA:KFDIA),&
          & PFRTHDS(KIDIA:KFDIA),ZSFSWDIF(KIDIA:KFDIA,1:NSW),&
          & ZSFSWDIR(KIDIA:KFDIA,1:NSW),&
          & ZCFAQ(KIDIA:KFDIA,KLEV:KLEV), ZCFATH(KIDIA:KFDIA,KLEV:KLEV),&
          & ZCFAU(KIDIA:KFDIA,KLEV:KLEV),&
          & ZCFBQ(KIDIA:KFDIA,KLEV:KLEV), ZCFBTH(KIDIA:KFDIA,KLEV:KLEV),&
          & ZCFBU(KIDIA:KFDIA,KLEV:KLEV),&
          & ZCFBV(KIDIA:KFDIA,KLEV:KLEV),&
          & PFCS(KIDIA:KFDIA,1),ZFEV(KIDIA:KFDIA),&
          & ZSFSV(KIDIA:KFDIA,1:NGFL_EXT),ZSFCO2(KIDIA:KFDIA),&
          & ZFMDU(KIDIA:KFDIA),ZFMDV(KIDIA:KFDIA),&
          & ZALBP(KIDIA:KFDIA,1:NSW),ZALBD(KIDIA:KFDIA,1:NSW),&
          & PEMIS(KIDIA:KFDIA),ZTSN(KIDIA:KFDIA),&
          & PFRTH(KIDIA:KFDIA,KLEV,1))               !orographic shadowing

! Opposite water vapor flux
        ZFEVS(:)=-ZFEV(:)

        CALL ARO_GROUND_DIAG( KBL, KGPCOMP,&
          & KFDIA-KIDIA+1, KIDIA, KFDIA, KLEV, -1,&
          & NDGUNG, NDGUXG, NDLUNG, NDLUXG, LSURFEX_KFROM,&
          & ZZS(KIDIA:KFDIA),ZFEVS(KIDIA:KFDIA),&
          & PU(KIDIA:KFDIA,1:KLEV), PV(KIDIA:KFDIA,1:KLEV),&
          & ZDEPTH_HEIGHT(KIDIA:KFDIA,1:KLEV),&
          & PFRTH(KIDIA:KFDIA,KLEV,1),PFRSO(KIDIA:KFDIA,KLEV,1),&
          & PINDX(KIDIA:KFDIA), PINDY(KIDIA:KFDIA),&
          & PQS(KIDIA:KFDIA), PGZ0(KIDIA:KFDIA),&
          & PGZ0H(KIDIA:KFDIA), PTCLS (KIDIA:KFDIA),&
          & PQCLS(KIDIA:KFDIA), PRHCLS(KIDIA:KFDIA),&
          & PUCLS(KIDIA:KFDIA), PVCLS(KIDIA:KFDIA),&
          & PNUCLS(KIDIA:KFDIA), PNVCLS(KIDIA:KFDIA), &
          & PFCLL(KIDIA:KFDIA,1), PFCLN(KIDIA:KFDIA,1),&
          & PFEVL(KIDIA:KFDIA,1), PFEVN(KIDIA:KFDIA,1),&
          & ZSSO_STDEV(KIDIA:KFDIA), ZTWSNOW(KIDIA:KFDIA),&
          & ZBUDTH(KIDIA:KFDIA), ZBUDSO(KIDIA:KFDIA),&
          & ZFCLL(KIDIA:KFDIA),ZTOWNS(KIDIA:KFDIA),&
          & ZCD(KIDIA:KFDIA)                        )

        DO JLON=KIDIA,KFDIA
          PGPAR(JLON,MGZ0)   = PGZ0 (JLON)
          PGPAR(JLON,MGZ0H)  = PGZ0H(JLON)
          PGPAR(JLON,MVEMIS) = PEMIS(JLON)
          PGPAR(JLON,MVQS)   = PQS  (JLON)
          PGPAR(JLON,MCD)    = ZCD  (JLON)
        ENDDO

        DO JSG=1,NSW
          PGPAR(:,MALBSCA-1+JSG) = ZALBD(:,JSG)
          PGPAR(:,MALBDIR-1+JSG) = ZALBP(:,JSG)
        ENDDO

        DO JSG  = 1, KSGST+1
          DO JLEV = 0, KLEV
            DO JLON = KIDIA, KFDIA
              PFRTH(JLON,JLEV,JSG)=PFRTH(JLON,JLEV,JSG)+ZBUDTH(JLON)
            ENDDO
          ENDDO
        ENDDO

! calculation of variables for the old "ISBA" atmosphere scheme
        IF (.NOT. LELAM) THEN
          CALL ARO_GROUND_DIAG_2ISBA( KBL, KGPCOMP, &
            & KFDIA-KIDIA+1, KIDIA, KFDIA, &
            & NDGUNG, NDGUXG, NDLUNG, NDLUXG, LSURFEX_KFROM, &
            & PINDX(KIDIA:KFDIA), PINDY(KIDIA:KFDIA), &
            & YDMF_PHYS_SURF%GSD_VF%PLSM, YDMF_PHYS_SURF%GSD_VV%PARG, YDMF_PHYS_SURF%GSD_VV%PSAB, YDMF_PHYS_SURF%GSD_VV%PD2, ZTSN, ZTWSNOW, &
            & YDMF_PHYS_SURF%GSP_SB%PT_T1(KIDIA:KFDIA,1), YDMF_PHYS_SURF%GSP_RR%PW_T1(KIDIA:KFDIA), YDMF_PHYS_SURF%GSP_SB%PQ_T1(KIDIA:KFDIA,1), &
            & YDMF_PHYS_SURF%GSP_RR%PIC_T1(KIDIA:KFDIA), YDMF_PHYS_SURF%GSP_SB%PTL_T1(KIDIA:KFDIA,1), YDMF_PHYS_SURF%GSP_RR%PFC_T1(KIDIA:KFDIA), &
            & YDMF_PHYS_SURF%GSP_SG%PA_T1(KIDIA:KFDIA,1), YDMF_PHYS_SURF%GSP_SG%PR_T1(KIDIA:KFDIA,1), ZHV2 )
          DO JLON=KIDIA,KFDIA
            YDMF_PHYS_SURF%GSD_VV%PHV(JLON) = ZHV2(JLON)
          ENDDO
        ENDIF

        IF (LDIFCONS.AND..NOT.LNODIFQC) THEN
          CALL ACAA1 ( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,KTDIA,KLEV,&
            & PAPRS,ZCOEFN,PCP,ZQL,ZQI,PT,&
            & ZALPHA1,ZCOEFA,ZLVT,ZQICE)
        ENDIF

      ELSEIF (.NOT.LMSE) THEN

        IF(NDIFFNEB == 5) THEN
          ZNEBDIFF(:,:)=ZNEBS(:,:)
        ELSEIF(NDIFFNEB == 2) THEN
          ZNEBDIFF(:,:)=PNEB(:,:)
        ELSEIF(NDIFFNEB == 3) THEN
          ZNEBDIFF(:,:)=ZNEBS(:,:)+(1.0_JPRB-ZNEBS(:,:))*ZNEBCH(:,:)
        ENDIF

        IF (.NOT. LSFORCS) THEN
          IF (LEDMFI) THEN
            ZCFBS_G(:,:) = ZCFBS(:,:)
            ZCFBQ_G(:,:) = ZCFBQ(:,:) 
            ZCFBU_G(:,:) = ZCFBU(:,:)
            ZCFBV_G(:,:) = ZCFBV(:,:)
          ENDIF   
          CALL ARP_GROUND_PARAM ( YDMCC,YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,KTDIA,KLEV,KCSS,&
           & PAPHI,ZCP,PFRSO,&
           & ZQV,PRDELP,PT,PU,PV,ZXURO,ZXQRO,ZXTRO,&
           & PAPRS,ZQL,ZQI,ZNEBDIFF,&
           & PCD,PCDN,ZCDROV,ZCHROV,ZCEROV,PCPS,PCT,ZDQSTS,PEMIS,YDMF_PHYS_SURF%GSD_VH%PSPSH,&
           & ZHQ,ZHTR,ZHU,YDMF_PHYS_SURF%GSD_VV%PHV,YDMF_PHYS_SURF%GSD_VF%PLSM,YDMF_PHYS_SURF%GSD_VV%PIVEG,PNEIJ,PQS,PQSATS,&
           & PTP,PTS,PVEG,ZXDROV,ZXHROV,PWS,PWSI,&
           & ZDSE,&
           & ZCFAS,ZCFAU,&
           & ZCFBS,ZCFBU,ZCFBV,&
           & ZCFBQ,ZCOEFA,ZALPHA1,ZLVT,ZQICE,&
           & ZDIFWQ,ZDIFWS,ZFMDU,ZFMDV,&
           & ZSC_FEVI,ZSC_FEVN,ZSC_FCLL,ZSC_FCLN,&
           & PFCHSP,PFCLL,PFCLN,PFCS,PFEVI,PFEVL,PFEVN,&
           & PFEVV,PFTR,PLHS,YDMF_PHYS_SURF%GSD_VH%PQSH,&
           & PFRTH,&
           & YDMF_PHYS_SURF%GSD_VF%PZ0F,YDMF_PHYS_SURF%GSD_VV%PZ0H)

          DO JLON=KIDIA,KFDIA
            PDIFTQ(JLON,KLEV)=ZDIFWQ(JLON)
            PDIFTS(JLON,KLEV)=ZDIFWS(JLON)
          ENDDO

          IF (LEDMFI) THEN
            ZCFBQ(:,:)  = ZCFBQ_G(:,:)
            ZCFBS(:,:)  = ZCFBS_G(:,:) 
            ZCFBU(:,KLEV)  = ZCFBU_G(:,KLEV)
            ZCFBV(:,KLEV)  = ZCFBV_G(:,KLEV) 
          ENDIF   

        ENDIF   ! <== LSFORCS

      ELSEIF (.NOT. LCALLSFX) THEN
        PFCS(:,:) = 0.0_JPRB
        ZFEV(:)   = 0.0_JPRB

      ENDIF  !LMSE.AND.LCALLSFX

      CALL ACDIFV2 ( YGFL,YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,KTDIA,KLEV,&
        & PAPRS,ZCFAQ,ZCFAS,ZCFAU,ZCFASV,ZCFBQ,ZCFBS,ZCFBU,ZCFBV,ZCFBSV,&
        & ZKTROV,ZKQROV,ZKQLROV,ZKUROV,ZDSE,ZQT,PU,PV,ZPOID,&
        & PT,ZQL,ZQI,PRDELP,&
        & ZCOEFA,ZALPHA1,ZLVT,ZQICE,&
        & ZSFSV,PFCS,ZFEV,ZFMDU,ZFMDV,ZTSN,ZXHROV,&
        & PDIFSV,PDIFTQ,PDIFTS,PSTRTU,PSTRTV,PDIFTQL,PDIFTQI,PDIFCQ,PDIFCS,PSTRCU,PSTRCV,YDVARS%SHTUR%T0)

      IF (LEDKF) THEN
        IF (LSFORCS) THEN
        DO JLON=KIDIA,KFDIA
           YDMF_PHYS_SURF%GSD_SFL%PGROUP(JLON,1) = PFCS(JLON,1)
           YDMF_PHYS_SURF%GSD_SFL%PGROUP(JLON,2) = ZFEV(JLON)
        ENDDO
        ELSE
          DO JLON=KIDIA,KFDIA             
            YDMF_PHYS_SURF%GSD_SFL%PGROUP(JLON,1) = PDIFTS(JLON,KLEV)
            YDMF_PHYS_SURF%GSD_SFL%PGROUP(JLON,2) = PDIFTQ(JLON,KLEV)
          ENDDO
        ENDIF   
      ENDIF

      IF ( LMSE ) THEN
        DO JLON=KIDIA,KFDIA
          PGPAR(JLON,MVTS) = ZTSN (JLON)
          YDMF_PHYS_SURF%GSP_SG%PF_T1(JLON,1) = ZTWSNOW (JLON)
        ENDDO
      ENDIF

      ! First compute horizontal exchange coefficients for momentum:
      !  (there's mo TOMs contribution, thus has to be done at latest here)
      IF (L3DTURB) THEN
        CALL ACTKECOEFKH(YDRIP,YDMODEL%YRML_PHY_MF,YDGEOMETRY%YREGEO,KIDIA,KFDIA,KLON,KTDIA,KLEV,&
          & PTKE, PTENDPTKE, PAPHI, PAPHIF, PT, PU, PV, PALPH,&
          & PDIV, PVORT0, PUL, PVL, PWW, PWWL, PWWM, PAPRS, PR, PLNPR,&
          & ZLML, ZFHORM, ZFHORH, ZKUROV,&
          & ZRTI, PCD, ZCDROV,&
          & LPTKE, PKUROV_H, PKTROV_H, ZRHS)
      ENDIF

      IF (LCOEFKTKE) THEN
        IF (NDIFFNEB == 1) THEN
          ZCOEFA(:,:) = ZBNEBQ(:,:)
        ELSEIF (NDIFFNEB == 4) THEN
          ZCOEFA(:,:) = ZBNEBCVPP(:,:)
        ENDIF
        CALL ACDIFV3 ( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,KTDIA,KLEV,KSTEP,&
          & PAPRS,PAPHI,PAPHIF,ZCP,PDELP,ZKTROV,ZXTROV,&
          & PR,PRDELP,ZCHROV,ZXHROV,&
          & ZCOEFA,ZQV,ZQL,ZQI,PU,PV,PT,PALPH,PLNPR,&
          & ZLML, ZTH_FUN,ZWW_FUN, ZF_EPS,&
          & PDIFTS,PDIFTQ,PTKE,PTENDPTKE,&
          & ZMN2_ES,ZMN2_EQ,ZMN2_DS,ZMN2_DQ,&
          & PDIFTQL,PDIFTQI,&
          & ZDIFWQ,ZDIFWS,&
          & PFCLL,PFCLN,PFCS,PFEVI,PFEVL,PFEVN,&
          & PGZ0,ZRTI,&
          & ZSC_FEVI,ZSC_FEVN,ZSC_FCLL,ZSC_FCLN,&
          & ZTSTAR,ZTSTAR2,ZTSTARQ,ZTSTAR2Q)

        !store fluxes and shear term
        !GFL fields are on full levels, fluxes on half levels
        IF (YFQTUR%LGP.AND.YFSTUR%LGP) THEN
          DO JLEV=KTDIA,KLEV
            DO JLON=KIDIA,KFDIA
              YDVARS%FQTUR%T0(JLON,JLEV)=PDIFTQ(JLON,JLEV)+PDIFTQL(JLON,JLEV)&
               &                                 +PDIFTQI(JLON,JLEV)
              YDVARS%FSTUR%T0(JLON,JLEV)=PDIFTS(JLON,JLEV)
            ENDDO
          ENDDO
        ENDIF
      ENDIF ! LCOEFKTKE

      ! Now the heat coefficient can be completed by TKE+ containing
      !  the TOMs contribution. 
      IF (L3DTURB) THEN
        CALL ACTKECOEFKH(YDRIP,YDMODEL%YRML_PHY_MF,YDGEOMETRY%YREGEO,KIDIA,KFDIA,KLON,KTDIA,KLEV,&
          & PTKE, PTENDPTKE, PAPHI, PAPHIF, PT, PU, PV, PALPH,&
          & PDIV, PVORT0, PUL, PVL, PWW, PWWL, PWWM, PAPRS, PR, PLNPR,&
          & ZLML, ZFHORM, ZFHORH, ZKUROV,&
          & ZRTI, PCD, ZCDROV,&
          & LPTKE, PKUROV_H, PKTROV_H, ZRHS)
      ENDIF

    ENDIF

!-----------------------------------------------------------------------------
!   THE DEEP CONVECTION WILL SEE THE SHALLOW PART FROM KFB AS IT IS WITH LOUIS
!   SCHEME AND THE MODIFIED RI
!----------------------------------------------------------------------------
    IF (LCVPPKF.OR.(LEDKF .AND. .NOT. LEDMFI)) THEN
      DO JLEV=KTDIA,KLEV
        DO JLON=KIDIA,KFDIA
          PDIFTQ   (JLON,JLEV) = PDIFTQ(JLON,JLEV) + ZDIFCVPPQ(JLON,JLEV)
          PDIFTS   (JLON,JLEV) = PDIFTS(JLON,JLEV) + ZDIFCVPPS(JLON,JLEV)
          PSTRTU   (JLON,JLEV) = PSTRTU(JLON,JLEV) + ZDIFCVPPU(JLON,JLEV)
          PSTRTV   (JLON,JLEV) = PSTRTV(JLON,JLEV) + ZDIFCVPPV(JLON,JLEV)
        ENDDO
      ENDDO
    ENDIF

    IF (L3MT) THEN

    ! ------------------------------------------------------------------
    ! UPDATE TEMPERATURE, LIQUID WATER AND ICE BY THE TURBULENT FLUXES
    ! INCLUDING CORRECTION OF NEGATIVE VALUES OF WATER SPECIES
    ! SAVE THE INCREMENTAL PART DUE TO THE TURBULENT DIFFUSION PROCESSES
    ! ------------------------------------------------------------------

!   setup of auxiliary variables for water vapour updating for RK condensation scheme

    IF(LRKCDEV) THEN
      ZDTURDIFF=1._JPRB
      IF (LCVGQD) ZDTURDIFF=0._JPRB
    ENDIF

!cdir unroll=8
    DO JLEV = KTDIA,KLEV
!DEC$ IVDEP
      DO JLON = KIDIA,KFDIA

        ZT(JLON,JLEV)=PT(JLON,JLEV)-ZIPOI(JLON,JLEV)/PCP(JLON,JLEV)&
         & *(PDIFTS(JLON,JLEV)-PDIFTS(JLON,JLEV-1))
        ZQX0=ZQI(JLON,JLEV)
        ZQX1=ZQX0-ZIPOI(JLON,JLEV)*(PDIFTQI(JLON,JLEV)&
          & -PDIFTQI(JLON,JLEV-1))
        ZQI(JLON,JLEV)=MAX(0.0_JPRB,ZQX1)
        ZDQI=MAX(0.0_JPRB,ZQX1)-ZQX1
        ZFCQING(JLON,JLEV)=ZFCQING(JLON,JLEV-1)-ZDQI*ZPOID(JLON,JLEV)
        PFCQING(JLON,JLEV)=PFCQING(JLON,JLEV)+ZFCQING(JLON,JLEV)
        ZQX0=ZQL(JLON,JLEV)
        ZQX1=ZQX0-ZIPOI(JLON,JLEV)*(PDIFTQL(JLON,JLEV)&
          & -PDIFTQL(JLON,JLEV-1))
        ZQL(JLON,JLEV)=MAX(0.0_JPRB,ZQX1)
        ZDQL= MAX(0.0_JPRB,ZQX1)-ZQX1
        ZFCQLNG(JLON,JLEV)=ZFCQLNG(JLON,JLEV-1)-ZDQL*ZPOID(JLON,JLEV)
        PFCQLNG(JLON,JLEV)=PFCQLNG(JLON,JLEV)+ZFCQLNG(JLON,JLEV)
        ZDQC=ZDQI+ZDQL

        ZQX0=ZQV(JLON,JLEV)
        ZQX1=ZQX0-ZIPOI(JLON,JLEV)*(PDIFTQ(JLON,JLEV)&
          & -PDIFTQ(JLON,JLEV-1))
        ZQV0=ZQX1-ZIPOI(JLON,JLEV)*(0.0_JPRB&
          & -ZFCQVNG(JLON,JLEV-1)-ZFCQING(JLON,JLEV-1)&
          & -ZFCQLNG(JLON,JLEV-1))
        IF(LCVGQD) THEN
          ZQV(JLON,JLEV)=MAX(0.0_JPRB,ZQV0-ZDQC)
        ENDIF
        ZDQV=MAX(0.0_JPRB,ZQV0-ZDQC)-ZQX1
        ZDQVDIFF(JLON,JLEV)=ZDQV+ZQX1-ZQX0
        ZFCQVNG(JLON,JLEV)=ZFCQVNG(JLON,JLEV-1)-ZDQV*ZPOID(JLON,JLEV)
        PFCQVNG(JLON,JLEV)=PFCQVNG(JLON,JLEV)+ZFCQVNG(JLON,JLEV)
        IF(LRKCDEV.AND.KSTEP>0) THEN
          ZDTRAD(JLON,JLEV)=ZIPOI(JLON,JLEV)/PCP(JLON,JLEV)* (&
            & PFRSO(JLON,JLEV-1,1)-PFRSO(JLON,JLEV,1)&
            & +PFRTH(JLON,JLEV-1,1)-PFRTH(JLON,JLEV,1) )
          ZRKTTEND(JLON,JLEV)=(ZT(JLON,JLEV)-YDVARS%RKTH%T0(JLON,JLEV)&
             & +ZDTRAD(JLON,JLEV))/TSPHY
          ZRKQVTEND(JLON,JLEV)=(MAX(0._JPRB,ZQV(JLON,JLEV)&
             & +ZDQVDIFF(JLON,JLEV)*ZDTURDIFF)&
             & -MAX(0._JPRB,YDVARS%RKTQV%T0(JLON,JLEV)))/TSPHY
          ZRKQCTEND(JLON,JLEV)= (MAX(0._JPRB,ZQI(JLON,JLEV)+ZQL(JLON,JLEV))&
             & -MAX(0._JPRB,YDVARS%RKTQC%T0(JLON,JLEV)))/TSPHY
        ENDIF
      ENDDO
    ENDDO

    ELSEIF (LSTRAPRO) THEN

    ! ------------------------------------------------------------------
    ! UPDATE THE CORRECTION FLUXES FOR NEGATIVE VALUES OF WATER SPECIES
    ! SAVE THE INCREMENTAL PART DUE TO THE TURBULENT DIFFUSION PROCESSES
    ! ------------------------------------------------------------------
    DO JLEV = KTDIA, KLEV
      DO JLON = KIDIA,KFDIA

        ZT (JLON,JLEV)= PT(JLON,JLEV)
        ZQX0=ZQI(JLON,JLEV)
        ZQX1=ZQX0-ZIPOI(JLON,JLEV)*(PDIFTQI(JLON,JLEV)&
          & -PDIFTQI(JLON,JLEV-1))
        ZDQI= MAX(0.0_JPRB,ZQX1)-ZQX1
        ZFCQING(JLON,JLEV)=ZFCQING(JLON,JLEV-1)-ZDQI*ZPOID(JLON,JLEV)
        PFCQING(JLON,JLEV)=PFCQING(JLON,JLEV)+ZFCQING(JLON,JLEV)
        ZQX0=ZQL(JLON,JLEV)
        ZQX1=ZQX0-ZIPOI(JLON,JLEV)*(PDIFTQL(JLON,JLEV)&
          & -PDIFTQL(JLON,JLEV-1))
        ZDQL= MAX(0.0_JPRB,ZQX1)-ZQX1
        ZFCQLNG(JLON,JLEV)=ZFCQLNG(JLON,JLEV-1)-ZDQL*ZPOID(JLON,JLEV)
        PFCQLNG(JLON,JLEV)=PFCQLNG(JLON,JLEV)+ZFCQLNG(JLON,JLEV)
        ZDQC=ZDQI+ZDQL

        ZQX0=ZQV(JLON,JLEV)
        ZQX1=ZQX0-ZIPOI(JLON,JLEV)*(PDIFTQ(JLON,JLEV)&
          & -PDIFTQ(JLON,JLEV-1))
        ZQV0=ZQX1-ZIPOI(JLON,JLEV)*(0.0_JPRB&
          & -ZFCQVNG(JLON,JLEV-1)-ZFCQING(JLON,JLEV-1)&
          & -ZFCQLNG(JLON,JLEV-1))
        ZDQV=MAX(0.0_JPRB,ZQV0-ZDQC)-ZQX1
        ZFCQVNG(JLON,JLEV)=ZFCQVNG(JLON,JLEV-1)-ZDQV*ZPOID(JLON,JLEV)
        PFCQVNG(JLON,JLEV)=PFCQVNG(JLON,JLEV)+ZFCQVNG(JLON,JLEV)

      ENDDO
    ENDDO

    ENDIF ! 3MT || LSTRAPRO

    ! ------------------------------------------------------
    ! DIAGNOSTIC DE LA HAUTEUR DE COUCHE LIMITE, SELON TROEN ET MAHRT,
    ! POUR USAGE AU PAS DE TEMPS SUIVANT.
    ! ------------------------------------------------------

    IF((TRIM(CGMIXLEN) == 'TM').OR.(TRIM(CGMIXLEN) == 'TMC')) THEN
      ZBLH(KIDIA:KFDIA)=MIN(XMAXLM,MAX(XMINLM,YDMF_PHYS_SURF%GSD_VH%PPBLH(KIDIA:KFDIA)))
      CALL ACPBLHTM ( YDPHY0,KIDIA,KFDIA,KLON,NTDIFU,KLEV,&
       & PAPHI, PAPHIF, PDELP, PCP,&
       & ZQV, PT, PU, PV,PAPRSF,PR,&
       & PSTRTU, PSTRTV,&
       & ZPCLS, PTCLS,PQCLS,&
       & PFCS,PFCLL,PFCLN,PLHS, PGZ0,&
       & KCLPH,ZBLH,ZUGST,ZVGST)
      YDMF_PHYS_SURF%GSD_VH%PPBLH(KIDIA:KFDIA)=ZBLH(KIDIA:KFDIA)
      PCLPH(KIDIA:KFDIA)=ZBLH(KIDIA:KFDIA)
      IF (.NOT.LRAFTUR) THEN
        PUGST(KIDIA:KFDIA)=ZUGST(KIDIA:KFDIA)
        PVGST(KIDIA:KFDIA)=ZVGST(KIDIA:KFDIA)
      ENDIF
    ENDIF

    IF(LNEBCO.AND.LNEBR)THEN
      DO JLON = KIDIA,KFDIA
        ZPREN(JLON)=PAPRS(JLON,KLEV)
      ENDDO
      CALL ACPBLH ( YDPHY0,KIDIA,KFDIA,KLON,NTDIFU,KLEV,&
       & PAPHI, PAPHIF, PCP,&
       & ZQV, PT, PU, PV,PAPRSF,&
       & PSTRTU, PSTRTV,&
       & ZPREN, PTS, PQS,&
       & PFCS,PFCLL,PFCLN,PLHS,ZRTI,YDMF_PHYS_SURF%GSD_VH%PPBLH)
    ENDIF
    ! ------------------------------------------------------------------
    ! UPDATE PASSIFS SCALAIRS DUE TO THE TURBULENT DIFFUSION PROCESSES
    ! ------------------------------------------------------------------
    IF (LMDUST.AND.(NGFL_EXT/=0)) THEN
      DO JGFL=1,NGFL_EXT
        DO JLON=1,KLON
          DO JLEV=1,KLEV
            ZSVM(JLON,JLEV,JGFL)=ZSVM(JLON,JLEV,JGFL)-ZIPOI(JLON,JLEV)&
          & *(PDIFSV(JLON,JLEV,JGFL)-PDIFSV(JLON,JLEV-1,JGFL))
            ZSVM(JLON,JLEV,JGFL)=MAX(ZSVM(JLON,JLEV,JGFL),0.0_JPRB)
          ENDDO
        ENDDO
      ENDDO
    ENDIF  ! LMDUST
  ENDIF ! LVDIF

!     DIAGNOSTIC SUPPLEMENTAIRE FLUX DE RAYONNEMENT (PFRTHDS ET PFRSOPT)
!     ADDITIONAL DIAGNOSTICS OF RADIATIVE FLUXES (PFRTHDS AND PFRSOPT)

!DEC$ IVDEP
  DO JLON=KIDIA,KFDIA
    IF(.NOT.LMSE)PFRTHDS(JLON)=PFRTH(JLON,KLEV,1)/PEMIS(JLON)+RSIGMA*PTS(JLON)**4
    IF(PMU0(JLON) <= 0.0_JPRB) THEN

!     NUIT : FLUX SOLAIRE NUL
!     NIGHT: SOLAR FLUX IS EQUAL TO ZERO

      PFRSOPT(JLON)=0.0_JPRB
    ELSE
      PFRSOPT(JLON)=RII0*PMU0(JLON)
    ENDIF
  ENDDO

! ADDITIONAL DIAGNOSTIC OF THE DERIVATIVE OF THE NON SOLAR SURFACE
! HEAT FLUX WITH RESPECT TO SURFACE TEMPERATURE (PDERNSHF)

  IF(LMCC03)THEN
    CALL ACDNSHF(YDPHY,YDPHY1,KIDIA, KFDIA, KLON, KTDIA, KLEV,&
     & PEMIS, YDMF_PHYS_SURF%GSD_VF%PLSM, PNEIJ, ZQV, PQS, PTS, ZCHROV,  ZDQSTS,&
     & PDERNSHF)
  ENDIF

!*
!     ------------------------------------------------------------------
!     9.- TRAINEE DES ONDES DE GRAVITE INDUITES PAR LE RELIEF
!     ------------------------------------------------------------------
  IF ( LGWD ) THEN
    CALL ACDRAG ( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTDRAG,KLEV,&
     & PAPRS, PAPRSF,&
     & PDELP, ZNBVNO, PRDELP, PU, PV,&
     & PRCORI,YDMF_PHYS_SURF%GSD_VF%PGETRL, ZGWDCS,&
     & YDMF_PHYS_SURF%GSD_VF%PVRLAN , YDMF_PHYS_SURF%GSD_VF%PVRLDI,&
     & PSTRDU, PSTRDV,ZTRAJGWD)
  ENDIF
 ! SAVE FOR TL/NL COEFS FROM VERT. DIFF AND GWD

  IF (LTRAJPS.AND.(LVDIFSPNL.OR.LGWDSPNL)) THEN


     IF(.NOT.LVDIFSPNL) THEN
       ZKTROV_SAVE(:,:)=0.0_JPRB
       ZKUROV_SAVE(:,:)=0.0_JPRB
       ZCDROV_SAVE(:)=0.0_JPRB
       ZCHROV_SAVE(:)=0.0_JPRB
     ENDIF
     IF(.NOT. LGWDSPNL) THEN
       ZTRAJGWD(:,:)=0.0_JPRB
     ENDIF

     CALL WRPHTRAJTM_NL(YDGEOMETRY,YDSIMPHL,KIDIA,KFDIA,PTRAJ_PHYS,&
                & ZKTROV_SAVE,ZKUROV_SAVE,&
                & ZCDROV_SAVE,ZCHROV_SAVE,ZTRAJGWD,&
                & PQL,PQI,PQRRES,PQSRES,ZQLIS,ZNEBS)
  ENDIF

!     ------------------------------------------------------------------
!     10.- PRECIPITATIONS STRATIFORMES.
!     ---------------------------------

  IF ( LSTRA.AND.(.NOT.LSTRAPRO) ) THEN
    CALL ACPLUIE ( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTPLUI,KLEV,&
     & PAPRS, PDELP,&
     & ZQV, PQW, PT,&
     & PFPFPSL,PFPFPSN,PFCSQL,PFCSQN,PFPEVPSL,PFPEVPSN,PFPLSL,PFPLSN)
  ENDIF

  IF ( LSTRAS ) THEN
    CALL ACPLUIS ( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTPLUI,KLEV,&
     & PAPRSF,PDELP,ZNEBS,ZQV,ZQLIS,PQW,PR,PT,&
     & PFCSQL,PFCSQN,PFPLSL,PFPLSN,PFPEVPSL,PFPEVPSN,PFPFPSL,PFPFPSN)
  ENDIF

  IF (L3MT.OR.LSTRAPRO) THEN

    IF (LCOEFKTKE.OR.LLREDPR) THEN
      CALL ACTQSATS ( YDPHY,YDPHY0,KIDIA,KFDIA,KLON,NTQSAT,KLEV,&
       & PAPRSF, PCP, ZQV, ZT,&
       & ZGEOSLC, ZLH, ZLSCPE, ZQSAT, ZQW, ZRH, ZTW)
      CALL ACNEBCOND ( YDRIP,YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTPLUI,KLEV,LLREDPR,&
       & ZHUC,ZVETAF,PAPHI,PAPHIF,PAPRSF,PCP,PR,PDELP,PRH,ZBLH,ZQV,ZQI,ZQL,&
       & ZQW,ZT,ZNEBCH,PGM,PTS,&
       & ZQLIS,ZNEBS,ZRHCRI,ZRH,ZQSATS,ZICEFR1,ZQLIS0,ZNEBS0)
      CALL ACCDEV ( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTPLUI,KLEV,&
       & ZVETAF,PAPHI,&
       & PAPRS,PAPRSF,PCP,PDELP,ZQV,ZQI,ZQL,ZQS,ZQR,ZQG,ZQW,PR,ZT,PTW,ZNEBS,&
       & ZRHCRI,ZICEFR1,ZQSATS,ZNEBCH,ZRHDFDA,ZRKTTEND,ZRKQVTEND,ZRKQCTEND,&
       & ZQLI_CVPP,ZNEB_CVPP,YDMF_PHYS_SURF%GSD_VF%PLSM,PNEIJ,PGM,PTS,ZDECRD_MF,&
       & PFPFPSL,PFPFPSN,PFPFPSG,PFCSQL,PFCSQN,PFPEVPSL,PFPEVPSN,PFPEVPSG,PFPLSL,PFPLSN,PFPLSG,&
       & ZSEDIQL,ZSEDIQI,PDIAGH)
    ELSE
      CALL ACCDEV ( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTPLUI,KLEV,&
       & ZVETAF,PAPHI,&
       & PAPRS,PAPRSF,PCP,PDELP,ZQV,ZQI,ZQL,ZQS,ZQR,ZQG,PQW,PR,PT,PTW,ZNEBS,&
       & ZRHCRI,ZICEFR1,ZQSATS,ZNEBCH,ZRHDFDA,ZRKTTEND,ZRKQVTEND,ZRKQCTEND,&
       & ZQLI_CVPP,ZNEB_CVPP,YDMF_PHYS_SURF%GSD_VF%PLSM,PNEIJ,PGM,PTS,ZDECRD_MF,&
       & PFPFPSL,PFPFPSN,PFPFPSG,PFCSQL,PFCSQN,PFPEVPSL,PFPEVPSN,PFPEVPSG,PFPLSL,PFPLSN,PFPLSG,&
       & ZSEDIQL,ZSEDIQI,PDIAGH)
    ENDIF

  ENDIF

  IF (L3MT) THEN


    !  ----------------------------------------------------------------
    !   UPDATE HUMIDITY VARIABLES BY RESOLVED CONDENSATION FLUXES
    !  ----------------------------------------------------------------
!cdir unroll=8
    DO JLEV=KTDIA,KLEV
      DO JLON=KIDIA,KFDIA
        ZDQL=ZIPOI(JLON,JLEV)* (&
          & PFCSQL(JLON,JLEV)-PFCSQL(JLON,JLEV-1))
        ZQL(JLON,JLEV)=ZQL(JLON,JLEV)+ZDQL
        ZDQI=ZIPOI(JLON,JLEV)* (&
          & PFCSQN(JLON,JLEV)-PFCSQN(JLON,JLEV-1))
        ZQI(JLON,JLEV)=ZQI(JLON,JLEV)+ZDQI
        ZQV(JLON,JLEV)=ZQV(JLON,JLEV)-ZDQI-ZDQL

        ZT(JLON,JLEV)=ZT(JLON,JLEV)+(ZLHV(JLON,JLEV)*ZDQL&
                   & +ZLHS(JLON,JLEV)*ZDQI)/PCP(JLON,JLEV)
      ENDDO
    ENDDO

!rb : Store values for next time-step: all cases
    IF(LRKCDEV) THEN
      DO JLEV=KTDIA,KLEV
        DO JLON=KIDIA,KFDIA
          YDVARS%RKTH%T0(JLON,JLEV)= ZT(JLON,JLEV)+ZDTRAD(JLON,JLEV)
          YDVARS%RKTQV%T0(JLON,JLEV)=ZQV(JLON,JLEV)+ZDQVDIFF(JLON,JLEV)*ZDTURDIFF
          YDVARS%RKTQC%T0(JLON,JLEV)= ZQI(JLON,JLEV)+ZQL(JLON,JLEV)
        ENDDO
      ENDDO
    ENDIF

  ENDIF ! L3MT

!     11.- PRECIPITATIONS SOUS-MAILLES.
!     ---------------------------------

  IF (LVDIF.AND.(LCVRA.OR.L3MT.OR.LCVRAV3)) THEN
!           LA TENDANCE DYNAMIQUE DE Q EST MULTIPLIEE PAR UN
!           FACTEUR CORRECTIF FONCTION DE LA RESOLUTION LOCALE
!           DU MODELE PUIS AUGMENTEE DE LA CONTRIBUTION
!           DE L EVAPORATION DU SOL.
    IF(LCVCSD.OR..NOT.LCVGQD) THEN
      IF (LCOMOD) THEN
          DO JLON=KIDIA,KFDIA
            ZMOD(JLON)=1._JPRB/(1.0_JPRB+PGM(JLON)*TEQK)
         ENDDO
      ELSE
         ZMOD(KIDIA:KFDIA)=1._JPRB
      ENDIF
!cdir unroll=8
      DO JLEV = KTDIA, KLEV
        DO JLON = KIDIA, KFDIA
          PCVGQ(JLON,JLEV) = PCVGQ(JLON,JLEV)*ZMOD(JLON) &
           & -RG*PRDELP(JLON,JLEV)&
           & *(PDIFTQ(JLON,JLEV)-PDIFTQ(JLON,JLEV-1)&
           & +ZFCQVNG(JLON,JLEV)-ZFCQVNG(JLON,JLEV-1))
        ENDDO
      ENDDO
    ENDIF
    IF (LCAPE) THEN
      IF (LCAMOD) THEN
         DO JLON=KIDIA,KFDIA
            ZTAUX(JLON)=RTCAPE*(PGM(JLON)*TEQC)
         ENDDO
      ELSE
         ZTAUX=RTCAPE
      ENDIF ! lcamod
    ENDIF
  ENDIF


  IF (L3MT) THEN
    ! - TEMPORAIRES
    ! ZSIGPC: CONVECTIVE FRACTION OF PRECIPITATION FLUX, USED A POSTERIORI 
    ! ZSIGP : PRECIPITATION MESH FRACTION
    ZSIGPC=0.0_JPRB
    ZSIGP=1.0_JPRB  ! used to limit/scale dd area
  IF (LCVPRO) THEN
  !  -------------------------
  !  UPDRAUGHT CONTRIBUTION
  !  -------------------------

    CALL ACTQSATS ( YDPHY,YDPHY0,KIDIA,KFDIA,KLON,NTQSAT,KLEV,&
     & PAPRSF, PCP, ZQV, ZT,&
     & ZGEOSLC, ZLH, ZLSCPE, ZQSAT, ZQW, ZRH, ZTW)

    IF (.NOT.LCVCSD) THEN
      CALL ACCVUD ( YDMODEL%YRML_PHY_EC%YRECUCONVCA,YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,KTDIA,KLEV,&
       & PALPH, PAPHI, PAPHIF, PAPRS, PAPRSF, PCP,PR,&
       & PCVGQ, PDELP, PLNPR,&
       & ZQV, ZQI, ZQL, ZQSAT, ZQW,&
       & PRDELP, ZT, ZTW, PU, PV, PVORT0,&
       & YDVARS%DAL%T0,&
       & PTS, ZTAUX, PRCORI,PGM, ZDECRD_MF,&
       & PDIFCQ, PDIFCQL, PDIFCQI, PDIFCS,&
       & PFCCQL, PFCCQN, PSTRCU, PSTRCV, ZATSLC,&
       & INLAB, YDVARS%UNEBH%T0, ZDETFI, ZTU, ZQU, ZUU, ZVU,&
       & INND,PCAPE,PCUCONVCA,PNLCONVCA,&
       & ZGEOSLC, YDVARS%UEN%T0, YDVARS%UAL%T0, YDVARS%UOM%T0)

    ! Initialize temperature correction
      ZTCORR(KIDIA:KFDIA,:)=ZTU(KIDIA:KFDIA,:)-ZT(KIDIA:KFDIA,:)
    ! Initialize Environment horizontal velocity
      ZU(KIDIA:KFDIA,:)=PU(KIDIA:KFDIA,:)
      ZV(KIDIA:KFDIA,:)=PV(KIDIA:KFDIA,:)
    ELSE
! PUT IN ZTCORR THE CONDENSATE USED IN TRIGGERING
      DO JLEV=KTDIA,KLEV
       DO JLON=KIDIA,KFDIA
          ZTCORR(JLON,JLEV)=MAX(0._JPRB,ZQI(JLON,JLEV)+ZQL(JLON,JLEV) -&
          &  MAX(0._JPRB,PQI(JLON,JLEV)+PQL(JLON,JLEV)) )
       ENDDO
      ENDDO
! PASS T9 CONDENSATES TO ACCSU
      CALL ACCSU ( YDMODEL%YRML_PHY_EC%YRECUCONVCA,YDMODEL%YRML_PHY_EC%YRECUMF,YDMODEL%YRML_PHY_MF, &
        & KIDIA,KFDIA,KLON,KTDIA,KLEV,&
        & PALPH, PAPHI, PAPHIF, PAPRS, PAPRSF, PCP,PR,&
        & PCVGQ, PDELP, PLNPR,&
        & ZQV, ZTCORR, PQI, PQL, ZQSAT, ZQW,&
        & PRDELP, ZT, ZTW, PU, PV, PVORT0,&
        & PVERVEL, &
        & PFCSQL, PFCSQN, &
        & PTS, ZTAUX, PRCORI,ZDECRD_MF,&
        & YDMF_PHYS_SURF%GSD_VK%PUDGRO, &
        & PCUCONVCA,PNLCONVCA,&
        & PDIFCQ, PDIFCQL, PDIFCQI, PDIFCS,&
        & PFCCQL, PFCCQN, PSTRCU, PSTRCV, ZATSLC,&
        & INLAB, YDVARS%UNEBH%T0, ZDETFI, ZTU, ZQU, ZUU, ZVU,&
        & INND,PCAPE, &
        & ZGEOSLC, YDVARS%UEN%T0, YDVARS%UAL%T0, YDVARS%UOM%T0)

    ! Initialize temperature correction
      ZTCORR(:,:)=ZTU(:,:)
    ! Initialize Environment horizontal velocity
      ZU(KIDIA:KFDIA,:)=PU(KIDIA:KFDIA,:)
      ZV(KIDIA:KFDIA,:)=PV(KIDIA:KFDIA,:)
    ENDIF


    CALL ACUPU(YDPHY,YDPHY0,KIDIA,KFDIA,KLON,KTDIA,KLEV,&
               & YDVARS%UAL%T0,YDVARS%UNEBH%T0,ZDETFI,&
               & ZPOID,ZIPOI,ZLHV,ZLHS,PCP,&
               & PDIFCQ,PDIFCQI,PDIFCQL,PDIFCS,&
               & PFCCQL,PFCCQN,PFCSQL,PFCSQN,&
! output  1d .
               & ZSIGP, ZSIGPC,&
!input/output  2d .
               & ZNEBS,ZQI,ZQL,ZQV,ZT,&
               & PFCQVNG,PFCQING,PFCQLNG)

!rb store "-B" state: no protection of Ncv
    IF(LRKCDEV.AND.(.NOT.LNEBCV)) THEN
      DO JLEV=KTDIA,KLEV
        DO JLON=KIDIA,KFDIA
          YDVARS%RKTH%T0(JLON,JLEV)=YDVARS%RKTH%T0(JLON,JLEV)-ZT(JLON,JLEV)
          YDVARS%RKTQV%T0(JLON,JLEV)=YDVARS%RKTQV%T0(JLON,JLEV)-ZQV(JLON,JLEV)
          YDVARS%RKTQC%T0(JLON,JLEV)=YDVARS%RKTQC%T0(JLON,JLEV)-ZQI(JLON,JLEV)&
        & -ZQL(JLON,JLEV)
        ENDDO
      ENDDO
    ENDIF

  ENDIF !LCVPRO


  !  ---------------------------------------------------------
  !  MICROPHYSICS (AUTOCONVERSION, COLLECTION AND EVAPORATION)
  !        OF TOTAL CONDENSATE (RESOLVED + SUB-GRID)
  !  ---------------------------------------------------------

    ZAUXPRC(:)=0._JPRB
    ZRCVOTT(:,:)=0._JPRB

    DO JLEV=KTDIA,KLEV
      DO JLON=KIDIA,KFDIA

    !    COMPUTE TOTAL CONDENSATION FLUX
    !    -------------------------------
        ZFCQL(JLON,JLEV)=PFCSQL(JLON,JLEV)+PFCCQL(JLON,JLEV)
        ZFCQI(JLON,JLEV)=PFCSQN(JLON,JLEV)+PFCCQN(JLON,JLEV)
        IF (LRCVOTT) THEN
          ZCONVC=MAX(0.0_JPRB, PFCCQL(JLON,JLEV)+PFCCQN(JLON,JLEV))
          ZAUXPRC(JLON)=ZAUXPRC(JLON)+&
         & MAX(0.0_JPRB,PFCSQL(JLON,JLEV)+PFCSQN(JLON,JLEV)&
         & -PFCSQL(JLON,JLEV-1)-PFCSQN(JLON,JLEV-1))
          ZTOTC=ZCONVC+ZAUXPRC(JLON)
          ZRCVOTT(JLON,JLEV)=MAX(0.0_JPRB,SIGN(1.0_JPRB,ZTOTC-ZEPS0))&
         & *ZCONVC/MAX(ZTOTC,ZEPS0)
        ENDIF
      ENDDO
    ENDDO

    CALL ACTQSATS ( YDPHY,YDPHY0,KIDIA,KFDIA,KLON,NTQSAT,KLEV,&
     & PAPRSF, PCP, ZQV, ZT,&
     & ZGEOSLC, ZLH, ZLSCPE, ZQSAT, ZQW, ZRH, ZTW)

    DO JLEV=KTDIA,KLEV
      DO JLON=KIDIA,KFDIA
        ZDQ(JLON,JLEV)=ZQW(JLON,JLEV)&
         & -(ZQV(JLON,JLEV)+ZQI(JLON,JLEV)+ZQL(JLON,JLEV))
        ZDQM(JLON,JLEV)=ZQW(JLON,JLEV)
      ENDDO
    ENDDO

    CALL APLMPHYS( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,KTDIA,KLEV,&
     & PAPRS, PAPRSF, PCP, ZQV, ZQI, ZQL, ZQS, ZQR, ZQG, PR, ZT,&
     & ZIPOI, ZDQ, ZDQM, ZLHS, ZLHV, ZNEBS, ZPOID, ZRCVOTT,&
     & ZTCORR,YDMF_PHYS_SURF%GSD_VF%PLSM, PNEIJ, PTS, ZDECRD_MF,&
     & ZFCQL, ZFCQI,&
     & ZFALLR, ZFALLS,ZFALLG,&
     & PFPFPSL,PFPFPSN, PFPFPSG, PFPEVPSL, PFPEVPSN, PFPEVPSG, PFPLSL, PFPLSN,PFPLSG,&
     & ZSEDIQL,ZSEDIQI,ZMELNET,ZMELGET,PDIAGH)

    !  ------------------------------------------------------------
    !   UPDATE AFTER MICROPHYSICS - 3MT
    !  ------------------------------------------------------------

   CALL ACUPM( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,KTDIA,KLEV,&
              & PCP, ZLHS, ZLHV,&
              & PEVEL0, ZIPOI, ZPOID, YDVARS%UAL%T0, YDVARS%UOM%T0,&
              & PFPEVPSL,PFPEVPSN,PFPEVPSG,PFPFPSL,PFPFPSN,PFPFPSG,&
              & PFPLSL,PFPLSN,PFPLSG,&
              & ZFCQL,ZFCQI,PFCCQL,PFCCQN,&
! output 2D
              & ZOME, ZFHP,&
! input/output  2d .
              & ZQV,ZQL,ZQI,ZQR,ZQS,ZQG,ZT,&
              & PFCSQL,PFCSQN,&
              & PFCQVNG,PFCQRNG,PFCQSNG,PFCQGNG)

  IF (LCDDPRO) THEN
  !  -------------------------
  !  DOWNDRAUGHT CONTRIBUTION
  !  -------------------------

    ZDIFCQD(:,:)=0.0_JPRB
    ZDIFCQLD(:,:)=0.0_JPRB
    ZDIFCQID(:,:)=0.0_JPRB
    ZDIFCSD(:,:)=0.0_JPRB
    ZSTRCUD(:,:)=0.0_JPRB
    ZSTRCVD(:,:)=0.0_JPRB

    CALL ACTQSATS ( YDPHY,YDPHY0,KIDIA,KFDIA,KLON,NTQSAT,KLEV,&
     & PAPRSF, PCP, ZQV, ZT,&
     & ZGEOSLC, ZLH, ZLSCPE, ZQSAT, ZQW, ZRH, ZTW)

    IF (LNSDO) THEN
      CALL ACNSDO(YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,KTDIA,KLEV,&
       & PALPH,PAPHIF,PAPRS,PAPRSF,&
       & PDELP,PLNPR,ZQV,ZQI,ZQL,ZQR,ZQS,ZQW,&
       & PRDELP, ZSIGP,&
       & ZT,ZTW,ZU,ZV,PVERVEL,&
       & ZATSLC,ZGEOSLC,&
       & PFPLSL,PFPLSN,PFPEVPSL, PFPEVPSN,&
       & ZDIFCQD,ZDIFCQLD,ZDIFCQID,ZDIFCSD,&
       & PFPEVPCL,PFPEVPCN,&
       & ZSTRCUD,ZSTRCVD,&
       & YDVARS%DAL%T0,YDVARS%DOM%T0)
    ELSE
      CALL ACMODO(YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,KTDIA,KLEV,&
       & PALPH,PAPHIF,PAPRS,PAPRSF,PCP,&
       & PDELP,PLNPR,ZQV,ZQI,ZQL,ZQW,&
       & PR,PRDELP,ZSIGP,ZT,ZTW,ZU,ZV,PEVEL0,ZOME,&
       & ZATSLC,ZGEOSLC,ZFHP,&
       & PFPLSL,PFPLSN,PFPLSG,&
       & ZDIFCQD,ZDIFCQLD,ZDIFCQID,ZDIFCSD,&
       & PFPEVPCL,PFPEVPCN,PFPEVPCG,&
       & ZSTRCUD,ZSTRCVD,&
       & YDVARS%DAL%T0,YDVARS%DOM%T0)
    ENDIF
  !  ---------------------------------------------
  !  UPDATE VARIABLES  BY DOWNDRAUGHT CONTRIBUTION
  !  ---------------------------------------------


    DO JLEV=KTDIA,KLEV
      DO JLON=KIDIA,KFDIA

    !   UPDATE CONVECTIVE DIFFUSION AND EVAPORATION FLUXES
    !   --------------------------------------------------

        PDIFCS(JLON,JLEV) =PDIFCS(JLON,JLEV) +ZDIFCSD(JLON,JLEV)
        PDIFCQ(JLON,JLEV) =PDIFCQ(JLON,JLEV) +ZDIFCQD(JLON,JLEV)
        PDIFCQL(JLON,JLEV)=PDIFCQL(JLON,JLEV)+ZDIFCQLD(JLON,JLEV)
        PDIFCQI(JLON,JLEV)=PDIFCQI(JLON,JLEV)+ZDIFCQID(JLON,JLEV)
        PSTRCU(JLON,JLEV)=PSTRCU(JLON,JLEV)+ZSTRCUD(JLON,JLEV)
        PSTRCV(JLON,JLEV)=PSTRCV(JLON,JLEV)+ZSTRCVD(JLON,JLEV)
      ENDDO
    ENDDO

    CALL ACUPD(YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,KTDIA,KLEV,&
! input  2d .
     & PAPRSF,PCP,ZLHS,ZLHV,PR,&
     & ZIPOI,ZPOID,&
     & ZFALLR,ZFALLS,ZFALLG,&
     & PFPEVPSL,PFPEVPSN,PFPEVPSG,PFPEVPCL,PFPEVPCN,PFPEVPCG,ZFHP,&
     & ZDIFCSD,ZDIFCQD,ZDIFCQLD,ZDIFCQID,&
! input/output  2d .
     & ZQV,ZQL,ZQI,ZQR,ZQS,ZQG,ZT,YDVARS%UEN%T0,&
     & PFCQVNG,PFCQING,PFCQLNG,PFCQRNG,PFCQSNG,PFCQGNG,&
     & PFPLSL,PFPLSN,PFPLSG)

!rb  store "+C": case with no protection of Ncv
    IF((LRKCDEV).AND.(.NOT.LNEBCV)) THEN
      DO JLEV=KTDIA,KLEV
        DO JLON=KIDIA,KFDIA
          YDVARS%RKTH%T0(JLON,JLEV)=YDVARS%RKTH%T0(JLON,JLEV)+ZT(JLON,JLEV)
          YDVARS%RKTQV%T0(JLON,JLEV)=YDVARS%RKTQV%T0(JLON,JLEV)+ZQV(JLON,JLEV)
          YDVARS%RKTQC%T0(JLON,JLEV)=YDVARS%RKTQC%T0(JLON,JLEV)&
          & +ZQI(JLON,JLEV)+ZQL(JLON,JLEV)
        ENDDO
      ENDDO
    ENDIF

  !  PARTITION CONVECTIVE/STRATIFORM PRECIPITATION
  ! ---------------------------------------------
    DO JLEV=KTDIA-1,KLEV
      DO JLON=KIDIA, KFDIA
         PFPLCL(JLON,JLEV)=ZSIGPC(JLON)*PFPLSL(JLON,JLEV)
         PFPLSL(JLON,JLEV)=PFPLSL(JLON,JLEV)-PFPLCL(JLON,JLEV)
         PFPLCN(JLON,JLEV)=ZSIGPC(JLON)*PFPLSN(JLON,JLEV)
         PFPLSN(JLON,JLEV)=PFPLSN(JLON,JLEV)-PFPLCN(JLON,JLEV)
      ENDDO
    ENDDO
    IF (LGRAPRO) THEN
      DO JLEV=KTDIA-1,KLEV
        DO JLON=KIDIA, KFDIA
           PFPLCG(JLON,KLEV)=0.0_JPRB !ZSIGPC(JLON)*PFPLSG(JLON,JLEV)
           PFPLSG(JLON,JLEV)=PFPLSG(JLON,JLEV)-PFPLCG(JLON,JLEV)
        ENDDO
      ENDDO
    ENDIF
  ENDIF ! LCDDPRO

  ENDIF ! L3MT

! -----------------------------------------------------

  IF ( LCVRA ) THEN

    IF (LSTRAPRO) THEN
      DO JLEV = KTDIA-1, KLEV
        DO JLON = KIDIA, KFDIA
          PDIFTQ(JLON,JLEV)=PDIFTQ(JLON,JLEV)+ZFCQVNG(JLON,JLEV)
        ENDDO
      ENDDO
    ENDIF

    CALL ACCVIMP ( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTCVIM,KLEV,&
     & PALPH, PAPHI, PAPHIF, PAPRS, PAPRSF, PCP, PCVGQ, PDELP,&
     & PLNPR, ZQV, PQSAT, PQW, PR, PRDELP, PT, PTW, PU, PV, PVORT0, PVERVEL,&
     & PGM, PTS, ZTAUX, PRCORI,&
     & PDIFCQ, PDIFCS, PFCCQL, PFCCQN, PFPLCL, PFPLCN, PFPFPCL, PFPFPCN,&
     & PFPEVPCL, PFPEVPCN, PSTRCU, PSTRCV, ZFPCOR, INLAB, PCAPE, INND,&
     & PDIFTQ, PDIFTS, ZGEOSLC, PGEMU)

    IF (LSTRAPRO) THEN
      DO JLEV = KTDIA-1, KLEV
        DO JLON = KIDIA, KFDIA
          PDIFTQ(JLON,JLEV)=PDIFTQ(JLON,JLEV)-ZFCQVNG(JLON,JLEV)
        ENDDO
      ENDDO
    ENDIF

  ELSEIF (LCVRAV3) THEN

    CALL ACCVIMP_V3 (YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTCVIM,KLEV,&
     & PALPH, PAPHI, PAPHIF, PAPRS, PAPRSF, PCP, PCVGQ, PDELP,&
     & PLNPR, ZQV, PQW, PR, PRDELP, PT, PTW, PU, PV,&
     & PTS, YDMF_PHYS_SURF%GSD_VH%PPBLH,&
     & PDIFCQ, PDIFCS, PFCCQL, PFCCQN, PFPLCL, PFPLCN, PFPFPCL, PFPFPCN,&
     & PFPEVPCL, PFPEVPCN, PSTRCU, PSTRCV, INLAB, INND,&
     & PDIFTQ, PDIFTS)

  ELSEIF (LCVTDK) THEN     ! <== IFS deep convection scheme

    DO JLEV=1,KLEV
      DO JLON=KIDIA,KFDIA
        ZGEOM1(JLON,JLEV)     = PAPHIF(JLON,JLEV)-PAPHI(JLON,KLEV)
        ZVERVEL(JLON,JLEV)    = PVERVEL(JLON,JLEV)*PAPRSF(JLON,JLEV)
        ZLISUM(JLON,JLEV)     = 0.0_JPRB
        ZLCRIT_AER(JLON,JLEV) = 5.E-4_JPRB
      ENDDO
    ENDDO
    DO JLEV=0,KLEV
      DO JLON=KIDIA,KFDIA
        ZGEOMH(JLON,JLEV)=PAPHI(JLON,JLEV)-PAPHI(JLON,KLEV)
        ZFCQLF(JLON,JLEV)=0.0_JPRB
        ZFCQLI(JLON,JLEV)=0.0_JPRB
      ENDDO
    ENDDO
    DO JLON=KIDIA,KFDIA
       LLLAND(JLON)    = (YDMF_PHYS_SURF%GSD_VF%PLSM(JLON)>0.5_JPRB)
       LLSHCV(JLON)    = .FALSE.
       ZCUCONVCA(JLON) = 0.0_JPRB
       ZACPR(JLON)     = 0.0_JPRB
       ZDXTDK(JLON)    = RDELXN/PGM(JLON)
    ENDDO
    LLPTQ = .FALSE.
    CALL ACUPTQ ( KLON,KIDIA,KFDIA,KLEV,LLPTQ,PFRSO,PFRTH,&
     & PDIFCQ,PDIFCS,PDIFTQ,PDIFTS,PFCCQL,PFCCQN,PFPLCL,PFPLCN,&
     & PFPEVPCL,PFPEVPCN,PFPFPCL,PFPFPCN,PRDELP,PT,PQ,PTS,&
     & ZTENHA,ZTENQVA )
    
    DO JLEV=1,KLEV
      DO JLON=KIDIA,KFDIA 
         ZTENT(JLON,JLEV) = ZTENHA(JLON,JLEV)/PCP(JLON,JLEV)
         ZTENQ(JLON,JLEV) = ZTENQVA(JLON,JLEV)
         ZTENU(JLON,JLEV) = 0.0_JPRB
         ZTENV(JLON,JLEV) = 0.0_JPRB
      ENDDO
    ENDDO
    LLDSLPHY=.TRUE.
    ZVDIFTS = 0._JPRB
    ISPPN2D = 0
         
    CALL CUCALLN_MF &
     & (YDMODEL%YRML_PHY_RAD%YRERAD,YDMODEL%YRML_PHY_SLIN,YDMODEL%YRML_PHY_EC,YDMODEL%YRML_GCONF%YGFL,&
     & KIDIA,KFDIA,KLON,0,KLEV,ZDXTDK,ISPPN2D,LLLAND,LLDSLPHY,TSPHY,ZVDIFTS,&
     & PT,ZQV,PU,PV,ZLISUM,ZVERVEL,PDIFTQ,PDIFTS,&
     & PAPRS,PAPRSF,PAPRS,ZGEOM1,ZGEOMH,PGM, &
     & ZCUCONVCA,ZGP2DSPP,ZTENT,ZTENQ,ZTENU,ZTENV,ZACPR,&
     & ITOPC,IBASC,ITYPE,ICBOT,ICTOP,IBOTSC,LLCUM,LLSC,LLSHCV,ZLCRIT_AER,&
     & ZLU,ZLUDE,ZLUDELI,ZSNDE,ZMFU,ZMFD,PDIFCQ,PDIFCS,ZFHPCL,ZFHPCN,&
     & PFPLCL,PFPLCN,ZLRAIN,ZRSUD,PSTRCU,PSTRCV,ZFCQLF,ZFCQLI,&
     & ZMFUDE_RATE,ZMFDDE_RATE,PCAPE,ZWMEAN,ZDIFF,0,ZCEN,ZTENC,ZSCAV)
    DO JLEV=0,KLEV
      DO JLON=KIDIA,KFDIA 
         ZFPCOR  (JLON,JLEV)=PFPLCL(JLON,JLEV)+PFPLCN(JLON,JLEV)
         PFCCQL  (JLON,JLEV)=PFPLCL(JLON,JLEV)
         PFCCQN  (JLON,JLEV)=PFPLCN(JLON,JLEV)
         PFPFPCL (JLON,JLEV)=PFPLCL(JLON,JLEV)
         PFPFPCN (JLON,JLEV)=PFPLCN(JLON,JLEV)
         PFPEVPCL(JLON,JLEV)=0._JPRB
         PFPEVPCN(JLON,JLEV)=0._JPRB
       ENDDO
    ENDDO

  ENDIF
  IF(LFLASH .AND. LCVTDK) THEN
    ! LIGHTNING PARAMETERIZATION. OUTPUT IS PFLASH, TOTAL LIGHTNING FLASH RATES.
    ZGAW(:)=0._JPRB
    CALL CULIGHT &
      & ( YDEPHY,YGFL,KIDIA ,  KFDIA,   KLON,    KLEV,  ZGAW, ZGAW, &
      &   PAPRSF,     PAPRS  ,  PAPHI,   PAPHIF,  LLLAND,&
      &   PT    ,  ZLU   ,  ZMFU,    PCAPE, &
      &   PFPLCL,  PFPLCN,&
      &   LLCUM ,  ICBOT ,  ICTOP,&
      ! Outputs
      &   LLLINOX, PFLASH,  ZLIGH_CTG,  ZCTOPH, &
      &   ZPRECMX, ZICE,   ZCDEPTH,  ZWMFU) 
    ! LIGHTNING FLASH RATES ARE CONVERTED IN fl/km2/s BEFORE ENTERING CFU TIME ACCUMULATION.
    DO JLON=KIDIA,KFDIA
      PFLASH(JLON)=PFLASH(JLON)/86400._JPRB
    ENDDO
  ENDIF

  IF ( LADJCLD ) THEN
    ZFRSO(:,:) = 0.0_JPRB
    ZFRTH(:,:) = 0.0_JPRB
    LLPTQ = .TRUE.
    CALL ACUPTQ ( KLON,KIDIA,KFDIA,KLEV,LLPTQ,ZFRSO,ZFRTH,&
     & PDIFCQ,PDIFCS,PDIFTQ,PDIFTS,PFCCQL,PFCCQN,PFPLCL,PFPLCN,&
     & PFPEVPCL,PFPEVPCN,PFPFPCL,PFPFPCN,PRDELP,PT,PQ,PTS,&
     & ZTENHA,ZTENQVA )
  ENDIF

  IF ( LPROCLD ) THEN
    IF(LGPCMT) THEN
      ! Microphysics occurs in a shell between updraft and its resolved environment.
      ZNEBS(KIDIA:KFDIA,KTDIA:KLEV)=1._JPRB-(1._JPRB-ZNEBS(KIDIA:KFDIA,KTDIA:KLEV))&
        & *(1._JPRB-ZCSGC(KIDIA:KFDIA,KTDIA:KLEV))
      ZTMIC(KIDIA:KFDIA,KTDIA:KLEV)=PT(KIDIA:KFDIA,KTDIA:KLEV)
      ZQMIC(KIDIA:KFDIA,KTDIA:KLEV)=ZCSGC(KIDIA:KFDIA,KTDIA:KLEV)&
        & *PQSAT(KIDIA:KFDIA,KTDIA:KLEV)&
        & +(1._JPRB-ZCSGC(KIDIA:KFDIA,KTDIA:KLEV))*ZQV(KIDIA:KFDIA,KTDIA:KLEV)
      ZQLIS(KIDIA:KFDIA,KTDIA:KLEV)=MAX(ZQLIS(KIDIA:KFDIA,KTDIA:KLEV),&
        & ZCSGC(KIDIA:KFDIA,KTDIA:KLEV)&
        & *(ZQL(KIDIA:KFDIA,KTDIA:KLEV)+ZQI(KIDIA:KFDIA,KTDIA:KLEV))&
        & +(1._JPRB-ZCSGC(KIDIA:KFDIA,KTDIA:KLEV))*ZQLIS(KIDIA:KFDIA,KTDIA:KLEV))
      ZQC_DET_PCMT(:,:)=0._JPRB
    ELSE
      ! Microphysics occurs in the resolved state.
      ZTMIC(KIDIA:KFDIA,KTDIA:KLEV)=PT(KIDIA:KFDIA,KTDIA:KLEV)
      ZQMIC(KIDIA:KFDIA,KTDIA:KLEV)=ZQV(KIDIA:KFDIA,KTDIA:KLEV)
    ENDIF

    CALL ACPLUIZ ( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,NTPLUI,KLEV,&
     & ZTMIC, ZQMIC, ZQL, ZQI, ZQR, ZQS,&
     & PDELP, PAPRSF, PCP, PR,&
     & ZNEBS, ZQLIS, ZNEB_CVPP, ZQLI_CVPP,ZQC_DET_PCMT,&
     & ZTENHA, ZTENQVA, LADJCLD, PAPHI,&
     & PTS, PNEIJ, YDMF_PHYS_SURF%GSD_VF%PLSM, PGM, ZVETAF,&
     & PFCSQL, PFCSQN, PFPLSL, PFPLSN,&
     & PFPEVPSL, PFPEVPSN, PFPFPSL, PFPFPSN, ZSEDIQL, ZSEDIQI )

    IF(LGPCMT.AND.LCVNHD) THEN
      ! Evaporation processes within convective environment
      ! will be used by the convection, to compute their feedback on convective updrafts. 
      ! This information is put here in PDDAL.
      YDVARS%DAL%T0(:,:)=0._JPRB
      DO JLEV=KTDIA,KLEV
        DO JLON=KIDIA,KFDIA
          YDVARS%DAL%T0(JLON,JLEV)=( &
            & +PFPEVPSL(JLON,JLEV)-PFPEVPSL(JLON,JLEV-1)   &
            & +PFPEVPSN(JLON,JLEV)-PFPEVPSN(JLON,JLEV-1)   &
            & +PFPEVPCL(JLON,JLEV)-PFPEVPCL(JLON,JLEV-1)   &
            & +PFPEVPCN(JLON,JLEV)-PFPEVPCN(JLON,JLEV-1)) &
            & /RG*PRDELP(JLON,JLEV)
        ENDDO
      ENDDO
      IF(LMUSCLFA) CALL WRSCMR(NMUSCLFA,'PFPEVPSL0',PFPEVPSL,KLON,KLEV+1)
      IF(LMUSCLFA) CALL WRSCMR(NMUSCLFA,'PFPEVPSN0',PFPEVPSN,KLON,KLEV+1)
      IF(LMUSCLFA) CALL WRSCMR(NMUSCLFA,'PFPEVPCL0',PFPEVPCL,KLON,KLEV+1)
      IF(LMUSCLFA) CALL WRSCMR(NMUSCLFA,'PFPEVPCN0',PFPEVPCN,KLON,KLEV+1)
    ENDIF
  ENDIF

  IF ( LNEBCO ) THEN
    CALL ACNEBC ( YDPHY0,KIDIA,KFDIA,KLON,NTNEBU,KLEV,&
     & PFPLCL,PFPLCN,INLAB,&
     & INND,&
     & YDMF_PHYS_SURF%GSD_VH%PTCCH,YDMF_PHYS_SURF%GSD_VH%PSCCH,YDMF_PHYS_SURF%GSD_VH%PBCCH)
  ENDIF
  IF ( LGWDC ) THEN
    CALL ACDRAC ( YDPHY0,YDPHY2,KIDIA,KFDIA,KLON,NTDRAG,KLEV,&
     & PAPRS, ZNBVNO, PRDELP, PU, PV,&
     & PFPLCL, PFPLCN, YDMF_PHYS_SURF%GSD_VH%PSCCH, YDMF_PHYS_SURF%GSD_VH%PBCCH,&
     & PSTRCU, PSTRCV)
  ENDIF

  ZFLX_LOTT_GWU(:, :) = 0.0_JPRB
  ZFLX_LOTT_GWV(:, :) = 0.0_JPRB

  IF ( LNORGWD ) THEN

    ! Inversion du sens des niveaux
    DO JLON = KIDIA, KFDIA
      DO JLEV = 1, KLEV
        Z_PP(JLON, JLEV) = PAPRSF(JLON, KLEV - JLEV + 1)
        Z_UU(JLON, JLEV) = PU(JLON, KLEV - JLEV + 1)
        Z_VV(JLON, JLEV) = PV(JLON, KLEV - JLEV + 1)
        Z_TT(JLON, JLEV) = PT(JLON, KLEV - JLEV + 1)
        Z_VO(JLON, JLEV) = PVORT0(JLON, KLEV - JLEV + 1)
        ZD_U(JLON, JLEV) = TSPHY * PNOGWDU(JLON, KLEV - JLEV + 1)
        ZD_V(JLON, JLEV) = TSPHY * PNOGWDV(JLON, KLEV - JLEV + 1)
      ENDDO
    ENDDO

    ZPRECGWD(KIDIA:KFDIA) = MAX(0.0_JPRB,                  &
      & PFPLCL(KIDIA:KFDIA,KLEV) + PFPLCN(KIDIA:KFDIA,KLEV))
    
    CALL ACNORGWD(YDNORGWD, KIDIA, KFDIA, KLON, KLEV, TSPHY, &
                    & Z_PP, PGEMU, Z_TT, Z_UU, Z_VV, Z_VO, ZPRECGWD, &
                    & ZD_U, ZD_V)
    
    DO JLON = KIDIA, KFDIA
      DO JLEV = 1, KLEV
        PNOGWDU(JLON, JLEV) = ZD_U(JLON, KLEV - JLEV + 1) / TSPHY
        PNOGWDV(JLON, JLEV) = ZD_V(JLON, KLEV - JLEV + 1) / TSPHY
      ENDDO
    ENDDO

    !-- CALCUL DU FLUX, PAR INTEGRATION DE LA TENDANCE DE HAUT EN BAS.
    !   LES FLUX SONT SUPPOSES NULS AU PREMIER NIVEAU (1 = TOP) DE CALCUL.
    DO JLEV = 1, KLEV
       DO JLON = KIDIA, KFDIA
          ZFLX_LOTT_GWU(JLON, JLEV) = ZFLX_LOTT_GWU(JLON, JLEV - 1) - PNOGWDU(JLON, JLEV)*PDELP(JLON, JLEV)/RG
          ZFLX_LOTT_GWV(JLON, JLEV) = ZFLX_LOTT_GWV(JLON, JLEV - 1) - PNOGWDV(JLON, JLEV)*PDELP(JLON, JLEV)/RG
          PSTRCU(JLON, JLEV) = PSTRCU(JLON, JLEV) + ZFLX_LOTT_GWU(JLON, JLEV)
          PSTRCV(JLON, JLEV) = PSTRCV(JLON, JLEV) + ZFLX_LOTT_GWV(JLON, JLEV)          
    !+ TODOLATER +!      PSTRNORGWDU(JLON, JLEV) = PSTRNORGWDU(JLON, JLEV) + ZFLX_LOTT_GWU(JLON, JLEV)
    !+ TODOLATER +!      PSTRNORGWDV(JLON, JLEV) = PSTRNORGWDV(JLON, JLEV) + ZFLX_LOTT_GWV(JLON, JLEV)          
       ENDDO
    ENDDO

    ! NO VERTICAL DIFFUSION IN THE MIDDLE ATMOSPHERE
    DO JLEV = 1, NORGWD_NNOVERDIF
       DO JLON = KIDIA, KFDIA
          PSTRTU(JLON, JLEV) = 0.0
          PSTRTV(JLON, JLEV) = 0.0          
       ENDDO
    ENDDO

    !+ TODOLATER +! IF (LNOWINDTEND) THEN
    !+ TODOLATER +!  DO JLEV = 0, KLEV
    !+ TODOLATER +!    DO JLON = KIDIA, KFDIA
    !+ TODOLATER +!      PSTRCU(JLON,JLEV) = 0._JPRB
    !+ TODOLATER +!      PSTRCV(JLON,JLEV) = 0._JPRB
    !+ TODOLATER +!    ENDDO
    !+ TODOLATER +!  ENDDO
    !+ TODOLATER +! ENDIF

  ENDIF

!*
!     ------------------------------------------------------------------
!         SAUVEGARDE DES FLUX DE PRECIPITATION CONVECTIVE ET STRATIFORME.

  IF(LNEBN.OR.LNEBR.OR.LRRGUST) THEN
    IF (LFPCOR) THEN
      IF (LCDDPRO) THEN
        DO JLEV=KTDIA-1,KLEV
          DO JLON=KIDIA,KFDIA
            PFPLCH(JLON,JLEV)=PFPLCL(JLON,JLEV)+PFPLCN(JLON,JLEV)
          ENDDO
        ENDDO
      ELSE
        DO JLEV=KTDIA-1,KLEV
          DO JLON=KIDIA,KFDIA
            PFPLCH(JLON,JLEV)=ZFPCOR(JLON,JLEV)
          ENDDO
        ENDDO
      ENDIF
    ELSE
      DO JLEV=KTDIA-1,KLEV
        DO JLON=KIDIA,KFDIA
          PFPLCH(JLON,JLEV)=PFPLCL(JLON,JLEV)+PFPLCN(JLON,JLEV)
        ENDDO
      ENDDO
    ENDIF
  ENDIF

  IF(LRRGUST) THEN
    DO JLEV=KTDIA-1,KLEV
      DO JLON=KIDIA,KFDIA
        PFPLSH(JLON,JLEV)=PFPLSL(JLON,JLEV)+PFPLSN(JLON,JLEV)+PFPLSG(JLON,JLEV)
      ENDDO
    ENDDO
  ENDIF

  ! - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  ! UPDATE TRANSPORT FLUXES DUE TO SEDIMENTATION OF CLOUDS.
  ! - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  DO JLEV=KTDIA,KLEV
    DO JLON=KIDIA,KFDIA
      PDIFTQL(JLON,JLEV)=PDIFTQL(JLON,JLEV)+ZSEDIQL(JLON,JLEV)
      PDIFTQI(JLON,JLEV)=PDIFTQI(JLON,JLEV)+ZSEDIQI(JLON,JLEV)
      ZFPLSL (JLON,JLEV)=PDIFTQL(JLON,JLEV)+PFPLSL (JLON,JLEV)
      ZFPLSN (JLON,JLEV)=PDIFTQI(JLON,JLEV)+PFPLSN (JLON,JLEV)
    ENDDO
  ENDDO
  IF (LGRAPRO) THEN
    DO JLEV=KTDIA,KLEV
      DO JLON=KIDIA,KFDIA
        ZFPLSN (JLON,JLEV)=ZFPLSN(JLON,JLEV)+PFPLSG(JLON,JLEV)
      ENDDO
    ENDDO
  ENDIF

  ! - - - - - - - - - - - - - - - - -
  ! CORRECT NEGATIVE WATER CONTENTS.
  ! - - - - - - - - - - - - - - - - -

  IF ( LCONDWT.AND.LPROCLD.AND..NOT.LGPCMT ) THEN
    CALL QNGCOR (YDPHY2,KIDIA, KFDIA, KLON, NTPLUI, KLEV,&
     & ZQV, ZQL, ZQI, PRDELP,&
     & PDIFCQ, PDIFCQI, PDIFCQL, PDIFTQ, PDIFTQI, PDIFTQL,&
     & PFPEVPSL, PFPEVPSN, PFPEVPCL, PFPEVPCN,&
     & PFPFPSL, PFPFPSN, PFPFPCL, PFPFPCN,&
     & PFCCQL, PFCCQN, PFCSQL, PFCSQN, PFCQVNG )

    ! Comment the following lines, which generate negative QR/QS values in CPTEND_NEW.
    !DO JLON=KIDIA,KFDIA
    !  PFPLSL(JLON,KLEV)=PFPLSL(JLON,KLEV)+PDIFTQL(JLON,KLEV)
    !  PFPLSN(JLON,KLEV)=PFPLSN(JLON,KLEV)+PDIFTQI(JLON,KLEV)
    !ENDDO

  ENDIF

!*
!     ------------------------------------------------------------------
!     12. - BILAN HYDRIQUE DU SOL
!     ---------------------------
  IF ( LMSE ) THEN

    DO JLON=KIDIA,KFDIA
      PGPAR(JLON,MRAIN)=ZFPLSL(JLON,KLEV)+PFPLCL(JLON,KLEV)
      PGPAR(JLON,MSNOW)=ZFPLSN(JLON,KLEV)+PFPLCN(JLON,KLEV)
    ENDDO

  ELSE

    IF ( LSFHYD.AND.LSOLV ) THEN
      CALL ACDROV ( YDMODEL%YRML_PHY_MF,KIDIA,KFDIA,KLON,KLEV,KCSS,&
       & PFPLCL, PFPLCN, ZFPLSL, ZFPLSN, PFRSO, PFRTH,&
       & PC1, PC2, ZC3, ZCN, PCT, YDMF_PHYS_SURF%GSD_VV%PD2, PFEVV, PFTR, YDMF_PHYS_SURF%GSD_VV%PLAI, PNEIJ,&
       & PVEG, ZWFC, ZWPMX, PWL, ZWLMX, ZWSEQ, ZWSMX,&
       & PFCHSP, PFCLL, PFCLN, PFCS, PFEVI, PFEVL, PFEVN, YDMF_PHYS_SURF%GSD_VF%PLSM, PSNS,&
       & PTP, PTS, PWP, PWPI, PWS, PWSI,&
       & PFGEL, PFGELS,&
       & PFLWSP, PFONTE, PRUISP, PRUISL, PRUISS)
    ENDIF

  ENDIF

!*
!-  --------------------------------------------------------------------
!     13.- DRAG MESOSPHERIQUE POUR UN MODELE POSSEDANT DES NIVEAUX
!               AU-DESSUS DE 50 KM (I.E. DANS LA MESOSPHERE)
!     ------------------------------------------------------------------
  IF ( LRRMES ) THEN
    CALL ACDRME ( YDPHY2,YDTOPH,KIDIA,KFDIA,KLON,NTDRME,KLEV,&
     & PCP,PDELP,PT,ZQV,PU,PV,&
     & PFRMH,PFRMQ,PSTRMU,PSTRMV,&
     & RMESOT,RMESOQ,RMESOU,STTEM)
  ENDIF

!*
!     ------------------------------------------------------------------
!     14.- FLUX PHOTO-CHIMIQUE D'OZONE
!     ------------------------------------------------------------------
  IF ( LOZONE ) THEN
    CALL ACOZONE ( YDPHY2,YDTOPH,KIDIA,KFDIA,KLON,NTOZON,KLEV,KVCLIS,&
     & PAPRS,PAPRSF,PDELP,PKOZO,ZQO3(1,1),PT,PMU0,&
     & PFCHOZ)

!           DIFFUSION TURBULENTE/DEPOT SEC DE L'OZONE

    CALL ACDIFOZ ( YDRIP,YDPHY2,YDMODEL%YRML_PHY_MF%YRVDOZ,KIDIA,KFDIA,KLON,KTDIA,KLEV,&
     & PAPRSF,PDELP,PFPLCL,PFPLSL,PFRSO,&
     & ZKTROV,ZQO3(1,1),PRDELP,PT,ZXTROV,&
     & PNEIJ,PGEMU,YDMF_PHYS_SURF%GSD_VV%PIVEG,&
     & PFCHOZ)
  ENDIF
!*
!     ------------------------------------------------------------------
!     15.- CALCUL DES FLUX D'ENTHALPIE ET DE CHALEUR SENSIBLE LIES AUX
!          PRECIPITATIONS EN FONCTION DES FLUX DE PRECIPITATION
!          ET DE CONDENSATION.
!     ------------------------------------------------------------------

  ! STORE THE PSEUDO-HISTORIC SURFACE PRECIPITATION SENSIBLE HEAT FLUX
  ! -------------------------------------------------------------------

  IF (LPHSPSH) THEN
    DO JLON=KIDIA, KFDIA
       YDMF_PHYS_SURF%GSD_VH%PSPSH(JLON)=(PT(JLON,KLEV)-PTS(JLON)) * ((&
          & RCW-RCPD)*(PFPLSL(JLON,KLEV)+PFPLCL(JLON,KLEV))&
          & +(RCS-RCPD)*(PFPLSN(JLON,KLEV)+PFPLCN(JLON,KLEV)) )
    ENDDO
    IF (LGRAPRO) THEN
      YDMF_PHYS_SURF%GSD_VH%PSPSH(JLON)=YDMF_PHYS_SURF%GSD_VH%PSPSH(JLON)+(PT(JLON,KLEV)-PTS(JLON)) * (&
        &(RCS-RCPD)*(PFPLSG(JLON,KLEV)+PFPLCG(JLON,KLEV)))
    ENDIF
  ENDIF !LPHSPSH

! Store radiative cloudiness in GFL structure for ISP, Historical files or PostProcessing
  IF (YIRAD%LGP) YDVARS%IRAD%T1(KIDIA:KFDIA,:) = PQICE(KIDIA:KFDIA,:)
  IF (YLRAD%LGP) YDVARS%LRAD%T1(KIDIA:KFDIA,:) = PQLI (KIDIA:KFDIA,:)
  IF (YA%LGP)    YDVARS%A%T1(KIDIA:KFDIA,:) = PNEB (KIDIA:KFDIA,:)


!*
!     -----------------------------------------------------------------------
!     16.- DDH FLEXIBLES POUR LES CHAMPS DE SURFACE VARIABLES/FLUX/TENDANCES.
!     -----------------------------------------------------------------------

  IF(LFLEXDIA) THEN
    IF (LDDH_OMP) THEN
      ! Store in DDH the clouds used for radiative calculations
      ZTMPAF(KIDIA:KFDIA,1:KLEV)=PDELP(KIDIA:KFDIA,1:KLEV)*PQICE(KIDIA:KFDIA,1:KLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAF,'VIR',YDDDH)
      ZTMPAF(KIDIA:KFDIA,1:KLEV)=PDELP(KIDIA:KFDIA,1:KLEV)*PQLI(KIDIA:KFDIA,1:KLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAF,'VLR',YDDDH)
      ZTMPAF(KIDIA:KFDIA,1:KLEV)=PDELP(KIDIA:KFDIA,1:KLEV)*PNEB(KIDIA:KFDIA,1:KLEV)
      CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAF,'VNT',YDDDH)

      ! surface variables
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,YDMF_PHYS_SURF%GSD_VF%PLSM,'VLSM',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PTS(KIDIA:KFDIA)/PCT(KIDIA:KFDIA)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'VSTS',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*RTINER*PTP(KIDIA:KFDIA,KCSS)/PCT(KIDIA:KFDIA)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'VSTP',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PWS(KIDIA:KFDIA)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'VSWS',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PWP(KIDIA:KFDIA)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'VSWP',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PSNS(KIDIA:KFDIA)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'VSWN',YDDDH)

      ! surface free-style variables
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,PTCLS,'VTCLS',YDDDH,CDTYPE='S')
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,PQCLS,'VQCLS',YDDDH,CDTYPE='S')
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,PUCLS,'VUCLS',YDDDH,CDTYPE='S')
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,PVCLS,'VVCLS',YDDDH,CDTYPE='S')
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,PNUCLS,'VNUCLS',YDDDH,CDTYPE='S')
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,PNVCLS,'VNVCLS',YDDDH,CDTYPE='S')
      ZTMPAS(KIDIA:KFDIA)=PAPHI(KIDIA:KFDIA,KLEV)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'VSPHI',YDDDH,CDTYPE='S')
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,PGZ0,'VSGZ0',YDDDH,CDTYPE='S')
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,PGZ0H,'VSGZH',YDDDH,CDTYPE='S')
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,PALB,'VSALB',YDDDH,CDTYPE='S')
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,PCLPH,'VSCPH',YDDDH,CDTYPE='S')

      ! surface fluxes free stlye or not
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFRSO(KIDIA:KFDIA,KLEV,1)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'FSRAYSODW',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFRTH(KIDIA:KFDIA,KLEV,1)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'FSRAYTHUP',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFCLL(KIDIA:KFDIA,1)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'FSCHLATLI',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFCLN(KIDIA:KFDIA,1)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'FSCHLATNE',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFCS(KIDIA:KFDIA,1)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'FSCHLATSF',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFCHSP(KIDIA:KFDIA,KCSS)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'FSCHGSNPL',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFONTE(KIDIA:KFDIA)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'FFONTESLI',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFPLSL(KIDIA:KFDIA,KLEV)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'FSPRELIGE',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFPLSN(KIDIA:KFDIA,KLEV)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'FSPRENEGE',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFPLCL(KIDIA:KFDIA,KLEV)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'FSPRELICO',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFPLCN(KIDIA:KFDIA,KLEV)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'FSPRENECO',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFEVL(KIDIA:KFDIA,1)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'FSEVAPLIQ',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFEVN(KIDIA:KFDIA,1)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'FSEVAPNEG',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFLWSP(KIDIA:KFDIA)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'FSLIQSNPL',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PRUISS(KIDIA:KFDIA)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'FRUISSURF',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PRUISP(KIDIA:KFDIA)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'FRUISSPRF',YDDDH)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,PFRTHDS,'FSRAYTHDS',YDDDH)
      ZTMPAS(KIDIA:KFDIA)=-YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*RLMLT*PFONTE(KIDIA:KFDIA)
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'FFONTESNE',YDDDH)

      ZEPSA = 1.E-4_JPRB
      DO JLON=KIDIA, KFDIA
        ZTMPAS(JLON)=PFRSO(JLON,KLEV,1)/MAX(1.0_JPRB-PALB(JLON),ZEPSA)
      ENDDO
      CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH,ZTMPAS,'FSRAYSOLR',YDDDH)
      IF (NPRINTLEV >= 2) THEN
      WRITE(NULOUT,*) 'LFLEXDIA ARPEGE WITH NTOTSURF = ',NTOTSURF,&
         & ' AND NTOTSVAR = ',NTOTSVAR, ' AND NTOTSVFS = ',NTOTSVFS
      ENDIF

    ELSE  

      ! Store in DDH the clouds used for radiative calculations
      ZTMPAF(KIDIA:KFDIA,1:KLEV)=PDELP(KIDIA:KFDIA,1:KLEV)*PQICE(KIDIA:KFDIA,1:KLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPAF,'VIR','V','ARP',.TRUE.,.TRUE.)
      ZTMPAF(KIDIA:KFDIA,1:KLEV)=PDELP(KIDIA:KFDIA,1:KLEV)*PQLI(KIDIA:KFDIA,1:KLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPAF,'VLR','V','ARP',.TRUE.,.TRUE.)
      ZTMPAF(KIDIA:KFDIA,1:KLEV)=PDELP(KIDIA:KFDIA,1:KLEV)*PNEB(KIDIA:KFDIA,1:KLEV)
      CALL ADD_FIELD_3D(YDLDDH,ZTMPAF,'VNT','V','ARP',.TRUE.,.TRUE.)

      ! surface variables
      CALL ADD_FIELD_2D(YDLDDH,YDMF_PHYS_SURF%GSD_VF%PLSM,'VLSM','V','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PTS(KIDIA:KFDIA)/PCT(KIDIA:KFDIA)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'VSTS','V','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*RTINER*PTP(KIDIA:KFDIA,KCSS)/PCT(KIDIA:KFDIA)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'VSTP','V','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PWS(KIDIA:KFDIA)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'VSWS','V','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PWP(KIDIA:KFDIA)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'VSWP','V','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PSNS(KIDIA:KFDIA)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'VSWN','V','ARP',.TRUE.,.TRUE.)

      ! surface free-style variables
      CALL ADD_FIELD_2D(YDLDDH,PTCLS,'VTCLS','S','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_2D(YDLDDH,PQCLS,'VQCLS','S','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_2D(YDLDDH,PUCLS,'VUCLS','S','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_2D(YDLDDH,PVCLS,'VVCLS','S','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_2D(YDLDDH,PNUCLS,'VNUCLS','S','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_2D(YDLDDH,PNVCLS,'VNVCLS','S','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=PAPHI(KIDIA:KFDIA,KLEV)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'VSPHI','S','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_2D(YDLDDH,PGZ0,'VSGZ0','S','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_2D(YDLDDH,PGZ0H,'VSGZH','S','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_2D(YDLDDH,PALB,'VSALB','S','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_2D(YDLDDH,PCLPH,'VSCPH','S','ARP',.TRUE.,.TRUE.)

      ! surface fluxes free stlye or not
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFRSO(KIDIA:KFDIA,KLEV,1)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'FSRAYSODW','F','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFRTH(KIDIA:KFDIA,KLEV,1)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'FSRAYTHUP','F','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFCLL(KIDIA:KFDIA,1)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'FSCHLATLI','F','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFCLN(KIDIA:KFDIA,1)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'FSCHLATNE','F','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFCS(KIDIA:KFDIA,1)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'FSCHLATSF','F','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFCHSP(KIDIA:KFDIA,KCSS)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'FSCHGSNPL','F','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFONTE(KIDIA:KFDIA)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'FFONTESLI','F','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFPLSL(KIDIA:KFDIA,KLEV)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'FSPRELIGE','F','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFPLSN(KIDIA:KFDIA,KLEV)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'FSPRENEGE','F','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFPLCL(KIDIA:KFDIA,KLEV)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'FSPRELICO','F','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFPLCN(KIDIA:KFDIA,KLEV)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'FSPRENECO','F','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFEVL(KIDIA:KFDIA,1)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'FSEVAPLIQ','F','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFEVN(KIDIA:KFDIA,1)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'FSEVAPNEG','F','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PFLWSP(KIDIA:KFDIA)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'FSLIQSNPL','F','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PRUISS(KIDIA:KFDIA)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'FRUISSURF','F','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*PRUISP(KIDIA:KFDIA)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'FRUISSPRF','F','ARP',.TRUE.,.TRUE.)
      CALL ADD_FIELD_2D(YDLDDH,PFRTHDS,'FSRAYTHDS','F','ARP',.TRUE.,.TRUE.)
      ZTMPAS(KIDIA:KFDIA)=-YDMF_PHYS_SURF%GSD_VF%PLSM(KIDIA:KFDIA)*RLMLT*PFONTE(KIDIA:KFDIA)
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'FFONTESNE','F','ARP',.TRUE.,.TRUE.)
 
      ZEPSA = 1.E-4_JPRB
      DO JLON=KIDIA, KFDIA
        ZTMPAS(JLON)=PFRSO(JLON,KLEV,1)/MAX(1.0_JPRB-PALB(JLON),ZEPSA)
      ENDDO
      CALL ADD_FIELD_2D(YDLDDH,ZTMPAS,'FSRAYSOLR','F','ARP',.TRUE.,.TRUE.)
      IF (NPRINTLEV >= 2) THEN
      WRITE(NULOUT,*) 'LFLEXDIA ARPEGE WITH NTOTSURF = ',NTOTSURF,&
         & ' AND NTOTSVAR = ',NTOTSVAR, ' AND NTOTSVFS = ',NTOTSVFS
      ENDIF
    ENDIF
  ENDIF

  IF (LECT.AND.LRAFTKE) THEN
     ! DCAPE due to precipitation evaporation.
     CALL ACEVADCAPE(KIDIA,KFDIA, KLON, KLEV,&
      & PFPLSL,PFPLSN,PFPLCL,PFPLCN,PAPRS,PAPRSF,PT,PCP,PAPHIF,PAPHI,ZDCAPE)
     ! Gusts.
     ZQGM=ZEPSNEB
     CALL ACCLDIA(YDXFU,YDPHY,YDPHY2,YDTOPH, KIDIA,KFDIA, KLON, KLEV,&
      & PUCLS, PVCLS, PU, PV, PCAPE, ZDCAPE, ZTKE1, PAPHIF, POROG, PUGST, PVGST, ZBLH, KCLPH)
     PCLPH(KIDIA:KFDIA)=MIN(XMAXLM,MAX(XMINLM,ZBLH(KIDIA:KFDIA)))
  ENDIF

  IF (LXVISI.OR.LXVISI2) THEN
     CALL ACVISIH(YDMODEL%YRML_PHY_MF%YRPHY%YRDVISI,KIDIA,KFDIA,KLON,KTDIA,KLEV,PAPHI,PAPHIF,PAPRSF,&
      & PT,PR,PQLI,PQICE,ZQR,ZQS,ZQGM,PVISICLD, PVISIHYDRO,PMXCLWC)
  ENDIF

ENDIF !LMPHYS
!----------------------------------------------------
!  CALCUL DE DEPOT HUMIDE POUR LES AEROSOLS DESERTIQUES
!----------------------------------------------------
IF (LMDUST.AND.(NGFL_EXT/=0).AND.LRDEPOS) THEN

IKRR=6
ISPLITR=1
ZEVAP=0.0_JPRB
ZZDEP=0.0_JPRB

  DO JLEV = 1 , KLEV
    DO JLON = KIDIA,KFDIA
      ZZDEP(JLON,1,JLEV)=ZZI_APHI(JLON,JLEV)*ZINVG
    ENDDO
  ENDDO


  DO JLEV=1,KLEV
    DO JLON= KIDIA, KFDIA
      ZQDM(JLON,JLEV)=1._JPRB-ZQV(JLON,JLEV)-ZQL(JLON,JLEV)-ZQR(JLON,JLEV) &
       & -ZQI(JLON,JLEV)-ZQS(JLON,JLEV)
    ENDDO
  ENDDO

  DO JLEV = 1, KLEV
    DO JLON = KIDIA,KFDIA
      ZZI_RM(JLON,1,JLEV,2)=ZQL(JLON,JLEV)&
       & /ZQDM(JLON,JLEV)
    ENDDO
  ENDDO

  DO JLEV = 1, KLEV
    DO JLON = KIDIA,KFDIA
      ZZI_RM(JLON,1,JLEV,3)=ZQR(JLON,JLEV)&
       & /ZQDM(JLON,JLEV)
    ENDDO
  ENDDO

  DO JLEV = 1, KLEV
    DO JLON = KIDIA,KFDIA
      ZEVAP(JLON,1,JLEV)=PFPEVPSL(JLON,JLEV)&
       & +PFPEVPCL(JLON,JLEV)
    ENDDO
  ENDDO

  DO JGFL=1,NGFL_EXT
    DO JLON=1,KLON
      DO JLEV=1,KLEV
        ZZI_SVM(JLON,1,JLEV,JGFL)=MAX(0._JPRB,ZSVM(JLON,JLEV,JGFL))
      ENDDO
    ENDDO
  ENDDO

    CALL ARO_WETDEP(ILONMNH,KLEV,NGFL_EXT,IKRR, PDT,&
                 & ZZI_SVM(KIDIA:KFDIA,:,:,1:NGFL_EXT),&
                 & ZZDEP(KIDIA:KFDIA,:,:),&
                 & ZZI_PABSM(KIDIA:KFDIA,:,:),&
                 & ZZI_THM(KIDIA:KFDIA,:,:),&
                 & ZZI_RHODREFM(KIDIA:KFDIA,:,:),&
                 & KSTEP+1,&
                 & ZZI_RM(KIDIA:KFDIA,:,:,:),&
                 & ZEVAP(KIDIA:KFDIA,:,:),&
                 & ISPLITR               )
! return to tendency
   DO JGFL=1,NGFL_EXT
     DO JLON=1,KLON
       DO JLEV=1,KLEV
         ZPSV(JLON,JLEV,JGFL)=ZZI_SVM(JLON,1,JLEV,JGFL)
       ENDDO
     ENDDO
   ENDDO

      DO JGFL=1,NGFL_EXT
        DO JLON=1,KLON
          DO JLEV=1,KLEV
            PTENDEXT_DEP(JLON,JLEV,JGFL)=(ZPSV(JLON,JLEV,JGFL)-ZSVM(JLON,JLEV,JGFL))*ZINVDT
          ENDDO
        ENDDO
      ENDDO

ENDIF ! ENDIF  (LMDUST & NGFL_EXT & LRDEPOS)

IF(LMUSCLFA) THEN
  DO JLEV=0,KLEV
    DO JLON=1,KLON
      ZFPLS(JLON,JLEV)=PFPLSL(JLON,JLEV)+PFPLSN(JLON,JLEV)
      ZFPLC(JLON,JLEV)=PFPLCL(JLON,JLEV)+PFPLCN(JLON,JLEV)
      ZFPL (JLON,JLEV)=ZFPLC (JLON,JLEV)+ZFPLS (JLON,JLEV)
    ENDDO
  ENDDO
  CALL WRSCMR(NMUSCLFA,'ZFPLS',ZFPLS,KLON,KLEV+1)
  CALL WRSCMR(NMUSCLFA,'ZFPLC',ZFPLC,KLON,KLEV+1)
  CALL WRSCMR(NMUSCLFA,'ZFPL',ZFPL,KLON,KLEV+1)
ENDIF

!     ------------------------------------------------------------------

! BAYRAD
! Compute convective hydrometeors mixing ratio from diagnistic fluxes
!--------------------------------------------------------------------
IF ( (.NOT. LGPCMT) ) THEN

   ! Convert from flux [kg/m2/s] to density [kg/m3] using old RTTOV-SCATT
   !  a    b         ! RR = a * LWC^b, [RR]=mm/h, [LWC]=g/m^3
   ! 20.89 1.15      ! rain
   ! 29.51 1.10      ! snow
   ZRHORAIN     = 1.0_JPRB
   ZRHOSNOW     = 0.1_JPRB

   ZCOEFRAIN(1) = ((1.0_JPRB / 20.89_JPRB) * 3600.0_JPRB) / ZRHORAIN
   ZCOEFRAIN(2) = (1.0_JPRB / 1.15_JPRB)
   ZCOEFSNOW(1) = ((1.0_JPRB / 29.51_JPRB) * 3600.0_JPRB) / ZRHOSNOW
   ZCOEFSNOW(2) = (1.0_JPRB / 1.10_JPRB)

   PQRCONV1(KIDIA:KFDIA,:) =  0.0_JPRB
   PQSCONV1(KIDIA:KFDIA,:) =  0.0_JPRB


   DO JLEV=1,KLEV
     DO JLON= KIDIA, KFDIA
       PQRCONV1(JLON,JLEV)  = 0.001_JPRB * ( (ABS(PFPLCL(JLON,JLEV)) * ZCOEFRAIN(1)) ** ZCOEFRAIN(2) )
       PQSCONV1(JLON,JLEV)  = 0.001_JPRB * ( (ABS(PFPLCN(JLON,JLEV)) * ZCOEFSNOW(1)) ** ZCOEFSNOW(2) )    
     ENDDO
   ENDDO


   ! Convert density [kg/m3] to mixing ratio [kg/kg]
   ! R_dry (dry air constant)

   ZDE2MR(KIDIA:KFDIA,:)  = RD * PT(KIDIA:KFDIA,:) / PAPRSF(KIDIA:KFDIA,:)
   PQRCONV1(KIDIA:KFDIA,:) = PQRCONV1(KIDIA:KFDIA,:) * ZDE2MR(KIDIA:KFDIA,:)
   PQSCONV1(KIDIA:KFDIA,:) = PQSCONV1(KIDIA:KFDIA,:) * ZDE2MR(KIDIA:KFDIA,:)

ENDIF


! Precipitation Type

! Compute wet-bulb temperature at 2 meters (suppose homogeneity of qv/ql/qi )
!ZPCLS(KIDIA:KFDIA)=PAPRS(KIDIA:KFDIA,KLEV)-2._JPRB/ZZZF(KIDIA:KFDIA,1,KLEV)*&
!                 &(PAPRS(KIDIA:KFDIA,KLEV)-PAPRSF(KIDIA:KFDIA,KLEV))
CALL PPWETPOINT(YDPHY,KIDIA,KFDIA,KLON,ZPCLS,PTCLS,&
  & PQ(:,KLEV),PQL(:,KLEV),PQI(:,KLEV),PTPWCLS)


IF (LDPRECIPS .OR. LDPRECIPS2) THEN
   ! Defined precipitation type
   !
   ! Compute wet-bulb temperature
  DO JLEV=1,KLEV
    CALL PPWETPOINT(YDPHY,KIDIA,KFDIA,KLON,PAPRSF(:,JLEV),PT(:,JLEV),&
     & PQ(:,JLEV),PQL(:,JLEV),PQI(:,JLEV),ZTW(:,JLEV))
  ENDDO

  DO JLON=1,KLON
      ZFPLS(JLON,KLEV)=PFPLCN(JLON,KLEV)+PFPLSN(JLON,KLEV)
      ZFPLC(JLON,KLEV)=PFPLCL(JLON,KLEV)+PFPLSL(JLON,KLEV)
      ZFPLSG(JLON,KLEV)=0._JPRB
  ENDDO

  !initialisation de ZZZ
  DO JLEV = 1,KLEV
    DO JLON = KIDIA,KFDIA
      ZZZ(JLON,1,JLEV)=PAPHI(JLON,JLEV)*ZINVG
    ENDDO
  ENDDO

  !initialisation de ZDZZ
  DO JLEV = 2, KLEV
    DO JLON = KIDIA,KFDIA
      ZDZZ(JLON,1,JLEV)=ZZZ(JLON,1,JLEV-1)-ZZZ(JLON,1,JLEV)
    ENDDO
  ENDDO
  DO JLON = KIDIA,KFDIA
      ZDZZ(JLON,1,1)=PAPHI(JLON,0)*ZINVG-ZZZ(JLON,1,1)
  ENDDO

  IF (LDPRECIPS) THEN

   NDTPRECCUR=INT(MOD(ZSTATI/TSTEP,REAL(NDTPREC)))+1_JPIM

   CALL DPRECIPS (YDPHY%YRDPRECIPS,KIDIA,KFDIA,KLON,KLEV,POROG,PTPWCLS,PDIAGH,PAPHIF,&
      & ZDZZ,ZTW,PQL,ZFPLC(:,KLEV),ZFPLS(:,KLEV),ZFPLSG(:,KLEV),PDPRECIPS(:,NDTPRECCUR))

  ! WRITE(20,*)'sous aplpar ZDPRECIPS ', ZDPRECIPS(KIDIA:KFDIA,NDTPRECCUR),NDTPRECCUR

  ENDIF

  IF (LDPRECIPS2) THEN

 !Idem for an other time step and an other period
   NDTPRECCUR2=INT(MOD(ZSTATI/TSTEP,REAL(NDTPREC2)))+1_JPIM

   CALL DPRECIPS(YDPHY%YRDPRECIPS,KIDIA,KFDIA,KLON,KLEV,POROG,PTPWCLS,PDIAGH,PAPHIF,&
      & ZDZZ,ZTW,PQL,ZFPLC(:,KLEV),ZFPLS(:,KLEV),ZFPLSG(:,KLEV),PDPRECIPS2(:,NDTPRECCUR2))

  ! WRITE(20,*)'sous aplpar ZDPRECIPS2',ZDPRECIPS2(KIDIA:KFDIA,NDTPRECCUR2),NDTPRECCUR2

  ENDIF
ENDIF  

!     ------------------------------------------------------------------
END ASSOCIATE
END ASSOCIATE
IF (LHOOK) CALL DR_HOOK('APLPAR',1,ZHOOK_HANDLE)
END SUBROUTINE APLPAR
