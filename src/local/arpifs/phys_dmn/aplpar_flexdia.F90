SUBROUTINE APLPAR_FLEXDIA (YDCPG_DIM, YDCPG_MISC, YDMF_PHYS, YDMF_PHYS_SURF, &
                         & YDMODEL, YDDDH, YDMF_PHYS_BASE_STATE)

USE PARKIND1, ONLY : JPIM, JPRB

USE CPG_DIM_TYPE_MOD   , ONLY : CPG_DIM_TYPE
USE CPG_TYPE_MOD       , ONLY : CPG_MISC_TYPE, CPG_DYN_TYPE, &
                              & CPG_SL1_TYPE, CPG_SL2_TYPE
USE MF_PHYS_TYPE_MOD   , ONLY : MF_PHYS_TYPE
USE MF_PHYS_SURFACE_TYPE_MOD,ONLY : MF_PHYS_SURF_TYPE
USE SURFACE_FIELDS_MIX , ONLY : TSURF
USE TYPE_MODEL         , ONLY : MODEL
USE DDH_MIX            , ONLY : ADD_FIELD_3D ,ADD_FIELD_2D ,NTOTSVAR , & 
                              & NTOTSURF ,NTOTSVFS, NEW_ADD_FIELD_3D, NEW_ADD_FIELD_2D, &
                              & TYP_DDH
USE MF_PHYS_BASE_STATE_TYPE_MOD &
                       , ONLY : MF_PHYS_BASE_STATE_TYPE
USE YOMMP0             , ONLY : NPRINTLEV
USE YOMLUN             , ONLY : NULOUT
USE YOMCST             , ONLY : RLMLT


IMPLICIT NONE

TYPE(CPG_DIM_TYPE),             INTENT(IN)    :: YDCPG_DIM
TYPE(CPG_MISC_TYPE),            INTENT(INOUT) :: YDCPG_MISC
TYPE(MF_PHYS_TYPE),             INTENT(INOUT) :: YDMF_PHYS
TYPE(MF_PHYS_SURF_TYPE),        INTENT(INOUT) :: YDMF_PHYS_SURF
TYPE(MODEL),                    INTENT(IN)    :: YDMODEL
TYPE(TYP_DDH),                  INTENT(INOUT) :: YDDDH
TYPE (MF_PHYS_BASE_STATE_TYPE), INTENT(IN)    :: YDMF_PHYS_BASE_STATE
REAL(KIND=JPRB) :: ZEPSA
REAL(KIND=JPRB) :: ZTMPAF(YDCPG_DIM%KLON,YDCPG_DIM%KFLEVG)
REAL(KIND=JPRB) :: ZTMPAS(YDCPG_DIM%KLON)

INTEGER (KIND=JPIM) :: JLON

IF (YDMODEL%YRML_DIAG%YRLDDH%LDDH_OMP) THEN
  ! Store in DDH the clouds used for radiative calculations
  ZTMPAF(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1:YDCPG_DIM%KFLEVG)=YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%DELP(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1:YDCPG_DIM%KFLEVG)*YDCPG_MISC%QICE(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1:YDCPG_DIM%KFLEVG)
  CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAF, 'VIR', YDDDH)
  ZTMPAF(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1:YDCPG_DIM%KFLEVG)=YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%DELP(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1:YDCPG_DIM%KFLEVG)*YDCPG_MISC%QLI(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1:YDCPG_DIM%KFLEVG)
  CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAF, 'VLR', YDDDH)
  ZTMPAF(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1:YDCPG_DIM%KFLEVG)=YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%DELP(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1:YDCPG_DIM%KFLEVG)*YDCPG_MISC%NEB(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1:YDCPG_DIM%KFLEVG)
  CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAF, 'VNT', YDDDH)

  ! surface variables
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, YDMF_PHYS_SURF%GSD_VF%PLSM, 'VLSM', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS_BASE_STATE%YGSP_RR%T(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)/YDMF_PHYS%OUT%CT(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'VSTS', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMODEL%YRML_PHY_MF%YRPHY1%RTINER*YDMF_PHYS_BASE_STATE%YGSP_SB%T(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%YRSURF%YSP_SBD%NLEVS)/YDMF_PHYS%OUT%CT(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'VSTP', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS_BASE_STATE%YGSP_RR%W(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'VSWS', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS_BASE_STATE%YGSP_SB%Q(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'VSWP', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS_BASE_STATE%YGSP_SG%F(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'VSWN', YDDDH)

  ! surface free-style variables
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, YDMF_PHYS%OUT%TCLS, 'VTCLS', YDDDH, CDTYPE='S'&
  & )
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, YDMF_PHYS%OUT%QCLS, 'VQCLS', YDDDH, CDTYPE='S'&
  & )
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, YDMF_PHYS%OUT%UCLS, 'VUCLS', YDDDH, CDTYPE='S'&
  & )
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, YDMF_PHYS%OUT%VCLS, 'VVCLS', YDDDH, CDTYPE='S'&
  & )
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, YDMF_PHYS%OUT%NUCLS, 'VNUCLS', YDDDH, CDTYPE='S'&
  & )
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, YDMF_PHYS%OUT%NVCLS, 'VNVCLS', YDDDH, CDTYPE='S'&
  & )
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_BASE_STATE%YCPG_DYN%PHI(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%KFLEVG)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'VSPHI', YDDDH, CDTYPE='S')
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, YDMF_PHYS%OUT%GZ0, 'VSGZ0', YDDDH, CDTYPE='S')
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, YDMF_PHYS%OUT%GZ0H, 'VSGZH', YDDDH, CDTYPE='S'&
  & )
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, YDMF_PHYS%OUT%ALB, 'VSALB', YDDDH, CDTYPE='S')
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, YDMF_PHYS%OUT%CLPH, 'VSCPH', YDDDH, CDTYPE='S'&
  & )

  ! surface fluxes free stlye or not
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FRSO(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%KFLEVG,1)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'FSRAYSODW', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FRTH(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%KFLEVG,1)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'FSRAYTHUP', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FCLL(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'FSCHLATLI', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FCLN(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'FSCHLATNE', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FCS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'FSCHLATSF', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FCHSP(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%YRSURF%YSP_SBD%NLEVS)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'FSCHGSNPL', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FONTE(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'FFONTESLI', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FPLSL(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%KFLEVG)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'FSPRELIGE', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FPLSN(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%KFLEVG)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'FSPRENEGE', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FPLCL(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%KFLEVG)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'FSPRELICO', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FPLCN(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%KFLEVG)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'FSPRENECO', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FEVL(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'FSEVAPLIQ', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FEVN(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'FSEVAPNEG', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FLWSP(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'FSLIQSNPL', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%RUISS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'FRUISSURF', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%RUISP(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'FRUISSPRF', YDDDH)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, YDMF_PHYS%OUT%FRTHDS, 'FSRAYTHDS', YDDDH)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=-YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*RLMLT*YDMF_PHYS%OUT%FONTE(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'FFONTESNE', YDDDH)

  ZEPSA = 1.E-4_JPRB
  DO JLON=YDCPG_DIM%KIDIA, YDCPG_DIM%KFDIA
    ZTMPAS(JLON)=YDMF_PHYS%OUT%FRSO(JLON,YDCPG_DIM%KFLEVG,1)/MAX(1.0_JPRB-YDMF_PHYS%OUT%ALB(JLON),ZEPSA)
  ENDDO
  CALL NEW_ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRMDDH, ZTMPAS, 'FSRAYSOLR', YDDDH)
  IF (NPRINTLEV >= 2) THEN
  WRITE(NULOUT,*) 'LFLEXDIA ARPEGE WITH NTOTSURF = ',NTOTSURF,&
     & ' AND NTOTSVAR = ',NTOTSVAR, ' AND NTOTSVFS = ',NTOTSVFS
  ENDIF

ELSE  

  ! Store in DDH the clouds used for radiative calculations
  ZTMPAF(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1:YDCPG_DIM%KFLEVG)=YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%DELP(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1:YDCPG_DIM%KFLEVG)*YDCPG_MISC%QICE(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1:YDCPG_DIM%KFLEVG)
  CALL ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAF, 'VIR', 'V', 'ARP', .TRUE., .TRUE.)
  ZTMPAF(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1:YDCPG_DIM%KFLEVG)=YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%DELP(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1:YDCPG_DIM%KFLEVG)*YDCPG_MISC%QLI(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1:YDCPG_DIM%KFLEVG)
  CALL ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAF, 'VLR', 'V', 'ARP', .TRUE., .TRUE.)
  ZTMPAF(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1:YDCPG_DIM%KFLEVG)=YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%DELP(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1:YDCPG_DIM%KFLEVG)*YDCPG_MISC%NEB(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1:YDCPG_DIM%KFLEVG)
  CALL ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAF, 'VNT', 'V', 'ARP', .TRUE., .TRUE.)

  ! surface variables
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, YDMF_PHYS_SURF%GSD_VF%PLSM, 'VLSM', 'V', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS_BASE_STATE%YGSP_RR%T(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)/YDMF_PHYS%OUT%CT(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'VSTS', 'V', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMODEL%YRML_PHY_MF%YRPHY1%RTINER*YDMF_PHYS_BASE_STATE%YGSP_SB%T(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%YRSURF%YSP_SBD%NLEVS)/YDMF_PHYS%OUT%CT(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'VSTP', 'V', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS_BASE_STATE%YGSP_RR%W(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'VSWS', 'V', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS_BASE_STATE%YGSP_SB%Q(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'VSWP', 'V', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS_BASE_STATE%YGSP_SG%F(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'VSWN', 'V', 'ARP', .TRUE., .TRUE.)

  ! surface free-style variables
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, YDMF_PHYS%OUT%TCLS, 'VTCLS', 'S', 'ARP', .TRUE., .TRUE.)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, YDMF_PHYS%OUT%QCLS, 'VQCLS', 'S', 'ARP', .TRUE., .TRUE.)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, YDMF_PHYS%OUT%UCLS, 'VUCLS', 'S', 'ARP', .TRUE., .TRUE.)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, YDMF_PHYS%OUT%VCLS, 'VVCLS', 'S', 'ARP', .TRUE., .TRUE.)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, YDMF_PHYS%OUT%NUCLS, 'VNUCLS', 'S', 'ARP', .TRUE., .TRUE.)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, YDMF_PHYS%OUT%NVCLS, 'VNVCLS', 'S', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_BASE_STATE%YCPG_DYN%PHI(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%KFLEVG)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'VSPHI', 'S', 'ARP', .TRUE., .TRUE.)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, YDMF_PHYS%OUT%GZ0, 'VSGZ0', 'S', 'ARP', .TRUE., .TRUE.)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, YDMF_PHYS%OUT%GZ0H, 'VSGZH', 'S', 'ARP', .TRUE., .TRUE.)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, YDMF_PHYS%OUT%ALB, 'VSALB', 'S', 'ARP', .TRUE., .TRUE.)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, YDMF_PHYS%OUT%CLPH, 'VSCPH', 'S', 'ARP', .TRUE., .TRUE.)

  ! surface fluxes free stlye or not
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FRSO(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%KFLEVG,1)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'FSRAYSODW', 'F', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FRTH(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%KFLEVG,1)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'FSRAYTHUP', 'F', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FCLL(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'FSCHLATLI', 'F', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FCLN(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'FSCHLATNE', 'F', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FCS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'FSCHLATSF', 'F', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FCHSP(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%YRSURF%YSP_SBD%NLEVS)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'FSCHGSNPL', 'F', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FONTE(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'FFONTESLI', 'F', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FPLSL(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%KFLEVG)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'FSPRELIGE', 'F', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FPLSN(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%KFLEVG)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'FSPRENEGE', 'F', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FPLCL(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%KFLEVG)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'FSPRELICO', 'F', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FPLCN(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,YDCPG_DIM%KFLEVG)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'FSPRENECO', 'F', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FEVL(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'FSEVAPLIQ', 'F', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FEVN(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA,1)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'FSEVAPNEG', 'F', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%FLWSP(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'FSLIQSNPL', 'F', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%RUISS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'FRUISSURF', 'F', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*YDMF_PHYS%OUT%RUISP(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'FRUISSPRF', 'F', 'ARP', .TRUE., .TRUE.)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, YDMF_PHYS%OUT%FRTHDS, 'FSRAYTHDS', 'F', 'ARP', .TRUE., .TRUE.)
  ZTMPAS(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)=-YDMF_PHYS_SURF%GSD_VF%PLSM(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)*RLMLT*YDMF_PHYS%OUT%FONTE(YDCPG_DIM%KIDIA:YDCPG_DIM%KFDIA)
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'FFONTESNE', 'F', 'ARP', .TRUE., .TRUE.)

  ZEPSA = 1.E-4_JPRB
  DO JLON=YDCPG_DIM%KIDIA, YDCPG_DIM%KFDIA
    ZTMPAS(JLON)=YDMF_PHYS%OUT%FRSO(JLON,YDCPG_DIM%KFLEVG,1)/MAX(1.0_JPRB-YDMF_PHYS%OUT%ALB(JLON),ZEPSA)
  ENDDO
  CALL ADD_FIELD_2D(YDMODEL%YRML_DIAG%YRLDDH, ZTMPAS, 'FSRAYSOLR', 'F', 'ARP', .TRUE., .TRUE.)
  IF (NPRINTLEV >= 2) THEN
  WRITE(NULOUT,*) 'LFLEXDIA ARPEGE WITH NTOTSURF = ',NTOTSURF,&
     & ' AND NTOTSVAR = ',NTOTSVAR, ' AND NTOTSVFS = ',NTOTSVFS
  ENDIF
ENDIF


END SUBROUTINE
