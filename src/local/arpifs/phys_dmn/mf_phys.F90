SUBROUTINE MF_PHYS (YDGEOMETRY, YDCPG_DIM, YDCPG_MISC, YDCPG_GPAR, YDCPG_PHY0, YDCPG_PHY9, YDMF_PHYS,         &
& YDMF_PHYS_TMP, YDCPG_DYN0, YDCPG_DYN9, YDMF_PHYS_SURF, YDCPG_SL1, YDCPG_SL2, YDVARS, YDMODEL, YDFIELDS, &
& LDCONFX, PDTPHY, PGPSDT2D, PGFL, PGMVT1, PGFLT1, PTRAJ_PHYS, YDDDH)

USE PARKIND1, ONLY : JPIM, JPRB

USE GEOMETRY_MOD       , ONLY : GEOMETRY
USE CPG_DIM_TYPE_MOD   , ONLY : CPG_DIM_TYPE
USE MF_PHYS_TYPE_MOD   , ONLY : MF_PHYS_TYPE, MF_PHYS_TMP_TYPE
USE CPG_TYPE_MOD       , ONLY : CPG_DYN_TYPE, CPG_PHY_TYPE, CPG_MISC_TYPE, &
                              & CPG_TND_TYPE, CPG_TMP_TYPE, CPG_DDH_TYPE, &
                              & CPG_SL1_TYPE, CPG_SL2_TYPE, CPG_GPAR_TYPE
USE MF_PHYS_SURFACE_TYPE_MOD,ONLY : MF_PHYS_SURF_TYPE
USE FIELD_VARIABLES_MOD, ONLY : FIELD_VARIABLES
USE TYPE_MODEL         , ONLY : MODEL
USE FIELDS_MOD         , ONLY : FIELDS
USE YOMTRAJ            , ONLY : TRAJ_PHYS_TYPE, TRAJ_SLAG_TYPE
USE DDH_MIX            , ONLY : TYP_DDH, SETDDH, CLEANDDH
USE YOMSPSDT           , ONLY : YSPPT


IMPLICIT NONE

TYPE(GEOMETRY)    ,INTENT(IN)    :: YDGEOMETRY
TYPE(CPG_DIM_TYPE),INTENT(IN)    :: YDCPG_DIM
TYPE(CPG_MISC_TYPE),INTENT(INOUT):: YDCPG_MISC
TYPE(CPG_GPAR_TYPE),INTENT(INOUT):: YDCPG_GPAR
TYPE(CPG_PHY_TYPE),INTENT(INOUT) :: YDCPG_PHY0
TYPE(CPG_PHY_TYPE),INTENT(INOUT) :: YDCPG_PHY9
TYPE(MF_PHYS_TYPE),INTENT(INOUT) :: YDMF_PHYS
TYPE(MF_PHYS_TMP_TYPE), INTENT(INOUT) :: YDMF_PHYS_TMP
TYPE(CPG_DYN_TYPE),INTENT(INOUT) :: YDCPG_DYN0
TYPE(CPG_DYN_TYPE),INTENT(INOUT) :: YDCPG_DYN9
TYPE(MF_PHYS_SURF_TYPE),INTENT(INOUT) :: YDMF_PHYS_SURF
TYPE(CPG_SL1_TYPE),INTENT(INOUT) :: YDCPG_SL1
TYPE(CPG_SL2_TYPE),INTENT(INOUT) :: YDCPG_SL2
TYPE(FIELD_VARIABLES),INTENT(INOUT) :: YDVARS
TYPE(MODEL)       ,INTENT(INOUT) :: YDMODEL
TYPE(FIELDS)      ,INTENT(INOUT) :: YDFIELDS
LOGICAL           ,INTENT(IN)    :: LDCONFX
REAL(KIND=JPRB)   ,INTENT(IN)    :: PDTPHY
REAL(KIND=JPRB)   ,INTENT(IN)    :: PGPSDT2D(YDCPG_DIM%KLON,YSPPT%YGPSDT(1)%NG2D)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PGFL(YDCPG_DIM%KLON,YDCPG_DIM%KFLEVG,YDMODEL%YRML_GCONF%YGFL%NDIM)

REAL(KIND=JPRB)   ,INTENT(OUT)   :: PGMVT1(YDCPG_DIM%KLON,YDCPG_DIM%KFLEVG,YDFIELDS%YRGMV%YT1%NDIM)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PGFLT1(YDCPG_DIM%KLON,YDCPG_DIM%KFLEVG,YDMODEL%YRML_GCONF%YGFL%NDIM1)
TYPE (TRAJ_PHYS_TYPE),INTENT(INOUT) :: PTRAJ_PHYS
TYPE(TYP_DDH)        , INTENT(INOUT) :: YDDDH


#include "apl_arome.intfb.h"
#include "aplpar.intfb.h"
#include "aplsim.intfb.h"
#include "mf_phys_prep.intfb.h"

LOGICAL :: LLNEW
CHARACTER*16 :: CLNEW

!*       4.4.1   Call MF unlagged physics (predictor only if PC scheme).

CALL MF_PHYS_PREP(YDGEOMETRY, YDCPG_DIM, YDMODEL%YRML_PHY_MF%YRARPHY, YDCPG_DYN0%OROGL, YDCPG_DYN0%OROGM,     &
& YDVARS%U%T0, YDVARS%V%T0, YDVARS%U%T9, YDVARS%V%T9, YDCPG_DYN0%RCP%R, YDCPG_DYN9%RCP%CP, YDCPG_DYN0%GWFT,   &
& YDCPG_DYN9%GWFT, YDCPG_DYN0%GWFL, YDCPG_DYN0%GWFM, YDCPG_DYN0%NHPREF, YDCPG_DYN9%NHPREF, YDCPG_DYN0%NHPREH, &
& YDCPG_DYN9%NHPREH, YDCPG_DYN0%PREF, YDCPG_DYN9%PREF, YDCPG_DYN0%PRE, YDCPG_DYN9%PRE, YDCPG_DYN0%XYB%DELP,   &
& YDCPG_DYN0%XYB%RDELP, YDCPG_DYN0%XYB%LNPR, YDCPG_DYN0%XYB%ALPH, YDCPG_DYN9%XYB%DELP, YDCPG_DYN9%XYB%RDELP,  &
& YDCPG_DYN9%XYB%LNPR, YDCPG_DYN9%XYB%ALPH, YDCPG_PHY0%W, YDCPG_PHY9%W, YDCPG_PHY0%WL, YDCPG_PHY0%WM,         &
& YDCPG_PHY0%PREF, YDCPG_PHY9%PREF, YDCPG_PHY0%PRE, YDCPG_PHY9%PRE, YDCPG_PHY0%PREHYDF, YDCPG_PHY9%PREHYDF,   &
& YDCPG_PHY0%PREHYD, YDCPG_PHY9%PREHYD, YDCPG_PHY0%XYB%DELP, YDCPG_PHY0%XYB%RDELP, YDCPG_PHY0%XYB%LNPR,       &
& YDCPG_PHY0%XYB%ALPH, YDCPG_PHY9%XYB%DELP, YDCPG_PHY9%XYB%RDELP, YDCPG_PHY9%XYB%LNPR, YDCPG_PHY9%XYB%ALPH)

IF (YDMODEL%YRML_PHY_MF%YRSIMPHL%LSIMPH) THEN
  CALL APLSIM(YDGEOMETRY, YDCPG_DIM, YDCPG_MISC, YDCPG_PHY0, YDCPG_PHY9, YDMF_PHYS,            &
  & YDMF_PHYS_TMP, YDCPG_DYN0, YDCPG_DYN9, YDMF_PHYS_SURF, YDVARS, YDFIELDS%YRGMV, YDFIELDS%YRSURF, &
  & YDFIELDS%YRCFU, YDFIELDS%YRXFU, YDMODEL, LDCONFX, PDTPHY, PGFL, YDCPG_MISC%KOZO, PGPSDT2D,      &
  & YDCPG_SL1, YDCPG_SL2, PGMVT1, PGFLT1, YDCPG_GPAR%ZVIEW, PTRAJ_PHYS, YDDDH, YDCPG_MISC%FTCNS)
ELSEIF (YDMODEL%YRML_PHY_MF%YRARPHY%LMPA) THEN
  CALL APL_AROME(YDGEOMETRY, YDCPG_DIM, YDCPG_MISC, YDCPG_PHY0, YDCPG_PHY9, YDMF_PHYS,            &
  & YDMF_PHYS_TMP, YDCPG_DYN0, YDCPG_DYN9, YDMF_PHYS_SURF, YDVARS, YDFIELDS%YRGMV, YDFIELDS%YRSURF, &
  & YDFIELDS%YRCFU, YDFIELDS%YRXFU, YDMODEL, LDCONFX, PDTPHY, PGFL, YDCPG_MISC%KOZO, PGPSDT2D,      &
  & YDCPG_SL1%ZVIEW, YDCPG_SL2%ZVIEW, PGMVT1, PGFLT1, YDCPG_GPAR%ZVIEW, PTRAJ_PHYS, YDDDH, YDCPG_MISC%FTCNS)
ELSE
  CLNEW = ''
  CALL GETENV ('APLPAR_NEW', CLNEW)
  LLNEW = (CLNEW /= '') .AND. (CLNEW /= '0')

  IF (LLNEW) THEN
  ELSE
  CALL APLPAR(  YDGEOMETRY, YDCPG_DIM, YDCPG_MISC, YDCPG_PHY0, YDCPG_PHY9, YDMF_PHYS,                        &
  & YDMF_PHYS_TMP, YDCPG_DYN0, YDCPG_DYN9, YDMF_PHYS_SURF, YDCPG_SL1, YDCPG_SL2, YDVARS, YDFIELDS%YRGMV, YDFIELDS%YRSURF, &
  & YDFIELDS%YRCFU, YDFIELDS%YRXFU, YDMODEL, LDCONFX, PDTPHY, PGFL, YDCPG_MISC%KOZO, PGPSDT2D,                    &
  & PGMVT1, PGFLT1, YDCPG_GPAR%ZVIEW, PTRAJ_PHYS, YDDDH, YDCPG_MISC%FTCNS)
  ENDIF

ENDIF

END SUBROUTINE
