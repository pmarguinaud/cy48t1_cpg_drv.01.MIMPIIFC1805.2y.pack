SUBROUTINE MF_PHYS_MOCON (YDCPG_BNDS, YDCPG_OPTS, POUT_MOCON, PRDG_LCVQ, PMOC_CLPH, YDMF_PHYS_STATE)

USE YOMHOOK, ONLY : LHOOK, DR_HOOK
USE PARKIND1, ONLY : JPIM, JPRB

USE CPG_OPTS_TYPE_MOD   , ONLY : CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE MF_PHYS_TYPE_MOD   , ONLY : MF_PHYS_TYPE
USE MF_PHYS_BASE_STATE_TYPE_MOD &
                       , ONLY : MF_PHYS_BASE_STATE_TYPE


IMPLICIT NONE

TYPE(CPG_BNDS_TYPE),INTENT(IN)        :: YDCPG_BNDS
TYPE(CPG_OPTS_TYPE),INTENT(IN)        :: YDCPG_OPTS
REAL (KIND=JPRB),  INTENT(INOUT)      :: POUT_MOCON (YDCPG_OPTS%KLON)
REAL (KIND=JPRB),  INTENT(IN)         :: PRDG_LCVQ (YDCPG_OPTS%KLON, 1:YDCPG_OPTS%KFLEVG)
INTEGER (KIND=JPIM), INTENT(IN)       :: PMOC_CLPH (YDCPG_OPTS%KLON)
TYPE (MF_PHYS_BASE_STATE_TYPE) :: YDMF_PHYS_STATE

INTEGER (KIND=JPIM) :: JLEV
INTEGER (KIND=JPIM) :: JROF

REAL (KIND=JPRB) :: ZHOOK_HANDLE

IF (LHOOK) CALL DR_HOOK ('MF_PHYS_MOCON', 0, ZHOOK_HANDLE)

DO JLEV=1,YDCPG_OPTS%KFLEVG
  DO JROF = YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
    POUT_MOCON(JROF) = POUT_MOCON(JROF)+(PRDG_LCVQ(JROF,JLEV)-YDMF_PHYS_STATE%Q(JROF,JLEV)*&
     & YDMF_PHYS_STATE%DIV(JROF,JLEV))*YDMF_PHYS_STATE%YCPG_PHY%XYB%DELP(JROF,JLEV)&
     & *MAX(0,SIGN(1,JLEV-PMOC_CLPH(JROF)))  
  ENDDO
ENDDO
DO JROF = YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
  POUT_MOCON(JROF) = POUT_MOCON(JROF)/(YDMF_PHYS_STATE%YCPG_PHY%PREHYD(JROF,YDCPG_OPTS%KFLEVG)-YDMF_PHYS_STATE%YCPG_PHY%PREHYD(JROF,PMOC_CLPH(JROF)-1))
ENDDO

IF (LHOOK) CALL DR_HOOK ('MF_PHYS_MOCON', 1, ZHOOK_HANDLE)

END SUBROUTINE MF_PHYS_MOCON
