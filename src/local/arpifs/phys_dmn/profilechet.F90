SUBROUTINE PROFILECHET(YDGEOMETRY,&
 & YDCPG_MISC,YDMF_PHYS,PRDG_CVGQ, PRDG_LCVQ, PRDG_MU0,YDCPG_DYN0,YDMF_PHYS_SURF,YDVARS,&
 & YDSURF, YDDPHY,YDRIP,YDML_PHY_MF,KLON, PGELAM, PGEMU,&
 & PGM, POROG, PRCORI, PRATATH, PRATATX )

USE MF_PHYS_TYPE_MOD   , ONLY : MF_PHYS_TYPE
USE CPG_TYPE_MOD       , ONLY : CPG_DYN_TYPE, &
                              & CPG_MISC_TYPE
USE MF_PHYS_SURFACE_TYPE_MOD,ONLY : MF_PHYS_SURF_TYPE
USE FIELD_VARIABLES_MOD, ONLY : FIELD_VARIABLES
USE MODEL_PHYSICS_MF_MOD , ONLY : MODEL_PHYSICS_MF_TYPE
USE YOMRIP       , ONLY : TRIP
USE GEOMETRY_MOD , ONLY : GEOMETRY
USE SURFACE_FIELDS_MIX , ONLY : TSURF
USE PARKIND1  ,ONLY : JPIM    ,JPRB
USE YOMHOOK   ,ONLY : LHOOK   ,DR_HOOK
USE YOMCHET   ,ONLY : GCHET   ,GCHETN
USE YOMDPHY   ,ONLY : TDPHY
USE YOMLUN    ,ONLY : NULOUT

IMPLICIT NONE

! **** *PROFILECHET* 

!---------------------------------------------------------------- 
!   Purpose
!   -------
!   Output profiles for SCM for points with physical tendencies exceding 
!   the threshold.

!----------------------------------------------------------------!
!   Author
!   ------
!   2004-03-01: T.Kovacic, J.M.Piriou, F.Bouyssel

!   Modifications
!   -------------
!   2004-10, F. Bouyssel : cleaning
!   2007-05, F. Bouyssel : add PFCLL, PFCLN
!   2011-06: M. Jerczynski - some cleaning to meet norms

!----------------------------------------------------------------

!-------------------------------------------------
!  Dummy variables 
!-------------------------------------------------

TYPE(GEOMETRY)    ,INTENT(IN)    :: YDGEOMETRY
TYPE(CPG_MISC_TYPE),INTENT(IN)   :: YDCPG_MISC
TYPE(MF_PHYS_TYPE),INTENT(IN)    :: YDMF_PHYS

REAL (KIND=JPRB),  INTENT (IN)   :: PRDG_CVGQ (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB),  INTENT (IN)   :: PRDG_LCVQ (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB),  INTENT (IN)   :: PRDG_MU0 (YDGEOMETRY%YRDIM%NPROMA)

TYPE(CPG_DYN_TYPE),INTENT(IN)    :: YDCPG_DYN0
TYPE(MF_PHYS_SURF_TYPE),INTENT(IN) :: YDMF_PHYS_SURF
TYPE(FIELD_VARIABLES),INTENT(IN) :: YDVARS
TYPE(TSURF)       ,INTENT(IN)    :: YDSURF
TYPE(TDPHY)       ,INTENT(IN)    :: YDDPHY
TYPE(MODEL_PHYSICS_MF_TYPE),INTENT(IN):: YDML_PHY_MF
TYPE(TRIP)        ,INTENT(IN)    :: YDRIP
INTEGER(KIND=JPIM),INTENT(IN)    :: KLON
REAL(KIND=JPRB)   ,INTENT(IN)    :: PGELAM(YDGEOMETRY%YRDIM%NPROMA)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PGEMU(YDGEOMETRY%YRDIM%NPROMA)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PGM(YDGEOMETRY%YRDIM%NPROMA)
REAL(KIND=JPRB)   ,INTENT(IN)    :: POROG(YDGEOMETRY%YRDIM%NPROMA)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PRCORI(YDGEOMETRY%YRDIM%NPROMA)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PRATATH(YDGEOMETRY%YRDIM%NPROMA)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PRATATX(YDGEOMETRY%YRDIM%NPROMA)
LOGICAL :: LLTEST
INTEGER(KIND=JPIM) :: I, J, IIND
INTEGER(KIND=JPIM), DIMENSION(GCHET%NPHTEXTH) :: JIND
REAL(KIND=JPRB) :: ZHOOK_HANDLE

#include "writeprofile.intfb.h"
!-------------------------------------------------
! Check arguments.
!-------------------------------------------------

IF (LHOOK) CALL DR_HOOK('PROFILECHET', 0, ZHOOK_HANDLE)
ASSOCIATE(YDDIM=>YDGEOMETRY%YRDIM,YDDIMV=>YDGEOMETRY%YRDIMV,YDGEM=>YDGEOMETRY%YRGEM, YDMP=>YDGEOMETRY%YRMP)
ASSOCIATE(NPROMA=>YDDIM%NPROMA, NPROMM=>YDDIM%NPROMM, &
 & NFLEVG=>YDDIMV%NFLEVG, &
 & NTSSG=>YDDPHY%NTSSG)
! ----------------------------------------------------
  
  ! deleting multiple points over the same geographical point
IIND = 1
JIND(IIND) = 1
DO I = 2, GCHET%NPHTEXTH
  LLTEST=.TRUE.
  DO J = 1, I-1
    IF(GCHET%APOINT(I)%NCHETLONG==GCHET%APOINT(J)%NCHETLONG) THEN
      LLTEST=.FALSE.
      EXIT
    ENDIF
  ENDDO
  IF (LLTEST) THEN
    IIND = IIND + 1
    JIND(IIND) = I
  ENDIF
ENDDO

GCHET%NPHTEXTH = IIND
DO I = 1, IIND
  GCHET%APOINT(I) = GCHET%APOINT(JIND(I))
ENDDO

IF (GCHET%NPHTEXTH>GCHETN%NPROFMAX) THEN
  WRITE(NULOUT,*) 'WARNING : MAX NUMBER OF PROFILES REACHED IN PROFILECHET!'
  GCHET%NPHTEXTH = GCHETN%NPROFMAX
ENDIF

DO J = 1, GCHET%NPHTEXTH
  CALL WRITEPROFILE(YDGEOMETRY, &
  & YDCPG_MISC,YDMF_PHYS,PRDG_CVGQ, PRDG_LCVQ, PRDG_MU0,YDCPG_DYN0,YDMF_PHYS_SURF,YDVARS,&
  & YDSURF, YDDPHY, YDRIP, YDML_PHY_MF, 'CHET.PROFILE.', GCHET%APOINT(J)%NCHETLONG,                &
  & GCHET%APOINT(J)%ALAT, GCHET%APOINT(J)%ALONG, 0._JPRB, PGELAM, PGEMU, PGM, POROG, &
  & PRCORI, PRATATH, PRATATX)
ENDDO
GCHET%NPHTEXTH = 0

END ASSOCIATE
END ASSOCIATE
IF (LHOOK) CALL DR_HOOK('PROFILECHET', 1, ZHOOK_HANDLE)

END SUBROUTINE PROFILECHET
