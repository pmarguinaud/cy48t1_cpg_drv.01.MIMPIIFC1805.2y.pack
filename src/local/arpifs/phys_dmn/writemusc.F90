SUBROUTINE WRITEMUSC(&
  &YDCPG_MISC,YDCPG_PHY0,YDCPG_PHY9,YDMF_PHYS,YDCPG_DYN0,YDCPG_DYN9,YDMF_PHYS_SURF,YDVARS,&
  &YDVETA, YDRIP,YDML_PHY_MF,KIDIA  , KFDIA  , KLON   ,&
  &KTDIA  , KLEV   , KGL1   , KGL2   ,&
  &KSTEP  , KSGST  , KCSS   ,&
  &PCLON  , PSLON  ,&
  &PGELAM , PGEMU  , PGM    , POROG  ,&
  &CDLOCK, &
  &PRDG_CVGQ, PRDG_MU0, YDAPLPAR_TMP)

!     **** *WRITEMUSC* - Ecriture des resultats de la physique.

!     Purpose.
!     --------
!     Ecriture des resultats de la physique.

!     **   Interface.
!     ----------

!     Explicit arguments :    None.
!     --------------------

!     Implicit arguments :    None.
!     --------------------

!     Method.
!     -------

!     Externals.   None.
!     ----------

!     Reference.
!     ----------

!     Author.
!     -------
!     Eric Bazile, Francois Bouyssel et Jean-Marcel Piriou
!     Original :97-02-01

!     Modifications.
!     --------------
!     Modified for MUSC 2008-04-23 Eric BAZILE
!     F. Kocaman 2011-10-04 : CY38 cleaning
!     K. Yessad (July 2014): Move some variables.
!     ------------------------------------------------------------------

USE MF_PHYS_TYPE_MOD   , ONLY : MF_PHYS_TYPE, APLPAR_TMP_TYPE, MF_PHYS_TMP_TYPE
USE CPG_TYPE_MOD       , ONLY : CPG_DYN_TYPE, CPG_PHY_TYPE, &
                              & CPG_MISC_TYPE
USE MF_PHYS_SURFACE_TYPE_MOD,ONLY : MF_PHYS_SURF_TYPE
USE FIELD_VARIABLES_MOD, ONLY : FIELD_VARIABLES
USE MODEL_PHYSICS_MF_MOD , ONLY : MODEL_PHYSICS_MF_TYPE
USE YOMVERT  , ONLY : TVETA
USE PARKIND1 , ONLY : JPIM     ,JPRB
USE YOMHOOK  , ONLY : LHOOK    ,DR_HOOK

USE YOMRIP0  , ONLY : NINDAT   ,NSSSSS
USE YOMRIP   , ONLY : TRIP
USE YOMCST   , ONLY : RPI, RG, RCPD, RKAPPA, RETV, RATM, RTT,&
                   &RLVTT, RCPV, RCW, RLSTT, RCS, RALPW, RBETW,&
                   &RGAMW, RALPS, RBETS, RGAMS, RALPD, RBETD,&
                   &RGAMD, RV 
USE YOMCT0   , ONLY : LECMWF, LAROME

!     ------------------------------------------------------------------

IMPLICIT NONE

TYPE(CPG_MISC_TYPE),INTENT(INOUT):: YDCPG_MISC
TYPE(CPG_PHY_TYPE),INTENT(INOUT) :: YDCPG_PHY0
TYPE(CPG_PHY_TYPE),INTENT(INOUT) :: YDCPG_PHY9
TYPE(MF_PHYS_TYPE),INTENT(INOUT) :: YDMF_PHYS
TYPE(CPG_DYN_TYPE),INTENT(INOUT) :: YDCPG_DYN0
TYPE(CPG_DYN_TYPE),INTENT(INOUT) :: YDCPG_DYN9
TYPE(MF_PHYS_SURF_TYPE),INTENT(INOUT) :: YDMF_PHYS_SURF
TYPE(FIELD_VARIABLES),INTENT(INOUT) :: YDVARS
TYPE(TVETA)       ,INTENT(IN) :: YDVETA
TYPE(MODEL_PHYSICS_MF_TYPE),INTENT(INOUT):: YDML_PHY_MF
TYPE(TRIP)        ,INTENT(INOUT):: YDRIP
INTEGER(KIND=JPIM),INTENT(IN) :: KFDIA, KGL1, KGL2, KIDIA, KSTEP
INTEGER(KIND=JPIM),INTENT(IN) :: KTDIA, KLEV, KLON
INTEGER(KIND=JPIM),INTENT(IN) :: KSGST, KCSS
REAL(KIND=JPRB),INTENT(IN) :: PGEMU(KLON),PGELAM(KLON),PGM(KLON),POROG(KLON)
REAL(KIND=JPRB),INTENT(IN) :: PCLON(KLON), PSLON(KLON)

REAL (KIND=JPRB), INTENT (IN) :: PRDG_CVGQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN) :: PRDG_MU0 (KLON)
TYPE(APLPAR_TMP_TYPE), INTENT(IN),OPTIONAL :: YDAPLPAR_TMP
CHARACTER(LEN=9)  ,INTENT(IN)    :: CDLOCK

!     ------------------------------------------------------------------
! ----------------------------------------------
! Postprocessing fields
! ----------------------------------------------

REAL(KIND=JPRB), EXTERNAL :: THETA,THETAL_KE,THETAV,THETAVL,HCLA
REAL(KIND=JPRB), EXTERNAL :: THETAE_BOLTON,THETAES_BOLTON
REAL(KIND=JPRB) :: ZW(KLON,KLEV)
REAL(KIND=JPRB) :: ZVENT(KLON,KLEV),ZDIRVENT(KLON,KLEV)
REAL(KIND=JPRB) :: ZVENTCLS(KLON),ZDIRCLS(KLON)
REAL(KIND=JPRB) :: ZECT(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZELEVATION(KLON,KLEV+1)
REAL(KIND=JPRB) :: ZTHETA(KLON,KLEV+1)
REAL(KIND=JPRB) :: ZTHETAL_KE(KLON,KLEV+1)
REAL(KIND=JPRB) :: ZTHETAL(KLON,KLEV+1)
REAL(KIND=JPRB) :: ZTHETAL_LES(KLON,KLEV+1)
REAL(KIND=JPRB) :: ZTHETAV(KLON,KLEV+1)
REAL(KIND=JPRB) :: ZTHETAVL(KLON,KLEV+1)
REAL(KIND=JPRB) :: ZQC(KLON,KLEV),ZH(KLON,KLEV)
REAL(KIND=JPRB) :: ZLWP(KLON),ZECT_INT(KLON)
REAL(KIND=JPRB) :: ZIWP(KLON)
REAL(KIND=JPRB) :: ZCWP(KLON)
REAL(KIND=JPRB) :: ZWVP(KLON)
REAL(KIND=JPRB) :: ZTHETAS(KLON),ZLMO(KLON),ZHEATS(KLON),ZBLHG(KLON),ZUSTAR(KLON)
REAL(KIND=JPRB) :: ZRHO(KLON,KLEV),ZRHOFLUX(KLON,0:KLEV),ZCPFLUX(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZUPWP(KLON,0:KLEV),ZVPWP(KLON,0:KLEV),ZLIM(KLON)
REAL(KIND=JPRB) :: ZWPQP(KLON,0:KLEV),ZHEAT(KLON,0:KLEV),ZWT(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZRRTOTAL(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZWTHETAL(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZWPQLP(KLON,0:KLEV),ZWPQIP(KLON,0:KLEV),ZLWPQTP(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZWPQPS(KLON),ZLH(KLON,0:KLEV)
REAL(KIND=JPRB) :: ZRI(KLON,0:KLEV),ZDTRAD(KLON,KLEV)
REAL(KIND=JPRB) :: ZZUV,ZZUVB,ZALPHA,ZBETA,ZZ,ZDPHI,ZZRTI,ZCIS,ZDTETA,ZSTA
REAL(KIND=JPRB) :: ZMEAN_SAT_DEF(KLON),ZTOP(KLON),ZBASE(KLON),ZHCLA
REAL(KIND=JPRB) :: ZNEBMAX(KLON),ZMAXFRAC(KLON)
REAL(KIND=JPRB) :: ZDELTAPSG,ZVAL,ZDELTA,ZT

INTEGER(KIND=JPIM) :: JLEV,JLON,ILEV, IUSCM
REAL(KIND=JPRB) :: ZTHETABOT(KLON),ZRBOT(KLON),ZLCL(KLON)


REAL(KIND=JPRB) :: ZHOOK_HANDLE

!     ------------------------------------------------------------------

#include "ecr1d.intfb.h"
#include "wrscmr.intfb.h"
#include "fcttrm.func.h"

!     ------------------------------------------------------------------
IF (LHOOK) CALL DR_HOOK('WRITEMUSC',0,ZHOOK_HANDLE)
ASSOCIATE(VKARMN=>YDML_PHY_MF%YRPHY0%VKARMN, &
 & TSPHY=>YDML_PHY_MF%YRPHY2%TSPHY, &
 & LMSE=>YDML_PHY_MF%YRARPHY%LMSE, &
 & LCONDWT=>YDML_PHY_MF%YRPHY%LCONDWT, LECTFL=>YDML_PHY_MF%YRPHY%LECTFL, LSOLV=>YDML_PHY_MF%YRPHY%LSOLV, &
 & LRAYFM=>YDML_PHY_MF%YRPHY%LRAYFM, LVGSN=>YDML_PHY_MF%YRPHY%LVGSN, LECT=>YDML_PHY_MF%YRPHY%LECT, &
 & LSNV=>YDML_PHY_MF%YRPHY%LSNV, &
 & LEFB=>YDML_PHY_MF%YRPHY%LEFB, LPROCLD=>YDML_PHY_MF%YRPHY%LPROCLD, &
 & RSTATI=>YDRIP%RSTATI)
!     ------------------------------------------------------------------

! * basic dimensioning (levels, time, vertical structure functions ...)
IF(CDLOCK /= 'WRITEMUSC') CALL ABOR1('BAD NUMBER OF ARGUMENTS!')

IUSCM=86
DO JLON=KIDIA,KFDIA
   DO JLEV=KTDIA,KLEV
      ZRHO(JLON,JLEV)=YDCPG_PHY0%PREHYDF(JLON,JLEV)/(YDCPG_DYN0%RCP%R(JLON,JLEV)*YDVARS%T%T0(JLON,JLEV))
   ENDDO
ENDDO
CALL WRSCMR(IUSCM,'RHO',ZRHO,KLON,KLEV)
DO JLON=KIDIA,KFDIA
ZRHOFLUX(JLON,KLEV)=YDCPG_PHY0%PREHYD(JLON,KLEV)/(YDCPG_DYN0%RCP%R(JLON,KLEV)*YDVARS%T%T0(JLON,KLEV))
ZRHOFLUX(JLON,0)=ZRHO(JLON,1)
ENDDO
DO JLEV=1,KLEV-1
DO JLON=KIDIA,KFDIA
      ZRHOFLUX(JLON,JLEV)=(YDCPG_PHY0%PREHYDF(JLON,JLEV)*ZRHO(JLON,JLEV)+&
         &                 YDCPG_PHY0%PREHYDF(JLON,JLEV+1)*ZRHO(JLON,JLEV+1))&
         &                /(YDCPG_PHY0%PREHYDF(JLON,JLEV)+YDCPG_PHY0%PREHYDF(JLON,JLEV+1))
ENDDO
ENDDO
CALL WRSCMR(IUSCM,'RHO_flux',ZRHOFLUX,KLON,KLEV+1)
CALL LFAECRI(IUSCM,'KLEV',KLEV,1)
CALL LFAECRR(IUSCM,'TSPHY',TSPHY,1)
!CALL WRSCMR(IUSCM,'VAH',VAH,KLON,KLEV+1)
!CALL WRSCMR(IUSCM,'VBH',VBH,KLON,KLEV+1)
CALL LFAECRI(IUSCM,'NINDAT',NINDAT,1)
CALL LFAECRI(IUSCM,'NSSSSS',NSSSSS,1)
CALL LFAECRI(IUSCM,'KCLPH',YDAPLPAR_TMP%MOC%CLPH(2),1)
CALL LFAECRR(IUSCM,'RSTATI',RSTATI,1)


! * prognostic fields at time

CALL WRSCMR(IUSCM,'PU',YDVARS%U%T0,KLON,KLEV)
CALL WRSCMR(IUSCM,'PV',YDVARS%V%T0,KLON,KLEV)
ZVENT(:,:)=SQRT(YDVARS%U%T0(:,:)**2+YDVARS%V%T0(:,:)**2)
CALL WRSCMR(IUSCM,'PVENT',ZVENT,KLON,KLEV)
DO JLON=1,KLON
DO JLEV=1,KLEV
CALL RECPOL(YDVARS%U%T0(JLON,JLEV),YDVARS%V%T0(JLON,JLEV),ZVENT(JLON,JLEV),ZDIRVENT(JLON,JLEV))
ZDIRVENT(JLON,JLEV)=ZDIRVENT(JLON,JLEV)/RPI*180._JPRB
ZDIRVENT(JLON,JLEV)=270._JPRB-ZDIRVENT(JLON,JLEV)
IF (ZDIRVENT(JLON,JLEV) < 0.0_JPRB) THEN
   ZDIRVENT(JLON,JLEV)=360._JPRB+ZDIRVENT(JLON,JLEV)
ELSEIF (ZDIRVENT(JLON,JLEV) > 360.0_JPRB) THEN
   ZDIRVENT(JLON,JLEV)=ZDIRVENT(JLON,JLEV)-360._JPRB
ENDIF
ENDDO
ENDDO
CALL WRSCMR(IUSCM,'PDIRVENT',ZDIRVENT,KLON,KLEV)
CALL WRSCMR(IUSCM,'PT',YDVARS%T%T0,KLON,KLEV)
CALL WRSCMR(IUSCM,'PQ',YDVARS%Q%T0,KLON,KLEV)
ZH(:,:)=YDCPG_DYN0%RCP%CP(:,:)*YDVARS%T%T0(:,:)+YDCPG_DYN0%PHIF(:,:) 
CALL WRSCMR(IUSCM,'ZH',ZH,KLON,KLEV)

!-------------------------------------------------
! Compute theta, theta_v and theta_vl.
!-------------------------------------------------

DO JLON=KIDIA,KFDIA
DO JLEV=KTDIA,KLEV
   ZTHETA(JLON,JLEV)=THETA(YDCPG_PHY0%PREHYDF(JLON,JLEV),YDVARS%T%T0(JLON,JLEV))
   ZTHETAV(JLON,JLEV)=THETAV(YDCPG_PHY0%PREHYDF(JLON,JLEV),YDVARS%T%T0(JLON,JLEV),YDVARS%Q%T0(JLON,JLEV))
   ZQC(JLON,JLEV)=YDCPG_MISC%QLI(JLON,JLEV)+YDCPG_MISC%QICE(JLON,JLEV)
   ZTHETAL_KE(JLON,JLEV)=THETAL_KE(YDCPG_PHY0%PREHYDF(JLON,JLEV),YDVARS%T%T0(JLON,JLEV),YDVARS%Q%T0(JLON,JLEV),ZQC(JLON,JLEV))
   ZTHETAL(JLON,JLEV)=ZTHETA(JLON,JLEV)*(1.-(YDAPLPAR_TMP%MSC%LH(JLON,JLEV)*ZQC(JLON,JLEV))/(YDCPG_DYN0%RCP%CP(JLON,JLEV)*YDVARS%T%T0(JLON,JLEV)))
   ZTHETAL_LES(JLON,JLEV)=ZTHETA(JLON,JLEV)*(1.-(2.5E+06*ZQC(JLON,JLEV))/(1005.*YDVARS%T%T0(JLON,JLEV)))
   ZTHETAVL(JLON,JLEV)=THETAVL(YDCPG_PHY0%PREHYDF(JLON,JLEV),YDVARS%T%T0(JLON,JLEV),YDVARS%Q%T0(JLON,JLEV),ZQC(JLON,JLEV))
   ZELEVATION(JLON,JLEV)=(YDCPG_DYN0%PHIF(JLON,JLEV)-YDCPG_DYN0%PHI(JLON,KLEV))/RG
ENDDO
ENDDO
DO JLON=KIDIA,KFDIA
   ZTHETA(JLON,KLEV+1)=THETA(YDCPG_PHY0%PREHYD(JLON,KLEV),YDMF_PHYS_SURF%GSP_RR%PT_T9(JLON))
   ZTHETAV(JLON,KLEV+1)=THETAV(YDCPG_PHY0%PREHYD(JLON,KLEV),YDMF_PHYS_SURF%GSP_RR%PT_T9(JLON),YDCPG_MISC%QS(JLON))
   ZTHETAS(JLON)=ZTHETA(JLON,KLEV+1)
!   zthetavl(jlon,klev+1)=thetavl(paprs(jlon,klev),pts(jlon),pqs(jlon),zqc(jlon,klev))
   ZELEVATION(JLON,KLEV+1)=0.
ENDDO
CALL WRSCMR(IUSCM,'ZELEVA',ZELEVATION,KLON,KLEV)
CALL WRSCMR(IUSCM,'THETA',ZTHETA,KLON,KLEV)
CALL WRSCMR(IUSCM,'THETAV',ZTHETAV,KLON,KLEV)
CALL WRSCMR(IUSCM,'THETAL_KE',ZTHETAL_KE,KLON,KLEV)
CALL WRSCMR(IUSCM,'THETAL_BS',ZTHETAL_LES,KLON,KLEV)
CALL WRSCMR(IUSCM,'THETAL',ZTHETAL,KLON,KLEV)
CALL WRSCMR(IUSCM,'THETAVL',ZTHETAVL,KLON,KLEV)
ZRI(:,:)=0._JPRB
DO JLEV=KTDIA,KLEV-1
DO JLON=KIDIA,KFDIA
     ZDPHI=YDCPG_DYN0%PHIF(JLON,JLEV)-YDCPG_DYN0%PHIF(JLON,JLEV+1)
     ZZRTI=2.0_JPRB/(YDCPG_DYN0%RCP%R(JLON,JLEV)*YDVARS%T%T0(JLON,JLEV)+YDCPG_DYN0%RCP%R(JLON,JLEV+1)*YDVARS%T%T0(JLON,JLEV+1))
     ZCIS=MAX(1.E-14_JPRB,(YDVARS%U%T0(JLON,JLEV)-YDVARS%U%T0(JLON,JLEV+1))**2+(YDVARS%V%T0(JLON,JLEV)-YDVARS%V%T0(JLON,JLEV+1))**2)
     ZDTETA=YDCPG_DYN0%RCP%R(JLON,JLEV)*YDVARS%T%T0(JLON,JLEV)-YDCPG_DYN0%RCP%R(JLON,JLEV+1)*YDVARS%T%T0(JLON,JLEV+1)+RKAPPA*ZDPHI
     ZSTA=ZDPHI*ZDTETA*ZZRTI
     ZRI(JLON,JLEV)=ZSTA/ZCIS
ENDDO
ENDDO
CALL WRSCMR(IUSCM,'ZRI',ZRI,KLON,KLEV+1)

IF (LAROME) THEN
   CALL WRSCMR(IUSCM,'PECT',YDVARS%TKE%T0,KLON,KLEV)
ELSEIF (LECT) THEN
  IF (LECTFL) THEN
     CALL WRSCMR(IUSCM,'PECT',YDVARS%TKE%T0,KLON,KLEV)
  ELSE         
     ZECT(:,:)=0._JPRB
     DO JLON=1,KLON
     DO JLEV=1,KLEV
        ZECT(JLON,JLEV)=YDVARS%TKE%T0(JLON,JLEV)
     ENDDO
     ENDDO
     CALL WRSCMR(IUSCM,'PECT',ZECT,KLON,KLEV+1)
  ENDIF
ENDIF
IF (LEFB) THEN
   CALL WRSCMR(IUSCM,'PEFB1',YDVARS%EFB1%T0,KLON,KLEV)
   CALL WRSCMR(IUSCM,'PEFB2',YDVARS%EFB2%T0,KLON,KLEV)
   CALL WRSCMR(IUSCM,'PEFB3',YDVARS%EFB3%T0,KLON,KLEV)
ENDIF   
IF (LCONDWT.OR.LECMWF.OR.LAROME) THEN
  CALL WRSCMR(IUSCM,'PQI',YDVARS%I%T0,KLON,KLEV)
  CALL WRSCMR(IUSCM,'PQL',YDVARS%L%T0,KLON,KLEV)
  IF (LPROCLD.OR.LAROME) THEN
     CALL WRSCMR(IUSCM,'PQSN',YDVARS%S%T0,KLON,KLEV)
     CALL WRSCMR(IUSCM,'PQR',YDVARS%R%T0,KLON,KLEV)
     IF (LAROME) THEN
        CALL WRSCMR(IUSCM,'PQG',YDVARS%G%T0,KLON,KLEV)
     ENDIF
  ENDIF
ENDIF
! * dimensions used in physics

CALL LFAECRI(IUSCM,'KGL1',KGL1,1)
CALL LFAECRI(IUSCM,'KGL2',KGL2,1)
CALL LFAECRI(IUSCM,'KSGST',KSGST,1)
CALL LFAECRI(IUSCM,'KSTEP',KSTEP,1)
CALL LFAECRI(IUSCM,'KCSS',KCSS,1)
CALL ECR1D(IUSCM,'PMU0',PRDG_MU0,1,KLON)
CALL ECR1D(IUSCM,'PGEMU',PGEMU,1,KLON)
CALL ECR1D(IUSCM,'PGELAM',PGELAM,1,KLON)
! * input parameters for physics

CALL WRSCMR(IUSCM,'PAPHI',YDCPG_DYN0%PHI,KLON,KLEV+1)
CALL WRSCMR(IUSCM,'PAPRS',YDCPG_PHY0%PREHYD,KLON,KLEV+1)
CALL WRSCMR(IUSCM,'PAPHIF',YDCPG_DYN0%PHIF,KLON,KLEV)
CALL WRSCMR(IUSCM,'PAPRSF',YDCPG_PHY0%PREHYDF,KLON,KLEV)
CALL WRSCMR(IUSCM,'PALPH',YDCPG_PHY0%XYB%ALPH,KLON,KLEV)
IF (LSOLV.OR.LECMWF) THEN
  CALL ECR1D(IUSCM,'PD2',YDMF_PHYS_SURF%GSD_VV%PD2,1,KLON)
ENDIF
CALL WRSCMR(IUSCM,'PDELP',YDCPG_PHY0%XYB%DELP,KLON,KLEV)
IF (.NOT.LAROME) CALL ECR1D(IUSCM,'PGZ0H',YDMF_PHYS%OUT%GZ0H,1,KLON)
IF (.NOT.LAROME) CALL ECR1D(IUSCM,'PGZ0',YDMF_PHYS%OUT%GZ0,1,KLON)
IF (LSOLV) THEN
  CALL ECR1D(IUSCM,'PHV',YDMF_PHYS_SURF%GSD_VV%PHV,1,KLON)
  CALL ECR1D(IUSCM,'PARG',YDMF_PHYS_SURF%GSD_VV%PARG,1,KLON)
  CALL ECR1D(IUSCM,'PIVEG',YDMF_PHYS_SURF%GSD_VV%PIVEG,1,KLON)
  CALL ECR1D(IUSCM,'PLAI',YDMF_PHYS_SURF%GSD_VV%PLAI,1,KLON)
  CALL ECR1D(IUSCM,'PRSMIN',YDMF_PHYS_SURF%GSD_VV%PRSMIN,1,KLON)
  CALL ECR1D(IUSCM,'PGZ0F',YDMF_PHYS_SURF%GSD_VF%PZ0F,1,KLON)
  CALL ECR1D(IUSCM,'PGZ0HF',YDMF_PHYS_SURF%GSD_VV%PZ0H,1,KLON)
  CALL ECR1D(IUSCM,'PSAB',YDMF_PHYS_SURF%GSD_VV%PSAB,1,KLON)
  CALL ECR1D(IUSCM,'PALBF',YDMF_PHYS_SURF%GSD_VF%PALBF,1,KLON)
  IF (LVGSN) THEN
     CALL ECR1D(IUSCM,'PALV',YDMF_PHYS_SURF%GSD_VV%PALV,1,KLON)
     CALL ECR1D(IUSCM,'PALBH',YDMF_PHYS_SURF%GSP_SG%PT_T1,1,KLON)
  ENDIF
ENDIF
IF(LSNV.AND..NOT.LECMWF )THEN
  CALL ECR1D(IUSCM,'PALBSF',YDMF_PHYS_SURF%GSD_VF%PALBSF,1,KLON)
  CALL ECR1D(IUSCM,'PALBH',YDMF_PHYS_SURF%GSP_SG%PT_T1,1,KLON)
ENDIF
CALL WRSCMR(IUSCM,'PLNPR',YDCPG_PHY0%XYB%LNPR,KLON,KLEV)
CALL WRSCMR(IUSCM,'PRDELP',YDCPG_PHY0%XYB%RDELP,KLON,KLEV)
CALL WRSCMR(IUSCM,'PCP',YDCPG_DYN0%RCP%CP,KLON,KLEV)
IF (.NOT.LAROME) CALL WRSCMR(IUSCM,'PCVGQ',PRDG_CVGQ,KLON,KLEV)
CALL WRSCMR(IUSCM,'PR',YDCPG_DYN0%RCP%R,KLON,KLEV)
!-------------------------------------------------
! Vertical velocity in pressure coordinate: omega/P (Pa/s).
!-------------------------------------------------

CALL WRSCMR(IUSCM,'PVERVEL',YDCPG_DYN0%CTY%VVEL(:, 1:),KLON,KLEV)
!-------------------------------------------------
! Vertical velocity w (m/s).
!-------------------------------------------------

DO JLEV=1,KLEV
DO JLON=1,KLON
   ZW(JLON,JLEV)=-YDCPG_DYN0%RCP%R(JLON,JLEV)*YDVARS%T%T0(JLON,JLEV)/RG*YDCPG_DYN0%CTY%VVEL(JLON,JLEV)
ENDDO
ENDDO
CALL WRSCMR(IUSCM,'ZW',ZW,KLON,KLEV)
DO JLEV=1,KLEV
DO JLON=1,KLON
   ZW(JLON,JLEV)=YDCPG_PHY0%PREHYDF(JLON,JLEV)*YDCPG_DYN0%CTY%VVEL(JLON,JLEV)
ENDDO
ENDDO
CALL WRSCMR(IUSCM,'ZOMEGA',ZW,KLON,KLEV)
!-------------------------------------------------
! ECMWF radiation.
!-------------------------------------------------

IF( LECMWF.OR.LRAYFM ) THEN
  CALL WRSCMR(IUSCM,'PEMTD',YDMF_PHYS%RAD%EMTD,KLON,KLEV+1)
  CALL WRSCMR(IUSCM,'PEMTU',YDMF_PHYS%RAD%EMTU,KLON,KLEV+1)
  CALL WRSCMR(IUSCM,'PTRSO',YDMF_PHYS%RAD%TRSW,KLON,KLEV+1)
ENDIF
CALL ECR1D(IUSCM,'PCLON',PCLON,1,KLON)
CALL ECR1D(IUSCM,'PSLON',PSLON,1,KLON)
CALL WRSCMR(IUSCM,'PFRSO',YDMF_PHYS%OUT%FRSO,KLON,KLEV+1)
CALL WRSCMR(IUSCM,'PFRTH',YDMF_PHYS%OUT%FRTH,KLON,KLEV+1)
DO JLEV=1,KLEV
    DO JLON=1,KLON
      ZDTRAD(JLON,JLEV)= RG*YDCPG_PHY0%XYB%RDELP(JLON,JLEV)/YDCPG_DYN0%RCP%CP(JLON,JLEV)*&
                         & (YDMF_PHYS%OUT%FRSO(JLON,JLEV-1,1)+YDMF_PHYS%OUT%FRTH(JLON,JLEV-1,1)-&
                         & YDMF_PHYS%OUT%FRSO(JLON,JLEV,1)+YDMF_PHYS%OUT%FRTH(JLON,JLEV,1))
    ENDDO
ENDDO
CALL WRSCMR(IUSCM,'ZDTRAD',ZDTRAD,KLON,KLEV)
CALL ECR1D(IUSCM,'PTCLS',YDMF_PHYS%OUT%TCLS,1,KLON)
CALL ECR1D(IUSCM,'PUCLS',YDMF_PHYS%OUT%UCLS,1,KLON)
CALL ECR1D(IUSCM,'PVCLS',YDMF_PHYS%OUT%VCLS,1,KLON)
CALL ECR1D(IUSCM,'PQCLS',YDMF_PHYS%OUT%QCLS,1,KLON)
CALL ECR1D(IUSCM,'PCLCT',YDCPG_MISC%CLCT,1,KLON)
CALL ECR1D(IUSCM,'PCLCH',YDMF_PHYS%OUT%CLCH,1,KLON)
CALL ECR1D(IUSCM,'PCLCM',YDMF_PHYS%OUT%CLCM,1,KLON)
CALL ECR1D(IUSCM,'PCLCL',YDMF_PHYS%OUT%CLCL,1,KLON)
CALL ECR1D(IUSCM,'PCLCC',YDMF_PHYS%OUT%CLCC,1,KLON)
!ZVENTCLS(:)=SQRT(PUCLS(:)**2+PVCLS(:)**2)
DO JLON=1,KLON
CALL RECPOL(YDMF_PHYS%OUT%UCLS(JLON),YDMF_PHYS%OUT%VCLS(JLON),ZVENTCLS(JLON),ZDIRCLS(JLON))
ENDDO
ZDIRCLS(:)=ZDIRCLS(:)/RPI*180._JPRB
ZDIRCLS(:)=270._JPRB-ZDIRCLS(:)
DO JLON=1,KLON
IF (ZDIRCLS(JLON) < 0._JPRB) THEN
   ZDIRCLS(JLON)=360._JPRB+ZDIRCLS(JLON)
ELSEIF (ZDIRCLS(JLON) > 360.0_JPRB) THEN
   ZDIRCLS(JLON)=ZDIRCLS(JLON)-360._JPRB
ENDIF
ENDDO
CALL ECR1D(IUSCM,'VENTCLS',ZVENTCLS,1,KLON)
CALL ECR1D(IUSCM,'DIRCLS',ZDIRCLS,1,KLON)
CALL ECR1D(IUSCM,'PFCLL',YDMF_PHYS%OUT%FCLL,1,KLON)
CALL ECR1D(IUSCM,'PFCLN',YDMF_PHYS%OUT%FCLN,1,KLON)
CALL ECR1D(IUSCM,'PFCS',YDMF_PHYS%OUT%FCS,1,KLON)
CALL WRSCMR(IUSCM,'PNEB',YDCPG_MISC%NEB,KLON,KLEV)
CALL ECR1D(IUSCM,'PCLPH',YDMF_PHYS%OUT%CLPH,1,KLON)
IF (.NOT.LAROME) THEN 
   CALL WRSCMR(IUSCM,'PQSAT',YDAPLPAR_TMP%FLU%QSAT,KLON,KLEV)
ENDIF
CALL ECR1D(IUSCM,'PRHCLS',YDMF_PHYS%OUT%RHCLS,1,KLON)

!-------------------------------------------------
! Perform some vertical integrals.
!-------------------------------------------------

DO JLON=KIDIA,KFDIA
   ZECT_INT(JLON)=0._JPRB
   DO JLEV=KTDIA,KLEV
        ZECT_INT(JLON)=ZECT_INT(JLON)+YDVARS%TKE%T0(JLON,JLEV)* YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
   ENDDO
ENDDO
CALL ECR1D(IUSCM,'ECT_INT',ZECT_INT,1,KLON)
IF (LAROME) THEN
DO JLON=KIDIA,KFDIA
   ZLWP(JLON)=0._JPRB
   ZIWP(JLON)=0._JPRB
   ZWVP(JLON)=0._JPRB
   DO JLEV=KTDIA,KLEV
        ZLWP(JLON)=ZLWP(JLON)+YDVARS%L%T0(JLON,JLEV)* YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
        ZIWP(JLON)=ZIWP(JLON)+YDVARS%I%T0(JLON,JLEV)*YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
        ZWVP(JLON)=ZWVP(JLON)+YDVARS%Q%T0(JLON,JLEV)*YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
    ENDDO
    ZCWP(JLON)=ZLWP(JLON)+ZIWP(JLON)
ENDDO
ELSE
DO JLON=KIDIA,KFDIA
   ZLWP(JLON)=0._JPRB
   ZIWP(JLON)=0._JPRB
   ZWVP(JLON)=0._JPRB
   DO JLEV=KTDIA,KLEV
        ZLWP(JLON)=ZLWP(JLON)+YDCPG_MISC%QLI(JLON,JLEV)* YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
        ZIWP(JLON)=ZIWP(JLON)+YDCPG_MISC%QICE(JLON,JLEV)*YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
        ZWVP(JLON)=ZWVP(JLON)+YDVARS%Q%T0(JLON,JLEV)*YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
    ENDDO
    ZCWP(JLON)=ZLWP(JLON)+ZIWP(JLON)
ENDDO
ENDIF
CALL ECR1D(IUSCM,'LWP',ZLWP,1,KLON) ! liquid water path. Kg/m2
CALL ECR1D(IUSCM,'IWP',ZIWP,1,KLON) ! ice water path.
CALL ECR1D(IUSCM,'CWP',ZCWP,1,KLON) ! (liquid+ice) = condensated water path.
CALL ECR1D(IUSCM,'WVP',ZWVP,1,KLON) ! water vapour path.
CALL WRSCMR(IUSCM,'PFPLSL',YDMF_PHYS%OUT%FPLSL,KLON,KLEV+1)
CALL WRSCMR(IUSCM,'PFPLSN',YDMF_PHYS%OUT%FPLSN,KLON,KLEV+1)
IF (LAROME) THEN
   CALL WRSCMR(IUSCM,'PFPLSG',YDMF_PHYS%OUT%FPLSG,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFPLSHL',YDMF_PHYS%OUT%FPLSH,KLON,KLEV+1)
   ZRRTOTAL(:,:)=YDMF_PHYS%OUT%FPLSN(:,:)+YDMF_PHYS%OUT%FPLSG(:,:)+YDMF_PHYS%OUT%FPLSH(:,:)
   CALL WRSCMR(IUSCM,'PREC_SOL',ZRRTOTAL,KLON,KLEV+1)
   ZRRTOTAL(:,:)=YDMF_PHYS%OUT%FPLSL(:,:)
   CALL WRSCMR(IUSCM,'PREC_LIQ',ZRRTOTAL,KLON,KLEV+1)
   ZRRTOTAL(:,:)=YDMF_PHYS%OUT%FPLSL(:,:)+YDMF_PHYS%OUT%FPLSN(:,:)+YDMF_PHYS%OUT%FPLSG(:,:)+YDMF_PHYS%OUT%FPLSH(:,:)
   CALL WRSCMR(IUSCM,'PREC_TOT',ZRRTOTAL,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PQICE',YDVARS%I%T0,KLON,KLEV)
   CALL WRSCMR(IUSCM,'PQLI',YDVARS%L%T0,KLON,KLEV)
ELSE
   CALL WRSCMR(IUSCM,'PFPLCL',YDMF_PHYS%OUT%FPLCL,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFPLCN',YDMF_PHYS%OUT%FPLCN,KLON,KLEV+1)
   ZRRTOTAL(:,:)=YDMF_PHYS%OUT%FPLSN(:,:)+YDMF_PHYS%OUT%FPLCN(:,:)
   CALL WRSCMR(IUSCM,'PREC_SOL',ZRRTOTAL,KLON,KLEV+1)
   ZRRTOTAL(:,:)=YDMF_PHYS%OUT%FPLSL(:,:)+YDMF_PHYS%OUT%FPLCL(:,:)
   CALL WRSCMR(IUSCM,'PREC_LIQ',ZRRTOTAL,KLON,KLEV+1)
   ZRRTOTAL(:,:)=YDMF_PHYS%OUT%FPLSL(:,:)+YDMF_PHYS%OUT%FPLSN(:,:)+YDMF_PHYS%OUT%FPLCL(:,:)+YDMF_PHYS%OUT%FPLCN(:,:)
   CALL WRSCMR(IUSCM,'PREC_TOT',ZRRTOTAL,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PQICE',YDCPG_MISC%QICE,KLON,KLEV)
   CALL WRSCMR(IUSCM,'PQLI',YDCPG_MISC%QLI,KLON,KLEV)
ENDIF

!  Paramters for EDMF intercomparison

ZTHETABOT(:)=ZTHETA(:,KLEV)
ZRBOT(:)=YDVARS%Q%T0(:,KLEV)/(1._JPRB-YDVARS%Q%T0(:,KLEV))
ZLCL(:)=(20._JPRB + (YDVARS%T%T0(:,KLEV)-273.15_JPRB)/5._JPRB)*(100._JPRB - YDCPG_MISC%RH(:,KLEV))  

CALL ECR1D(IUSCM,'THETABOT',ZTHETABOT,1,KLON)
CALL ECR1D(IUSCM,'RBOT',ZRBOT,1,KLON)
CALL ECR1D(IUSCM,'LCL',ZLCL,1,KLON)

! END Paramters for EDMF intercomparison

CALL WRSCMR(IUSCM,'PRH',YDCPG_MISC%RH,KLON,KLEV) ! relative humidity.
CALL ECR1D(IUSCM,'PTS',YDMF_PHYS_SURF%GSP_RR%PT_T9,1,KLON)
CALL ECR1D(IUSCM,'PQS',YDCPG_MISC%QS,1,KLON)
CALL ECR1D(IUSCM,'PFRSODS',YDMF_PHYS%OUT%FRSODS,1,KLON)
CALL ECR1D(IUSCM,'PFRTHDS',YDMF_PHYS%OUT%FRTHDS,1,KLON)
CALL ECR1D(IUSCM,'PITM',YDMF_PHYS_SURF%GSD_VF%PLSM,1,KLON)
CALL WRSCMR(IUSCM,'PSTRTU',YDMF_PHYS%OUT%STRTU,KLON,KLEV+1)
CALL WRSCMR(IUSCM,'PSTRTV',YDMF_PHYS%OUT%STRTV,KLON,KLEV+1)
CALL WRSCMR(IUSCM,'PFRSOC',YDMF_PHYS%OUT%FRSOC,KLON,2)
CALL WRSCMR(IUSCM,'PFRTHC',YDMF_PHYS%OUT%FRTHC,KLON,2)
IF (.NOT.LAROME) THEN
   CALL ECR1D(IUSCM,'PALB',YDMF_PHYS%OUT%ALB,1,KLON)
   CALL WRSCMR(IUSCM,'PLH',YDAPLPAR_TMP%MSC%LH,KLON,KLEV)
   CALL WRSCMR(IUSCM,'PDIFCQ',YDMF_PHYS%OUT%DIFCQ,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PDIFCQI',YDMF_PHYS%OUT%DIFCQN,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PDIFCQL',YDMF_PHYS%OUT%DIFCQL,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PDIFCS',YDMF_PHYS%OUT%DIFCS,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PDIFTQ',YDMF_PHYS%OUT%DIFTQ,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PDIFTQI',YDMF_PHYS%OUT%DIFTQN,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PDIFTQL',YDMF_PHYS%OUT%DIFTQL,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PDIFTS',YDMF_PHYS%OUT%DIFTS,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFCCQL',YDMF_PHYS%OUT%FCCQL,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFCCQN',YDMF_PHYS%OUT%FCCQN,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFCSQL',YDMF_PHYS%OUT%FCSQL,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFCSQN',YDMF_PHYS%OUT%FCSQN,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFCQVNG',YDMF_PHYS%OUT%FCQNG,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFCQING',YDMF_PHYS%OUT%FCQNNG,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFCQLNG',YDMF_PHYS%OUT%FCQLNG,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFCQRNG',YDMF_PHYS%OUT%FCQRNG,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFCQSNG',YDMF_PHYS%OUT%FCQSNG,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFPFPSL',YDMF_PHYS%OUT%FPFPSL,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFPFPSL',YDMF_PHYS%OUT%FPFPSN,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFPFPSL',YDMF_PHYS%OUT%FPFPCL,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFPFPSL',YDMF_PHYS%OUT%FPFPCN,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFPEVPSL',YDMF_PHYS%OUT%FPEVPSL,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFPEVPSN',YDMF_PHYS%OUT%FPEVPSN,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFPEVPCL',YDMF_PHYS%OUT%FPEVPCL,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFPEVPCN',YDMF_PHYS%OUT%FPEVPCN,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFTKE',YDAPLPAR_TMP%PFL%FTKE,KLON,KLEV+1)
   IF (LEFB) THEN
      CALL WRSCMR(IUSCM,'PFEFB1',YDAPLPAR_TMP%PFL%FEFB1,KLON,KLEV+1)
      CALL WRSCMR(IUSCM,'PFEFB2',YDAPLPAR_TMP%PFL%FEFB2,KLON,KLEV+1)
      CALL WRSCMR(IUSCM,'PFEFB3',YDAPLPAR_TMP%PFL%FEFB3,KLON,KLEV+1)
   ENDIF   
   CALL WRSCMR(IUSCM,'PSTRCU',YDMF_PHYS%OUT%STRCU,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PSTRCV',YDMF_PHYS%OUT%STRCV,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PSTRDU',YDMF_PHYS%OUT%STRDU,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PSTRDV',YDMF_PHYS%OUT%STRDV,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PSTRMU',YDMF_PHYS%OUT%STRMU,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PSTRMV',YDMF_PHYS%OUT%STRMV,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFRMH',YDMF_PHYS%OUT%FRMH,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFRMQ',YDAPLPAR_TMP%MSC%FRMQ,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'PFCHOZ',YDMF_PHYS%OUT%FCHOZ,KLON,KLEV+1)
ENDIF
IF (.NOT.LMSE) THEN
CALL ECR1D(IUSCM,'PLHS',YDAPLPAR_TMP%DSA%LHS,1,KLON)
ENDIF
CALL ECR1D(IUSCM,'PEMIS',YDAPLPAR_TMP%FLU%EMIS,1,KLON)
CALL ECR1D(IUSCM,'PFEVL',YDMF_PHYS%OUT%FEVL,1,KLON)
CALL ECR1D(IUSCM,'PFEVI',YDAPLPAR_TMP%FLU%FEVI,1,KLON)
CALL ECR1D(IUSCM,'PFEVN',YDMF_PHYS%OUT%FEVN,1,KLON)
IF ((.NOT.LMSE).AND.(LSOLV)) THEN  
  CALL ECR1D(IUSCM,'PCD',YDAPLPAR_TMP%FLU%CD,1,KLON)
  CALL ECR1D(IUSCM,'PCDN',YDAPLPAR_TMP%FLU%CDN,1,KLON)
  CALL ECR1D(IUSCM,'PCH',YDAPLPAR_TMP%FLU%CH,1,KLON)
  CALL ECR1D(IUSCM,'PSNS',YDMF_PHYS_SURF%GSP_SG%PF_T9,1,KLON)
  CALL ECR1D(IUSCM,'PCPS',YDAPLPAR_TMP%DSA%CPS,1,KLON)
  CALL ECR1D(IUSCM,'PRS',YDAPLPAR_TMP%DSA%RS,1,KLON)
  CALL WRSCMR(IUSCM,'PLSCPE',YDAPLPAR_TMP%MSC%LSCPE,KLON,KLEV)
  CALL WRSCMR(IUSCM,'PQW',YDAPLPAR_TMP%MSC%QW,KLON,KLEV)
  CALL WRSCMR(IUSCM,'PTW',YDAPLPAR_TMP%MSC%TW,KLON,KLEV)
  CALL ECR1D(IUSCM,'PFCHSP',YDMF_PHYS%OUT%FCHSP,1,KLON)
!CALL ECR1D(IUSCM,'PEMISF',PEMISF,1,KLON)
!CALL ECR1D(IUSCM,'PGETRL',PGETRL,1,KLON)
  CALL ECR1D(IUSCM,'PVEG0',YDMF_PHYS_SURF%GSD_VF%PVEG,1,KLON)
!CALL ECR1D(IUSCM,'PVRLAN',PVRLAN,1,KLON)
!CALL ECR1D(IUSCM,'PVRLDI',PVRLDI,1,KLON)
!CALL ECR1D(IUSCM,'POROG',POROG,1,KLON)
!CALL ECR1D(IUSCM,'PGM',PGM,1,KLON)
  CALL ECR1D(IUSCM,'PC1',YDAPLPAR_TMP%DSA%C1,1,KLON)
  CALL ECR1D(IUSCM,'PC2',YDAPLPAR_TMP%DSA%C2,1,KLON)
  CALL ECR1D(IUSCM,'PCT',YDMF_PHYS%OUT%CT,1,KLON)
  CALL ECR1D(IUSCM,'PFEVV',YDMF_PHYS%OUT%FEVV,1,KLON)
  CALL ECR1D(IUSCM,'PFTR',YDMF_PHYS%OUT%FTR,1,KLON)
  CALL ECR1D(IUSCM,'PFGEL',YDMF_PHYS%OUT%FGEL,1,KLON)
  CALL ECR1D(IUSCM,'PFGELS',YDMF_PHYS%OUT%FGELS,1,KLON)
  CALL ECR1D(IUSCM,'PFRSOPT',YDMF_PHYS%OUT%FRSOPT,1,KLON)
  CALL ECR1D(IUSCM,'PFRSOLU',YDMF_PHYS%OUT%FRSOLU,1,KLON)
  CALL ECR1D(IUSCM,'PNEIJ',YDAPLPAR_TMP%FLU%NEIJ,1,KLON)
  CALL ECR1D(IUSCM,'PVEG',YDAPLPAR_TMP%FLU%VEG,1,KLON)
  CALL ECR1D(IUSCM,'PQSATS',YDAPLPAR_TMP%FLU%QSATS,1,KLON)
  CALL ECR1D(IUSCM,'PRUISL',YDMF_PHYS%OUT%RUISL,1,KLON)
  CALL ECR1D(IUSCM,'PFLWSP',YDMF_PHYS%OUT%FLWSP,1,KLON)
  CALL ECR1D(IUSCM,'PFONTE',YDMF_PHYS%OUT%FONTE,1,KLON)
  CALL ECR1D(IUSCM,'PFRSOPS',YDMF_PHYS%OUT%FRSOPS,1,KLON)
  CALL ECR1D(IUSCM,'PRUISP',YDMF_PHYS%OUT%RUISP,1,KLON)
  CALL ECR1D(IUSCM,'PRUISS',YDMF_PHYS%OUT%RUISS,1,KLON)
!CALL ECR1D(IUSCM,'PDCLS',PDCLS,1,KLON)
  CALL ECR1D(IUSCM,'PCAPE',YDMF_PHYS%OUT%CAPE,1,KLON)
  CALL ECR1D(IUSCM,'PCTOP',YDMF_PHYS%OUT%CTOP,1,KLON)
  CALL ECR1D(IUSCM,'PUGST',YDMF_PHYS%OUT%UGST,1,KLON)
  CALL ECR1D(IUSCM,'PVGST',YDMF_PHYS%OUT%VGST,1,KLON)
! * surface variables time T (ARPEGE style)
  CALL WRSCMR(IUSCM,'PTP',YDMF_PHYS_SURF%GSP_SB%PT_T9,KLON,KCSS)
  CALL ECR1D(IUSCM,'PWL',YDMF_PHYS_SURF%GSP_RR%PFC_T9,1,KLON)
  CALL ECR1D(IUSCM,'PWP',YDMF_PHYS_SURF%GSP_SB%PQ_T9,1,KLON)
  CALL ECR1D(IUSCM,'PWPI',YDMF_PHYS_SURF%GSP_SB%PTL_T9,1,KLON)
  CALL ECR1D(IUSCM,'PWSI',YDMF_PHYS_SURF%GSP_RR%PIC_T9,1,KLON)
  CALL ECR1D(IUSCM,'PWS',YDMF_PHYS_SURF%GSP_RR%PW_T9,1,KLON)
ENDIF
CALL LFAECRR(IUSCM,'VETAH',YDVETA%VETAH,KLEV+1)
CALL LFAECRR(IUSCM,'VETAF',YDVETA%VETAF,KLEV+2)
IF (LSNV.OR.LVGSN) THEN
  CALL ECR1D(IUSCM,'PALBNS',YDMF_PHYS_SURF%GSP_SG%PA_T0,1,KLON)
  CALL ECR1D(IUSCM,'PRHONS',YDMF_PHYS_SURF%GSP_SG%PR_T0,1,KLON)
ENDIF
IF (.NOT.LAROME) THEN
   DO JLON=KIDIA,KFDIA
   ZHEATS(JLON)= -(1./(ZRHO(JLON,KLEV)*YDCPG_DYN0%RCP%CP(JLON,KLEV))*YDMF_PHYS%OUT%FCS(JLON,1)+RETV*&
   &(YDMF_PHYS%OUT%FCLL(JLON,1)+YDMF_PHYS%OUT%FCLN(JLON,1))*YDMF_PHYS%OUT%TCLS(JLON)&
   &/(ZRHO(JLON,KLEV)*YDAPLPAR_TMP%MSC%LH(JLON,KLEV)))
   ENDDO
   CALL ECR1D(IUSCM,'ZHEATS',ZHEATS,1,KLON)
ENDIF

!-------------------------------------------------
! Surface values, to give as entry to the PBL depth computation.
!-------------------------------------------------

ILEV=KLEV+1
CALL ECR1D(IUSCM,'THETAS',ZTHETAS,1,KLON)
ZHCLA=HCLA(ILEV,ZTHETAVL,ZELEVATION,'DINT')
CALL LFAECRR(IUSCM,'HCLA',ZHCLA,1)

ZHCLA=HCLA(ILEV,ZTHETAVL,ZELEVATION,'AY1996')
CALL LFAECRR(IUSCM,'HCLA_AY1996',ZHCLA,1)

!   Diagnostic pour GABLS : - ZBLHG : boundary layer height
!                           - Surf. Potantial temperature flux  
!                           - Monin-Obukhov length

ZCPFLUX(:,KLEV)=YDAPLPAR_TMP%DSA%CPS(:)
ZCPFLUX(:,0)=YDCPG_DYN0%RCP%CP(:,1)
DO JLON=KIDIA,KFDIA
DO JLEV=KLEV-1,1,-1
      ZCPFLUX(JLON,JLEV)=(YDCPG_PHY0%PREHYDF(JLON,JLEV)*YDCPG_DYN0%RCP%CP(JLON,JLEV)+&
         &                 YDCPG_PHY0%PREHYDF(JLON,JLEV+1)*YDCPG_DYN0%RCP%CP(JLON,JLEV+1))&
         &                /(YDCPG_PHY0%PREHYDF(JLON,JLEV)+YDCPG_PHY0%PREHYDF(JLON,JLEV+1))
ENDDO
ENDDO
CALL WRSCMR(IUSCM,'ZCP_flux',ZCPFLUX,KLON,KLEV+1)
! Calcul de ZLH sur les niveaux flux
DO JLON=KIDIA,KFDIA
   ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-YDVARS%T%T0(JLON,1)))
   ZLH(JLON,0)=FOLH (YDVARS%T%T0(JLON,1),ZDELTA)
   DO JLEV=2,KLEV
      ZT=(YDVARS%T%T0(JLON,JLEV-1)+YDVARS%T%T0(JLON,JLEV))*0.5_JPRB
      ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-ZT))
      ZLH(JLON,JLEV-1)=FOLH (ZT,ZDELTA)
   ENDDO
   ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-YDMF_PHYS_SURF%GSP_RR%PT_T9(JLON)))
   ZLH(JLON,KLEV)=FOLH (YDMF_PHYS_SURF%GSP_RR%PT_T9(JLON),ZDELTA)
ENDDO
CALL WRSCMR(IUSCM,'ZLH_flux',ZLH,KLON,KLEV+1)
!
!   Calcul de Upwp, Vpwp et ZUSTAR
DO JLON=KIDIA,KFDIA
   ZUPWP(JLON,0)=0._JPRB
   ZVPWP(JLON,0)=0._JPRB
   DO JLEV=1,KLEV
      ZUPWP(JLON,JLEV)=-YDMF_PHYS%OUT%STRTU(JLON,JLEV)/ZRHOFLUX(JLON,JLEV)
      ZVPWP(JLON,JLEV)=-YDMF_PHYS%OUT%STRTV(JLON,JLEV)/ZRHOFLUX(JLON,JLEV)
   ENDDO
   ZUSTAR(JLON)=(ZUPWP(JLON,KLEV)**2+ZVPWP(JLON,KLEV)**2)**0.25
ENDDO
CALL WRSCMR(IUSCM,'ZUPWP_tur',ZUPWP,KLON,KLEV+1)
CALL WRSCMR(IUSCM,'ZVPWP_tur',ZVPWP,KLON,KLEV+1)
CALL ECR1D(IUSCM,'ZUSTAR',ZUSTAR,1,KLON)

IF (.NOT.LAROME) THEN
   DO JLON=KIDIA,KFDIA
      ZUPWP(JLON,0)=0._JPRB
      ZVPWP(JLON,0)=0._JPRB
      DO JLEV=1,KLEV
         ZUPWP(JLON,JLEV)=-YDMF_PHYS%OUT%STRCU(JLON,JLEV)/ZRHOFLUX(JLON,JLEV)
         ZVPWP(JLON,JLEV)=-YDMF_PHYS%OUT%STRCV(JLON,JLEV)/ZRHOFLUX(JLON,JLEV)
      ENDDO
   ENDDO
   CALL WRSCMR(IUSCM,'ZUPWP_dee',ZUPWP,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'ZVPWP_dee',ZVPWP,KLON,KLEV+1)
   DO JLON=KIDIA,KFDIA
   IF (ZHEATS(JLON) /= 0._JPRB) THEN
      ZLMO(JLON)=-ZUSTAR(JLON)**3*YDMF_PHYS%OUT%TCLS(JLON)/(VKARMN*RG*ZHEATS(JLON))
   ENDIF
   ENDDO
   CALL ECR1D(IUSCM,'ZLMO',ZLMO,1,KLON)

   !! Part Turbulente 
   DO JLON=KIDIA,KFDIA
   ZWPQP(JLON,0)=0._JPRB
   ZWPQLP(JLON,0)=0._JPRB
   ZWPQIP(JLON,0)=0._JPRB
   ZHEAT(JLON,0)=0._JPRB
   ZWT(JLON,0)=0._JPRB
   ZWTHETAL(JLON,0)=0._JPRB
      DO JLEV=1,KLEV
      ZWPQP(JLON,JLEV)=-YDMF_PHYS%OUT%DIFTQ(JLON,JLEV)/ZRHOFLUX(JLON,JLEV)
      ZWT(JLON,JLEV)=-YDMF_PHYS%OUT%DIFTS(JLON,JLEV)/ZRHOFLUX(JLON,JLEV)&
        & /ZCPFLUX(JLON,JLEV)
      ZHEAT(JLON,JLEV)=-YDMF_PHYS%OUT%DIFTS(JLON,JLEV)/ZRHOFLUX(JLON,JLEV)&
        & *(RATM/YDCPG_PHY0%PREHYD(JLON,JLEV))**(RKAPPA)/RCPD
      ZWTHETAL(JLON,JLEV)=ZHEAT(JLON,JLEV) -(ZLH(JLON,JLEV)/RCPD)*&
      & (RATM/YDCPG_PHY0%PREHYD(JLON,JLEV))**(RKAPPA)*(-YDMF_PHYS%OUT%DIFTQL(JLON,JLEV)&
        &  -YDMF_PHYS%OUT%DIFTQN(JLON,JLEV))/ZRHOFLUX(JLON,JLEV)
      ZWPQLP(JLON,JLEV)=-YDMF_PHYS%OUT%DIFTQL(JLON,JLEV)/ZRHOFLUX(JLON,JLEV)
      ZWPQIP(JLON,JLEV)=-YDMF_PHYS%OUT%DIFTQN(JLON,JLEV)/ZRHOFLUX(JLON,JLEV)
      ENDDO
      ZWPQPS(JLON)=-(YDMF_PHYS%OUT%FEVL(JLON,1)+YDMF_PHYS%OUT%FEVN(JLON,1))/ZRHOFLUX(JLON,KLEV)
   ENDDO
   ZLWPQTP(:,:)=ZWPQLP(:,:)+ZWPQIP(:,:)+ZWPQP(:,:)
   CALL WRSCMR(IUSCM,'ZWPQT_tur',ZLWPQTP,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'WTHL_tur',ZWTHETAL,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'ZWPQP_tur',ZWPQP,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'ZHEAT_tur',ZHEAT,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'ZWT_tur',ZWT,KLON,KLEV+1)
   CALL ECR1D(IUSCM,'ZWPQPS',ZWPQPS,1,KLON)
   !! Part Deep Convection
   DO JLON=KIDIA,KFDIA
   ZWPQP(JLON,0)=0._JPRB
   ZWPQLP(JLON,0)=0._JPRB
   ZWPQIP(JLON,0)=0._JPRB
   ZHEAT(JLON,0)=0._JPRB
   ZWT(JLON,0)=0._JPRB
   ZWTHETAL(JLON,0)=0._JPRB
      DO JLEV=1,KLEV
      ZWPQP(JLON,JLEV)=-YDMF_PHYS%OUT%DIFCQ(JLON,JLEV)/ZRHOFLUX(JLON,JLEV)
      ZWT(JLON,JLEV)=-YDMF_PHYS%OUT%DIFCS(JLON,JLEV)/ZRHOFLUX(JLON,JLEV)&
        & /ZCPFLUX(JLON,JLEV)
      ZHEAT(JLON,JLEV)=-YDMF_PHYS%OUT%DIFCS(JLON,JLEV)/ZRHOFLUX(JLON,JLEV)&
        & *(RATM/YDCPG_PHY0%PREHYD(JLON,JLEV))**(RKAPPA)/RCPD
      ZWTHETAL(JLON,JLEV)=ZHEAT(JLON,JLEV) -(ZLH(JLON,JLEV)/RCPD)*&
      & (RATM/YDCPG_PHY0%PREHYD(JLON,JLEV))**(RKAPPA)*(-YDMF_PHYS%OUT%DIFCQL(JLON,JLEV)&
        &  -YDMF_PHYS%OUT%DIFCQN(JLON,JLEV))/ZRHOFLUX(JLON,JLEV)
      ZWPQLP(JLON,JLEV)=-YDMF_PHYS%OUT%DIFCQL(JLON,JLEV)/ZRHOFLUX(JLON,JLEV)
      ZWPQIP(JLON,JLEV)=-YDMF_PHYS%OUT%DIFCQN(JLON,JLEV)/ZRHOFLUX(JLON,JLEV)
      ENDDO
   ENDDO
   ZLWPQTP(:,:)=ZWPQLP(:,:)+ZWPQIP(:,:)+ZWPQP(:,:)
   CALL WRSCMR(IUSCM,'ZWPQT_dee',ZLWPQTP,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'WTHL_dee',ZWTHETAL,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'ZWPQP_dee',ZWPQP,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'ZHEAT_dee',ZHEAT,KLON,KLEV+1)
   CALL WRSCMR(IUSCM,'ZWT_dee',ZWT,KLON,KLEV+1)

   DO JLON=KIDIA,KFDIA
   ZLIM(JLON)=0.05*ZUSTAR(JLON)**2
   ZBLHG(JLON)=(YDCPG_DYN0%PHIF(JLON,KLEV)-YDCPG_DYN0%PHI(JLON,KLEV))/RG
   ZZUVB=ZLIM(JLON)
   ZZ=0.
   DO JLEV=KLEV-1,0,-1
      ZZUV=SQRT(ZUPWP(JLON,JLEV)**2+ZVPWP(JLON,JLEV)**2)
      IF ((ZZUV<=ZLIM(JLON)).AND.(ZZ==0.)) THEN
         ZALPHA=(ZZUVB-ZZUV)*RG/(YDCPG_DYN0%PHI(JLON,JLEV+1)-YDCPG_DYN0%PHI(JLON,JLEV))
         ZBETA=ZZUV-ZALPHA*(YDCPG_DYN0%PHI(JLON,JLEV)-YDCPG_DYN0%PHI(JLON,KLEV))/RG
         ZBLHG(JLON)= (ZLIM(JLON)-ZBETA)/MAX(ZALPHA,0.0000001_JPRB)
         ZZ=1.
      ENDIF
      ZZUVB=ZZUV
   ENDDO
   ENDDO
   CALL ECR1D(IUSCM,'ZBLHG',ZBLHG,1,KLON)
ENDIF

!-------------------------------------------------
! Vertical mean of saturation deficit (thetaES - thetaE) between 0 and 15 km.
!-------------------------------------------------

DO JLON=KIDIA,KFDIA
   ZMEAN_SAT_DEF(JLON)=0._JPRB
   ZDELTAPSG=0._JPRB
   DO JLEV=KTDIA,KLEV
      IF (YDCPG_DYN0%PHIF(JLON,JLEV)/RG < 15000._JPRB ) THEN
         ZVAL=THETAES_BOLTON(YDCPG_PHY0%PREHYDF(JLON,JLEV),YDVARS%T%T0(JLON,JLEV))&
                & -THETAE_BOLTON(YDCPG_PHY0%PREHYDF(JLON,JLEV),YDVARS%T%T0(JLON,JLEV),YDVARS%Q%T0(JLON,JLEV))
         ZMEAN_SAT_DEF(JLON)=ZMEAN_SAT_DEF(JLON)+ZVAL*YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
         ZDELTAPSG=ZDELTAPSG+YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
      ENDIF
   ENDDO
   ZMEAN_SAT_DEF(JLON)=ZMEAN_SAT_DEF(JLON)/ZDELTAPSG
ENDDO
CALL ECR1D(IUSCM,'SAT_DEF_0-15',ZMEAN_SAT_DEF,1,KLON) ! vertical mean of saturation deficit.

!-------------------------------------------------
! Vertical mean of saturation deficit (thetaES - thetaE) between 1 and 15 km.
!-------------------------------------------------

DO JLON=KIDIA,KFDIA
   ZMEAN_SAT_DEF(JLON)=0._JPRB
   ZDELTAPSG=0._JPRB
   DO JLEV=KTDIA,KLEV
      IF (YDCPG_DYN0%PHIF(JLON,JLEV)/RG > 1000._JPRB .AND.&
         & YDCPG_DYN0%PHIF(JLON,JLEV)/RG < 15000._JPRB ) THEN
         ZVAL=THETAES_BOLTON(YDCPG_PHY0%PREHYDF(JLON,JLEV),YDVARS%T%T0(JLON,JLEV))&
             & -THETAE_BOLTON(YDCPG_PHY0%PREHYDF(JLON,JLEV),YDVARS%T%T0(JLON,JLEV),YDVARS%Q%T0(JLON,JLEV))
         ZMEAN_SAT_DEF(JLON)=ZMEAN_SAT_DEF(JLON)+ZVAL*YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
         ZDELTAPSG=ZDELTAPSG+YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
      ENDIF
   ENDDO
   IF (ZDELTAPSG/=0._JPRB) ZMEAN_SAT_DEF(JLON)=ZMEAN_SAT_DEF(JLON)/ZDELTAPSG
ENDDO
CALL ECR1D(IUSCM,'SAT_DEF_1-15',ZMEAN_SAT_DEF,1,KLON) ! vertical mean of saturation deficit.

!-------------------------------------------------
! Vertical mean of saturation deficit (thetaES - thetaE) between 2.5 and 4.5 km.
!-------------------------------------------------

DO JLON=KIDIA,KFDIA
   ZMEAN_SAT_DEF(JLON)=0._JPRB
   ZDELTAPSG=0._JPRB
   DO JLEV=KTDIA,KLEV
      IF(YDCPG_DYN0%PHIF(JLON,JLEV)/RG > 2500._JPRB .AND.&
        & YDCPG_DYN0%PHIF(JLON,JLEV)/RG < 4500._JPRB ) THEN
        ZVAL=THETAES_BOLTON(YDCPG_PHY0%PREHYDF(JLON,JLEV),YDVARS%T%T0(JLON,JLEV))&
           & -THETAE_BOLTON(YDCPG_PHY0%PREHYDF(JLON,JLEV),YDVARS%T%T0(JLON,JLEV),YDVARS%Q%T0(JLON,JLEV))
        ZMEAN_SAT_DEF(JLON)=ZMEAN_SAT_DEF(JLON)+ZVAL*YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
        ZDELTAPSG=ZDELTAPSG+YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
      ENDIF
    ENDDO
    IF (ZDELTAPSG/=0._JPRB) ZMEAN_SAT_DEF(JLON)=ZMEAN_SAT_DEF(JLON)/ZDELTAPSG
ENDDO
CALL ECR1D(IUSCM,'SAT_DEF_2.5-4.5',ZMEAN_SAT_DEF,1,KLON) ! vertical mean of saturation deficit.

!-------------------------------------------------
! Vertical mean of saturation deficit (thetaES - thetaE) between 1.4 and 3.0 km.
!-------------------------------------------------

DO JLON=KIDIA,KFDIA
   ZMEAN_SAT_DEF(JLON)=0._JPRB
   ZDELTAPSG=0._JPRB
   DO JLEV=KTDIA,KLEV
      IF(YDCPG_DYN0%PHIF(JLON,JLEV)/RG > 1400._JPRB .AND.&
        & YDCPG_DYN0%PHIF(JLON,JLEV)/RG < 3000._JPRB ) THEN
        ZVAL=THETAES_BOLTON(YDCPG_PHY0%PREHYDF(JLON,JLEV),YDVARS%T%T0(JLON,JLEV))&
           & -THETAE_BOLTON(YDCPG_PHY0%PREHYDF(JLON,JLEV),YDVARS%T%T0(JLON,JLEV),YDVARS%Q%T0(JLON,JLEV))
        ZMEAN_SAT_DEF(JLON)=ZMEAN_SAT_DEF(JLON)+ZVAL*YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
        ZDELTAPSG=ZDELTAPSG+YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
      ENDIF
   ENDDO
   IF (ZDELTAPSG/=0._JPRB) ZMEAN_SAT_DEF(JLON)=ZMEAN_SAT_DEF(JLON)/ZDELTAPSG
ENDDO
CALL ECR1D(IUSCM,'SAT_DEF_1.4-3',ZMEAN_SAT_DEF,1,KLON) ! vertical mean of saturation deficit.

!-------------------------------------------------
! Vertical mean of saturation deficit (qvsat - qv) between 0 and 15 km.
!-------------------------------------------------

DO JLON=KIDIA,KFDIA
   ZMEAN_SAT_DEF(JLON)=0._JPRB
   ZDELTAPSG=0._JPRB
   DO JLEV=KTDIA,KLEV
      IF(YDCPG_DYN0%PHIF(JLON,JLEV)/RG >= 0._JPRB .AND.&
        & YDCPG_DYN0%PHIF(JLON,JLEV)/RG < 15000._JPRB ) THEN
        ZVAL=(YDAPLPAR_TMP%FLU%QSAT(JLON,JLEV)-YDVARS%Q%T0(JLON,JLEV))*1000._JPRB
        ZMEAN_SAT_DEF(JLON)=ZMEAN_SAT_DEF(JLON)+ZVAL*YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
        ZDELTAPSG=ZDELTAPSG+YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
      ENDIF
   ENDDO
   IF (ZDELTAPSG/=0._JPRB) ZMEAN_SAT_DEF(JLON)=ZMEAN_SAT_DEF(JLON)/ZDELTAPSG
ENDDO
CALL ECR1D(IUSCM,'SAT_DEF_QV_0-15',ZMEAN_SAT_DEF,1,KLON)

!-------------------------------------------------
! Vertical mean of saturation deficit (qvsat - qv) between 1 and 15 km.
!-------------------------------------------------

DO JLON=KIDIA,KFDIA
   ZMEAN_SAT_DEF(JLON)=0._JPRB
   ZDELTAPSG=0._JPRB
   DO JLEV=KTDIA,KLEV
      IF(YDCPG_DYN0%PHIF(JLON,JLEV)/RG >= 1000._JPRB .AND.&
        & YDCPG_DYN0%PHIF(JLON,JLEV)/RG < 15000._JPRB ) THEN
        ZVAL=(YDAPLPAR_TMP%FLU%QSAT(JLON,JLEV)-YDVARS%Q%T0(JLON,JLEV))*1000._JPRB
        ZMEAN_SAT_DEF(JLON)=ZMEAN_SAT_DEF(JLON)+ZVAL*YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
        ZDELTAPSG=ZDELTAPSG+YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
      ENDIF
   ENDDO
   IF (ZDELTAPSG/=0.) ZMEAN_SAT_DEF(JLON)=ZMEAN_SAT_DEF(JLON)/ZDELTAPSG
ENDDO
CALL ECR1D(IUSCM,'SAT_DEF_QV_1-15',ZMEAN_SAT_DEF,1,KLON)

!-------------------------------------------------
! Vertical mean of saturation deficit (qvsat - qv) between 2.5 and 4.5 km.
!-------------------------------------------------

DO JLON=KIDIA,KFDIA
   ZMEAN_SAT_DEF(JLON)=0._JPRB
   ZDELTAPSG=0._JPRB
   DO JLEV=KTDIA,KLEV
      IF(YDCPG_DYN0%PHIF(JLON,JLEV)/RG >= 2500._JPRB&
        &.AND. YDCPG_DYN0%PHIF(JLON,JLEV)/RG < 4500._JPRB ) THEN
        ZVAL=(YDAPLPAR_TMP%FLU%QSAT(JLON,JLEV)-YDVARS%Q%T0(JLON,JLEV))*1000.
        ZMEAN_SAT_DEF(JLON)=ZMEAN_SAT_DEF(JLON)+ZVAL*YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
        ZDELTAPSG=ZDELTAPSG+YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
      ENDIF
   ENDDO
   IF (ZDELTAPSG/=0._JPRB) ZMEAN_SAT_DEF(JLON)=ZMEAN_SAT_DEF(JLON)/ZDELTAPSG
ENDDO
CALL ECR1D(IUSCM,'SAT_DEF_QV_2.5-4.5',ZMEAN_SAT_DEF,1,KLON)

!-------------------------------------------------
! Vertical mean of saturation deficit (qvsat - qv) between 1.4 and 3 km.
!-------------------------------------------------

DO JLON=KIDIA,KFDIA
   ZMEAN_SAT_DEF(JLON)=0._JPRB
   ZDELTAPSG=0._JPRB
   DO JLEV=KTDIA,KLEV
      IF(YDCPG_DYN0%PHIF(JLON,JLEV)/RG >= 1400._JPRB&
        & .AND. YDCPG_DYN0%PHIF(JLON,JLEV)/RG < 3000._JPRB ) THEN
        ZVAL=(YDAPLPAR_TMP%FLU%QSAT(JLON,JLEV)-YDVARS%Q%T0(JLON,JLEV))*1000._JPRB
        ZMEAN_SAT_DEF(JLON)=ZMEAN_SAT_DEF(JLON)+ZVAL*YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
        ZDELTAPSG=ZDELTAPSG+YDCPG_PHY0%XYB%DELP(JLON,JLEV)/RG
      ENDIF
   ENDDO
   IF (ZDELTAPSG/=0._JPRB) ZMEAN_SAT_DEF(JLON)=ZMEAN_SAT_DEF(JLON)/ZDELTAPSG
ENDDO
CALL ECR1D(IUSCM,'SAT_DEF_QV_1.4-3',ZMEAN_SAT_DEF,1,KLON)

!-------------------------------------------------
! Base and Top of PBL clouds 
!-------------------------------------------------

DO JLON=KIDIA,KFDIA
   ZTOP(JLON)=0._JPRB
   ZBASE(JLON)=0._JPRB
   ZNEBMAX(JLON)=0._JPRB
   ZMAXFRAC(JLON)=0._JPRB
   DO JLEV=KLEV,KTDIA,-1
      IF(YDCPG_MISC%NEB(JLON,JLEV) > 0.01_JPRB .AND.&
     &  ((YDCPG_DYN0%PHIF(JLON,JLEV)/RG) < 5000._JPRB) .AND.&
     &  ((YDCPG_DYN0%PHIF(JLON,JLEV)/RG) > 50._JPRB)) THEN 
        ZTOP(JLON)=YDCPG_DYN0%PHIF(JLON,JLEV)/RG
      ENDIF
      IF ((YDCPG_MISC%NEB(JLON,JLEV) > ZNEBMAX(JLON)).AND.&
      &   ((YDCPG_DYN0%PHIF(JLON,JLEV)/RG) < 5000._JPRB)) THEN
        ZMAXFRAC(JLON)=YDCPG_DYN0%PHIF(JLON,JLEV)/RG
        ZNEBMAX(JLON)=YDCPG_MISC%NEB(JLON,JLEV)
      ENDIF
   ENDDO
   DO JLEV=KTDIA,KLEV
      IF(YDCPG_MISC%NEB(JLON,JLEV) > 0.01_JPRB .AND.&
     &  ((YDCPG_DYN0%PHIF(JLON,JLEV)/RG) > 50._JPRB)) THEN 
        ZBASE(JLON)=YDCPG_DYN0%PHIF(JLON,JLEV)/RG
      ENDIF
   ENDDO
ENDDO
CALL ECR1D(IUSCM,'ZCLDTOP',ZTOP,1,KLON) 
CALL ECR1D(IUSCM,'ZCLDBAS',ZBASE,1,KLON) 
CALL ECR1D(IUSCM,'ZMAXFRAC',ZMAXFRAC,1,KLON) 
CALL ECR1D(IUSCM,'ZNEBMAX',ZNEBMAX,1,KLON) 

!     ------------------------------------------------------------------
END ASSOCIATE
IF (LHOOK) CALL DR_HOOK('WRITEMUSC',1,ZHOOK_HANDLE)
END SUBROUTINE WRITEMUSC
