SUBROUTINE SUALLT(YDGEOMETRY,YDMTRAJ,YDGMV,YDSURF,YDMODEL)

!**** *SUALLT * - Allocate additional space for trajectory.

!     Purpose.
!     --------
!           Allocate space for the grid-point and spectral trajectory.

!**   Interface.
!     ----------
!        *CALL* *SUALLT*

!     Explicit arguments :  None
!     --------------------

!     Implicit arguments :
!     --------------------

!     Method.
!     -------
!        See documentation

!     Externals.
!     ----------

!     Reference.
!     ----------
!        ECMWF Research Department documentation of the IFS

!     Author.
!     -------
!      Mats Hamrud and Philippe Courtier  *ECMWF*   88-05-19

!     Modifications.
!     --------------
!      Modified 01-05-03 by C. Fischer - allocate_traj under key for 801
!      M.Hamrud      01-Oct-2003 CY28 Cleaning
!      Modified 03-08-01 by M.Hamrud - GFL introduction
!      Modified 03-06-02 by C. Soci - reintroduce test on allocate_traj under 801
!                        needed because suallt is called twice under sim4d in 801
!      Modified 03-09-30 by C. Fischer - introduce Aladin mean wind profiles
!      Modified 23-Nov-10 by O.Riviere-Nullify SPXX pointers if XX not existing
!      F. Vana  28-Nov-2013 : Redesigned trajectory handling
!      K. Yessad (July 2014): Move some variables.
!     ------------------------------------------------------------------

USE TYPE_MODEL   , ONLY : MODEL
USE GEOMETRY_MOD , ONLY : GEOMETRY
USE MTRAJ_MOD  , ONLY : MTRAJ
USE SURFACE_FIELDS_MIX , ONLY : TSURF
USE YOMGMV     , ONLY : TGMV
USE PARKIND1 , ONLY : JPIM, JPRB
USE YOMHOOK  , ONLY : LHOOK, DR_HOOK
USE YOMCT0   , ONLY : NCONF !! ,LELAM  
!! USE YOMDYNA  , ONLY : LRUBC
USE YOMLUN   , ONLY : NULOUT
USE YOMSP5   , ONLY : SPA5
USE YOMVAR   , ONLY : L3DFGAT
USE TRAJECTORY_MOD, ONLY: ALLOCATE_TRAJECTORY
USE YOMTRAJ  , ONLY : LTRAJSAVE
USE GMV_SUBS_MOD, ONLY : SETUP_GMV5
USE SPECTRAL_FIELDS_MOD, ONLY : SPECTRAL_FIELD, ASSIGNMENT(=), ALLOCATE_SPEC

!     ------------------------------------------------------------------

IMPLICIT NONE

TYPE(GEOMETRY),INTENT(IN)    :: YDGEOMETRY
TYPE(TGMV)    ,INTENT(INOUT) :: YDGMV
TYPE(MTRAJ)   ,INTENT(INOUT) :: YDMTRAJ
TYPE(TSURF)   ,INTENT(INOUT) :: YDSURF
TYPE(MODEL)   ,INTENT(INOUT) :: YDMODEL
INTEGER(KIND=JPIM) :: IGRIB(YDMODEL%YRML_GCONF%YRDIMF%NS3D+YDMODEL%YRML_GCONF%YRDIMF%NS2D)
!! INTEGER(KIND=JPIM) ::  IPT,IOFF
REAL(KIND=JPRB) :: ZHOOK_HANDLE
#ifdef __INTEL_COMPILER
INTRINSIC :: SHAPE ! Fails with Intel compiler as it thinks we use ATLAS shape function
#endif


!     ------------------------------------------------------------------
IF (LHOOK) CALL DR_HOOK('SUALLT',0,ZHOOK_HANDLE)
ASSOCIATE(YDGFL5=>YDMTRAJ%YRGFL5, YDGMV5=>YDMTRAJ%YRGMV5, &
  & YDDIM=>YDGEOMETRY%YRDIM, &
  & YDDIMV=>YDGEOMETRY%YRDIMV, YDGEM=>YDGEOMETRY%YRGEM, YDMP=>YDGEOMETRY%YRMP, YDLAP=>YDGEOMETRY%YRLAP, &
  & YGFL=>YDMODEL%YRML_GCONF%YGFL,YDDIMF=>YDMODEL%YRML_GCONF%YRDIMF)

ASSOCIATE(NDIM0=>YGFL%NDIM0, NDIM5=>YGFL%NDIM5, YI=>YGFL%YI, YL=>YGFL%YL, &
 & YO3=>YGFL%YO3, YQ=>YGFL%YQ, &
 & NGPBLKS=>YDDIM%NGPBLKS, NPROMA=>YDDIM%NPROMA, NMSMAX=>YDDIM%NMSMAX, &
 & NSMAX=>YDDIM%NSMAX, NSPEC2=>YDDIM%NSPEC2, NUMP=>YDDIM%NUMP, &
 & LSPT=>YDDIMF%LSPT, NFD2D=>YDDIMF%NFD2D, NFTHER=>YDDIMF%NFTHER, &
 & NS2D=>YDDIMF%NS2D, NS3D=>YDDIMF%NS3D,NGRBSP3=>YDDIMF%NGRBSP3,NGRBSP2=>YDDIMF%NGRBSP2, &
 & NFLEVG=>YDDIMV%NFLEVG, NFLEVL=>YDDIMV%NFLEVL, NFLSUR=>YDDIMV%NFLSUR, &
 & YT0=>YDGMV%YT0, &
 & MYMS=>YDLAP%MYMS, &
 & NALLMS=>YDMP%NALLMS, NPSURF=>YDMP%NPSURF, NPTRLL=>YDMP%NPTRLL, &
 & NPTRMS=>YDMP%NPTRMS, NUMLL=>YDMP%NUMLL)
!     ------------------------------------------------------------------

!*       1.    ALLOCATE SPACE FOR ARRAYS.
!              --------------------------

IGRIB(1:NS3D)=NGRBSP3(:)
IGRIB(NS3D+1:NS3D+NS2D)=NGRBSP2(:)
CALL ALLOCATE_SPEC(SPA5,NFLEVL,NFLEVG,NUMP,MYMS,NSMAX,NMSMAX,&
 & NALLMS,NPTRMS,NUMLL,NPTRLL,NPSURF,NS3D,NS2D,IGRIB)

!YT IF (.NOT.ALLOCATED(SPA5%SP3D)) THEN
!YT   ALLOCATE(SPA5%SP3D(NFLSUR,NSPEC2,NS3D))
!YT ENDIF
!YT WRITE(NULOUT,9990) 'SP5A3    ',SIZE(SPA5%SP3D),SHAPE(SPA5%SP3D)
!YT SPA5%VOR => SPA5%SP3D(1:NFLSUR,1:NSPEC2,1)
!YT SPA5%DIV => SPA5%SP3D(1:NFLSUR,1:NSPEC2,2)
!YT IF(NFTHER > 0) THEN
!YT   SPA5%HV => SPA5%SP3D(1:NFLSUR,1:NSPEC2,3:2+NFTHER)
!YT ENDIF
!YT IPT = 3
!YT IF(LSPT) THEN
!YT   SPA5%T => SPA5%SP3D(1:NFLSUR,1:NSPEC2,IPT)
!YT   IPT = IPT+1
!YT ENDIF
!YT 
!YT IOFF=2+NFTHER
!YT IF(YGFL%NUMSPFLDS > 0) THEN
!YT   SPA5%GFL => SPA5%SP3D(1:NFLSUR,1:NSPEC2,IOFF+1:IOFF+YGFL%NUMSPFLDS)
!YT ELSE
!YT   NULLIFY(SPA5%GFL)
!YT ENDIF
!YT IF(YQ%LSP) THEN
!YT   SPA5%Q => SPA5%SP3D(1:NFLSUR,1:NSPEC2,IOFF+YQ%MPSP)
!YT ELSE
!YT   NULLIFY(SPA5%Q)
!YT ENDIF
!YT IF(YO3%LSP) THEN
!YT   SPA5%O3 => SPA5%SP3D(1:NFLSUR,1:NSPEC2,IOFF+YO3%MPSP)
!YT ELSE
!YT   NULLIFY(SPA5%O3)
!YT ENDIF
!YT IF(YL%LSP) THEN
!YT   SPA5%L => SPA5%SP3D(1:NFLSUR,1:NSPEC2,IOFF+YL%MPSP)
!YT ELSE
!YT   NULLIFY(SPA5%L)
!YT ENDIF
!YT IF(YI%LSP) THEN
!YT   SPA5%I => SPA5%SP3D(1:NFLSUR,1:NSPEC2,IOFF+YI%MPSP)
!YT ELSE
!YT   NULLIFY(SPA5%I)
!YT ENDIF
!YT 
!YT IF (.NOT.ALLOCATED(SPA5%SP2D)) THEN
!YT   ALLOCATE(SPA5%SP2D(NSPEC2,NS2D))
!YT ENDIF
!YT WRITE(NULOUT,9990) 'SP5A2    ',SIZE(SPA5%SP2D),SHAPE(SPA5%SP2D)
!YT IF(NFD2D > 0) THEN
!YT   SPA5%SP  => SPA5%SP2D(1:NSPEC2,1)
!YT !  IF (LRUBC) THEN
!YT !    SPA5%VELT1 => SPA5%SP2D(1:NSPEC2,2)
!YT !  ELSE
!YT !    SPA5%VELT1 => SPA5%SP2D(1:NSPEC2,1)
!YT !  ENDIF
!YT ENDIF
!YT 
!YT IF (.NOT.ALLOCATED(SPA5%SP1D)) THEN
!YT   IF(LELAM) THEN
!YT     ALLOCATE(SPA5%SP1D(NFLEVL,2))
!YT   ELSE
!YT ! to prevent out of bounds -rek
!YT     ALLOCATE(SPA5%SP1D(NFLEVL,2))
!YT   ENDIF
!YT ENDIF
!YT WRITE(NULOUT,9990) 'SP5A1    ',SIZE(SPA5%SP1D),SHAPE(SPA5%SP1D)
!YT IF(LELAM) THEN
!YT   SPA5%UB => SPA5%SP1D(1:NFLEVL,1)
!YT   SPA5%VB => SPA5%SP1D(1:NFLEVL,2)
!YT ELSE
!YT   IF(ASSOCIATED(SPA5%UB)) NULLIFY(SPA5%UB)
!YT   IF(ASSOCIATED(SPA5%UB)) NULLIFY(SPA5%VB)
!YT ENDIF

CALL SETUP_GMV5(YDGEOMETRY,YDGMV5,YDDIMF)

! Dont understand this/makes all fail/MH
IF (.NOT.(NCONF==801.AND.LTRAJSAVE)) THEN
  CALL ALLOCATE_TRAJECTORY(YDGEOMETRY,YDGMV,YDGMV5,YDSURF,YDMODEL)
ENDIF

IF (.NOT.ALLOCATED(YDGFL5%GFL5)) THEN
  ALLOCATE(YDGFL5%GFL5(NPROMA,NFLEVG,NDIM5,NGPBLKS))
  WRITE(NULOUT,9990) 'GFL5     ',SIZE(YDGFL5%GFL5),SHAPE(YDGFL5%GFL5)
ENDIF

IF (L3DFGAT .AND. .NOT.ALLOCATED(YDGMV5%GMV_DEPART)) THEN
  ALLOCATE(YDGMV5%GMV_DEPART(NPROMA,NFLEVG,YT0%NDIM,NGPBLKS))
  WRITE(NULOUT,9990) 'GMV_DEPART',SIZE(YDGMV5%GMV_DEPART ),SHAPE(YDGMV5%GMV_DEPART)
  ALLOCATE(YDGMV5%GMVS_DEPART(NPROMA,YT0%NDIMS,NGPBLKS))
  WRITE(NULOUT,9990) 'GMVS_DEPART',SIZE(YDGMV5%GMVS_DEPART ),SHAPE(YDGMV5%GMVS_DEPART)
  ALLOCATE(YDGFL5%GFL_DEPART(NPROMA,NFLEVG,NDIM0,NGPBLKS))
  WRITE(NULOUT,9990) 'GFL_DEPART',SIZE(YDGFL5%GFL_DEPART ),SHAPE(YDGFL5%GFL_DEPART)
ENDIF

!     ------------------------------------------------------------------
9990 FORMAT(1X,'ARRAY ',A10,' ALLOCATED ',9I8)

END ASSOCIATE
END ASSOCIATE
IF (LHOOK) CALL DR_HOOK('SUALLT',1,ZHOOK_HANDLE)
END SUBROUTINE SUALLT
